{"pages":[{"title":"å…³äºæˆ‘ &#x2F; About me","text":"ç®€ä»‹ / IntroHi æˆ‘æ˜¯è¯¥ç½‘ç«™çš„ç»´æŠ¤äºº Jackyã€‚ ä¸€ä¸ªå–œæ¬¢å¬ Rapã€ç©æ¸¸æˆã€æ•²ä»£ç çš„è€é€æ˜ ä¹Ÿæ˜¯ç‹å˜‰å°”(Jackson Wang) çš„ç²‰ä¸ï¼›ow å…»è€ç©å®¶ï¼›èŒ¶èŒ¶çš„å°æµ·è±šï¼› Hi Iâ€™m jacky, the maintainer of this website. An obscure person who likes to listen to Rap, play games, and program. Meanwhile, Iâ€™m also a fan of Jackson Wang, OverWatch player, and little dolphin of TeaTea ^ ^ è”ç³» / ContactEmail: jacky.teamwang@qq.com / clorisforcoding@gmail.com Twitter: Anonymous sry ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€å–”ï½ Welcome to leave your message~ é“¾æ¥ / LinksMy Github: è¿™é‡Œæœ‰æˆ‘å†™çš„è®¸å¤š hello world çº§åˆ«çš„é¡¹ç›®ã€‚ My LeetCode: å¹³æ—¶æœ‰ç©ºåˆ·ç®—æ³•çš„åœ°æ–¹ã€‚å¶å°”å‚åŠ æ¯”èµ›ä½†å§‹ç»ˆä¿æŒåƒåå¼€å¤– ğŸ˜…","link":"/about.html"}],"posts":[{"title":"Javaå¹¶å‘ç¼–ç¨‹","text":"å¹¶å‘ç¼–ç¨‹åŸºç¡€ç›¸å…³çš„å†…å®¹â€¦ Immutable of Guava çš„å®ç°åŸç†ï¼Œå°±æ˜¯åœ¨å®ç°çš„æ–¹æ³•ä¸­æŠ›å‡ºå¼‚å¸¸ã€‚ çº¿ç¨‹å°é—­çš„æ–¹æ³•ï¼šä½¿ç”¨ ThreadLocal çº¿ç¨‹ä¸å®‰å…¨çš„å†™æ³•ï¼šif(condition(a)) { handle(a); },å¯ä»¥ä½¿ç”¨ volatile boolean æ¥åšæ ‡è®° + while è¯­å¥ final Object mutex; // Object on which to synchronize åŒæ­¥å®¹å™¨ä¸ä¸€å®šèƒ½åšåˆ°çº¿ç¨‹å®‰å…¨ã€‚åº”ä½¿ç”¨å¹¶å‘å®¹å™¨ã€‚ 1. çº¿ç¨‹å®‰å…¨æ€§1.1 åŸå­æ€§ äº’æ–¥è®¿é—®ï¼Œå³åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹å®ƒæ“ä½œã€‚ è‹¥å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹intå˜é‡increaseæ“ä½œï¼Œå¯èƒ½ä¼šå› ä¸ºä¸»å†…å­˜å˜é‡ä¸æ˜¯æœ€æ–°å€¼(è¿™æ˜¯å¯è§æ€§é—®é¢˜)åŒæ—¶æ‰§è¡Œ(è¿èƒŒåŸå­æ€§)è€Œä¸èƒ½è¾¾åˆ°é¢„è®¡ç»“æœã€‚ AtomicInteger åŸç†ï¼šAtomicInteger çš„åŸç†æ˜¯ä¾é åº•å±‚çš„ CAS æ¥ä¿éšœåŸå­æ€§çš„æ›´æ–°æ•°æ®ï¼Œåœ¨è¦æ·»åŠ æˆ–è€…å‡å°‘çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨æ­»å¾ªç¯ä¸æ–­åœ° CAS åˆ°ç‰¹å®šçš„å€¼ï¼Œä»è€Œè¾¾åˆ°æ›´æ–°æ•°æ®çš„ç›®çš„ã€‚CAS çš„ ABA é—®é¢˜é€šè¿‡ Version Stamp è§£å†³ã€‚ 12// setup to use Unsafe.compareAndSwapInt&lt;CAS&gt; for updatesprivate static final Unsafe unsafe = Unsafe.getUnsafe(); 123456789101112131415161718192021222324252627public class AtomicMain { // static ç±»å˜é‡ static int sum = 0;// static AtomicInteger sum = new AtomicInteger(0); public static void main(String[] args) throws InterruptedException { CountDownLatch latch = new CountDownLatch(2); ExecutorService service = Executors.newFixedThreadPool(2); service.execute(() -&gt; { for (int i = 0; i &lt; 5000; i++) { sum++; } latch.countDown(); }); service.execute(() -&gt; { for (int i = 0; i &lt; 5000; i++) { sum++; } latch.countDown(); }); latch.await(); System.out.println(&quot;======&gt;ç»“æœï¼š&quot; + sum); // éšæœºä¸”å°äºç­‰äº10000 }} LongAdder å’Œ AtomicLong çš„åŒºåˆ« LongAdder(jdk1.8) åœ¨ AtomicLong(jdk1.5) çš„åŸºç¡€ä¸Šå°†å•ç‚¹çš„æ›´æ–°å‹åŠ›åˆ†æ•£åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œæ€§èƒ½æ›´å¥½ã€‚ ä¸‹é¢ä¸º LongAdder çš„éƒ¨åˆ†æºç ï¼š 123456789101112131415/** * Adds the given value. * * @param x the value to add */public void add(long x) { Cell[] as; long b, v; int m; Cell a; if ((as = cells) != null || !casBase(b = base, b + x)) { boolean uncontended = true; if (as == null || (m = as.length - 1) &lt; 0 || (a = as[getProbe() &amp; m]) == null || !(uncontended = a.cas(v = a.value, v + x))) longAccumulate(x, null, uncontended); }} å¯¹æ¯” AtomicInteger çš„å®ç°ï¼š 12345678public final int getAndAddInt(Object var1, long var2, int var4) { int var5; do { var5 = this.getIntVolatile(var1, var2); } while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4)); return var5;} AtomicReference AtomicStampedReference ç›¸æ¯”è¯¥ç±»å¤šäº†ä¸€ä¸ª stamp. å¯¹æ¯”synchronized synchronized ä¸å±äºæ–¹æ³•å£°æ˜çš„ä¸€éƒ¨åˆ†ã€‚ synchronized ä¸å¯ä¸­æ–­ï¼Œç›´åˆ°æ‰§è¡Œå®Œä»£ç ã€‚Lock é€šè¿‡ unlock æ–¹æ³•ä¸­æ–­ã€‚ synchronized é€‚åˆç«äº‰ä¸æ¿€çƒˆçš„åœºæ™¯ã€‚ Atomic æ¯” Lock æ€§èƒ½å¥½ï¼Œä½†æ˜¯åªèƒ½åŒæ­¥ä¸€ä¸ªå€¼ã€‚ 1.2 å¯è§æ€§ ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸»å†…å­˜çš„ä¿®æ”¹å¯ä»¥åŠæ—¶åœ°è¢«å…¶å®ƒçº¿ç¨‹è§‚å¯Ÿåˆ°ã€‚ å¯¼è‡´å…±äº«å˜é‡åœ¨çº¿ç¨‹é—´ä¸å¯è§çš„åŸå› ï¼š1. çº¿ç¨‹äº¤å‰æ‰§è¡Œã€‚ 2. æŒ‡ä»¤é‡æ’ã€‚ 3. å€¼æ›´æ–°åæ²¡æœ‰åœ¨å·¥ä½œå†…å­˜å’Œä¸»å†…å­˜ä¸­åŠæ—¶æ›´æ–°ã€‚ synchronized JMM å…³äº synchronized çš„ä¸¤æ¡è§„å®šï¼š çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚ çº¿ç¨‹åŠ é”æ—¶ï¼Œå°†æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œè®©å…±äº«å˜é‡çš„å€¼ä½¿ç”¨ä¸»å†…å­˜ä¸­çš„æ•°æ®ã€‚ï¼ˆåŠ é”å’Œè§£é”æ˜¯åŒä¸€æŠŠé”ï¼‰ volatile å¯è§æ€§çš„å®ç°åŸç†ï¼šé€šè¿‡åŠ å…¥å†…å­˜å±éšœå’Œç¦æ­¢é‡æ’åºæ¥å®ç°å¯è§æ€§ã€‚ å¯¹ volatile å˜é‡å†™æ“ä½œæ—¶ï¼Œä¼šåœ¨æœ€ååŠ å…¥ä¸€æ¡ store å±éšœæŒ‡ä»¤ï¼Œå°†æœ¬åœ°å·¥ä½œå†…å­˜ä¸­çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚ å¯¹ volatile å˜é‡è¯»æ“ä½œæ—¶ï¼Œä¼šåœ¨å‰é¢åŠ å…¥ä¸€æ¡ load å±éšœæŒ‡ä»¤ï¼Œä½¿å…¶ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚ Tips: ä¸‹é¢ä¸ºä¸€ä¸ª atomic å®ç°çš„è®¡æ•°å™¨ï¼Œè‹¥æ¢æˆ volatileï¼Œåˆ™æ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚å› ä¸ºåœ¨æ‰§è¡Œcount++;æ“ä½œæ—¶ï¼Œè™½ç„¶ä¼šå…ˆä»ä¸»å†…å­˜å–å‡ºæœ€æ–°å€¼ï¼Œä½†æ˜¯æœ‰å¯èƒ½**å¤šä¸ªçº¿ç¨‹(å³æ— åŸå­æ€§)**æ‰§è¡Œäº†+1çš„æ“ä½œã€‚å› æ­¤ï¼Œå³ä¾¿æ˜¯ä¿è¯äº†å¯è§æ€§(å³å˜é‡æ˜¯æœ€æ–°å€¼)ï¼Œä¹Ÿä¼šç”±äºåŸå­æ€§çš„é—®é¢˜è€Œæ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * @author Jacky * Date: 2019/1/4 * Time: 0:26 */@Slf4j@ThreadSafepublic class CountExample1 { private static final int REQUESTS_TOTAL = 5000; private static final int THREADS = 200; // public static final int INIT_THREADS = 50; private static AtomicInteger counts = new AtomicInteger(0); private static void add() { counts.incrementAndGet(); } public static void main(String[] args) { ExecutorService executorService = Executors.newCachedThreadPool(); final Semaphore semaphore = new Semaphore(THREADS); final CountDownLatch countDownLatch = new CountDownLatch(REQUESTS_TOTAL); for (int i = 0; i &lt; REQUESTS_TOTAL; i++) { executorService.execute(() -&gt; { try { semaphore.acquire(); add(); semaphore.release(); } catch (Exception e) { log.error(&quot;exception&quot;, e); } countDownLatch.countDown(); }); } try { countDownLatch.await(); } catch (InterruptedException e) { log.error(&quot;exception&quot;, e); } executorService.shutdown(); log.info(&quot;counts:{}&quot;, counts.get()); }} 1.3 æœ‰åºæ€§ ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿåˆ°å…¶å®ƒçº¿ç¨‹ä¸­çš„æŒ‡ä»¤æ‰§è¡Œé¡ºåºã€‚ç”±äºæŒ‡ä»¤é‡æ’çš„å­˜åœ¨ï¼Œè¯¥è§‚å¯Ÿç»“æœä¸€èˆ¬æ‚ä¹±æ— åºã€‚ 2. åŒæ­¥ &amp; å¹¶å‘å®¹å™¨ (JUC)å‚ç…§ã€ŠJavaåŸºç¡€çŸ¥è¯†ã€‹å®¹å™¨ç« èŠ‚ã€‚ 3. çº¿ç¨‹æ± 3.1 åŸºç¡€çº¿ç¨‹æ± ThreadPoolExecutorçš„æ ¸å¿ƒå‚æ•°åŠç»“æ„ï¼š core =&gt; queue =&gt; max =&gt; handler æ ¸å¿ƒçº¿ç¨‹æ•°ä¸è¶³ï¼Œæ— æ³•å¤„ç†çš„ä»»åŠ¡ä¼šè¢«æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›å½“ç­‰å¾…é˜Ÿåˆ—ä¹Ÿæ’æ»¡äº†åï¼Œå°±ä¼šå¯åŠ¨æ›´å¤šçš„çº¿ç¨‹(æœ€å¤§çº¿ç¨‹æ•°)æ¥å¤„ç†ä»»åŠ¡ï¼›å½“æœ€å¤§çº¿ç¨‹æ•°ä¹Ÿä¸å¤Ÿå¤„ç†æ—¶ï¼Œå°±ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼›è¶…å‡ºcoreSizeçš„çº¿ç¨‹ï¼Œç§°ä¸ºç©ºé—²çº¿ç¨‹ã€‚ ThreadPoolExecutor çº¿ç¨‹æ± çš„5ç§çŠ¶æ€ï¼š å¦å¤–ï¼ŒExecutorsåˆ›å»ºçš„çº¿ç¨‹æ± å‡æ˜¯ä½¿ç”¨ThreadPoolExecutoråˆ›å»ºçš„ åŸºæœ¬æ–¹æ³•ä»‹ç»ï¼š execte(): æäº¤ä»»åŠ¡ submit(): æäº¤ä»»åŠ¡ï¼Œæœ‰è¿”å›å€¼ã€‚ç›¸å½“äº execute + future shutdown(): å…³é—­çº¿ç¨‹æ± ï¼Œä½†æ˜¯ä¼šç­‰å¾…ä»»åŠ¡éƒ½æ‰§è¡Œå®Œå†å…³é—­ shutdownNow(): å…³é—­çº¿ç¨‹æ± ï¼Œä¸ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œï¼Œç›´æ¥åœæ­¢æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ 3.2 Executors ç±» ç¤ºä¾‹ å…ˆåˆ›å»ºä»»åŠ¡ï¼Œå³å®ç° runnable/callable æ¥å£ã€‚ 123456public class OrderTask implements Callable&lt;String&gt; { @Override public String call() { return &quot;hello world&quot;; }} æ¥ç€ä¹Ÿå¯ä»¥ç”¨FutureTaskæ¥æ”¶ï¼Œå®ç°æ›´å¤šåŠŸèƒ½å¦‚å–æ¶ˆä»»åŠ¡ï¼Œåˆ¤æ–­ä»»åŠ¡ç»“æŸç­‰ç­‰ã€‚FutureTaskæ˜¯Futureå”¯ä¸€çš„å®ç°ç±»ã€‚ æäº¤(submit)ä»»åŠ¡åˆ°çº¿ç¨‹æ±  12345678910111213141516/** * æ¯æ¬¡æ‰§è¡Œ3ä¸ªä»»åŠ¡ */public class ThreadPoolExample { public static void main(String[] args) throws ExecutionException, InterruptedException { ExecutorService threadPool = Executors.newFixedThreadPool(3); for (int i = 0; i &lt; 10; i++) { // foreach concrete business Future&lt;String&gt; submit = threadPool.submit(new OrderTask()); System.out.println(submit.get()); } System.out.println(&quot;10 tasks have been dispatched successfully.&quot;); threadPool.shutdown(); }} 3.2 çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥ All implement the RejectedExecutionHandler. CallerRunsPolicy: A handler for rejected tasks that runs the rejected task directly in the calling thread of the execute method, unless the executor has been shut down, in which case the task is discarded.(è°ƒç”¨çº¿ç¨‹å¤„ç†) AbortPolicy(default): A handler for rejected tasks that throws a RejectedExecutionException.(ä¸¢å¼ƒå¹¶æŠ›å‡ºå¼‚å¸¸) DiscardPolicy: A handler for rejected tasks that silently discards the rejected task.(ç›´æ¥ä¸¢å¼ƒ) DiscardOldestPolicy: A handler for rejected tasks that discards the oldest unhandled request and then retries execute, unless the executor is shut down, in which case the task is discarded.(ä¸¢å¼ƒæ—§ä»»åŠ¡å†å°è¯•é‡æ–°æ‰§è¡Œ) 4. HashMap4.1 æ•°æ®ç»“æ„ConcurrentHashMapæ•°ç»„ + é“¾è¡¨ï¼Œé“¾è¡¨åœ¨å‘ç”Ÿhashå†²çªæ—¶å½¢æˆã€‚å¦‚ä¸‹å›¾ï¼š æ³¨æ„ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºç­‰äº 8 æ—¶ï¼Œä¼šè½¬åŒ–æˆçº¢é»‘æ ‘ç»“æ„ã€‚å¯»å€çš„æ—¶é—´å¤æ‚åº¦ä» O(n) é™ä¸º O(logn) 4.2 åˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­123static final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; // aka 16static final float DEFAULT_LOAD_FACTOR = 0.75f; // åœ¨ä¿è¯äº†ç©ºé—´åˆ©ç”¨ç‡çš„åŒæ—¶ï¼Œå‡å°‘Hashå†²çª 4.3 HashMap çš„æ‰©å®¹æ‰©å®¹ 2 å€ï¼Œä¿è¯å®¹é‡æ˜¯ 2^nã€‚å‡å°‘äº†hashå†²çªã€‚ ä¸‹å›¾ä¸ºå•çº¿ç¨‹çš„æ‰©å®¹ï¼š 5. å¤šçº¿ç¨‹å¹¶å‘ä¸çº¿ç¨‹å®‰å…¨æ€»ç»“","link":"/2021/03/01/Concurrency%E5%B9%B6%E5%8F%91/"},{"title":"Hexoåšå®¢ç½‘ç«™æ­å»º","text":"1. è‡ªè¨€è‡ªè¯­èŠ±äº†å¥½å‡ å¤©çš„æ—¶å€™ï¼Œä»æŠ€æœ¯æ¡†æ¶ç­›é€‰å†åˆ°æ ·å¼è°ƒæ•´ã€é…ç½®ä¿®æ”¹ã€é¡¹ç›®éƒ¨ç½²ç­‰ç­‰ã€‚ä¸Šçº¿åä¹ŸèŠ±äº†è®¸å¤šæ—¶é—´ç²¾åŠ›å¢åŠ åŠŸèƒ½ã€‚ ç”±äºä¹‹å‰æœ‰å°è¯•è¿‡ä»é›¶å¼€å§‹æ­å»ºä¸ªäººåšå®¢ (å‰åç«¯ä¸€èµ·å†™ï¼Œåç«¯ç”¨Springbootï¼Œå‰ç«¯æ˜¯ bootstrap + jquery)ï¼Œå•å‰ç«¯æ¥è®²ï¼Œå†™ä¸ªåˆ†é¡µçš„jsåŠ ä¸Šè°ƒè¯•å°±å¤Ÿæˆ‘èŠ±å¤§åŠå¤©æ—¶é—´äº†T T æ¯•ç«Ÿè‡ªå·±çš„å‰ç«¯éƒ½æ˜¯ä¸´æ—¶æŠ±ä½›è„šå­¦çš„ï¼ï¼åŠ ä¸Šç°åœ¨å·²ç» 2021 å¹´äº†ï¼Œä¹Ÿä¸ä¼šæœ‰äººé‡å¤å†™è¿™äº›å¸‚é¢ä¸Šå·²ç»æœ‰è€Œä¸”å¾ˆæˆç†Ÿçš„ç»„ä»¶äº†å§ (è™½ç„¶çœŸçš„æœ‰ä½†æ˜¯æ˜¯å°‘éƒ¨åˆ†) = = å†™ç€å†™ç€æ„Ÿè§‰å˜æˆæ—¥è®°äº†â€¦ 2. æŠ€æœ¯æ¡†æ¶ç½‘ä¸Šç›¸å…³çš„æ•™ç¨‹å…¶å®å·²ç»å¾ˆå¤šäº†ï¼Œå°±å¤§æ¦‚è¯´ä¸€ä¸‹ä¸»è¦ç”¨åˆ°çš„æŠ€æœ¯å­ã€‚ é¦–å…ˆæ˜¯é™æ€åšå®¢æ¡†æ¶ Hexoï¼Œä¸»é¢˜é‡‡ç”¨ Icarusã€‚ å¦å¤–å…³äº wordpress, vuepress, halo, jpress ç­‰åšå®¢æ¡†æ¶çš„å¯¹æ¯”åœ¨ç½‘ä¸Šå·²ç»æœ‰è®¸å¤šæ–‡ç« äº†ã€‚ç”±äºæœ€åˆçš„æƒ³æ³•æ˜¯è‡ªå·±å†™åç«¯ï¼Œå†ç”¨åŠ¨æ€åšå®¢æ¡†æ¶ï¼Œæ‰€ä»¥å°è¯•äº†åŸºäº Java çš„ Halo æ¡†æ¶ã€‚ä½†åæ¥æƒ³åˆ°å†™åšå®¢çš„åˆè¡·æˆ–è€…è¯´æ˜¯é‡ç‚¹åº”è¯¥æ˜¯åŸºäºåˆ›ä½œå†…å®¹çš„è´¨é‡ä¸Šï¼Œè€Œä¸æ˜¯ç½‘ç«™æœ‰å¤šå°‘åŠŸèƒ½æˆ–è€…å¤šé…·(å½“ç„¶å•¦ä¹Ÿå¸Œæœ›è‡ªå·±çš„ç½‘ç«™é…·ä¸€ç‚¹)ã€‚æ•…é‡‡ç”¨äº†ç›¸å¯¹æ–¹ä¾¿ä¸”ç®€æ´çš„ Hexoã€‚ å›åˆ°æ­£é¢˜ï¼ï¼ï¼ç»å†åƒè¾›ä¸‡è‹¦é…ç½®å¥½ç½‘ç«™åï¼Œå†éƒ¨ç½²åœ¨ github pages ä¸Š (ä¸è¦é—®ä¸ºä»€ä¹ˆè¦æŒ‚åœ¨å›½å¤–çš„æœåŠ¡å™¨ä¸Šï¼Œå› ä¸ºä¸èˆå¾—ä¹°æœåŠ¡å™¨äº†ï¼ï¼)ï¼Œç„¶åç”¨è‡ªå·±è´­ä¹°çš„åŸŸåCNAME åˆ° github pages é»˜è®¤çš„åŸŸå yourname.github.io ç”¨åˆ°çš„æ’ä»¶ï¼švaline(è¯„è®ºåŠŸèƒ½)ã€valine-admin(è¯„è®ºé€šçŸ¥åŠæ•°æ®ç®¡ç†)ã€sharethis(æ–‡ç« åˆ†äº«åŠŸèƒ½)ã€ä¸è’œå­(è®¿å®¢ç»Ÿè®¡)ã€ç™¾åº¦ç»Ÿè®¡(ç”¨äºæ•°æ®åˆ†æ)ã€google Adsense(ç½‘ç«™çš„å¹¿å‘Šä½)ã€hexo-renderer-marked(æ–‡ç« å›¾ç‰‡æ¸²æŸ“)ã€hexo-deployer-git(ä¸€é”®éƒ¨ç½²) ç´ æï¼šé˜¿é‡Œå·´å·´çŸ¢é‡å›¾æ ‡åº“ 3. è¯´åœ¨æœ€åç”±äºä¹‹å‰é™¤äº†å†™æŠ€æœ¯ç¬”è®°å¤–ï¼ŒåŸºæœ¬æ²¡å†™è¿‡ä»»ä½•ä¸œè¥¿ã€‚æ‰€ä»¥å°±å½“ä½œå°å­¦ç”Ÿå†™ä½œæ–‡ä¸€æ ·çœ‹çœ‹åˆ«åœ¨æ„ï¼ï¼ â€œè¡ŒåŠ¨æ¯”è¯´è¯æ›´æœ‰ä¿¡æœåŠ›ã€‚â€ï¼ˆå…¶å®å°±æ˜¯å¯¹è‡ªå·±è¯´çš„ T T ï¼‰ 4. ç›¸å…³æ–‡æ¡£ https://hexo.io Icaruså¿«é€Ÿä¸Šæ‰‹ - Icarus","link":"/2021/02/25/Hexo%E5%8D%9A%E5%AE%A2%E7%BD%91%E7%AB%99%E6%90%AD%E5%BB%BA/"},{"title":"MacAppæ¨è","text":"MacAppæ¨è é¼ æ ‡ï¼š sensible-side-buttons: è§£å†³é¼ æ ‡åœ¨macä¸Šå‰è¿›ã€åé€€ä¾§é”®ä¸å¯ç”¨ã€‚ steelseries-exactmouse-tool: ç§»é™¤macä¸Šçš„é¼ æ ‡åŠ é€Ÿåº¦ ç³»ç»Ÿï¼š avast: æ€æ¯’è½¯ä»¶ ä¸€é”®å‘å¸ƒï¼š openwrite","link":"/2021/03/07/MacApp%E6%8E%A8%E8%8D%90/"},{"title":"RabbitMQ Adv","text":"Github Project: Private Repo","link":"/2021/04/09/RabbitMQ-Adv/"},{"title":"","text":"å¶ç„¶çœ‹åˆ°ä¸€ä¸ªéŸ³ä¹çºªå½•ç‰‡ï¼Œæ˜¯å’Œé©¬æ€å”¯çš„æ–°ä¸“è¾‘ã€Šé»‘é©¬ã€‹ä¸­çš„ä¸€é¦–æ­Œã€Šä¸œå¤§è¡—ã€‹æœ‰å…³ã€‚è™½ç„¶ä¹‹å‰å°±å¬è¿‡è¿™é¦–æ­Œäº†ä½†æ˜¯æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æƒ…æ„Ÿï¼ˆä¹Ÿå’Œè‡ªå·±å¯¹æ–°ä¸“è¾‘çš„æœŸå¾…æ¯”è¾ƒé«˜æœ‰å…³å§ï¼‰ç°åœ¨çœ‹å®Œè¿˜æ˜¯æœ‰è®¸å¤šè¯´ä¸ä¸Šæ¥çš„æ„Ÿæ…¨ TT","link":"/2021/02/26/210226/"},{"title":"Redis6.0ä¹‹å¤šçº¿ç¨‹","text":"ä¸‹åˆå¤ªå›°äº†å°±åœ¨ç½‘ä¸Šéšä¾¿çœ‹çœ‹æ–‡ç« ã€‚ æ–‡ç« é“¾æ¥ï¼šRedis6.0ä¹‹å¤šçº¿ç¨‹ ä¸ªäººæ€»ç»“ï¼š å•çº¿ç¨‹RedisæŒ‡çš„æ˜¯åœ¨å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­ä½¿ç”¨å•çº¿ç¨‹ï¼Œè€Œå…¶å®ƒæ¨¡å—ä»ä¼šä½¿ç”¨å¤šçº¿ç¨‹ã€‚ è€Œredis6.0å¼•å…¥çš„å¤šçº¿ç¨‹æ˜¯åœ¨å¤„ç†è¯·æ±‚çš„ç½‘ç»œIOéƒ¨åˆ†ï¼Œå¤„ç†è¯·æ±‚çš„å…¶å®ƒæµç¨‹å¦‚Rediså‘½ä»¤æ‰§è¡Œï¼Œä¾ç„¶ä½¿ç”¨å•çº¿ç¨‹æ“ä½œã€‚","link":"/2021/04/02/Redis6-0%E4%B9%8B%E5%A4%9A%E7%BA%BF%E7%A8%8B/"},{"title":"RocketMQå’ŒRabbitMQçš„åŒºåˆ«","text":"è™½ç„¶éƒ½ä½¿ç”¨è¿‡è¿™ä¸¤ç§æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸è¿‡è¿˜æ˜¯å†™ä¸ªç®€å•çš„summaryå§ã€‚ æ¦‚è§ˆï¼šä¸¤è€…å‡å¼€æºï¼Œç”±äºrabbitmqæ›´æ—©å¼€æºä»¥åŠçº³å…¥SpringCloudä½“ç³»ï¼Œæ•…ç”¨æˆ·é‡æ›´å¤š(docker-hubæ›´ä¸ºæ˜æ˜¾ï¼Œä½†æ˜¯rocketmqåœ¨githubä¸Šæ›´å—æ¬¢è¿)ã€‚rocketmqä¼˜åŠ¿ä¸»è¦ä½“ç°åœ¨æ€§èƒ½ã€‚ è¿™é‡Œæ˜¯ä¸€ä¸ªä»ç½‘ä¸Šçœ‹åˆ°çš„æ€§èƒ½å¯¹æ¯”ï¼Œæ‰€ä»¥ä»…ä¾›å‚è€ƒï¼šKafkaååé‡17.3w/sï¼Œrocketmqååé‡11.6w/sï¼Œrabbitmqååé‡5.95w/sã€‚ ä¸šåŠ¡åŠŸèƒ½ï¼š åŠŸèƒ½ RocketMQ RabbitMQ é¡ºåºæ¶ˆæ¯ æ”¯æŒ ä¸æ”¯æŒ å…¨é“¾è·¯æ¶ˆæ¯è½¨è¿¹ æ”¯æŒ ä¸æ”¯æŒ æ¶ˆæ¯å †ç§¯èƒ½åŠ› ä¸å½±å“æ€§èƒ½ å½±å“æ€§èƒ½ æ¶ˆæ¯å›æº¯ æ”¯æŒ ä¸æ”¯æŒ å…¶å®ƒä¸€äº›åŠŸèƒ½ç»†èŠ‚å·®å¼‚ï¼š å¤±è´¥é‡è¯•ï¼šrabbitmqé»˜è®¤å¤±è´¥ä¸€ç›´é‡è¯•ï¼Œå¯è®¾ç½®é‡è¯•æ¬¡æ•°å’Œé‡è¯•é—´éš”ï¼Œè€Œrocketmqé»˜è®¤é‡è¯•2æ¬¡ï¼Œé—´éš”æ ¹æ®messageDelayLevelé€’å¢ã€‚ ä¸¤è€…è¾¾åˆ°é‡è¯•æ¬¡æ•°ä¸Šé™ï¼Œå‡ä¼šè‡ªåŠ¨ackæ¶ˆæ¯ï¼Œå†æŠŠæ¶ˆæ¯æŠ•é€’åˆ°æ­»ä¿¡é˜Ÿåˆ—DLQ(deadline queue)(rabbitmqä¸ä¼šè‡ªåŠ¨åˆ°DLQ)ã€‚rocketmqä¿å­˜DLQçš„æ¶ˆæ¯3å¤©ï¼Œå› ä¸ºæ‰€æœ‰æ¶ˆæ¯3å¤©ä¸æ¶ˆè´¹å‡ä¼šè¢«åˆ é™¤ã€‚ é€šå¸¸å»ºè®®å½“é‡è¯•æ¬¡æ•°è¾¾åˆ°ä¸Šé™åï¼Œ(Consumerç«¯)å›æ»šäº‹åŠ¡å¹¶ä¿å­˜é”™è¯¯æ—¥å¿—(å°½é‡ä¸è¦ä½¿ç”¨æ‰‹åŠ¨ackæ¶ˆæ¯)ã€‚è‹¥æ˜¯å› ä¸ºæ¶ˆæ¯å‘é€å¤±è´¥è€Œè§¦å‘é‡è¯•ï¼Œåˆ™è¦æ ¹æ®SendResultçš„SendStateçŠ¶æ€æ¥åšå¤„ç†ã€‚å…¶ä¸­ï¼Œrocketmqå¯é€šè¿‡MessageExtè·å–é‡è¯•æ¬¡æ•°ï¼Œè€Œrabbitmqéœ€è¦è‡ªè¡Œå®ç°ï¼ˆå¦‚ä½¿ç”¨redisï¼Œæ¶ˆæ¯çš„ä¸»é”®å¦‚orderId/messageIdåškeyï¼Œæ¶ˆè´¹æ¬¡æ•°åšvalï¼‰ã€‚ å¦å¤–ï¼Œè¦æ³¨æ„å¦‚æœåœ¨æ¶ˆæ¯æ¶ˆè´¹ä½¿ç”¨äº†try/catchæˆ–å…¨å±€å¼‚å¸¸å¤„ç†å¼‚å¸¸ï¼Œä¼šå¯¼è‡´rocketmqè·å–ä¸åˆ°å¼‚å¸¸å¯¼è‡´è§¦å‘ä¸äº†é‡è¯•æœºåˆ¶ã€‚ æœ€åï¼Œç›¸è¾ƒKafkaè¿™ä¸¤æ¬¾æ¶ˆæ¯ç»„ä»¶è™½ç„¶æ€§èƒ½ä¸åŠå®ƒï¼Œä½†ç”±äºæ˜¯é¢å‘å…·ä½“ä¸šåŠ¡è€Œç”Ÿçš„(Kafkaé¢å‘æ•°æ®/æ—¥å¿—)ï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯æ¶ˆæ¯å¯é æ€§ä¸Šè¿˜æ˜¯åŠŸèƒ½ä¸Šæ›´å…·ä¼˜åŠ¿ã€‚ ä¸€äº›æ¦‚å¿µä¸Šçš„å¯¹åº”å…³ç³»ï¼š","link":"/2021/04/02/RocketMQ%E5%92%8CRabbitMQ%E7%9A%84%E5%8C%BA%E5%88%AB/"},{"title":"ShardingSphere","text":"ShardingSphere ShardingSphere 1. æ¦‚å¿µ &amp; åŠŸèƒ½1.1 æ•°æ®åˆ†ç‰‡ æ•°æ®åˆ†ç‰‡æŒ‡æŒ‰ç…§æŸä¸ªç»´åº¦å°†å­˜æ”¾åœ¨å•ä¸€æ•°æ®åº“ä¸­çš„æ•°æ®åˆ†æ•£åœ°å­˜æ”¾è‡³å¤šä¸ªæ•°æ®åº“æˆ–è¡¨ä¸­ã€‚ å‚ç›´åˆ†ç‰‡ æŒ‰ç…§ä¸šåŠ¡æ‹†åˆ†çš„æ–¹å¼ç§°ä¸ºå‚ç›´åˆ†ç‰‡ï¼Œåˆç§°ä¸ºçºµå‘æ‹†åˆ†ï¼Œå®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ä¸“åº“ä¸“ç”¨ã€‚ åœ¨æ‹†åˆ†ä¹‹å‰ï¼Œä¸€ä¸ªæ•°æ®åº“ç”±å¤šä¸ªæ•°æ®è¡¨æ„æˆï¼Œæ¯ä¸ªè¡¨å¯¹åº”ç€ä¸åŒçš„ä¸šåŠ¡ã€‚è€Œæ‹†åˆ†ä¹‹åï¼Œåˆ™æ˜¯æŒ‰ç…§ä¸šåŠ¡å°†è¡¨è¿›è¡Œå½’ç±»ï¼Œåˆ†å¸ƒåˆ°ä¸åŒçš„æ•°æ®åº“ä¸­ï¼Œä»è€Œå°†å‹åŠ›åˆ†æ•£è‡³ä¸åŒçš„æ•°æ®åº“ã€‚ ä¸‹å›¾å±•ç¤ºäº†æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œå°†ç”¨æˆ·è¡¨å’Œè®¢å•è¡¨å‚ç›´åˆ†ç‰‡åˆ°ä¸åŒçš„æ•°æ®åº“çš„æ–¹æ¡ˆã€‚(å³åˆ†åº“) å‚ç›´åˆ†ç‰‡å¾€å¾€éœ€è¦å¯¹æ¶æ„å’Œè®¾è®¡è¿›è¡Œè°ƒæ•´ã€‚é€šå¸¸æ¥è®²ï¼Œæ˜¯æ¥ä¸åŠåº”å¯¹äº’è”ç½‘ä¸šåŠ¡éœ€æ±‚å¿«é€Ÿå˜åŒ–çš„ï¼›è€Œä¸”ï¼Œå®ƒä¹Ÿå¹¶æ— æ³•çœŸæ­£çš„è§£å†³å•ç‚¹ç“¶é¢ˆã€‚ å‚ç›´æ‹†åˆ†å¯ä»¥ç¼“è§£æ•°æ®é‡å’Œè®¿é—®é‡å¸¦æ¥çš„é—®é¢˜ï¼Œä½†æ— æ³•æ ¹æ²»ã€‚å¦‚æœå‚ç›´æ‹†åˆ†ä¹‹åï¼Œè¡¨ä¸­çš„æ•°æ®é‡ä¾ç„¶è¶…è¿‡å•èŠ‚ç‚¹æ‰€èƒ½æ‰¿è½½çš„é˜ˆå€¼ï¼Œåˆ™éœ€è¦æ°´å¹³åˆ†ç‰‡æ¥è¿›ä¸€æ­¥å¤„ç†ã€‚ æ°´å¹³åˆ†ç‰‡ æ°´å¹³åˆ†ç‰‡åˆç§°ä¸ºæ¨ªå‘æ‹†åˆ†ã€‚ ç›¸å¯¹äºå‚ç›´åˆ†ç‰‡ï¼Œå®ƒä¸å†å°†æ•°æ®æ ¹æ®ä¸šåŠ¡é€»è¾‘åˆ†ç±»ï¼Œè€Œæ˜¯é€šè¿‡æŸä¸ªå­—æ®µï¼ˆæˆ–æŸå‡ ä¸ªå­—æ®µï¼‰ï¼Œæ ¹æ®æŸç§è§„åˆ™å°†æ•°æ®åˆ†æ•£è‡³å¤šä¸ªåº“æˆ–è¡¨ä¸­ï¼Œæ¯ä¸ªåˆ†ç‰‡ä»…åŒ…å«æ•°æ®çš„ä¸€éƒ¨åˆ†ã€‚ ä¾‹å¦‚ï¼šæ ¹æ®ä¸»é”®åˆ†ç‰‡ï¼Œå¶æ•°ä¸»é”®çš„è®°å½•æ”¾å…¥0åº“ï¼ˆæˆ–è¡¨ï¼‰ï¼Œå¥‡æ•°ä¸»é”®çš„è®°å½•æ”¾å…¥1åº“ï¼ˆæˆ–è¡¨ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚(å³åˆ†è¡¨åˆ†åº“) æ°´å¹³åˆ†ç‰‡ä»ç†è®ºä¸Šçªç ´äº†å•æœºæ•°æ®é‡å¤„ç†çš„ç“¶é¢ˆï¼Œå¹¶ä¸”æ‰©å±•ç›¸å¯¹è‡ªç”±ï¼Œæ˜¯åˆ†åº“åˆ†è¡¨çš„æ ‡å‡†è§£å†³æ–¹æ¡ˆã€‚ Challengeï¼šæ•°æ®æŸ¥è¯¢&amp;èšåˆ&amp;åˆ†ç»„ã€åˆ†é¡µã€æ’åºã€åˆ†å¸ƒå¼äº‹åŠ¡(åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡(MYCAT)ç”±äºåœ¨å¹¶å‘åº¦é«˜çš„åœºæ™¯ä¸­æ€§èƒ½æ— æ³•æ»¡è¶³éœ€è¦ï¼Œå¹¶æœªè¢«äº’è”ç½‘å·¨å¤´å¤§è§„æ¨¡ä½¿ç”¨ï¼Œä»–ä»¬å¤§å¤šé‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§çš„æŸ”æ€§äº‹åŠ¡ä»£æ›¿å¼ºä¸€è‡´äº‹åŠ¡) åˆ†ç‰‡ç›¸å…³æ¦‚å¿µ é€»è¾‘è¡¨(logic table)ï¼št_order çœŸå®è¡¨(actual table)ï¼št_order_0åˆ°t_order_9 æ•°æ®èŠ‚ç‚¹(data node)ï¼šæ•°æ®åˆ†ç‰‡çš„æœ€å°å•å…ƒã€‚ç”±æ•°æ®æºåç§°å’Œæ•°æ®è¡¨ç»„æˆï¼Œä¾‹ï¼šds_0.t_order_0ã€‚ ç»‘å®šè¡¨(binding table) å¹¿æ’­è¡¨æ˜¯ä»€ä¹ˆâ€¦. åˆ†ç‰‡é”®ï¼šç”¨äºæ•°æ®åº“åˆ†ç‰‡çš„(1ä¸ªæˆ–å¤šä¸ª)å­—æ®µã€‚ SQLä¸­å¦‚æœæ— åˆ†ç‰‡å­—æ®µï¼Œå°†æ‰§è¡Œå…¨è·¯ç”±ï¼Œæ€§èƒ½è¾ƒå·®ã€‚ åˆ†ç‰‡ç®—æ³• åˆ†ç‰‡ç­–ç•¥ï¼ˆåˆ†ç‰‡é”® + åˆ†ç‰‡ç®—æ³•ï¼‰ SQL Hintå¯¹äºåˆ†ç‰‡å­—æ®µéSQLå†³å®šï¼Œè€Œç”±å…¶ä»–å¤–ç½®æ¡ä»¶å†³å®šçš„åœºæ™¯ï¼Œå¯ä½¿ç”¨SQL Hintçµæ´»çš„æ³¨å…¥åˆ†ç‰‡å­—æ®µã€‚ä¾‹ï¼šå†…éƒ¨ç³»ç»Ÿï¼ŒæŒ‰ç…§å‘˜å·¥ç™»å½•ä¸»é”®åˆ†åº“ï¼Œè€Œæ•°æ®åº“ä¸­å¹¶æ— æ­¤å­—æ®µã€‚SQL Hintæ”¯æŒé€šè¿‡Java APIå’ŒSQLæ³¨é‡Š(å¾…å®ç°)ä¸¤ç§æ–¹å¼ä½¿ç”¨ã€‚ åˆ†ç‰‡ç­–ç•¥é…ç½® è‡ªå¢ä¸»é”®ç”Ÿæˆç­–ç•¥é€šè¿‡åœ¨å®¢æˆ·ç«¯ç”Ÿæˆè‡ªå¢ä¸»é”®æ›¿æ¢ä»¥æ•°æ®åº“åŸç”Ÿè‡ªå¢ä¸»é”®çš„æ–¹å¼ï¼Œåšåˆ°åˆ†å¸ƒå¼ä¸»é”®æ— é‡å¤ã€‚ 1.2 å†…éƒ¨æ‰§è¡Œæµç¨‹ ShardingSphereçš„3ä¸ªäº§å“çš„æ•°æ®åˆ†ç‰‡ä¸»è¦æµç¨‹æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚ æ ¸å¿ƒç”±SQLè§£æ =&gt; æ‰§è¡Œå™¨ä¼˜åŒ– =&gt; SQLè·¯ç”± =&gt; SQLæ”¹å†™ =&gt; SQLæ‰§è¡Œ =&gt; ç»“æœå½’å¹¶çš„æµç¨‹ç»„æˆã€‚ è§£æå¼•æ“(Parse Engine)è§£æè¿‡ç¨‹åˆ†ä¸ºè¯æ³•è§£æå’Œè¯­æ³•è§£æã€‚ è¯æ³•è§£æï¼šå°†SQLæ‹†è§£ä¸ºä¸å¯å†åˆ†çš„åŸå­ç¬¦å·ï¼Œç§°ä¸ºTokenï¼ˆç»¿è‰²ï¼‰ã€‚è¯­æ³•è§£æï¼šå°†SQLè½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ã€‚ 1SELECT id, name FROM t_user WHERE status = 'ACTIVE' AND age &gt; 18 è·¯ç”±å¼•æ“(Route Engine)æ”¹å†™å¼•æ“(Rewrite Engine)æ‰§è¡Œå¼•æ“(Execute Engine)å½’å¹¶å¼•æ“(Merger Engine)1.3 æ³¨æ„äº‹é¡¹ ä¸æ”¯æŒè·¨åº“å…³è”æŸ¥è¯¢ ä¸æ”¯æŒCASE WHENã€HAVINGã€UNION (ALL)ï¼Œæœ‰é™æ”¯æŒå­æŸ¥è¯¢ï¼ˆç”±äºå½’å¹¶çš„é™åˆ¶ï¼Œå­æŸ¥è¯¢ä¸­åŒ…å«èšåˆå‡½æ•°ç›®å‰æ— æ³•æ”¯æŒã€‚ï¼‰ è¿ç®—è¡¨è¾¾å¼å’Œå‡½æ•°ä¸­çš„åˆ†ç‰‡é”®ï¼ˆsharding columnï¼‰ä¼šå¯¼è‡´å…¨è·¯ç”±ã€‚ 2. sharding-jdbc ä»‹ç»2.1 è¿è¡Œæµç¨‹ 2.2 åŠŸèƒ½ç‰¹æ€§æ•°æ®åˆ†ç‰‡ åˆ†åº“ &amp; åˆ†è¡¨ è¯»å†™åˆ†ç¦» åˆ†ç‰‡ç­–ç•¥å®šåˆ¶åŒ– æ— ä¸­å¿ƒåŒ–åˆ†å¸ƒå¼ä¸»é”® åˆ†å¸ƒå¼äº‹åŠ¡ æ ‡å‡†åŒ–äº‹åŠ¡æ¥å£ XAå¼ºä¸€è‡´äº‹åŠ¡ æŸ”æ€§äº‹åŠ¡ æ•°æ®åº“æ²»ç† é…ç½®åŠ¨æ€åŒ– ç¼–æ’ &amp; æ²»ç† æ•°æ®è„±æ• å¯è§†åŒ–é“¾è·¯è¿½è¸ª å¼¹æ€§ä¼¸ç¼©(è§„åˆ’ä¸­) ä¸æ”¯æŒçš„åŠŸèƒ½ï¼ˆå³ç¼ºç‚¹ï¼‰ https://shardingsphere.apache.org/document/legacy/4.x/document/cn/manual/sharding-jdbc/unsupported-items/ é¢ä¸´é—®é¢˜ è¶Šè·å–åç§»é‡ä½ç½®é åæ•°æ®ï¼Œä½¿ç”¨LIMITåˆ†é¡µæ–¹å¼çš„æ•ˆç‡å°±è¶Šä½ã€‚ æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥é¿å…ä½¿ç”¨LIMITè¿›è¡Œåˆ†é¡µã€‚æ¯”å¦‚æ„å»ºè¡Œè®°å½•æ•°é‡ä¸è¡Œåç§»é‡çš„äºŒçº§ç´¢å¼•ï¼Œæˆ–ä½¿ç”¨ä¸Šæ¬¡åˆ†é¡µæ•°æ®ç»“å°¾IDä½œä¸ºä¸‹æ¬¡æŸ¥è¯¢æ¡ä»¶çš„åˆ†é¡µæ–¹å¼ç­‰ã€‚ è‹¥idä¸ºuuidç­‰æ— åºå­—ç¬¦ï¼Œåˆ™è€ƒè™‘ä½¿ç”¨æ—¶é—´èŒƒå›´æŸ¥è¯¢ã€‚ä¸ç„¶å°±æ²¡åŠæ³•å•¦ã€‚ ShardingSphereè¿›è¡Œäº†2ä¸ªæ–¹é¢çš„ä¼˜åŒ–ã€‚ é¦–å…ˆï¼Œé‡‡ç”¨æµå¼å¤„ç† + å½’å¹¶æ’åºçš„æ–¹å¼æ¥é¿å…å†…å­˜çš„è¿‡é‡å ç”¨ã€‚ç”±äºSQLæ”¹å†™ä¸å¯é¿å…çš„å ç”¨äº†é¢å¤–çš„å¸¦å®½ï¼Œä½†å¹¶ä¸ä¼šå¯¼è‡´å†…å­˜æš´æ¶¨ã€‚ ä¸ç›´è§‰ä¸åŒï¼Œå¤§å¤šæ•°äººè®¤ä¸ºShardingSphereä¼šå°†1,000,010 * 2è®°å½•å…¨éƒ¨åŠ è½½è‡³å†…å­˜ï¼Œè¿›è€Œå ç”¨å¤§é‡å†…å­˜è€Œå¯¼è‡´å†…å­˜æº¢å‡ºã€‚ ä½†ç”±äºæ¯ä¸ªç»“æœé›†çš„è®°å½•æ˜¯æœ‰åºçš„ï¼Œå› æ­¤ShardingSphereæ¯æ¬¡æ¯”è¾ƒä»…è·å–å„ä¸ªåˆ†ç‰‡çš„å½“å‰ç»“æœé›†è®°å½•ï¼Œé©»ç•™åœ¨å†…å­˜ä¸­çš„è®°å½•ä»…ä¸ºå½“å‰è·¯ç”±åˆ°çš„åˆ†ç‰‡çš„ç»“æœé›†çš„å½“å‰æ¸¸æ ‡æŒ‡å‘è€Œå·²ã€‚ å¯¹äºæœ¬èº«å³æœ‰åºçš„å¾…æ’åºå¯¹è±¡ï¼Œå½’å¹¶æ’åºçš„æ—¶é—´å¤æ‚åº¦ä»…ä¸ºO(n)ï¼Œæ€§èƒ½æŸè€—å¾ˆå°ã€‚ å…¶æ¬¡ï¼ŒShardingSphereå¯¹ä»…è½è‡³å•åˆ†ç‰‡çš„æŸ¥è¯¢è¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚ è½è‡³å•åˆ†ç‰‡æŸ¥è¯¢çš„è¯·æ±‚å¹¶ä¸éœ€è¦æ”¹å†™SQLä¹Ÿå¯ä»¥ä¿è¯è®°å½•çš„æ­£ç¡®æ€§ï¼Œå› æ­¤åœ¨æ­¤ç§æƒ…å†µä¸‹ï¼ŒShardingSphereå¹¶æœªè¿›è¡ŒSQLæ”¹å†™ï¼Œä»è€Œè¾¾åˆ°èŠ‚çœå¸¦å®½çš„ç›®çš„ã€‚ PageHelper æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ æ²¡æœ‰è§£å†³ï¼Œä¹Ÿæ˜¯é€šè¿‡ limit æ‹¼æ¥ SQL æ¥å®ç°åˆ†é¡µåŠŸèƒ½çš„ã€‚ å¯ä»¥é€šè¿‡æŸ¥è¯¢ä¸»é”®å†è”è¡¨è§£å†³ã€‚ 123456select * from user where age = 10 limit 100000,10;&lt;!-- æ”¹å†™æˆ --&gt;SELECT a.* FROM USER aINNER JOIN (SELECT id FROM USER WHERE age = 10 LIMIT 100000,10) b ON a.id = b.id; 3. å¿«é€Ÿå¼€å§‹3.1 é…ç½®ä»‹ç»æ•°æ®åˆ†ç‰‡ (Data Sharding)12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667spring: shardingsphere: datasource: &lt;data-source-name&gt;: driver-class-name: '#æ•°æ®åº“é©±åŠ¨ç±»å' password: '#æ•°æ®åº“å¯†ç ' type: '#æ•°æ®åº“è¿æ¥æ± ç±»åç§°' url: '#æ•°æ®åº“urlè¿æ¥' username: '#æ•°æ®åº“ç”¨æˆ·å' xxx: '#æ•°æ®åº“è¿æ¥æ± çš„å…¶å®ƒå±æ€§' names: '#æ•°æ®æºåç§°ï¼Œå¤šæ•°æ®æºä»¥é€—å·åˆ†éš”' props: executor: size: '#å·¥ä½œçº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤å€¼: CPUæ ¸æ•°' sql: show: '#æ˜¯å¦å¼€å¯SQLæ˜¾ç¤ºï¼Œé»˜è®¤å€¼: false' sharding: binding-tables: - '#ç»‘å®šè¡¨è§„åˆ™åˆ—è¡¨' - '#ç»‘å®šè¡¨è§„åˆ™åˆ—è¡¨' binding-tables[x]: '#ç»‘å®šè¡¨è§„åˆ™åˆ—è¡¨' broadcast-tables: - '#å¹¿æ’­è¡¨è§„åˆ™åˆ—è¡¨' - '#å¹¿æ’­è¡¨è§„åˆ™åˆ—è¡¨' broadcast-tables[x]: '#å¹¿æ’­è¡¨è§„åˆ™åˆ—è¡¨' default-data-source-name: '#æœªé…ç½®åˆ†ç‰‡è§„åˆ™çš„è¡¨å°†é€šè¿‡é»˜è®¤æ•°æ®æºå®šä½' default-database-strategy: xxx: '#é»˜è®¤æ•°æ®åº“åˆ†ç‰‡ç­–ç•¥ï¼ŒåŒåˆ†åº“ç­–ç•¥' default-key-generator: props: &lt;property-name&gt;: '#è‡ªå¢åˆ—å€¼ç”Ÿæˆå™¨å±æ€§é…ç½®, æ¯”å¦‚SNOWFLAKEç®—æ³•çš„worker.idä¸max.tolerate.time.difference.milliseconds' type: '#é»˜è®¤è‡ªå¢åˆ—å€¼ç”Ÿæˆå™¨ç±»å‹ï¼Œç¼ºçœå°†ä½¿ç”¨org.apache.shardingsphere.core.keygen.generator.impl.SnowflakeKeyGeneratorã€‚å¯ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„åˆ—å€¼ç”Ÿæˆå™¨æˆ–é€‰æ‹©å†…ç½®ç±»å‹ï¼šSNOWFLAKE/UUID' default-table-strategy: xxx: '#é»˜è®¤è¡¨åˆ†ç‰‡ç­–ç•¥ï¼ŒåŒåˆ†è¡¨ç­–ç•¥' master-slave-rules: &lt;master-slave-data-source-name&gt;: load-balance-algorithm-class-name: '#è¯¦è§è¯»å†™åˆ†ç¦»éƒ¨åˆ†' load-balance-algorithm-type: '#è¯¦è§è¯»å†™åˆ†ç¦»éƒ¨åˆ†' master-data-source-name: '#è¯¦è§è¯»å†™åˆ†ç¦»éƒ¨åˆ†' slave-data-source-names: - '#è¯¦è§è¯»å†™åˆ†ç¦»éƒ¨åˆ†' - '#è¯¦è§è¯»å†™åˆ†ç¦»éƒ¨åˆ†' slave-data-source-names[x]: '#è¯¦è§è¯»å†™åˆ†ç¦»éƒ¨åˆ†' tables: &lt;logic-table-name&gt;: actual-data-nodes: '#ç”±æ•°æ®æºå + è¡¨åç»„æˆï¼Œä»¥å°æ•°ç‚¹åˆ†éš”ã€‚å¤šä¸ªè¡¨ä»¥é€—å·åˆ†éš”ï¼Œæ”¯æŒinlineè¡¨è¾¾å¼ã€‚ç¼ºçœè¡¨ç¤ºä½¿ç”¨å·²çŸ¥æ•°æ®æºä¸é€»è¾‘è¡¨åç§°ç”Ÿæˆæ•°æ®èŠ‚ç‚¹ï¼Œç”¨äºå¹¿æ’­è¡¨ï¼ˆå³æ¯ä¸ªåº“ä¸­éƒ½éœ€è¦ä¸€ä¸ªåŒæ ·çš„è¡¨ç”¨äºå…³è”æŸ¥è¯¢ï¼Œå¤šä¸ºå­—å…¸è¡¨ï¼‰æˆ–åªåˆ†åº“ä¸åˆ†è¡¨ä¸”æ‰€æœ‰åº“çš„è¡¨ç»“æ„å®Œå…¨ä¸€è‡´çš„æƒ…å†µ' database-strategy: complex: algorithm-class-name: '#å¤åˆåˆ†ç‰‡ç®—æ³•ç±»åç§°ã€‚è¯¥ç±»éœ€å®ç°ComplexKeysShardingAlgorithmæ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨' sharding-columns: '#åˆ†ç‰‡åˆ—åç§°ï¼Œå¤šä¸ªåˆ—ä»¥é€—å·åˆ†éš”' hint: algorithm-class-name: '#Hintåˆ†ç‰‡ç®—æ³•ç±»åç§°ã€‚è¯¥ç±»éœ€å®ç°HintShardingAlgorithmæ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨' inline: algorithm-expression: '#åˆ†ç‰‡ç®—æ³•è¡Œè¡¨è¾¾å¼ï¼Œéœ€ç¬¦åˆgroovyè¯­æ³•' sharding-column: '#åˆ†ç‰‡åˆ—åç§°' standard: precise-algorithm-class-name: '#ç²¾ç¡®åˆ†ç‰‡ç®—æ³•ç±»åç§°ï¼Œç”¨äº=å’ŒINã€‚è¯¥ç±»éœ€å®ç°PreciseShardingAlgorithmæ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨' range-algorithm-class-name: '#èŒƒå›´åˆ†ç‰‡ç®—æ³•ç±»åç§°ï¼Œç”¨äºBETWEENï¼Œå¯é€‰ã€‚è¯¥ç±»éœ€å®ç°RangeShardingAlgorithmæ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨' sharding-column: '#åˆ†ç‰‡åˆ—åç§°' key-generator: column: '#è‡ªå¢åˆ—åç§°ï¼Œç¼ºçœè¡¨ç¤ºä¸ä½¿ç”¨è‡ªå¢ä¸»é”®ç”Ÿæˆå™¨' props: &lt;property-name&gt;: '#å±æ€§é…ç½®, æ³¨æ„ï¼šä½¿ç”¨SNOWFLAKEç®—æ³•ï¼Œéœ€è¦é…ç½®worker.idä¸max.tolerate.time.difference.millisecondså±æ€§ã€‚è‹¥ä½¿ç”¨æ­¤ç®—æ³•ç”Ÿæˆå€¼ä½œåˆ†ç‰‡å€¼ï¼Œå»ºè®®é…ç½®max.vibration.offsetå±æ€§' type: '#è‡ªå¢åˆ—å€¼ç”Ÿæˆå™¨ç±»å‹ï¼Œç¼ºçœè¡¨ç¤ºä½¿ç”¨é»˜è®¤è‡ªå¢åˆ—å€¼ç”Ÿæˆå™¨ã€‚å¯ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„åˆ—å€¼ç”Ÿæˆå™¨æˆ–é€‰æ‹©å†…ç½®ç±»å‹ï¼šSNOWFLAKE/UUID' table-strategy: xxx: '#çœç•¥' è¯»å†™åˆ†ç¦» (Read-Write Split)æ”¯æŒï¼š æä¾›ä¸€ä¸»å¤šä»çš„è¯»å†™åˆ†ç¦»é…ç½®ï¼Œå¯ç‹¬ç«‹ä½¿ç”¨ï¼Œä¹Ÿå¯é…åˆåˆ†åº“åˆ†è¡¨ä½¿ç”¨ã€‚ ç‹¬ç«‹ä½¿ç”¨è¯»å†™åˆ†ç¦»æ”¯æŒSQLé€ä¼ ã€‚ åŒä¸€çº¿ç¨‹ä¸”åŒä¸€æ•°æ®åº“è¿æ¥å†…ï¼Œå¦‚æœ‰å†™å…¥æ“ä½œï¼Œä»¥åçš„è¯»æ“ä½œå‡ä»ä¸»åº“è¯»å–ï¼Œç”¨äºä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ åŸºäºHintçš„å¼ºåˆ¶ä¸»åº“è·¯ç”±ã€‚ ä¸æ”¯æŒï¼š ä¸»åº“å’Œä»åº“çš„æ•°æ®åŒæ­¥ã€‚ ä¸»åº“å’Œä»åº“çš„æ•°æ®åŒæ­¥å»¶è¿Ÿå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚ ä¸»åº“åŒå†™æˆ–å¤šå†™ã€‚ è·¨ä¸»åº“å’Œä»åº“ä¹‹é—´çš„äº‹åŠ¡çš„æ•°æ®ä¸ä¸€è‡´ã€‚ä¸»ä»æ¨¡å‹ä¸­ï¼Œäº‹åŠ¡ä¸­è¯»å†™å‡ç”¨ä¸»åº“ã€‚ 12345678910111213141516171819202122spring: shardingsphere: props: check: table: metadata: enabled: '#æ˜¯å¦åœ¨å¯åŠ¨æ—¶æ£€æŸ¥åˆ†è¡¨å…ƒæ•°æ®ä¸€è‡´æ€§ï¼Œé»˜è®¤å€¼: false' executor: size: '#å·¥ä½œçº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤å€¼: CPUæ ¸æ•°' sql: show: '#æ˜¯å¦å¼€å¯SQLæ˜¾ç¤ºï¼Œé»˜è®¤å€¼: false' sharding: master-slave-rules: &lt;master-slave-data-source-name&gt;: load-balance-algorithm-class-name: '#ä»åº“è´Ÿè½½å‡è¡¡ç®—æ³•ç±»åç§°ã€‚è¯¥ç±»éœ€å®ç°MasterSlaveLoadBalanceAlgorithmæ¥å£ä¸”æä¾›æ— å‚æ•°æ„é€ å™¨' load-balance-algorithm-type: '#ä»åº“è´Ÿè½½å‡è¡¡ç®—æ³•ç±»å‹ï¼Œå¯é€‰å€¼ï¼šROUND_ROBINï¼ŒRANDOMã€‚è‹¥`load-balance-algorithm-class-name`å­˜åœ¨åˆ™å¿½ç•¥è¯¥é…ç½®' master-data-source-name: '#ä¸»åº“æ•°æ®æºåç§°' slave-data-source-names: - '#ä»åº“æ•°æ®æºåç§°åˆ—è¡¨' - '#ä»åº“æ•°æ®æºåç§°åˆ—è¡¨' slave-data-source-names[x]: '#ä»åº“æ•°æ®æºåç§°åˆ—è¡¨' æ•°æ®è„±æ• (Data Masking)1234567891011121314151617spring: shardingsphere: encrypt: encryptors: &lt;encryptor-name&gt;: props: &lt;property-name&gt;: '#å±æ€§é…ç½®, æ³¨æ„ï¼šä½¿ç”¨AESåŠ å¯†å™¨ï¼Œéœ€è¦é…ç½®AESåŠ å¯†å™¨çš„KEYå±æ€§ï¼šaes.key.value' type: '#åŠ è§£å¯†å™¨ç±»å‹ï¼Œå¯è‡ªå®šä¹‰æˆ–é€‰æ‹©å†…ç½®ç±»å‹ï¼šMD5/AES ' tables: &lt;table-name&gt;: columns: &lt;logic-column-name&gt;: assistedQueryColumn: '#è¾…åŠ©æŸ¥è¯¢å­—æ®µï¼Œé’ˆå¯¹ShardingQueryAssistedEncryptorç±»å‹çš„åŠ è§£å¯†å™¨è¿›è¡Œè¾…åŠ©æŸ¥è¯¢' cipherColumn: '#å­˜å‚¨å¯†æ–‡çš„å­—æ®µ' encryptor: '#åŠ å¯†å™¨åå­—' plainColumn: '#å­˜å‚¨æ˜æ–‡çš„å­—æ®µ' æ²»ç† (Orchestration)12345678910111213141516spring: shardingsphere: orchestration: name: '#æ²»ç†å®ä¾‹åç§°' overwrite: '#æœ¬åœ°é…ç½®æ˜¯å¦è¦†ç›–æ³¨å†Œä¸­å¿ƒé…ç½®ã€‚å¦‚æœå¯è¦†ç›–ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½ä»¥æœ¬åœ°é…ç½®ä¸ºå‡†' registry: digest: '#è¿æ¥æ³¨å†Œä¸­å¿ƒçš„æƒé™ä»¤ç‰Œã€‚ç¼ºçœä¸ºä¸éœ€è¦æƒé™éªŒè¯' max-retries: '#è¿æ¥å¤±è´¥åçš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡' namespace: '#æ³¨å†Œä¸­å¿ƒçš„å‘½åç©ºé—´' operation-timeout-milliseconds: '#æ“ä½œè¶…æ—¶çš„æ¯«ç§’æ•°ï¼Œé»˜è®¤500æ¯«ç§’' props: '#é…ç½®ä¸­å¿ƒå…¶å®ƒå±æ€§' retry-interval-milliseconds: '#é‡è¯•é—´éš”æ¯«ç§’æ•°ï¼Œé»˜è®¤500æ¯«ç§’' server-lists: '#è¿æ¥æ³¨å†Œä¸­å¿ƒæœåŠ¡å™¨çš„åˆ—è¡¨ã€‚åŒ…æ‹¬IPåœ°å€å’Œç«¯å£å·ã€‚å¤šä¸ªåœ°å€ç”¨é€—å·åˆ†éš”ã€‚å¦‚: host1:2181,host2:2181' time-to-live-seconds: '#ä¸´æ—¶èŠ‚ç‚¹å­˜æ´»ç§’æ•°ï¼Œé»˜è®¤60ç§’' type: '#é…ç½®ä¸­å¿ƒç±»å‹ã€‚å¦‚ï¼šzookeeper' 3.2 ä»£ç ç¤ºä¾‹ åˆ›å»º DataSourceï¼šé€šè¿‡ShardingDataSourceFactoryå·¥å‚å’Œè§„åˆ™é…ç½®å¯¹è±¡è·å–ShardingDataSourceï¼ŒShardingDataSourceå®ç°è‡ªJDBCçš„æ ‡å‡†æ¥å£DataSourceã€‚ç„¶åå³å¯é€šè¿‡DataSourceé€‰æ‹©ä½¿ç”¨åŸç”ŸJDBCå¼€å‘ï¼Œæˆ–è€…ä½¿ç”¨JPA, MyBatisç­‰ORMå·¥å…·ã€‚ ä½¿ç”¨ MyBatisä½¿ç”¨ JPA","link":"/2021/03/14/ShardingSphere/"},{"title":"Spring Cloud å¿«é€Ÿé›†æˆ Seata","text":"Spring Cloud å¿«é€Ÿé›†æˆ Seata 1. æ·»åŠ ä¾èµ–æ·»åŠ Spring Cloud Alibaba ä¾èµ–ç®¡ç†å·¥å…·å’Œ Seata ä¾èµ– Gradle 12345dependencyManagement { imports { mavenBom &quot;com.alibaba.cloud:spring-cloud-alibaba-dependencies:2.1.0.RELEASE&quot; }} 123dependencies { compile('com.alibaba.cloud:spring-cloud-starter-alibaba-seata')} Maven 1234567891011&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt; &lt;version&gt;2.1.0.RELEASE&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;&lt;/dependency&gt; éœ€è¦æ³¨æ„çš„æ˜¯Spring Cloud Alibaba çš„æ¯•ä¸šç‰ˆæœ¬çš„ GroupId æ˜¯ com.alibaba.cloud spring-cloud-starter-alibaba-seataè¿™ä¸ªä¾èµ–ä¸­åªä¾èµ–äº†spring-cloud-alibaba-seataï¼Œæ‰€ä»¥åœ¨é¡¹ç›®ä¸­æ·»åŠ spring-cloud-starter-alibaba-seataå’Œspring-cloud-alibaba-seataæ˜¯ä¸€æ ·çš„ 2. æ·»åŠ Seata é…ç½®æ–‡ä»¶registry.confè¯¥é…ç½®ç”¨äºæŒ‡å®š TC çš„æ³¨å†Œä¸­å¿ƒå’Œé…ç½®æ–‡ä»¶ï¼Œé»˜è®¤éƒ½æ˜¯ file; å¦‚æœä½¿ç”¨å…¶ä»–çš„æ³¨å†Œä¸­å¿ƒï¼Œè¦æ±‚ Seata-Server ä¹Ÿæ³¨å†Œåˆ°è¯¥é…ç½®ä¸­å¿ƒä¸Š registry.conf 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374registry { # file ã€nacos ã€eurekaã€redisã€zkã€consulã€etcd3ã€sofa type = &quot;file&quot; nacos { serverAddr = &quot;localhost&quot; namespace = &quot;public&quot; cluster = &quot;default&quot; } eureka { serviceUrl = &quot;http://localhost:8761/eureka&quot; application = &quot;default&quot; weight = &quot;1&quot; } redis { serverAddr = &quot;localhost:6379&quot; db = &quot;0&quot; } zk { cluster = &quot;default&quot; serverAddr = &quot;127.0.0.1:2181&quot; session.timeout = 6000 connect.timeout = 2000 } consul { cluster = &quot;default&quot; serverAddr = &quot;127.0.0.1:8500&quot; } etcd3 { cluster = &quot;default&quot; serverAddr = &quot;http://localhost:2379&quot; } sofa { serverAddr = &quot;127.0.0.1:9603&quot; application = &quot;default&quot; region = &quot;DEFAULT_ZONE&quot; datacenter = &quot;DefaultDataCenter&quot; cluster = &quot;default&quot; group = &quot;SEATA_GROUP&quot; addressWaitTime = &quot;3000&quot; } file { name = &quot;file.conf&quot; }}config { # fileã€nacos ã€apolloã€zkã€consulã€etcd3 type = &quot;file&quot; nacos { serverAddr = &quot;localhost&quot; namespace = &quot;public&quot; cluster = &quot;default&quot; } consul { serverAddr = &quot;127.0.0.1:8500&quot; } apollo { app.id = &quot;seata-server&quot; apollo.meta = &quot;http://192.168.1.204:8801&quot; } zk { serverAddr = &quot;127.0.0.1:2181&quot; session.timeout = 6000 connect.timeout = 2000 } etcd3 { serverAddr = &quot;http://localhost:2379&quot; } file { name = &quot;file.conf&quot; }} file.confè¯¥é…ç½®ç”¨äºæŒ‡å®šTCçš„ç›¸å…³å±æ€§ï¼›å¦‚æœä½¿ç”¨æ³¨å†Œä¸­å¿ƒä¹Ÿå¯ä»¥å°†é…ç½®æ·»åŠ åˆ°é…ç½®ä¸­å¿ƒ file.conf 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121transport { # tcp udt unix-domain-socket type = &quot;TCP&quot; #NIO NATIVE server = &quot;NIO&quot; #enable heartbeat heartbeat = true #thread factory for netty thread-factory { boss-thread-prefix = &quot;NettyBoss&quot; worker-thread-prefix = &quot;NettyServerNIOWorker&quot; server-executor-thread-prefix = &quot;NettyServerBizHandler&quot; share-boss-worker = false client-selector-thread-prefix = &quot;NettyClientSelector&quot; client-selector-thread-size = 1 client-worker-thread-prefix = &quot;NettyClientWorkerThread&quot; # netty boss thread size,will not be used for UDT boss-thread-size = 1 #auto default pin or 8 worker-thread-size = 8 } shutdown { # when destroy server, wait seconds wait = 3 } serialization = &quot;seata&quot; compressor = &quot;none&quot;}service { #vgroup-&gt;rgroup vgroup_mapping.my_test_tx_group = &quot;default&quot; #only support single node default.grouplist = &quot;127.0.0.1:8091&quot; #degrade current not support enableDegrade = false #disable disable = false #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent max.commit.retry.timeout = &quot;-1&quot; max.rollback.retry.timeout = &quot;-1&quot;}client { async.commit.buffer.limit = 10000 lock { retry.internal = 10 retry.times = 30 } report.retry.count = 5}## transaction log storestore { ## store mode: fileã€db mode = &quot;file&quot; ## file store file { dir = &quot;sessionStore&quot; # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions max-branch-session-size = 16384 # globe session size , if exceeded throws exceptions max-global-session-size = 512 # file buffer size , if exceeded allocate new buffer file-write-buffer-cache-size = 16384 # when recover batch read size session.reload.read_size = 100 # async, sync flush-disk-mode = async } ## database store db { ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc. datasource = &quot;dbcp&quot; ## mysql/oracle/h2/oceanbase etc. db-type = &quot;mysql&quot; url = &quot;jdbc:mysql://127.0.0.1:3306/seata&quot; user = &quot;mysql&quot; password = &quot;mysql&quot; min-conn = 1 max-conn = 3 global.table = &quot;global_table&quot; branch.table = &quot;branch_table&quot; lock-table = &quot;lock_table&quot; query-limit = 100 }}lock { ## the lock store mode: localã€remote mode = &quot;remote&quot; local { ## store locks in user's database } remote { ## store locks in the seata's server }}recovery { committing-retry-delay = 30 asyn-committing-retry-delay = 30 rollbacking-retry-delay = 30 timeout-retry-delay = 30}transaction { undo.data.validation = true undo.log.serialization = &quot;jackson&quot;}## metrics settingsmetrics { enabled = false registry-type = &quot;compact&quot; # multi exporters use comma divided exporter-list = &quot;prometheus&quot; exporter-prometheus-port = 9898} éœ€è¦æ³¨æ„çš„æ˜¯ service.vgroup_mappingè¿™ä¸ªé…ç½®ï¼Œåœ¨ Spring Cloud ä¸­é»˜è®¤æ˜¯${spring.application.name}-fescar-service-groupï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šapplication.propertiesçš„ spring.cloud.alibaba.seata.tx-service-groupè¿™ä¸ªå±æ€§è¦†ç›–ï¼Œä½†æ˜¯å¿…é¡»è¦å’Œ file.conf ä¸­çš„ä¸€è‡´ï¼Œå¦åˆ™ä¼šæç¤º no available server to connect 3. æ³¨å…¥æ•°æ®æºSeata é€šè¿‡ä»£ç†æ•°æ®æºçš„æ–¹å¼å®ç°åˆ†æ”¯äº‹åŠ¡ï¼›MyBatis å’Œ JPA éƒ½éœ€è¦æ³¨å…¥ io.seata.rm.datasource.DataSourceProxy, ä¸åŒçš„æ˜¯ï¼ŒMyBatis è¿˜éœ€è¦é¢å¤–æ³¨å…¥ org.apache.ibatis.session.SqlSessionFactory MyBatis 123456789101112131415161718192021@Configurationpublic class DataSourceProxyConfig { @Bean @ConfigurationProperties(prefix = &quot;spring.datasource&quot;) public DataSource dataSource() { return new DruidDataSource(); } @Bean public DataSourceProxy dataSourceProxy(DataSource dataSource) { return new DataSourceProxy(dataSource); } @Bean public SqlSessionFactory sqlSessionFactoryBean(DataSourceProxy dataSourceProxy) throws Exception { SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); sqlSessionFactoryBean.setDataSource(dataSourceProxy); return sqlSessionFactoryBean.getObject(); }} JPA 12345678910111213141516@Configurationpublic class DataSourceProxyConfig { @Bean @ConfigurationProperties(prefix = &quot;spring.datasource&quot;) public DruidDataSource druidDataSource() { return new DruidDataSource(); } @Primary @Bean public DataSourceProxy dataSource(DruidDataSource druidDataSource) { return new DataSourceProxy(druidDataSource); }} å¦‚æœä½¿ç”¨çš„æ˜¯ Hikari æ•°æ®æºï¼Œéœ€è¦ä¿®æ”¹æ•°æ®æºçš„é…ç½®ï¼Œä»¥åŠæ³¨å…¥çš„ Bean çš„é…ç½®å‰ç¼€ 1234spring.datasource.hikari.driver-class-name=com.mysql.cj.jdbc.Driverspring.datasource.hikari.jdbc-url=jdbc:mysql://localhost:3306/seata?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=falsespring.datasource.hikari.username=rootspring.datasource.hikari.password=123456 12345@Bean@ConfigurationProperties(prefix = &quot;spring.datasource.hikari&quot;)public DataSource dataSource() { return new HikariDataSource();} 4. æ·»åŠ  undo_log è¡¨åœ¨ä¸šåŠ¡ç›¸å…³çš„æ•°æ®åº“ä¸­æ·»åŠ  undo_log è¡¨ï¼Œç”¨äºä¿å­˜éœ€è¦å›æ»šçš„æ•°æ® 12345678910111213141516CREATE TABLE `undo_log`( `id` BIGINT(20) NOT NULL AUTO_INCREMENT, `branch_id` BIGINT(20) NOT NULL, `xid` VARCHAR(100) NOT NULL, `context` VARCHAR(128) NOT NULL, `rollback_info` LONGBLOB NOT NULL, `log_status` INT(11) NOT NULL, `log_created` DATETIME NOT NULL, `log_modified` DATETIME NOT NULL, `ext` VARCHAR(100) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)) ENGINE = InnoDB AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8 5. å¯åŠ¨ Seata-Serveråœ¨ https://github.com/seata/seata/releases ä¸‹è½½ç›¸åº”ç‰ˆæœ¬çš„ Seata-Serverï¼Œä¿®æ”¹ registry.confä¸ºç›¸åº”çš„é…ç½®(å¦‚æœä½¿ç”¨ file åˆ™ä¸éœ€è¦ä¿®æ”¹)ï¼Œè§£å‹å¹¶é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯åŠ¨: 1sh ./bin/seata-server.sh 6. ä½¿ç”¨@GlobalTransactionalå¼€å¯äº‹åŠ¡åœ¨ä¸šåŠ¡çš„å‘èµ·æ–¹çš„æ–¹æ³•ä¸Šä½¿ç”¨@GlobalTransactionalå¼€å¯å…¨å±€äº‹åŠ¡ï¼ŒSeata ä¼šå°†äº‹åŠ¡çš„ xid é€šè¿‡æ‹¦æˆªå™¨æ·»åŠ åˆ°è°ƒç”¨å…¶ä»–æœåŠ¡çš„è¯·æ±‚ä¸­ï¼Œå®ç°åˆ†å¸ƒå¼äº‹åŠ¡ 7. æ€»ç»“","link":"/2021/03/14/Spring-Cloud-%E5%BF%AB%E9%80%9F%E9%9B%86%E6%88%90-Seata/"},{"title":"JavaåŸºç¡€çŸ¥è¯†","text":"æ¶µç›–äº† Java è®¸å¤šé‡è¦çš„åŸºç¡€çŸ¥è¯†ï½ 1. æ•°æ®ç±»å‹1.1 æ•°æ®ç±»å‹ åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆæˆ–å«åšåŸç”Ÿç±»ã€å†…ç½®ç±»å‹ï¼‰8ç§ï¼š æ•´æ•°ï¼šbyteï¼Œshortï¼Œintï¼Œlongï¼ˆé»˜è®¤æ˜¯intç±»å‹ï¼‰ æµ®ç‚¹ç±»å‹ï¼š floatï¼Œdoubleï¼ˆé»˜è®¤æ˜¯doubleç±»å‹ï¼‰ å­—ç¬¦ç±»å‹ï¼šchar å¸ƒå°”ç±»å‹ï¼šboolean å¼•ç”¨æ•°æ®ç±»å‹3ç§ï¼šæ•°ç»„ï¼Œç±»ï¼Œæ¥å£ 1.2 == å’Œ equals çš„åŒºåˆ«ç”¨æ³•ä¸Šçš„åŒºåˆ«ï¼š== æ¯”è¾ƒ(å¼•ç”¨çš„)å†…å­˜åœ°å€ï¼Œequals æ¯”è¾ƒå†…å®¹æ˜¯å¦ä¸€æ ·ã€‚ ä»£ç å®ç°ï¼šé»˜è®¤çš„Object.equals()æ–¹æ³•ä¹Ÿæ˜¯ä½¿ç”¨ == åšåˆ¤æ–­ï¼Œè€ŒString.equals()æ–¹æ³•æ¯”è¾ƒäº†æ¯ä¸ªCharacterå­—ç¬¦ï¼Œå¹¶é‡å†™äº†hashCodeæ–¹æ³•ã€‚å¦‚æœè¦é‡å†™equalsæ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿåº”é‡å†™hashCodeæ–¹æ³•ã€‚ å¦‚æœä¸é‡å†™å¯¹è±¡çš„hashCodeï¼Œå½“ä¸¤è€…equalsä¸ºtrueä½†hashCodeä¸åŒï¼Œå­˜æ”¾åœ¨åŒåˆ—å®¹å™¨Mapä¸­ä¹Ÿä¼šæ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ã€‚å› ä¸ºMapæ¯”è¾ƒkeyæ—¶ï¼Œä¼šå…ˆæ¯”è¾ƒhashCodeï¼Œå†ä½¿ç”¨equalsæ–¹æ³•ã€‚ e.g. ä½¿ç”¨JDK1.7BKDRå“ˆå¸Œç®—æ³•é‡å†™euqalså’ŒhashCodeæ–¹æ³• (é€šè¿‡ä½¿ç”¨ Objects.equals(..) + Objects.hash(..) æ–¹æ³•)ï¼š 12345678910111213141516171819public class Laptop { private String name; private Integer price; // omit getter and setter @Override public boolean equals(Object o) { if (this == o) return true; if (o == null || getClass() != o.getClass()) return false; Laptop laptop = (Laptop) o; return Objects.equals(name, laptop.name) &amp;&amp; Objects.equals(price, laptop.price); } @Override public int hashCode() { return Objects.hash(name, price); }} ä¸‹é¢æ˜¯Stringçš„hashCodeæ–¹æ³•ï¼Œå°±æ˜¯ BKDR Hashï¼š 123456789101112public int hashCode() { int h = hash; // hashé»˜è®¤å€¼æ˜¯0 if (h == 0 &amp;&amp; value.length &gt; 0) { char val[] = value; for (int i = 0; i &lt; value.length; i++) { h = 31 * h + val[i]; // key point } hash = h; } return h;} e.g. == åˆ¤æ–­ boxï¼Œequals åˆ¤æ–­ value new Integer(3) == new Integer(3) ä¸æ˜¯åŒä¸ªbox, false new Integer(3) == 3 (int) åŒä¸ªbox, true 2. Thread2.1 çº¿ç¨‹å®‰å…¨/æ•°æ®åŒæ­¥ synchronizedï¼šåŒ…æ‹¬monitor enterå’Œmonitor exitä¸¤ä¸ªJVMæŒ‡ä»¤ã€‚ä¿è¯æ‰§è¡Œenter/exitéƒ½èƒ½è¯»å†™åˆ°ä¸»å†…å­˜çš„æ•°æ®ï¼ˆå³æœ€æ–°æ•°æ®ï¼‰ã€‚ monitorè®¡æ•°å™¨ï¼šæ¯ä¸€ä¸ªå¯¹è±¡ä¸ä¸€ä¸ªmonitorå…³è”ï¼Œenteræ—¶monitorè®¡æ•°å™¨+1,exitæ—¶monitorè®¡æ•°å™¨-1ã€‚ HashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹åŒæ—¶å†™æ“ä½œå®¹æ˜“å‡ºç°æ­»å¾ªç¯å¼•èµ·æ­»é”ã€‚ 2.2 é”é”çš„ç­–ç•¥ï¼šæ‚²è§‚é” &amp; ä¹è§‚é”a. æ‚²è§‚é” æ¯æ¬¡è·å–æ•°æ®æ—¶éƒ½ä¼šå…ˆåŠ ä¸Šé”ï¼Œä¾‹å¦‚synchronized å…³é”®å­—ï¼Œå°±æ˜¯æ‚²è§‚é”ç­–ç•¥çš„ä¸€ç§å®ç° ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“çš„è¡Œé”ã€è¡¨é”å’Œè¯»å†™é”ç­‰ä¹Ÿæ˜¯æ‚²è§‚é”ï¼Œéƒ½æ˜¯åœ¨æ“ä½œä¹‹å‰å…ˆä¸Šé” æ‚²è§‚é”å­˜åœ¨çš„é—®é¢˜/ç¼ºç‚¹ï¼š åœ¨å¤šçº¿ç¨‹ç«äº‰ä¸‹ï¼ŒåŠ é”ã€é‡Šæ”¾é”ä¼šå¯¼è‡´æ¯”è¾ƒå¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œè°ƒåº¦å»¶æ—¶ï¼Œå¼•èµ·æ€§èƒ½é—®é¢˜ ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ä¼šå¯¼è‡´å…¶å®ƒæ‰€æœ‰éœ€è¦æ­¤é”çš„çº¿ç¨‹æŒ‚èµ· (çº¿ç¨‹é˜»å¡) å¦‚æœä¸€ä¸ªä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ç­‰å¾…ä¸€ä¸ªä¼˜å…ˆçº§ä½çš„çº¿ç¨‹é‡Šæ”¾é”ä¼šå¯¼è‡´ä¼˜å…ˆçº§å€’ç½®ï¼Œå¼•èµ·æ€§èƒ½é£é™© b. ä¹è§‚é” å¾ˆä¹è§‚ï¼Œæ¯æ¬¡æ‹¿æ•°æ®çš„æ˜¯éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šæ¥ä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¸Šé” åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤åˆ«äººæœ‰æ²¡æœ‰ä¹Ÿæ¥æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·ç­‰æœºåˆ¶ã€‚ç”±äºä½¿ç”¨äº†ç‰ˆæœ¬å·æœºåˆ¶ï¼Œæ‰€ä»¥ CAS åŸç†ä¸ä¼šäº§ç”Ÿ ABA é—®é¢˜ ä¹è§‚é”é€‚åˆreadçš„åœºæ™¯ï¼Œå¯ä»¥æé«˜tpsï¼Œç±»ä¼¼äºæ•°æ®åº“write_conditionæœºåˆ¶ CAS(Compare And Swap, æ¯”è¾ƒå’Œäº¤æ¢) æ˜¯å…¶ä¸­ä¸€ç§å®ç°æ–¹å¼ JUCåŒ…çš„å®ç°å°±æ˜¯å»ºç«‹åœ¨CASç®—æ³•åŸºç¡€ä¸Šçš„(the entities have â€˜Lockâ€™, â€˜ReadWriteLockâ€™)ã€‚ Java ä» 5.0å¼€å§‹å¼•å…¥äº†å¯¹CASçš„æ”¯æŒï¼Œä¸ä¹‹å¯¹åº”çš„æ˜¯ java.util.concurrent.atomic åŒ…ä¸‹çš„AtomicIntegerã€AtomicReferenceç­‰ç±»ï¼Œå®ƒä»¬æä¾›äº†åŸºäºCASçš„è¯»å†™æ“ä½œå’Œå¹¶å‘ç¯å¢ƒä¸‹çš„å†…å­˜å¯è§æ€§ã€‚ ä¸‹é¢æ˜¯CASçš„éƒ¨åˆ†æ¨¡æ‹Ÿä»£ç ï¼š 123456789101112public class SimulatedCAS { private int value; public synchronized int get() { return value; } public synchronized int compareAndSwap(int expectedValue, int newValue) { int oldValue = value; if (oldValue == expectedValue) value = newValue; return oldValue; }} ä¸Šè¾¹çš„ç±»æ¨¡æ‹Ÿäº†CASæ“ä½œï¼Œå¦‚æœæˆå‘˜å˜é‡ value çš„å€¼ä¸å‚æ•° expecredValue çš„å€¼ä¸åŒï¼Œé‚£å°±è¯´æ˜å…¶ä»–çš„çº¿ç¨‹å·²å¯¹å…¶è¿›è¡Œäº†ä¿®æ”¹ï¼Œæœ¬æ¬¡æ“ä½œå¤±è´¥ã€‚ é”çš„æœºåˆ¶ï¼š(è‡ªé€‚åº”)è‡ªæ—‹é”è‡ªæ—‹é”ï¼š åœ¨Javaä¸­ï¼Œè‡ªæ—‹é”æ˜¯æŒ‡å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPUã€‚è‡ªæ—‹æ¬¡æ•°çš„é»˜è®¤å€¼æ˜¯10æ¬¡ï¼Œè‹¥ä»ç„¶æ²¡æœ‰æˆåŠŸè·å¾—é”ï¼Œåˆ™ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŒ‚èµ·çº¿ç¨‹ã€‚ è‡ªé€‚åº”è‡ªæ—‹é”ï¼š åœ¨JDK 1.6ä¸­å¼•å…¥äº†è‡ªé€‚åº”çš„è‡ªæ—‹é”ã€‚è‡ªé€‚åº”æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®šäº†ï¼Œè€Œæ˜¯ç”±å‰ ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚ å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…åˆšåˆšæˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±ä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½å†æ¬¡æˆåŠŸï¼Œè¿›è€Œå®ƒå°†å…è®¸è‡ªæ—‹ç­‰å¾…æŒç»­ç›¸å¯¹æ›´é•¿æ—¶é—´ï¼Œæ¯”å¦‚100ä¸ªå¾ªç¯ã€‚ å¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—è¿‡ï¼Œé‚£åœ¨ä»¥åè¦è·å–è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä»¥é¿å…æµªè´¹å¤„ç†å™¨èµ„æº. é”çš„çŠ¶æ€ï¼šåå‘é”ã€è½»é‡/é‡é‡çº§é”åå‘é”ï¼š åå‘é”æ˜¯æŒ‡ä¸€æ®µåŒæ­¥ä»£ç ä¸€ç›´è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šè‡ªåŠ¨è·å–é”ã€‚é™ä½è·å–é”çš„ä»£ä»·ã€‚ è½»é‡çº§é”(è‡ªæ—‹)ï¼š è½»é‡çº§é”æ˜¯æŒ‡å½“é”æ˜¯åå‘é”çš„æ—¶å€™ï¼Œè¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œåå‘é”å°±ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹çš„å½¢å¼å°è¯•è·å–é”ï¼Œä¸ä¼šé˜»å¡ï¼Œæé«˜æ€§èƒ½ã€‚ é‡é‡çº§é”(é˜»å¡)ï¼š é‡é‡çº§é”æ˜¯æŒ‡å½“é”ä¸ºè½»é‡çº§é”çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è™½ç„¶æ˜¯è‡ªæ—‹ï¼Œä½†è‡ªæ—‹ä¸ä¼šä¸€ç›´æŒç»­ä¸‹å»ï¼Œå½“è‡ªæ—‹ä¸€å®šæ¬¡æ•°çš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰è·å–åˆ°é”ï¼Œå°±ä¼šè¿›å…¥é˜»å¡ï¼Œè¯¥é”è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”ä¼šè®©å…¶ä»–ç”³è¯·çš„çº¿ç¨‹è¿›å…¥é˜»å¡ï¼Œæ€§èƒ½é™ä½ã€‚ åˆ†æ®µé”ï¼šConcurrentHashMapConcurrentHashMapä¸­çš„åˆ†æ®µé”ç§°ä¸ºSegmentï¼Œå®ƒå³ç±»ä¼¼äºHashMapï¼ˆJDK7ä¸JDK8ä¸­HashMapçš„å®ç°ï¼‰çš„ç»“æ„ï¼Œå³**å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªEntryæ•°ç»„ã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼›åŒæ—¶åˆæ˜¯ä¸€ä¸ªReentrantLockï¼ˆSegment ç»§æ‰¿äº† ReentrantLock)**ã€‚ å½“éœ€è¦putå…ƒç´ çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯å¯¹æ•´ä¸ªhashmapè¿›è¡ŒåŠ é”ï¼Œè€Œæ˜¯å…ˆé€šè¿‡ hashcode æ¥çŸ¥é“ä»–è¦æ”¾åœ¨é‚£ä¸€ä¸ªåˆ†æ®µä¸­ï¼Œç„¶åå¯¹è¿™ä¸ªåˆ†æ®µè¿›è¡ŒåŠ é”ï¼Œæ‰€ä»¥å½“å¤šçº¿ç¨‹putçš„æ—¶å€™ï¼Œåªè¦ä¸æ˜¯æ”¾åœ¨ä¸€ä¸ªåˆ†æ®µä¸­ï¼Œå°±å®ç°äº†çœŸæ­£çš„å¹¶è¡Œçš„æ’å…¥ã€‚ ä½†æ˜¯ï¼Œåœ¨ç»Ÿè®¡sizeçš„æ—¶å€™ï¼Œå¯å°±æ˜¯è·å– hashmap å…¨å±€ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±éœ€è¦è·å–æ‰€æœ‰çš„åˆ†æ®µé”æ‰èƒ½ç»Ÿè®¡ã€‚åˆ†æ®µé”çš„è®¾è®¡ç›®çš„æ˜¯ç»†åŒ–é”çš„ç²’åº¦ï¼Œå½“æ“ä½œä¸éœ€è¦æ›´æ–°æ•´ä¸ªæ•°ç»„çš„æ—¶å€™ï¼Œå°±ä»…ä»…é’ˆå¯¹æ•°ç»„ä¸­çš„ä¸€é¡¹è¿›è¡ŒåŠ é”æ“ä½œã€‚ synchronized &amp; lock synchronized å…³é”®å­—æ˜¯ jvm åŸç”Ÿè¯­ä¹‰ä¸Šçš„å®ç° Synchronizedï¼šä¸€ä¸ªéå…¬å¹³ï¼Œæ‚²è§‚ï¼Œç‹¬äº«ï¼Œäº’æ–¥ï¼Œå¯é‡å…¥çš„é‡é‡çº§é” ä»€ä¹ˆæ˜¯å¯é‡å…¥é”ï¼Ÿå°±æ˜¯å¯é‡å¤å¯é€’å½’è°ƒç”¨çš„é”ã€‚åœ¨å¤–å±‚ä½¿ç”¨é”ä¹‹åå†…å±‚ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸å‘ç”Ÿæ­»é”ï¼ˆå³å¯ä»¥åµŒå¥—ä½¿ç”¨ï¼‰ lock æ˜¯ API å±‚é¢ä¸Šçš„å®ç°ï¼Œä½äº J.U.C.locks åŒ…ä¸‹ ReentrantLockï¼šä¸€ä¸ªé»˜è®¤éå…¬å¹³ä½†å¯å®ç°å…¬å¹³çš„ï¼Œæ‚²è§‚ï¼Œç‹¬äº«ï¼Œäº’æ–¥ï¼Œå¯é‡å…¥ï¼Œé‡é‡çº§é” ReentrantReadWriteLocKï¼šä¸€ä¸ªé»˜è®¤éå…¬å¹³ä½†å¯å®ç°å…¬å¹³çš„ï¼Œæ‚²è§‚ï¼Œ**å†™ç‹¬äº«&amp;è¯»å…±äº«(é€‚ç”¨è¯»å¤šçš„åœºæ™¯)**ï¼Œè¯»å†™ï¼Œå¯é‡å…¥ï¼Œé‡é‡çº§é” ä¸‹é¢æ˜¯Lockæ¥å£çš„æºç ï¼š 12345678910111213141516public interface Lock { void lock(); // ç­‰å¾…å¯ä¸­æ–­ void lockInterruptibly() throws InterruptedException; boolean tryLock(); boolean tryLock(Long time, TimeUnit unit) throws InterruptedException; void unlock(); // ç»‘å®šæ¡ä»¶ Condition newCondition();} å¯¹äºå®ç°äº†Lockæ¥å£çš„ReentrantLockï¼Œæœ‰ä»¥ä¸‹3ä¸ªä¸»è¦ç‰¹æ€§(ä¹Ÿæ˜¯synchronizedæ— æ³•åšåˆ°çš„)ï¼š ç­‰å¾…å¯ä¸­æ–­ ç­‰å¾…å¯ä¸­æ–­æ˜¯æŒ‡å½“æŒæœ‰é”çš„çº¿ç¨‹é•¿æœŸä¸é‡Šæ”¾é”çš„æ—¶å€™ï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ï¼Œå¯ä¸­æ–­ç‰¹æ€§å¯¹å¤„ç†æ‰§è¡Œæ—¶é—´éå¸¸é•¿çš„åŒæ­¥å—å¾ˆæœ‰å¸®åŠ©ã€‚ 1void lockInterruptibly() throws InterruptedException; å¯å®ç°å…¬å¹³é”() å…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”ï¼›è€Œéå…¬å¹³é”åˆ™ä¸ä¿è¯è¿™ä¸€ç‚¹ï¼Œåœ¨é”è¢«é‡Šæ”¾æ—¶ï¼Œä»»ä½•ä¸€ä¸ªç­‰å¾…é”çš„çº¿ç¨‹éƒ½æœ‰æœºä¼šè·å¾—é”ã€‚synchronizedä¸­çš„é”æ˜¯éå…¬å¹³çš„ï¼ŒReentrantLock é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯éå…¬å¹³çš„ï¼Œä½†å¯ä»¥é€šè¿‡å¸¦å¸ƒå°”å€¼çš„æ„é€ å‡½æ•°è¦æ±‚ä½¿ç”¨å…¬å¹³é”ã€‚ 123public ReentrantLock(boolean fair) { sync = fair ? new FairSync() : new NonfairSync();} é”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ é”ç»‘å®šå¤šä¸ªæ¡ä»¶æ˜¯æŒ‡ä¸€ä¸ª ReentrantLock å¯¹è±¡å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡ï¼Œè€Œåœ¨synchronizedä¸­ï¼Œé”å¯¹è±¡çš„ waitï¼ˆï¼‰å’Œ notifyï¼ˆï¼‰æˆ– notifyAllï¼ˆï¼‰æ–¹æ³•å¯ä»¥å®ç°ä¸€ä¸ªéšå«çš„æ¡ä»¶ã€‚å¦‚æœè¦å’Œå¤šäºä¸€ä¸ªçš„æ¡ä»¶å…³è”çš„æ—¶å€™ï¼Œå°±ä¸å¾—ä¸é¢å¤–åœ°æ·»åŠ ä¸€ä¸ªé”ï¼Œè€Œ ReentrantLock åˆ™æ— é¡»è¿™æ ·åšï¼Œåªéœ€è¦å¤šæ¬¡è°ƒç”¨ newCondition() æ–¹æ³•å³å¯ã€‚ 1Condition newCondition(); ç”¨æ³•ä¸Šçš„ä¸åŒï¼š synchronized æ˜¯åœ¨JVMå±‚é¢ä¸Šå®ç°çš„ï¼Œä¸ä½†å¯ä»¥é€šè¿‡ä¸€äº›ç›‘æ§å·¥å…·ç›‘æ§synchronized çš„é”å®šï¼Œè€Œä¸”åœ¨ä»£ç æ‰§è¡Œæ—¶å‡ºç°å¼‚å¸¸ï¼ŒJVMä¼šè‡ªåŠ¨é‡Šæ”¾é”å®šï¼Œä½†æ˜¯ä½¿ç”¨ Lock åˆ™ä¸è¡Œï¼Œlock æ˜¯é€šè¿‡ä»£ç å®ç°çš„ï¼Œè¦ä¿è¯é”å®šä¸€å®šä¼šè¢«é‡Šæ”¾ï¼Œå°±å¿…é¡»å°† unLock() æ”¾åˆ° finally{} ä¸­(lockæ–¹æ³•å¯ä¸æ”¾try{}ä¸­)ã€‚ åœ¨èµ„æºç«äº‰ä¸æ˜¯å¾ˆæ¿€çƒˆçš„æƒ…å†µä¸‹ï¼ŒSynchronized çš„æ€§èƒ½è¦ä¼˜äº ReetrantLockï¼Œä½†æ˜¯åœ¨èµ„æºç«äº‰å¾ˆæ¿€çƒˆçš„æƒ…å†µä¸‹ï¼ŒSynchronized çš„æ€§èƒ½ä¼šä¸‹é™å‡ åå€ï¼Œä½†æ˜¯ ReetrantLock çš„æ€§èƒ½èƒ½ç»´æŒå¸¸æ€ï¼› å¦å¤–ï¼Œåœ¨ jdk1.8 ä¸­ä¸¤è€…çš„æ€§èƒ½å·²ç»ç›¸å·®æ— å‡ äº†ã€‚è‹¥synchronizedåœ¨åŠŸèƒ½å±‚é¢ä¸Šæ— æ³•æ»¡è¶³ï¼Œå°±ç”¨ lock()æ–¹æ³• + try{} finally{} 2.3 çº¿ç¨‹ 6 ç§çŠ¶æ€ æ–°å»º å¯è¿è¡Œ é˜»å¡ ç­‰å¾… é™æ—¶ç­‰å¾… ç»“æŸ 1234567891011public class Thread implements Runnable { // ... public enum State { NEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED; }} 2.4 çº¿ç¨‹é—´çš„é€šä¿¡åŒæ­¥é˜»å¡ å’Œ å¼‚æ­¥éé˜»å¡ åŒæ­¥é˜»å¡æ¶ˆæ¯å¤„ç†çš„è¿‡ç¨‹ï¼šæ¯æ¬¡æäº¤ä¸€ä¸ªeventï¼ŒæœåŠ¡ç«¯æ¥å—eventåˆ›å»ºçº¿ç¨‹å¤„ç†ï¼Œè¿”å›ç»“æœã€‚ å¼‚æ­¥éé˜»å¡æ¶ˆæ¯å¤„ç†çš„è¿‡ç¨‹ï¼šæäº¤evenï¼Œæ”¾å…¥eventé˜Ÿåˆ—(ç«‹å³è¿”å›å·¥å•)ï¼Œè®©å¤šä¸ªçº¿ç¨‹(çº¿ç¨‹æ•°é‡åœ¨å¯æ§èŒƒå›´ä¹‹å†…)å¤„ç†ã€‚ é™ä½CPUä¸Šä¸‹æ–‡åˆ‡æ¢çº¿ç¨‹çš„å¼€é”€ï¼› çº¿ç¨‹å¯ä»¥é‡å¤åˆ©ç”¨ï¼Œå‡å°‘åˆ›å»ºçº¿ç¨‹çš„èµ„æºæµªè´¹ï¼› wait å’Œ notify æ–¹æ³• wait()æ–¹æ³•å¿…é¡»å¿…é¡»æ‹¥æœ‰è¯¥å¯¹è±¡çš„monitorï¼Œä¸ç„¶è‚¿ä¹ˆè®©é”ã€‚å³waitæ–¹æ³•å¿…é¡»åœ¨åŒæ­¥æ–¹æ³•å—ä¸­ä½¿ç”¨ï¼›notifyæ–¹æ³•ä¹Ÿä¸€æ · å“ªä¸ªå¯¹è±¡waitï¼Œå“ªä¸ªå¯¹è±¡å°±notifyã€‚å¦åˆ™æŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ sleep å’Œ wait æ–¹æ³•çš„æ¯”è¾ƒ ç›¸åŒç‚¹ï¼š é˜»å¡çº¿ç¨‹ ç­‰å¾…å¯ä¸­æ–­ ä¸åŒç‚¹ï¼š sleepæ˜¯Threadç‰¹æœ‰çš„æ–¹æ³• waitæ–¹æ³•(è®©é”)å¿…é¡»åœ¨åŒæ­¥ä»£ç å—ä¸­æ‰§è¡Œï¼Œsleepä¸éœ€è¦ sleepæ–¹æ³•çŸ­æš‚ä¼‘çœ ä¹‹åä¼šä¸»åŠ¨é€€å‡ºé˜»å¡ï¼Œè€Œwait(æ²¡æœ‰æŒ‡å®š wait æ—¶é—´)åˆ™éœ€è¦è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­åæ‰èƒ½é€€å‡ºé˜»å¡ å¤šçº¿ç¨‹é—´çš„é€šä¿¡If æ¡ä»¶è¯­å¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¸å¯é ï¼Œéœ€è¦ä½¿ç”¨ while + volatile 2.5 ç±»åŠ è½½çš„è¿‡ç¨‹ ä¸»è¦åˆ†ä¸º3ä¸ªé˜¶æ®µï¼šåŠ è½½ã€è¿æ¥(éªŒè¯ å‡†å¤‡ è§£æ)ã€åˆå§‹åŒ– ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨è¢«åŠ¨ä½¿ç”¨ä¸ä¼šå¯¼è‡´ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–ã€‚æ­¤å¤–ï¼Œç±»çš„åˆå§‹åŒ–æ“ä½œåªä¼šæ‰§è¡Œstaticé™æ€ä»£ç (åœ¨æ–¹æ³•åŒº/Metaspace)ï¼›è€Œå®ä¾‹åŒ–æ“ä½œåŒ…æ‹¬åˆå§‹åŒ–å¤–ï¼Œè¿˜ä¼šè¿è¡Œæ„é€ æ–¹æ³•ã€åˆ†é…ç©ºé—´(Head)ç­‰æ“ä½œã€‚ ä¸»åŠ¨ä½¿ç”¨çš„åœºæ™¯(5ç§)ï¼šnewã€ä½¿ç”¨ç±»çš„é™æ€å˜é‡/æ–¹æ³•ã€åå°„æ“ä½œ(class.forNameæ–¹æ³•)ã€åˆå§‹åŒ–å…¶å­ç±»ã€ä½œä¸ºå¯åŠ¨ç±»(å³mainæ–¹æ³•æ‰€åœ¨çš„ç±»ï¼Œmaybeåå°„) è¢«åŠ¨ä½¿ç”¨çš„åœºæ™¯(3ç§)ï¼šnew æŸä¸ªç±»çš„æ•°ç»„ã€ä½¿ç”¨çˆ¶ç±»çš„é™æ€å˜é‡(static)**ä¸ä¼šå¯¼è‡´å­ç±»çš„åˆå§‹åŒ– (å³å¯¹å­ç±»æ¥è¯´æ˜¯è¢«åŠ¨ä½¿ç”¨ï¼Œä½†å¯¹çˆ¶ç±»æ¥è¯´æ˜¯ä¸»åŠ¨ä½¿ç”¨ï¼Œçˆ¶å­åˆ†æ˜)ã€ä½¿ç”¨é™æ€å¸¸é‡** 123456789101112131415161718192021// ä½¿ç”¨çˆ¶ç±»çš„é™æ€å˜é‡ï¼Œå¯¹è‡ªå·±æ˜¯æ²¡æœ‰å½±å“çš„class Dfather{ static int count = 1; static{ System.out.println(&quot;Initialize class Dfather&quot;); } } class Dson extends Dfather{ static{ System.out.println(&quot;Initialize class Dson&quot;); } } public class Test4 { public static void main(String[] args) { int x = Dson.count; } } è¿™ä¸€éƒ¨åˆ†å¯ä»¥è·³è¿‡ï¼Œä»…ä»…ä¸æ„é€ æ–¹æ³•æœ‰å…³ 1234567891011121314// staticä»£ç æœ€å…ˆæ‰§è¡Œã€‚å½“new Juice()çš„æ—¶å€™ï¼Œè¾“å‡ºï¼š// Juice block// æ„é€ æ–¹æ³•public class Juice { public Juice() { System.out.println(&quot;æ„é€ æ–¹æ³•&quot;); } static { System.out.println(&quot;Juice block&quot;); }} ç±»çš„åŠ è½½è¿‡ç¨‹è¯¦è§£12345678910111213141516171819202122public class Singleton { // â‘  private static int x = 0; // é™æ€å¸¸é‡ ä¸ä¼šåˆå§‹åŒ– private static int y; // é™æ€å˜é‡ åˆå§‹åŒ– private static Singleton instance = new Singleton(); // â‘¡ private Singleton() { x++; y++; } // ä¸»åŠ¨ä½¿ç”¨ public static Singleton getInstance() { return instance; } public static void main(String[] args) { Singleton singleton = Singleton.getInstance(); System.out.println(singleton.x); // 1 â‘¡æ”¾åˆ°â‘ è¾“å‡º0 System.out.println(singleton.y); // 1 â‘¡æ”¾åˆ°â‘ è¾“å‡º1 }} è¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆæ›´æ¢ä½ç½®åxçš„å€¼ä¼šå˜æˆ0ã€‚å½“è°ƒç”¨getInstance()é™æ€æ–¹æ³•åï¼Œä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ï¼Œä¼šæŒ‰é¡ºåºæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š 12345private static Singleton instance = new Singleton(); // æ‰§è¡Œå®Œæ„é€ æ–¹æ³•åx=1private static int x = 0 // xè¢«é‡æ–°èµ‹å€¼0private static int y åˆå§‹åŒ–æŒ‰staticä»£ç ä½ç½®é¡ºåºæ‰§è¡Œï¼Œå’Œè°ƒç”¨é¡ºåºæ— å…³ã€‚æ¯”å¦‚ä½ å…ˆè°ƒç”¨äº†é™æ€æ–¹æ³•getInstance, ä½†è¿˜æ˜¯ä¼šæŒ‰é¡ºåºæ‰§è¡Œç¬¬ä¸€è¡Œstaticä»£ç ã€‚ 2.6 ç±»åŠ è½½å™¨çš„ä½œç”¨ä½œç”¨ï¼šè®©æ ¹åŠ è½½å™¨å§”æ‰˜å­ç±»åŠ è½½å™¨å»åŠ è½½å‚å•†æä¾›çš„SPI(Service Provider Interface)å…·ä½“å®ç°ã€‚å…¶å®å°±æ˜¯é€šè¿‡SPIæœºåˆ¶å®ç°åŠŸèƒ½çš„æ‰©å±•ã€‚å…³äºç±»åŠ è½½å™¨çš„æ›´å¤šå†…å®¹å‚è€ƒJVMã€‚ 2.7 æ·±å…¥ç†è§£ volatile å…³é”®å­—åˆè¯† volatile å…³é”®å­— volatile åªèƒ½ä¿®é¥°å˜é‡ï¼›è€Œ synchronized å¯ä»¥ä¿®é¥°ä»£ç å—å’Œæ–¹æ³•å å®ä¾‹å˜é‡ï¼šinit_value å»æ‰ static å°±æ˜¯æ™®é€šçš„å®ä¾‹å˜é‡ ç±»å˜é‡ (é™æ€å˜é‡)ï¼šåŠ  static 1234567891011121314151617181920212223242526272829303132333435public class VolatileFoo { final static int MAX = 5; static volatile int init_value = 0; // å°è¯•ä¸åŠ  volatile çš„è¾“å‡ºç»“æœ public static void main(String[] args) { // Reader çº¿ç¨‹ new Thread(() -&gt; { int localValue = init_value; while (localValue &lt; MAX) { if (init_value != localValue) { System.out.printf(&quot;The init_value is updated to [%d]\\n&quot;, init_value); // å¯¹ localValue è¿›è¡Œé‡æ–°èµ‹å€¼ localValue = init_value; } } }, &quot;Reader&quot;).start(); // Update çº¿ç¨‹ new Thread(() -&gt; { int localValue = init_value; while (localValue &lt; MAX) { // ä¿®æ”¹ init_value System.out.printf(&quot;The init_value will be changed to [%d]\\n&quot;, ++localValue); init_value = localValue; try { // çŸ­æš‚ä¼‘çœ ï¼Œä½¿ Reader çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œã€‚ TimeUnit.SECONDS.sleep(2); } catch (InterruptedException e) { e.printStackTrace(); } } }, &quot;Update&quot;).start(); }} CPU Cache æ¨¡å‹ å’Œ Java å†…å­˜æ¨¡å‹çš„ç»“æ„ç±»ä¼¼ï¼š a. è¯»å–æ“ä½œï¼Œä¸åšä»»ä½•å¤„ç†ï¼Œåªæ˜¯å°† Cache ä¸­çš„æ•°æ®è¯»å–åˆ°å¯„å­˜å™¨ä¸­ã€‚ b. å†™å…¥æ“ä½œï¼Œå‘å‡ºä¿¡å·é€šçŸ¥å…¶ä»– CPU å°†è¯¥å˜é‡çš„ Cache line ç½®ä¸ºæ— æ•ˆçŠ¶æ€ï¼Œå…¶ä»– CPU åœ¨è¿›è¡Œè¯¥å˜é‡è¯»å–çš„æ—¶å€™å¿…é¡»åˆ°ä¸»å†…å­˜ä¸­å†æ¬¡è·å–ï¼Œå³å† copy ä¸€ä»½å‰¯æœ¬ã€‚ å¹¶å‘ç¼–ç¨‹çš„ä¸‰ä¸ªé‡è¦ç‰¹æ€§ åŸå­æ€§ã€æœ‰åºæ€§ã€å¯è§æ€§ åŸå­æ€§ï¼šä¸€ä¸ªäº‹åŠ¡åŒ…å«å¤šä¸ªæ“ä½œï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œ æœ‰åºæ€§ï¼šä¸ºäº†ä¼˜åŒ–ç¨‹åºæ€§èƒ½è€Œå¯¹æŒ‡ä»¤åºåˆ—è¿›è¡Œé‡æ’åºï¼Œä¹Ÿå°±æ˜¯ä½ ç¼–å†™çš„ä»£ç é¡ºåºå’Œæœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤é¡ºåºæ˜¯ä¸ä¸€è‡´çš„ï¼Œé‡æ’åºå¯èƒ½ä¼šå¯¼è‡´å¤šçº¿ç¨‹ç¨‹åºå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªå…±äº«å˜é‡å€¼çš„ä¿®æ”¹ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»è·å¾—ä¿®æ”¹ä»¥åçš„å€¼ volatile å’Œ synchronized çš„åŒºåˆ« volatile ä¿®é¥°å®ä¾‹å˜é‡å’Œç±»(é™æ€)å˜é‡ï¼›synchronized ä¿®é¥°æ–¹æ³•å’Œä»£ç å— volatile ä¸èƒ½ä¿è¯åŸå­æ€§ å¯è§æ€§çš„å®ç°åŸç†ï¼švolatile ä½¿ç”¨æœºå™¨æŒ‡ä»¤(åç¡¬ä»¶) â€œlockâ€ çš„æ–¹å¼è¿«ä½¿å…¶ä»–çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­çš„æ•°æ®å¤±æ•ˆï¼Œå¿…é¡»åˆ°ä¸»å†…å­˜ä¸­è¿›è¡Œå†æ¬¡åŠ è½½ã€‚è€Œ synchronized ä½¿ç”¨ JVM æŒ‡ä»¤ monitor enter å’Œ monitor exit ä¸²è¡ŒåŒ–ä»£ç ï¼Œåœ¨ monitor exit æ—¶æ‰€æœ‰çš„å…±äº«èµ„æºéƒ½ä¼šè¢«åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ volatile ä¸ä¼šä½¿çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œsynchronized åˆ™ä¸åŒ volatile çš„ä½¿ç”¨åœºæ™¯å¼€å…³æ§åˆ¶ï¼ŒçŠ¶æ€æ ‡è®°ï¼ŒSingleton çš„ double-check ä¸ƒç§å•ä¾‹æ¨¡å¼çš„è®¾è®¡æ¯”è¾ƒæ–¹æ³•ï¼šçº¿ç¨‹å®‰å…¨ã€é«˜æ€§èƒ½ã€æ‡’åŠ è½½ã€‚ 1) é¥¿æ±‰å¼12345678910111213141516171819/*** ç‰¹ç‚¹ï¼šå¯ä»¥ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å”¯ä¸€å®ä¾‹ï¼ŒgetInstance æ–¹æ³•æ€§èƒ½æ¯”è¾ƒé«˜ï¼Œä½†æ˜¯æ— æ³•è¿›è¡Œæ‡’åŠ è½½ã€‚* ä½¿ç”¨åœºæ™¯ï¼šå ç”¨å†…å­˜èµ„æºå°‘ï¼Œå› ä¸ºInstanceè¢«CLåŠ è½½åå¾ˆé•¿ä¸€æ®µæ—¶é—´æ‰ä½¿ç”¨çš„è¯ï¼Œä¼šåœ¨å †å†…å­˜é©»ç•™å¾ˆé•¿æ—¶é—´ã€‚*/// final ä¸å…è®¸è¢«ç»§æ‰¿public final class Singleton { // å®ä¾‹å˜é‡ private byte[] data = new byte[1024]; // åœ¨å®šä¹‰å®ä¾‹å¯¹è±¡çš„æ—¶å€™ç›´æ¥åˆå§‹åŒ– private static Singleton instance = new Singleton(); // ç§æœ‰æ„é€ å‡½æ•°ï¼Œä¸å…è®¸å¤–éƒ¨ new private Singleton() { } public static Singleton getInstance() { return instance; }} 2) æ‡’æ±‰å¼12345678910111213141516171819202122/*** ç‰¹ç‚¹ï¼š ä½¿ç”¨å®ä¾‹çš„æ—¶å€™å†åˆ›å»º(å³æ‡’åŠ è½½)ï¼Œæ— æ³•ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å”¯ä¸€å®ä¾‹ã€‚* ä½¿ç”¨åœºæ™¯ï¼š*///final ä¸å…è®¸è¢«ç»§æ‰¿public final class Singleton { // å®ä¾‹å˜é‡ private byte[] data = new byte[1024]; // å®šä¹‰å®ä¾‹ï¼Œä½†æ˜¯ä¸ç›´æ¥åˆå§‹åŒ– private static Singleton instance = null; // ç§æœ‰æ„é€ å‡½æ•°ï¼Œä¸å…è®¸å¤–éƒ¨ new private Singleton() { } public static Singleton getInstance() { if (null == instance) { // å¯èƒ½ä¼šæœ‰ä¸¤ä¸ª(æˆ–ä»¥ä¸Š)çº¿ç¨‹åŒæ—¶çœ‹åˆ° instance == null instance = new Singleton(); } return instance; }} 3) æ‡’æ±‰å¼ + åŒæ­¥æ–¹æ³•12345// å‘ getInstance æ–¹æ³•åŠ å…¥ synchronized åŒæ­¥æ§åˆ¶ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥ã€‚// ç‰¹ç‚¹ï¼šå› synchronizedï¼ŒgetInstance æ–¹æ³•åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œæ€§èƒ½ä½ä¸‹ã€‚public static synchronized Singleton getInstance() { ....} 4) Double-Check1234567891011121314151617181920212223242526/*** ç‰¹ç‚¹ï¼šæ‡’åŠ è½½ + ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å”¯ä¸€å®ä¾‹ + æé«˜æ•ˆç‡ï¼Œå¯èƒ½é€ æˆç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚* ç©ºæŒ‡é’ˆå¼‚å¸¸çš„åˆ†æï¼šçº¿ç¨‹1åˆ›å»ºinstanceå®ä¾‹å®Œåï¼Œconn,socket çš„å®ä¾‹å¯èƒ½å°šæœªåˆ›å»ºå®Œæˆï¼ˆç”±JVMå‘ç”ŸæŒ‡ä»¤é‡æ’* å¯¼è‡´ï¼‰ï¼Œåœ¨æ­¤æœŸé—´ï¼Œçº¿ç¨‹2æ‹¿åˆ°instanceå®ä¾‹ä¸å¹¸ä½¿ç”¨å®ä¾‹å˜é‡connæˆ–è€…socketï¼Œåˆ™ä¼šäº§ç”Ÿç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚*/public final class Singleton { private byte[] data = new byte[1024]; private static Singleton instance = null; Connection conn; Socket socket; private Singleton() { } public static Singleton getInstance() { if (null == instance) { // å‡å°‘æ’é˜Ÿè¿›å…¥åŒæ­¥ä»£ç å—çš„çº¿ç¨‹æ•°é‡(å‡å°‘é˜»å¡)ï¼Œæé«˜æ•ˆç‡ã€‚ synchronized (Singleton.class) { if (null == instance) { // é˜²æ­¢ä¸‹ä¸€ä¸ªè·å¾— monitor é”çš„çº¿ç¨‹è¿›å…¥æ‰§è¡Œã€‚add: // å¯èƒ½å‡ºç°ï¼šçº¿ç¨‹ 1 è¿˜æ²¡åˆå§‹åŒ–ç»“æŸï¼Œçº¿ç¨‹ 2 å°±ç›´æ¥è¿”å› instance äº†ã€‚ä»è€Œå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚ instance = new Singleton(); } } } return instance; }} 5) Volatile + Double-Check12// åˆ©ç”¨ volatile ç¦æ­¢ JVM çš„æŒ‡ä»¤é‡æ’ã€‚private volatile static Singleton instance = null; 6) Holder æ–¹å¼1234567891011121314151617181920/*** ç‰¹ç‚¹ï¼šSingleton åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¸ä¼šåˆ›å»º Instance å®ä¾‹ï¼Œåªæœ‰å½“ Holder è¢«ä¸»åŠ¨å¼•ç”¨çš„æ—¶å€™æ‰åˆ›å»ºã€‚* Holder æ–¹å¼çš„å•ä¾‹è®¾è®¡æ˜¯æœ€å¥½çš„è®¾è®¡ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯ç›®å‰ä½¿ç”¨æ¯”è¾ƒå¹¿çš„è®¾è®¡ä¹‹ä¸€ã€‚*/public final class Singleton { private byte[] data = new byte[1024]; private Singleton() { } // åœ¨é™æ€å†…éƒ¨ç±»ä¸­æŒæœ‰ Singleton çš„å®ä¾‹ï¼Œå¹¶ä¸”å¯è¢«ç›´æ¥åˆå§‹åŒ–ã€‚ private static class Holder { private static Singleton instance = new Singleton(); } // è°ƒç”¨ getInstance æ–¹æ³•ï¼Œäº‹å®ä¸Šæ—¶è·å¾— Holder çš„ instance é™æ€å±æ€§ public static Singleton getInstance() { return Holder.instance; }} 7) æšä¸¾æ–¹å¼123456789101112131415161718192021/*** ç‰¹ç‚¹ï¼šæšä¸¾ç±»å‹ä¸å…è®¸è¢«ç»§æ‰¿ï¼ŒåŒæ ·æ˜¯çº¿ç¨‹å®‰å…¨çš„ä¸”åªèƒ½è¢«å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œä½†æ˜¯ä¸èƒ½æ‡’åŠ è½½ã€‚**/public enum EnumSingleton { INSTANCE; // å®ä¾‹å˜é‡ private byte[] data = new byte[1024]; EnumSingleton() { System.out.println(&quot;INSTANCE will be initialized immediately.&quot;); } public static void method() { // è°ƒç”¨è¯¥æ–¹æ³•åˆ™ä¼šä¸»åŠ¨ä½¿ç”¨ Singletonï¼ŒINSTANCE å°†ä¼šè¢«å®ä¾‹åŒ–ã€‚ } public static EnumSingleton getInstance() { return INSTANCE; }} 1234567891011121314151617181920212223242526272829/*** ç‰¹ç‚¹å¯å®ç°æ‡’åŠ è½½*/public class Singleton { // å®ä¾‹å˜é‡ private byte[] data = new byte[1024]; private Singleton() { } // ä½¿ç”¨æšä¸¾å……å½“ holder private enum EnumHolder { INSTANCE; private Singleton instance; EnumHolder() { this.instance = new Singleton(); } private Singleton getEnumSingleton() { return instance; } } public static Singleton getInstance() { return EnumHolder.INSTANCE.getEnumSingleton(); }} 2.8 å¤šçº¿ç¨‹è®¾è®¡æ¶æ„æ¨¡å¼æš‚æ—  3. é›†åˆç±»3.1 Map (åŒåˆ—é›†åˆ) é›†åˆç±» Key Value Supper è¯´æ˜ HashTable ä¸å…è®¸ä¸º null ä¸å…è®¸ä¸º null Dictionary çº¿ç¨‹å®‰å…¨ ConcurrentHashMap ä¸å…è®¸ä¸º null ä¸å…è®¸ä¸º null AbstractMap é”åˆ†æ®µæŠ€æœ¯(JDK8:CAS) TreeMap ä¸å…è®¸ä¸º null å…è®¸ä¸º null AbstractMap çº¿ç¨‹ä¸å®‰å…¨ HashMap å…è®¸ä¸º null å…è®¸ä¸º null AbstractMap çº¿ç¨‹ä¸å®‰å…¨ LinkedHashMap HashMap æ‰©å®¹æœºåˆ¶é»˜è®¤å¤§å°ä¸º16(1&lt;&lt;4)ã€‚å½“å®¹é‡è¾¾åˆ°75%æ—¶(é»˜è®¤è´Ÿè½½å› å­æ˜¯0.75)è‡ªåŠ¨æ‰©å®¹ï¼Œæ‰©å®¹ä¸ºåŸæ¥çš„2å€ï¼Œä¿è¯å®¹é‡æ˜¯2^nã€‚ åœ¨ç¡®å®šå­˜æ”¾å…ƒç´ ä½ç½®çš„æ—¶å€™ï¼Œä½¿ç”¨(n-1) &amp; hashæ¥ç¡®å®šå­˜æ”¾ä½ç½®ã€‚å› ä¸ºä½ä¸è¿ç®—ç¬¦ &amp; åœ¨æ“ä½œç³»ç»Ÿä¸­æ•ˆç‡å¾ˆé«˜ï¼ŒåŒæ—¶nä¸º2çš„næ¬¡å¹‚æ—¶ï¼Œhashå€¼è®¡ç®—å‡ºçš„ç»“æœåˆ†å¸ƒæ›´åŠ å‡åŒ€ï¼Œå¯ä»¥å‡å°‘hashå†²çªã€‚ ArrayListæ‰©å®¹ä¸ºåŸæ¥çš„1.5å€ã€‚ 3.2 Collection (å•åˆ—é›†åˆ)a. List (æœ‰åº) - æ€§èƒ½ è¯´æ˜ Vector æŸ¥è¯¢å¿«ï¼Œå¢åˆ æ…¢ï¼Œæ•ˆç‡ä½ çº¿ç¨‹å®‰å…¨ ArrayList æŸ¥è¯¢å¿«ï¼Œå¢åˆ æ…¢ï¼Œæ•ˆç‡é«˜ çº¿ç¨‹ä¸å®‰å…¨ LinkedList æŸ¥è¯¢æ…¢ï¼Œå¢åˆ å¿«ï¼Œæ•ˆç‡é«˜ çº¿ç¨‹ä¸å®‰å…¨ çº¿ç¨‹å®‰å…¨çš„List/Set:CopyOnWriteArrayList,å®ç°åŸç†å¦‚ä¸‹ï¼š å†™æ“ä½œåœ¨copyä¸”åŠ é”çš„å‰¯æœ¬ä¸Š(ä¸²è¡Œ)ï¼Œè¯»æ“ä½œåˆ™åœ¨åŸå®¹å™¨è¯»(å¹¶è¡Œ)ã€‚ ä¼˜ç‚¹: 1.è§£å†³çš„å¼€å‘å·¥ä½œä¸­çš„å¤šçº¿ç¨‹çš„å¹¶å‘é—®é¢˜ã€‚ ç¼ºç‚¹: **1.å†…å­˜å æœ‰é«˜:**å¾ˆæ˜æ˜¾ï¼Œä¸¤ä¸ªæ•°ç»„åŒæ—¶é©»æ‰åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœå®é™…åº”ç”¨ä¸­ï¼Œæ•°æ®æ¯”è¾ƒå¤šï¼Œè€Œä¸”æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œå ç”¨å†…å­˜ä¼šæ¯”è¾ƒå¤§ï¼Œé’ˆå¯¹è¿™ä¸ªå…¶å®å¯ä»¥ç”¨ConcurrentHashMapæ¥ä»£æ›¿ã€‚ **2.æ•°æ®ä¸€è‡´æ€§:**CopyOnWriteå®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ã€‚æ‰€ä»¥å¦‚æœä½ å¸Œæœ›å†™å…¥çš„çš„æ•°æ®ï¼Œé©¬ä¸Šèƒ½è¯»åˆ°ï¼Œè¯·ä¸è¦ä½¿ç”¨CopyOnWriteå®¹å™¨ b. Set (æœ‰åº) - - è¯´æ˜ HashSet LinkedHashSet TreeSet 4. é›¶æ•£çŸ¥è¯† String.trim(): å»æ‰é¦–å°¾ç©ºæ ¼ String.split(&quot; &quot;): æ ¹æ®regexåˆ‡åˆ†è¿”å›Stringæ•°ç»„ 1234Scanner in = new Scanner(System.in);int n = Integer.parseInt(in.nextLine().trim()); // input a number in line and trim the space of head and end.String[] strArr = in.nextLine.trim().split(&quot; &quot;); // input &quot; hello world &quot;.System.out.println(strArr); // ouput [hello, world]. Context æ˜¯ MetaData çš„å…·ä½“è¡¨ç°ï¼Ÿï¼Ÿï¼Ÿ 4.1 java å…³é”®å­—æ€»ç»“final å…³é”®å­—final å…³é”®å­—ä¸»è¦ç”¨åœ¨ä¸‰ä¸ªåœ°æ–¹ï¼šç±»(é™¤äº†æ¥å£å’ŒæŠ½è±¡ç±») æ–¹æ³• å˜é‡ ä¸‹é¢æ˜¯å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š ä¿®é¥°ç±»/æ–¹æ³•æ—¶ï¼Œè¡¨æ˜è¿™ä¸ªç±»/æ–¹æ³•ä¸èƒ½è¢«ç»§æ‰¿ï¼Œå¹¶ä¸” final ç±»ä¸­çš„æ‰€æœ‰ fields, methods éƒ½ä¼šè¢«éšå¼åœ°æŒ‡å®šä¸ºfinal å˜é‡/æ–¹æ³• private æ–¹æ³•ä¹Ÿéšå¼åœ°æŒ‡å®šä¸º final finalä¿®é¥°çš„æ–¹æ³•è™½ç„¶ä¸èƒ½è¢«ç»§æ‰¿ä½†å¯ä»¥è¢«é‡è½½(@Overload) final ä¿®é¥°çš„å˜é‡ä¸ä¸€å®šéƒ½æ˜¯å¸¸é‡ã€‚ä¾‹å¦‚å½“ final ä¿®é¥°ä»»æ„ Object æ—¶ï¼Œå¦‚ map (å¼•ç”¨æ•°æ®ç±»å‹)æ—¶ï¼Œä»…ä»£è¡¨ä¸èƒ½æŒ‡å‘å…¶å®ƒå¯¹è±¡ï¼Œä½†æ˜¯ map çš„å€¼è¿˜æ˜¯èƒ½å¤Ÿè¢«æ”¹å˜çš„ï¼ˆfinalçš„æ˜¯å†…å­˜åœ°å€ï¼‰ï¼Œè¿™å°±ä¼šäº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚åªæœ‰å½“ final ä¿®é¥°åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡æ—¶æ‰æ˜¯å¸¸é‡ã€‚ static å…³é”®å­— ä¿®é¥°å˜é‡ã€æ–¹æ³•ã€ä»£ç å—ã€é™æ€å†…éƒ¨ç±»ã€é™æ€å¯¼åŒ… ä¿®é¥°å˜é‡æˆ–æ–¹æ³•ï¼šé™æ€å˜é‡å­˜æ”¾åœ¨JVMçš„æ–¹æ³•åŒº/æ°¸ä¹…ä»£/meta space ä¿®é¥°ç±»æ—¶ï¼Œç”±äºæ²¡æœ‰å†…éƒ¨å¼•ç”¨(æŒ‡é’ˆ)ï¼Œæ•…ä¸èƒ½ä½¿ç”¨ä»»ä½•å¤–å›´ç±»çš„éstaticå˜é‡å’Œæ–¹æ³• staticæ–¹æ³•åªèƒ½è°ƒç”¨static field/methodï¼Œéstaticæ–¹æ³•å¯ä»¥è°ƒç”¨static field/methodã€‚æ¢ä¸ªæ–¹å¼è¯´ï¼Œå°±æ˜¯metaspaceæ— æ³•è®¿é—®å¤–éƒ¨ç©ºé—´ã€‚ this å…³é”®å­—å¼•ç”¨ç±»çš„å½“å‰å®ä¾‹ã€‚ super å…³é”®å­—å¯¹çˆ¶ç±»çš„å¼•ç”¨ã€‚ this å’Œ super å¿…é¡»æ”¾åœ¨é¦–è¡Œï¼›å¹¶ä¸”ä¸èƒ½ç”¨åœ¨ static æ–¹æ³•ä¸­ï¼Œå› ä¸ºthis, superå¯¹static metasapceè€Œè¨€æ˜¯å¤–éƒ¨ç©ºé—´ã€‚ 4.2 æŠ½è±¡ç±»å’Œæ¥å£çš„åŒºåˆ«æŠ½è±¡ç±»ï¼šå¯ä»¥è‡ªè¡Œå®ç°æ–¹æ³•ï¼›æ— å¤šç»§æ‰¿ 1234567891011// å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œä½†æ˜¯ java ä¸èƒ½å®ç°å¤šç»§æ‰¿public abstract class Beverage { public String getDescription() { return description; } // æŠ½è±¡æ–¹æ³•ï¼Œä¸æ¥å£ç±»ä¼¼ public abstract double cost();} 4.3 Overload å’Œ Override çš„åŒºåˆ«é‡è½½ ï¼šå‘ç”Ÿåœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚æ–¹æ³•åç›¸åŒï¼Œå‚æ•°å¿…é¡»ä¸åŒï¼Œè¿”å›å€¼å’Œè®¿å¯ä¿®é¥°ç¬¦å¯ä»¥ä¸åŒï¼Œå‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ã€‚ï¼ˆå…¶å®å°±æ˜¯æ–¹æ³•åä¸€æ ·å°±å¥½äº†ï¼Œæœ¬è´¨ä¸Šé‡è½½æ–¹æ³•å…¶å®æ˜¯ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼‰ é‡å†™ ï¼šå‘ç”Ÿåœ¨çˆ¶å­ç±»ä¸­ã€‚æ–¹æ³•åç›¸åŒã€å‚æ•°å¿…é¡»ç›¸åŒï¼Œè¿”å›å€¼èŒƒå›´ã€æŠ›å‡ºçš„å¼‚å¸¸èŒƒå›´å°äºç­‰äºçˆ¶ç±»,ï¼›è®¿é—®ä¿®é¥°ç¬¦èŒƒå›´å¤§äºç­‰äºçˆ¶ç±»ï¼›å¦‚æœçˆ¶ç±»æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦ä¸º private åˆ™å­ç±»å°±ä¸èƒ½é‡å†™è¯¥æ–¹æ³•ã€‚ 4.4 å°è£…ã€ç»§æ‰¿å’Œå¤šæ€å¤šæ€ï¼š æ˜¯æŒ‡åœ¨super classä¸­å®šä¹‰çš„å±æ€§å’Œæ–¹æ³•è¢«å­ç±»ç»§æ‰¿ä¹‹åï¼Œå¯ä»¥å…·æœ‰ä¸åŒçš„æ•°æ®ç±»å‹æˆ–è¡¨ç°å‡ºä¸åŒè¡Œä¸º ç¼–è¯‘æ—¶å¤šæ€ï¼šé‡è½½ è¿è¡Œæ—¶å¤šæ€ï¼šç»§æ‰¿ 4.5 æ³›å‹æ³›å‹çš„è¯­æ³•ï¼š 12345678910// ç±»class ArrayList&lt;T&gt; {}// æ–¹æ³•public &lt;T&gt; void printList(List&lt;T&gt; data) {}// è°ƒç”¨ staticæ³›å‹ æ–¹æ³•LinkedList.&lt;Integer&gt;newEmptyList()// T ä¹Ÿå¯ä»¥åšè¿”å›å€¼ è¿è¡Œæ—¶å¦‚ä½•çŸ¥é“æ³›å‹çš„ç±»å‹ï¼Ÿ å°†ç±»å‹ä½œä¸ºå‚æ•°ä¼ é€’,å¦‚ï¼š &lt;T&gt; void printList(List&lt;T&gt; data, class&lt;T&gt; elementType) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124package com.macro.mall.common.api;/** * é€šç”¨è¿”å›å¯¹è±¡ */public class CommonResult&lt;T&gt; { private long code; private String message; private T data; protected CommonResult() { } protected CommonResult(long code, String message, T data) { this.code = code; this.message = message; this.data = data; } /** * æˆåŠŸè¿”å›ç»“æœ * * @param data è·å–çš„æ•°æ® */ public static &lt;T&gt; CommonResult&lt;T&gt; success(T data) { return new CommonResult&lt;T&gt;(ResultCode.SUCCESS.getCode(), ResultCode.SUCCESS.getMessage(), data); } /** * æˆåŠŸè¿”å›ç»“æœ * * @param data è·å–çš„æ•°æ® * @param message æç¤ºä¿¡æ¯ */ public static &lt;T&gt; CommonResult&lt;T&gt; success(T data, String message) { return new CommonResult&lt;T&gt;(ResultCode.SUCCESS.getCode(), message, data); } /** * å¤±è´¥è¿”å›ç»“æœ * @param errorCode é”™è¯¯ç  */ public static &lt;T&gt; CommonResult&lt;T&gt; failed(IErrorCode errorCode) { return new CommonResult&lt;T&gt;(errorCode.getCode(), errorCode.getMessage(), null); } /** * å¤±è´¥è¿”å›ç»“æœ * @param errorCode é”™è¯¯ç  * @param message é”™è¯¯ä¿¡æ¯ */ public static &lt;T&gt; CommonResult&lt;T&gt; failed(IErrorCode errorCode,String message) { return new CommonResult&lt;T&gt;(errorCode.getCode(), message, null); } /** * å¤±è´¥è¿”å›ç»“æœ * @param message æç¤ºä¿¡æ¯ */ public static &lt;T&gt; CommonResult&lt;T&gt; failed(String message) { return new CommonResult&lt;T&gt;(ResultCode.FAILED.getCode(), message, null); } /** * å¤±è´¥è¿”å›ç»“æœ */ public static &lt;T&gt; CommonResult&lt;T&gt; failed() { return failed(ResultCode.FAILED); } /** * å‚æ•°éªŒè¯å¤±è´¥è¿”å›ç»“æœ */ public static &lt;T&gt; CommonResult&lt;T&gt; validateFailed() { return failed(ResultCode.VALIDATE_FAILED); } /** * å‚æ•°éªŒè¯å¤±è´¥è¿”å›ç»“æœ * @param message æç¤ºä¿¡æ¯ */ public static &lt;T&gt; CommonResult&lt;T&gt; validateFailed(String message) { return new CommonResult&lt;T&gt;(ResultCode.VALIDATE_FAILED.getCode(), message, null); } /** * æœªç™»å½•è¿”å›ç»“æœ */ public static &lt;T&gt; CommonResult&lt;T&gt; unauthorized(T data) { return new CommonResult&lt;T&gt;(ResultCode.UNAUTHORIZED.getCode(), ResultCode.UNAUTHORIZED.getMessage(), data); } /** * æœªæˆæƒè¿”å›ç»“æœ */ public static &lt;T&gt; CommonResult&lt;T&gt; forbidden(T data) { return new CommonResult&lt;T&gt;(ResultCode.FORBIDDEN.getCode(), ResultCode.FORBIDDEN.getMessage(), data); } public long getCode() { return code; } public void setCode(long code) { this.code = code; } public String getMessage() { return message; } public void setMessage(String message) { this.message = message; } public T getData() { return data; } public void setData(T data) { this.data = data; }} 4.6 å€¼ä¼ é€’ &amp; å¼•ç”¨ä¼ é€’å€¼ä¼ é€’ï¼šåŸºæœ¬æ•°æ®ç±»å‹çš„ä¼ é€’ã€‚copyäº†å€¼ï¼Œå®é™…ä¸Šæ˜¯2ä»½æ•°æ®ã€‚ å¼•ç”¨ä¼ é€’ï¼šå¼•ç”¨æ•°æ®ç±»å‹çš„ä¼ é€’(æ•°ç»„ ç±» æ¥å£)ã€‚åªä¼ é€’å¼•ç”¨çš„åœ°å€ï¼Œå®é™…ä¸Šæ˜¯1ä»½æ•°æ®ã€‚ 5. MySQL5.1 ä¸‰èŒƒå¼&amp;å››ç‰¹æ€§ ç¬¬ä¸€èŒƒå¼ï¼šæ¯ä¸ªå­—æ®µéƒ½ ä¸å¯å†åˆ†(åŸå­æ€§) ç¬¬äºŒèŒƒå¼ï¼šæ¯ä¸ªå­—æ®µéƒ½ å’Œä¸»é”®ç›¸å…³(å”¯ä¸€æ€§) ç¬¬ä¸‰èŒƒå¼ï¼šæ¯ä¸ªå­—æ®µéƒ½ å’Œä¸»é”®åˆ—ç›´æ¥ç›¸å…³ï¼Œè€Œä¸æ˜¯é—´æ¥ç›¸å…³/ä¾èµ–(å†—ä½™æ€§) å››ç‰¹æ€§ï¼šACID 5.2 äº‹åŠ¡éš”ç¦»çº§åˆ« å¹¶å‘äº‹åŠ¡å¸¦æ¥çš„é—®é¢˜ï¼š è„è¯»ï¼šè¯»å–äº†è¢«ä¿®æ”¹è¿‡ä½†æ˜¯æœªæäº¤åˆ°æ•°æ®åº“çš„æ•°æ® ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ä½†æ˜¯ç»“æœä¸ä¸€æ ·(æ•°æ®è¢«ä¿®æ”¹) å¹»è¯»ï¼šåŒä¸Šï¼Œä½†æ˜¯æ•°æ®å¢åŠ æˆ–åˆ é™¤äº† MySQLé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ« (Repeatable Read) æ˜¯å¦‚ä½•é¿å…å¹»è¯»çš„ï¼Ÿ **å¿«ç…§è¯» **(æ— é”ï¼Œå¦‚ select) çš„å®ç°æ–¹å¼ é€šè¿‡ MVCC(å¤šç‰ˆæœ¬æ§åˆ¶) å’Œ undo log å½“å‰è¯» (æœ‰é”ï¼Œå¦‚ select .. [for update]/[lock in share mode] å’Œ æ‰€æœ‰ä¿®æ”¹æ“ä½œï¼Œå³ update , delete , insert) çš„å®ç°æ–¹å¼ é€šè¿‡ è¡Œé” å’Œ gap é” (mysqlå®˜æ–¹æ–‡æ¡£ç§°ä¸º Next-Key Locks) ä¾‹å¦‚ï¼Œå‡è®¾è¦updateä¸€æ¡è®°å½•ï¼Œä½†æ˜¯å¦ä¸€ä¸ªäº‹åŠ¡å·²ç»deleteè¿™æ¡æ•°æ®å¹¶ä¸”commitäº†ï¼Œå¦‚æœä¸åŠ é”å°±ä¼šäº§ç”Ÿå†²çªã€‚æ‰€ä»¥updateçš„æ—¶å€™è‚¯å®šè¦æ˜¯å½“å‰è¯»ï¼Œå¾—åˆ°æœ€æ–°çš„ä¿¡æ¯å¹¶ä¸”é”å®šç›¸åº”çš„è®°å½•ã€‚ MVCCå¤šç‰ˆæœ¬æ§åˆ¶ å®ç°ï¼šDB_REX_ID, DB_ROLL_PTR(undo log?), DB_ROW_ID gapé”çš„ä»‹ç» 123select *from user where age&gt;0 and age&lt;10 for update;æˆ–è€…select *from user where age&gt;0 and age&lt;10 in share mode; ä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œä¸Šè¿°çš„SQLè¯­å¥,æ•°æ®åº“ä¸­åªæœ‰age=1ï¼Œage=4ï¼Œage=7ï¼Œage=8 è¿™ä¸‰æ¡æ»¡è¶³æ¡ä»¶çš„è®°å½•,é‚£ä¹ˆgapé”ä¼šåŠ åˆ°age=2ï¼Œ3ï¼Œ5ï¼Œ6ï¼Œ9ä¸Šé¢ï¼Œå¦‚æœå¦å¤–ä¸€ä¸ªäº‹åŠ¡é‡Œé¢æƒ³insert age=2ï¼Œ3ï¼Œ5ï¼Œ6ï¼Œ9 æ˜¯ä¼šè¢«é˜»å¡çš„ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªäº‹åŠ¡æ‹¿åˆ°äº†gapé”ã€‚ gapé”ä¼šä½œç”¨åœ¨æ™®é€šç´¢å¼•æˆ–æ— ç´¢å¼•çš„å½“å‰è¯»ä¸­ã€‚ 5.3 ç´¢å¼• ç´¢å¼•çš„ä½œç”¨ï¼šé¿å…å…¨è¡¨æ‰«æï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ ç´¢å¼•çš„ç§ç±» ç´¢å¼•çš„æ•°æ®ç»“æ„B-Tree ç´¢å¼•çš„ä¼˜ç‚¹å“ˆå¸Œç´¢å¼•ï¼šå¯¹äºå“ˆå¸Œç´¢å¼•æ¥è¯´ï¼Œå…¶åº•å±‚çš„æ•°æ®ç»“æ„å°±æ˜¯å•¥å¸Œè¡¨ã€‚å› æ­¤åœ¨æŸ¥è¯¢1æ¡è®°å½•æ—¶é€Ÿåº¦æœ€å¿«ï¼Œä¸ºO(1)çš„æ—¶é—´å¤æ‚åº¦ã€‚å…¶ä½™å¤§éƒ¨åˆ†åœºæ™¯ï¼Œå»ºè®®é€‰æ‹© Btree ç´¢å¼•ã€‚ B-Tree ç´¢å¼•ï¼šMysqlçš„ Btree ç´¢å¼•ä½¿ç”¨çš„æ˜¯B+æ ‘ã€‚ä½†å¯¹äºä¸»è¦çš„ä¸¤ç§å­˜å‚¨å¼•( MYISAMå’ŒNNODB)çš„å®ç°æ–¹å¼æ˜¯ä¸åŒçš„ã€‚ B-Tree ç›¸å¯¹äºŒå‰æ ‘ï¼šå› ä¸ºä¸€ä¸ªèŠ‚ç‚¹æœ‰å¤šä¸ªå­©å­ï¼Œæ‰€ä»¥ç›¸å¯¹äºäºŒå‰æ ‘æ·±åº¦ké˜¶é™ä½ï¼Œå‡å°‘äº†ç³»ç»Ÿçš„IOæ¬¡æ•°ã€‚ B+æ ‘å’ŒBæ ‘çš„åŒºåˆ«ï¼šéå¶å­èŠ‚ç‚¹ä»…ç”¨åšç´¢å¼•ï¼Œå°†æ•°æ®éƒ½å­˜æ”¾åœ¨äº†å¶å­èŠ‚ç‚¹ä¸Šä¸”æ•°æ®æœ‰åºã€‚åŒæ—¶ï¼ŒB+æ ‘ä¸Šçš„å¶å­ç»“ç‚¹å¢åŠ äº†é¡ºåºè®¿é—®æŒ‡é’ˆï¼Œæ‰€ä»¥åŒçº§/èŒƒå›´å†…çš„(å¶å­èŠ‚ç‚¹)æ•°æ®èƒ½å¤Ÿäº’ç›¸è®¿é—®ï¼Œä¸éœ€è¦å†å›åˆ°çˆ¶èŠ‚ç‚¹æŸ¥æ‰¾æ•°æ®ï¼Œå‡å°‘äº†ç£ç›˜IOæ¬¡æ•°ã€‚ æ€»ç»“ï¼š I/Oæ¬¡æ•°é™ä½ï¼Œæ•…ç£ç›˜è¯»å†™ä»£ä»·æ›´ä½ æŸ¥è¯¢æ•ˆç‡æ›´ç¨³å®šã€‚æŸ¥çš„æ—¶é—´å¤æ‚åº¦O(logn)ï¼Œ å“ˆå¸Œç´¢å¼•æœ€å¥½ä¸ºO(1)ï¼Œæœ€åä¸ºO(n)) Hash ç´¢å¼•çš„ç¼ºç‚¹åœ¨åŠŸèƒ½ä¸Šï¼š ä»…èƒ½æ»¡è¶³=ã€inï¼Œä¸èƒ½ä½¿ç”¨èŒƒå›´æŸ¥è¯¢ï¼ˆåŒ…æ‹¬æ¨¡ç³ŠæŸ¥è¯¢ï¼‰ å› ä¸ºåŸå…ˆæ˜¯æœ‰åºçš„é”®å€¼ï¼Œä½†æ˜¯ç»è¿‡hashç®—æ³•åï¼Œæœ‰å¯èƒ½å˜æˆä¸è¿ç»­çš„ï¼Œå°±æ²¡æœ‰åŠæ³•åˆ©ç”¨ç´¢å¼•å®ŒæˆèŒƒå›´æŸ¥è¯¢æ£€ç´¢æ•°æ®ã€‚ æ— æ³•ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ï¼šä¸æ”¯æŒå¤šåˆ—è”åˆç´¢å¼•çš„æœ€å·¦å‰ç¼€åŒ¹é…è§„åˆ™ åœ¨æ€§èƒ½ä¸Šï¼š å½“å‘ç”Ÿhashå†²çªæ—¶ï¼Œæ€§èƒ½ä½ä¸‹ å¹¶ä¸”ç”±äºhashå†²çªçš„å­˜åœ¨ï¼Œæ— æ³•100%é¿å…å…¨è¡¨æ‰«æ æœ€å·¦åŒ¹é…åŸåˆ™ä»å·¦å‘å³åŒ¹é…(ç»„åˆç´¢å¼•)ç›´åˆ°æœ‰èŒƒå›´æŸ¥è¯¢ (&gt;,&lt;,between,like) å°±åœæ­¢ï¼ˆä½†æ˜¯èƒ½è¾¾åˆ°è¿™ä¸ªèŒƒå›´çš„ç´¢å¼•ï¼‰ã€‚ ä¾‹å¦‚ï¼šå¯¹ç»„åˆç´¢å¼•ï¼ˆa,b,c,dï¼‰æ¥è¯´ï¼Œwhere a = 3 and b = 4 and c &lt; 5 and d = 6 ä¸­åˆ° c ç»ˆæ­¢ï¼Œd çš„ç´¢å¼•æ˜¯è¾¾ä¸åˆ°çš„ï¼Œæ‰€ä»¥ä¸ä¼šä½¿ç”¨è¯¥ç»„åˆç´¢å¼•ã€‚ä½†å¦‚æœç»„åˆç´¢å¼•ä¸ºï¼ˆa,b,d,cï¼‰åˆ™éƒ½å¯ä»¥ç”¨åˆ°ã€‚ æ³¨æ„ï¼š**= æ¡ä»¶å¯ä»¥ä¹±åºï¼Œmysql ä¼šè‡ªåŠ¨è¯†åˆ«çš„** 5.4 ä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦ ä¸€äº›ä¼˜åŒ–çš„ Tipsï¼š å¯ä»¥é€šè¿‡ Druid ç­‰å·¥å…·æ¥æ‰¾åˆ°æ…¢SQL ä½¿ç”¨ join å…³é”®å­—çš„æ—¶å€™ï¼Œéµå¾ªå°è¡¨é©±åŠ¨å¤§è¡¨ æ–¹æ¡ˆä¸€ï¼Œä¼˜åŒ–SQL ç´¢å¼• é™å®šæŸ¥è¯¢æ•°æ®èŒƒå›´ æ–¹æ¡ˆäºŒï¼Œä¼˜åŒ–æ¶æ„ Replicationsè¯»å†™åˆ†ç¦» / Cluster å‚ç›´/æ°´å¹³åˆ†åŒºï¼ˆäº‹åŠ¡å¤æ‚ï¼‰ æ•°æ®åº“åˆ†ç‰‡ å¦å¤–è¿˜æœ‰ä¸€äº›æ¯”è¾ƒå¥½ç”¨çš„å‘½ä»¤â€¦ 12345678910# query commandsshow variables like '%query%'; explain ..; # å…¶å®ç”¨ druid æ›´æ–¹ä¾¿å§...# set commands # ç”¨å‘½ä»¤æ”¹çš„å‚æ•°åœ¨ mysql é‡å¯åä¼šå¤±æ•ˆï¼Œæ¨èçš„æ–¹å¼æ˜¯åœ¨ my.ini/my.cnf é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹set global slow_query_log = on;set global long_query_time = 1;# æ…¢ sql ç›¸å…³å˜é‡æœ‰ï¼š long_query_time=10(s) / slow_query_log=OFFï¼ˆæ…¢ sql å°†ä¼šè¢«è®°å½•åœ¨æ—¥å¿—ä¸­ï¼‰ / slow_query_log_file=... explain å…³é”®å­— reference ä¹Ÿæœ‰â€ç´¢å¼•â€çš„å«ä¹‰ all index range ref(å¸¸è§) eq_ref(å¸¸è§) const å…¨è¡¨æ‰«æ æœ‰é¡ºåºçš„å…¨è¡¨æ‰«æ ç´¢å¼•èŒƒå›´æ‰«æ ä½¿ç”¨ç´¢å¼•ï¼Œç´¢å¼•å€¼ä¸å”¯ä¸€ å”¯ä¸€ç´¢å¼•æŸ¥æ‰¾ ä»¥ä¸»é”®ä¸ºæŸ¥è¯¢æ¡ä»¶ 1234EXPLAIN select m.* from base_mobile_menu m inner join base_mobile_authority a on m.id = a.menu_id and a.role_id = &quot;d0278641a3d04e64987c2fbec1e778da&quot;; å½“ exta ä¸­å‡ºç°ä»¥ä¸‹ 2 é¡¹æ„å‘³ç€ MYSQL æ ¹æœ¬ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œæ•ˆç‡ä¼šå—åˆ°é‡å¤§å½±å“ã€‚åº”å°½å¯èƒ½å¯¹æ­¤è¿›è¡Œä¼˜åŒ–ã€‚ extra è¯´æ˜ Using filesort è¡¨ç¤º MySQL ä¼šå¯¹ç»“æœä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨ç´¢å¼•æ’åº(æŒ‡ file )ï¼Œè€Œä¸æ˜¯ä»è¡¨é‡ŒæŒ‰ç´¢å¼•æ¬¡åºè¯»åˆ°ç›¸å…³å†…å®¹ã€‚å¯èƒ½åœ¨å†…å­˜æˆ–è€…ç£ç›˜ä¸Šè¿›è¡Œæ’åºã€‚MSQL ä¸­æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆçš„æ’åºæ“ä½œç§°ä¸ºæ–‡ä»¶æ’åºâ€”â€”filesort Using temporary è¡¨ç¤º MSQL åœ¨å¯¹æŸ¥è¯¢ç»“æœæ’åºæ—¶ä½¿ç”¨ temporary ä¸´æ—¶è¡¨ã€‚å¸¸è§äºæ’åº order by å’Œåˆ†ç»„æŸ¥è¯¢ group by 5.5 éƒ¨åˆ†è¯­æ³•group by ..ï¼šæ ¹æ®..è¿›è¡Œåˆ†ç»„ havingï¼šä¸€èˆ¬ç”¨åšç­›é€‰ group by çš„åˆ†ç»„ç»“æœï¼Œä¹Ÿå¯ä»¥åƒ where ä¸€æ ·ä½¿ç”¨ã€‚å¯ä»¥æ¥èšåˆå‡½æ•°ã€‚ èšåˆå‡½æ•°ï¼šcount, sum, max, min, avg ä¼˜å…ˆçº§ï¼š where &gt; group by &gt; having (with func) 5.6 InnoDB å’Œ MyISAMMyISAM ä»é”å’Œäº‹åŠ¡ä¸¤æ–¹é¢çœ‹æœ‰å¦‚ä¸‹ç¼ºç‚¹ï¼š åªæœ‰è¡¨é”ã€‚MyISAM select çš„æ—¶å€™ä¼šåšå…¨è¡¨é”(æ’å®ƒé”)ï¼Œæ­¤æ—¶æ— æ³•æ‰§è¡Œæ›´æ–°ç­‰æ“ä½œï¼ˆå³æŸ¥è¯¢&amp;ä¿®æ”¹æ“ä½œä¸èƒ½åŒæ—¶æ‰§è¡Œï¼Œä½†æ˜¯å¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªè¯»æ“ä½œï¼‰ï¼›è€Œ InnoDB select é»˜è®¤ä¸åŠ é”ï¼Œä¿®æ”¹æ“ä½œé»˜è®¤ä½¿ç”¨è¡Œé”+gapé”ï¼ˆè¯»æ“ä½œä¹Ÿå¯ä»¥é€šè¿‡åœ¨selectè¯­å¥ååŠ for updateå®ç°è¡Œé”+gapé”ï¼‰ã€‚è¡¨é”ä¸å­˜åœ¨æ­»é”ï¼Œå› ä¸ºå…¨éƒ¨èµ„æºè¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨äº†ã€‚ ä¸æ”¯æŒäº‹åŠ¡ã€‚æ²¡æœ‰äº‹åŠ¡æ€§èƒ½æ›´é«˜ã€‚ å¯¹äºInnoDBï¼š è‹¥èµ°ç´¢å¼•ï¼Œåˆ™é»˜è®¤ä½¿ç”¨è¡Œé” è‹¥æ— ç´¢å¼•ï¼Œåˆ™é»˜è®¤ä½¿ç”¨å…¨è¡¨é” å› æ­¤ MyISAM é€‚ç”¨åœºæ™¯ï¼šåªæŸ¥è¯¢ï¼Œä¸éœ€è¦äº‹åŠ¡ 5.7 å¸¸è§é—®é¢˜æ—¶åŒºåœ¨è¿æ¥æ•°æ®åº“çš„ url æŒ‡å®šå‚æ•°ï¼š?serverTimezone=GMT%2B8 ä¿®æ”¹æœ€å¤§è¿æ¥æ•°é€šå¸¸ï¼Œmysqlçš„æœ€å¤§è¿æ¥æ•°é»˜è®¤æ˜¯100, æœ€å¤§å¯ä»¥è¾¾åˆ°16384ã€‚1ã€æŸ¥çœ‹æœ€å¤§è¿æ¥æ•°:show variables like â€˜%max_connections%â€™;2ã€ä¿®æ”¹æœ€å¤§è¿æ¥æ•° æ–¹æ³•ä¸€ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ (Recommend) è¿›å…¥MySQLå®‰è£…ç›®å½• æ‰“å¼€MySQLé…ç½®æ–‡ä»¶ my.ini æˆ– my.cnfæŸ¥æ‰¾ max_connections=100 ä¿®æ”¹ä¸º max_connections=1000 æœåŠ¡é‡Œé‡èµ·MySQLå³å¯. æ–¹æ³•äºŒï¼šå‘½ä»¤è¡Œä¿®æ”¹ï¼Œé‡å¯å¤±æ•ˆ 12# å‘½ä»¤è¡Œè¿æ¥ MySQL server åï¼Œè®¾ç½®æ–°çš„ MySQL æœ€å¤§è¿æ¥æ•°ä¸º 200MySQL &gt; set global max_connections=200 å› ä¸ºåœ¨å‘½ä»¤è¡Œè®¾ç½®çš„æœ€å¤§è¿æ¥æ•°åªåœ¨ mysql å½“å‰æœåŠ¡è¿›ç¨‹å†…æœ‰æ•ˆï¼Œä¸€æ—¦mysqlé‡å¯ï¼Œåˆä¼šæ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚å› ä¸ºmysqlå¯åŠ¨åçš„åˆå§‹åŒ–å·¥ä½œæ˜¯ä»å…¶é…ç½®æ–‡ä»¶ä¸­è¯»å–æ•°æ®çš„ï¼Œè€Œè¿™ç§æ–¹å¼æ²¡æœ‰å¯¹å…¶é…ç½®æ–‡ä»¶åšæ›´æ”¹ã€‚ 8 å°æ—¶è¿æ¥è‡ªåŠ¨å¤±æ•ˆæŸ¥çœ‹å¤±æ•ˆæ—¶é—´ï¼šshow variables like 'wait_timeout'; è®¾ç½®å¤±æ•ˆæ—¶é—´ï¼šset global wait_timeout = xxx; ä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”æ£€æŸ¥ä»£ç é…ç½®ï¼ï¼ ä¸ºä»€ä¹ˆå•æœºæ¨èç”¨è‡ªå¢idåšä¸»é”® è¿™é‡Œä¸åŒ…æ‹¬åˆ†å¸ƒå¼çš„åœºæ™¯ï¼Œå› ä¸ºä¸èƒ½ä¿è¯ä¸»é”®çš„å”¯ä¸€æ€§ å¦‚æœè¡¨ä½¿ç”¨è‡ªå¢ä¸»é”®ï¼Œé‚£ä¹ˆæ¯æ¬¡æ’å…¥æ–°çš„è®°å½•ï¼Œè®°å½•å°±ä¼šé¡ºåºæ·»åŠ åˆ°å½“å‰ç´¢å¼•èŠ‚ç‚¹çš„åç»­ä½ç½®ï¼Œå½“ä¸€é¡µå†™æ»¡ï¼Œå°±ä¼šè‡ªåŠ¨å¼€è¾Ÿä¸€ä¸ªæ–°çš„é¡µã€‚ æ€»çš„æ¥è¯´å°±æ˜¯å¯ä»¥æé«˜æŸ¥è¯¢å’Œæ’å…¥çš„æ€§èƒ½ã€‚ èšç°‡ç´¢å¼• &amp; éèšç°‡ç´¢å¼• 6. Redis redis çš„æ‰€æœ‰ keys å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´+å¾®å°çš„éšæœºå€¼ï¼ˆé™¤äº†å¸¸é‡éœ€è¦ç”±æ‰‹åŠ¨è§¦å‘æ›´æ–°å¤–ï¼‰ 6.1äº”ç§æ•°æ®ç»“æ„ å¯¹Redisæ¥è¯´ï¼Œæ‰€æœ‰çš„ key éƒ½æ˜¯å­—ç¬¦ä¸²ã€‚value ä¸æ˜¯ string å°±æ˜¯collections stringã€hash(map)ã€list set zset(SortedSet) 6.2 å…­ç§å†…å­˜æ·˜æ±°ç­–ç•¥ LRU (Least recently used) æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼›volatile adj. æ˜“å˜çš„ï¼›æ˜“æŒ¥å‘çš„ æ€»ç»“ï¼šé»˜è®¤noevictionï¼Œ2ç§LRUï¼Œ2ç§Randomï¼Œè¿˜æœ‰ TTL 6.3æ€ä¹ˆå­˜æ”¾çƒ­ç‚¹æ•°æ®æä¾›ä¸€ç§ç®€å•å®ç°ç»¶å­˜å¤±æ•ˆçš„æ€è·¯ï¼šå¯ä»¥ç»“åˆ volatile-LRU è¿‡æœŸç­–ç•¥ï¼Œæ¯å‘½ä¸­ä¸€æ¬¡ key å°±ç»™å®ƒå¢åŠ è¿‡æœŸæ—¶é—´ã€‚ 6.4 RDB å’Œ AOFä¸¤è€…å¯¹æ¯” RDB å¿«ç…§å¤‡ä»½ï¼šä¿å­˜æŸä¸ªæ—¶é—´ç‚¹çš„å…¨é‡æ•°æ®å¿«ç…§ã€‚ å¥½å¤„æ˜¯æ–‡ä»¶ä½“ç§¯å°(äºŒè¿›åˆ¶æ ¼å¼+è‡ªåŠ¨å‹ç¼©)ï¼Œæ¢å¤é€Ÿåº¦å¿«(ç±»ä¼¼äºsqlçš„æ‰¹é‡æ“ä½œ)ï¼Œç¼ºç‚¹æ˜¯ä¸¢å¤±æ•°æ®æ—¶æ•°æ®é‡è¾ƒå¤§ã€‚ AOF (append-only file)ï¼šä¿å­˜å†™çŠ¶æ€ï¼Œå³æ¯æ¡ redis å‘½ä»¤ã€‚ï¼ˆä¸ä¿å­˜æŸ¥è¯¢å‘½ä»¤ï¼‰ Redis æŒä¹…åŒ–é»˜è®¤ä¸º RDB æŒä¹…åŒ–ï¼Œè‹¥éœ€è¦ AOF åœ¨ conf æ–‡ä»¶ä¸­æŠŠappend-onlyå‚æ•°æ”¹æˆ yesã€‚ RDBå’ŒAOFå¯ä»¥åŒæ—¶é…ç½®çš„ï¼Œå½“åŒæ—¶å¼€å¯çš„æ—¶å€™å¯åŠ¨çš„æ—¶å€™redisä¼šä¼˜å…ˆåŠ è½½AOFæ–‡ä»¶ï¼Œå› ä¸ºé€šå¸¸æƒ…å†µä¸‹AOFæŒä¹…åŒ–ä¿å­˜çš„æ•°æ®æ›´å®Œæ•´ä¸€äº›ã€‚è‹¥åªæ‰“ç®—ç”¨Redis åšç¼“å­˜ï¼Œå¯ä»¥å…³é—­æŒä¹…åŒ–ã€‚è‹¥æ‰“ç®—ä½¿ç”¨ Redis æŒä¹…åŒ–ï¼Œå»ºè®®RDBå’ŒAOFéƒ½å¼€å¯ï¼ŒAOFçš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œè‹¥æ²¡æœ‰å¼€å¯åˆ™ä½¿ç”¨RDBæ¢å¤ã€‚ AOF é…ç½®1234567# AOF 3ç§å¤‡ä»½ç­–ç•¥appendfsync always #æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶ã€‚appendfsync everysec #æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ã€‚é»˜è®¤ç­–ç•¥appendfsync no #ä»ä¸åŒæ­¥ã€‚é«˜æ•ˆä½†æ˜¯æ•°æ®ä¸ä¼šè¢«æŒä¹…åŒ–ã€‚ å‹ç¼© AOF æ–‡æœ¬æ–‡ä»¶çš„å‘½ä»¤ï¼š 123456789# æ‰‹åŠ¨å‹ç¼©çš„å‘½ä»¤ï¼ˆnot recommendedï¼‰bgrewriteaof# appendonly.aof æ–‡ä»¶å¤§å°å¢åŠ  100%(å³åŸæ¥çš„2å€) åˆ™è¿›è¡Œä¸€æ¬¡ rewirte å‹ç¼©# å¦‚æœä¹‹å‰æ²¡æœ‰é‡å†™è¿‡ï¼Œåˆ™ä»¥å¯åŠ¨æ—¶çš„ aof æ–‡ä»¶å¤§å°ä¸ºä¾æ®auto-aof-rewrite-percentage 100 # é»˜è®¤å€¼# appendonly.apf æ–‡ä»¶è‹¥å°äº 64mb åˆ™æ— éœ€é‡å†™auto-aof-rewrite-min-size 64mb # é»˜è®¤å€¼ AOF æ—¥å¿—è®°å½•æ–¹å¼ï¼š Alwaysï¼ˆåŒæ­¥å›å†™ï¼‰: æ‰§è¡Œå®ŒæŒ‡ä»¤åå¿…é¡»åŒæ­¥å†™å®Œæ—¥å¿—åè¯·æ±‚æ‰å“åº”ã€‚ Everysecï¼ˆå®šæ—¶å›å†™ï¼‰ï¼š å¼‚æ­¥å›å†™ï¼Œæ‰§è¡Œå®ŒæŒ‡ä»¤åå…ˆæŠŠæ—¥å¿—è®°å½•åˆ°å†…å­˜ç¼“å†²åŒºé‡Œé¢ï¼Œç„¶åæ¯éš”ä¸€æ®µæ—¶é—´æŠŠç¼“å†²åŒºåˆ·åˆ°æ—¥å¿—è®°å½•é‡Œã€‚ Noï¼ˆç³»ç»Ÿè§¦å‘å›å†™ï¼‰: å¼‚æ­¥å›å†™ï¼Œæ‰§è¡Œå®ŒæŒ‡ä»¤åå…ˆæŠŠæ—¥å¿—è®°å½•åˆ°å†…å­˜ç¼“å†²åŒºé‡Œé¢ï¼Œç”±ç³»ç»Ÿå†³å®šä»€ä¹ˆæ—¶å€™æŠŠç¼“å†²æ•°æ®åˆ·åˆ°æ—¥å¿—é‡Œã€‚ RDB é…ç½®123456# RDB å¿«ç…§å¤‡ä»½è¯´æ˜# save æ—¶é—´(s) keysæ•°é‡save 900 1 : åœ¨15åˆ†é’Ÿå†…æœ‰è‡³å°‘ä¸€ä¸ªé”®è¢«ä¿®æ”¹åˆ™è§¦å‘RDBå¿«ç…§å¤‡ä»½save 300 10 : åœ¨5åˆ†é’Ÿå†…è‡³å°‘æœ‰10ä¸ªé”®è¢«ä¿®æ”¹åˆ™è§¦å‘ã€‚save 60 10000 : åœ¨ä¸€åˆ†é’Ÿå†…æœ‰10000ä¸ªé”®è¢«ä¿®æ”¹åˆ™è§¦å‘ã€‚ ä¸»ä»åŒæ­¥çš„åŸç†ä¸»ä»æ¨¡å¼æ ¸å¿ƒé—®é¢˜æ˜¯ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®åŒæ­¥çš„æœºåˆ¶ï¼ŒRedisçš„ä¸»ä»æ•°æ®åŒæ­¥ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆå§‹åŒ–é˜¶æ®µçš„æ•°æ®åŒæ­¥å’Œæ›´æ–°æ—¶çš„æ•°æ®åŒæ­¥ï¼Œåˆå§‹åŒ–æ•°æ®åŒæ­¥ä¸»è¦æ˜¯é€šè¿‡ RDB å®Œæˆï¼Œæ›´æ–°æ•°æ®åŒæ­¥é€šè¿‡replication bufferæ¥å®Œæˆï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š ä»åº“å‘ä¸»åº“å‘èµ·åŒæ­¥è¯·æ±‚ ä¸»åº“æ‰§è¡Œ bgsave å‘½ä»¤ï¼Œç”Ÿæˆå¹¶å‘é€ RDB æ–‡ä»¶åˆ°ä»åº“ ä¸»åº“ç»§ç»­å‘é€ replication buffer é‡Œçš„å‘½ä»¤ï¼Œè¡¥å…¨æ•°æ® ä»ä¸Šè¿°çš„åŒæ­¥è¿‡ç¨‹æ¥çœ‹ï¼Œå…¶å®å°±æ˜¯å€ŸåŠ©äº† RDB ä¸ ç±»AOF çš„åŠŸèƒ½ 6.5 ç¼“å­˜é›ªå´©å’Œç¼“å­˜ç©¿é€ç¼“å­˜é›ªå´© ç¼“å­˜çœŸçš„å´©äº† ç¼“å­˜åŒä¸€æ—¶é—´keyså¤§é¢ç§¯çš„å¤±æ•ˆï¼Œæ‰€ä»¥ï¼Œåé¢çš„è¯·æ±‚éƒ½ä¼šè½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“çŸ­æ—¶é—´å†…æ‰¿å—å¤§é‡è¯·æ±‚è€Œå´©æ‰ã€‚ è§£å†³æ–¹æ³•ï¼šé›†ç¾¤ =&gt; **é™æµ/é™çº§/**åŠ é”/exTimeè¿‡æœŸæ—¶é—´éšæœºå€¼ =&gt; å†ä½¿ç”¨ aof, rdb æ¢å¤ redis æ•°æ®åº“ ç¼“å­˜ç©¿é€ ç¼“å­˜æ²¡é—®é¢˜ï¼Œæ˜¯æœ‰æ„ä¸ºä¹‹ ä¸€èˆ¬æ˜¯é»‘å®¢æ•…æ„å»è¯·æ±‚ç¼“å­˜ä¸­ä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½è½åˆ°æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“çŸ­æ—¶é—´å†…æ‰¿å—å¤§é‡è¯·æ±‚è€Œå´©æ‰ã€‚ è§£å†³æ–¹æ³•ï¼šå…ˆä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é™æµï¼Œå†ç¼“å­˜ç»“æœ(å³ä¾¿è¿™ä¸ªç»“æœå¯èƒ½ä¸ºç©º)ã€‚ å¸ƒéš†è¿‡æ»¤å™¨å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥çœ‹æˆä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„ã€‚æ¯å½“æœ‰æ•°æ®è¿›æ¥æ—¶ï¼Œä¼šå…ˆé€šè¿‡ä¸€ç³»åˆ—å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºè¯¥æ•°æ®çš„hashcodeï¼Œç„¶åå†æ ¹æ®hashcodeå­˜æ”¾åœ¨å¯¹åº”çš„ä½ç½®ä¸Šã€‚ä½†æ˜¯ç”±äºhashcodeæœ‰å¯èƒ½é‡å¤ï¼ˆå³å“ˆå¸Œå†²çªï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼šå¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥åˆ¤æ–­æŸä¸ªæ•°æ®ä¸€å®šä¸å­˜åœ¨ï¼Œä½†æ˜¯æ— æ³•åˆ¤æ–­ä¸€å®šå­˜åœ¨ã€‚ï¼ˆå³å‘ç”Ÿå“ˆå¸Œå†²çªæ—¶ï¼Œè°éƒ½ä¸çŸ¥é“è¿™ä¸ªæ•°æ®æœ‰æ²¡æœ‰å­˜åœ¨ï¼‰ ä¸‹é¢æ˜¯ guava ç±»åº“çš„ bloomfilter æ¼”ç¤ºä»£ç ï¼Œå…¶å®ä¸€äº› Redis lib ä¹Ÿæœ‰è¯¥è¿‡æ»¤å™¨çš„å®ç°ã€‚ 12345678910111213141516171819// è¿™é‡Œä½¿ç”¨çš„æ˜¯guavaå·¥å…·åŒ…, rediså·¥å…·åŒ…åº”è¯¥ä¹Ÿæœ‰æä¾›package com.ys.rediscluster.bloomfilter;import com.google.common.base.Charsets;import com.google.common.hash.BloomFilter;import com.google.common.hash.Funnel;import com.google.common.hash.Funnels;public class GuavaBloomFilter { public static void main(String[] args) { BloomFilter&lt;String&gt; bloomFilter = BloomFilter.create(Funnels.stringFunnel(Charsets.UTF_8),100000,0.01); bloomFilter.put(&quot;10086&quot;); System.out.println(bloomFilter.mightContain(&quot;123456&quot;)); System.out.println(bloomFilter.mightContain(&quot;10086&quot;)); }} 6.6 å¦‚ä½•ä½¿ç”¨Redisåšå¼‚æ­¥é˜Ÿåˆ—ä½¿ç”¨ List æ•°æ®ç»“æ„ä½œä¸ºé˜Ÿåˆ—ï¼›rpushç”Ÿäº§æ¶ˆæ¯ï¼Œlpopæ¶ˆè´¹æ¶ˆæ¯ã€‚(å…ˆè¿›å…ˆå‡º) pub/subï¼šå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼ˆç±»ä¼¼æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶æ„ï¼‰ï¼Œå¦‚ä¸‹å›¾ï¼š 6.7 Redis å’Œ Memcached2021å¹´çœ‹æ¥memcachedè¿˜æ˜¯ä¸è¡Œäº†ï¼Œetcd yydsï¼ 6.8 å¸¸è§é—®é¢˜å½“å‡ºç°å¤§é‡ keys åŒæ—¶è¿‡æœŸçš„æƒ…å†µï¼Œç”±äºæ¸…é™¤ key éœ€è¦æ—¶é—´ï¼Œæ‰€ä»¥ä¼šå‡ºç°çŸ­æš‚çš„å¡é¡¿ç°è±¡ã€‚å¯åœ¨è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ—¶å€™ç»™æ¯ä¸ªkeyåŠ ä¸Šéšæœºå€¼ã€‚ 7. Spring spring MVC è¿è¡Œæµç¨‹ï¼š1.Request 2.DispatcherServlet 3.HandlerMapping 4.HandlerAdaper(Controller) 5.ViewResolver 7.1 Beançš„ç”Ÿå‘½å‘¨æœŸ singleton(é»˜è®¤å€¼) prototype @Scope(&quot;prototype&quot;) request session 7.2 äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸MySQLç±»ä¼¼ï¼Œæœ‰read uncommitedï¼Œread commitedï¼Œrepeatable read(é»˜è®¤)ï¼Œserializable 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public enum Isolation { /** * Use the default isolation level of the underlying datastore. * All other levels correspond to the JDBC isolation levels. * @see java.sql.Connection */ DEFAULT(TransactionDefinition.ISOLATION_DEFAULT), /** * A constant indicating that dirty reads, non-repeatable reads and phantom reads * can occur. This level allows a row changed by one transaction to be read by * another transaction before any changes in that row have been committed * (a &quot;dirty read&quot;). If any of the changes are rolled back, the second * transaction will have retrieved an invalid row. * @see java.sql.Connection#TRANSACTION_READ_UNCOMMITTED */ READ_UNCOMMITTED(TransactionDefinition.ISOLATION_READ_UNCOMMITTED), /** * A constant indicating that dirty reads are prevented; non-repeatable reads * and phantom reads can occur. This level only prohibits a transaction * from reading a row with uncommitted changes in it. * @see java.sql.Connection#TRANSACTION_READ_COMMITTED */ READ_COMMITTED(TransactionDefinition.ISOLATION_READ_COMMITTED), /** * A constant indicating that dirty reads and non-repeatable reads are * prevented; phantom reads can occur. This level prohibits a transaction * from reading a row with uncommitted changes in it, and it also prohibits * the situation where one transaction reads a row, a second transaction * alters the row, and the first transaction rereads the row, getting * different values the second time (a &quot;non-repeatable read&quot;). * @see java.sql.Connection#TRANSACTION_REPEATABLE_READ */ REPEATABLE_READ(TransactionDefinition.ISOLATION_REPEATABLE_READ), /** * A constant indicating that dirty reads, non-repeatable reads and phantom * reads are prevented. This level includes the prohibitions in * {@code ISOLATION_REPEATABLE_READ} and further prohibits the situation * where one transaction reads all rows that satisfy a {@code WHERE} * condition, a second transaction inserts a row that satisfies that * {@code WHERE} condition, and the first transaction rereads for the * same condition, retrieving the additional &quot;phantom&quot; row in the second read. * @see java.sql.Connection#TRANSACTION_SERIALIZABLE */ SERIALIZABLE(TransactionDefinition.ISOLATION_SERIALIZABLE); private final int value; Isolation(int value) { this.value = value; } public int value() { return this.value; }} 7.3 äº‹åŠ¡ä¼ æ’­è¡Œä¸º æ”¯æŒå½“å‰äº‹åŠ¡(å½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœæ²¡æœ‰åˆ™å¦‚ä¸‹ï¼š) TransactionDefinition.PROPAGATION_REQUIRED: åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ã€‚ supportsï¼šä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚ mandatoryï¼šæŠ›å‡ºå¼‚å¸¸ã€‚ ä¸æ”¯æŒå½“å‰äº‹åŠ¡ requires_new: åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ï¼ˆè‹¥æœ‰ï¼‰ã€‚ not_supported: ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ï¼ˆè‹¥æœ‰ï¼‰ never: ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ˆè‹¥æœ‰ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283public enum Propagation { /** * Support a current transaction, create a new one if none exists. * Analogous to EJB transaction attribute of the same name. * &lt;p&gt;This is the default setting of a transaction annotation. */ REQUIRED(TransactionDefinition.PROPAGATION_REQUIRED), /** * Support a current transaction, execute non-transactionally if none exists. * Analogous to EJB transaction attribute of the same name. * &lt;p&gt;Note: For transaction managers with transaction synchronization, * {@code SUPPORTS} is slightly different from no transaction at all, * as it defines a transaction scope that synchronization will apply for. * As a consequence, the same resources (JDBC Connection, Hibernate Session, etc) * will be shared for the entire specified scope. Note that this depends on * the actual synchronization configuration of the transaction manager. * @see org.springframework.transaction.support.AbstractPlatformTransactionManager#setTransactionSynchronization */ SUPPORTS(TransactionDefinition.PROPAGATION_SUPPORTS), /** * Support a current transaction, throw an exception if none exists. * Analogous to EJB transaction attribute of the same name. */ MANDATORY(TransactionDefinition.PROPAGATION_MANDATORY), /** * Create a new transaction, and suspend the current transaction if one exists. * Analogous to the EJB transaction attribute of the same name. * &lt;p&gt;&lt;b&gt;NOTE:&lt;/b&gt; Actual transaction suspension will not work out-of-the-box * on all transaction managers. This in particular applies to * {@link org.springframework.transaction.jta.JtaTransactionManager}, * which requires the {@code javax.transaction.TransactionManager} to be * made available to it (which is server-specific in standard Java EE). * @see org.springframework.transaction.jta.JtaTransactionManager#setTransactionManager */ REQUIRES_NEW(TransactionDefinition.PROPAGATION_REQUIRES_NEW), /** * Execute non-transactionally, suspend the current transaction if one exists. * Analogous to EJB transaction attribute of the same name. * &lt;p&gt;&lt;b&gt;NOTE:&lt;/b&gt; Actual transaction suspension will not work out-of-the-box * on all transaction managers. This in particular applies to * {@link org.springframework.transaction.jta.JtaTransactionManager}, * which requires the {@code javax.transaction.TransactionManager} to be * made available to it (which is server-specific in standard Java EE). * @see org.springframework.transaction.jta.JtaTransactionManager#setTransactionManager */ NOT_SUPPORTED(TransactionDefinition.PROPAGATION_NOT_SUPPORTED), /** * Execute non-transactionally, throw an exception if a transaction exists. * Analogous to EJB transaction attribute of the same name. */ NEVER(TransactionDefinition.PROPAGATION_NEVER), /** * Execute within a nested transaction if a current transaction exists, * behave like {@code REQUIRED} otherwise. There is no analogous feature in EJB. * &lt;p&gt;Note: Actual creation of a nested transaction will only work on specific * transaction managers. Out of the box, this only applies to the JDBC * DataSourceTransactionManager. Some JTA providers might support nested * transactions as well. * @see org.springframework.jdbc.datasource.DataSourceTransactionManager */ NESTED(TransactionDefinition.PROPAGATION_NESTED); private final int value; Propagation(int value) { this.value = value; } public int value() { return this.value; }} 8. é¢è¯• FAQå¦‚ä½•æ’åº 10G çš„æ•°æ®é¦–å…ˆï¼Œæ•°æ®é‡è¾ƒå¤§æ— æ³•ä¸€æ¬¡åŠ è½½åˆ°å†…å­˜ï¼Œæ•…éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ†æ®µï¼Œåˆ†å‘åˆ°å„ä¸ªèŠ‚ç‚¹æ’åºï¼Œæœ€åå†å½’å¹¶èŠ‚ç‚¹ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨ k è·¯å½’å¹¶ç®—æ³•ï¼Œå¹¶ç»“åˆç¼“å†²åŒºå’Œ iterable é›†åˆç±»æ¡†æ¶Listçš„å¸¸ç”¨æ–¹æ³•åŠæ³¨æ„äº‹é¡¹ åœ¨å¯¹Listéå†çš„æ—¶å€™ä¸èƒ½è¿›è¡Œåˆ é™¤æˆ–è€…ä¿®æ”¹ç­‰æ“ä½œï¼Œå¦åˆ™ä¼šå‡ºç°ConcurrentModificationExceptionå¼‚å¸¸ã€‚éå†æ¨è Iteratorã€‚ Mapçš„å¸¸ç”¨æ–¹æ³•åŠæ³¨æ„äº‹é¡¹ æ­»é”å®šä¹‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„çº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„èµ„æºï¼Œå¯¼è‡´è¿™äº›çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œæ— æ³•æ‰§è¡Œã€‚ äº§ç”Ÿæ­»é”çš„ 4 ä¸ªå¿…è¦æ¡ä»¶ äº’æ–¥æ€§(èµ„æº)ï¼šä¸€ä¸ªèµ„æºåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å æœ‰ã€‚ è¯·æ±‚å’Œä¿æŒæ¡ä»¶(A)ï¼šä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å·²è¢«å æœ‰çš„èµ„æºå‘ç”Ÿé˜»å¡æ—¶ï¼Œè‡ªå·±å æœ‰çš„èµ„æºä¹Ÿä¸é‡Šæ”¾ã€‚ ä¸å¯æŠ¢å (B)ï¼šçº¿ç¨‹æ— æ³•å‰¥å¤ºè¢«å ç”¨çš„èµ„æºã€‚ å¾ªç¯ç­‰å¾…(AB)ï¼šå‘ç”Ÿæ­»é”æ—¶ï¼Œçº¿ç¨‹è¿›å…¥æ­»å¾ªç¯ï¼Œæ°¸ä¹…é˜»å¡ã€‚ äº§ç”Ÿæ­»é”çš„åŸå›  ç«äº‰ä¸å¯æŠ¢å æ€§èµ„æº ç«äº‰å¯æ¶ˆè€—èµ„æº è¿›ç¨‹æ¨è¿›é¡ºåºä¸å½“ é¿å…æ­»é”çš„æ–¹æ³• ç ´åâ€œè¯·æ±‚å’Œä¿æŒâ€æ¡ä»¶ï¼šä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰éœ€è¦çš„èµ„æºï¼ˆåƒsynchronizedç›´æ¥åŠ åœ¨æ–¹æ³•åä¸Šï¼‰ ç ´åâ€œä¸å¯æŠ¢å â€æ¡ä»¶ï¼šæŠ¢ä¸åˆ°èµ„æºå°±é‡Šæ”¾è‡ªå·±å æœ‰çš„èµ„æºï¼ˆä¸å¤ªç°å®ï¼‰ ç ´åâ€œå¾ªç¯ç­‰å¾…â€æ¡ä»¶ï¼šæŒ‰é¡ºåºè·å–èµ„æºï¼ˆæ¨èï¼‰ æ¨èå·¥å…·visualvmï¼Œjprofiler(æ”¶è´¹) Java åå°„æœºåˆ¶å®šä¹‰ï¼š**åŠ¨æ€ **(Running Time) è·å–ç±»ä¿¡æ¯åŠè°ƒç”¨æ–¹æ³•çš„åŠŸèƒ½ï¼Œç§°ä¸ºåå°„ã€‚ åå°„çš„ä¾‹å­ï¼š 12345678910public class ReflectSample { public static void main(String[] args) throws ClassNotFoundException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException { Class robotClass = Class.forName(&quot;com.example.demo.reflect.Robot&quot;); Robot robot = (Robot) robotClass.newInstance(); Method sayHi = robotClass.getDeclaredMethod(&quot;sayHi&quot;, String.class); sayHi.invoke(robot, &quot;welcome&quot;); }} Class.forName() &amp; ClassLoader.loadClass()forNameç›´æ¥åˆå§‹åŒ–ç±»ï¼ŒloadClassæ‡’åŠ è½½ æ‰€ä»¥ç†è®ºä¸Šä½¿ç”¨loadClassæ€§èƒ½æ›´åŠ ï¼Œä½†æ˜¯æœ‰äº›libéœ€è¦åˆå§‹åŒ–æ‰èƒ½ä½¿ç”¨ï¼Œæ¯”å¦‚Mysql Driveré©±åŠ¨ï¼Œæ‰€ä»¥ä½¿ç”¨forNameåŠ è½½ç±»ã€‚ Java å†…å­˜æ¨¡å‹è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«ä¸¤è€…çš„æ¦‚å¿µï¼šè¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½ã€‚ åŒºåˆ«ï¼šä¸€ä¸ªè¿›ç¨‹å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹ï¼›è¿›ç¨‹æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ï¼Œæœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼›è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€å¤§ï¼› å¦å¤–ï¼Œä¸€ä¸ªçº¿ç¨‹æŒ‚æ‰å¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹æŒ‚æ‰ã€‚Javaé‡‡ç”¨å•çº¿ç¨‹ç¼–ç¨‹æ¨¡å‹ï¼Œæ¯ä¸ªè¿›ç¨‹å¯¹åº”ä¸€ä¸ªJVMå®ä¾‹ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«JVMé‡Œçš„å †ã€‚ PCè¡¨ç¤ºç¨‹åºè®¡æ•°å™¨ï¼›TLSä¸ºThreadLocalStorageï¼Œç”¨äºçº¿ç¨‹é—´çš„æ•°æ®éš”ç¦»ã€‚ å¦‚ä½•æ’æŸ¥å’Œè§£å†³æ­»é”ä½¿ç”¨ jvisualvm æŸ¥çœ‹å“ªäº›çº¿ç¨‹å‘ç”Ÿæ­»é”dufy [å¼ºåˆ¶]å¯¹å¤šä¸ªèµ„æºã€æ•°æ®åº“è¡¨ã€å¯¹è±¡åŒæ—¶åŠ é”æ—¶ï¼Œéœ€è¦ä¿æŒä¸€è‡´çš„åŠ é”é¡ºåºï¼Œå¦åˆ™å¯èƒ½ä¼š é€ æˆæ­»é”ã€‚è¯´æ˜ï¼šçº¿ç¨‹ä¸€éœ€è¦å¯¹è¡¨ Aã€Bã€C ä¾æ¬¡å…¨éƒ¨åŠ é”åæ‰å¯ä»¥è¿›è¡Œæ›´æ–°æ“ä½œï¼Œé‚£ä¹ˆçº¿ç¨‹äºŒçš„åŠ é”é¡ºåºä¹Ÿå¿…é¡»æ˜¯ Aã€Bã€Cï¼Œå¦åˆ™å¯èƒ½å‡ºç°æ­»é”ã€‚ å¦‚ä½•æ’æŸ¥å’Œè§£å†³æœåŠ¡å™¨CPUå ç”¨ç‡100% topå‘½ä»¤æŸ¥çœ‹CPUä½¿ç”¨æƒ…å†µ(å¦‚mysqlè¿›ç¨‹ç­‰ç­‰çš„cpuä½¿ç”¨ç‡ï¼Œæ­»é”ä¸ä¸€å®šå ç”¨cpu)ã€‚ å†é€šè¿‡jvisualvmæŸ¥çœ‹ç›¸å…³è¿›ç¨‹çš„ä¿¡æ¯ã€‚ æœ‰å“ªäº›å·¥å…·èƒ½å¤Ÿå¿«é€ŸæŸ¥çœ‹çº¿ç¨‹ä½¿ç”¨æƒ…å†µå¼ºè½¯å¼±è™šå¼•ç”¨ Thread çº¿ç¨‹ç›¸å…³ ç”±äºé”æœºåˆ¶çš„å­˜åœ¨ï¼Œæ‰€ä»¥æ²¡æœ‰å¯ç«‹å³è¿è¡Œçš„çº¿ç¨‹å­˜åœ¨ Threadå’ŒRunnableçš„å…³ç³»åˆ›å»ºçº¿ç¨‹æ—¶å¯å®ç°Runnableæ¥å£æˆ–ç»§æ‰¿Threadç±»(é‡å†™runæ–¹æ³•)ï¼Œè€ŒThreadç±»å®é™…ä¸Šä¹Ÿæ˜¯å®ç°äº†Runnableæ¥å£çš„ã€‚ å› ç±»çš„å•ä¸€ç»§æ‰¿åŸåˆ™ï¼Œæ¨èä½¿ç”¨Runnableæ¥å£ã€‚ å¦å¤–ï¼Œè°ƒç”¨startæ–¹æ³•ä¸ä¸€å®šç«‹å³æ‰§è¡Œrunæ–¹æ³•ï¼Œè€Œä»…ä»…æ˜¯è¿›å…¥RunnableçŠ¶æ€ï¼Œæœ‰å¯èƒ½éœ€è¦ç­‰å¾…çº¿ç¨‹è·å–èµ„æºåæ‰èƒ½æ‰§è¡Œã€‚ å¦‚ä½•è·å–çº¿ç¨‹çš„è¿”å›å€¼a. ä¸»çº¿ç¨‹ç­‰å¾…æ³• 1234567891011121314151617181920212223public class CycleWait implements Runnable{ private String value; // ä¸éœ€è¦åŠ  static ä¹Ÿèƒ½åœ¨æœ¬æ–¹æ³•ä¸­ä½¿ç”¨ã€‚ @Override public void run() { try { Thread.currentThread().sleep(5000); } catch (InterruptedException e) { e.printStackTrace(); } value = &quot;we have data now.&quot;; } public static void main(String[] args) throws InterruptedException { CycleWait wait = new CycleWait(); Thread thread = new Thread(wait); thread.start(); while(null == wait.value) { // çœ‹è¿™é‡Œ Thread.currentThread().sleep(1); } System.out.println(&quot;value: &quot; + wait.value); }} b. ä½¿ç”¨Threadç±»çš„join()æ–¹æ³•é˜»å¡å½“å‰çº¿ç¨‹ä»¥ç­‰å¾…å­çº¿ç¨‹å¤„ç†å®Œæ¯• 123456789101112131415161718192021public class CycleWait implements Runnable{ private String value; // ä¸éœ€è¦åŠ  static ä¹Ÿèƒ½åœ¨æœ¬æ–¹æ³•ä¸­ä½¿ç”¨ã€‚ @Override public void run() { try { Thread.currentThread().sleep(5000); } catch (InterruptedException e) { e.printStackTrace(); } value = &quot;we have data now.&quot;; } public static void main(String[] args) throws InterruptedException { CycleWait wait = new CycleWait(); Thread thread = new Thread(wait); thread.start(); thread.join(); // é˜»å¡å½“å‰çº¿ç¨‹è€Œä¸æ˜¯è‡ªå·±==ã€‚ System.out.println(&quot;value: &quot; + wait.value); }} c. é€šè¿‡Callableæ¥å£å®ç°ï¼šä½¿ç”¨FutureTaskæˆ–è€…Executorçº¿ç¨‹æ± æ¥æ”¶Callableå¯¹è±¡ 12345678910public class FutureTaskDemo { public static void main(String[] args) throws ExecutionException, InterruptedException { FutureTask&lt;String&gt; task = new FutureTask&lt;&gt;(new MyCallable()); new Thread(task).start(); if (!task.isDone()) { System.out.println(&quot;task has not finished, please wait!&quot;); } System.out.println(&quot;task return: &quot; + task.get()); }} 1234567public class ExecutorDemo { public static void main(String[] args) throws ExecutionException, InterruptedException { ExecutorService threadPool = Executors.newCachedThreadPool(); Future&lt;String&gt; future = threadPool.submit(new MyCallable()); System.out.println(future.get()); }} çº¿ç¨‹çš„6ç§çŠ¶æ€ NEW æ–°å»º RUNANBLE å¯è¿è¡Œ/è¿è¡Œä¸­ BLOCKED é˜»å¡ï¼šç­‰å¾…è·å–é”(èµ„æº)ã€‚ WAITING æ— é™æœŸç­‰å¾…ï¼šæ²¡æœ‰å¯¹Object.wait()æˆ–Thread.join()æ–¹æ³•è®¾ç½®Timeoutã€‚å› ä¸ºwaitè®©å‡ºé”ï¼Œæ‰€ä»¥æ­¤æ—¶è‡ªå·±ä¼šå˜æˆç­‰å¾…çŠ¶æ€ã€‚ TIMED_WAITING é™æ—¶ç­‰å¾… TERMINATED ç»“æŸï¼šç»“æŸåä¸èƒ½å†è°ƒç”¨Thread.start()æ–¹æ³•ï¼ˆå³åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼‰ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ notify å’Œ notifyAll çš„åŒºåˆ«notify éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…é”çš„çº¿ç¨‹ï¼ŒnotifyAllåˆ™å”¤é†’æ‰€æœ‰ç­‰å¾…èµ„æºé”çš„çº¿ç¨‹ã€‚ å¦‚ä½•ä¸­æ–­çº¿ç¨‹ ä½¿ç”¨ Thread.interrupt() æ–¹æ³•ã€‚ è‹¥çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œåˆ™æŠ›å‡ºInterruptedExceptionã€‚ è‹¥çº¿ç¨‹å¤„äºæ­£å¸¸æ´»åŠ¨çŠ¶æ€ï¼Œåˆ™ä¸èµ·ä½œç”¨ã€‚å¯ä»¥å°†è¯¥çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°(ä½¿ç”¨volatileä¿®é¥°çš„å˜é‡)è®¾ç½®ä¸º true/false. ä½¿ç”¨ Thread.stop() æ–¹æ³•ï¼Œç›¸å½“äºç”µè„‘çš„å¼ºåˆ¶å…³æœºï¼Œå·²å¼ƒç”¨ã€‚ 1234567891011121314151617181920212223242526/** * 1. volatile æ ‡è®° * 2. interrupt() æ–¹æ³• * 3. stop() æ–¹æ³•(å·²å¼ƒç”¨) */public class StopThread { static volatile boolean mark = true; public static void main(String[] args) throws InterruptedException { Thread tickTop = new Thread(new Runnable() { @Override public void run() { while(mark) { System.out.println(System.currentTimeMillis()/1000); } } }); tickTop.start(); TimeUnit.SECONDS.sleep(3); System.out.println(&quot;å³å°†ç»“æŸ&quot;); // tickTop.stop(); // tickTop.interrupt(); // useless mark = false; }} BIOã€NIO å’Œ AIO å¯¹æ¯” ABN Spring IOC å’Œ AOPIOC(Inversion of Controlï¼Œæ§åˆ¶åè½¬)ï¼š Interceptorå’ŒFilterçš„åŒºåˆ«Interceptor æ‹¦æˆªå™¨æ˜¯åŸºäºjavaåå°„æœºåˆ¶å®ç°ï¼Œåœ¨actionçš„ç”Ÿå‘½å‘¨æœŸä¸­å¯ä»¥å¤šæ¬¡è°ƒç”¨; è€Œ Filter åŸºäºå‡½æ•°å›è°ƒå®ç°ï¼Œåªèƒ½åœ¨å®¹å™¨åˆå§‹åŒ–æ—¶è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä½†æ˜¯Filterå¯¹æ‰€æœ‰çš„è¯·æ±‚èµ·ä½œç”¨ï¼Œå³ä½œç”¨èŒƒå›´æ›´å¹¿ã€‚æœ€é€‚åˆæœ€ç½‘å…³ã€‚ åˆ›å»ºå¯¹è±¡çš„ 4 ç§æ–¹æ³• new åå°„ Object.clone(): éœ€è¦é‡å†™ clone æ–¹æ³•ï¼Œè¿™æ˜¯æµ…æ‹·è´ï¼Œå³æˆå‘˜å˜é‡çš„å¼•ç”¨ä¸åŸå¯¹è±¡æ˜¯ç›¸åŒçš„ã€‚ ååºåˆ—åŒ–â€¦? ä¿å­˜æ—¥å¿—æ—¥å¿—çº§åˆ«ï¼šerror &gt; warn &gt; info &gt; debug æ—¥å¿—é…ç½®ï¼š 12345678logging: file: ${spring.application.name}.log # æ—¥å¿—æ–‡ä»¶è¶…è¿‡ 10MB åï¼Œè‡ªåŠ¨åˆ†ç‰‡ file.max-size: 10MB # æ—¥å¿—æ–‡ä»¶æœ€å¤šå­˜æ”¾ 10 å¤© file.max-history: 10 level: root: info # DAO å±‚å¯ä»¥ä¸º DEBUG çº§åˆ«ï¼Œç”Ÿäº§ç¯å¢ƒå°½é‡å°‘ï¼ï¼","link":"/2021/02/28/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"},{"title":"ServiceMesh, Serverless, K8s","text":"å…³äºServiceMesh, Serverless, K8sçš„æ¦‚å¿µä¸è”ç³»ã€‚ ServiceMeshå¾®æœåŠ¡å­˜åœ¨çš„é—®é¢˜ï¼š æ¡†æ¶åº•å±‚å®ç°å¤æ‚(åˆ†å¸ƒå¼ç³»ç»Ÿçš„é€šä¿¡åè®®) æ¡†æ¶æ²¡æœ‰å¤šè¯­è¨€æ”¯æŒ ç‰ˆæœ¬å…¼å®¹é—®é¢˜ï¼Œå¯èƒ½ä¾èµ–åº“å‡çº§ï¼Œç³»ç»Ÿä¹Ÿè¦å‡çº§ã€‚ ServiceMeshï¼ŒæœåŠ¡ç½‘æ ¼ï¼š æœåŠ¡ç½‘æ ¼æ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½å±‚ï¼Œç”¨äºå¤„ç†æœåŠ¡é—´é€šä¿¡ã€‚äº‘åŸç”Ÿåº”ç”¨æœ‰ç€å¤æ‚çš„æœåŠ¡æ‹“æ‰‘ï¼ŒæœåŠ¡ç½‘æ ¼ä¿è¯è¯·æ±‚åœ¨è¿™äº›æ‹“æ‰‘ä¸­å¯é åœ°ç©¿æ¢­ã€‚åœ¨å®é™…åº”ç”¨å½“ä¸­ï¼ŒæœåŠ¡ç½‘æ ¼é€šå¸¸æ˜¯ç”±ä¸€ç³»åˆ—è½»é‡çº§çš„ç½‘ç»œä»£ç†ç»„æˆçš„ï¼Œå®ƒä»¬ä¸åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ä¸€èµ·ï¼Œä½†å¯¹åº”ç”¨ç¨‹åºé€æ˜ã€‚ ç½‘æ ¼ = sidecar = ç½‘ç»œä»£ç† å®ƒå°†åˆ†å¸ƒå¼æœåŠ¡çš„é€šä¿¡æŠ½è±¡ä¸ºå•ç‹¬ä¸€å±‚ï¼Œåœ¨è¿™ä¸€å±‚ä¸­å®ç°è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‘ç°ã€è®¤è¯æˆæƒã€ç›‘æ§è¿½è¸ªã€æµé‡æ§åˆ¶ç­‰åˆ†å¸ƒå¼ç³»ç»Ÿæ‰€éœ€è¦çš„åŠŸèƒ½ï¼Œä½œä¸ºä¸€ä¸ªå’ŒæœåŠ¡å¯¹ç­‰çš„ä»£ç†æœåŠ¡ï¼Œå’ŒæœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œæ¥ç®¡æœåŠ¡çš„æµé‡ï¼Œé€šè¿‡ä»£ç†ä¹‹é—´çš„é€šä¿¡é—´æ¥å®ŒæˆæœåŠ¡ä¹‹é—´çš„é€šä¿¡è¯·æ±‚ï¼Œè¿™æ ·ä¸Šè¾¹æ‰€è¯´çš„ä¸‰ä¸ªé—®é¢˜ä¹Ÿè¿åˆƒè€Œè§£ã€‚ï¼ˆæŠ½è±¡åŒ–å¾®æœåŠ¡é€šç”¨ç»„ä»¶çš„é€šä¿¡åŠŸèƒ½ï¼‰ å› æ­¤è¯´ï¼ŒService Mesh æ˜¯å¾®æœåŠ¡æ—¶ä»£çš„ TCP/IP åè®®ã€‚ å¦‚æœæˆ‘ä»¬æš‚æ—¶ç•¥å»æœåŠ¡ï¼Œåªçœ‹Service Meshçš„å•æœºç»„ä»¶ç»„æˆçš„ç½‘ç»œï¼š ç¬¬äºŒä»£ Service Meshï¼Œå¢åŠ äº†ç®¡ç†å„ä¸ª sidecar ç½‘æ ¼çš„æ§åˆ¶é¢æ¿ï¼š æ€»ç»“ä¸€ä¸‹ï¼ŒService Meshå…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š å±è”½åˆ†å¸ƒå¼ç³»ç»Ÿé€šä¿¡çš„å¤æ‚æ€§(è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‘ç°ã€è®¤è¯æˆæƒã€ç›‘æ§è¿½è¸ªã€æµé‡æ§åˆ¶ç­‰ç­‰)ï¼ŒæœåŠ¡åªç”¨å…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼› çœŸæ­£çš„è¯­è¨€æ— å…³ï¼ŒæœåŠ¡å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ç¼–å†™ï¼Œåªéœ€å’ŒService Meshé€šä¿¡å³å¯ï¼› å¯¹åº”ç”¨é€æ˜ï¼ŒService Meshç»„ä»¶å¯ä»¥å•ç‹¬å‡çº§ï¼› å½“ç„¶ï¼ŒService Meshç›®å‰ä¹Ÿé¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼š Service Meshç»„ä»¶ä»¥ä»£ç†æ¨¡å¼è®¡ç®—å¹¶è½¬å‘è¯·æ±‚ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¼šé™ä½é€šä¿¡ç³»ç»Ÿæ€§èƒ½ï¼Œå¹¶å¢åŠ ç³»ç»Ÿèµ„æºå¼€é”€ï¼› Service Meshç»„ä»¶æ¥ç®¡äº†ç½‘ç»œæµé‡ï¼Œå› æ­¤æœåŠ¡çš„æ•´ä½“ç¨³å®šæ€§ä¾èµ–äºService Meshï¼ŒåŒæ—¶é¢å¤–å¼•å…¥çš„å¤§é‡Service MeshæœåŠ¡å®ä¾‹çš„è¿ç»´å’Œç®¡ç†ä¹Ÿæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼› å†å²æ€»æ˜¯æƒŠäººçš„ç›¸ä¼¼ã€‚ä¸ºäº†è§£å†³ç«¯åˆ°ç«¯çš„å­—èŠ‚ç é€šä¿¡é—®é¢˜ï¼ŒTCPåè®®è¯ç”Ÿï¼Œè®©å¤šæœºé€šä¿¡å˜å¾—ç®€å•å¯é ï¼›å¾®æœåŠ¡æ—¶ä»£ï¼ŒService Meshåº”è¿è€Œç”Ÿï¼Œå±è”½äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„è¯¸å¤šå¤æ‚æ€§ï¼Œè®©å¼€å‘è€…å¯ä»¥å›å½’ä¸šåŠ¡ï¼Œèšç„¦çœŸæ­£çš„ä»·å€¼ã€‚ Serverlessæ— æœåŠ¡å™¨è®¡ç®—æ˜¯ä¸€ç§æŒ‰éœ€æä¾›åç«¯æœåŠ¡çš„æ–¹æ³•ã€‚æ— æœåŠ¡å™¨æä¾›ç¨‹åºå…è®¸ç”¨æˆ·ç¼–å†™å’Œéƒ¨ç½²ä»£ç ï¼Œè€Œä¸å¿…æ‹…å¿ƒåº•å±‚åŸºç¡€ç»“æ„ã€‚ä»æ— æœåŠ¡å™¨ä¾›åº”å•†å¤„è·å¾—åç«¯æœåŠ¡çš„å…¬å¸å°†æ ¹æ®å…¶è®¡ç®—è´¹ç”¨ï¼Œè€Œä¸å¿…ä¿ç•™å’Œæ”¯ä»˜å›ºå®šæ•°é‡çš„å¸¦å®½æˆ–æœåŠ¡å™¨æ•°é‡ï¼Œå› ä¸ºè¯¥æœåŠ¡æ˜¯è‡ªåŠ¨æ‰©å±•çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç”¨ä½ å¤„ç†æœåŠ¡å™¨ä¸Šçš„éƒ¨ç½²ã€è¿ç»´ã€æœåŠ¡å™¨å®¹é‡å’ŒæœåŠ¡å™¨çš„æ‰©å±•å’Œå¤±è´¥å®¹é”™ï¼Œè¿˜æœ‰æœåŠ¡å™¨ä¸Šé€‰æ‹©ä»€ä¹ˆOSæ“ä½œç³»ç»Ÿï¼Œè¯­è¨€çš„æ›´æ–°ï¼Œæ—¥å¿—ç­‰ç­‰é—®é¢˜ã€‚è¯·æ³¨æ„ï¼Œå°½ç®¡ç§°ä¸ºæ— æœåŠ¡å™¨ï¼Œä½†ä»ä½¿ç”¨ç‰©ç†æœåŠ¡å™¨ï¼Œä½†å¼€å‘äººå‘˜æ— éœ€äº†è§£å®ƒä»¬ã€‚ å½“å‰ä¸šç•Œæœ€å¸¸è§çš„ Serverless å®ç°æ–¹æ¡ˆä¸º FaaSï¼ˆFunction as a Service, å‡½æ•°å³æœåŠ¡ï¼‰ + BaaSï¼ˆBackend as a Service, åç«¯å³æœåŠ¡ï¼‰ï¼Œæˆ‘ä»¬ç»å¸¸å¬åˆ°çš„ã€Œäº‘æœåŠ¡ã€å°±æ˜¯åŸºäº FaaS + BaaS æ¶æ„ã€‚ KubernetesRancheræœ‰åˆ†ä¸ºv1å’Œv2ç‰ˆæœ¬ï¼Œéƒ½æ˜¯æä¾›å®¹å™¨è°ƒåº¦ä¸ç¼–æ’ï¼Œä¸åŒä¹‹å¤„åœ¨äºåœ¨k8sç››è¡Œä¹‹å‰æœ‰è®¸å¤šäººéƒ½æè¿‡å®¹å™¨ç¼–æ’ï¼Œæ‰€ä»¥rancher v1ä¸Šä¼šæœ‰å‡ ç§ä¸åŒçš„ç¼–æ’æ¨¡å¼ï¼Œä¾‹å¦‚cattle ,swarm,kubernetesã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºRahcner v1æ—¶ä»£ï¼Œå®ƒç»™è‡ªå·±çš„å®šä½æ˜¯å„ç§ç¼–æ’å·¥å…·çš„ä¸Šå±‚ï¼Œä¹Ÿå°±æ˜¯k8sçš„ä¸Šå±‚ï¼Œç„¶åä½ å†é€šè¿‡å®ƒå»ç®¡ç†k8sã€‚ å› ä¸ºk8såæ¥å‘å±•å¾—åŠ¿ä¸å¯æŒ¡ï¼Œæ‰€ä»¥Rancher v2åº”è¿è€Œç”Ÿï¼Œç§»é™¤äº†å…¶ä»–ç±»å‹çš„ç¼–æ’å·¥å…·ï¼Œåªå‰©ä¸‹k8sã€‚ æ‰€ä»¥æ€»ç»“ä¸€ä¸‹ï¼Œä¸¤è€…çš„å…³ç³»æ˜¯Rancherå¯¹k8sè¿›è¡Œäº†åŠŸèƒ½çš„æ‹“å±•ä¸å®ç°äº†å’Œk8sé›†ç¾¤äº¤äº’çš„ä¸€äº›ä¾¿æ·å·¥å…·ï¼ŒåŒ…æ‹¬æ‰§è¡Œå‘½ä»¤è¡Œï¼Œç®¡ç†å¤šä¸ª k8sé›†ç¾¤ï¼ŒæŸ¥çœ‹k8sé›†ç¾¤èŠ‚ç‚¹çš„è¿è¡ŒçŠ¶æ€ç­‰ç­‰ã€‚","link":"/2021/10/29/ServiceMesh-Serverless-K8s/"},{"title":"etcd","text":"â€¦ etcd1. ä»‹ç»1.1 ä»€ä¹ˆæ˜¯etcd å®˜æ–¹ä»‹ç» etcd is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines. It gracefully handles leader elections during network partitions and can tolerate machine failure, even in the leader node. Learn more ç™¾åº¦æ‰¾çš„ å®ƒæ˜¯ä¸€ç§ç”¨äºå…±äº«é…ç½®å’ŒæœåŠ¡å‘ç°çš„åˆ†å¸ƒå¼ã€å¼ºä¸€è‡´æ€§çš„K-Vå­˜å‚¨ç³»ç»Ÿï¼ŒåŸºäºHTTP+JSONçš„APIè®©ä½ ç”¨curlå°±å¯ä»¥è½»æ¾ä½¿ç”¨ï¼Œå¯é€‰SSLå®¢æˆ·è®¤è¯æœºåˆ¶ï¼Œæ¯ä¸ªå®ä¾‹æ¯ç§’æ”¯æŒä¸€åƒæ¬¡å†™æ“ä½œï¼Œä½¿ç”¨Raftç®—æ³•å……åˆ†å®ç°äº†åˆ†å¸ƒå¼ã€‚ åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®åˆ†ä¸ºæ§åˆ¶æ•°æ®å’Œåº”ç”¨æ•°æ®ï¼Œectdé»˜è®¤å¤„ç†çš„æ•°æ®éƒ½æ˜¯æ§åˆ¶æ•°æ®ã€‚ è‡³äºä¼ ç»Ÿæ•°æ®åº“ï¼Œå¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„æœ‰Oracleã€MySQLã€Redisã€MongoDBç­‰ï¼Œéšç€äº‘è®¡ç®—çš„å‘å±•ï¼Œä¼ ç»Ÿæ•°æ®åº“çš„å¼Šç«¯è¶Šæ¥è¶Šæ˜æ˜¾ï¼Œç§»åŠ¨äº’è”ç½‘ã€ç‰©è”ç½‘äº§ç”Ÿæµ·é‡æ•°æ®ï¼Œè¦æ±‚æ•°æ®åº“æœ‰æ›´é«˜çš„æ‰©å±•æ€§ï¼Œä½†ä¼ ç»Ÿæ•°æ®åº“æ˜¯é›†ä¸­å¼æ¶æ„ï¼Œåœ¨æ‰©å±•æ€§å’Œçµæ´»ä¸Šå…ˆå¤©ä¸è¶³ï¼Œå¦‚æœéœ€è¦æ‰©å±•é€šå¸¸åªèƒ½æ˜¯Scale upï¼Œä¸ºæ­¤éœ€è¦è´­ä¹°æ˜‚è´µè®¾å¤‡ï¼ŒæŠ•èµ„ä¸è²ã€‚ è¿™ä¸ªæ—¶å€™NewSQLã€NoSQLå’Œäº‘æ•°æ®åº“åº”è¿è€Œç”Ÿï¼Œäº‘æ•°æ®åº“å¤©ç„¶å…·å¤‡äº‘ä¸Šçµæ´»æ€§ï¼Œæ”¯æŒå¸‚é¢ä¸Šä¸»æµçš„å•†ä¸šæ•°æ®åº“ï¼Œå…¶ç»æµé«˜æ•ˆçš„éƒ¨ç½²æ–¹å¼å’ŒæŒ‰éœ€ä»˜è´¹çš„æ”¯ä»˜æ¨¡å¼ç»™æ•°æ®åº“å¼€å¯äº†æ–°æ—¶ä»£çš„å¤§é—¨ã€‚ å¦å¤–ï¼Œetcdå’Œåˆ†å¸ƒå¼dbå·®å¼‚å¾ˆå¤§ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªkvå­˜å‚¨ï¼Œä½¿ç”¨åœºæ™¯å¾ˆæœ‰é™ã€‚å®ƒä¸æ”¯æŒsqlï¼Œå­˜å‚¨æ•°æ®é‡ä¹Ÿå¾ˆæœ‰é™ã€‚åˆ†å¸ƒå¼dbæœ‰äº›ä¼šåŸºäºetcdæ¥åšé›†ç¾¤ç®¡ç†ç­‰ï¼ˆå¦‚gausså’Œtbaseï¼‰ï¼Œtdsqlæ˜¯ç”¨zookeeperåšç±»ä¼¼åŠŸèƒ½ï¼Œ å…¶ä»–ç­”ä¸»ä¹Ÿæœ‰æåˆ°ã€‚etcd ä½œä¸ºä¸€ä¸ªé«˜å¯ç”¨é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œå¤©ç”Ÿå°±æ˜¯ä¸ºé›†ç¾¤åŒ–è€Œè®¾è®¡çš„ã€‚ç”±äºRaft ç®—æ³•åœ¨åšå†³ç­–æ—¶éœ€è¦å¤šæ•°èŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œæ‰€ä»¥etcd ä¸€èˆ¬éƒ¨ç½²é›†ç¾¤æ¨èå¥‡æ•°ä¸ªèŠ‚ç‚¹ï¼Œæ¨èçš„æ•°é‡ä¸º3ã€5 æˆ–è€…7 ä¸ªèŠ‚ç‚¹æ„æˆä¸€ä¸ªé›†ç¾¤ã€‚ åœ¨äº‘è®¡ç®—æ—¶ä»£ï¼Œæ€ä¹ˆæ ·èƒ½è®©æœåŠ¡å¿«é€Ÿé€æ˜åœ°æ¥å…¥åˆ°è®¡ç®—é›†ç¾¤ä¸­ï¼Œè®©å…±äº«é…ç½®ä¿¡æ¯å¿«é€Ÿè¢«é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨å‘ç°ï¼Œä»¥åŠå¦‚ä½•æ„å»ºä¸€å¥—é«˜å¯ç”¨ã€å®‰å…¨ã€æ˜“äºéƒ¨ç½²ä»¥åŠå“åº”å¿«é€Ÿçš„æœåŠ¡é›†ç¾¤ï¼Œæ˜¯è¿«åˆ‡éœ€è¦è§£å†³çš„é—®é¢˜ã€‚etcd å¯ä»¥è¯´æ˜¯ä¸ºè§£å†³è¿™ç±»é—®é¢˜å¸¦æ¥äº†æ–°çš„åŠæ³•ã€‚ è¢«k8sé‡‡ç”¨ä½œä¸ºå…¶æ•°æ®åº“","link":"/2021/11/01/etcd/"},{"title":"Javaè™šæ‹Ÿæœº (JVM)","text":"Java è™šæ‹ŸæœºçŸ¥è¯†ç‚¹ï¼Œæ€»ç»“è‡ªã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ 1. JVMç»“æ„ å †+æ ˆ+ç¨‹åºè®¡æ•°å™¨+æ–¹æ³•åŒº(MetaSpace1.8) Attention: æ ˆå’Œç¨‹åºè®¡æ•°å™¨ä¸ºçº¿ç¨‹ç§æœ‰ 1.1 ç¨‹åºè®¡æ•°å™¨ å­˜æ”¾çº¿ç¨‹çš„å­—èŠ‚ç æŒ‡ä»¤ã€åˆ†æ”¯ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†ç­‰ä¿¡æ¯ã€‚ ä¸ä¼šå‡ºç°ä»»ä½•æº¢å‡ºå¼‚å¸¸ã€‚ 1.2 è™šæ‹Ÿæœºæ ˆ -Xss è®¾ç½®å¤§å° æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºæ ˆå¸§,æ–¹æ³•çš„è°ƒç”¨æ˜¯æ ˆå¸§å‡ºæ ˆå’Œå…¥æ ˆçš„è¿‡ç¨‹ã€‚ æ ˆå¸§ï¼šå±€éƒ¨å˜é‡è¡¨ç­‰ã€‚ å®½åº¦ï¼šæ ˆå¸§å†…å­˜å¤§å° è™šæ‹Ÿæœºæ ˆçš„æ·±åº¦ï¼šæ ˆå¸§çš„æ•°é‡ 1.3 æœ¬åœ°æ–¹æ³•æ ˆ è°ƒç”¨çš„æ–¹æ³•æ˜¯æœ¬åœ°æ–¹æ³•çš„æ¥å£,ä¹Ÿå°±æ˜¯C/C++ç¨‹åºã€‚ 1.4 å † 1.5 æ–¹æ³•åŒº(æ°¸ä¹…ä»£) / MetaSpace jdk1.8 å­˜å‚¨å·²ç»è¢«JVMåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€JITç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚jdk1.7å¼€å§‹ï¼Œå­—ç¬¦ä¸²æ”¾åˆ°äº†å †ä¸­ã€‚ 2 Thread å’Œ JVM çš„å…³ç³»Javaè¿›ç¨‹çš„å†…å­˜å¤§å°(å³è®¡ç®—æœºRAMå†…å­˜) = å †å†…å­˜ + çº¿ç¨‹æ•°é‡ * æ ˆå†…å­˜ã€‚ æ•… æ ˆå†…å­˜(-Xss)è¶Šå¤§ï¼Œçº¿ç¨‹æ•°é‡å°±è¶Šå°‘ã€‚ 3 JVM ç±»åŠ è½½å™¨3.1 JVM å†…ç½®ä¸‰å¤§ç±»åŠ è½½å™¨â€‹ BootStrap CL &lt;- Extend CL &lt;- Application CL, éµå¾ª åŒäº²/çˆ¶ å§”æ‰˜æœºåˆ¶. â€‹ æ ¹åŠ è½½å™¨è´Ÿè´£è™šæ‹Ÿæœºæ ¸å¿ƒç±»åº“çš„åŠ è½½ï¼Œæ‹“å±•åŠ è½½å™¨è´Ÿè´£åŠ è½½JAVA_HOMEä¸‹jre\\lb\\extä¸‹å­ç›®å½•çš„ç±»åº“ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½classpathä¸‹çš„ç±»åº“èµ„æºã€‚ 3.2 class è¢«åŠ è½½åçš„å†…å­˜æƒ…å†µ æ ˆå†…å­˜(æŒ‡é’ˆ) å †åŒº æ–¹æ³•åŒº Classloaderçš„å¼•ç”¨ â€“&gt; ClassLoaderå¯¹è±¡ A class å¯¹è±¡çš„å¼•ç”¨ â€“&gt; A çš„ class å¯¹è±¡ â€“&gt; A ç±»çš„æ•°æ®ç»“æ„ A å¯¹è±¡çš„å¼•ç”¨ â€“&gt; A å¯¹è±¡ 4 Images 5 é…ç½®&amp;è°ƒä¼˜é…ç½®è¯´æ˜ -Xmxï¼šæœ€å¤§å †å¤§å°-Xmsï¼šåˆå§‹å †å¤§å°-Xmn:å¹´è½»ä»£å¤§å°ï¼ˆnï¼šNew generationï¼‰-XXSurvivorRatioï¼šå¹´è½»ä»£ä¸­EdenåŒºä¸SurvivoråŒºçš„å¤§å°æ¯”å€¼ï¼ˆä¸€èˆ¬å¯¹è±¡æ”¾EdenåŒºï¼ŒSåŒºæ˜¯è¾…åŠ©ï¼‰ ä¸ºé¿å…é¢‘ç¹GCï¼Œå¯å°†å †çš„åˆå§‹å€¼æœ€å¤§å€¼æ”¹ä¸ºç›¸ç­‰ã€‚ï¼ˆ-Xms &amp; -Xmxï¼‰ è¿™æ˜¯é»˜è®¤çš„é…ç½®(idea.vmoptions): 1234567891011121314151617-Xms128m-Xmx1024m-XX:ReservedCodeCacheSize=512m-XX:+UseConcMarkSweepGC // CMS åƒåœ¾å›æ”¶å™¨-XX:SoftRefLRUPolicyMSPerMB=50-XX:CICompilerCount=2-XX:+HeapDumpOnOutOfMemoryError-XX:-OmitStackTraceInFastThrow-ea-Dsun.io.useCanonCaches=false-Djdk.http.auth.tunneling.disabledSchemes=&quot;&quot;-Djdk.attach.allowAttachSelf=true-Djdk.module.illegalAccess.silent=true-Dkotlinx.coroutines.debug=off-XX:ErrorFile=$USER_HOME/java_error_in_idea_%p.log-XX:HeapDumpPath=$USER_HOME/java_error_in_idea.hprof å¤ªå›°äº†ä¹‹åå†å†™â€¦ 6 Java ç‰ˆæœ¬6.1 å‘å¸ƒæ—¥æœŸJDK 1.0 1996-01-23 å‘å¸ƒ JDK 1.1 1997-02-19 å‘å¸ƒ JDK 1.2 1998-12-04 å‘å¸ƒ JDK 1.3 2000-05-08 å‘å¸ƒ JDK 1.4 2002-02-13 å‘å¸ƒæ­£åˆ™è¡¨è¾¾å¼ï¼Œå¼‚å¸¸é“¾ï¼ŒNIOï¼Œæ—¥å¿—ç±»ï¼ŒXMLè§£æå™¨ï¼ŒXLST è½¬æ¢å™¨ JDK 1.5/5.0 2004-09-30 å‘å¸ƒè‡ªåŠ¨è£…ç®±ã€æ³›å‹ã€åŠ¨æ€æ³¨è§£ã€æšä¸¾ã€å¯å˜é•¿å‚æ•°ã€éå†å¾ªç¯ JDK 1.6/6.0 2006-04 æä¾›åŠ¨æ€è¯­è¨€æ”¯æŒã€æä¾›ç¼–è¯‘ API å’Œå«æ˜Ÿ HTTP æœåŠ¡å™¨ APIï¼Œæ”¹è¿› JVM çš„é”ï¼ŒåŒæ­¥åƒåœ¾å›æ”¶ï¼Œç±»åŠ è½½ JDK 1.7/7.0 2011-07-28 å‘å¸ƒæä¾›GIå›æ”¶å™¨ã€åŠ å¼ºå¯¹éJavaè¯­è¨€çš„è°ƒç”¨æ”¯æŒï¼ˆJSR-292,å‡çº§ç±»åŠ è½½æ¶æ„ JDK 1.8/8.0 2014-03-18 å‘å¸ƒLambda è¡¨è¾¾å¼ã€æ–¹æ³•å¼•ç”¨ã€é»˜è®¤æ–¹æ³•ã€æ–°å·¥å…·ã€Stream APIã€Date Time API ã€Optional ç±»ã€Nashorn, JavaScript å¼•æ“ JDK 9.0 2017-09-21 å‘å¸ƒJShellã€ä¸å¯å˜é›†åˆå·¥å‚æ–¹æ³•ã€æ¨¡å—ç³»ç»Ÿã€httpåè®®2.0ç‰ˆæœ¬ã€Process API/CompletableFuture API/Optional Class/Stream APIå¢å¼ºã€åŒ¿åå†…éƒ¨ç±»çš„é’»çŸ³æ“ä½œç¬¦ã€é»˜è®¤G1åƒåœ¾å›æ”¶å™¨ã€tryè¯­å¥è¯­æ³•æ”¹è¿› JDK 10.0 2018-03-21 å‘å¸ƒJIT ç¼–è¯‘å™¨ã€å±€éƒ¨å˜é‡ç±»å‹å¼•ç”¨ã€æ•°æ®ç±»å‹å…±äº«ã€å¹¶è¡ŒGCã€root è¯ä¹¦ã€javahå·¥å…·ã€å †åˆ†é… JDK 11.0 2018-09-25 å‘å¸ƒå•å‘½ä»¤è¿è¡ŒJavaæ–‡ä»¶ã€Lambda å‚æ•°å±€éƒ¨å˜é‡è¯­æ³•ã€åŸºäºåµŒå¥—è®¿é—®æ§åˆ¶ã€åŠ¨æ€ç±»æ–‡ä»¶å¸¸é‡ã€è¯¯æ“ä½œåƒåœ¾å›æ”¶å™¨ã€åˆ é™¤Java EEå’Œ CORBA æ¨¡å—ã€ChaCha20ä¸Poly1305åŠ å¯†ç®—æ³•ã€Aarch64å¢å¼ºã€ZGCè¯•ç”¨ã€å¼ƒç”¨ Nashorn JSå¼•æ“ JDK 12.0 2019-03-19 å‘å¸ƒJVM å¢å¼ºã€Switch è¡¨è¾¾å¼ã€æ–‡ä»¶ mismatch() æ–¹æ³•ã€String æ–°æ–¹æ³• indent()/transform()/describeConstable()/resolveConstantDesc()ã€JVMå¸¸é‡APIã€instanceof æ¨¡å¼åŒ¹é… JDK 13.0 2019-09-17 å‘å¸ƒæ”¯æŒç¼–å†™æ–‡æœ¬å—ã€Switch è¡¨è¾¾å¼å¢å¼ºã€é‡æ„é—ç•™çš„ Socket APIã€å–æ¶ˆæäº¤æœªä½¿ç”¨å†…å­˜ã€åŠ¨æ€CDSå­˜æ¡£ã€æ”¯æŒUnicode 12.1ã€DOM å’Œ SAX å·¥å‚æ”¯æŒå‘½åç©ºé—´ JDK 14.0 2020-03-17 å‘å¸ƒç©ºæŒ‡é’ˆå¼‚å¸¸å¢å¼ºæç¤ºã€Switch è¡¨è¾¾å¼ï¼ˆæ ‡å‡†ï¼‰ã€instanceof æ¨¡å¼åŒ¹é…ï¼ˆé¢„è§ˆï¼‰ã€Records ç±»ï¼ˆé¢„è§ˆï¼‰ã€æ–‡æœ¬å—ï¼ˆç¬¬äºŒæ¬¡é¢„è§ˆï¼‰ã€æ‰“åŒ…å·¥å…·ï¼ˆå­µåŒ–ï¼‰ã€JFR äº‹ä»¶æµã€ZGC ( æ”¯æŒ macOS å’Œ Windows )ã€å¤–éƒ¨å­˜å‚¨å™¨è®¿é—®APIï¼ˆå­µåŒ–ï¼‰ JDK 15.0 2020-09-15 å‘å¸ƒå¯†å°ç±»ï¼ˆé¢„è§ˆï¼‰ã€instanceof æ¨¡å¼åŒ¹é…ï¼ˆç¬¬äºŒæ¬¡é¢„è§ˆï¼‰ã€Records ç±»ï¼ˆç¬¬äºŒæ¬¡é¢„è§ˆï¼‰ã€æ–‡æœ¬å—ï¼ˆæ ‡å‡†ï¼‰ã€éšè—ç±»ã€åˆ é™¤ Nashorn JSå¼•æ“ã€é‡æ„é—ç•™çš„ DatagramSocket APIã€å¤–éƒ¨å­˜å‚¨å™¨è®¿é—®APIï¼ˆç¬¬äºŒæ¬¡å­µåŒ–ï¼‰ã€å¼ƒç”¨RMIæ¿€æ´»ã€ç§»é™¤ Solaris å’Œ SPARC çš„ç«¯å£ JDK 16.0 2020-12-10 ç¬¬ä¸€æ¬¡ææ¡ˆå†»ç»“2021-01-14 ç¬¬äºŒæ¬¡ææ¡ˆå†»ç»“2021-02-04 å‘å¸ƒç¬¬ä¸€ä¸ªé¢„è§ˆç‰ˆæœ¬2021-02-18 å‘å¸ƒç¬¬äºŒä¸ªé¢„è§ˆç‰ˆæœ¬2021-03-16 æ­£å¼å‘å¸ƒ JDK 17.0 2021-09-15 æ­£å¼å‘å¸ƒ 6.2 JDK 9~17 åŠŸèƒ½ç‰¹æ€§ java 9: G1 java 11: ZGC JDK9æœ€å¤§ç‰¹æ€§æ˜¯å¼•å…¥äº†æ¨¡å—åŒ–æœºåˆ¶ï¼Œå¹¶æŠŠä¹‹å‰çš„rt.jaråšäº†æ‹†åˆ†ã€‚ åœ¨Java9ä¹‹åå¼•å…¥äº†æ¨¡å—åŒ–çš„æ¦‚å¿µï¼Œæ˜¯å°†ç±»å‹å’Œèµ„æºå°è£…åœ¨æ¨¡å—ä¸­ï¼Œå¹¶ä»…å¯¼å‡ºå…¶ä»–æ¨¡å—è¦è®¿é—®å…¶å…¬å…±ç±»å‹çš„è½¯ä»¶åŒ…ã€‚å¦‚æœæ¨¡å—ä¸­çš„è½¯ä»¶åŒ…æœªå¯¼å‡ºæˆ–æ‰“å¼€ï¼Œåˆ™è¡¨ç¤ºæ¨¡å—çš„è®¾è®¡äººå‘˜æ— æ„åœ¨æ¨¡å—å¤–éƒ¨ä½¿ç”¨è¿™äº›è½¯ä»¶åŒ…ã€‚ è¿™æ ·çš„åŒ…å¯èƒ½ä¼šè¢«ä¿®æ”¹æˆ–ç”šè‡³ä»æ¨¡å—ä¸­åˆ é™¤ï¼Œæ— éœ€ä»»ä½•é€šçŸ¥ã€‚ å¦‚æœä»ç„¶ä½¿ç”¨è¿™äº›è½¯ä»¶åŒ…é€šè¿‡ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹å¯¼å‡ºæˆ–æ‰“å¼€å®ƒä»¬ï¼Œå¯èƒ½ä¼šé¢ä¸´ç ´ååº”ç”¨ç¨‹åºçš„é£é™©ï¼ ä»¥ä¸‹å‡ ä¸ªåŒ…å˜æˆäº†ç‹¬ç«‹çš„jarä¾èµ–ï¼š JAF(javax.activationï¼‰ CORBA(java.corba) JTA (java.transaction) JAXBå’ŒJAX-WS Common Annotations é¡¹ç›®ä¸­å¦‚æœæœ‰ä½¿ç”¨ï¼Œéœ€è¦æ·»åŠ å¼•ç”¨ã€‚ ClassLoaderå˜åŒ–å¸¦æ¥çš„URLClassLoaderçš„å˜åŒ– Java 8çš„ClassLoaderæµç¨‹ï¼š bootstrap classloaderåŠ è½½rt.jarï¼Œjre/lib/endorsedext classloaderåŠ è½½jre/lib/extapplication classloaderåŠ è½½-cpæŒ‡å®šçš„ç±» java9åŠä¹‹åçš„classloaderæµç¨‹ï¼š bootstrap classloaderåŠ è½½lib/modulesext classloaderæ›´åä¸ºplatform classloaderï¼ŒåŠ è½½lib/modulesapplication classloaderåŠ è½½-cpï¼Œ-mpæŒ‡å®šçš„ç±»åŒæ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼ŒJDK9å¼€å§‹ï¼ŒAppClassLoaderä»–çˆ¹ä¸å†æ˜¯ URLClassLoader JDK10æœ€å¤§ç‰¹ç‚¹æ˜¯æ”¹è¿›å¹¶è¡Œå…¨åƒåœ¾å›æ”¶å™¨ G1ã€‚ å¤§å®¶å¦‚æœæ¥è§¦è¿‡ Java æ€§èƒ½è°ƒä¼˜å·¥ä½œï¼Œåº”è¯¥ä¼šçŸ¥é“ï¼Œè°ƒä¼˜çš„æœ€ç»ˆç›®æ ‡æ˜¯é€šè¿‡å‚æ•°è®¾ç½®æ¥è¾¾åˆ°å¿«é€Ÿã€ä½å»¶æ—¶çš„å†…å­˜åƒåœ¾å›æ”¶ä»¥æé«˜åº”ç”¨ååé‡ï¼Œå°½å¯èƒ½çš„é¿å…å› å†…å­˜å›æ”¶ä¸åŠæ—¶è€Œè§¦å‘çš„å®Œæ•´ GCï¼ˆFull GC ä¼šå¸¦æ¥åº”ç”¨å‡ºç°å¡é¡¿ï¼‰ã€‚ G1 åƒåœ¾å›æ”¶å™¨æ˜¯ Java 9 ä¸­ Hotspot çš„é»˜è®¤åƒåœ¾å›æ”¶å™¨ï¼Œæ˜¯ä»¥ä¸€ç§ä½å»¶æ—¶çš„åƒåœ¾å›æ”¶å™¨æ¥è®¾è®¡çš„ï¼Œæ—¨åœ¨é¿å…è¿›è¡Œ Full GCï¼Œä½†æ˜¯å½“å¹¶å‘æ”¶é›†æ— æ³•å¿«é€Ÿå›æ”¶å†…å­˜æ—¶ï¼Œä¼šè§¦å‘åƒåœ¾å›æ”¶å™¨å›é€€è¿›è¡Œ Full GCã€‚ä¹‹å‰ Java ç‰ˆæœ¬ä¸­çš„ G1 åƒåœ¾å›æ”¶å™¨æ‰§è¡Œ GC æ—¶é‡‡ç”¨çš„æ˜¯åŸºäºå•çº¿ç¨‹æ ‡è®°æ‰«æå‹ç¼©ç®—æ³•ï¼ˆmark-sweep-compactï¼‰ã€‚ä¸ºäº†æœ€å¤§é™åº¦åœ°å‡å°‘ Full GC é€ æˆçš„åº”ç”¨åœé¡¿çš„å½±å“ï¼ŒJava 10 ä¸­å°†ä¸º G1 å¼•å…¥å¤šçº¿ç¨‹å¹¶è¡Œ GCï¼ŒåŒæ—¶ä¼šä½¿ç”¨ä¸å¹´è½»ä»£å›æ”¶å’Œæ··åˆå›æ”¶ç›¸åŒçš„å¹¶è¡Œå·¥ä½œçº¿ç¨‹æ•°é‡ï¼Œä»è€Œå‡å°‘äº† Full GC çš„å‘ç”Ÿï¼Œä»¥å¸¦æ¥æ›´å¥½çš„æ€§èƒ½æå‡ã€æ›´å¤§çš„ååé‡ã€‚Java 10 ä¸­é‡‡ç”¨å¹¶è¡ŒåŒ– mark-sweep-compact ç®—æ³•ï¼Œå¹¶ä½¿ç”¨ä¸å¹´è½»ä»£å›æ”¶å’Œæ··åˆå›æ”¶ç›¸åŒæ•°é‡çš„çº¿ç¨‹ã€‚å…·ä½“å¹¶è¡Œ GC çº¿ç¨‹æ•°é‡å¯ä»¥é€šè¿‡ï¼š-XX:ParallelGCThreads å‚æ•°æ¥è°ƒèŠ‚ï¼Œä½†è¿™ä¹Ÿä¼šå½±å“ç”¨äºå¹´è½»ä»£å’Œæ··åˆæ”¶é›†çš„å·¥ä½œçº¿ç¨‹æ•° åŸºäº Java çš„ å®éªŒæ€§ JIT ç¼–è¯‘å™¨ï¼šJava 10 ä¸­å¼€å¯äº†åŸºäº Java çš„ JIT ç¼–è¯‘å™¨ Graalï¼Œå¹¶å°†å…¶ç”¨ä½œ Linux/x64 å¹³å°ä¸Šçš„å®éªŒæ€§ JIT ç¼–è¯‘å™¨å¼€å§‹è¿›è¡Œæµ‹è¯•å’Œè°ƒè¯•å·¥ä½œï¼Œå¦å¤– Graal å°†ä½¿ç”¨ Java 9 ä¸­å¼•å…¥çš„ JVM ç¼–è¯‘å™¨æ¥å£ï¼ˆJVMCIï¼‰ã€‚ Graal æ˜¯ä¸€ä¸ªä»¥ Java ä¸ºä¸»è¦ç¼–ç¨‹è¯­è¨€ã€é¢å‘ Java bytecode çš„ç¼–è¯‘å™¨ã€‚ä¸ç”¨ C++å®ç°çš„ C1 åŠ C2 ç›¸æ¯”ï¼Œå®ƒçš„æ¨¡å—åŒ–æ›´åŠ æ˜æ˜¾ï¼Œä¹Ÿæ›´åŠ å®¹æ˜“ç»´æŠ¤ã€‚Graal æ—¢å¯ä»¥ä½œä¸ºåŠ¨æ€ç¼–è¯‘å™¨ï¼Œåœ¨è¿è¡Œæ—¶ç¼–è¯‘çƒ­ç‚¹æ–¹æ³•ï¼›äº¦å¯ä»¥ä½œä¸ºé™æ€ç¼–è¯‘å™¨ï¼Œå®ç° AOT ç¼–è¯‘ã€‚åœ¨ Java 10 ä¸­ï¼ŒGraal ä½œä¸ºè¯•éªŒæ€§ JIT ç¼–è¯‘å™¨ä¸€åŒå‘å¸ƒï¼ˆJEP 317ï¼‰ã€‚å°† Graal ç¼–è¯‘å™¨ç ”ç©¶é¡¹ç›®å¼•å…¥åˆ° Java ä¸­ï¼Œæˆ–è®¸èƒ½å¤Ÿä¸º JVM æ€§èƒ½ä¸å½“å‰ C++ æ‰€å†™ç‰ˆæœ¬åŒ¹æ•Œï¼ˆæˆ–æœ‰å¹¸è¶…è¶Šï¼‰æä¾›åŸºç¡€ã€‚ Java 10 ä¸­é»˜è®¤æƒ…å†µä¸‹ HotSpot ä»ä½¿ç”¨çš„æ˜¯ C2 ç¼–è¯‘å™¨ï¼Œè¦å¯ç”¨ Graal ä½œä¸º JIT ç¼–è¯‘å™¨ï¼Œè¯·åœ¨ Java å‘½ä»¤è¡Œä¸Šä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š -XXï¼š+ UnlockExperimentalVMOptions -XXï¼š+ UseJVMCICompiler JDK11ï¼ˆLTSï¼‰æœ€å¤§å˜åŒ–æ—¶Linuxç‰ˆæœ¬æ–°å¢äº†ZGCã€‚ ZGCåœ¨Linux x64ä¸‹çš„JDK11ä»¥ä¸Šå¯ç”¨ï¼ŒMacå’ŒWindowsä¸Šéœ€è¦JDK15å¯ç”¨ã€‚ Java11 ZGCå®æµ‹gcæ—¶é—´ç¨³å®šåœ¨3mså·¦å³ï¼ˆå½“ç„¶ä¹Ÿè®¸è·Ÿåœºæ™¯æœ‰å…³ï¼Œå®˜æ–¹å£å¾„ä¸€èˆ¬åœ¨10msä»¥ä¸‹ï¼‰ã€‚ ZGCï¼šè¿™åº”è¯¥æ˜¯JDK11æœ€ä¸ºç©ç›®çš„ç‰¹æ€§ï¼Œæ²¡æœ‰ä¹‹ä¸€ã€‚ä½†æ˜¯åé¢å¸¦äº†Experimentalï¼Œè¯´æ˜è¿˜ä¸å»ºè®®ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒã€‚çœ‹çœ‹å®˜æ–¹å¯¹è¿™ä¸ªç‰¹æ€§çš„ç›®æ ‡æè¿°ï¼š GCæš‚åœæ—¶é—´ä¸ä¼šè¶…è¿‡10msï¼› å³èƒ½å¤„ç†å‡ ç™¾å…†å°å †ï¼Œä¹Ÿèƒ½å¤„ç†å‡ ä¸ªTçš„å¤§å †ï¼ˆOMGï¼‰ï¼› å’ŒG1ç›¸æ¯”ï¼Œåº”ç”¨ååèƒ½åŠ›ä¸ä¼šä¸‹é™è¶…è¿‡15%ï¼› ä¸ºæœªæ¥çš„GCåŠŸèƒ½å’Œåˆ©ç”¨colordæŒ‡é’ˆä»¥åŠLoad barriersä¼˜åŒ–å¥ å®šåŸºç¡€ï¼› åˆå§‹åªæ”¯æŒ64ä½ç³»ç»Ÿï¼› GCæ˜¯Javaä¸»è¦ä¼˜åŠ¿ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œå½“GCåœé¡¿å¤ªé•¿ï¼Œå°±ä¼šå¼€å§‹å½±å“åº”ç”¨çš„å“åº”æ—¶é—´ã€‚æ¶ˆé™¤æˆ–è€…å‡å°‘GCåœé¡¿æ—¶é•¿ï¼ŒJavaå°†å¯¹æ›´å¹¿æ³›çš„åº”ç”¨åœºæ™¯æ˜¯ä¸€ä¸ªæ›´æœ‰å¸å¼•åŠ›çš„å¹³å°ã€‚æ­¤å¤–ï¼Œç°ä»£ç³»ç»Ÿä¸­å¯ç”¨å†…å­˜ä¸æ–­å¢é•¿ï¼Œ ç”¨æˆ·å’Œç¨‹åºå‘˜å¸Œæœ›JVMèƒ½å¤Ÿä»¥é«˜æ•ˆçš„æ–¹å¼å……åˆ†åˆ©ç”¨è¿™äº›å†…å­˜ï¼Œå¹¶ä¸”æ— éœ€é•¿æ—¶é—´çš„GCæš‚åœæ—¶é—´ã€‚ ZGCä¸€ä¸ªå¹¶å‘ï¼ŒåŸºäºregionï¼Œå‹ç¼©å‹çš„åƒåœ¾æ”¶é›†å™¨ï¼Œåªæœ‰rootæ‰«æé˜¶æ®µä¼šSTWï¼Œå› æ­¤GCåœé¡¿æ—¶é—´ä¸ä¼šéšç€å †çš„å¢é•¿å’Œå­˜æ´»å¯¹è±¡çš„å¢é•¿è€Œå˜é•¿ã€‚ ZGCå’ŒG1åœé¡¿æ—¶é—´æ¯”è¾ƒï¼š Plain Text ZGC avg: 1.091ms (+/-0.215ms) 95th percentile: 1.380ms 99th percentile: 1.512ms 99.9th percentile: 1.663ms 99.99th percentile: 1.681ms max: 1.681ms G1 avg: 156.806ms (+/-71.126ms) 95th percentile: 316.672ms 99th percentile: 428.095ms 99.9th percentile: 543.846ms 99.99th percentile: 543.846ms max: 543.846ms ç”¨æ³•ï¼š Plain Text -XX:+UnlockExperimentalVMOptions -XX:+UseZGC å› ä¸ºZGCè¿˜å¤„äºå®éªŒé˜¶æ®µï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡JVMå‚æ•°UnlockExperimentalVMOptions æ¥è§£é”è¿™ä¸ªç‰¹æ€§ã€‚ ä¸è¿‡ç›®å‰ ZGC è¿˜å¤„äºå®éªŒé˜¶æ®µï¼Œç›®å‰åªåœ¨ Linux/x64 ä¸Šå¯ç”¨ï¼Œå¦‚æœæœ‰è¶³å¤Ÿçš„éœ€æ±‚ï¼Œå°†æ¥å¯èƒ½ä¼šå¢åŠ å¯¹å…¶ä»–å¹³å°çš„æ”¯æŒã€‚åŒæ—¶ä½œä¸ºå®éªŒæ€§åŠŸèƒ½çš„ ZGC å°†ä¸ä¼šå‡ºç°åœ¨ JDK æ„å»ºä¸­ï¼Œé™¤éåœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ configure å‚æ•°ï¼šâ€“with-jvm-features=zgc æ˜¾å¼å¯ç”¨ã€‚ åœ¨å®éªŒé˜¶æ®µï¼Œç¼–è¯‘å®Œæˆä¹‹åï¼Œå·²ç»è¿«ä¸åŠå¾…çš„æƒ³è¯•è¯• ZGCï¼Œéœ€è¦é…ç½®ä»¥ä¸‹ JVM å‚æ•°ï¼Œæ‰èƒ½ä½¿ç”¨ ZGCï¼Œå…·ä½“å¯åŠ¨ ZGC å‚æ•°å¦‚ä¸‹ï¼š -XXï¼š+ UnlockExperimentalVMOptions -XXï¼š+ UseZGC -Xmx10g å…¶ä¸­å‚æ•°ï¼š-Xmx æ˜¯ ZGC æ”¶é›†å™¨ä¸­æœ€é‡è¦çš„è°ƒä¼˜é€‰é¡¹ï¼Œå¤§å¤§è§£å†³äº†ç¨‹åºå‘˜åœ¨ JVM å‚æ•°è°ƒä¼˜ä¸Šçš„å›°æ‰°ã€‚ZGC æ˜¯ä¸€ä¸ªå¹¶å‘æ”¶é›†å™¨ï¼Œå¿…é¡»è¦è®¾ç½®ä¸€ä¸ªæœ€å¤§å †çš„å¤§å°ï¼Œåº”ç”¨éœ€è¦å¤šå¤§çš„å †ï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªè€ƒé‡ï¼š - å¯¹è±¡çš„åˆ†é…é€Ÿç‡ï¼Œè¦ä¿è¯åœ¨ GC çš„æ—¶å€™ï¼Œå †ä¸­æœ‰è¶³å¤Ÿçš„å†…å­˜åˆ†é…æ–°å¯¹è±¡ã€‚ - ä¸€èˆ¬æ¥è¯´ï¼Œç»™ ZGC çš„å†…å­˜è¶Šå¤šè¶Šå¥½ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½æµªè´¹å†…å­˜ï¼Œæ‰€ä»¥è¦æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ã€‚ Java11ä¸­è¿˜æ–°å¼•å…¥çš„Epsilonâ€“ç¥å…½è²”è²…ä¸€èˆ¬åªåƒä¸æ‹‰ï¼Œæ‰€ä»¥å°±ä¸å›æ”¶å’Œé‡Šæ”¾å†…å­˜ï¼Œéå¸¸é€‚åˆç”¨æ¥åšæ€§èƒ½åˆ†æã€‚ Epsilonåƒåœ¾å›æ”¶å™¨çš„ç›®æ ‡æ˜¯å¼€å‘ä¸€ä¸ªæ§åˆ¶å†…å­˜åˆ†é…ï¼Œä½†æ˜¯ä¸æ‰§è¡Œä»»ä½•å®é™…çš„åƒåœ¾å›æ”¶å·¥ä½œã€‚å®ƒæä¾›ä¸€ä¸ªå®Œå…¨æ¶ˆæçš„ GC å®ç°ï¼Œåˆ†é…æœ‰é™çš„å†…å­˜èµ„æºï¼Œæœ€å¤§é™åº¦çš„é™ä½å†…å­˜å ç”¨å’Œå†…å­˜ååå»¶è¿Ÿæ—¶é—´ã€‚ Java ç‰ˆæœ¬ä¸­å·²ç»åŒ…å«äº†ä¸€ç³»åˆ—çš„é«˜åº¦å¯é…ç½®åŒ–çš„ GC å®ç°ã€‚å„ç§ä¸åŒçš„åƒåœ¾å›æ”¶å™¨å¯ä»¥é¢å¯¹å„ç§æƒ…å†µã€‚ä½†æ˜¯æœ‰äº›æ—¶å€™ä½¿ç”¨ä¸€ç§ç‹¬ç‰¹çš„å®ç°ï¼Œè€Œä¸æ˜¯å°†å…¶å †ç§¯åœ¨å…¶ä»– GC å®ç°ä¸Šå°†ä¼šæ˜¯äº‹æƒ…å˜å¾—æ›´åŠ ç®€å•ã€‚ Epsilon åƒåœ¾å›æ”¶å™¨å’Œå…¶ä»–åƒåœ¾å›æ”¶å™¨ä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡å‚æ•°-XX:+UseEpsilonGC å¼€å¯ã€‚ JDK12Java 12 ä¸­å¼•å…¥ä¸€ä¸ªæ–°çš„åƒåœ¾æ”¶é›†å™¨ï¼šShenandoahï¼Œå®ƒæ˜¯ä½œä¸ºä¸€ä¸­ä½åœé¡¿æ—¶é—´çš„åƒåœ¾æ”¶é›†å™¨è€Œå¼•å…¥åˆ° Java 12 ä¸­çš„ï¼Œå…¶å·¥ä½œåŸç†æ˜¯é€šè¿‡ä¸ Java åº”ç”¨ç¨‹åºä¸­çš„æ‰§è¡Œçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œç”¨ä»¥æ‰§è¡Œå…¶åƒåœ¾æ”¶é›†ã€å†…å­˜å›æ”¶ä»»åŠ¡ï¼Œé€šè¿‡è¿™ç§è¿è¡Œæ–¹å¼ï¼Œç»™è™šæ‹Ÿæœºå¸¦æ¥çŸ­æš‚çš„åœé¡¿æ—¶é—´ã€‚ Shenandoah åƒåœ¾å›æ”¶å™¨æ˜¯ Red Hat åœ¨ 2014 å¹´å®£å¸ƒè¿›è¡Œçš„ä¸€é¡¹åƒåœ¾æ”¶é›†å™¨ç ”ç©¶é¡¹ç›®ï¼Œæ—¨åœ¨é’ˆå¯¹ JVM ä¸Šçš„å†…å­˜æ”¶å›å®ç°ä½åœé¡¿çš„éœ€æ±‚ã€‚è¯¥è®¾è®¡å°†ä¸åº”ç”¨ç¨‹åºçº¿ç¨‹å¹¶å‘ï¼Œé€šè¿‡äº¤æ¢ CPU å¹¶å‘å‘¨æœŸå’Œç©ºé—´ä»¥æ”¹å–„åœé¡¿æ—¶é—´ï¼Œä½¿å¾—åƒåœ¾å›æ”¶å™¨æ‰§è¡Œçº¿ç¨‹èƒ½å¤Ÿåœ¨ Java çº¿ç¨‹è¿è¡Œæ—¶è¿›è¡Œå †å‹ç¼©ï¼Œå¹¶ä¸”æ ‡è®°å’Œæ•´ç†èƒ½å¤ŸåŒæ—¶è¿›è¡Œï¼Œå› æ­¤é¿å…äº†åœ¨å¤§å¤šæ•° JVM åƒåœ¾æ”¶é›†å™¨ä¸­æ‰€é‡åˆ°çš„é—®é¢˜ã€‚ æ® Red Hat ç ”å‘ Shenandoah å›¢é˜Ÿå¯¹å¤–å®£ç§°ï¼ŒShenandoah åƒåœ¾å›æ”¶å™¨çš„æš‚åœæ—¶é—´ä¸å †å¤§å°æ— å…³ï¼Œè¿™æ„å‘³ç€æ— è®ºå°†å †è®¾ç½®ä¸º 200 MB è¿˜æ˜¯ 200 GBï¼Œéƒ½å°†æ‹¥æœ‰ä¸€è‡´çš„ç³»ç»Ÿæš‚åœæ—¶é—´ï¼Œä¸è¿‡å®é™…ä½¿ç”¨æ€§èƒ½å°†å–å†³äºå®é™…å·¥ä½œå †çš„å¤§å°å’Œå·¥ä½œè´Ÿè½½ã€‚ Shenandoahåœ¨Linux x64ä¸‹çš„JDK12ä»¥ä¸Šå¯ç”¨ï¼ˆåœ¨ç”±Red Hat å…¬å¸å‘è¡Œçš„Linuxç‰ˆæœ¬redhat/centosä¸Šï¼Œå¯ä»¥backportåˆ°JDK8çš„é«˜ç‰ˆæœ¬ï¼‰ï¼ŒMacå’ŒWindowsä¸Šéœ€è¦JDK15å¯ç”¨ã€‚ Shennadoahå·¥ä½œå‘¨æœŸå¦‚ä¸‹ï¼š Init Mark å¯åŠ¨å¹¶å‘æ ‡è®° é˜¶æ®µå¹¶å‘æ ‡è®°éå†å †é˜¶æ®µå¹¶å‘æ ‡è®°å®Œæˆé˜¶æ®µå¹¶å‘æ•´ç†å›æ”¶æ— æ´»åŠ¨åŒºåŸŸé˜¶æ®µå¹¶å‘ Evacuation æ•´ç†å†…å­˜åŒºåŸŸé˜¶æ®µInit Update Refs æ›´æ–°å¼•ç”¨åˆå§‹åŒ– é˜¶æ®µå¹¶å‘æ›´æ–°å¼•ç”¨é˜¶æ®µFinal Update Refs å®Œæˆå¼•ç”¨æ›´æ–°é˜¶æ®µå¹¶å‘å›æ”¶æ— å¼•ç”¨åŒºåŸŸé˜¶æ®µéœ€è¦äº†è§£ä¸æ˜¯å”¯æœ‰ GC åœé¡¿å¯èƒ½å¯¼è‡´å¸¸è§„åº”ç”¨ç¨‹åºå“åº”æ—¶é—´æ¯”è¾ƒé•¿ã€‚å…·æœ‰è¾ƒé•¿çš„ GC åœé¡¿æ—¶é—´ä¼šå¯¼è‡´ç³»ç»Ÿå“åº”æ…¢çš„é—®é¢˜ï¼Œä½†å“åº”æ—¶é—´æ…¢å¹¶éä¸€å®šæ˜¯ GC åœé¡¿æ—¶é—´é•¿å¯¼è‡´çš„ï¼Œé˜Ÿåˆ—å»¶è¿Ÿã€ç½‘ç»œå»¶è¿Ÿã€å…¶ä»–ä¾èµ–æœåŠ¡å»¶è¿Ÿå’Œæ“ä½œæä¾›è°ƒåº¦ç¨‹åºæŠ–åŠ¨ç­‰éƒ½å¯èƒ½å¯¼è‡´å“åº”å˜æ…¢ã€‚ ä½¿ç”¨ Shenandoah æ—¶éœ€è¦å…¨é¢äº†è§£ç³»ç»Ÿè¿è¡Œæƒ…å†µï¼Œç»¼åˆåˆ†æç³»ç»Ÿå“åº”æ—¶é—´ã€‚å„ç§ GC å·¥ä½œè´Ÿè½½å¯¹æ¯”å¦‚ä¸‹æ‰€ç¤ºï¼š æ¨èå‡ ä¸ªé…ç½®æˆ–è°ƒè¯• Shenandoah çš„ JVM å‚æ•°: -XX:+AlwaysPreTouchï¼šä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„å†…å­˜åˆ†é¡µï¼Œå‡å°‘ç³»ç»Ÿè¿è¡Œåœé¡¿ï¼Œä¸ºé¿å…è¿è¡Œæ—¶æ€§èƒ½æŸå¤±ã€‚ -Xmx == -Xmsï¼šè®¾ç½®åˆå§‹å †å¤§å°ä¸æœ€å¤§å€¼ä¸€è‡´ï¼Œå¯ä»¥å‡è½»ä¼¸ç¼©å †å¤§å°å¸¦æ¥çš„å‹åŠ›ï¼Œä¸ AlwaysPreTouch å‚æ•°é…åˆä½¿ç”¨ï¼Œåœ¨å¯åŠ¨æ—¶æäº¤æ‰€æœ‰å†…å­˜ï¼Œé¿å…åœ¨æœ€ç»ˆä½¿ç”¨ä¸­å‡ºç°ç³»ç»Ÿåœé¡¿ã€‚ -XX:+ UseTransparentHugePagesï¼šèƒ½å¤Ÿå¤§å¤§æé«˜å¤§å †çš„æ€§èƒ½ï¼ŒåŒæ—¶å»ºè®®åœ¨ Linux ä¸Šä½¿ç”¨æ—¶å°† /sys/kernel/mm/transparent_hugepage/enabled å’Œ /sys/kernel/mm/transparent_hugepage/defragv è®¾ç½®ä¸ºï¼šmadviseï¼ŒåŒæ—¶ä¸ AlwaysPreTouch ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œinit å’Œ shutdownv é€Ÿåº¦ä¼šæ›´å¿«ï¼Œå› ä¸ºå®ƒå°†ä½¿ç”¨æ›´å¤§çš„é¡µé¢è¿›è¡Œé¢„å¤„ç†ã€‚ -XX:+UseNUMAï¼šè™½ç„¶ Shenandoah å°šæœªæ˜ç¡®æ”¯æŒ NUMAï¼ˆNon-Uniform Memory Accessï¼‰ï¼Œä½†æœ€å¥½å¯ç”¨æ­¤åŠŸèƒ½ä»¥åœ¨å¤šæ’æ§½ä¸»æœºä¸Šå¯ç”¨ NUMA äº¤é”™ã€‚ä¸ AlwaysPreTouch ç›¸ç»“åˆï¼Œå®ƒæä¾›äº†æ¯”é»˜è®¤é…ç½®æ›´å¥½çš„æ€§èƒ½ã€‚ -XX:+DisableExplicitGCï¼šå¿½ç•¥ä»£ç ä¸­çš„ System.gc() è°ƒç”¨ã€‚å½“ç”¨æˆ·åœ¨ä»£ç ä¸­è°ƒç”¨ System.gc() æ—¶ä¼šå¼ºåˆ¶ Shenandoah æ‰§è¡Œ STW Full GC ï¼Œåº”ç¦ç”¨å®ƒä»¥é˜²æ­¢æ‰§è¡Œæ­¤æ“ä½œï¼Œå¦å¤–è¿˜å¯ä»¥ä½¿ç”¨ -XX:+ExplicitGCInvokesConcurrentï¼Œåœ¨ è°ƒç”¨ System.gc() æ—¶æ‰§è¡Œ CMS GC è€Œä¸æ˜¯ Full GCï¼Œå»ºè®®åœ¨æœ‰ System.gc() è°ƒç”¨çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ä¸è¿‡ç›®å‰ Shenandoah åƒåœ¾å›æ”¶å™¨è¿˜è¢«æ ‡è®°ä¸ºå®éªŒé¡¹ç›®ï¼Œéœ€è¦ä½¿ç”¨å‚æ•°ï¼š- XX:+UnlockExperimentalVMOptions å¯ç”¨ã€‚æ›´å¤šæœ‰å…³å¦‚ä½•é…ç½®ã€è°ƒè¯• Shenandoah çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… henandoah wikiã€‚ æ³¨æ„ï¼ŒZGCå’ŒShenandoah GCéƒ½å¯ä»¥çœ‹åšæ˜¯Azul å…¬å¸æå‡ºçš„æ— åœé¡¿GCï¼ˆPauseless GCï¼‰çš„å¼€æºå®ç°ç‰ˆæœ¬ã€‚ Java12ä¸­ç»§ç»­æ”¹å–„äº†G1 GC G1 æ˜¯åƒåœ¾æ”¶é›†å™¨ï¼Œè®¾è®¡ç”¨äºå…·æœ‰å¤§é‡å†…å­˜çš„å¤šå¤„ç†å™¨æœºå™¨ï¼Œæé«˜äº†åƒåœ¾å›æ”¶æ•ˆç‡ã€‚è¯¥åƒåœ¾æ”¶é›†å™¨ è®¾è®¡çš„ä¸»è¦ç›®æ ‡ä¹‹ä¸€æ˜¯æ»¡è¶³ç”¨æˆ·è®¾ç½®çš„é¢„æœŸçš„ JVM åœé¡¿æ—¶é—´ï¼ŒG1 é‡‡ç”¨ä¸€ä¸ªé«˜çº§åˆ†æå¼•æ“æ¥é€‰æ‹©åœ¨æ”¶é›†æœŸé—´è¦å¤„ç†çš„å·¥ä½œé‡ï¼Œæ­¤é€‰æ‹©è¿‡ç¨‹çš„ç»“æœæ˜¯ä¸€ç»„ç§°ä¸º GC å›æ”¶é›†çš„åŒºåŸŸã€‚ä¸€æ—¦æ”¶é›†å™¨ç¡®å®šäº† GC å›æ”¶é›† å¹¶ä¸” GC å›æ”¶ã€æ•´ç†å·¥ä½œå·²ç»å¼€å§‹ï¼Œåˆ™ G1 æ”¶é›†å™¨å¿…é¡»å®Œæˆæ”¶é›†é›†åˆé›†çš„æ‰€æœ‰åŒºåŸŸä¸­çš„æ‰€æœ‰æ´»åŠ¨å¯¹è±¡ä¹‹åæ‰èƒ½åœæ­¢ï¼›ä½†æ˜¯å¦‚æœæ”¶é›†å™¨é€‰æ‹©è¿‡å¤§çš„ GC å›æ”¶é›†ï¼Œå¯èƒ½ä¼šå¯¼è‡´ G1 å›æ”¶å™¨åœé¡¿æ—¶é—´è¶…è¿‡é¢„æœŸæ—¶é—´ã€‚ Java 12 ä¸­å°†æŠŠ GC å›æ”¶é›†ï¼ˆæ··åˆæ”¶é›†é›†åˆï¼‰æ‹†åˆ†ä¸ºå¿…éœ€å’Œå¯é€‰ä¸¤éƒ¨åˆ†ï¼Œä½¿ G1 åƒåœ¾å›æ”¶å™¨èƒ½ä¸­æ­¢åƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚å…¶ä¸­å¿…éœ€å¤„ç†çš„éƒ¨åˆ†åŒ…æ‹¬ G1 åƒåœ¾æ”¶é›†å™¨ä¸èƒ½é€’å¢å¤„ç†çš„ GC å›æ”¶é›†çš„éƒ¨åˆ†ï¼ˆå¦‚ï¼šå¹´è½»ä»£ï¼‰ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åŒ…å«è€å¹´ä»£ä»¥æé«˜å¤„ç†æ•ˆç‡ã€‚å°† GC å›æ”¶é›†æ‹†åˆ†ä¸ºå¿…éœ€å’Œå¯é€‰éƒ¨åˆ†æ—¶ï¼Œéœ€è¦ä¸ºå¯é€‰ GC å›æ”¶é›†éƒ¨åˆ†ç»´æŠ¤ä¸€äº›å…¶ä»–æ•°æ®ï¼Œè¿™ä¼šäº§ç”Ÿè½»å¾®çš„ CPU å¼€é”€ï¼Œä½†å°äº 1 ï¼…çš„å˜åŒ–ï¼ŒåŒæ—¶åœ¨ G1 å›æ”¶å™¨å¤„ç† GC å›æ”¶é›†æœŸé—´ï¼Œæœ¬æœºå†…å­˜ä½¿ç”¨ç‡ä¹Ÿå¯èƒ½ä¼šå¢åŠ ï¼Œä½¿ç”¨ä¸Šè¿°æƒ…å†µåªé€‚ç”¨äºåŒ…å«å¯é€‰ GC å›æ”¶éƒ¨åˆ†çš„ GC æ··åˆå›æ”¶é›†åˆã€‚ åœ¨ G1 åƒåœ¾å›æ”¶å™¨å®Œæˆæ”¶é›†éœ€è¦å¿…éœ€å›æ”¶çš„éƒ¨åˆ†ä¹‹åï¼Œä¾¿å¼€å§‹æ”¶é›†å¯é€‰çš„éƒ¨åˆ†ï¼Œå¦‚æœè¿˜æœ‰æ—¶é—´çš„è¯ï¼Œä½†æ˜¯ç²—ç²’åº¦çš„å¤„ç†ï¼Œå¯é€‰éƒ¨åˆ†çš„å¤„ç†ç²’åº¦å–å†³äºå‰©ä½™çš„æ—¶é—´ï¼Œä¸€æ¬¡åªèƒ½å¤„ç†å¯é€‰éƒ¨åˆ†çš„ä¸€ä¸ªå­é›†åŒºåŸŸã€‚åœ¨å®Œæˆå¯é€‰æ”¶é›†éƒ¨åˆ†çš„æ”¶é›†åï¼ŒG1 åƒåœ¾å›æ”¶å™¨å¯ä»¥æ ¹æ®å‰©ä½™æ—¶é—´å†³å®šæ˜¯å¦åœæ­¢æ”¶é›†ã€‚å¦‚æœåœ¨å¤„ç†å®Œ å¿…éœ€å¤„ç†çš„ éƒ¨åˆ†åï¼Œå±äºæ—¶é—´ä¸è¶³ï¼Œæ€»æ—¶é—´èŠ±é”€æ¥è¿‘é¢„æœŸæ—¶é—´ï¼ŒG1 åƒåœ¾å›æ”¶å™¨ä¹Ÿå¯ä»¥ä¸­æ­¢å¯é€‰éƒ¨åˆ†çš„å›æ”¶ä»¥è¾¾åˆ°æ»¡è¶³é¢„æœŸåœé¡¿æ—¶é—´çš„ç›®æ ‡ã€‚ Java12å¢å¼ºG1 åƒåœ¾æ”¶é›†å™¨ï¼šè‡ªåŠ¨è¿”å›æœªç”¨å †å†…å­˜ç»™æ“ä½œç³»ç»Ÿ Java 12 ä¸­å¢å¼ºäº† G1 åƒåœ¾æ”¶é›†å™¨å…³äºæ··åˆæ”¶é›†é›†åˆçš„å¤„ç†ç­–ç•¥ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨ç©ºé—²æ—¶è‡ªåŠ¨å°† Java å †å†…å­˜è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè¿™ä¹Ÿæ˜¯ Java 12 ä¸­çš„å¦å¤–ä¸€é¡¹é‡å¤§æ”¹è¿›ã€‚ ç›®å‰ Java 11 ç‰ˆæœ¬ä¸­åŒ…å«çš„ G1 åƒåœ¾æ”¶é›†å™¨ æš‚æ—¶æ— æ³•åŠæ—¶å°†å·²æäº¤çš„ Java å †å†…å­˜è¿”å›ç»™æ“ä½œç³»ç»Ÿï¼Œ G1 åƒåœ¾æ”¶é›†å™¨ä»…åœ¨è¿›è¡Œå®Œæ•´ GC (Full GC) æˆ–å¹¶å‘å¤„ç†å‘¨æœŸæ—¶æ‰èƒ½å°† Java å †è¿”å›å†…å­˜ã€‚ç”±äº G1 å›æ”¶å™¨å°½å¯èƒ½é¿å…å®Œæ•´ GCï¼Œå¹¶ä¸”åªè§¦å‘åŸºäº Java å †å ç”¨å’Œåˆ†é…æ´»åŠ¨çš„å¹¶å‘å‘¨æœŸï¼Œå› æ­¤åœ¨è®¸å¤šæƒ…å†µä¸‹ G 1 åƒåœ¾å›æ”¶å™¨ä¸èƒ½å›æ”¶ Java å †å†…å­˜ï¼Œé™¤éæœ‰å¤–éƒ¨å¼ºåˆ¶æ‰§è¡Œã€‚ åœ¨ä½¿ç”¨äº‘å¹³å°çš„å®¹å™¨ç¯å¢ƒä¸­ï¼Œè¿™ç§ä¸åˆ©ä¹‹å¤„ç‰¹åˆ«æ˜æ˜¾ã€‚å³ä½¿åœ¨è™šæ‹Ÿæœºä¸æ´»åŠ¨ï¼Œä½†å¦‚æœä»ç„¶ä½¿ç”¨å…¶åˆ†é…çš„å†…å­˜èµ„æºï¼Œå“ªæ€•æ˜¯å…¶ä¸­çš„ä¸€å°éƒ¨åˆ†ï¼ŒG1 å›æ”¶å™¨ä¹Ÿä»å°†ä¿ç•™æ‰€æœ‰å·²åˆ†é…çš„ Java å †å†…å­˜ã€‚è€Œè¿™å°†å¯¼è‡´ç”¨æˆ·éœ€è¦å§‹ç»ˆä¸ºæ‰€æœ‰èµ„æºä»˜è´¹ï¼Œå“ªæ€•æ˜¯å®é™…å¹¶æœªç”¨åˆ°ï¼Œè€Œäº‘æä¾›å•†ä¹Ÿæ— æ³•å……åˆ†åˆ©ç”¨å…¶ç¡¬ä»¶ã€‚å¦‚æœåœ¨æ¬¡æœŸé—´è™šæ‹Ÿæœºèƒ½å¤Ÿæ£€æµ‹åˆ° Java å †å†…å­˜çš„å®é™…ä½¿ç”¨æƒ…å†µï¼Œå¹¶åœ¨åˆ©ç”¨ç©ºé—²æ—¶é—´è‡ªåŠ¨å°† Java å †å†…å­˜è¿”è¿˜ï¼Œåˆ™ä¸¤è€…éƒ½å°†å—ç›Šã€‚ ä¸ºäº†å°½å¯èƒ½çš„å‘æ“ä½œç³»ç»Ÿè¿”å›ç©ºé—²å†…å­˜ï¼ŒG1 åƒåœ¾æ”¶é›†å™¨å°†åœ¨åº”ç”¨ç¨‹åºä¸æ´»åŠ¨æœŸé—´å®šæœŸç”Ÿæˆæˆ–æŒç»­å¾ªç¯æ£€æŸ¥æ•´ä½“ Java å †ä½¿ç”¨æƒ…å†µï¼Œä»¥ä¾¿ G 1 åƒåœ¾æ”¶é›†å™¨èƒ½å¤Ÿæ›´åŠæ—¶çš„å°† Java å †ä¸­ä¸ä½¿ç”¨å†…å­˜éƒ¨åˆ†è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚å¯¹äºé•¿æ—¶é—´å¤„äºç©ºé—²çŠ¶æ€çš„åº”ç”¨ç¨‹åºï¼Œæ­¤é¡¹æ”¹è¿›å°†ä½¿ JVM çš„å†…å­˜åˆ©ç”¨ç‡æ›´åŠ é«˜æ•ˆã€‚ å¦‚æœåº”ç”¨ç¨‹åºä¸ºéæ´»åŠ¨çŠ¶æ€ï¼Œåœ¨ä¸‹é¢ä¸¤ç§æƒ…å†µä¸‹ï¼ŒG1 å›æ”¶å™¨ä¼šè§¦å‘å®šæœŸåƒåœ¾æ”¶é›†ï¼š è‡ªä¸Šæ¬¡åƒåœ¾å›æ”¶å®Œæˆ ä»¥æ¥å·²è¶…è¿‡ G1PeriodicGCInterva l æ¯«ç§’ï¼Œ å¹¶ä¸”æ­¤æ—¶æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„åƒåœ¾å›æ”¶ä»»åŠ¡ã€‚å¦‚æœ G1PeriodicGCInterval å€¼ä¸ºé›¶è¡¨ç¤ºç¦ç”¨å¿«é€Ÿå›æ”¶å†…å­˜çš„å®šæœŸåƒåœ¾æ”¶é›†ã€‚ åº”ç”¨æ‰€åœ¨ä¸»æœºç³»ç»Ÿä¸Šæ‰§è¡Œæ–¹æ³• getloadavg()ï¼Œä¸€åˆ†é’Ÿå†…ç³»ç»Ÿè¿”å›çš„å¹³å‡è´Ÿè½½å€¼ä½äº G1PeriodicGCSystemLoadThresholdã€‚å¦‚æœ G1PeriodicGCSystemLoadThreshold å€¼ä¸ºé›¶ï¼Œåˆ™æ­¤æ¡ä»¶ä¸ç”Ÿæ•ˆã€‚ å¦‚æœä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œåˆ™å–æ¶ˆå½“æœŸçš„å®šæœŸåƒåœ¾å›æ”¶ã€‚ç­‰ä¸€ä¸ª G1PeriodicGCInterval æ—¶é—´å‘¨æœŸåï¼Œå°†é‡æ–°è€ƒè™‘æ˜¯å¦æ‰§è¡Œå®šæœŸåƒåœ¾å›æ”¶ã€‚ G1 å®šæœŸåƒåœ¾æ”¶é›†çš„ç±»å‹æ ¹æ® G1PeriodicGCInvokesConcurrent å‚æ•°çš„å€¼ç¡®å®šï¼šå¦‚æœè®¾ç½®å€¼äº†ï¼ŒG1 åƒåœ¾å›æ”¶å™¨å°†ç»§ç»­ä¸Šä¸€ä¸ªæˆ–è€…å¯åŠ¨ä¸€ä¸ªæ–°å¹¶å‘å‘¨æœŸï¼›å¦‚æœæ²¡æœ‰è®¾ç½®å€¼ï¼Œåˆ™ G1 å›æ”¶å™¨å°†æ‰§è¡Œä¸€ä¸ªå®Œæ•´çš„ GCã€‚åœ¨æ¯æ¬¡ä¸€æ¬¡ GC å›æ”¶æœ«å°¾ï¼ŒG1 å›æ”¶å™¨å°†è°ƒæ•´å½“å‰çš„ Java å †å¤§å°ï¼Œæ­¤æ—¶ä¾¿æœ‰å¯èƒ½ä¼šå°†æœªä½¿ç”¨å†…å­˜è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚æ–°çš„ Java å †å†…å­˜å¤§å°æ ¹æ®ç°æœ‰é…ç½®ç¡®å®šï¼Œå…·ä½“åŒ…æ‹¬ä¸‹åˆ—é…ç½®ï¼š- XX:MinHeapFreeRatioã€-XX:MaxHeapFreeRatioã€-Xmsã€-Xmxã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒG1 å›æ”¶å™¨åœ¨å®šæœŸåƒåœ¾å›æ”¶æœŸé—´æ–°å¯åŠ¨æˆ–ç»§ç»­ä¸Šä¸€è½®å¹¶å‘å‘¨æœŸï¼Œå°†æœ€å¤§é™åº¦åœ°å‡å°‘åº”ç”¨ç¨‹åºçš„ä¸­æ–­ã€‚å¦‚æœå®šæœŸåƒåœ¾æ”¶é›†ä¸¥é‡å½±å“ç¨‹åºæ‰§è¡Œï¼Œåˆ™éœ€è¦è€ƒè™‘æ•´ä¸ªç³»ç»Ÿ CPU è´Ÿè½½ï¼Œæˆ–è®©ç”¨æˆ·ç¦ç”¨å®šæœŸåƒåœ¾æ”¶é›†ã€‚ JDK13Java13å¢å¼ºZGCï¼šé‡Šæ”¾æœªä½¿ç”¨å†…å­˜ ZGC æ˜¯ Java 11 ä¸­å¼•å…¥çš„æœ€ä¸ºç©ç›®çš„åƒåœ¾å›æ”¶ç‰¹æ€§ï¼Œæ˜¯ä¸€ç§å¯ä¼¸ç¼©ã€ä½å»¶è¿Ÿçš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸è¿‡åœ¨ Java 11 ä¸­æ˜¯å®éªŒæ€§çš„å¼•å…¥ï¼Œä¸»è¦ç”¨æ¥æ”¹å–„ GC åœé¡¿æ—¶é—´ï¼Œå¹¶æ”¯æŒå‡ ç™¾ MB è‡³å‡ ä¸ª TB çº§åˆ«å¤§å°çš„å †ï¼Œå¹¶ä¸”åº”ç”¨ååèƒ½åŠ›ä¸‹é™ä¸ä¼šè¶…è¿‡ 15%ï¼Œç›®å‰åªæ”¯æŒ Linux/x64 ä½å¹³å°çš„è¿™æ ·ä¸€ç§æ–°å‹åƒåœ¾æ”¶é›†å™¨ã€‚ é€šè¿‡åœ¨å®é™…ä¸­çš„ä½¿ç”¨ï¼Œå‘ç° ZGC æ”¶é›†å™¨ä¸­å¹¶æ²¡æœ‰åƒ Hotspot ä¸­çš„ G1 å’Œ Shenandoah åƒåœ¾æ”¶é›†å™¨ä¸€æ ·ï¼Œèƒ½å¤Ÿä¸»åŠ¨å°†æœªä½¿ç”¨çš„å†…å­˜é‡Šæ”¾ç»™æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºæ¥è¯´ï¼ŒCPU å’Œå†…å­˜éƒ½å±äºæœ‰é™çš„ç´§ç¼ºèµ„æºï¼Œç‰¹åˆ«æ˜¯ç°åœ¨ä½¿ç”¨çš„äº‘ä¸Šæˆ–è€…è™šæ‹ŸåŒ–ç¯å¢ƒä¸­ã€‚å¦‚æœåº”ç”¨ç¨‹åºä¸­çš„å†…å­˜é•¿æœŸå¤„äºç©ºé—²çŠ¶æ€ï¼Œå¹¶ä¸”è¿˜ä¸èƒ½é‡Šæ”¾ç»™æ“ä½œç³»ç»Ÿï¼Œè¿™æ ·ä¼šå¯¼è‡´å…¶ä»–éœ€è¦å†…å­˜çš„åº”ç”¨æ— æ³•åˆ†é…åˆ°éœ€è¦çš„å†…å­˜ï¼Œè€Œè¿™è¾¹åº”ç”¨åˆ†é…çš„å†…å­˜è¿˜å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¤„äºâ€å¿™çš„å¤ªå¿™ï¼Œé—²çš„å¤ªé—²â€çš„éå…¬å¹³çŠ¶æ€ï¼Œå¹¶ä¸”ä¹Ÿå®¹æ˜“å¯¼è‡´åŸºäºè™šæ‹ŸåŒ–çš„ç¯å¢ƒä¸­ï¼Œå› ä¸ºè¿™äº›å®é™…å¹¶æœªä½¿ç”¨çš„èµ„æºè€Œå¤šä»˜è´¹çš„æƒ…å†µã€‚ç”±æ­¤å¯è§ï¼Œå°†æœªä½¿ç”¨å†…å­˜é‡Šæ”¾ç»™ç³»ç»Ÿä¸»å†…å­˜æ˜¯ä¸€é¡¹éå¸¸æœ‰ç”¨ä¸”äºŸéœ€çš„åŠŸèƒ½ã€‚ ZGC å †ç”±ä¸€ç»„ç§°ä¸º ZPages çš„å †åŒºåŸŸç»„æˆã€‚åœ¨ GC å‘¨æœŸä¸­æ¸…ç©º ZPages åŒºåŸŸæ—¶ï¼Œå®ƒä»¬å°†è¢«é‡Šæ”¾å¹¶è¿”å›åˆ°é¡µé¢ç¼“å­˜ ZPageCache ä¸­ï¼Œæ­¤ç¼“å­˜ä¸­çš„ ZPages æŒ‰æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆLRUï¼‰çš„é¡ºåºï¼Œå¹¶æŒ‰ç…§å¤§å°è¿›è¡Œç»„ç»‡ã€‚åœ¨ Java 13 ä¸­ï¼ŒZGC å°†å‘æ“ä½œç³»ç»Ÿè¿”å›è¢«æ ‡è¯†ä¸ºé•¿æ—¶é—´æœªä½¿ç”¨çš„é¡µé¢ï¼Œè¿™æ ·å®ƒä»¬å°†å¯ä»¥è¢«å…¶ä»–è¿›ç¨‹é‡ç”¨ã€‚åŒæ—¶é‡Šæ”¾è¿™äº›æœªä½¿ç”¨çš„å†…å­˜ç»™æ“ä½œç³»ç»Ÿä¸ä¼šå¯¼è‡´å †å¤§å°ç¼©å°åˆ°å‚æ•°è®¾ç½®çš„æœ€å°å¤§å°ä»¥ä¸‹ï¼Œå¦‚æœå°†æœ€å°å’Œæœ€å¤§å †å¤§å°è®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼Œåˆ™ä¸ä¼šé‡Šæ”¾ä»»ä½•å†…å­˜ç»™æ“ä½œç³»ç»Ÿã€‚ Java 13 ä¸­å¯¹ ZGC çš„æ”¹è¿›ï¼Œä¸»è¦ä½“ç°åœ¨ä¸‹é¢å‡ ç‚¹ï¼š é‡Šæ”¾æœªä½¿ç”¨å†…å­˜ç»™æ“ä½œç³»ç»Ÿ æ”¯æŒæœ€å¤§å †å¤§å°ä¸º 16TB æ·»åŠ å‚æ•°ï¼š-XX:SoftMaxHeapSize æ¥è½¯é™åˆ¶å †å¤§å° è¿™é‡Œæåˆ°çš„æ˜¯è½¯é™åˆ¶å †å¤§å°ï¼Œæ˜¯æŒ‡ GC åº”åŠªåŠ›æ˜¯å †å¤§å°ä¸è¦è¶…è¿‡æŒ‡å®šå¤§å°ï¼Œä½†æ˜¯å¦‚æœå®é™…éœ€è¦ï¼Œä¹Ÿè¿˜æ˜¯å…è®¸ GC å°†å †å¤§å°å¢åŠ åˆ°è¶…è¿‡ SoftMaxHeapSize æŒ‡å®šå€¼ã€‚ä¸»è¦ç”¨åœ¨ä¸‹é¢å‡ ç§æƒ…å†µï¼šå½“å¸Œæœ›é™ä½å †å ç”¨ï¼ŒåŒæ—¶ä¿æŒåº”å¯¹å †ç©ºé—´ä¸´æ—¶å¢åŠ çš„èƒ½åŠ›ï¼Œäº¦æˆ–æƒ³ä¿ç•™å……è¶³å†…å­˜ç©ºé—´ï¼Œä»¥èƒ½å¤Ÿåº”å¯¹å†…å­˜åˆ†é…ï¼Œè€Œä¸ä¼šå› ä¸ºå†…å­˜åˆ†é…æ„å¤–å¢åŠ è€Œé™·å…¥åˆ†é…åœæ»çŠ¶æ€ã€‚ä¸åº”å°† SoftMaxHeapSize è®¾ç½®ä¸ºå¤§äºæœ€å¤§å †å¤§å°ï¼ˆ-Xmx çš„å€¼ï¼Œå¦‚æœæœªåœ¨å‘½ä»¤è¡Œä¸Šè®¾ç½®ï¼Œåˆ™æ­¤æ ‡å¿—åº”é»˜è®¤ä¸ºæœ€å¤§å †å¤§å°ã€‚ Java 13 ä¸­ï¼ŒZGC å†…å­˜é‡Šæ”¾åŠŸèƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯å¼€å¯çš„ï¼Œä¸è¿‡å¯ä»¥ä½¿ç”¨å‚æ•°ï¼š-XXï¼š-ZUncommit æ˜¾å¼å…³é—­ï¼ŒåŒæ—¶å¦‚æœå°†æœ€å°å †å¤§å° (-Xms) é…ç½®ä¸ºç­‰äºæœ€å¤§å †å¤§å° (-Xmx)ï¼Œåˆ™å°†éšå¼ç¦ç”¨æ­¤åŠŸèƒ½ã€‚ è¿˜å¯ä»¥ä½¿ç”¨å‚æ•°ï¼š-XXï¼šZUncommitDelay = ï¼ˆé»˜è®¤å€¼ä¸º 300 ç§’ï¼‰æ¥é…ç½®å»¶è¿Ÿé‡Šæ”¾ï¼Œæ­¤å»¶è¿Ÿæ—¶é—´å¯ä»¥æŒ‡å®šé‡Šæ”¾å¤šé•¿æ—¶é—´ä¹‹å‰æœªä½¿ç”¨çš„å†…å­˜ã€‚ JDK14æ„Ÿè§‰å˜åŒ–ä¸å¤§ã€‚ åŠ å…¥äº†javaæ‰“åŒ…å·¥å…·jpackageçš„é¢„è§ˆç‰ˆã€‚ åŠ å…¥äº†ç±»ä¼¼kotlinä¸­çš„data objectçš„æ•°æ®ç±»å‹ï¼šè®°å½•Recordï¼ˆhttps://openjdk.java.net/jeps/359ï¼‰ï¼š record Point(int x, int y) { } å‚è§ï¼šhttps://www.infoworld.com/article/3436795/jdk-14-the-new-features-in-java-14.html JDK15ZGCå°†ä»å®éªŒåŠŸèƒ½å‡çº§ä¸ºäº§å“ã€‚ZGCå·²é›†æˆåˆ°2018å¹´9æœˆå‘å¸ƒçš„JDK 11ä¸­ï¼Œæ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„ä½å»¶è¿Ÿåƒåœ¾å›æ”¶å™¨ã€‚å¼•å…¥ZGCæ˜¯ä¸€é¡¹å®éªŒåŠŸèƒ½ï¼Œå› ä¸ºJavaçš„å¼€å‘äººå‘˜å†³å®šåº”è°¨æ…è€Œé€æ­¥åœ°å¼•å…¥è¿™ç§å¤§å°å’Œå¤æ‚æ€§çš„åŠŸèƒ½ã€‚ä»é‚£æ—¶èµ·ï¼Œå·²ç»æ·»åŠ äº†è®¸å¤šæ”¹è¿›ï¼Œä»å¹¶å‘ç±»å¸è½½ï¼Œæœªä½¿ç”¨å†…å­˜çš„æœªæäº¤ï¼Œå¯¹æ•°æ®ç±»å…±äº«çš„æ”¯æŒåˆ°æ”¹è¿›çš„NUMAæ„ŸçŸ¥å’Œå¤šçº¿ç¨‹å †é¢„è§¦ã€‚æ­¤å¤–ï¼Œæœ€å¤§å †å¤§å°å·²ä»4 TBå¢åŠ åˆ°16 TBã€‚æ”¯æŒçš„å¹³å°åŒ…æ‹¬Linuxï¼ŒWindowså’ŒMacOSã€‚ åŒæ ·çš„ï¼Œè¿˜æœ‰Shenandoah GCã€‚ å‚è§ï¼šhttps://www.infoworld.com/article/3534133/jdk-15-the-new-features-in-java-15.html JDK161ï¼‰æœ€å¤§çš„å˜åŒ–å°±æ˜¯å¼•å…¥Recordï¼ŒRecords å°±æ˜¯ä¸€ç§æ–°çš„è¯­æ³•ç³–ï¼Œç›®çš„è¿˜æ˜¯ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œåœ¨ JDK 14 ä¸­é¦–æ¬¡æˆä¸ºé¢„è§ˆç‰¹æ€§ï¼Œåœ¨ JDK 16 ä¸­æ­£å¼è½¬æ­£ã€‚ç†Ÿæ‚‰kotlinçš„åŒå­¦ï¼Œå¯ä»¥çœ‹åšæ˜¯data objectç±»ã€‚ Records å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…ä½çº§å†—ä½™çš„ä»£ç ï¼Œæ¯”å¦‚ï¼šconstructors, getters, equals(), hashCode(), toString() æ–¹æ³•ç­‰ï¼Œç›¸å½“äº Lombok çš„ @Data æ³¨è§£ï¼Œä½†åˆä¸èƒ½å®Œå…¨æ›¿ä»£ã€‚ ä¸‹é¢æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼š Plain Text public record Student(String name, int id, int age) {} è¿™æ ·å°±å®Œæˆ å®Œæˆäº†æ•´ä¸ªpojoç±»çš„å®šä¹‰ã€‚ 2ï¼‰JDK16 å°†æä¾›ä¸€æ¬¾åä¸º jpackage çš„å·¥å…·ï¼Œç”¨äºç‹¬ç«‹æ‰“åŒ… Java åº”ç”¨ç¨‹åºã€‚ jpackage åœ¨ JDK 14 ä¸­è¢«ä½œä¸ºå­µåŒ–å·¥å…·å¼•å…¥ï¼Œå¹¶åœ¨ JDK 15 ä¸­ä»å¤„äºå­µåŒ–é˜¶æ®µã€‚åˆ°äº†JDK 16ï¼Œjpackage å°†æŠ•å…¥ç”Ÿäº§ï¼Œæ”¯æŒæœ¬åœ°çš„è½¯ä»¶åŒ…æ ¼å¼ï¼Œä»è€Œä¸ºç”¨æˆ·æä¾›è‡ªç„¶çš„å®‰è£…ä½“éªŒï¼Œå¹¶å…è®¸åœ¨æ‰“åŒ…æ—¶æŒ‡å®šå¯åŠ¨æ—¶å‚æ•°ã€‚æ”¯æŒçš„æ ¼å¼åŒ…æ‹¬ Windows ä¸Šçš„ msi å’Œ exe ï¼ŒMacOS ä¸Šçš„ pkg å’Œ dmg ä»¥åŠ Linux ä¸Šçš„ deb å’Œ rpm ã€‚è¯¥å·¥å…·å¯ä»¥ç›´æ¥ä»å‘½ä»¤è¡Œæˆ–ä»¥ç¼–ç¨‹æ–¹å¼è°ƒç”¨ã€‚æ–°çš„æ‰“åŒ…å·¥å…·è§£å†³äº†è¿™æ ·ä¸€ç§æƒ…å†µï¼šè®¸å¤šJavaåº”ç”¨ç¨‹åºéœ€è¦ä»¥å…¨å±€å¯ç”¨çš„æ–¹å¼å®‰è£…åœ¨æœ¬æœºå¹³å°ä¸Šï¼Œè€Œä¸æ˜¯ç®€å•åœ°æ”¾ç½®åœ¨ç±»è·¯å¾„æˆ–æ¨¡å—è·¯å¾„ä¸Šã€‚å› æ­¤æä¾›é€‚åˆæœ¬æœºå¹³å°çš„å¯å®‰è£…è½¯ä»¶åŒ…éå¸¸æœ‰å¿…è¦ã€‚ å‚è§ï¼šhttps://www.infoworld.com/article/3569150/jdk-16-the-new-features-in-java-16.html 3ï¼‰Pattern Matching for instanceof æ¨¡å¼åŒ¹é… for instanceofï¼Œç›¸å½“äºæ˜¯å¢å¼ºçš„ instanceofï¼Œåœ¨ JDK 14 ä¸­é¦–æ¬¡æˆä¸ºé¢„è§ˆç‰¹æ€§ï¼Œåœ¨ JDK 16 ä¸­æ­£å¼è½¬æ­£ã€‚ æ¨¡å¼åŒ¹é…çš„åˆ°æ¥å°†ä½¿å¾— instanceof å˜å¾—æ›´ç®€æ´ã€æ›´å®‰å…¨ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Œè¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ã€‚ æ­£å¸¸çš„ instanceof å†™æ³•ï¼š Plain Text if (object instanceof Kid) { Kid kid = (Kid) object; // â€¦ } else if (object instanceof Kiddle) { Kid kid = (Kid) object; // â€¦ } æ¨¡å¼åŒ¹é…çš„ instanceof å†™æ³•ï¼š Plain Text if (object instanceof Kid kid) { // â€¦ } else if (object instanceof Kiddle kiddle) { // â€¦ } æ­¤å¤–ï¼Œè¿˜æŠŠopenjdkæºç è¿ç§»åˆ°äº†githubã€‚ å‚è§ï¼šhttps://www.cnblogs.com/javastack/p/14583578.html JDK171ï¼‰å¢å¼ºäº†ä¼ªéšæœºæ•°ç®—æ³•ã€‚ 2ï¼‰ç§»é™¤AOTæå‰ç¼–è¯‘å’ŒJITå³æ—¶ç¼–è¯‘çš„åŠŸèƒ½ï¼ŒOracle JDK16 æœªåŒ…å«æ­¤åŠŸèƒ½ã€‚ 3ï¼‰sealedä¿®é¥°çš„ç±»å’Œæ¥å£é™åˆ¶å…¶ä»–çš„ç±»æˆ–è€…æ¥å£çš„æ‰©å±•å’Œå®ç°ã€‚è¯´ç™½äº†å°±æ˜¯é™åˆ¶ç±»çš„ç»§æ‰¿æˆ–è€…æ¥å£çš„å®ç°æ•°é‡ã€‚ 4ï¼‰è¿›ä¸€æ­¥å¢å¼ºäº†switchè¯­æ³•çš„æ¨¡å¼åŒ¹é…ï¼Œä¸‡ç‰©çš†å¯switchä¸‹ä½¿ç”¨äº†ã€‚ æ­¤ç‰ˆæœ¬çš„å˜åŒ–è¾ƒå°ã€‚ 6.3 JDKç‰ˆæœ¬æœºåˆ¶Oracle Java å¹³å°ç»„çš„é¦–å¸­æ¶æ„å¸ˆ Mark Reinhold åœ¨åšå®¢ä¸Šä»‹ç»äº†æœ‰å…³ Java æœªæ¥ç‰ˆæœ¬çš„ä¸€äº›æƒ³æ³•ï¼ˆä½ èƒ½æ¥å— Java 9 çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ˜¯ Java 18.3 å—ï¼Ÿï¼‰ã€‚ä»–æåˆ°ï¼ŒJava è®¡åˆ’æŒ‰ç…§æ—¶é—´æ¥å‘å¸ƒï¼Œæ¯åŠå¹´ä¸€ä¸ªç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯åƒä¹‹å‰é‚£æ ·æŒ‰ç…§é‡è¦ç‰¹æ€§æ¥ç¡®å®šå¤§ç‰ˆæœ¬ï¼Œå¦‚æœæŸä¸ªå¤§çš„ç‰¹æ€§å› æ•…å»¶æœŸï¼Œè¿™ä¸ªç‰ˆæœ¬å¯èƒ½ä¸€æ‹–å†æ‹–ã€‚ å½“æ—¶ï¼ŒMark ä¹Ÿæå‡ºæ¥ä¸€ç§åŸºäºæ—¶é—´å‘½åç‰ˆæœ¬å·çš„æœºåˆ¶ï¼Œæ¯”å¦‚ä¸‹ä¸€ä¸ªå°†äº 2018 å¹´ 3 æœˆå‘å¸ƒçš„ç‰ˆæœ¬ï¼Œå°±æ˜¯ 18.3ï¼Œå†ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ˜¯ 18.9ï¼Œä»¥åç‰ˆæœ¬ä¾æ­¤ç±»æ¨ã€‚ ä¸è¿‡ç»è¿‡è®¨è®ºï¼Œè€ƒè™‘å’Œä¹‹å‰ç‰ˆæœ¬å·çš„å…¼å®¹ç­‰é—®é¢˜ï¼Œæœ€ç»ˆé€‰æ‹©çš„å‘½åæœºåˆ¶æ˜¯ï¼š $FEATURE.$INTERIM.$UPDATE.$PATCH $FEATUREï¼Œæ¯æ¬¡ç‰ˆæœ¬å‘å¸ƒåŠ  1ï¼Œä¸è€ƒè™‘å…·ä½“çš„ç‰ˆæœ¬å†…å®¹ã€‚2018 å¹´ 3 æœˆçš„ç‰ˆæœ¬æ˜¯ JDK 10ï¼Œ9 æœˆçš„ç‰ˆæœ¬æ˜¯ JDK 11ï¼Œä¾æ­¤ç±»æ¨ã€‚ $INTERIMï¼Œä¸­é—´ç‰ˆæœ¬å·ï¼Œåœ¨å¤§ç‰ˆæœ¬ä¸­é—´å‘å¸ƒçš„ï¼ŒåŒ…å«é—®é¢˜ä¿®å¤å’Œå¢å¼ºçš„ç‰ˆæœ¬ï¼Œä¸ä¼šå¼•å…¥éå…¼å®¹æ€§ä¿®æ”¹ã€‚ ç›®å‰JDKæ¯åŠå¹´å‡ä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼Œå…¶ä¸­JDK8å’Œ11æ˜¯LTSé•¿æœŸç»´æŠ¤ç‰ˆæœ¬ï¼Œ8çš„ç»´æŠ¤å‘¨æœŸé¢„è®¡æ¯”11è¿˜è¦é•¿ã€‚ä¸‹ä¸€ä¸ªå¯èƒ½æ˜¯JDK17ï¼ˆå¤§æ¦‚ä¼šåœ¨2021å¹´çš„Q3å‘å¸ƒï¼‰ã€‚æœŸæœ›8ä»¥åï¼Œå¤§å®¶ç›´æ¥å‡çº§åˆ°17ã€‚ æ¯å…­ä¸ªæœˆå‘å¸ƒä¸€ä¸ªå¤§æ›´æ–°ï¼ˆå°±æ˜¯æ¯å¹´çš„3æœˆè¿˜æœ‰9æœˆï¼‰ å¯¹äºæ¯ä¸ªå¤§ç‰ˆæœ¬æ›´æ–°ï¼Œä¼šæœ‰ä¸¤æ¬¡å°ç‰ˆæœ¬æ›´æ–°ï¼ˆåœ¨å‘å¸ƒåä¸€ä¸ªæœˆæˆ–è€…å››ä¸ªæœˆä¹‹åï¼‰ OpenJDKå·²å¯ä»¥ä½œä¸ºæ–°çš„çº¿ä¸Šæ ‡å‡†JDK åœ¨2018.9ä¹‹å‰ï¼ŒOracle JDKæ˜¯å¤§å®¶æ™®éè¿ç”¨äºçº¿ä¸Šçš„JDKï¼ŒOpenJDKçš„ç‰¹æ€§å¹¶ä¸å®Œå…¨ï¼Œå¹¶ä¸”Oracle JDKå·ç§°åšäº†å¾ˆå¤šä¼˜åŒ–ã€‚åœ¨2018.9ä¹‹åï¼ŒOracle JDKæ­£å¼å•†ç”¨ï¼ˆå¼€å‘ä¸æ”¶è´¹ï¼Œä½†æ˜¯è¿è¡Œçº¿ä¸Šä¸šåŠ¡æ”¶è´¹ï¼‰ã€‚ä½†æ˜¯ä¸æ­¤åŒæ—¶ï¼ŒOracleå®£å¸ƒï¼ŒOpenJDKä¸Oracle JDKåœ¨åŠŸèƒ½ä¸Šä¸ä¼šæœ‰åŒºåˆ«ã€‚å¹¶ä¸”ï¼ŒOpenJDK 11 RTSå°†ä¼šç”±çº¢å¸½ç¤¾åŒºè¿›è¡Œç»´æŠ¤ã€‚è¿™æ ·ï¼Œæ›´åŠ å¢åŠ äº†å¯é æ€§ä¸ä¿è¯é—®é¢˜çš„åŠæ—¶è§£å†³ã€‚ 2021-9-15 JDK17å‘å¸ƒçš„åŒæ—¶ï¼ŒOracle JDKå®£å¸ƒå…è´¹ã€‚ 6.4 Oracleå…è´¹JDKOracle JDKæ”¶è´¹ä¸€ç›´è¢«å¥½å¤šäººåæ§½ï¼Œè¿™æ¬¡æ˜¯æ¨å‡ºäº†Free Java License å¤§è‡´æ‘˜è¦ï¼š Oracle é•¿åœ¨å…è´¹æä¾›JDKï¼ŒåŒ…æ‹¬æ‰€æœ‰å­£åº¦å®‰å…¨æ›´æ–°ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬å•†ä¸šå’Œç”Ÿäº§ç”¨é€”ã€‚ æœ¬æ¬¡Oracle JDKè®¸å¯è¯å…è®¸æ‰€æœ‰ç”¨æˆ·å…è´¹ä½¿ç”¨ï¼Œå†åˆ†å‘ä¹Ÿå…è®¸ï¼› ç¨‹åºå‘˜å’Œä¼ä¸šç°åœ¨æ— éœ€ç‚¹å‡»å³å¯è½»æ¾ä¸‹è½½ã€ä½¿ç”¨ã€å…±äº«å’Œé‡æ–°åˆ†å‘ Oracle JDKã€‚ Oracle å°†ä»Oracle JDK 17å¼€å§‹æä¾›è¿™äº›å…è´¹ç‰ˆæœ¬å’Œæ›´æ–°ï¼Œå¹¶åœ¨ä¸‹ä¸€ä¸ª LTS ç‰ˆæœ¬ä¹‹åç»§ç»­æä¾›æ•´æ•´ä¸€å¹´ã€‚ä»¥å‰çš„ç‰ˆæœ¬ä¸å—æ­¤æ›´æ”¹çš„å½±å“ã€‚ Oracle å°†ç»§ç»­æŒ‰ç…§è‡ª Java 9 ä»¥æ¥çš„ç›¸åŒç‰ˆæœ¬å’Œæ—¶é—´è¡¨æä¾›GPLä¸‹çš„Oracle OpenJDK ç‰ˆæœ¬ã€‚ è§£é‡Šä¸€ä¸‹ç›®å‰åœ¨å…è´¹è®¸å¯è¯ä¸‹å¯ä»¥å•†ç”¨ï¼Œå…¶æ¬¡å°±æ˜¯Springä¹Ÿå®˜å®£äº†ï¼Œæ˜å¹´å‘å¸ƒçš„Spring framework 6 å’ŒSpring Boot 3 éƒ½å°†åŸºäºJAVA 17ï¼Œå¤§å®¶è¿˜è¦åšå®ˆJava8å—ï¼Ÿ","link":"/2021/03/02/JVM/"},{"title":"grpc","text":"â€¦ gRPCproject address: https://github.com/grpc/grpc-java","link":"/2021/11/01/grpc/"},{"title":"â˜ï¸ æˆ‘çš„ç½‘æ˜“äº‘æ­Œå• â˜ï¸","text":"","link":"/2021/02/26/music/"},{"title":"mysqlé›†ç¾¤","text":"â€¦ MYSQL1. Cluster é›†ç¾¤MySQL é›†ç¾¤æ–¹æ¡ˆä¸»è¦æœ‰ä¸‹è¿°å‡ ç§ï¼š å¸¸ç”¨çš„æœ‰Replicationsï¼Œå³æ‰€è°“çš„**è¯»å†™åˆ†ç¦»(ä¸€ä¸»å¤šä»master+slavesæœºåˆ¶)**ï¼›è€ŒMySQL Cluster ä¸ºå®˜æ–¹æ¨å´‡çš„æ–¹æ¡ˆã€‚ä¸å¸¸è§çš„InnoBDä¸åŒï¼Œä½¿ç”¨çš„æ˜¯NDBå¼•æ“ã€‚å½“éœ€è¦åšåˆ†ç‰‡çš„æ—¶å€™ï¼ŒInnoDBæ˜¯ä¸æ»¡è¶³æ¡ä»¶çš„ã€‚ MySQL Cluster è§£å†³äº†ä¸»ä»çš„è®¸å¤šé—®é¢˜ã€‚æ¯”å¦‚æœ€ä¸ºä¸¥é‡çš„æ•°æ®ä¸ä¸€è‡´æƒ…å†µ(å¼‚æ­¥å¤åˆ¶çš„ç¼ºé™·)ã€‚æ•…éšœæ¢å¤ï¼ˆç”±NDBç®¡ç†èŠ‚ç‚¹æ§åˆ¶ï¼‰ç­‰ã€‚ 1.1 Replications(è¯»å†™åˆ†ç¦»)æ­å»ºtodo ?? ç›¸å…³å‘½ä»¤SHOW SLAVE STATUS è¯»åº“å»¶è¿Ÿé—®é¢˜çš„å¤„ç†æ•°æ®åœ¨masterä¸»åº“æ›´æ–°æˆåŠŸåï¼Œå†é€šè¿‡binlogå¼‚æ­¥å¤åˆ¶åˆ°slavesä¸Šã€‚è€Œè¿™ä¸ªè¿‡ç¨‹æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œå¯èƒ½å¯¼è‡´è¯»å‡ºæ¥çš„æ•°æ®ä¸æ˜¯æœ€æ–°çš„ã€‚ è§£å†³æ–¹æ³•ï¼šå†™æ“ä½œè¯­å¥å¹¶åšäº‹åŠ¡æäº¤(@Transational)ã€‚ ä¸»ä»åˆ‡æ¢çš„å¤„ç†masteræ„å¤–æŒ‚æ‰åï¼Œéœ€è¦å…¶ä¸­ä¸€ä¸ªslaveæ¥åšæ–°çš„masterï¼Œå³failover(æ•…éšœåˆ‡æ¢)ã€‚è¯¥è¿‡ç¨‹å­˜åœ¨ä¸€å®šé£é™©ï¼Œå› ä¸ºå¼‚æ­¥å¤åˆ¶çš„å»¶è¿Ÿæ€§ï¼Œå¯èƒ½å¯¼è‡´æ–°masterçš„æ•°æ®ä¸å®Œæ•´ã€‚ è§£å†³æ–¹æ³•ï¼šåŠåŒæ­¥ã€‚å³masteråšäº‹åŠ¡æäº¤å‰ï¼Œéœ€è¦è‡³å°‘ä¸€ä¸ªslave ACK(é€šçŸ¥)masteræ•°æ®å·²æˆåŠŸå¤åˆ¶ã€‚å†äººå·¥(DBM)æ‰¾åˆ°æœ‰æœ€æ–°binlogçš„slaveï¼Œå¹¶é…ç½®ä¸ºæ–°çš„masterã€‚ä½†æ˜¯å½“å‡ºç°ä¸‹å›¾çš„æƒ…å†µï¼Œå³masteræ¥ä¸åŠæ”¶åˆ°ackå¯¼è‡´æ²¡æœ‰æäº¤äº‹åŠ¡ï¼Œå°±ä¼šäº§ç”Ÿslaveçš„æ•°æ®æ¯”masterå¤šçš„æƒ…å†µ(ä¼¼ä¹ä¹Ÿæ²¡æœ‰åå¤„)ã€‚è™½ç„¶å¯ä»¥é€šè¿‡TCCæ¥è§£å†³ï¼Œä½†æ˜¯ç”±äºæ€§èƒ½è€ƒé‡æ•…åªèƒ½ç”¨åŠåŒæ­¥çš„æ–¹æ¡ˆæŠ˜ä¸­è§£å†³ã€‚ 1.2 PXC Percona XtraDB Cluster, ä¸ MySQL Cluster åŠŸèƒ½ç›¸ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯InnoDBå¼•æ“ã€‚ä¸¤è€…å¯¹æ¯”ä½¿ç”¨è€…ï¼šå¾®è½¯ï¼ŒIBMå®˜ç½‘åœ°å€ï¼šhttps://www.percona.com æ­å»ºåˆ›å»º docker é€šä¿¡ç½‘ç»œï¼Œå¯ç”¨ docker inpect æŸ¥è¯¢ç½‘ç»œå…·ä½“ä¿¡æ¯(IPAM) 1docker network create --subnet=172.18.0.0/24 pxc-net ç”±äºæ— æ³•æ˜ å°„ç›®å½•ï¼Œæ•…åœ¨ä¸»æœºä¸Šåˆ›å»º docker volumeç›®å½• 123docker volume create v1docker volume create v2docker volume create v3 https://hub.docker.com/r/percona/percona-xtradb-cluster/ 12docker pull percona/percona-xtradb-cluster-operatordocker tag percona/percona-xtradb-cluster-operator pxc è¿è¡Œ mysql èŠ‚ç‚¹ (æ³¨æ„è¦ç­‰å¾…è¿è¡Œå®Œæˆåï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚) 1docker run -d -p 3306:3306 -v v1:/var/lib/mysql -e MYSQL_ROOOT_PASSWORD=123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=123456 --privileged --name=node1 --net=pxc-net --ip 172.18.0.2 pxc 1docker run -d -p 3307:3306 -v v2:/var/lib/mysql -e MYSQL_ROOOT_PASSWORD=123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=123456 -e CLUSTER_JOIN=node1 --privileged --name=node2 --net=pxc-net --ip 172.18.0.3 pxc 1docker run -d -p 3308:3306 -v v3:/var/lib/mysql -e MYSQL_ROOOT_PASSWORD=123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=123456 -e CLUSTER_JOIN=node1 --privileged --name=node3 --net=pxc-net --ip 172.18.0.4 pxc æ•°æ®åº“è´Ÿè½½å‡è¡¡ ä½¿ç”¨ Haproxy ä»“åº“åœ°å€ï¼šhttps://hub.docker.com/_/haproxy é…ç½®ä»‹ç»ï¼šhttps://zhangge.net/5125.html ä½¿ç”¨ MySQL-Proxy/Router 2. mysql å¸¸è§é—®é¢˜2.1 å¤‡ä»½ mysql dump å‘½ä»¤ï¼šç±»ä¼¼redisçš„rdbæœºåˆ¶ï¼Œå…¨é‡å¤‡ä»½ã€‚æ— æ³•åƒaosä¸€æ ·å¢é‡å¤‡ä»½ XtraBackup æœ€ä½³çš„å¤‡ä»½æ–¹æ³•ï¼šç¬¬ä¸€æ¬¡å¤‡ä»½ä½¿ç”¨å…¨é‡å¤‡ä»½ï¼Œå†ä½¿ç”¨å¢é‡å¤‡ä»½ã€‚ è¿›å…¥å®¹å™¨å†…éƒ¨å®‰è£… xtrabackupï¼šapt-get install percona-xtrabackup-24å®‰è£…å®Œæˆåï¼Œæ‰§è¡Œå…¨é‡å¤‡ä»½ï¼šinnobackupex --user=root --password=123456 /data/backup/full æ¢å¤å¤‡ä»½ï¼š å›æ»šæœªæäº¤çš„äº‹åŠ¡ï¼šinnobackupex --user=root --password=123456 --apply-back /data/backup/full æ¢å¤å¤‡ä»½ï¼šinnobackupex --user=root --password=123456 --copy-back /data/backup/full 3. ä¸»ä»æ­å»º bin_logï¼šmysql-binlogæ˜¯MySQLæ•°æ®åº“çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼Œç”¨äºè®°å½•ç”¨æˆ·å¯¹æ•°æ®åº“æ“ä½œçš„SQLè¯­å¥ï¼ˆé™¤äº†selectè¯­å¥ï¼‰ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨mysqlbinå‘½ä»¤æŸ¥çœ‹äºŒè¿›åˆ¶æ—¥å¿—çš„å†…å®¹ã€‚ binary log æ ¼å¼ï¼š 4. æ•°æ®åˆ†ç‰‡ A å›ºå®šè·¯ç”±ä½ï¼šä»¥ userId (hash + mod) ä¸ºç»´åº¦åˆ†ç‰‡ï¼Œæ‰æ–¹ä¾¿åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚ä»¥ orderId ä¸ºç»´åº¦ï¼Œåˆ™éœ€è¦èšåˆå¤šä¸ªä¸åŒåº“ä¹‹é—´çš„æ•°æ®ã€‚ B æ—¶é—´è‡ªå¢åˆ†ç‰‡ï¼šå¦‚ ä¸€å¹´ å†…è®¢å•æ•°æ®ã€‚ èšåˆæ•°æ®å¤„ç†ï¼š","link":"/2021/10/29/mysql%E9%9B%86%E7%BE%A4/"},{"title":"javaå¼€å‘æ‰‹å†Œ","text":"â€¦ ç¬¬ 1 ç«  ç¼–ç¨‹è§„çº¦1.1 å‘½åé£æ ¼ POJO ä¸­çš„ Boolean å˜é‡éƒ½ä¸è¦åŠ  is å‰ç¼€ï¼Œå¦åˆ™éƒ¨åˆ†æ¡†æ¶ï¼ˆå¦‚ RPCï¼‰è§£æä¼šå¼•èµ·åºåˆ—åŒ–é”™è¯¯ã€‚ åä¾‹ï¼šå¦‚ Boolean isDeleted RPC æ¡†æ¶åå‘è§£æçš„æ—¶å€™ï¼Œä¼šè¯†åˆ«ä¸º deletedï¼Œå¯¼è‡´å±æ€§è·å–ä¸åˆ°æŠ›å‡ºå¼‚å¸¸ã€‚ æ¥å£ç±»ä¸­çš„æ–¹æ³•å’Œå±æ€§ä¸è¦åŠ ä»»ä½•ä¿®é¥°ç¬¦å·ï¼ˆpublic ä¹Ÿä¸è¦åŠ ï¼‰ï¼Œä¿æŒä»£ç ç®€æ´ï¼Œå¹¶åŠ ä¸Šæœ‰æ•ˆçš„ Javadoc æ³¨é‡Šã€‚å°½é‡ä¸è¦åœ¨æ¥å£ä¸­å®šä¹‰å˜é‡ï¼Œé™¤éæ˜¯å¸¸é‡ã€‚ æ­£ä¾‹ï¼šæ–¹æ³•ç­¾åï¼švoid commit() åŸºç¡€å¸¸é‡ï¼šString COMPANY = &quot;alibaba&quot; æšä¸¾ç±»åå»ºè®®å¸¦ä¸Š Enum åç¼€ï¼Œæšä¸¾æˆå‘˜åç§°éœ€è¦å…¨å¤§å†™ï¼Œå•è¯é—´ç”¨ä¸‹åˆ’çº¿éš”å¼€ã€‚ è¯´æ˜ï¼šæšä¸¾å…¶å®å°±æ˜¯ç‰¹æ®Šçš„å¸¸é‡ç±»ï¼Œä¸”æ„é€ æ–¹æ³•è¢«é»˜è®¤å¼ºåˆ¶ä¸ºç§æœ‰ã€‚æ­£ä¾‹ï¼šæšä¸¾ç±»åä¸º ProcessStatusEnumï¼Œæˆå‘˜åç§°æœ‰ SUCCESS / UNKNOW_REASON å„å±‚å‘½åè§„çº¦ï¼š 1). Service / DAO å±‚ method å‘½åè§„çº¦ï¼š a. è·å–å•ä¸ªå¯¹è±¡çš„æ–¹æ³•ç”¨ get ä½œä¸ºå‰ç¼€b. è·å–å¤šä¸ªå¯¹è±¡çš„æ–¹æ³•ç”¨ list ä½œä¸ºå‰ç¼€c. æ’å…¥çš„æ–¹æ³•ç”¨ save / insert ä½œä¸ºå‰ç¼€d. åˆ é™¤çš„æ–¹æ³•ç”¨ remove / delete ä½œä¸ºå‰ç¼€e. ä¿®æ”¹çš„æ–¹æ³•ç”¨ update ä½œä¸ºå‰ç¼€f. è·å–ç»Ÿè®¡å€¼çš„æ–¹æ³•ç”¨ count ä½œä¸ºå‰ç¼€ 2). é¢†åŸŸæ¨¡å‹å‘½åè§„çº¦ï¼š a. æ•°æ®å¯¹è±¡ï¼šxxxDOï¼Œxxx ä¸ºæ•°æ®åº“è¡¨åã€‚b. æ•°æ®ä¼ è¾“å¯¹è±¡ï¼šxxxDTOï¼Œxxx ä¸ºä¸šåŠ¡é¢†åŸŸç›¸å…³çš„åç§°ã€‚c. å±•ç¤ºå¯¹è±¡ï¼šxxxVOï¼Œxxx ä¸€èˆ¬ä¸ºç½‘é¡µåç§°ã€‚d. POJO æ˜¯ DO/DTO/BO/VO çš„ç»Ÿç§°ï¼Œç¦æ­¢å‘½åæˆ xxxPOJOã€‚ 1.2 å¸¸é‡å®šä¹‰ ä¸å…è®¸ä»»ä½•é­”æ³•å€¼ï¼ˆå³æœªç»é¢„å…ˆå®šä¹‰çš„å¸¸é‡ï¼‰ç›´æ¥å‡ºç°åœ¨ä»£ç ä¸­ã€‚ åä¾‹ï¼š 12String key = &quot;Id#taobao_&quot; + tradeId; # &quot;Id#taobao&quot; åº”è¯¥å®šä¹‰ä¸ºå¸¸é‡ã€‚catch.put(key, value); å¦‚æœå˜é‡å€¼ä»…åœ¨ä¸€ä¸ªèŒƒå›´å†…å˜åŒ–ï¼Œåˆ™ç”¨ enum ç±»å‹æ¥å®šä¹‰ã€‚ æ­£ä¾‹ï¼š 1234567pubilc enum SeasonEnum { SPRING(1), SUMMER(2), AUTUMN(3), WINTER(4); private int seq; SeasonEnum(int seq) { this.seq = seq; }} 1.3 ä»£ç æ ¼å¼ ä¸€è¡Œä»£ç çš„å¤§æ‹¬å·ä¸æ¢è¡Œã€‚ 1.4 OOP è§„çº¦ Object çš„ equals æ–¹æ³•å®¹æ˜“æŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œåº”ä½¿ç”¨å¸¸é‡æˆ–æœ‰å€¼çš„å¯¹è±¡æ¥è°ƒç”¨ equalsã€‚ æ­£ä¾‹ï¼š&quot;test&quot;.equals(object);åä¾‹ï¼šobject.equals(&quot;test&quot;); æ‰€æœ‰ç›¸åŒç±»å‹çš„åŒ…è£…ç±»å¯¹è±¡ä¹‹é—´ value çš„æ¯”è¾ƒï¼Œå…¨éƒ¨ä½¿ç”¨ equals æ–¹æ³•ã€‚ä½†æ˜¯è¦æ³¨æ„ Integer var = ï¼Ÿåœ¨ -128 ~ 127 èŒƒå›´å†…çš„èµ‹å€¼æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼ˆå–è‡ª IntegerCache.cache ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨ == è¿›è¡Œåˆ¤æ–­ã€‚ä½†æ˜¯æ¨èä½¿ç”¨ equals æ–¹æ³•ã€‚ æ‰€æœ‰ POJO çš„å±æ€§å¿…é¡»ä½¿ç”¨åŒ…è£…æ•°æ®ç±»å‹ã€‚POJO ç±»å±æ€§æ²¡æœ‰åˆå§‹å€¼ï¼Œæ˜¯è¦æé†’ä½¿ç”¨è€…åœ¨éœ€è¦ä½¿ç”¨æ—¶ï¼Œå¿…é¡»è‡ªå·±æ˜¾å¼åœ°èµ‹å€¼ï¼Œä»»ä½• NPE é—®é¢˜ï¼Œæˆ–è€…å…¥åº“æ£€æŸ¥ï¼Œéƒ½ç”±ä½¿ç”¨è€…æ¥ä¿è¯ã€‚ æ­£ä¾‹ï¼šæ•°æ®åº“çš„æŸ¥è¯¢ç»“æœå¯èƒ½æ˜¯ nullï¼Œå› ä¸ºè‡ªåŠ¨æ‹†ç®±ï¼Œæ‰€ä»¥ç”¨åŸºæœ¬æ•°æ®ç±»å‹æ¥æ”¶éƒ½æœ‰ NPE é£é™©ã€‚ POJO å¿…é¡»å†™ toString æ–¹æ³•ã€‚ åœ¨å¾ªç¯ä½“å†…ï¼Œå­—ç¬¦ä¸²çš„è¿æ¥æ–¹å¼ä½¿ç”¨ StringBuilder çš„ append æ–¹æ³•ã€‚ç”¨ String æ‹¼æ¥ä¼šäº§ç”Ÿå¾ˆå¤šä¸ªæ–°çš„å¯¹è±¡ï¼Œé€ æˆå†…å­˜èµ„æºæµªè´¹ã€‚ å·¥å…·ç±»ä¸å…è®¸æœ‰ public æˆ– defaul æ„é€ æ–¹æ³•ã€‚å› ä¸ºå·¥å…·ç±»ä¸€èˆ¬åªéœ€è¦ä¸€ä¸ªå¯¹è±¡ï¼Œå†™ method æŒ‡å®šä¸º static å³å¯ã€‚ 1.5 é›†åˆå¤„ç† åœ¨ä½¿ç”¨å·¥å…·ç±» Arrays.asList() æŠŠæ•°ç»„è½¬æ¢æˆé›†åˆåï¼Œä¸èƒ½ä½¿ç”¨ä¿®æ”¹é›†åˆç›¸å…³çš„æ–¹æ³•ï¼Œå¦‚ add / remove / clear çš„é›†åˆæ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º UnsupportOperationException å¼‚å¸¸ã€‚å› ä¸º asList çš„è¿”å›å¯¹è±¡æ˜¯ä¸€ä¸ª Arrays å†…éƒ¨ç±»ï¼Œå¹¶æ²¡æœ‰å®ç°é›†åˆçš„ä¿®æ”¹æ–¹æ³•ã€‚Arrays.asList ä½“ç°çš„æ˜¯é€‚é…å™¨æ¨¡å¼ï¼Œåªæ˜¯è½¬æ¢æ¥å£ï¼Œåå°çš„æ•°æ®å®é™…ä¸Šè¿˜æ˜¯æ•°ç»„ã€‚ ä¸è¦å† foreach å¾ªç¯é‡Œè¿›è¡Œå…ƒç´ çš„ remove / add æ“ä½œã€‚remove å…ƒç´ ä½¿ç”¨ Iterator æ–¹å¼ï¼Œå¦‚æœæ˜¯å¹¶å‘æ“ä½œï¼Œéœ€è¦å¯¹ Iterator å¯¹è±¡åŠ é”ã€‚ æ­£ä¾‹ï¼š 1234Iterator&lt;String&gt; iterator = list.iterator();while (iterator.hasNext()) { String item = iterator.next();} åœ¨é›†åˆåˆå§‹åŒ–æ—¶ï¼Œæ¨èæŒ‡å®šé›†åˆåˆå§‹å€¼å¤§å°ã€‚HashMap ä½¿ç”¨ HashMap(itn initialCapacity) åˆå§‹åŒ–ã€‚ æ­£ä¾‹ï¼šinitialCapacity = ï¼ˆå…ƒç´ ä¸ªæ•° / è´Ÿè½½å› å­ï¼‰+ 1ã€‚å…¶ä¸­è´Ÿè½½å› å­ load factor é»˜è®¤ä¸º 0.75ã€‚å¦‚æœæš‚æ—¶æ— æ³•ç¡®å®šåˆå§‹å€¼å¤§å°ï¼Œå°±è®¾ç½®ä¸º 16ï¼ˆå³é»˜è®¤å€¼ï¼‰ã€‚åä¾‹ï¼šHashMap éœ€è¦æ”¾ç½® 1024 ä¸ªå…ƒç´ ï¼Œç”±äºæ²¡æœ‰è®¾ç½®å®¹é‡åˆå§‹å¤§å°ï¼Œéšç€å…ƒç´ çš„ä¸æ–­å¢åŠ ï¼Œå®¹é‡è¢«æ‰©å¤§ 7 æ¬¡ï¼Œresize éœ€è¦é‡å»º hash è¡¨ï¼Œè¿™ä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚ 1.6 å¹¶å‘å¤„ç† è·å–å•ä¾‹å¯¹è±¡éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå…¶ä¸­çš„æ–¹æ³•ä¹Ÿè¦ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚èµ„æºé©±åŠ¨ç±»ã€å·¥å…·ç±»ã€å•ä¾‹å·¥å‚ç±»éƒ½éœ€è¦æ³¨æ„ã€‚ çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾ç¤ºåˆ›å»ºçº¿ç¨‹ã€‚ çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼åˆ›å»ºï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼èƒ½è®©ç¼–å†™ä»£ç çš„å·¥ç¨‹å¸ˆæ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©ã€‚ è¯´æ˜ï¼šExecutors è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š1ï¼‰FixedThreadPool å’Œ SingleThreadPoolï¼šå…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚2ï¼‰CachedThreadPool å’Œ ScheduledThreadPoolï¼šå…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚ åœ¨å¹¶å‘ä¿®æ”¹åŒä¸€è®°å½•æ—¶ï¼Œä¸ºé¿å…æ›´æ–°ä¸¢å¤±éœ€è¦åŠ é”ã€‚è¦ä¹ˆåœ¨åº”ç”¨å±‚åŠ é”ï¼Œè¦ä¹ˆåœ¨ç¼“å­˜å±‚åŠ é”ï¼Œè¦ä¹ˆåœ¨æ•°æ®åº“å±‚ä½¿ç”¨ä¹è§‚é”ï¼Œä½¿ç”¨ version ä½œä¸ºæ›´æ–°ä¾æ®ã€‚ å¦‚æœæ¯æ¬¡è®¿é—®å†²çªæ¦‚ç‡å°äº 20%ï¼Œæ¨èä½¿ç”¨ä¹è§‚é”ï¼Œå¦åˆ™ä½¿ç”¨æ‚²è§‚é”ã€‚ä¹è§‚é”çš„é‡è¯•æ¬¡æ•°è¦å¤§äº 3 æ¬¡ã€‚ HashMap åœ¨å®¹é‡ä¸å¤Ÿè¿›è¡Œ resize æ—¶ï¼Œç”±äºé«˜å¹¶å‘å¯èƒ½å‡ºç°æ­»é”ï¼Œå¯¼è‡´ CPU å ç”¨é£™å‡ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨å…¶ä»–æ•°æ®ç»“æ„æˆ–åŠ é”æ¥è§„é¿æ­¤é£é™©ã€‚ ThreadLocal æ— æ³•è§£å†³å…±äº«å¯¹è±¡çš„æ›´æ–°é—®é¢˜ï¼Œ ThreadLocal å¯¹è±¡å»ºè®®ä½¿ç”¨ static ä¿®é¥°ã€‚ 1.7 æ§åˆ¶è¯­å¥ åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ï¼Œé¿å…ä½¿ç”¨ â€œ==â€ åˆ¤æ–­ä½œä¸ºä¸­æ–­æˆ–é€€å‡ºçš„æ¡ä»¶ï¼ˆif è¯­å¥ä¸å¯ä¿¡ï¼Œ== æ¡ä»¶ä¸å¯å–ï¼‰ã€‚ è¯´æ˜ï¼šå¦‚æœå¹¶å‘æ§åˆ¶æ²¡æœ‰å¤„ç†å¥½ï¼Œå®¹æ˜“äº§ç”Ÿç­‰å€¼åˆ¤æ–­è¢«â€œå‡»ç©¿â€çš„æƒ…å†µï¼Œåº”ä½¿ç”¨å¤§äºæˆ–å°äºçš„åŒºé—´åˆ¤æ–­æ¡ä»¶æ¥ä»£æ›¿ã€‚åä¾‹ï¼šåˆ¤æ–­åº“å­˜ç­‰äº 0 æ—¶ï¼Œåœæ­¢å‡ºå”®ã€‚ä½†å¯èƒ½å› ä¸ºå¹¶å‘é—®é¢˜å¯¼è‡´åº“å­˜æ•°é‡å°äº 0 è€Œæ— æ³•åœæ­¢å‡ºå”®ã€‚ åœ¨è¡¨è¾¾å¼‚å¸¸çš„åˆ†æ”¯æ—¶ï¼Œå°½é‡å°‘ç”¨ if-elseã€‚å¯ä»¥æ”¹å†™æˆå¤šä¸ª if è¯­å¥ã€‚ ä¸è¦åœ¨ if æ¡ä»¶è¯­å¥ä¸­æ‰§è¡Œå…¶å®ƒå¤æ‚çš„è¯­å¥ã€‚å¯ä»¥å°†å¤æ‚çš„é€»è¾‘åˆ¤æ–­ç»“æœèµ‹å€¼ç»™ä¸€ä¸ª boolean å˜é‡ï¼ˆå±€éƒ¨å˜é‡ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹ï¼‰ã€‚ 1.8 æ³¨é‡Šè§„çº¦ æ‰€æœ‰çš„ç±»éƒ½å¿…é¡»åŠ ä¸Šä½œè€…å’Œåˆ›å»ºæ—¥æœŸã€‚ æ‰€æœ‰çš„æšä¸¾ç±»å‹å­—æ®µå¿…é¡»è¦æœ‰æ³¨é‡Šï¼Œè¯´æ˜æ¯ä¸ªæ•°æ®é¡¹çš„ç”¨é€”ã€‚ 1.9 å…¶ä»– ä»»ä½•æ•°æ®ç»“æ„çš„æ„é€ æˆ–åˆå§‹åŒ–ï¼Œéƒ½åº”æŒ‡å®šå¤§å°ï¼Œé¿å…å› æ•°æ®ç»“æ„æ— é™å¢é•¿è€Œå†…å­˜ã€‚ åŠæ—¶æ¸…ç†ä¸å†ä½¿ç”¨çš„ä»£ç æ®µæˆ–é…ç½®ä¿¡æ¯ã€‚ è¯´æ˜ï¼šå¯¹äºæš‚æ—¶æ³¨é‡Šåç»­å¯èƒ½ä½¿ç”¨çš„ä»£ç ï¼Œåœ¨ä»£ç ä¸‰æ–¹ç”¨ â€œ///â€œ æ¥è¯´æ˜æ³¨é‡Šæ‰ä»£ç çš„ç†ç”±ã€‚ ç¬¬ 2 ç«  å¼‚å¸¸å¤„ç†2.1 å¼‚å¸¸å¤„ç† Java ç±»åº“ä¸­å®šä¹‰çš„å¯ä»¥é€šè¿‡é¢„æ£€æŸ¥æ–¹å¼è§„é¿çš„ RuntimeException ä¸åº”è¯¥ç”¨ catch æˆ– throws çš„æ–¹å¼æ¥å¤„ç†ã€‚å¦‚ï¼šIndexOutOfBoundsExceptionï¼ŒNullPointerException ç­‰ã€‚ æ­£ä¾‹ï¼šif (obj != null) { â€¦ }åä¾‹ï¼štry { obj.method() } catch (NullPointerException e) { â€¦ } å¼‚å¸¸ä¸è¦ç”¨æ¥åšæµç¨‹æ§åˆ¶ã€æ¡ä»¶æ§åˆ¶ã€‚ è¯´æ˜ï¼šå¼‚å¸¸è®¾è®¡çš„åˆè¡·æ˜¯è§£å†³ç¨‹åºè¿è¡Œåˆ†é’Ÿçš„å„ç§æ„å¤–æƒ…å†µï¼Œå†µä¸”å¼‚å¸¸çš„å¤„ç†æ•ˆç‡æ¯”æ¡ä»¶åˆ¤æ–­çš„æ–¹å¼è¦ä½å¾ˆå¤šã€‚ é˜²æ­¢ NPEï¼Œæ˜¯ç¨‹åºå‘˜çš„åŸºæœ¬ä¿®å…»ï¼Œæ³¨æ„äº§ç”Ÿ NPE çš„åœºæ™¯ã€‚ 1ï¼‰å½“è¿”å›ç±»å‹ä¸ºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œ return æ˜¯ä¸€ä¸ªåŒ…è£…æ•°æ®ç±»å‹çš„å¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨æ‹†ç®±æœ‰å¯èƒ½äº§ç”Ÿ NPEã€‚ï¼ˆequals çš„å€¼åˆ¤æ–­ä¹Ÿä¼šè‡ªåŠ¨æ‹†ç®±ï¼‰åä¾‹ï¼špublic int add() {return Integer å¯¹è±¡}ï¼Œå¦‚æœå¯¹è±¡ä¸º nullï¼Œè‡ªåŠ¨æ‹†ç®±å°±ä¼šäº§ç”Ÿ NPEã€‚å³ int i = null; ä¼šæŠ¥å¼‚å¸¸ã€‚2ï¼‰æ•°æ®åº“çš„æŸ¥è¯¢è¿”å›ç»“æœï¼ˆObjectï¼‰å¯èƒ½ä¸º nullã€‚3ï¼‰é›†åˆé‡Œçš„å…ƒç´ å³ä½¿ isNotEmptyï¼Œä½†å–å‡ºçš„å…ƒç´ ä¹Ÿå¯èƒ½ä¸º nullã€‚4ï¼‰è¿œç¨‹è°ƒç”¨è¿”å›å¯¹è±¡æ—¶ï¼Œä¸€å¾‹è¦æ±‚è¿›è¡Œç©ºæŒ‡é’ˆåˆ¤æ–­ï¼Œä»¥é˜²æ­¢ NPEã€‚5ï¼‰å¯¹äº Session ä¸­è·å–çš„æ•°æ®ï¼Œå»ºè®®è¿›è¡Œ NPE æ£€æŸ¥ï¼Œä»¥é¿å…ç©ºæŒ‡é’ˆã€‚ é¿å…å‡ºç°é‡å¤çš„ä»£ç ã€‚Donâ€™t repeat yourself. 2.2 æ—¥å¿—è§„çº¦ åº”ç”¨ä¸­çš„æ‰©å±•æ—¥å¿—ï¼ˆå¦‚æ‰“ç‚¹ã€ä¸´æ—¶ç›‘æ§ã€è®¿é—®æ—¥å¿—ç­‰ï¼‰å‘½åæ–¹å¼ï¼šappName_logType_logName.logã€‚logType æœ‰ stats/monitor/visit ç­‰ã€‚ æ­£ä¾‹ï¼šåœ¨ mppserver åº”ç”¨ä¸­å•ç‹¬ç›‘æ§æ—¶åŒºè½¬æ¢å¼‚å¸¸ï¼Œå¦‚ mppserver_monitor_timZoneConvert.log ç¬¬ 3 ç«  å•å…ƒæµ‹è¯• å¥½çš„å•å…ƒæµ‹è¯•å¿…é¡»éµå¾ª AIR åŸåˆ™ã€‚å³ Automatic,Independent and Repeatable. Automaticï¼šè‡ªåŠ¨æ‰§è¡Œã€‚å•å…ƒæµ‹è¯•ä¸å‡†ä½¿ç”¨ System.out è¿›è¡Œäººè‚‰éªŒè¯ï¼Œä¸è®¸ä½¿ç”¨ assert éªŒè¯ã€‚ 123456789public void MyTest { @Rule public final SystemOutRule systemOutRule = new SystemOutRule().enableLog(); @Test public void overrideProperty() { System.out.print(&quot;hello world&quot;); assertEquals(&quot;hello world&quot;, systemOutRule.getLog()); }} â€¦ å•å…ƒæµ‹è¯•åº”éµå¾ª BCDE åŸåˆ™ã€‚å³ Border,Correct,Design and Error. ä¸€èˆ¬å•å…ƒæµ‹è¯•ä¸è¦ä¿®æ”¹æ•°æ®åº“çš„æ•°æ®ï¼Œè‡ªå·± mock æ•°æ®æµ‹è¯•ã€‚å’Œæ•°æ®åº“ç›¸å…³çš„å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥è®¾ç½®è‡ªåŠ¨å›æ»šæœºåˆ¶ï¼Œä¸ç»™æ•°æ®åº“é€ æˆè„æ•°æ®ã€‚æˆ–è€…å¯¹å•å…ƒæµ‹è¯•äº§ç”Ÿçš„æ•°æ®è®¾ç«‹æ˜ç¡®çš„ prefix or suffixã€‚ ç¬¬ 4 ç«  å®‰å…¨è§„çº¦ç¬¬ 5 ç«  MySQL æ•°æ®åº“5.1 å»ºè¡¨è§„çº¦ è¡¨è¾¾â€œæ˜¯å¦â€çš„å­—æ®µï¼Œå¿…é¡»ä½¿ç”¨ is_xxx çš„æ–¹å¼å‘½åï¼Œä¸”æ•°æ®ç±»å‹æ˜¯ unsigned tinyintï¼ˆ1 è¡¨ç¤º trueï¼Œ0 è¡¨ç¤º falseï¼‰ã€‚å¦‚æœæ•°æ®ç±»å‹æ˜¯ Boolean åˆ™ POJO å¯¹è±¡è¢« RPC è°ƒç”¨ä¼šç”±äº is_xxx å±æ€§è§£æé”™è¯¯äº§ç”Ÿé—®é¢˜ã€‚ è¡¨åä¸ä½¿ç”¨å¤æ•°ã€‚DO ä¹Ÿä¸€æ ·ã€‚ å°æ•°ç±»å‹ä¸º decimalï¼Œç¦æ­¢ä½¿ç”¨ float å’Œ doubleã€‚ å¦‚æœå­˜å‚¨çš„å­—ç¬¦ä¸²é•¿åº¦å›ºå®šï¼ˆæˆ–è€…å‡ ä¹ä¸€æ ·ï¼‰ï¼ˆæ‰‹æœºå·ã€é‚®ç®±ç­‰ç­‰ï¼‰ï¼Œåˆ™åº”ä½¿ç”¨ char å®šé•¿å­—ç¬¦ä¸²ã€‚ï¼ˆèŠ‚çº¦ç©ºé—´ï¼‰ ä»»ä½•è¡¨éƒ½åº”è¯¥æœ‰çš„ 3 ä¸ªå­—æ®µï¼šidï¼Œgmt_create &lt; datetime type &gt;ï¼Œ gmt_modified. å•è¡¨è¶…è¿‡ 500 ä¸‡è¡Œæˆ–è€…å®¹é‡è¶…è¿‡ 2 GB æ—¶ï¼Œæ‰æ¨èè¿›è¡Œåˆ†è¡¨åˆ†åº“ã€‚å¦‚æœé¢„è®¡ä¸‰å¹´åçš„æ•°æ®é‡æ— æ³•è¾¾åˆ°è¿™ä¸ªçº§åˆ«ï¼Œå°±ä¸è¦åœ¨åˆ›å»ºè¡¨æ—¶å°±åˆ†åº“åˆ†è¡¨ã€‚ è®¾ç½®åˆé€‚çš„å­—ç¬¦å­˜å‚¨é•¿åº¦ï¼ˆåŒ…æ‹¬ unsignedï¼‰ï¼Œä¸ä½†å¯ä»¥èŠ‚çº¦ç©ºé—´ï¼Œæ›´é‡è¦çš„æ˜¯èƒ½æé«˜æ£€ç´¢é€Ÿåº¦ã€‚ 5.2 ç´¢å¼•è§„çº¦ ä¸šåŠ¡ä¸Šå…·æœ‰å”¯ä¸€ç‰¹æ€§çš„å­—æ®µï¼Œå³ä½¿æ˜¯å¤šä¸ªå­—æ®µçš„ç»„åˆï¼Œä¹Ÿå¿…é¡»å»ºæˆå”¯ä¸€ç´¢å¼•ã€‚ é¡µé¢æœç´¢ç¦æ­¢ä½¿ç”¨å·¦æ¨¡ç³Šæˆ–è€…å…¨æ¨¡ç³Šæœç´¢ï¼Œè‹¥éœ€è¦åˆ™é€šè¿‡æœç´¢å¼•æ“è§£å†³ã€‚å› ä¸ºç´¢å¼•æœªè§å…·æœ‰ B-Tree çš„æœ€å·¦å‰ç¼€åŒ¹é…ç‰¹æ€§ï¼Œå¦‚æœå·¦è¾¹çš„å€¼æœªç¡®å®šï¼Œé‚£ä¹ˆå°±æ— æ³•ä½¿ç”¨ç´¢å¼•äº†ã€‚ æ³¨æ„ order by çš„åœºæ™¯ã€‚ æ­£ä¾‹ï¼šwhere a = ? and b = ? order by c = ?; ç´¢å¼•æ˜¯ a_b_cåä¾‹ï¼šç´¢å¼•ä¸­æœ‰èŒƒå›´æŸ¥æ‰¾ï¼Œé‚£ä¹ˆç´¢å¼•æœ‰åºæ€§æ— æ³•åˆ©ç”¨ï¼Œå¦‚ where a &gt; 10 order by b; ç´¢å¼• a_b æ— æ³•æ’åºã€‚ åˆ©ç”¨å»¶è¿Ÿå…³è”æˆ–å­æŸ¥è¯¢ä¼˜åŒ–è¶…å¤šåˆ†é¡µåœºæ™¯ã€‚ è¯´æ˜ï¼šMySQL å¹¶ä¸æ˜¯è·³è¿‡ offset è¡Œï¼Œè€Œæ˜¯å– offset + N è¡Œï¼ˆå…¨éƒ¨ï¼‰ï¼Œç„¶åæ”¾å¼ƒå‰ offset è¡Œï¼Œè¿”å› N è¡Œã€‚æ‰€ä»¥å½“ offset ç‰¹åˆ«å¤§çš„æ—¶å€™æ•ˆç‡å°±ä¼šéå¸¸ä½ã€‚è¦ä¹ˆæ§åˆ¶è¿”å›çš„æ€»é¡µæ•°ï¼Œè¦ä¹ˆå¯¹ç‰¹å®šè¶…è¿‡é˜ˆå€¼çš„é¡µæ•°è¿›è¡Œ SQL æ”¹å†™ã€‚æ­£ä¾‹ï¼šå…ˆå¿«é€Ÿå®šä½éœ€è¦è·å–çš„ id æ®µï¼Œç„¶åå†å…³è”ï¼š 1select a.å­—æ®µ from è¡¨ 1 a, (select id from è¡¨ 1 where æ¡ä»¶ limit 100000, 20) b where a.id = b.id å»ºç»„åˆç´¢å¼•æ—¶ï¼ŒåŒºåˆ†åº¦æœ€é«˜çš„åœ¨æœ€å·¦è¾¹ã€‚ æ­£ä¾‹ï¼šå¦‚ where a = ? and b = ? è¯­å¥ï¼Œå…¶ä¸­ a å‡ ä¹æ¥è¿‘å”¯ä¸€å€¼ï¼Œé‚£ä¹ˆåªéœ€è¦å•å»º idx_a ç´¢å¼•å³å¯ã€‚å¯¹ where a &gt; ? and b = ? è¯­å¥ï¼Œb çš„åŒºåˆ†åº¦æ›´é«˜ã€‚ 5.3 SQL è¯­å¥ count(*) ç»Ÿè®¡æ‰€æœ‰ï¼Œcount(åˆ—å) åªç»Ÿè®¡è¯¥åˆ—ä¸ä¸º null çš„è¡Œæ•°ã€‚ åœ¨ä»£ç ä¸­å†™åˆ†é¡µæŸ¥è¯¢é€»è¾‘æ—¶ï¼Œè‹¥ count ä¸º 0 åˆ™åº”è¯¥ç›´æ¥è¿”å›ï¼Œé¿å…æ‰§è¡Œåé¢çš„åˆ†é¡µè¯­å¥ã€‚ 5.4 ORM æ˜ å°„ POJO ä¸­çš„ Boolean å±æ€§å‘½åä¸èƒ½åŠ  is å‰ç¼€ï¼Œè€Œæ•°æ®åº“å¿…é¡»åŠ  is_ï¼Œè¦æ±‚åœ¨ resultMap ä¸­è¿›è¡Œå­—æ®µä¸å±æ€§çš„æ˜ å°„ã€‚ SQL ç›¸å…³çš„å‚æ•°ä½¿ç”¨ï¼š#{}ï¼Œç”¨ ${} çš„è¯å®¹æ˜“å‡ºç° SQL æ³¨å…¥ã€‚ æ›´æ–°æ—¶ä¹Ÿè¦åŒæ—¶æ›´æ–° gmt_modified å­—æ®µã€‚ ç¬¬ 6 ç«  å·¥ç¨‹ç»“æ„6.1 åº”ç”¨åˆ†å±‚6.2 äºŒæ–¹åº“ä¾èµ–6.3 æœåŠ¡å™¨ é«˜å¹¶å‘æœåŠ¡å™¨å»ºè®®è°ƒå° TCP åè®®çš„ time_wait è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 240sï¼‰ã€‚ æ­£ä¾‹ï¼šåœ¨ Linux æœåŠ¡å™¨ä¸Šå¯é€šè¿‡å˜æ›´ /etc/sysctl.conf æ–‡ä»¶å»ä¿®æ”¹è¯¥é»˜è®¤å€¼ã€‚# net.ipv4.tcp_fin_timeout = 30 è°ƒå¤§æœåŠ¡å™¨æ‰€æ”¯æŒçš„æœ€å¤§æ–‡ä»¶å¥æŸ„æ•°ï¼ˆFile Descriptionï¼Œç®€ç§° fdï¼‰ æ¨èç»™ JVM è®¾ç½® -XX:+HeapDumpOnOutOfMemoryError å‚æ•°ï¼Œè®© JVM ç¢°åˆ° OOM åœºæ™¯æ—¶è¾“å‡º dump ä¿¡æ¯ã€‚ æ¨èåœ¨çº¿ä¸Šç”Ÿäº§ç¯å¢ƒï¼ŒJVM çš„ Xms å’Œ Xmx è®¾ç½®åŒä¸€æ•°å€¼ï¼Œé¿å…åœ¨ GC åè°ƒæ•´å †å¤§å°å¸¦æ¥çš„å‹åŠ›ã€‚ æœåŠ¡å™¨å†…éƒ¨é‡å®šå‘ä½¿ç”¨ forwardï¼›å¤–éƒ¨é‡å®šå‘åœ°å€ä½¿ç”¨ URL æ‹¼è£…å·¥å…·ç±»æ¥ç”Ÿæˆï¼Œå¦åˆ™ä¼šå¸¦æ¥ URL ç»´æŠ¤ä¸ä¸€è‡´çš„é—®é¢˜å’Œæ½œåœ¨çš„å®‰å…¨é£é™©ã€‚ ç¬¬ 7 ç«  è®¾è®¡è§„çº¦é™„å½• A ä¸“æœ‰åè¯","link":"/2021/10/23/java%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/"},{"title":"docker","text":"â€¦ Dockerå¸¸ç”¨å‘½ä»¤3306(æœ¬æœº):3306(å®¹å™¨) docker run hello-world(image) docker run â€“help docker start [å®¹å™¨id] docker image ls docker container ls ï¼ˆè¿è¡Œä¸­ï¼‰ docker container ls â€“all docker container stop [name] docker container rm webserver docker rmi [iamge] docker stats docker network/volume crate/ls/rm docker inspect [image/container/network/volume] å‘½ä»¤çš„ä½¿ç”¨run æ–°å®¹å™¨docker run -p 6379:6379 -d redis:latest redis-server docker run --name test-mysql -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456. mysql æ‰“å¼€mysql clientå‘½ä»¤è¡Œdocker run -it --rm mysql mysql -h47.94.128.66 -uroot -p æŸ¥çœ‹å®¹å™¨ä¿¡æ¯docker inspect [å®¹å™¨id] è¿›å…¥å®¹å™¨è·¯å¾„docker exec -it [å®¹å™¨id] [/bin/bash] docker exec â€“help è·¯å¾„æ˜ å°„docker -v docker run -d -p 8888:8888 -v C:/all/server/nginx-config/nginx.conf:/etc/nginx/nginx.conf:ro nginx build æ„å»ºé•œåƒ cd å½“å‰ç›®å½•ï¼š æ‰§è¡Œå‘½ä»¤ï¼šdocker build -t jackyofteamwang/cheers2019 .å…¶ä¸­ï¼Œjackyofteamwang/cheers2019 ä¸ºé•œåƒæ–‡ä»¶ æ¨é€ï¼šdocker login docker push jackyofteamwang/cheers2019 åˆ é™¤ dockeré™¤äº†å®˜ç½‘çš„æ–¹æ³•ï¼š æŸ¥è¯¢ç›¸å…³è½¯ä»¶åŒ…dpkg -l|grep docker sudo apt remove -purge dock.io æŸ¥çœ‹é•œåƒä¿¡æ¯1docker inspect rancher/rancher:latest å®¹å™¨é—´çš„ç½‘ç»œé€šä¿¡(https://blog.csdn.net/zhizhuodewo6/article/details/87706638) Dockeræœ‰ä»¥ä¸‹ç½‘ç»œç±»å‹ï¼š bridgeï¼šå¤šç”±äºç‹¬ç«‹containerä¹‹é—´çš„é€šä¿¡ hostï¼š ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œï¼Œç«¯å£ä¹Ÿä½¿ç”¨å®¿ä¸»æœºçš„ overlayï¼šå½“æœ‰å¤šä¸ªdockerä¸»æœºæ—¶ï¼Œè·¨ä¸»æœºçš„containeré€šä¿¡ macvlanï¼šæ¯ä¸ªcontaineréƒ½æœ‰ä¸€ä¸ªè™šæ‹Ÿçš„MACåœ°å€ none: ç¦ç”¨ç½‘ç»œ ä½¿ç”¨dockerå‘½ä»¤ åˆ›å»º bridge ç½‘ç»œ 1docker network create --driver bridge local-net å®¹å™¨å¯åŠ¨æ—¶æŒ‡å®š--network [your net]å’Œ--name [your name] è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨å®¹å™¨å†…ping [container_name]åŒä¸ªbridgeçš„å®¹å™¨ã€‚ ä½¿ç”¨ docker-compose1234567networks: some-network: # Use a custom driver driver: custom-driver-1 other-network: # Use a custom driver which takes special options driver: custom-driver-2 Docker æ„å»º SpringBoot åº”ç”¨åŸºç¡€ä½¿ç”¨å‘½ä»¤ï¼šdocker build -t jackyfangofteamwang/app.jar . Dockerfile æ–‡ä»¶å¦‚ä¸‹ï¼š 1234567891011FROM openjdk:8MAINTAINER jakcy &quot;jacky.teamwang@qq.com&quot;ENV TZ=&quot;Asia/Shanghai&quot;VOLUME /tmpADD tea-tea.jar app.jar# docker hints server portEXPOSE 8080ENTRYPOINT [&quot;java&quot;, &quot;-Djava.security.egd=file:/dev/./urandom&quot;, &quot;-jar&quot;, &quot;app.jar&quot;] æŒ‚è½½æ—¥å¿—ç›®å½•ï¼š docker run -d -p 8085:8085 -v C:/all/volume/tmp:/tmp jackyfangofteamwang/chaos.jar docker-compose æ„å»ºè¿è¡Œdocker-compose å®é™…ä¸Šæ˜¯ docker run çš„å‘½ä»¤å°è£…ã€‚ docker-compose.yml æ–‡ä»¶å¦‚ä¸‹ï¼š 12345678910version: '2.2'services: demo: build: context: ./ dockerfile: Dockerfile image: jackyfangofteamwang/app.jar:1.0.0 # æœ¬æœºç«¯å£å·:dockerç«¯å£ ports: - 8083:8083 æ³¨æ„äº‹é¡¹ docker çš„æ—¶åŒºé—®é¢˜-å¯åŠ¨å®¹å™¨æ—¶æŒ‡å®šå‚æ•°:-e TZ=&quot;Asia/Shanghai&quot; docker å¯ä»¥ä½¿ç”¨ localhostï¼Œä½†æ˜¯éœ€è¦åšç«¯å£æ˜ å°„ï¼ˆå³è¿˜æ˜¯ä½¿ç”¨ä¸»æœºç«¯å£ï¼‰ã€‚ Jenkinså¯åŠ¨å‘½ä»¤ï¼š 12345678docker run \\ -u root \\ -d \\ -p 18080:8080 \\ -p 50000:50000 \\ -v /jacky/data/docker/jenkins-data:/var/jenkins_home \\ -v /jacky/data/docker/var/run/docker.sock:/var/run/docker.sock \\ jenkinsci/blueocean Jenkinsé»˜è®¤ç”¨æˆ·ä¸æ˜¯rootï¼Œæ‰€ä»¥è¿æ¥githubæ—¶éœ€è¦å†ç”Ÿæˆkeyï¼š è¿›å…¥jenkinså®¹å™¨åï¼Œæ‰§è¡Œå‘½ä»¤ï¼šssh-keygen -t rsa -C &quot;jenkins@git&quot;,cd ~/.ssh. docker cp a2119a11fbfa:/root/.ssh/id_rsa.pub /jacky/data/temp å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œåœ¨jenkinså®¹å™¨å†…æ‰§è¡Œå‘½ä»¤ï¼šgit ls-remote -h git@github.com:cloris-cc/demo.git HEAD jenkins æ’ä»¶ä¸‹è½½é€Ÿåº¦æ…¢ è¿™ä¸ªä¹Ÿå¯ä»¥ï¼šhttps://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json http://mirror.xmission.com/jenkins/updates/current/update-center.json http://mirror.esuni.jp/jenkins/updates/update-center.json Docker é…ç½®daemon.json[root@libresse-test01 ~]# cat /etc/docker/daemon.json 1234567891011{ &quot;registry-mirrors&quot;: [&quot;https://ndy7ld6k.mirror.aliyuncs.com&quot;,&quot;http://abcd1234.m.daocloud.io&quot;], &quot;graph&quot;: &quot;/guanke/datas/docker&quot;, &quot;dns&quot;: [&quot;8.8.8.8&quot;,&quot;8.8.4.4&quot;], &quot;hosts&quot;: [&quot;tcp://0.0.0.0:2378&quot;,&quot;unix:///var/run/docker.sock&quot;], &quot;log-driver&quot;:&quot;json-file&quot;, &quot;log-opts&quot;:{ &quot;max-size&quot; :&quot;500m&quot;,&quot;max-file&quot;:&quot;3&quot; }} ä¿®æ”¹ daemon.json å1234567891011a.ä¿®æ”¹å®Œæˆåreloadé…ç½®æ–‡ä»¶sudo systemctl daemon-reloadb.é‡å¯dockeræœåŠ¡sudo systemctl restart docker.servicec.æŸ¥çœ‹çŠ¶æ€sudo systemctl status docker -ld.æŸ¥çœ‹æœåŠ¡sudo docker info 1sudo systemctl daemon-reloadsudo systemctl restart docker è¿œç¨‹è®¿é—®è§ Docker å®˜æ–¹æ–‡æ¡£ æŸ¥çœ‹è¿œç¨‹ä¸»æœºdockerä¿¡æ¯å‘½ä»¤: docker -H tcp://ip-address:port infoä¾‹å¦‚ï¼Œdocker -H tcp://10.100.240.124:2378 info Configuring remote access with systemd unit file Use the command sudo systemctl edit docker.service to open an override file for docker.service in a text editor. Add or modify the following lines, substituting your own values. 1[Service]ExecStart=ExecStart=/usr/bin/dockerd -H fd:// -H tcp://127.0.0.1:2375 Save the file. Reload the systemctl configuration. 1$ sudo systemctl daemon-reload Restart Docker. 1$ sudo systemctl restart docker.service Check to see whether the change was honored by reviewing the output of netstat to confirm dockerd is listening on the configured port. 1$ sudo netstat -lntp | grep dockerdtcp 0 0 127.0.0.1:2375 0.0.0.0:* LISTEN 3758/dockerd é•œåƒåŠ é€Ÿç¼–è¾‘/etc/docker/daemon.json,æ·»åŠ  registry-mirrorsï¼š 1{ &quot;registry-mirrors&quot;: [ &quot;https://registry.docker-cn.com&quot;], &quot;insecure-registries&quot;: [], &quot;debug&quot;: true, &quot;experimental&quot;: false} æŒ‚è½½ç›®å½•/å·ç›®å½•å‡å¯è‡ªå®šä¹‰ã€‚å¦‚æŒ‚è½½è‡ªå®šä¹‰ä¸»æœºç›®å½•:/è‡ªå®šä¹‰å®¹å™¨ç›®å½•ã€‚å­˜æ”¾æ—¥å¿—æ—¶ï¼Œéœ€è¦åœ¨ä¸»æœºä¸Šä¸ºå„ä¸ªå¾®æœåŠ¡å»ºç«‹å•ç‹¬çš„æ—¥å¿—å­˜æ”¾ç›®å½•/è·¯å¾„ï¼Œé¿å…å­˜æ”¾åœ¨ä¸€èµ·ï¼Œä½¿å„ä¸ªå®¹å™¨ä½“ç§¯å˜å¤§ã€‚ ä¿®æ”¹å·²å¯åŠ¨å®¹å™¨æ—¶åŒº echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone dpkg-reconfigure -f noninteractive tzdata ä½¿ç”¨ docker cp å‘½ä»¤ï¼šdocker cp /etc/localtime [å®¹å™¨IDæˆ–è€…NAME]:/etc/localtime é¡¹ç›®åº”ç”¨æ‰“åŒ… Dockerfiletagï¼šå°†resourcesç›®å½•ä¸€åŒæ‰“åŒ… 1&lt;resources&gt; &lt;finalName&gt;${project.artifactId}&lt;/finalName&gt; &lt;resource&gt; &lt;directory&gt;src/main/resources&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*&lt;/include&gt; &lt;/includes&gt; &lt;/resource&gt; &lt;resource&gt; &lt;directory&gt;src/main/docker&lt;/directory&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;includes&gt; &lt;include&gt;**/Dockerfile&lt;/include&gt; &lt;/includes&gt; &lt;targetPath&gt;${project.build.directory}&lt;/targetPath&gt; &lt;/resource&gt; &lt;/resources&gt; TEA Dockerfile1FROM openjdk:8MAINTAINER jakcy &quot;jacky.teamwang@qq.com&quot;ENV TZ=&quot;Asia/Shanghai&quot;VOLUME /tmpADD tea-tea.jar app.jar# docker hints server portEXPOSE 8080ENTRYPOINT [&quot;java&quot;, &quot;-Djava.security.egd=file:/dev/./urandom&quot;, &quot;-jar&quot;, &quot;app.jar&quot;] Jenkins é¡¹ç›®é…ç½® 1docker image rm github-demo-imgdocker build -t github-demo-img /jacky/data/docker/image/sleep 1docker psdocker stop github-demodocker run -d -p 8083:8083 -e TZ=&quot;Asia/Shanghai&quot; -v /jacky/data/docker/tmp:/tmp --rm --name github-demo github-demo-img ## ä»éœ€æŒ‚è½½æ—¥å¿—ç›®å½•å’Œåˆ‡æ¢æ—¶åŒº æ¸…é™¤dockeræ—¥å¿—du -chs /tea/docker/containers/*/*json.log docker æ¸…ç†å‘½ä»¤docker system prune æ‰¾å‡ºå¤§æ–‡ä»¶å‘½ä»¤æ‰¾å‡ºå¤§æ–‡ä»¶å‘½ä»¤ï¼šfind . -type f -size +40M -print0 | xargs -0 du -h | sort -nr å¯åŠ¨ nginxnginx.conf æ–‡ä»¶ç¤ºä¾‹ï¼š 1user nginx;worker_processes 1;error_log /var/log/nginx/error.log warn;pid /var/run/nginx.pid;events { worker_connections 1024;}http { include /etc/nginx/mime.types; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] &quot;$request&quot; ' '$status $body_bytes_sent &quot;$http_referer&quot; ' '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'; access_log /var/log/nginx/access.log main; sendfile on; #tcp_nopush on; keepalive_timeout 65; #gzip on; include /etc/nginx/conf.d/*.conf; server { listen 80; server_name www.teamwang.cn teamwang.cn; rewrite ^(.*) https://$server_name$1 permanent; } server { listen 18005; server_name www.teamwang.cn teamwang.cn; location /static { alias /usr/share/nginx/static; expires 1d; autoindex on; } }} å…¶ä¸­ï¼Œ*.confé»˜è®¤æœ‰default.confï¼š 1server { listen 80; listen [::]:80; server_name localhost; #charset koi8-r; #access_log /var/log/nginx/host.access.log main; location / { root /usr/share/nginx/html; index index.html index.htm; } #error_page 404 /404.html; # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; } # proxy the PHP scripts to Apache listening on 127.0.0.1:80 # #location ~ \\.php$ { # proxy_pass http://127.0.0.1; #} # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000 # #location ~ \\.php$ { # root html; # fastcgi_pass 127.0.0.1:9000; # fastcgi_index index.php; # fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name; # include fastcgi_params; #} # deny access to .htaccess files, if Apache's document root # concurs with nginx's one # #location ~ /\\.ht { # deny all; #}} ä¿®æ”¹å®¹å™¨é…ç½® å‚ç…§è¯¥é¡¹ç›®ï¼šhttps://github.com/nacos-group/nacos-dockerå…¶ä¸­çš„ docker-compose.yml çš„ env ç¯å¢ƒå˜é‡ä»¥æ–‡ä»¶æ–¹å¼æå–ï¼Œ å¦‚æœè¦è‡ªå®šä¹‰å®¹å™¨çš„é…ç½®ï¼Œå»ºè®®ä½¿ç”¨ docker-compose up å‘½ä»¤ã€‚ç›¸åº”çš„é…ç½®åœ¨ xxx.yml ä¸­ä¿®æ”¹å³å¯ï¼Œä½¿ç”¨ docker-compose -f xxx.yml upã€‚-f æ˜¯ -file çš„æ„æ€ã€‚ ä¸‹é¢æ˜¯ nacos-docker å…¶ä¸­ä¸€ä¸ªå¯åŠ¨é…ç½®æ–‡ä»¶ standalone-mysql-5.7.yaml 1version: &quot;2&quot;services: nacos: image: nacos/nacos-server:latest container_name: nacos-standalone-mysql # ç”¨æ–‡ä»¶æ–¹å¼è¯»å– env env_file: - ../env/nacos-standlone-mysql.env volumes: - ./standalone-logs/:/home/nacos/logs - ./init.d/custom.properties:/home/nacos/init.d/custom.properties ports: - &quot;8848:8848&quot; - &quot;9555:9555&quot; depends_on: - mysql restart: on-failure mysql: container_name: mysql image: nacos/nacos-mysql:5.7 env_file: - ../env/mysql.env volumes: - ./mysql:/var/lib/mysql ports: - &quot;3306:3306&quot; prometheus: container_name: prometheus image: prom/prometheus:latest volumes: - ./prometheus/prometheus-standalone.yaml:/etc/prometheus/prometheus.yml ports: - &quot;9090:9090&quot; depends_on: - nacos restart: on-failure grafana: container_name: grafana image: grafana/grafana:latest ports: - 3000:3000 restart: on-failure æŸ¥çœ‹å®¹å™¨ip addresså‘½ä»¤ï¼šdocker inspect container_id Gatewayæ˜¯æœ¬æœºï¼æ›¿ä»£localhost! docker è¿›é˜¶1. æœåŠ¡ç¼–æ’1.1 Mesos1.2 DockerSwarm æ•™ç¨‹ï¼šhttps://www.bookstack.cn/read/docker-swarm-guides/kai-shi-shi-yong-swarm-swarmmo-shi-duan-kou-lu-you.md æ¦‚å¿µ æœåŠ¡å‘ç°æœºåˆ¶ï¼š Ingressï¼šoverlay ç½‘ç»œ å¿«é€Ÿå¼€å§‹ Attention: å¼€æ”¾ manager ä¸»æœºTCP 2377ç«¯å£(ä¹Ÿå¯ä»¥è‡ªå®šä¹‰) å¼€æ”¾æ‰€æœ‰èŠ‚ç‚¹çš„ TCP/UDP 7946ç«¯å£ç”¨äºcontaineræœåŠ¡å‘ç° UDP 4789ç«¯å£ç”¨äºoverlayç½‘ç»œé€šä¿¡ã€‚ åˆå§‹åŒ–é›†ç¾¤(Manager * 1)docker swarm init --advertise-addr &lt;MANAGER-IP&gt;:&lt;PORT&gt; 1docker swarm join --token SWMTKN-1-28bihq1uqncv0whwd5laj01kmgdx32oqp1crkzopn80087tvl8-aokefgdf485ju7cj85zk9qapn 47.94.128.66:2377 åŠ å…¥å·¥ä½œèŠ‚ç‚¹(Node * n)docker swarm join --token &lt;TOKEN&gt; &lt;MANAGER-IP&gt;:&lt;PORT&gt; ç–æ•£å½“å‰èŠ‚ç‚¹docker swarm leave æå‡workerä¸ºmanagerdocker node lsdocker node promote [hostname] å¸¸ç”¨å‘½ä»¤åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼š docker network create --driver=overlay --attachable mynet å‘å¸ƒæœåŠ¡ï¼šdocker service create --replicas 1 --name helloworld alpine ping docker.comæœåŠ¡æ›´æ–°ï¼šdocker service updateæœåŠ¡ä¼¸ç¼©ï¼šdocker service scale &lt;SERVICE-ID&gt;=&lt;NUMBER-OF-TASKS&gt;æœåŠ¡åˆ—è¡¨ï¼šdocker service listæŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼šdocker [service] inspect --pretty &lt;Service-Id&gt;æŸ¥çœ‹æœåŠ¡æ‰€åœ¨èŠ‚ç‚¹ï¼šdocker service ps nginx-allåˆ é™¤ï¼šdocker service rm [service-id/name]ç«¯å£æ˜ å°„ï¼š 1docker service create \\ --name &lt;SERVICE-NAME&gt; \\ --publish published=&lt;xx&gt;,target=&lt;xx&gt; \\ [--publish-add &lt;xx&gt;:&lt;xx&gt;] &lt;IMAGE&gt; æ›´æ–°ç«¯å£ï¼š 1docker service update \\ --publish-add published=&lt;PUBLISHED-PORT&gt;,target=&lt;CONTAINER-PORT&gt; \\ &lt;SERVICE&gt; 1.3 Kubernetes","link":"/2021/10/29/docker/"},{"title":"rancher","text":"â€¦ RancheråŸºç¡€ç¯å¢ƒé…ç½®ä¸»æœºé…ç½® ä¿®æ”¹ä¸»æœºåï¼šcat /etc/hostname ç¼–è¾‘ /etc/hosts æ–‡ä»¶ï¼š ä¿®æ”¹æ—¶åŒºï¼šæŸ¥çœ‹æ—¶åŒºdate -R æˆ–è€… timedatectlï¼Œä¿®æ”¹æ—¶åŒºï¼šln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime rancher å¯åŠ¨å‘½ä»¤sudo docker run -d --restart=unless-stopped -p 8080:8080 rancher/server æ³¨æ„äº‹é¡¹å®¹å™¨æ—¶åŒºä¿®æ”¹ï¼š æŒ‚è½½ä¸»æœºæ—¶åŒºï¼š-v /etc/localtime:/etc/localtime å¯åŠ¨å®¹å™¨æ—¶æ·»åŠ å‚æ•°ï¼š-e TZ=&quot;Asia/Shanghai&quot; ç³»ç»Ÿå…¨å±€ä¿®æ”¹ centos with `ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime` Dockerfile ä¿®æ”¹ ç¯å¢ƒå˜é‡ï¼šTZ=&quot;Asia/Shanghai&quot; rancher é›†ç¾¤https://rancher.com/docs/rancher/v1.6/en/installing-rancher/installing-server/#multi-nodes v1.6 è¿ç§» v2.xMigration Cheatsheet Rancher 1.6 Rancher 2.0 Container Pod Services Workload Load Balancer Ingress Stack Namespace Environment Project (Administration)/Cluster (Compute) Host Node Catalog Helm Rancher 2.5 Rancher: ä½¿ç”¨Rancherå¯ä»¥éå¸¸è½»æ¾åœ°ç®¡ç†å®‰è£…åœ¨æœ¬åœ°æˆ–è¿œç¨‹å¼€å‘ç¯å¢ƒä¸­çš„Kubernetesã€‚Rancher 2.3å…¨é¢æ”¯æŒWindowså®¹å™¨ï¼Œé›†æˆIstioæœåŠ¡ç½‘æ ¼ï¼Œå¹¶å¢å¼ºäº†äº‘åŸç”Ÿå·¥ä½œè´Ÿè½½çš„å®‰å…¨æ€§ï¼Œæœ‰åŠ©äºå¼€å‘äººå‘˜æ›´å¿«ä¸”æ›´æœ‰ä¿¡å¿ƒåœ°è¿›è¡Œåˆ›æ–°ã€‚ RKE: RKEæ˜¯ä¸€æ¬¾ç»è¿‡CNCFè®¤è¯ã€æè‡´ç®€å•æ˜“ç”¨ä¸”é—ªç”µèˆ¬å¿«é€Ÿçš„Kuberneteså®‰è£…ç¨‹åºï¼Œå®Œå…¨åœ¨å®¹å™¨å†…è¿è¡Œï¼Œè§£å†³äº†å®¹å™¨æœ€å¸¸è§çš„å®‰è£…å¤æ‚æ€§é—®é¢˜ã€‚å€ŸåŠ©RKEï¼ŒKuberneteså¯ä»¥å®Œå…¨ç‹¬ç«‹äºæ‚¨æ­£åœ¨è¿è¡Œçš„æ“ä½œç³»ç»Ÿå’Œå¹³å°ï¼Œè½»æ¾å®ç°Kubernetesçš„è‡ªåŠ¨åŒ–è¿ç»´ã€‚ä»…éœ€å‡ åˆ†é’Ÿï¼ŒRKEä¾¿å¯é€šè¿‡å•æ¡å‘½ä»¤æ„å»ºä¸€ä¸ªé›†ç¾¤ï¼Œå…¶å£°æ˜å¼é…ç½®ä½¿Kuberneteså‡çº§æ“ä½œå…·å¤‡åŸå­æ€§ä¸”å®‰å…¨ã€‚ K3s: k3sæ˜¯ç»CNCFä¸€è‡´æ€§è®¤è¯çš„Kuberneteså‘è¡Œç‰ˆï¼Œä¸“ä¸ºæ— äººå€¼å®ˆã€èµ„æºå—é™ã€åè¿œåœ°åŒºæˆ–ç‰©è”ç½‘è®¾å¤‡å†…éƒ¨çš„ç”Ÿäº§å·¥ä½œè´Ÿè½½è€Œè®¾è®¡ã€‚ k3sè¢«æ‰“åŒ…æˆå•ä¸ªå°äº60MBçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¯æŒx86å’ŒARMå¤„ç†å™¨ï¼Œåœ¨å°åˆ°æ ‘è“æ´¾æˆ–å¤§åˆ° AWS a1.4xlarge 32GiBæœåŠ¡å™¨çš„ç¯å¢ƒä¸­å‡èƒ½å‡ºè‰²å·¥ä½œã€‚ Rio: Rioæ˜¯ä¸€æ¬¾è½»é‡çº§Kubernetesåº”ç”¨éƒ¨ç½²å¼•æ“ï¼Œå¯ä»¥å¿«é€Ÿä¸”ç®€å•åœ°åœ¨ä»»ä½•Kubernetesé›†ç¾¤ä¸­æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ã€æ‰©å±•å’Œç¼–å†™æ— çŠ¶æ€çš„åº”ç”¨ç¨‹åºã€‚é€šè¿‡é›†æˆIstioã€Knativeå’ŒPrometheusç­‰å¸¸è§æœåŠ¡ï¼ŒRioå¸®åŠ©æ‚¨ä¸ºç”¨æˆ·æä¾›æœ€ä½³çš„åº”ç”¨ç¨‹åºå‘å¸ƒä½“éªŒã€‚ 1. å¿«é€Ÿå¼€å§‹1.1 éƒ¨ç½²RancherServeråœ¨1.xç‰ˆæœ¬ï¼Œé•œåƒåœ°å€ä¸ºrancher/serverï¼›åœ¨2.xç‰ˆæœ¬ï¼Œé•œåƒåœ°å€ä¸ºrancher/rancherã€‚ä¸‹é¢çš„tagæ˜¯é€‚é…äº†m1 macçš„ç‰ˆæœ¬ã€‚ 123docker run -d --privileged --restart=unless-stopped \\ -p 8080:80 -p 8081:443 \\ rancher/rancher:v2.5.10-linux-arm64 å¯åŠ¨åå¦‚ä¸‹ç•Œé¢ï¼š k3sæœ‰å¤šè½»é‡ï¼Ÿ k3så¤§å°ä»…æœ‰60MBï¼Œå°äº512MB RAMå³å¯è¿è¡Œã€‚ä¸ºäº†å‡å°‘è¿è¡ŒKubernetesæ‰€éœ€å†…å­˜ï¼ŒRancher K3så¼€å‘å›¢é˜Ÿä¸»è¦ä¸“æ³¨äºä»¥ä¸‹å››ä¸ªæ–¹é¢çš„ä¸»è¦å˜åŒ–ï¼š åˆ é™¤æ—§çš„ã€éå¿…é¡»çš„ä»£ç ï¼šK3sä¸åŒ…æ‹¬ä»»ä½•é»˜è®¤ç¦ç”¨çš„AlphaåŠŸèƒ½æˆ–è€…è¿‡æ—¶çš„åŠŸèƒ½ï¼ŒåŸæœ‰çš„APIç»„ä»¶ç›®å‰ä»è¿è¡Œäºæ ‡å‡†éƒ¨ç½²å½“ä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRancherè¿˜åˆ é™¤äº†æ‰€æœ‰éé»˜è®¤è®¸å¯æ§åˆ¶å™¨ï¼Œin- treeäº‘æä¾›å•†å’Œå­˜å‚¨é©±åŠ¨ç¨‹åºï¼Œä½†å…è®¸ç”¨æˆ·æ·»åŠ ä»»ä½•ä»–ä»¬éœ€è¦çš„é©±åŠ¨ç¨‹åºã€‚ æ•´åˆæ­£åœ¨è¿è¡Œçš„æ‰“åŒ…è¿›ç¨‹ï¼šä¸ºäº†èŠ‚çœRAMï¼ŒRancherå°†é€šå¸¸åœ¨Kubernetesç®¡ç†æœåŠ¡å™¨ä¸Šè¿è¡Œçš„å¤šæµç¨‹åˆå¹¶ä¸ºå•ä¸ªæµç¨‹ã€‚Rancherè¿˜å°†åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œçš„kubeletã€kubeproxyå’Œflannelä»£ç†è¿›ç¨‹ç»„åˆæˆä¸€ä¸ªè¿›ç¨‹ã€‚ ä½¿ç”¨containerdä»£æ›¿Dockerä½œä¸ºè¿è¡Œæ—¶çš„å®¹å™¨å¼•æ“ï¼šé€šè¿‡ç”¨containderdæ›¿æ¢Dockerï¼ŒRancherèƒ½å¤Ÿæ˜¾è‘—å‡å°‘è¿è¡Œæ—¶å ç”¨ç©ºé—´ï¼Œåˆ é™¤libnetworkã€swarmã€Dockerå­˜å‚¨é©±åŠ¨ç¨‹åºå’Œå…¶ä»–æ’ä»¶ç­‰åŠŸèƒ½ã€‚ é™¤äº† etcd ä¹‹å¤–ï¼Œå¼•å…¥ SQLite ä½œä¸ºå¯é€‰çš„æ•°æ®å­˜å‚¨ï¼šRancheråœ¨k3sä¸­æ·»åŠ äº†SQLiteä½œä¸ºå¯é€‰çš„æ•°æ®å­˜å‚¨ï¼Œä»è€Œä¸ºetcdæä¾›äº†ä¸€ä¸ªè½»é‡çº§çš„æ›¿ä»£æ–¹æ¡ˆã€‚è¯¥æ–¹æ¡ˆä¸ä»…å ç”¨äº†è¾ƒå°‘çš„å†…å­˜ï¼Œè€Œä¸”å¤§å¹…ç®€åŒ–äº†æ“ä½œã€‚ ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ·»åŠ å·¥ä½œèŠ‚ç‚¹node(linuxæœåŠ¡å™¨/è™šæ‹Ÿæœº)ï¼š 1sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.5.10 --server https://localhost:8081 --token srvzmd2c95b9fxrfqpf45nx6wk2wntctd5qvmqhlnpsnzgtf8zmzdx --ca-checksum 23da76edbcca360b01ccaca56421c1a58097164a8c7eaf1ab4759991c947559c --etcd --controlplane --worker rancherç­‰å¾…é¡µé¢ï¼š ä¸èƒ½æŠŠè‡ªå·±å½“ä½œå·¥ä½œèŠ‚ç‚¹æ·»åŠ åˆ°rancherä¸Šå—ï¼Ÿï¼Ÿï¼Ÿ Cluster must have at least one etcd plane host: failed to connect to the following etcd host(s) [192.168.64.3] 1.2 éƒ¨ç½²å·¥ä½œè´Ÿè½½ ä¸Šé¢çš„ç½‘ç»œæ¨¡å¼ï¼Œå…¶å®å°±æ˜¯k8sçš„Servcie(å››ç§ç±»å‹)ã€‚ 1.3 å‘½ä»¤è¡Œå·¥å…·1.4 Istioæ“ä½œæ­¥éª¤# åœ¨ Rancher é›†ç¾¤èµ„æºç®¡ç†å™¨ä¸­ï¼Œæ‰“å¼€ kubectl shellã€‚ ç„¶åè¿è¡Œkubectl label namespace &lt;namespace&gt; istio-injection=enabledã€‚ ç»“æœï¼š å‘½åç©ºé—´ç°åœ¨æœ‰istio-injection=enabledæ ‡ç­¾ã€‚åœ¨è¯¥å‘½åç©ºé—´éƒ¨ç½²çš„æ‰€æœ‰æ–°å·¥ä½œè´Ÿè½½å°†é»˜è®¤æ³¨å…¥ Istio sidecarã€‚","link":"/2021/11/01/rancher/"},{"title":"kubernetes","text":"k8s ä¹‹å¿«é€Ÿå…¥é—¨å¿«é€Ÿå‡ºé—¨ K8s Kubernetes åŠŸèƒ½çš„è®¾è®¡æ–‡æ¡£å½’æ¡£ï¼Œä¸å¦¨è€ƒè™‘ä» Kubernetes æ¶æ„ å’Œ Kubernetes è®¾è®¡æ¦‚è¿° å¼€å§‹é˜…è¯»ã€‚ 1. å¿«é€Ÿå¼€å§‹ Kubernetes é›†ç¾¤Kubernetes åè°ƒä¸€ä¸ªé«˜å¯ç”¨è®¡ç®—æœºé›†ç¾¤ï¼Œæ¯ä¸ªè®¡ç®—æœºä½œä¸ºç‹¬ç«‹å•å…ƒäº’ç›¸è¿æ¥å·¥ä½œã€‚ Kubernetes ä¸­çš„æŠ½è±¡å…è®¸æ‚¨å°†å®¹å™¨åŒ–çš„åº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤ï¼Œè€Œæ— éœ€å°†å®ƒä»¬ç»‘å®šåˆ°æŸä¸ªç‰¹å®šçš„ç‹¬ç«‹è®¡ç®—æœºã€‚ä¸ºäº†ä½¿ç”¨è¿™ç§æ–°çš„éƒ¨ç½²æ¨¡å‹ï¼Œåº”ç”¨éœ€è¦ä»¥å°†åº”ç”¨ä¸å•ä¸ªä¸»æœºåˆ†ç¦»çš„æ–¹å¼æ‰“åŒ…ï¼šå®ƒä»¬éœ€è¦è¢«å®¹å™¨åŒ–ã€‚ä¸è¿‡å»çš„é‚£ç§åº”ç”¨ç›´æ¥ä»¥åŒ…çš„æ–¹å¼æ·±åº¦ä¸ä¸»æœºé›†æˆçš„éƒ¨ç½²æ¨¡å‹ç›¸æ¯”ï¼Œå®¹å™¨åŒ–åº”ç”¨æ›´çµæ´»ã€æ›´å¯ç”¨ã€‚ Kubernetes ä»¥æ›´é«˜æ•ˆçš„æ–¹å¼è·¨é›†ç¾¤è‡ªåŠ¨åˆ†å‘å’Œè°ƒåº¦åº”ç”¨å®¹å™¨ã€‚ Kubernetes æ˜¯ä¸€ä¸ªå¼€æºå¹³å°ï¼Œå¹¶ä¸”å¯åº”ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚ ä¸€ä¸ª Kubernetes é›†ç¾¤åŒ…å«ä¸¤ç§ç±»å‹çš„èµ„æº: Master è°ƒåº¦æ•´ä¸ªé›†ç¾¤ Nodes è´Ÿè´£è¿è¡Œåº”ç”¨(è™šæ‹Ÿæœº/æœåŠ¡å™¨) 1.1 å®‰è£…æ–¹æ³•ä¸€ï¼š ç¡®ä¿æœºå™¨ä¸Šå·²ç»å®‰è£…äº†docker å®‰è£…kubectlå‘½ä»¤è¡Œå·¥å…· å®‰è£…å¹¶ä½¿ç”¨minikubeè¿è¡Œä¸€ä¸ªå•èŠ‚ç‚¹çš„k8sé›†ç¾¤ æ–¹æ³•äºŒï¼š å®‰è£…Docker Desktop æ¥ç€ï¼ŒéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸã€‚ 1234kubectl version --clientkubectl cluster-info 2. å®˜æ–¹æ•™ç¨‹ ä¸€æ—¦è¿è¡Œäº† Kubernetes é›†ç¾¤ï¼Œå°±å¯ä»¥åœ¨å…¶ä¸Šéƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚ 2.1 åˆ›å»ºä¸€ä¸ªk8sé›†ç¾¤1234567891011# ç‰ˆæœ¬ä¿¡æ¯minikube version# å¯åŠ¨ä¸€ä¸ªå•ç»“ç‚¹çš„k8sé›†ç¾¤minikube start# é›†ç¾¤ä¿¡æ¯kubectl cluster-info# èŠ‚ç‚¹ä¿¡æ¯kubectl get nodes 2.2 éƒ¨ç½²åº”ç”¨ç¨‹åº 1234567# éƒ¨ç½²appçš„å‘½ä»¤ï¼Œé»˜è®¤æ·»åŠ äº†ä¸€ä¸ªPodï¼ˆç±»ä¼¼äº docker run ...ï¼‰kubectl create deployment [name] --image=[imageURL]kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1# æŸ¥çœ‹æ‰€æœ‰deploymentkubectl get deployments 2.3 åº”ç”¨ç¨‹åºæ¢ç´¢ Podè¿è¡Œåœ¨å·¥ä½œèŠ‚ç‚¹nodeä¸Šï¼Œæ¯ä¸ªå·¥ä½œèŠ‚ç‚¹å¯ä»¥æ˜¯è™šæ‹Ÿæœºæˆ–ç‰©ç†è®¡ç®—æœºã€‚æ‰€æœ‰çš„nodesç”±masterä¸»èŠ‚ç‚¹ç®¡ç†ã€‚ æ¯ä¸ª Kubernetes å·¥ä½œèŠ‚ç‚¹è‡³å°‘è¿è¡Œ: Kubeletï¼Œè´Ÿè´£ Kubernetes ä¸»èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹ä¹‹é—´é€šä¿¡çš„è¿‡ç¨‹; å®ƒç®¡ç† Pod å’Œæœºå™¨ä¸Šè¿è¡Œçš„å®¹å™¨ã€‚ **å®¹å™¨è¿è¡Œæ—¶(A container runtime)**ï¼ˆå¦‚ Dockerï¼‰è´Ÿè´£ä»ä»“åº“ä¸­æå–å®¹å™¨é•œåƒï¼Œè§£å‹ç¼©å®¹å™¨ä»¥åŠè¿è¡Œåº”ç”¨ç¨‹åºã€‚ Podæ˜¯ Kubernetes å¹³å°ä¸Šçš„åŸå­å•å…ƒã€‚ å½“æˆ‘ä»¬åœ¨ Kubernetes ä¸Šåˆ›å»º Deployment æ—¶ï¼Œè¯¥ Deployment ä¼šåœ¨å…¶ä¸­åˆ›å»ºåŒ…å«å®¹å™¨çš„ Pod ï¼ˆè€Œä¸æ˜¯ç›´æ¥åˆ›å»ºå®¹å™¨ï¼‰ã€‚æ¯ä¸ª Pod éƒ½ä¸è°ƒåº¦å®ƒçš„å·¥ä½œèŠ‚ç‚¹ç»‘å®šï¼Œå¹¶ä¿æŒåœ¨é‚£é‡Œç›´åˆ°ç»ˆæ­¢ï¼ˆæ ¹æ®é‡å¯ç­–ç•¥ï¼‰æˆ–åˆ é™¤ã€‚ å¦‚æœå·¥ä½œèŠ‚ç‚¹(æœåŠ¡å™¨)å‘ç”Ÿæ•…éšœï¼Œåˆ™ä¼šåœ¨ç¾¤é›†ä¸­çš„å…¶ä»–å¯ç”¨å·¥ä½œèŠ‚ç‚¹ä¸Šè°ƒåº¦ç›¸åŒçš„ Podã€‚ æœ€å¸¸è§çš„æ“ä½œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ kubectl å‘½ä»¤å®Œæˆï¼š kubectl get - åˆ—å‡ºèµ„æº kubectl describe - æ˜¾ç¤ºæœ‰å…³èµ„æºçš„è¯¦ç»†ä¿¡æ¯ kubectl logs [pod_name] - æ‰“å° pod å’Œå…¶ä¸­å®¹å™¨çš„æ—¥å¿— kubectl exec [-it] [pod_name] - åœ¨ pod ä¸­çš„å®¹å™¨ä¸Šæ‰§è¡Œå‘½ä»¤ 1234567# è·å–æ‰€æœ‰podskubectl get pods#We see here details about the Podâ€™s container: IP address, the ports used and a list of events related to the lifecycle of the Pod.kubectl describe pods 2.4 åº”ç”¨å¤–éƒ¨å¯è§é€šè¿‡ Serivce by service é€šè¿‡Serviceå®ç°äº†è®©podå¯ä»¥è¢«è®¿é—®ã€‚Serviceæœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š ClusterIP (é»˜è®¤) - åœ¨é›†ç¾¤çš„å†…éƒ¨ IP ä¸Šå…¬å¼€ Service ã€‚è¿™ç§ç±»å‹ä½¿å¾— Service åªèƒ½ä»é›†ç¾¤å†…è®¿é—®ã€‚ NodePort- ä½¿ç”¨ NAT åœ¨é›†ç¾¤ä¸­æ¯ä¸ªé€‰å®š Node çš„ç›¸åŒç«¯å£ä¸Šå…¬å¼€ Service ã€‚ä½¿ç”¨&lt;NodeIP&gt;:&lt;NodePort&gt; ä»é›†ç¾¤å¤–éƒ¨è®¿é—® Serviceã€‚æ˜¯ ClusterIP çš„è¶…é›†ã€‚ LoadBalancer - åœ¨å½“å‰äº‘ä¸­åˆ›å»ºä¸€ä¸ªå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨(å¦‚æœæ”¯æŒçš„è¯)ï¼Œå¹¶ä¸º Service åˆ†é…ä¸€ä¸ªå›ºå®šçš„å¤–éƒ¨IPã€‚æ˜¯ NodePort çš„è¶…é›†ã€‚ ExternalName - é€šè¿‡è¿”å›å¸¦æœ‰è¯¥åç§°çš„ CNAME è®°å½•ï¼Œä½¿ç”¨ä»»æ„åç§°(ç”± spec ä¸­çš„externalNameæŒ‡å®š)å…¬å¼€ Serviceã€‚ä¸ä½¿ç”¨ä»£ç†ã€‚è¿™ç§ç±»å‹éœ€è¦kube-dnsçš„v1.7æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚ 1234567891011# æŸ¥çœ‹æ‰€æœ‰ podskubectl get pods# æŸ¥çœ‹æ‰€æœ‰ serviceskubectl get services# åˆ›å»º servicekubectl expose deployment/kubernetes-bootcamp --type=&quot;NodePort&quot; --port 8080# æŸ¥çœ‹ service è¯¦æƒ…kubectl describe services/kubernetes-bootcamp Labels çš„ç”¨æ³•12345678910# æŸ¥çœ‹deploymentçš„labelkubectl describe deployment# é€šè¿‡labelæŸ¥è¯¢(-l)kubectl get pods -l app=kubernetes-bootcampkubectl get services -l app=kubernetes-bootcamp# é€šè¿‡labelåˆ é™¤æœåŠ¡kubectl delete service -l app=kubernetes-bootcamp 2.5 åº”ç”¨å¯æ‰©å±•æ‰©å±• Deploymentç›®çš„ï¼šç”¨ kubectl æ‰©ç¼©åº”ç”¨ç¨‹åº åœ¨ä¹‹å‰çš„æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª Deploymentï¼Œç„¶åé€šè¿‡ Serviceè®©å…¶å¯ä»¥å¼€æ”¾è®¿é—®ã€‚Deployment ä»…ä¸ºè·‘è¿™ä¸ªåº”ç”¨ç¨‹åºåˆ›å»ºäº†ä¸€ä¸ª Podã€‚ å½“æµé‡å¢åŠ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å®¹åº”ç”¨ç¨‹åºæ»¡è¶³ç”¨æˆ·éœ€æ±‚ã€‚ æ‰©ç¼© æ˜¯é€šè¿‡æ”¹å˜ Deployment ä¸­çš„å‰¯æœ¬æ•°é‡æ¥å®ç°çš„ã€‚ å°ç»“ï¼šæ‰©ç¼©ä¸€ä¸ªDeployment å¦å¤–ï¼Œåœ¨è¿è¡Œkubectl runå‘½ä»¤æ˜¯ï¼Œå¯ä»¥è®¾ç½® â€“ replicas å‚æ•°æ¥è®¾ç½®Deploymentçš„å‰¯æœ¬æ•°ã€‚ 123456789101112# å…ˆæŸ¥çœ‹å·²æœ‰çš„ deploymentkubectl get deployments# æ‰©å±•åˆ° 4 ä¸ª Podskubectl scale deployments/kubernetes-bootcamp --replicas=4# å˜æˆ 2 ä¸ª Podskubectl scale deployments/kubernetes-bootcamp --replicas=2# æŸ¥çœ‹ deployment å’Œ podskubectl get deploymentskubectl get pods -o wide 2.6 åº”ç”¨æ›´æ–°æ»šåŠ¨æ›´æ–°(Rolling Updates)çš„è¿‡ç¨‹ï¼š 123456789101112# æŸ¥çœ‹deploymets, podsä¿¡æ¯kubectl get deploymentskubectl get podskubectl describe pods# æ›´æ–°é•œåƒç‰ˆæœ¬ï¼šä½¿ç”¨ set image å‘½ä»¤kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2# éªŒè¯æ›´æ–°# æŸ¥çœ‹ipï¼Œç«¯å£ç­‰ä¿¡æ¯kubectl describe services/kubernetes-bootcamp 3. é…ç½®åœ¨ Kubernetes ä¸­ï¼Œä¸º docker å®¹å™¨è®¾ç½®ç¯å¢ƒå˜é‡æœ‰å‡ ç§ä¸åŒçš„æ–¹å¼ï¼Œæ¯”å¦‚ï¼š Dockerfileã€kubernetes.ymlã€Kubernetes ConfigMapsã€å’Œ Kubernetes Secretsã€‚ ä½¿ç”¨ ConfigMaps å’Œ Secrets çš„ä¸€ä¸ªå¥½å¤„æ˜¯ä»–ä»¬èƒ½åœ¨å¤šä¸ªå®¹å™¨é—´å¤ç”¨ï¼Œ æ¯”å¦‚èµ‹å€¼ç»™ä¸åŒçš„å®¹å™¨ä¸­çš„ä¸åŒç¯å¢ƒå˜é‡ã€‚ 3.1 é…ç½®javaå¾®æœåŠ¡ ä½¿ç”¨ MicroProfileã€ConfigMapsã€Secrets å®ç°å¤–éƒ¨åŒ–åº”ç”¨é…ç½® éƒ¨ç½²2ä¸ªjavaå¾®æœåŠ¡åˆ°k8sï¼Œç„¶åç”¨MicroProfileConfig, k8sConfigMaps å’Œ Secrets ä¿®æ”¹é…ç½®ã€‚ 1kubectl apply -f kubernetes.yaml 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889apiVersion: apps/v1kind: Deploymentmetadata: name: system-deployment labels: app: systemspec: selector: matchLabels: app: system template: metadata: labels: app: system spec: containers: - name: system-container image: system:1.0-SNAPSHOT ports: - containerPort: 9080 # Set the APP_NAME environment variable env: - name: APP_NAME valueFrom: configMapKeyRef: name: sys-app-name key: name---apiVersion: apps/v1kind: Deploymentmetadata: name: inventory-deployment labels: app: inventoryspec: selector: matchLabels: app: inventory template: metadata: labels: app: inventory spec: containers: - name: inventory-container image: inventory:1.0-SNAPSHOT ports: - containerPort: 9080 # Set the SYSTEM_APP_USERNAME and SYSTEM_APP_PASSWORD environment variables env: - name: SYSTEM_APP_USERNAME valueFrom: secretKeyRef: name: sys-app-credentials key: username - name: SYSTEM_APP_PASSWORD valueFrom: secretKeyRef: name: sys-app-credentials key: password---apiVersion: v1kind: Servicemetadata: name: system-servicespec: type: NodePort selector: app: system ports: - protocol: TCP port: 9080 targetPort: 9080 nodePort: 31000---apiVersion: v1kind: Servicemetadata: name: inventory-servicespec: type: NodePort selector: app: inventory ports: - protocol: TCP port: 9080 targetPort: 9080 nodePort: 32000 3.2 ä½¿ç”¨ConfigMapæ¥é…ç½®Redis12345678910111213141516171819202122232425262728293031323334apiVersion: v1kind: Podmetadata: name: redisspec: containers: - name: redis image: redis:5.0.4 command: - redis-server - &quot;/redis-master/redis.conf&quot; env: - name: MASTER value: &quot;true&quot; ports: - containerPort: 6379 resources: limits: cpu: &quot;0.1&quot; volumeMounts: - mountPath: /redis-master-data name: data - mountPath: /redis-master name: config volumes: - name: data emptyDir: {} - name: config configMap: name: example-redis-config items: - key: redis-config path: redis.conf 4. åº”ç”¨4.1 æ— çŠ¶æ€åº”ç”¨4.2 æœ‰çŠ¶æ€åº”ç”¨5. æœåŠ¡ã€è´Ÿè½½å‡è¡¡å’Œè”ç½‘5.1 IngressIngress å…¬å¼€äº†ä»é›†ç¾¤å¤–éƒ¨åˆ°é›†ç¾¤å†…æœåŠ¡çš„ HTTP å’Œ HTTPS è·¯ç”±ã€‚ æµé‡è·¯ç”±ç”± Ingress èµ„æºä¸Šå®šä¹‰çš„è§„åˆ™æ§åˆ¶ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªå°†æ‰€æœ‰æµé‡éƒ½å‘é€åˆ°åŒä¸€ Service çš„ç®€å• Ingress ç¤ºä¾‹ï¼š å¯ä»¥å°† Ingress é…ç½®ä¸ºæœåŠ¡æä¾›å¤–éƒ¨å¯è®¿é—®çš„ URLã€è´Ÿè½½å‡è¡¡æµé‡ã€ç»ˆæ­¢ SSL/TLSï¼Œä»¥åŠæä¾›åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºç­‰èƒ½åŠ›ã€‚ Ingress æ§åˆ¶å™¨ é€šå¸¸è´Ÿè´£é€šè¿‡è´Ÿè½½å‡è¡¡å™¨æ¥å®ç° Ingressï¼Œå°½ç®¡å®ƒä¹Ÿå¯ä»¥é…ç½®è¾¹ç¼˜è·¯ç”±å™¨æˆ–å…¶ä»–å‰ç«¯æ¥å¸®åŠ©å¤„ç†æµé‡ã€‚ Ingress ä¸ä¼šå…¬å¼€ä»»æ„ç«¯å£æˆ–åè®®ã€‚ å°† HTTP å’Œ HTTPS ä»¥å¤–çš„æœåŠ¡å…¬å¼€åˆ° Internet æ—¶ï¼Œé€šå¸¸ä½¿ç”¨ Service.Type=NodePort æˆ– Service.Type=LoadBalancer ç±»å‹çš„æœåŠ¡ã€‚ ä½ å¿…é¡»å…·æœ‰ Ingress æ§åˆ¶å™¨ æ‰èƒ½æ»¡è¶³ Ingress çš„è¦æ±‚ã€‚ ä»…åˆ›å»º Ingress èµ„æºæœ¬èº«æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚ä½ å¯èƒ½éœ€è¦éƒ¨ç½² Ingress æ§åˆ¶å™¨ï¼Œä¾‹å¦‚ ingress-nginxã€‚ ä½ å¯ä»¥ä»è®¸å¤š Ingress æ§åˆ¶å™¨ ä¸­è¿›è¡Œé€‰æ‹©ã€‚Ingressæ§åˆ¶å™¨æœ‰è®¸å¤šç§ï¼Œä¾‹å¦‚ï¼šnginx ingress, Istio Ingress ç­‰ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€å°çš„æ§åˆ¶å™¨èµ„æºservice/networking/minimal-ingress.yaml: 123456789101112131415161718apiVersion: networking.k8s.io/v1kind: Ingressmetadata: name: minimal-ingress annotations: nginx.ingress.kubernetes.io/rewrite-target: /spec: rules: - http: paths: - path: /testpath pathType: Prefix backend: service: name: test port: number: 80","link":"/2021/11/01/kubernetes/"},{"title":"TensorFlow","text":"â€¦ Tensorflowä»é›¶å¼€å§‹å­¦1. æœºå™¨å­¦ä¹ åŸºç¡€ Tensorflow2.0 æ¶æ„å›¾ 1.1 æœºå™¨å­¦ä¹ åˆ†ç±»æœºå™¨å­¦ä¹ ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š æœ‰ç›‘ç£å­¦ä¹ (Supervised Learning)ï¼šæ ¹æ®æœ‰ç‰¹å¾çš„æ•°æ®è¿›è¡Œè®­ç»ƒã€å»ºæ¨¡ã€‚åŒ…æ‹¬åˆ†ç±»ã€å›å½’ã€‚å¸¸è§ç®—æ³•æœ‰çº¿æ€§å›å½’ã€é€»è¾‘å›å½’ã€K-è¿‘é‚»æœ´ç´ è´å¶æ–¯ã€å†³ç­–æ ‘ã€éšæœºæ£®æ—ã€æ”¯æŒå‘é‡æœºã€‚ æ— ç›‘ç£å­¦ä¹ ï¼šç›´æ¥å»ºæ¨¡ã€‚å¸¸è§ç®—æ³•æœ‰K-meansã€EM åŠç›‘ç£å­¦ä¹  å¼ºåŒ–å­¦ä¹ (Reinforcement Learning): åŸºäºå‘¨å›´ç¯å¢ƒå­¦ä¹ ã€‚ 1.2 æœºå™¨å­¦ä¹ æµç¨‹ å¼•å…¥æ•°æ®é›† &amp; æ•°æ®é¢„å¤„ç† (ç‰¹å¾å·¥ç¨‹ï¼šscikit-learnå¤„ç†æ•°æ®å’Œæå–ç‰¹å¾) **è®­ç»ƒå’Œæµ‹è¯•æ¨¡å‹ **(åˆ¤æ–­é—®é¢˜ç±»å‹ï¼Œé€‰æ‹©ç®—æ³•å’Œæ¨¡å‹) è¯„ä¼°æ¨¡å‹ æ•°æ®é¢„å¤„ç†çš„å‡ ç§å¸¸è§ç®€å•æ–¹æ³•ï¼š å½’ä¸€åŒ–ï¼šå…¶ä½œç”¨åŒ…æ‹¬æ— é‡çº²åŒ–ã€åŠ å¿«æ¨¡å‹çš„æ”¶æ•›é€Ÿåº¦ç­‰ã€‚ä½¿ç”¨min-max/Z-scoreç®—æ³•ã€‚ æ ‡å‡†åŒ–ï¼šå°†æ•°æ®æŒ‰æ¯”ä¾‹ç¼©æ”¾ä¸ºä¸€ä¸ªé™å®šåŒºé—´ã€‚ä½¿ç”¨åœºæ™¯å¦‚è·ç¦»åº¦é‡ã€æ•°æ®ç¬¦åˆæ­£æ€åˆ†å¸ƒã€‚ ç¦»æ•£åŒ–ï¼šæŠŠè¿ç»­çš„æ•°å€¼å‹æ•°æ®è¿›è¡Œå¾ˆçŸ­ã€‚æœ‰åŠ©äºæ¶ˆé™¤å¼‚å¸¸æ•°æ®ï¼Œæé«˜ç®—æ³•çš„æ•ˆç‡ã€‚ äºŒå€¼åŒ–ï¼šç®€åŒ–æ•°æ®ï¼Œæ¶ˆé™¤æ•°æ®æ‚éŸ³ã€‚ å“‘ç¼–ç ï¼šç‹¬çƒ­ç¼–ç (One-Hot Encoding)ã€‚å¯¹ç‰¹å¾(å¦‚å½¢çŠ¶ã€å¤§å°ç­‰)è¿›è¡Œç¼–ç åŒ–ã€‚ ç‰¹å¾å·¥ç¨‹ï¼šæŠŠåŸå§‹æ•°æ®è½¬æ¢ä¸ºæ¨¡å‹å¯ç”¨çš„æ•°æ®ã€‚ä¸»è¦åŒ…æ‹¬3æ–¹é¢ï¼šç‰¹å¾æ„é€ ã€ç‰¹å¾æå–å’Œç‰¹å¾é€‰æ‹©ã€‚ ç‰¹å¾æ„é€ ï¼šåœ¨åŸæœ‰ç‰¹å¾çš„åŸºç¡€ä¸Šåšç»„åˆæ“ä½œã€‚ä¾‹å¦‚å¯¹åŸæœ‰ç‰¹å¾è¿›è¡Œå››åˆ™è¿ç®—ï¼Œä»è€Œå¾—åˆ°æ–°çš„ç‰¹å¾ã€‚ ç‰¹å¾æå–ï¼šä½¿ç”¨æ˜ å°„æˆ–å˜æ¢çš„æ–¹æ³•ï¼Œé™é«˜ç»´ç‰¹å¾è½¬æ¢ä¸ºä½ç»´çš„æ–°ç‰¹å¾ã€‚å³é™ä½ç»´åº¦ï¼ˆsklearnï¼‰ã€‚ å¸¸ç”¨æ–¹æ³•æœ‰ä¸»æˆåˆ†åˆ†æï¼ˆPrincipe Component Analysisï¼ŒPCAï¼‰ã€çº¿æ€§åˆ¤åˆ«åˆ†æï¼ˆLinear Discriminant Analysisï¼ŒLDAï¼‰å’Œç‹¬ç«‹æˆåˆ†åˆ†æï¼ˆIndependent Component Analysisï¼ŒICAï¼‰ PCAï¼šæ— ç›‘ç£é™ç»´ç®—æ³•ã€‚ä¸»è¦å®ç°æ˜¯ç”¨â€œå‡å°‘å™ªå£°â€å’Œâ€œå»å†—ä½™â€æ¥é™ç»´ã€‚ LDAï¼šæœ‰ç›‘ç£é™ç»´ç®—æ³•ã€‚å€ŸåŠ©åæ–¹å·®çŸ©é˜µã€å¹¿ä¹‰ç‘åˆ©ç†µç­‰å®ç°ç±»é—´è·ç¦»çš„æœ€å¤§åŒ–å’Œæœ€å°åŒ–ã€‚ ICAï¼šé™ç»´çš„è¿‡ç¨‹ä¸­ä¿ç•™ç›¸äº’ç‹¬ç«‹çš„ç»´åº¦ç‰¹å¾ã€‚ ç‰¹å¾é€‰æ‹©ï¼šé€‰æ‹©å¯¹æ¨¡å‹å½±å“å¤§çš„ç‰¹å¾ï¼Œç§»é™¤ä¸å¤ªç›¸å…³çš„ç‰¹å¾ã€‚ä½œç”¨æ˜¯å‡å°‘è¿‡æ‹Ÿåˆã€æé«˜æ¨¡å‹å‡†ç¡®åº¦ã€å‡å°‘è®­ç»ƒæ—¶é—´ã€‚ è¿‡æ»¤å¼ï¼šPearsonç›¸å…³ç³»æ•°æ³•ã€æ–¹å·®é€‰æ‹©æ³•ã€å‡è®¾æ£€éªŒã€äº’ä¿¡æ¯æ³•ç­‰ã€‚ åŒ…è£¹å¼ åµŒå…¥å¼ æ¨¡å‹çš„è¯„ä¼°å’Œé€‰æ‹© åŸºæœ¬æ¦‚å¿µï¼š å‚æ•°ï¼šæ¨¡å‹çš„å†…éƒ¨å˜é‡ã€‚å¦‚æ¨¡å‹çš„æƒé‡çŸ©é˜µå’Œåç½®ã€‚ è¶…å‚æ•°ï¼šæ¨¡å‹ä¸­å¯äººä¸ºè®¾å®šå’Œä¿®æ”¹çš„å‚æ•°ï¼Œæˆ–è€…ç§°ä¸ºè®­ç»ƒè¿‡ç¨‹ä¸­ä¸å˜çš„å‚æ•°ï¼Œå¦‚ç¥ç»ç½‘ç»œçš„å±‚æ•°ã€å­¦ä¹ ç‡ã€éšè—å±‚ç¥ç»å…ƒçš„ä¸ªæ•°ç­‰ã€‚ è¯„ä¼°çš„å¸¸è§æ–¹æ³•ï¼šç•™å‡ºæ³•ã€äº¤å‰éªŒè¯æ³•ã€ç•™ä¸€æ³•ã€è‡ªåŠ©æ³•ã€‚ ç•™å‡ºæ³•ï¼šæŒ‰æ¯”ä¾‹å°†æ•°æ®é›†åˆ’åˆ†è®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›† éªŒè¯é›†ï¼Œæ˜¯æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å•ç‹¬ç•™å‡ºçš„æ ·æœ¬é›†ï¼Œå®ƒå¯ä»¥ç”¨äºè°ƒæ•´æ¨¡å‹çš„è¶…å‚æ•°å’Œç”¨äºå¯¹æ¨¡å‹çš„èƒ½åŠ›è¿›è¡Œåˆæ­¥è¯„ä¼°ã€‚ é€šå¸¸ç”¨æ¥åœ¨æ¨¡å‹è¿­ä»£è®­ç»ƒæ—¶ï¼Œç”¨ä»¥éªŒè¯å½“å‰æ¨¡å‹æ³›åŒ–èƒ½åŠ›ï¼ˆå‡†ç¡®ç‡ï¼Œå¬å›ç‡ç­‰ï¼‰ï¼Œä»¥å†³å®šæ˜¯å¦åœæ­¢ç»§ç»­è®­ç»ƒã€‚ äº¤å‰éªŒè¯æ³•ï¼šåˆ’åˆ†ä¸ºkä¸ªæ•°æ®é›†ï¼Œå…¶ä¸­ä¸€ä¸ªä½œä¸ºéªŒè¯é›†ï¼Œå‰©ä¸‹çš„k-1ä¸ªä½œä¸ºè®­ç»ƒé›†ã€‚å°†å¾—åˆ°çš„kä¸ªç»“æœå–å¹³å‡å€¼ï¼Œä½œä¸ºæœ€ç»ˆæ¨¡å‹è¯„ä¼°çš„ç»“æœã€‚è¿™ç§æ–¹æ³•ç§°ä¸ºâ€œkæŠ˜äº¤å‰éªŒè¯â€ã€‚ æ¨¡å‹çš„æ€§èƒ½åº¦é‡ï¼šæ­£ç¡®ç‡(Accuracy)ã€é”™è¯¯ç‡(Error Rate)ã€æŸ¥å‡†ç‡(Precision)ã€æŸ¥å…¨ç‡/å¬å›ç‡(Recall) Precisionå’ŒRecallçš„æŒ‡æ ‡è¡¡é‡ä½¿ç”¨F1å…¬å¼ã€‚ 1.3 æœ¯è¯­ è®¡ç®—å›¾ï¼šåŠ¨æ€è®¡ç®—å›¾(Eager Execution) ä¼šè¯ è¿ç®—æ“ä½œå’Œè¿ç®—æ ¸ å¼ é‡(Tensor)ï¼šå¤šç»´çš„æ•°ç»„æˆ–åˆ—è¡¨ã€‚ Learning Rate åœ¨æœºå™¨å­¦ä¹ å’Œç»Ÿè®¡å­¦ä¸­ï¼Œå­¦ä¹ ç‡æ˜¯ä¼˜åŒ–ç®—æ³•ä¸­çš„ä¸€ä¸ªè°ƒæ•´å‚æ•°ï¼Œå®ƒç¡®å®šæ¯æ¬¡è¿­ä»£æ—¶æ¢¯åº¦ä¸‹é™çš„æ­¥é•¿ï¼ŒåŒæ—¶æœç€æŸå¤±å‡½æ•°çš„æœ€å°å€¼ç§»åŠ¨ã€‚[1]ç”±äºå®ƒä¼šå½±å“æ–°è·å–çš„ä¿¡æ¯è¦†ç›–æ—§ä¿¡æ¯çš„ç¨‹åº¦ï¼Œå› æ­¤å®ƒéšå–»åœ°ä»£è¡¨äº†æœºå™¨å­¦ä¹ æ¨¡å‹â€œå­¦ä¹ â€çš„é€Ÿåº¦ã€‚åœ¨è‡ªé€‚åº”æ§åˆ¶æ–‡çŒ®ä¸­ï¼Œå­¦ä¹ ç‡é€šå¸¸ç§°ä¸ºå¢ç›Šã€‚[2] å¦‚æœçŸ¥é“æ„ŸçŸ¥æœºåŸç†çš„è¯ï¼Œé‚£å¾ˆå¿«å°±èƒ½çŸ¥é“ï¼ŒLearning Rateæ˜¯è°ƒæ•´ç¥ç»ç½‘ç»œè¾“å…¥æƒé‡çš„ä¸€ç§æ–¹æ³•ã€‚å¦‚æœæ„ŸçŸ¥æœºé¢„æµ‹æ­£ç¡®ï¼Œåˆ™å¯¹åº”çš„è¾“å…¥æƒé‡ä¸ä¼šå˜åŒ–ï¼Œå¦åˆ™ä¼šæ ¹æ®Loss Functionæ¥å¯¹æ„ŸçŸ¥æœºé‡æ–°è°ƒæ•´ï¼Œè€Œè¿™ä¸ªè°ƒæ•´çš„å¹…åº¦å¤§å°å°±æ˜¯Learning Rateï¼Œä¹Ÿå°±æ˜¯åœ¨è°ƒæ•´çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªæ¯”å€¼ã€‚ å¦‚ä¸‹å›¾çš„æƒé‡wï¼Œåœ¨è¾“å‡ºä¹‹åé¢„æµ‹æ­£ç¡®ä¸å¦ï¼Œè‹¥æ­£ç¡®åˆ™ä¿æŒæƒé‡wä¸å˜ï¼Œè‹¥é”™è¯¯åˆ™ç”¨å³è¾¹çš„å…¬å¼æ¥å¯¹æƒé‡wè¿›è¡Œè°ƒæ•´ï¼Œå¦‚ä¸‹å›¾ï¼š é‚£ä¸€èˆ¬Learning Rateçš„å–å€¼éƒ½åœ¨0.0001åˆ°0.01ä¹‹é—´ï¼Œè¿™ä¸ªæ•ˆæœå°±åƒä½ èµ°è·¯çš„æ­¥å­ï¼Œæ­¥å­è¿ˆè¾¾äº†ï¼Œå¾ˆå®¹æ˜“é”™è¿‡æœ€ä½³ç‚¹(æŒ‡ä½¿lossæŸå¤±å‡½æ•°ä¸ºæœ€å°å€¼æ—¶çš„ LR)ï¼Œè€Œè¿ˆå°äº†åˆéœ€è¦èŠ±æ›´é•¿çš„æ—¶é—´æ‰èƒ½åˆ°æœ€ä½³ç‚¹ã€‚ æ‰€ä»¥ï¼Œç›´è§‚ä¸Šæ¥çœ‹ï¼Œåœ¨è¿™æœ€å¥½çš„åŠæ³•æ˜¯ï¼šå…ˆèµ°å¿«ä¸€äº›ï¼ˆå¤§ä¸€äº›çš„Learning Rateï¼‰ï¼Œç„¶åè¦åˆ°æœ€ä½³ç‚¹çš„æ—¶å€™ï¼Œå†é™ä½Learning Rateæ¥åˆ°è¾¾æœ€ä½³ç‚¹ã€‚ æ¢¯åº¦ä¸‹é™(Gradient Descent)ç®—æ³• loss å’Œ val_loss : loss æ˜¯è®­ç»ƒé›†çš„æŸå¤±å€¼ï¼Œval_loss(validation) æ˜¯éªŒè¯é›†çš„æŸå¤±å€¼ã€‚ ä»¥ä¸‹æ˜¯lossä¸val_lossçš„å˜åŒ–åæ˜ å‡ºè®­ç»ƒèµ°å‘çš„è§„å¾‹æ€»ç»“ï¼š train loss ä¸æ–­ä¸‹é™ï¼Œtest lossä¸æ–­ä¸‹é™ï¼Œè¯´æ˜ç½‘ç»œä»åœ¨å­¦ä¹ ;ï¼ˆæœ€å¥½çš„ï¼‰ train loss ä¸æ–­ä¸‹é™ï¼Œtest lossè¶‹äºä¸å˜ï¼Œè¯´æ˜ç½‘ç»œè¿‡æ‹Ÿåˆ;ï¼ˆmax poolæˆ–è€…æ­£åˆ™åŒ–ï¼‰ train loss è¶‹äºä¸å˜ï¼Œtest lossä¸æ–­ä¸‹é™ï¼Œè¯´æ˜æ•°æ®é›†100%æœ‰é—®é¢˜;ï¼ˆæ£€æŸ¥datasetï¼‰ train loss è¶‹äºä¸å˜ï¼Œtest lossè¶‹äºä¸å˜ï¼Œè¯´æ˜å­¦ä¹ é‡åˆ°ç“¶é¢ˆï¼Œéœ€è¦å‡å°å­¦ä¹ ç‡æˆ–æ‰¹é‡æ•°ç›®;ï¼ˆå‡å°‘å­¦ä¹ ç‡ï¼‰ train loss ä¸æ–­ä¸Šå‡ï¼Œtest lossä¸æ–­ä¸Šå‡ï¼Œè¯´æ˜ç½‘ç»œç»“æ„è®¾è®¡ä¸å½“ï¼Œè®­ç»ƒè¶…å‚æ•°è®¾ç½®ä¸å½“ï¼Œæ•°æ®é›†ç»è¿‡æ¸…æ´—ç­‰é—®é¢˜ã€‚ï¼ˆæœ€ä¸å¥½çš„æƒ…å†µï¼‰ 1.4 Wide&amp;Deep æ¨¡å‹ è®ºæ–‡åœ°å€(Wide &amp; Deep Learning for Recommender Systems )ï¼šhttps://arxiv.org/pdf/1606.07792v1.pdf https://www.jianshu.com/p/5b807e6c3801 ç¨€ç–ç‰¹å¾+å¯†é›†ç‰¹å¾ 2. æ•°æ®é¢„å¤„ç†2.1 å½’ä¸€åŒ–å½’ä¸€åŒ–ï¼šå°†æ•°æ®é›†è½¬æ¢ä¸º(0,1)åŒºé—´èŒƒå›´æˆ–è€…æ— é‡çº²åŒ–(dimensionlessï¼Œå»ç»´åº¦)ï¼Œä½¿å…¶ä½äºæ¿€æ´»å‡½æ•°æœ‰æ˜æ˜¾æ¢¯åº¦çš„ä½ç½®ï¼Œæ‰èƒ½ä½¿æ¯ä¸€å±‚ç¥ç»ç½‘ç»œä¹‹é—´æ„ŸçŸ¥åˆ°æ˜æ˜¾å˜åŒ–çš„lossæŸå¤±å‡½æ•°å€¼ã€‚å¦‚æœåœ¨æ¢¯åº¦ä¸æ˜æ˜¾çš„åœ°æ–¹(å¦‚å‡½æ•°å¹³ç¼“ï¼Œå³å¯¼æ•°æ¥è¿‘0ï¼›ç¥ç»ç½‘ç»œå±‚æ•°å¤šï¼Œå¯¼è‡´æ¯ä¸€å±‚ç¥ç»ç½‘ç»œçš„losså˜åŒ–ä¸å¤§)ï¼ŒçŸ­æ—¶é—´å†…çš„è®­ç»ƒæ•ˆæœä¼šä¸æ˜æ˜¾ã€‚ä¸‹é¢æ˜¯ 2 ç§å½’ä¸€åŒ–æ–¹æ³•ï¼ˆå‡å€¼MSEï¼Œæ–¹å·®STDï¼‰ï¼š æ‰¹å½’ä¸€åŒ–ï¼šå¯¹æ¯å±‚ç¥ç»è®­ç»ƒåçš„æ•°æ®å†è¿›è¡Œå½’ä¸€åŒ–ã€‚å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/skyfsm/p/8453498.html aä¸­å·¦å›¾æ˜¯æ²¡æœ‰ç»è¿‡ä»»ä½•å¤„ç†çš„è¾“å…¥æ•°æ®ï¼Œæ›²çº¿æ˜¯sigmoidå‡½æ•°ï¼Œå¦‚æœæ•°æ®åœ¨æ¢¯åº¦å¾ˆå°çš„åŒºåŸŸï¼Œé‚£ä¹ˆå­¦ä¹ ç‡å°±ä¼šå¾ˆæ…¢ç”šè‡³é™·å…¥é•¿æ—¶é—´çš„åœæ»ã€‚å‡å‡å€¼é™¤æ–¹å·®åï¼Œæ•°æ®å°±è¢«ç§»åˆ°ä¸­å¿ƒåŒºåŸŸå¦‚å³å›¾æ‰€ç¤ºï¼Œå¯¹äºå¤§å¤šæ•°æ¿€æ´»å‡½æ•°è€Œè¨€ï¼Œè¿™ä¸ªåŒºåŸŸçš„æ¢¯åº¦éƒ½æ˜¯æœ€å¤§çš„æˆ–è€…æ˜¯æœ‰æ¢¯åº¦çš„ï¼ˆæ¯”å¦‚ReLUï¼‰ï¼Œè¿™å¯ä»¥çœ‹åšæ˜¯ä¸€ç§å¯¹æŠ—æ¢¯åº¦æ¶ˆå¤±çš„æœ‰æ•ˆæ‰‹æ®µã€‚ 2.2 One-Hot ç¼–ç ä½œä¸ºæœºå™¨å­¦ä¹ ç®—æ³•çš„è¾“å…¥ï¼Œé€šå¸¸éœ€è¦å¯¹å…¶è¿›è¡Œç‰¹å¾æ•°å­—åŒ–ã€‚æ•…ä½¿ç”¨one-hotç¼–ç å¯ä»¥å°†å…·å¤‡ç¦»æ•£å€¼ç‰¹å¾çš„åˆ†ç±»æ•°æ®è½¬åŒ–ä¸ºäºŒè¿›åˆ¶å‘é‡ã€‚ä¾‹å¦‚ï¼ŒæŒ‰ç…§ Nä½çŠ¶æ€å¯„å­˜å™¨ æ¥ å¯¹Nä¸ªçŠ¶æ€ è¿›è¡Œç¼–ç çš„åŸç†ï¼Œå¤„ç†ååº”è¯¥æ˜¯è¿™æ ·çš„ï¼š 12345678910111213æ€§åˆ«ç‰¹å¾ï¼š[&quot;ç”·&quot;,&quot;å¥³&quot;] ï¼ˆè¿™é‡Œåªæœ‰ä¸¤ä¸ªç‰¹å¾ï¼Œæ‰€ä»¥ N=2ï¼‰ï¼šç”· =&gt; 10å¥³ =&gt; 01ç¥–å›½ç‰¹å¾ï¼š[&quot;ä¸­å›½&quot;ï¼Œ&quot;ç¾å›½ï¼Œ&quot;æ³•å›½&quot;]ï¼ˆN=3ï¼‰ï¼šä¸­å›½ =&gt; 100ç¾å›½ =&gt; 010æ³•å›½ =&gt; 001 3. å‰é¦ˆç¥ç»ç½‘ç»œ3.1 ç¥ç»ç½‘ç»œ æ„ŸçŸ¥å™¨æ¨¡å‹ã€å¤šå±‚ç¥ç»ç½‘ç»œ æ„ŸçŸ¥å™¨æ¨¡å‹(å•å±‚ç¥ç»ç½‘ç»œï¼Œæ˜¯ä¸€ç§ä¸¤ç±»çº¿æ€§åˆ†ç±»æ¨¡å‹) å¤šå±‚ç¥ç»ç½‘ç»œï¼ˆå¯é€šè¿‡éšè—å±‚çš„éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼Œè§£å†³éçº¿æ€§é—®é¢˜ï¼‰ 3.2 æ¿€æ´»å‡½æ•°æ¿€æ´»å‡½æ•°çš„æ¦‚å¿µå’Œä½œç”¨ ä¸ºä»€ä¹ˆè¦ç”¨æ¿€æ´»å‡½æ•°ï¼Ÿ å¦‚æœä¸ç”¨æ¿€æ´»å‡½æ•°ï¼Œæ¯ä¸€å±‚è¾“å‡ºéƒ½æ˜¯ä¸Šå±‚è¾“å…¥çš„çº¿æ€§å‡½æ•°ï¼Œæ— è®ºç¥ç»ç½‘ç»œæœ‰å¤šå°‘å±‚ï¼Œè¾“å‡ºéƒ½æ˜¯è¾“å…¥çš„çº¿æ€§ç»„åˆï¼Œè¿™ç§æƒ…å†µå°±æ˜¯æœ€åŸå§‹çš„æ„ŸçŸ¥æœºï¼ˆPerceptronï¼‰ã€‚å¦‚æœä½¿ç”¨çš„è¯ï¼Œæ¿€æ´»å‡½æ•°ç»™ç¥ç»å…ƒå¼•å…¥äº†éçº¿æ€§å› ç´ ï¼Œä½¿å¾—ç¥ç»ç½‘ç»œå¯ä»¥ä»»æ„é€¼è¿‘ä»»ä½•éçº¿æ€§å‡½æ•°ï¼Œè¿™æ ·ç¥ç»ç½‘ç»œå°±å¯ä»¥åº”ç”¨åˆ°ä¼—å¤šçš„éçº¿æ€§æ¨¡å‹ä¸­ã€‚ ä¸ºäº†è§£å†³éçº¿æ€§çš„åˆ†ç±»æˆ–å›å½’é—®é¢˜ï¼Œæ¿€æ´»å‡½æ•°å¿…é¡»æ˜¯éçº¿æ€§å‡½æ•°ã€‚å¦å¤–ä½¿ç”¨åŸºäºæ¢¯åº¦(æ…¢æ…¢è¶‹äºæŸä¸ªå€¼ï¼Œæ‰èƒ½åˆ†ç±»)çš„æ–¹å¼æ¥è®­ç»ƒæ¨¡å‹ï¼Œå› æ­¤æ¿€æ´»å‡½æ•°ä¹Ÿå¿…é¡»æ˜¯è¿ç»­å¯å¯¼çš„ã€‚ æ¿€æ´»å‡½æ•°ï¼šLogistic(Sigmoid)å‡½æ•°ã€Tanhå‡½æ•°ã€ReLUå‡½æ•°(å¸¸ç”¨) æ¿€æ´»å‡½æ•°ï¼š æ¢¯åº¦æ¶ˆå¤±ï¼šéšç€ç¥ç»ç½‘ç»œå±‚æ•°çš„åŠ æ·±ï¼Œæ¢¯åº¦åå‘ä¼ æ’­åˆ°æµ…å±‚ç½‘ç»œæ—¶ï¼ŒåŸºæœ¬æ— æ³•å¼•èµ·å‚æ•°çš„æ‰°åŠ¨ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å°†lossçš„ä¿¡æ¯ä¼ é€’åˆ°æµ…å±‚ç½‘ç»œï¼Œè¿™æ ·ç½‘ç»œå°±æ— æ³•è®­ç»ƒå­¦ä¹ äº†ã€‚(å³éšç€éšè—å±‚æ•°ç›®çš„å¢åŠ ï¼Œåˆ†ç±»å‡†ç¡®ç‡åè€Œä¸‹é™äº†ï¼›æ›´ä¸ºç›´ç™½çš„è¡¨è¾¾ï¼Œå°±æ˜¯æ¢¯åº¦æ¶ˆå¤±ï¼Œå‡½æ•°æˆä¸ºæ¨ªçº¿å˜ä¸ºä¸å¯å¯¼ã€‚) Causeï¼šSigå‡½æ•°æ±‚å¯¼åçš„å¯¼æ•°æœ€å¤§å€¼ä¸º0.25(å½“x=0æ—¶)ã€‚ç¥ç»ç½‘ç»œä¸»è¦çš„è®­ç»ƒæ–¹æ³•æ˜¯BPç®—æ³•ï¼Œè€Œåå‘ä¼ æ’­ç®—æ³•(Back Propagation)çš„åŸºç¡€æ˜¯å¯¼æ•°çš„é“¾å¼æ³•åˆ™ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªå¯¼æ•°çš„ä¹˜ç§¯ã€‚å½“å±‚æ•°è¿‡å¤šæ—¶ï¼Œå¯¼æ•°ä¹˜ç§¯ä¼šå˜å¾—éå¸¸å°ï¼Œå°±ä¼šé€ æˆæ¢¯åº¦æ¶ˆå¤±ç°è±¡äº†ã€‚ Relu è¡ç”Ÿå‡½æ•° 3.3 è¾“å‡ºå•å…ƒè¾“å‡ºå•å…ƒï¼š1.çº¿æ€§å•å…ƒ(å›å½’) 2.Sigmoidå•å…ƒ(äºŒåˆ†ç±») 3.Softmaxå•å…ƒ(å¤šåˆ†ç±») 3.4 æŸå¤±å‡½æ•° æŸå¤±å‡½æ•°(ç›®æ ‡å‡½æ•°)**ç”¨æ¥è¡¨è¾¾æ¨¡å‹çš„é¢„æµ‹å€¼å’ŒçœŸå®ç±»æ ‡ä¹‹é—´çš„è¯¯å·®ã€‚æ·±åº¦å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒå°±æ˜¯ä½¿ç”¨åŸºäºæ¢¯åº¦çš„æ–¹æ³•ä½¿æŸå¤±å‡½æ•°æœ€å°åŒ–**çš„è¿‡ç¨‹ã€‚æŸå¤±å‡½æ•°å’Œè¾“å‡ºå•å…ƒæœ‰å¯†åˆ‡çš„å…³ç³»ï¼Ÿ æŸå¤±å‡½æ•°ï¼š 1.å‡æ–¹è¯¯å·®æŸå¤±å‡½æ•°(Mean Squared Error, MSE)ï¼Œç”¨äºå›å½’é—®é¢˜ã€‚ 2.äº¤å‰ç†µæŸå¤±å‡½æ•°(Cross Entropy)ï¼Œç”¨äºåˆ†ç±»é—®é¢˜ã€‚ 3.5 ä¼˜åŒ–å™¨ sgdï¼šéšæœºæ¢¯åº¦ä¸‹é™ adamï¼š RMSPropï¼šhttps://zhuanlan.zhihu.com/p/34230849 3.6 ç¤ºä¾‹ï¼šMNISTæ‰‹å†™æ•°å­—è¯†åˆ«è¿™æ˜¯ä¸€ä¸ªæœ‰ç›‘ç£çš„åˆ†ç±»é—®é¢˜ã€‚ï¼ˆæ­¤å¤„æŒ‡ç±»æ ‡labelï¼Œè€Œä¸æ˜¯ç±»åˆ«categoryï¼‰ 4. å·ç§¯ç¥ç»ç½‘ç»œ å·ç§¯ç¥ç»ç½‘ç»œ(Convolutional Neural Networkï¼ŒCNN)æ˜¯ä¸€ç§ä¸“é—¨ç”¨æ¥å¤„ç†ç½‘æ ¼ç»“æ„æ•°æ®(å¦‚å›¾åƒæ•°æ®)çš„å‰é¦ˆç¥ç»ç½‘ç»œã€‚ç›¸å¯¹å…¨è¿æ¥ç¥ç»ç½‘ç»œå‚æ•°æ›´å°‘ï¼Œå‡å°‘äº†æ¨¡å‹è®­ç»ƒçš„å¤æ‚æ€§å’Œè¿‡æ‹Ÿåˆé—®é¢˜ï¼Œä½¿æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›æ›´å¼ºã€‚ 4.1 CNNçš„åŸºæœ¬ç‰¹å¾ä¸ç»“æ„CNNä¸»è¦æœ‰3å¤§ç‰¹å¾ï¼š1.å±€éƒ¨è¿æ¥ 2.æƒå€¼å…±äº« 3.å­é‡‡æ ·(æ± åŒ–) 4.2 å·ç§¯å±‚å·ç§¯å…¬å¼ï¼š å·ç§¯çš„ç¤ºä¾‹ï¼š å·ç§¯çš„ä½œç”¨ï¼šå°†å„ç§ä½çº§ç‰¹å¾(è¾“å…¥å±‚çš„å›¾åƒçš„ç‰¹å¾)å·ç§¯æˆé«˜çº§ç‰¹å¾(ç‰¹å¾å›¾)ã€‚ å·ç§¯å±‚çš„åŸºæœ¬ç»“æ„ 4.3 æ± åŒ–å±‚ æ± åŒ–å±‚(Pooling Layer)ä¹Ÿç§°ä¸ºå­é‡‡æ ·å±‚(Subsampling Layer)ï¼Œä¸€èˆ¬éƒ½ç´§è·Ÿåœ¨å·ç§¯å±‚ä¹‹åï¼Œå®ƒçš„ä½œç”¨æ˜¯è¿›è¡Œç‰¹å¾é€‰æ‹©(å¯¹ç‰¹å¾å›¾è¿›è¡Œé‡‡æ ·)ï¼Œå‡å°‘ç‰¹å¾çš„æ•°é‡ï¼Œä»è€Œå‡å°‘ç½‘ç»œå‚æ•°çš„æ•°é‡ã€‚ æ± åŒ–å±‚çš„è¿‡ç¨‹å…¶å®åœ¨å·ç§¯å±‚ä¹Ÿèƒ½å®Œæˆã€‚ 4.4 CNNå›¾åƒåˆ†ç±»5. å¾ªç¯ç¥ç»ç½‘ç»œ å¾ªç¯ç¥ç»ç½‘ç»œ(Recurrent Neural Network, RNN)ï¼Œç”¨äºè§£å†³å…·æœ‰æ•°æ®æ—¶åºå‰åå…³è”æ€§(å¦‚æ–‡æœ¬ã€è¯­éŸ³ã€è§†é¢‘ã€æ— äººé©¾é©¶ç­‰)çš„é—®é¢˜ã€‚å¼ºåŒ–å­¦ä¹ åº”è¯¥æ˜¯å®æ—¶çš„ã€‚ 5.1 RNN RNNçš„åŸºæœ¬ç»“æ„ã€å‰é¢è®¡ç®—çš„è¿‡ç¨‹ã€å‚æ•°ä¼˜åŒ–çš„é—®é¢˜ è®°å¿†å•å…ƒèƒ½è®°ä½æœ‰é™æ—¶é—´èŒƒå›´å†…çš„ä¿¡æ¯ï¼ŒåŒæ—¶èƒ½å°†è¿™äº›ä¿¡æ¯ä¼ é€’åˆ°ä¸‹ä¸€å±‚æˆ–ä¸Šä¸€å±‚çš„ç¥ç»å…ƒï¼ˆå³æ¯ä¸ªæ—¶åˆ»çš„è¾“å‡ºæ˜¯ç”±ä¸Šä¸‹ä¸¤ä¸ªå¾ªç¯ç¥ç»ç½‘ç»œçš„è¾“å‡ºå…±åŒå†³å®šçš„ï¼‰ã€‚ æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸ã€è§£å†³æ–¹æ³•(æ¢¯åº¦æˆªæ–­ã€æ­£åˆ™åŒ–åŠæ”¹è¿›æ¨¡å‹ç­‰) 5.2 é—¨æ§RNN åœ¨RNNåŸºç¡€ä¸Šå¢åŠ é—¨æ§æœºåˆ¶ï¼Œç”¨æ¥æ§åˆ¶ç¥ç»ç½‘ç»œä¸­ä¿¡æ¯çš„ä¼ é€’ã€‚å³ä¿ç•™æˆ–ä¸¢å¼ƒè®°å¿†å•å…ƒä¸­çš„ä¿¡æ¯ã€‚è¿™æ ·å°±å¯ä»¥ä½¿RNNå­¦ä¹ æ—¶é—´è·¨åº¦æ›´å¤§çš„ä¾èµ–å…³ç³»ï¼Œè€Œä¸ä¼šå‡ºç°æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚ é•¿çŸ­æœŸè®°å¿†ç½‘ç»œ(Long Short-Term Memory, LSTM):å½“è¶‹äºæ¢¯åº¦æ¶ˆå¤±æ—¶ï¼Œè¢«é—å¿˜çš„ä¿¡æ¯è¶Šå¤šï¼›å½“è¶‹äºæ¢¯åº¦çˆ†ç‚¸æ—¶ï¼Œè®°å¿†çš„ä¿¡æ¯è¶Šå¤šã€‚ 1tf.keras.layers.LSTM é—¨æ§å¾ªç¯å•å…ƒ(Gated Recurrent Unit, GRU)ï¼šGRUç½‘ç»œç»“æ„æ¯”LSTMç®€å•ï¼Œå®ƒå°†LSTMçš„è¾“å…¥é—¨å’Œé—å¿˜é—¨åˆå¹¶ä¸ºæ›´æ–°é—¨ã€‚ 1tf.keras.layers.GRU 5.3 RNNçš„åº”ç”¨ åº”ç”¨åœºæ™¯ä¸»è¦æœ‰ï¼šè‡ªç„¶è¯­è¨€å¤„ç†(Natural Language Processingï¼ŒNLP)ã€è¯­éŸ³è¯†åˆ«/åˆæˆã€èŠå¤©æœºå™¨äººã€æœºå™¨ç¿»è¯‘ç­‰ã€‚ 5.4 æ³¨æ„åŠ›æ¨¡å‹ï¼ˆå¼ºåŒ–å­¦ä¹ ï¼Ÿï¼‰è·³è¿‡ 6. æ·±åº¦å¼ºåŒ–å­¦ä¹  6.1 åŸºç¡€çŸ¥è¯† è¡Œä¸ºæ¨¡å¼ï¼šDo &amp; CorrectåŠ¨ä½œç©ºé—´(Action Space)ï¼šAçŠ¶æ€ç©ºé—´(State Space)ï¼šSå¥–åŠ±(Reward)ï¼šRçŠ¶æ€è½¬ç§»æ¦‚ç‡çŸ©é˜µ(Transition)ï¼šP å¼ºåŒ–å­¦ä¹ å’Œä¼ ç»Ÿçš„æœ‰ç›‘ç£å­¦ä¹ çš„åŒºåˆ«ï¼šæœ‰ç›‘ç£å­¦ä¹  Learning with a teacherï¼Œå¼ºåŒ–å­¦ä¹  Learning with a critic 6.2 æœ‰æ¨¡å‹çš„å¼ºåŒ–å­¦ä¹ æ–¹æ³•6.3 æ— æ¨¡å‹çš„å¼ºåŒ–å­¦ä¹ æ–¹æ³•6.4 å¼ºåŒ–å­¦ä¹ ç®—æ³•6.5 æ·±åº¦å¼ºåŒ–å­¦ä¹ ç®—æ³•7. é¡¹ç›®å®æˆ˜8. Tensorflow ä»£ç TODOè§†é¢‘ 3-6å­ç±»è‡ªå®šä¹‰ layer 3-9ç­¾åå‡½æ•°å’Œå›¾ç»“æ„ 3-12æ‰‹åŠ¨metrics mse ç¬¬4ç« csv 8.1 å›å½’å’Œåˆ†ç±»æœ¬ç¬”è®°æœ¬ (notebook) ä»‹ç»äº†ä¸€äº›å¤„ç†å›å½’é—®é¢˜çš„æŠ€æœ¯ã€‚ å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰æ˜¯ç”¨äºå›å½’é—®é¢˜çš„å¸¸è§æŸå¤±å‡½æ•°ï¼ˆåˆ†ç±»é—®é¢˜ä¸­ä½¿ç”¨ä¸åŒçš„æŸå¤±å‡½æ•°ï¼‰ã€‚ ç±»ä¼¼çš„ï¼Œç”¨äºå›å½’çš„è¯„ä¼°æŒ‡æ ‡ä¸åˆ†ç±»ä¸åŒã€‚ å¸¸è§çš„å›å½’æŒ‡æ ‡æ˜¯å¹³å‡ç»å¯¹è¯¯å·®ï¼ˆMAEï¼‰ã€‚ å½“æ•°å­—è¾“å…¥æ•°æ®ç‰¹å¾çš„å€¼å­˜åœ¨ä¸åŒèŒƒå›´æ—¶ï¼Œæ¯ä¸ªç‰¹å¾åº”ç‹¬ç«‹ç¼©æ”¾åˆ°ç›¸åŒèŒƒå›´ã€‚ å¦‚æœè®­ç»ƒæ•°æ®ä¸å¤šï¼Œä¸€ç§æ–¹æ³•æ˜¯é€‰æ‹©éšè—å±‚è¾ƒå°‘çš„å°ç½‘ç»œï¼Œä»¥é¿å…è¿‡åº¦æ‹Ÿåˆã€‚ æ—©æœŸåœæ­¢æ˜¯ä¸€ç§é˜²æ­¢è¿‡åº¦æ‹Ÿåˆçš„æœ‰æ•ˆæŠ€æœ¯ã€‚ 8.2 TF åŸºç¡€ APItf.constant()9. Q&amp;A9.1 æ•°æ®é™ç»´ 9.2 é˜²æ­¢è¿‡æ‹Ÿåˆtodo: https://tensorflow.google.cn/tutorials/keras/overfit_and_underfit?hl=zh_cn Dropoutã€å–æ›´é‡è¦çš„ç‰¹å¾ï¼Œå¿½ç•¥ä¸é‡è¦çš„ç‰¹å¾ã€early stopping 10. TensorFlow å®˜ç½‘æ•™ç¨‹Todo https://keras.io/examples/ 10.1 å¿«é€Ÿå¼€å§‹10.2 Keras æœºå™¨å­¦ä¹ åŸºç¡€çŸ¥è¯†åŸºæœ¬å›¾åƒåˆ†ç±»åŸºæœ¬æ–‡æœ¬åˆ†ç±»ä½¿ç”¨ TF Hub è¿›è¡Œæ–‡æœ¬åˆ†ç±»TensorFlow Hubï¼Œä¸€ä¸ªç”¨äºè¿ç§»å­¦ä¹ çš„åº“å’Œå¹³å°ã€‚å…³äºè¿ç§»å­¦ä¹ å¯å‚è€ƒè¯¥æ–‡ç« ã€‚ å›å½’è¿‡æ‹Ÿåˆå’Œæ¬ æ‹Ÿåˆé˜²æ­¢è¿‡åº¦æ‹Ÿåˆçš„æœ€ç®€å•æ–¹æ³•æ˜¯ä»ä¸€ä¸ªå°æ¨¡å‹å¼€å§‹ï¼šä¸€ä¸ªå…·æœ‰å°‘é‡å¯å­¦ä¹ å‚æ•°ï¼ˆç”±å±‚æ•°å’Œæ¯å±‚å•å…ƒæ•°å†³å®šï¼‰çš„æ¨¡å‹ã€‚åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œæ¨¡å‹ä¸­å¯å­¦ä¹ å‚æ•°çš„æ•°é‡é€šå¸¸è¢«ç§°ä¸ºæ¨¡å‹çš„â€œå®¹é‡â€ã€‚ L1ã€L2 æ­£åˆ™åŒ–æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä½¿ç®€åŒ–æ¨¡å‹ï¼Œä½¿å…¶å…·æœ‰è¾ƒå°‘å‚æ•°ã€‚ &quot;L2&quot;æ­£åˆ™åŒ–æ¨¡å‹ç°åœ¨æ¯”&quot;Tiny&quot;æ¨¡å‹æ›´å…·ç«äº‰åŠ›ã€‚è¿™ç§&quot;L2&quot;æ¨¡å¼ä¹Ÿæ›´è€æ¯”è¿‡æ‹Ÿåˆ&quot;Large&quot;ï¼Œå°½ç®¡æœ‰ç›¸åŒæ•°é‡çš„å‚æ•°ï¼Œå®ƒæ˜¯åŸºäºæ¨¡å‹ã€‚ Dropout æ˜¯æœ€æœ‰æ•ˆå’Œæœ€å¸¸ç”¨çš„ç¥ç»ç½‘ç»œæ­£åˆ™åŒ–æŠ€æœ¯ä¹‹ä¸€ï¼Œç”± Hinton å’Œä»–åœ¨å¤šä¼¦å¤šå¤§å­¦çš„å­¦ç”Ÿå¼€å‘ã€‚ å¯¹ dropout çš„ç›´è§‚è§£é‡Šæ˜¯ï¼Œç”±äºç½‘ç»œä¸­çš„å•ä¸ªèŠ‚ç‚¹ä¸èƒ½ä¾èµ–å…¶ä»–èŠ‚ç‚¹çš„è¾“å‡ºï¼Œå› æ­¤æ¯ä¸ªèŠ‚ç‚¹å¿…é¡»è¾“å‡ºå¯¹è‡ªå·±æœ‰ç”¨çš„ç‰¹å¾ã€‚ åº”ç”¨äºå±‚çš„ Dropout åŒ…æ‹¬åœ¨è®­ç»ƒæœŸé—´éšæœºâ€œä¸¢å¼ƒâ€ï¼ˆå³è®¾ç½®ä¸ºé›¶ï¼‰è¯¥å±‚çš„è®¸å¤šè¾“å‡ºç‰¹å¾ã€‚å‡è®¾ä¸€ä¸ªç»™å®šçš„å±‚é€šå¸¸ä¼šåœ¨è®­ç»ƒæœŸé—´ä¸ºç»™å®šçš„è¾“å…¥æ ·æœ¬è¿”å›ä¸€ä¸ªå‘é‡ [0.2, 0.5, 1.3, 0.8, 1.1] ï¼›åº”ç”¨ dropout åï¼Œè¯¥å‘é‡å°†éšæœºåˆ†å¸ƒä¸€äº›é›¶æ¡ç›®ï¼Œä¾‹å¦‚ [0, 0.5, 1.3, 0, 1.1]ã€‚ â€œè¾å­¦ç‡â€æ˜¯è¢«å½’é›¶çš„ç‰¹å¾çš„æ¯”ä¾‹ï¼›å®ƒé€šå¸¸è®¾ç½®åœ¨ 0.2 åˆ° 0.5 ä¹‹é—´ã€‚åœ¨æµ‹è¯•æ—¶ï¼Œæ²¡æœ‰å•å…ƒè¢«ä¸¢å¼ƒï¼Œè€Œæ˜¯å±‚çš„è¾“å‡ºå€¼æŒ‰ä¸ä¸¢å¼ƒç‡ç›¸ç­‰çš„å› å­ç¼©å°ï¼Œä»¥å¹³è¡¡æ¯”è®­ç»ƒæ—¶æ›´å¤šçš„å•å…ƒå¤„äºæ´»åŠ¨çŠ¶æ€è¿™ä¸€äº‹å®ã€‚ è¿‡æ‹Ÿåˆçš„åé¢æ˜¯æ¬ æ‹Ÿåˆã€‚å½“è®­ç»ƒæ•°æ®ä»æœ‰æ”¹è¿›ç©ºé—´æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ¬ æ‹Ÿåˆã€‚å‘ç”Ÿè¿™ç§æƒ…å†µçš„åŸå› æœ‰å¾ˆå¤šï¼šå¦‚æœæ¨¡å‹ä¸å¤Ÿå¼ºå¤§ã€è¿‡åº¦è§„èŒƒåŒ–ï¼Œæˆ–è€…åªæ˜¯è®­ç»ƒæ—¶é—´ä¸å¤Ÿé•¿ã€‚è¿™æ„å‘³ç€ç½‘ç»œè¿˜æ²¡æœ‰å­¦ä¹ åˆ°è®­ç»ƒæ•°æ®ä¸­çš„ç›¸å…³æ¨¡å¼ã€‚ æ€»ç»“ å›é¡¾ä¸€ä¸‹ï¼šä»¥ä¸‹æ˜¯é˜²æ­¢ç¥ç»ç½‘ç»œè¿‡åº¦æ‹Ÿåˆçš„æœ€å¸¸è§æ–¹æ³•ï¼š è·å–æ›´å¤šè®­ç»ƒæ•°æ®ã€‚ å‡å°‘ç½‘ç»œå®¹é‡(æ¨¡å‹å‚æ•°)ã€‚ æ·»åŠ æƒé‡æ­£åˆ™åŒ–(Weight Regularization)ã€‚ æ·»åŠ è¾å­¦ã€‚ æœ¬æŒ‡å—æœªæ¶µç›–çš„ä¸¤ç§é‡è¦æ–¹æ³•æ˜¯ï¼š æ•°æ®å¢å¼º æ‰¹é‡æ ‡å‡†åŒ–(Batch Normalization) è¯·è®°ä½ï¼Œæ¯ç§æ–¹æ³•éƒ½å¯ä»¥å•ç‹¬æä¾›å¸®åŠ©ï¼Œä½†é€šå¸¸å°†å®ƒä»¬ç»“åˆèµ·æ¥ä¼šæ›´æœ‰æ•ˆã€‚ ä¿å­˜å’ŒåŠ è½½é€‰é¡¹ ä¿å­˜ Tensorflow çš„æ¨¡å‹æœ‰è®¸å¤šæ–¹æ³•â€”â€”å…·ä½“å–å†³äºæ‚¨ä½¿ç”¨çš„ APIã€‚æœ¬æŒ‡å—ä½¿ç”¨ tf.kerasï¼Œ ä¸€ä¸ªé«˜çº§ API ç”¨äºåœ¨ Tensorflow ä¸­æ„å»ºå’Œè®­ç»ƒæ¨¡å‹ã€‚æœ‰å…³å…¶ä»–æ–¹æ³•çš„å®ç°ï¼Œè¯·å‚é˜… TensorFlow ä¿å­˜å’Œæ¢å¤æŒ‡å—æˆ–ä¿å­˜åˆ° eagerã€‚ Keras é€šè¿‡æ£€æŸ¥ç½‘ç»œç»“æ„æ¥ä¿å­˜æ¨¡å‹ã€‚è¿™é¡¹æŠ€æœ¯å¯ä»¥ä¿å­˜ä¸€åˆ‡: æƒé‡å€¼ æ¨¡å‹çš„æ¶æ„ æ¨¡å‹çš„è®­ç»ƒé…ç½®(æ‚¨ä¼ é€’ç»™ç¼–è¯‘çš„å†…å®¹) ä¼˜åŒ–å™¨åŠå…¶çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼ˆè¿™ä½¿æ‚¨å¯ä»¥åœ¨ä¸­æ–­çš„åœ°æ–¹é‡æ–°å¼€å§‹è®­ç»ƒï¼‰ Keras æ— æ³•ä¿å­˜ v1.x ä¼˜åŒ–å™¨ï¼ˆæ¥è‡ª tf.compat.v1.trainï¼‰ï¼Œå› ä¸ºå®ƒä»¬ä¸æ£€æŸ¥ç‚¹ä¸å…¼å®¹ã€‚å¯¹äº v1.x ä¼˜åŒ–å™¨ï¼Œæ‚¨éœ€è¦åœ¨åŠ è½½-å¤±å»ä¼˜åŒ–å™¨çš„çŠ¶æ€åï¼Œé‡æ–°ç¼–è¯‘æ¨¡å‹ã€‚ å¦‚æœä½¿ç”¨çš„æ˜¯ SavedModel æ ¼å¼ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤éƒ¨åˆ†ã€‚HDF5 å’Œ SavedModel ä¹‹é—´çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼ŒHDF5 ä½¿ç”¨å¯¹è±¡é…ç½®ä¿å­˜æ¨¡å‹ç»“æ„ï¼Œè€Œ SavedModel ä¿å­˜æ‰§è¡Œå›¾ã€‚å› æ­¤ï¼ŒSavedModel èƒ½å¤Ÿä¿å­˜è‡ªå®šä¹‰å¯¹è±¡ï¼Œä¾‹å¦‚å­ç±»åŒ–æ¨¡å‹å’Œè‡ªå®šä¹‰å±‚ï¼Œè€Œæ— éœ€åŸå§‹ä»£ç ã€‚ 1https://www.tensorflow.org/tutorials/keras/save_and_load#%E4%BF%9D%E5%AD%98%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1 ä½¿ç”¨ Keras Tuner è°ƒæ•´è¶…å‚æ•°è¶…å‚æ•°æœ‰ä¸¤ç§ç±»å‹ï¼š å½±å“æ¨¡å‹é€‰æ‹©çš„æ¨¡å‹è¶…å‚æ•°ï¼Œä¾‹å¦‚éšè—å±‚çš„æ•°é‡å’Œå®½åº¦ to do éšè—å±‚æ˜¯ä»€ä¹ˆ å½±å“å­¦ä¹ ç®—æ³•é€Ÿåº¦å’Œè´¨é‡çš„ç®—æ³•è¶…å‚æ•°ï¼Œä¾‹å¦‚éšæœºæ¢¯åº¦ä¸‹é™ (SGD) çš„å­¦ä¹ ç‡å’Œ ak æœ€è¿‘é‚» (KNN) åˆ†ç±»å™¨çš„æœ€è¿‘é‚»æ•° æ‚¨å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•å®šä¹‰è¶…æ¨¡å‹ï¼š é€šè¿‡ä½¿ç”¨æ¨¡å‹æ„å»ºå™¨åŠŸèƒ½ here é€šè¿‡HyperModelç»§æ‰¿ Keras Tuner APIçš„ç±» The Keras Tuner has four tuners available - RandomSearch, Hyperband, BayesianOptimization, and Sklearn æ¦‚æ‹¬ åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæ‚¨å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ Keras Tuner è°ƒæ•´æ¨¡å‹çš„è¶…å‚æ•°ã€‚è¦äº†è§£æœ‰å…³ Keras Tuner çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é™„åŠ èµ„æºï¼š TensorFlow åšå®¢ä¸Šçš„ Keras Tuner Keras Tuner website Also check out the HParams Dashboard in TensorBoard to interactively tune your model hyperparameters. 10.3 åŠ è½½å’Œé¢„å¤„ç†æ•°æ®å›¾åƒCSVNumPypandas.DataFrameæ–‡æœ¬UnicodeTF.Textå­è¯åˆ†è¯åŒ–TFRecord å’Œ tf.Example","link":"/2021/09/03/TensorFlow/"},{"title":"rocketmq samples","text":"spring-boot-rocketmq ç¤ºä¾‹ï¼Œå…·ä½“è§é¡¹ç›®ä»£ç å’Œæ–‡æ¡£ã€‚ ç¤ºä¾‹ä»£ç ï¼šSC-alibaba/rocketmq/rocketmq-spring-boot at master Â· cloris-cc/SC-alibaba Â· GitHub ç¬”è®°ï¼šspring cloud alibaba - èŒ¶èŒ¶æ—¥è®° - winklog å®˜æ–¹ä¸­æ–‡æ–‡æ¡£ï¼šrocketmq/docs/cn at master Â· apache/rocketmq Â· GitHub 1. å¿«é€Ÿå¼€å§‹1.1 å¯åŠ¨æœåŠ¡ä¸‹è½½åœ°å€ï¼šQuick Start - Apache RocketMQ å¯åŠ¨ Name Serverï¼š 123&gt; nohup sh bin/mqnamesrv &amp;&gt; tail -f ~/logs/rocketmqlogs/namesrv.logThe Name Server boot success... å¯åŠ¨ Brokerï¼š 123&gt; nohup sh bin/mqbroker -n localhost:9876 &amp;&gt; tail -f ~/logs/rocketmqlogs/broker.log The broker[%s, 172.30.30.233:10911] boot success... å…³é—­æœåŠ¡ï¼š 1234567&gt; sh bin/mqshutdown brokerThe mqbroker(36695) is running...Send shutdown request to mqbroker(36695) OK&gt; sh bin/mqshutdown namesrvThe mqnamesrv(36664) is running...Send shutdown request to mqnamesrv(36664) OK 1.2 å¼•å…¥ä¾èµ–åœ¨ spring-boot é¡¹ç›® 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt; &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;${RELEASE.VERSION}&lt;/version&gt;&lt;/dependency&gt; æˆ–è€…ä½¿ç”¨ spring-cloud-stream 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-stream-rocketmq&lt;/artifactId&gt;&lt;/dependency&gt; 1.3 å‘é€æ¶ˆæ¯åœ¨å‘é€æ¶ˆæ¯å‰ï¼Œéœ€è¦å¯¹ç”Ÿäº§(output)/æ¶ˆè´¹è€…(input)åšå‡ é¡¹å¿…è¦çš„é…ç½® 1234rocketmq: name-server: localhost:9876 producer: group: test-group # ä¸€èˆ¬ä¸ºä¸šåŠ¡å(application name) æ¥ç€ä½¿ç”¨RocketMQTemplateå‘é€æ¶ˆæ¯ 123456789101112// æŒ‰ç…§åç§°è£…é…ã€‚è‹¥æ˜¯è‡ªå·±çš„Bean(eg:@Service/@Component/...)åˆ™ç”¨@AuowiredæŒ‰ç±»å‹è£…é…@Resourceprivate RocketMQTemplate rocketMQTemplate;/** * 1. string-topic æ™®é€šæ¶ˆæ¯ */public void stringTopic() { SendResult sendResult = rocketMQTemplate.syncSend(Topic.STRING_TOPIC, &quot;ä¸€æ¡æ™®é€šçš„æ¶ˆæ¯&quot;); log.info(&quot;======&gt; STRING_TOPICï¼šæ¶ˆæ¯å·²å‘é€&quot;); log.info(&quot;======&gt; sendResult: {}&quot;, sendResult);} æ¶ˆè´¹æ¶ˆæ¯ 12345678910// å½“éœ€è¦ç”¨åˆ°è´Ÿè½½å‡è¡¡æ—¶ï¼Œgroupå’Œtopicéƒ½è¦ç›¸åŒã€‚@RocketMQMessageListener(consumerGroup = &quot;consumer-group-1&quot;, topic = Topic.STRING_TOPIC)@Service@Slf4jpublic class StringTopicHandler implements RocketMQListener&lt;String&gt; { @Override public void onMessage(String s) { log.info(&quot;======&gt; æ¥å—åˆ°æ¶ˆæ¯ï¼š{}&quot;, s); }} 2. ä½¿ç”¨ç¤ºä¾‹2.1 åŸºæœ¬æ¦‚å¿µå‚ç…§ï¼šRocketMQä¸­Topicã€Tagã€GroupNameçš„è®¾è®¡åˆè¡· 2.2 ä¸»è¦åŠŸèƒ½(æ¶ˆæ¯ä¹‹é—´çš„) äº‹åŠ¡å¤„ç†ï¼šç”Ÿäº§è€…(æœåŠ¡A/æœ¬åœ°äº‹åŠ¡) ==&gt; æ¶ˆè´¹è€…(æœåŠ¡B) 2.3 æ³¨æ„ &amp; todoRocketMQListenerä¸­çš„æ³›å‹æ¶ˆæ¯ä½“Payload Tä¸ºå¯¹è±¡æ—¶ï¼Œéœ€è¦æœ‰æ— å‚æ„é€ å‡½æ•°ã€‚åŒ…æ‹¬RabbitMQçš„(byte[])message.getBody()å¯¹è±¡ä¹Ÿä¸€æ ·ã€‚å¦åˆ™åºåˆ—åŒ–å¯¹è±¡æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ è¶…çº§ç®€å•çš„ RocketMQ æµé‡å‰Šå³°å®æˆ˜_xmt1139057136çš„ä¸“æ -CSDNåšå®¢ ä¸šåŠ¡è®¾è®¡ï¼šä¸»è¦å›´ç»•topicï¼Œè®¾è®¡ä¸Šå’Œservice/controllerç­‰ç±»ä¼¼ï¼Œå°½é‡ä¸€ä¸ªtopicå¯¹åº”ä¸€ä¸ªå®ä½“ç±»ï¼Œä¾‹å¦‚å¯¹äºuserå¯¹è±¡ï¼Œæœ‰User-Service/Controller/Topic/Listenerã€‚ åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯æ¶ˆæ¯äº‹åŠ¡çš„çˆ¶é›†ã€‚ 12345@Slf4j@Service@RocketMQMessageListener(consumerGroup = &quot;delay-consumer-group&quot;, topic = Topic.DELAY_TOPIC)// æ­¤å¤„çš„ T ä¸ºPayloadçš„ç±»å‹ æˆ– MessageExtpublic class DelayTopicHandler implements RocketMQListener&lt;T&gt;","link":"/2021/04/02/rocketmq-samples/"},{"title":"Spring Cloud","text":"Spring Cloud ç³»åˆ—ç¬”è®°â€¦ ç¬¬ 1 ç«  å¾®æœåŠ¡ä¸SC1.1 å¾®æœåŠ¡æ¶æ„æŠ€æœ¯æ ˆ â€“ Spring Cloud Dubbo Motan MSEC å…¶ä»– åŠŸèƒ½ æœåŠ¡æ–¹æ¡ˆå®Œæ•´ æœåŠ¡æ²»ç†æ¡†æ¶ æœåŠ¡æ²»ç†æ¡†æ¶ æœåŠ¡å¼€å‘è¿è¥æ¡†æ¶ ç•¥ é€šä¿¡æ–¹å¼ REST / Http RPC åè®® RPC / Hessian2 Protocol buffer grpc, thrift æœåŠ¡å‘ç° / æ³¨å†Œ Eureka (AP) ZK, Nacos ZK / Conusl åªæœ‰æœåŠ¡å‘ç° Etcd è´Ÿè½½å‡è¡¡ Ribbon å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ Nginx + Lua å®¹é”™æœºåˆ¶ 6ç§å®¹é”™ç­–ç•¥ 6ç§å®¹é”™ç­–ç•¥ 2ç§å®¹é”™ç­–ç•¥ è‡ªåŠ¨å®¹é”™ Keepalivedã€HeartBeat ç†”æ–­æœºåˆ¶ Hystrix æ—  æ—  æä¾›è¿‡è½½ä¿æŠ¤ æ—  é…ç½®ä¸­å¿ƒ Spring Cloud Config Nacos æ—  æ—  Apollo, Nacos ç½‘å…³ Zuul, Gateway æ—  æ—  æ—  Kong, è‡ªç ” æœåŠ¡ç›‘æ§ Hystrix + Turbine Dubbo + Monitor æ—  Monitor ELK é“¾è·¯ç›‘æ§ Sleuth + Zipkin æ—  æ—  æ—  PinPoint å¤šè¯­è¨€ Rest æ”¯æŒå¤šè¯­è¨€ Java Java Java, C++, PHP Java, PHP, Node.js ç¤¾åŒºæ´»è·ƒ é«˜ (Spring ç¤¾åŒº) é«˜ (é˜¿é‡Œ) ä¸€èˆ¬ æœªçŸ¥ ç•¥ 1.2 æ¶æ„æ¼”å˜å•ä½“åº”ç”¨ &gt;&gt; åˆ†å¸ƒå¼(æ°´å¹³å¤åˆ¶) &gt;&gt; SOA(é¢å‘æœåŠ¡æ¶æ„) &gt;&gt; å¾®æœåŠ¡ å…¶ä¸­ï¼Œå¾®æœåŠ¡æ˜¯æ›´ç»†ç²’åº¦çš„åˆ’åˆ†ï¼›è€ŒSOAæ¶æ„æ›´åºé‡ï¼Œä¸»è¦åŒ…æ‹¬æœ‰ESBï¼ˆEnterprise Service Busï¼Œä¼ä¸šæœåŠ¡æ€»çº¿ã€‚æœ‰SOAP/JMSæŠ€æœ¯ï¼‰ï¼ŒåŸºäºXMLå’ŒWDSLè¯­è¨€ã€‚ 1.3 SpringCloud Dç‰ˆä¸­æ–‡æ–‡æ¡£ç¬¬ 2 ç«  Eureka2.1 æœåŠ¡çš„æ ¸å¿ƒæ“ä½œæœåŠ¡æ³¨å†Œã€ä¸‹çº¿ã€ç§Ÿçº¦å’Œå‰”é™¤ã€‚ 2.2 åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤åˆ¶æ–¹å¼ ä¸»ä»å¤åˆ¶å¯¹æ•°æ®çš„å†™æ“ä½œéƒ½æäº¤åˆ°ä¸»å‰¯æœ¬ï¼Œæœ€åå†ç”±ä¸»å‰¯æœ¬æ›´æ–°åˆ°å…¶å®ƒå‰¯æœ¬ã€‚è¯»æ“ä½œå¯ä»¥åˆ†é…åœ¨ä»å‰¯æœ¬ä¸Šä»¥ç¼“è§£å‹åŠ›ã€‚æ›´æ–°æ–¹å¼æœ‰ï¼šåŒæ­¥æ›´æ–°ã€å¼‚æ­¥æ›´æ–°ã€åŒæ­¥å’Œå¼‚æ­¥æ··åˆã€‚ å¯¹ç­‰å¤åˆ¶Eurekaå°±æ˜¯å®ç°äº†Peer to Peer. 2.3 CAPç†è®ºåœ¨Eurekaä¸­çš„ä½“ç°Eurekaä¼šå­˜ç•™è¿‡æœŸçš„å®ä¾‹ä¿¡æ¯ï¼ŒEurekaå¹¶ä¸æ˜¯å¼ºä¸€è‡´æ€§çš„ã€‚Cå’ŒAå†²çªçš„åŸå› ï¼šä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§éœ€è¦åŒæ­¥(åŠ é”)ï¼Œæ‰€ä»¥å¯èƒ½ä¼šé€ æˆé˜»å¡(å³ç‰ºç‰²äº†å¯ç”¨æ€§)ã€‚ å•æœºRedisä¸ºCAï¼Œæ²¡æœ‰Pæ˜¯å› ä¸ºä¸å­˜åœ¨å’Œå…¶å®ƒç½‘ç»œåˆ†åŒºé€šä¿¡ã€‚é›†ç¾¤Redisä¸ºAPï¼Œç‰ºç‰²å¼ºä¸€è‡´æ€§ä¿è¯é«˜å¯ç”¨ã€‚ æ€»ç»“ï¼šç”±äºCAPç†è®ºæ˜¯å­˜åœ¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ï¼Œæ•…ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ä¼šä¸å…¶å®ƒç½‘ç»œåˆ†åŒºé€šä¿¡çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šä¿è¯Pã€‚å¦å¤–ï¼Œç”±äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸»è¦ä»¥æ€§èƒ½ä¸ºä¸»ï¼Œæ•…ä¹Ÿä¼šä¿è¯Aã€‚æ‰€ä»¥åˆ†å¸ƒå¼ç»„ä»¶å¤§å¤šéƒ½æ˜¯ä¿è¯äº†APï¼Œå†ç”¨æœ€ç»ˆä¸€è‡´æ€§æ¥ä¿è¯æ•°æ®å®‰å…¨ã€‚Eureka/Redisä¹Ÿå¦‚æ­¤ã€‚ 2.4 Eurekaçš„é…ç½® Server 12345678910111213# bootstrap.ymlspring: application: name: eureka-server cloud: config: uri: http://localhost:8888management: endpoints: web: exposure: include: '*'&lt;/pre&gt; 123456789101112131415161718192021# application.ymlserver: port: 8761spring: application: name: eureka-servereureka: instance: hostname: localhost preferIpAddress: true client: registerWithEureka: false # æ³¨å†Œä¸­å¿ƒä¸ºfalse fetchRegistry: false # æ³¨å†Œä¸­å¿ƒä¸ºfalse serviceUrl:# defaultZone: http://localhost:8761/eureka/ # one eureka server# defaultZone: http://localhost:8762/eureka/ # two eureka server defaultZone: http://localhost:8762/eureka/,http://localhost:8763/eureka/ # three eureka server server: waitTimeInMsWhenSyncEmpty: 0 enableSelfPreservation: false Client 12345678910111213server: port: 8081spring: application: name: eureka-client1eureka: client: serviceUrl:# defaultZone: http://localhost:8761/eureka/ # one eureka server# defaultZone: http://localhost:8761/eureka/,http://localhost:8762/eureka/ # two eureka server defaultZone: http://localhost:8761/eureka/,http://localhost:8762/eureka/,http://localhost:8763/eureka/ # three eureka server ç¬¬ 3 ç«  Feign3.1 æ¦‚è¿° Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ Web Service å®¢æˆ·ç«¯ã€‚Feign ä¼šå®Œå…¨ä»£ç† HTTP çš„è¯·æ±‚ã€‚å®ƒçš„å‡ºç°ä½¿å¼€å‘ Web Service å®¢æˆ·ç«¯å˜å¾—å¾ˆç®€å•ã€‚ä½¿ç”¨ Feign åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ¥å£åŠ ä¸Šå¯¹åº”çš„æ³¨è§£ï¼Œå¦‚ï¼š@FeignClientã€‚ Feign æœ‰å¯æ’æ‹”çš„æ³¨è§£ï¼ŒåŒ…æ‹¬ Feign æ³¨è§£å’Œ JAX-RS æ³¨è§£ã€‚Feign ä¹Ÿæ”¯æŒç¼–ç å™¨å’Œè§£ç å™¨ï¼ŒSpring Cloud Open Feign å¯¹ Feign è¿›è¡Œå¢å¼ºæ”¯æŒ Spring MVC æ³¨è§£ï¼Œå¯ä»¥åƒ Spring Web ä¸€æ ·ä½¿ç”¨ HttpMessageConverters. æ­¤å¤–ï¼ŒæœåŠ¡æ¶ˆè´¹è€…è°ƒç”¨æä¾›è€…æ—¶ï¼Œåº•å±‚é€šè¿‡ HTTP Client çš„æ–¹å¼è®¿é—®ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ JDK åŸç”Ÿçš„ URLConnectionã€Apache çš„ HTTP Clientã€Netty çš„å¼‚æ­¥ HTTP Clientï¼ŒSpring çš„ RestTemplate (å®ç° Ribbon è´Ÿè½½å‡è¡¡çš„åª’ä»‹) å»å®ç°æœåŠ¡é—´çš„è°ƒç”¨ã€‚ 3.2 ç‰¹æ€§ å¯æ’æ‹”çš„æ³¨è§£æ”¯æŒï¼ŒåŒ…æ‹¬ Feign æ³¨è§£å’Œ JAX-RS æ³¨è§£ã€‚ æ”¯æŒå¯æ’æ‹”çš„ HTTP ç¼–ç å™¨å’Œè§£ç å™¨ã€‚ æ”¯æŒ Hystrix å’Œå®ƒçš„ Fallbackã€‚ æ”¯æŒ Ribbon çš„è´Ÿè½½å‡è¡¡ã€‚ æ”¯æŒ HTTP è¯·æ±‚å’Œå“åº”çš„å‹ç¼©ã€‚ 3.3 Feign çš„åŸºç¡€ç”¨æ³•12345678@SpringBootApplication@EnableFeignClientspublic class SpringCloudFeignApplication { public static void main(String[] args) { SpringApplication.run(SpringCloudFeignApplication.class, args); }} 12345678910111213@FeignClient(name = &quot;github-client&quot;, url = &quot;https://api.github.com&quot;, configuration = HelloFeignServiceConfig.class)public interface HelloFeignService { /** * content: {&quot;message&quot;:&quot;Validation Failed&quot;,&quot;errors&quot;:[{&quot;resource&quot;:&quot;Search&quot;,&quot;field&quot;:&quot;q&quot;,&quot;code&quot;:&quot;missing&quot;}], * &quot;documentation_url&quot;:&quot;https://developer.github.com/v3/search&quot;} * @param queryStr * @return */ @RequestMapping(value = &quot;/search/repositories&quot;, method = RequestMethod.GET) String searchRepo(@RequestParam(&quot;q&quot;) String queryStr);} 12345678910111213@RestControllerpublic class HelloFeignController { @Autowired private HelloFeignService helloFeignService; // æœåŠ¡æ¶ˆè´¹è€…å¯¹ä½æä¾›çš„æœåŠ¡ @GetMapping(value = &quot;/search/github&quot;) public String searchGithubRepoByStr(@RequestParam(&quot;str&quot;) String queryStr) { return helloFeignService.searchRepo(queryStr); }} 3.4 Feign çš„åŸºç¡€åŠŸèƒ½3.4.1 @FeignClient æ³¨è§£@FeignClientçš„å¸¸ç”¨å±æ€§å¦‚ä¸‹ï¼š nameï¼šæŒ‡å®š FeignClient çš„åç§°ï¼Œå¦‚æœé¡¹ç›®ä½¿ç”¨äº† Ribbonï¼Œname å±æ€§ä¼šä½œä¸ºå¾®æœåŠ¡çš„åç§°ï¼Œç”¨äºæœåŠ¡å‘ç°ã€‚ urlï¼šurl ä¸€èˆ¬ç”¨äºè°ƒè¯•ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®š@FeignClientè°ƒç”¨çš„åœ°å€ã€‚ decode404ï¼šå½“å‘ç”Ÿ 404 é”™è¯¯æ—¶ï¼Œå¦‚æœè¯¥å­—æ®µä¸º trueï¼Œä¼šè°ƒç”¨ decoder è¿›è¡Œè§£ç ï¼Œå¦åˆ™æŠ›å‡º FeignExceptionã€‚ configurationï¼šFeigné…ç½®ç±»ã€‚å¯ä»¥å®šä¹‰ Feign çš„ Encoderã€Decoderã€LogLevelã€Contractã€‚ fallbackï¼šå®šä¹‰å®¹é”™çš„å¤„ç†ç±»ï¼Œå½“è°ƒç”¨è¿œç¨‹æ¥å£å¤±è´¥æˆ–è¶…æ—¶æ—¶ï¼Œä¼šè°ƒç”¨å¯¹åº”æ¥å£çš„å®¹é”™é€»è¾‘ï¼Œfallback æŒ‡å®šçš„ç±»å¿…é¡»å®ç°@FeignClientæ ‡è®°çš„æ¥å£å¹¶ç”¨@Componentæ³¨å†ŒBeanã€‚ fallbackFactoryï¼šå·¥å‚ç±»ï¼Œç”¨äºç”Ÿæˆ fallback ç±»ç¤ºä¾‹ï¼Œé€šè¿‡è¿™ä¸ªå±æ€§æˆ‘ä»¬å¯ä»¥å®ç°æ¯ä¸ªæ¥å£é€šç”¨çš„å®¹é”™é€»è¾‘ï¼Œå‡å°‘é‡å¤çš„ä»£ç ã€‚ä¹Ÿè¦æ³¨å†Œåˆ°Springå®¹å™¨å†…ã€‚ pathï¼šå®šä¹‰å½“å‰ FeignClient çš„ç»Ÿä¸€å‰ç¼€ã€‚ 3.4.2 Feign å¼€å¯ GZIP å‹ç¼©ç¬¬ 4 ç«  Ribbon4.1 Ribbonçš„åŸºæœ¬ç”¨æ³•1234567891011121314@SpringBootApplication@EnableDiscoveryClientpublic class RibbonLoadbalancerApplication { public static void main(String[] args) { SpringApplication.run(RibbonLoadbalancerApplication.class, args); } @Bean @LoadBalanced // Eureka å·²ç»é—´æ¥ä¾èµ–äº† Ribbonï¼Œæ‰€ä»¥ä¸éœ€è¦å†å¯¼å…¥ Ribbon çš„ä¾èµ–ã€‚ public RestTemplate restTemplate() { return new RestTemplate(); }} 1234567891011121314@RestControllerpublic class TestController { @Autowired private RestTemplate restTemplate; // é€šè¿‡ RestTemplate è°ƒç”¨å¤šä¸ªå®¢æˆ·ç«¯ï¼Œå®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ã€‚ @GetMapping(&quot;/add&quot;) public String add(Integer a, Integer b) { String result = restTemplate .getForObject(&quot;http://CLIENT-A/add?a=&quot; + a + &quot;&amp;b=&quot; + b, String.class); System.out.println(result); return result; }} 4.2 Ribbonè´Ÿè½½å‡è¡¡ç­–ç•¥ä¸è‡ªå®šä¹‰é…ç½®4.2.1 ç­–ç•¥è¯¦è§£ ç­–ç•¥ç±» å‘½å æè¿° RandomRule éšæœºç­–ç•¥ éšæœºé€‰æ‹© server RoundRobinRuleï¼ˆdefaultï¼‰ è½®è¯¢ç­–ç•¥ æŒ‰é¡ºåºå¾ªç¯é€‰æ‹© server RetryRule é‡è¯•ç­–ç•¥ åœ¨ä¸€ä¸ªé…ç½®æ—¶é—´æ®µå†…é€‰æ‹© server ä¸æˆåŠŸï¼Œåˆ™ä¸€ç›´å°è¯•é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ server BestAvailableRule æœ€ä½å¹¶å‘ç­–ç•¥ é€ä¸ªè€ƒå¯Ÿ server, å¦‚æœ server æ–­è·¯å™¨æ‰“å¼€ï¼Œåˆ™å¿½ç•¥ï¼Œå†é€‰æ‹©å…¶ä¸­å¹¶å‘è¿æ¥æœ€ä½çš„ server AvailabilityFilteringRule å¯ç”¨è¿‡æ»¤ç­–ç•¥ è¿‡æ»¤æ‰ä¸€ç›´è¿æ¥å¤±è´¥å¹¶è¢«æ ‡è®°ä¸º circuit tripped çš„ serverï¼Œè¿‡æ»¤æ‰é‚£äº›é«˜å¹¶å‘è¿æ¥çš„ serverï¼ˆactive connections è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼‰ ResponseTimeWeightedRule å“åº”æ—¶é—´åŠ æƒç­–ç•¥ æ ¹æ® server çš„å“åº”æ—¶é—´æ”¹å˜æƒé‡ ZoneAvoidanceRule åŒºåŸŸæƒè¡¡ç­–ç•¥ ç»¼åˆåˆ¤æ–­ server æ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œ server çš„å¯ç”¨æ€§è½®è¯¢é€‰æ‹© serverï¼Œå¹¶ä¸”åˆ¤å®šä¸€ä¸ª AWS Zone çš„è¿è¡Œæ€§èƒ½æ˜¯å¦å¯ç”¨ï¼Œå‰”é™¤ä¸å¯ç”¨çš„ Zone ä¸­çš„æ‰€æœ‰ server 4.2.2 ä»£ç å®ç° 4.2.3 ç­–ç•¥è®¾ç½® å…¨å±€ç­–ç•¥è®¾ç½® 12345678@Configurationpublic class TestConfiguration { @Bean public IRule ribbonRule() { return new RandomRule(); }} å¯¹ç‰¹å®šçš„å¾®æœåŠ¡è®¾ç½® IRule ç­–ç•¥ ä½¿ç”¨@RibbonClientï¼Œè®¾ç½® configuration çš„å±æ€§å€¼ï¼Œeg: 1234567891011121314151617181920@SpringBootApplication@EnableDiscoveryClient@RibbonClient(name = &quot;client-a&quot;, configuration = TestConfiguration.class)//@RibbonClients(value = {// @RibbonClient(name = &quot;client-a&quot;, configuration = TestConfiguration.class),// @RibbonClient(name = &quot;client-b&quot;, configuration = TestConfiguration.class)//})@ComponentScan(excludeFilters = {@ComponentScan.Filter(type = FilterType.ANNOTATION, value = {AvoidScan.class})})public class RibbonLoadbalancerApplication { public static void main(String[] args) { SpringApplication.run(RibbonLoadbalancerApplication.class, args); } @Bean @LoadBalanced public RestTemplate restTemplate() { return new RestTemplate(); }} ä½¿ç”¨yamlé…ç½®æ–‡ä»¶é…ç½®ï¼Œeg: 1234567891011121314151617181920212223spring: application: name: ribbon-loadbalancerserver: port: 7777eureka: client: serviceUrl: defaultZone: http://${eureka.host:127.0.0.1}:${eureka.port:8888}/eureka/ instance: prefer-ip-address: true#client-a:# ribbon:# ConnectTimeout: 3000# ReadTimeout: 60000# MaxAutoRetries: 1 #å¯¹ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æœåŠ¡çš„é‡è¯•æ¬¡æ•°# MaxAutoRetriesNextServer: 1 #è¦é‡è¯•çš„ä¸‹ä¸€ä¸ªæœåŠ¡çš„æœ€å¤§æ•°é‡ï¼ˆä¸åŒ…æ‹¬ç¬¬ä¸€ä¸ªæœåŠ¡ï¼‰# OkToRetryOnAllOperations: true# NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule##ribbon:# eager-load:# enabled: true# clients: client-a, client-b, client-c é€šè¿‡é…ç½®æ–‡ä»¶è‡ªå®šä¹‰ Ribbon å®¢æˆ·ç«¯çš„è¯­æ³•è¯´æ˜ï¼ˆå®˜æ–¹æ–‡æ¡£å‡æœ‰è¯´æ˜ï¼‰ï¼Œeg: é…ç½®é¡¹ è¯´æ˜ clientName.ribbon.NFLoadBalancerClassName æŒ‡å®š ILoadBalancer çš„å®ç°ç±» clientName.ribbon.NFLoadBalancerRuleClassName æŒ‡å®š IRule çš„å®ç°ç±» clientName.ribbon.NFLoadBalancerPingClassName æŒ‡å®š IPing çš„å®ç°ç±» clientName.ribbon.NIWSServerListClassName æŒ‡å®š ServerList çš„å®ç°ç±» clientName.ribbon.NIWSServerListFilterClassName æŒ‡å®š ServerListFilter çš„å®ç°ç±» å®ç°è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šå®ç°IRuleæ¥å£çš„chooseæ–¹æ³•å†æ³¨å†Œåˆ°å®¹å™¨å³å¯ã€‚ 4.3 Ribbon è¿›é˜¶4.3.1 Ribbon çš„æ ¸å¿ƒæ¥å£åœ¨ IDE ä¸­æŸ¥çœ‹å…·ä½“å®ç° IRuleã€IPing çš„ I ä»£è¡¨ Interfaceï¼Œä»¥åçš„æ¥å£ä¹Ÿä½¿ç”¨æ­¤å‘½åæ ¼å¼ã€‚å¦‚ IUserServiceâ€¦ æ¥å£ æè¿° é»˜è®¤å®ç°ç±» IClientConfig å®šä¹‰ Ribbon ä¸­ç®¡ç†é…ç½®çš„æ¥å£ DefaultClientConfigImpl IRule å®šä¹‰ Ribbon ä¸­è´Ÿè½½å‡è¡¡ç­–ç•¥çš„æ¥å£ ZoneAvoidanceRule IPing å®šä¹‰å®šæœŸ ping æœåŠ¡æ£€æŸ¥å¯ç”¨æ€§çš„æ¥å£ DummyPing ServerList&lt;Server å®šä¹‰è·å–æœåŠ¡åˆ—è¡¨æ–¹æ³•çš„æ¥å£ ConfigurationBasedServerList ServerListFilter&lt;Server å®šä¹‰ç‰¹å®šæœŸæœ›è·å–æœåŠ¡åˆ—è¡¨æ–¹æ³•çš„æ¥å£ ZonePreferenceServerListFilter ILoadBalancer å®šä¹‰è´Ÿè½½å‡è¡¡é€‰æ‹©æœåŠ¡çš„æ ¸å¿ƒæ–¹æ³•çš„æ¥å£ ZoneAwareLoadBalancer ServerListUpdater ä¸º DynamicServerListLoadBalancer å®šä¹‰åŠ¨æ€æ›´æ–°æœåŠ¡åˆ—è¡¨çš„æ¥å£ PollingServerListUpdater 4.3.2 RestTemplate è¾¾åˆ°è´Ÿè½½å‡è¡¡çš„åŸç† RestTemplate.classBean çš„ç»§æ‰¿å…³ç³»å›¾ï¼š @LoadBalanced æ³¨è§£ï¼š LoadBalancerClient æ¥å£çš„æ–¹æ³•å’Œå®ç°ç±»ï¼Œå…·ä½“è§æ³¨é‡Šæ–‡æ¡£ï¼š å…¶ä¸­LoadBalancerClientæ¥å£ç»§æ‰¿è‡ªServiceInstanceChooseræ¥å£ï¼Œè¯¥æ¥å£åªæœ‰ä¸€ä¸ªServiceInstance choose(String serviceId);æ–¹æ³• ã€‚ ç¬¬ 5 ç«  Hystrix - Defend your APP5.1 è®¾è®¡ç›®æ ‡ é€šè¿‡å®¢æˆ·ç«¯åº“å¯¹å»¶è¿Ÿå’Œæ•…éšœè¿›è¡Œä¿æŠ¤å’Œæ§åˆ¶ åœ¨ä¸€ä¸ªå¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åœæ­¢çº§è”æ•…éšœ å¿«é€Ÿå¤±è´¥å’Œè¿…é€Ÿæ¢å¤ åœ¨åˆç†çš„æƒ…å†µä¸‹å›é€€å’Œä¼˜é›…åœ°é™çº§ å¼€å¯è¿‘å®æ—¶ç›‘æ§ã€å‘Šè­¦å’Œæ“ä½œæ§åˆ¶ 5.2 Hystrix çš„åŸºæœ¬ç”¨æ³•ä½¿ç”¨@EnableHystrixã€@HystrixCommand&lt;ä¿®é¥°æ–¹æ³•&gt; æ³¨è§£ï¼š @Client çš„æ³¨è§£åŸºæœ¬éƒ½æ˜¯ä¿®é¥°ç±»ã€‚ 1234567891011121314151617181920212223@Componentpublic class UserService implements IUserService{ @Override @HystrixCommand(fallbackMethod=&quot;defaultUser&quot;) public String getUser(String username) throws Exception { if(username.equals(&quot;spring&quot;)) { return &quot;This is real user&quot;; }else { throw new Exception(); } } /** * å‡ºé”™åˆ™è°ƒç”¨è¯¥æ–¹æ³•è¿”å›å‹å¥½é”™è¯¯ * @param username * @return */ public String defaultUser(String username) { return &quot;The user does not exist in this system&quot;; } } Feign ä¸­ä½¿ç”¨æ–­è·¯å™¨ï¼ŒFeign é»˜è®¤ä¸å¼€å¯ Hystrixï¼š 1234567@FeignClient(name = &quot;sc-provider-service&quot;, fallback = UserServiceFallback.class)public interface IUserService { @RequestMapping(value = &quot;/getUser&quot;,method = RequestMethod.GET) public String getUser(@RequestParam(&quot;username&quot;) String username); } 5.3 Hystrix Dashboard Hystrix Dashboard å±•ç¤ºæ¯ä¸ª HystrixCommand æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¿¡æ¯ã€‚ ä½¿ç”¨æ–¹æ³•ï¼šé¡¹ç›®å¯¼å…¥ actuator ä¾èµ–ï¼Œæš´éœ² hystrix.stream ç«¯ç‚¹ã€‚å¯åŠ¨ç±»å¢åŠ  @EnableHystrixDashboard æ³¨è§£ã€‚ 5.4 Turbine èšåˆ Hystrixä¸»å¯åŠ¨ç±»ï¼š 123456789@SpringBootApplication@EnableDiscoveryClient@EnableTurbine@EnableHystrixDashboardpublic class TurbineApplication { public static void main(String[] args) { SpringApplication.run(TurbineApplication.class, args); }} YAML é…ç½®æ–‡ä»¶ï¼š 1234567891011121314151617eureka: client: serviceUrl: defaultZone: http://${eureka.host:127.0.0.1}:${eureka.port:8761}/eureka/ instance: prefer-ip-address: truemanagement: security: enabled: false endpoints: web: exposure: include: hystrix.streamturbine: # è®¾ç½®éœ€è¦æ”¶é›†å¥åº·ä¿¡æ¯çš„æœåŠ¡åç§° appConfig: sc-hello-service,sc-provider-service clusterNameExpression: &quot;'default'&quot; 5.5 Hystrix è¯¦è§£5.5.1 Hystrix å¼‚å¸¸æœºåˆ¶å’Œå¤„ç†Hystrix çš„å¼‚å¸¸å¤„ç†ä¸­ï¼Œæœ‰5ç§å‡ºé”™çš„æƒ…å†µä¸‹ä¼šè¢« fallback æˆªè·ï¼Œåˆ†åˆ«æ˜¯ï¼š FAILUREï¼šæ‰§è¡Œå¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚ TIMEOUTï¼šæ‰§è¡Œè¶…æ—¶ã€‚ SHORT_CIRCUITEDï¼šæ–­è·¯å™¨æ‰“å¼€ã€‚ THREAD_POOL_REJECTEDï¼šçº¿ç¨‹æ± æ‹’ç»ã€‚ SEMAPHORE_REJECTEDï¼šä¿¡å·é‡æ‹’ç»ã€‚ å¯¹äº BAD_REQUEST å¼‚å¸¸æ˜¯ä¸ä¼šè§¦å‘ fallback ä¸”ä¸ä¼šè¢«è®¡æ•°è¿›å…¥ç†”æ–­çš„ï¼Œä¼šæŠ›å‡º HystrixBadRequestException. 5.5.2 Hystrix é…ç½®è¯´æ˜5.5.3 Hystrix çº¿ç¨‹è°ƒæ•´å’Œè®¡ç®—å¯¹ä¸šåŠ¡çš„é…ç½®é€šç”¨çš„åšæ³•ï¼š è¶…æ—¶æ—¶é—´é»˜è®¤ä¸º 1000msï¼Œå¦‚æœä¸šåŠ¡æ˜æ˜¾è¶…è¿‡ 1000msï¼Œåˆ™æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡è¿›è¡Œä¿®æ”¹ã€‚ çº¿ç¨‹æ± é»˜è®¤ä¸º 10ï¼Œéœ€è¦æ›´å¤šæ—¶è‡ªè¡Œè°ƒæ•´ã€‚ é‡‘ä¸é›€å‘å¸ƒï¼Œå¦‚æœæˆåŠŸåˆ™ä¿æŒã€‚ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œè¶…è¿‡ 24 å°æ—¶ã€‚ å¦‚æœç³»ç»Ÿæœ‰è­¦å‘Šå’Œç›‘æ§ï¼Œé‚£ä¹ˆå¯ä»¥ä¾é å®ƒä»¬æ•æ‰é—®é¢˜ã€‚ è¿è¡Œ 24 å°æ—¶ä¹‹åï¼Œé€šè¿‡å»¶è¿Ÿç™¾åˆ†ä½å’Œæµé‡æ¥è®¡ç®—æœ‰æ„ä¹‰çš„æœ€ä½æ»¡è¶³å€¼ã€‚ åœ¨ç”Ÿäº§æˆ–è€…æµ‹è¯•ç¯å¢ƒä¸­å®æ—¶ä¿®æ”¹å€¼ï¼Œç„¶åç”¨ä»ªè¡¨ç›˜ç›‘æ§ã€‚ å¦‚æœæ–­è·¯å™¨äº§ç”Ÿå˜åŒ–å’Œå½±å“ï¼Œåˆ™éœ€å†æ¬¡ç¡®è®¤è¿™ä¸ªé…ç½®ã€‚ å…·ä½“çš„è°ƒæ•´å’Œè®¡ç®—è§å®˜æ–¹è¯´æ˜æ–‡æ¡£ã€‚ 5.5.4 Hystrix è¯·æ±‚ç¼“å­˜ä½¿ç”¨@CacheResultå¼€å¯ç¼“å­˜ï¼Œ@CacheRemoveæ¸…é™¤ç¼“å­˜ï¼š 12345678910111213141516171819202122232425262728293031@Componentpublic class HelloService implements IHelloService{ @Autowired private RestTemplate restTemplate; @CacheResult @HystrixCommand public String hello(Integer id) { String json = restTemplate.getForObject(&quot;http://sc-provider-service/getUser/{1}&quot;, String.class, id); System.out.println(json); return json; } @CacheResult @HystrixCommand(commandKey = &quot;getUser&quot;) public String getUserToCommandKey(@CacheKey Integer id) { String json = restTemplate.getForObject(&quot;http://sc-provider-service/getUser/{1}&quot;, String.class, id); System.out.println(json); return json; } @CacheRemove(commandKey=&quot;getUser&quot;) @HystrixCommand public String updateUser(@CacheKey Integer id) { System.out.println(&quot;åˆ é™¤getUserç¼“å­˜&quot;); return &quot;update success&quot;; }} 5.5.5 Hystrix Request Collapserä½¿ç”¨æ³¨è§£è¿›è¡Œè¯·æ±‚åˆå¹¶ï¼š å’Œç¼“å­˜ç±»ä¼¼ï¼Œç”¨æ‹¦æˆªå™¨å®ç° Hystrix ä¸Šä¸‹æ–‡çš„åˆå§‹åŒ–å’Œå…³é—­ï¼š 12345678910111213141516171819202122public class CacheContextInterceptor implements HandlerInterceptor { private HystrixRequestContext context; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse respone, Object arg2) throws Exception { context = HystrixRequestContext.initializeContext(); return true; } @Override public void postHandle(HttpServletRequest request, HttpServletResponse respone, Object arg2, ModelAndView arg3) throws Exception { } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse respone, Object arg2, Exception arg3) throws Exception { context.shutdown(); } } æœªå®Œå¾…ç»­â€¦ ç¬¬ 6 ç«  Zuul6.1 ç®€ä»‹ Zuul is the front door for all request from devices and web sites to the backend of the Netflix streaming application. Zuul å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š è®¤è¯ä¸æˆæƒ å‹åŠ›æ§åˆ¶ é‡‘ä¸é›€æµ‹è¯• åŠ¨æ€è·¯ç”± è´Ÿè½½å‰Šå‡ é™æ€å“åº”å¤„ç† ä¸»åŠ¨æµé‡ç®¡ç† 6.2 Zuul çš„å¿«é€Ÿå…¥é—¨6.2.1 åŸºæœ¬é…ç½® å•å®ä¾‹é…ç½®ï¼š 12345zuul: routes: zuul-gateway: path: /client/** # å°†æ‰€æœ‰ /client å¼€å¤´çš„ URL æ˜ å°„åˆ° client-a æœåŠ¡å»ã€‚ serviceId: client-a # æœåŠ¡å or 123zuul: routes: client-a: /client/** å¤šå®ä¾‹é…ç½®ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼ŒZuul ä¼šä½¿ç”¨ Eureka é›†æˆçš„åŸºæœ¬è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå¦‚æœæƒ³ä½¿ç”¨ Ribbon å°±éœ€è¦åˆ¶å®šä¸€ä¸ª serviceIdï¼Œæ­¤æ“ä½œéœ€è¦ç¦æ­¢ Ribbon ä½¿ç”¨ Eurekaï¼Œåœ¨ E ç‰ˆä¹‹åæ–°å¢äº†è´Ÿè½½å‡è¡¡ç­–ç•¥çš„é…ç½®ï¼Œå¦‚ä¸‹ï¼š 1234567891011121314151617### è„±ç¦»eurekaè®©zuulç»“åˆribbonå®ç°è·¯ç”±è´Ÿè½½å‡è¡¡ ###zuul: routes: ribbon-route: path: /ribbon/** serviceId: ribbon-routeribbon: eureka: enabled: false #ç¦æ­¢Ribbonä½¿ç”¨Eurekaribbon-route: ribbon: NIWSServerListClassName: com.netflix.loadbalancer.ConfigurationBasedServerList NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule #Ribbon LB Strategy listOfServers: localhost:7070,localhost:7071 #client services for Ribbon LB 6.2.2 è·¯ç”±é€šé…ç¬¦ è§„åˆ™ é‡Šä¹‰ ç¤ºä¾‹ /** åŒ¹é…ä»»æ„æ•°é‡çš„è·¯å¾„ä¸å­—ç¬¦ /mul/a/bâ€¦ /* åŒ¹é…ä»»æ„æ•°é‡çš„å­—ç¬¦ /mul /? åŒ¹é…å•ä¸ªå­—ç¬¦ /m 6.2.3 åŠŸèƒ½é…ç½® è·¯ç”±å‰ç¼€ã€æœåŠ¡å±è”½ã€è·¯å¾„å±è”½ã€æ•æ„Ÿå¤´ä¿¡æ¯ã€é‡å®šå‘é—®é¢˜ã€é‡è¯•æœºåˆ¶â€¦ 12345678910#### æœåŠ¡å¿½ç•¥ã€è·¯å¾„å¿½ç•¥ã€å‰ç¼€ã€é‡å®šå‘é—®é¢˜ã€é‡è¯•æœºåˆ¶ ####zuul: ignored-services: client-b # å¿½ç•¥çš„æœåŠ¡ï¼Œé˜²æœåŠ¡ä¾µå…¥ ignored-patterns: /**/div/** # å¿½ç•¥çš„æ¥å£ï¼Œå±è”½æ¥å£ prefix: /pre # å‰ç¼€ add-host-header: true # é‡å®šå‘headeré—®é¢˜ routes: sensitiveHeaders: Cookie,Set-Cookie,Authorization # æ•æ„Ÿå¤´ä¿¡æ¯ client-a: /client/** 12345678########################## é‡è¯•æœºåˆ¶ ##########################zuul: retryable: true #å¼€å¯é‡è¯•ribbon: MaxAutoRetries: 1 #åŒä¸€ä¸ªæœåŠ¡é‡è¯•çš„æ¬¡æ•°(é™¤å»é¦–æ¬¡) MaxAutoRetriesNextServer: 1 #åˆ‡æ¢ç›¸åŒæœåŠ¡æ•°é‡ 6.3 Zuul è¿›é˜¶6.3.1 Zuul Filter é“¾ Zuul æœ¬è´¨ä¸Šæ˜¯ Filter è´£ä»»é“¾ã€‚Zuul å†…éƒ¨æä¾›äº†ä¸€ä¸ªåŠ¨æ€è¯»å–ã€ç¼–è¯‘å’Œè¿è¡Œè¿™äº› Filter çš„æœºåˆ¶ã€‚Filter ä¹‹é—´ä¸ç›´æ¥é€šä¿¡ï¼ˆå†…éƒ¨ç”¨ ThreadLocal å®ç°ï¼‰ï¼Œåœ¨è¯·æ±‚çº¿ç¨‹ä¸­ä¼šé€šè¿‡ RequestContextï¼ˆä¸ doFilter åœ¨åŒä¸€ ThreadLocal ä¸­ï¼‰ æ¥å…±äº«çŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Filter ä¹‹é—´ä½¿ç”¨ ThreadLocal æ¥æ”¶é›†è‡ªå·±éœ€è¦çš„çŠ¶æ€æˆ–æ•°æ®ã€‚ Java ä¸­çš„ Filter æ¥å£ï¼ˆåœ¨tomcat-embed-core.jarä¸­ï¼‰ï¼š 1234567891011package javax.servlet;import java.io.IOException;public interface Filter { void init(FilterConfig var1) throws ServletException; void doFilter(ServletRequest var1, ServletResponse var2, FilterChain var3) throws IOException, ServletException; void destroy();} com.netflix.zuul.context.RequestContext ä¸­çš„æ³¨é‡Šï¼Œå®ƒç»§æ‰¿è‡ªConcurrentHashMapï¼š 12345678910/** * The Request Context holds request, response, state information and data for ZuulFilters to access and share. * The RequestContext lives for the duration of the request and is ThreadLocal. * extensions of RequestContext can be substituted by setting the contextClass. * Most methods here are convenience wrapper methods; the RequestContext is an extension of a ConcurrentHashMap * * @author Mikey Cohen * Date: 10/13/11 * Time: 10:21 AM */ Zuul ä¸­æœ‰å››ç§ä¸åŒç”Ÿå‘½å‘¨æœŸçš„ Filterï¼Œåˆ†åˆ«æ˜¯ï¼š preï¼šåœ¨ Zuul æŒ‰ç…§è§„åˆ™è·¯ç”±åˆ°ä¸‹çº§æœåŠ¡ä¹‹å‰æ‰§è¡Œã€‚å¦‚æœéœ€è¦å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œæ¯”å¦‚é‰´æƒã€é™æµç­‰ï¼Œéƒ½åº”è€ƒè™‘åœ¨æ­¤ç±» Filter ä¸­å®ç°ã€‚ routeï¼šè¿™ç±» Filter æ˜¯ Zuul è·¯ç”±åŠ¨ä½œçš„æ‰§è¡Œè€…ï¼Œæ˜¯ Apache HttpClient æˆ– Netflix Ribbon æ„å»ºå’Œå‘é€åŸå§‹ HTTP è¯·æ±‚çš„åœ°æ–¹ï¼Œç›®å‰å·²æ”¯æŒ OkHttpã€‚ postï¼šè¿™ç±» Filter æ˜¯åœ¨æºæœåŠ¡è¿”å›ç»“æœæˆ–è€…å¼‚å¸¸ä¿¡æ¯å‘ç”Ÿåæ‰§è¡Œçš„ï¼Œå¦‚æœéœ€è¦å¯¹è¿”å›ä¿¡æ¯åšä¸€äº›å¤„ç†ï¼Œåˆ™åœ¨æ­¤ Filter è¿›è¡Œå¤„ç†ã€‚ errorï¼šåœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™ä¼šè¿›å…¥ error Filterï¼Œå¯åšå…¨å±€å¼‚å¸¸å¤„ç†ã€‚ 6.3.2 Zuul Filter å’Œ Actuator@EnableZuulProxy + Spring Boot Actuator ä¼šå¤šä¸¤ä¸ªç®¡æ§ç«¯ç‚¹ï¼š /routesï¼šè¿”å›å½“å‰ Zuul Server ä¸­æ‰€æœ‰å·²ç”Ÿæˆçš„æ˜ å°„è§„åˆ™ï¼ŒåŠ ä¸Š /details å¯æŸ¥çœ‹æ˜ç»†ã€‚ /filtersï¼šè¿”å›å½“å‰ Zuul Server ä¸­æ‰€æœ‰å·²æ³¨å†Œç”Ÿæ•ˆçš„ Filterã€‚ 6.3.3 å¤šçº§ä¸šåŠ¡å¤„ç†å®ç°è‡ªå®šä¹‰ Filter ç»§æ‰¿ ZuulFIlter æŠ½è±¡ç±»ï¼Œå®ƒåŒ…æ‹¬ä»¥ä¸‹ç­‰å‡ ä¸ªæ–¹æ³•ï¼š String filterType()ï¼šæŠ½è±¡æ–¹æ³•ã€‚ä½¿ç”¨è¿”å›å€¼è®¾ç½® Filter ç±»å‹ï¼Œå¯ä»¥è®¾ç½®ä¸º preï¼Œrouteï¼Œpostï¼Œerror ç±»å‹ã€‚ int filterOrder()ï¼šæŠ½è±¡æ–¹æ³•ã€‚ä½¿ç”¨è¿”å›å€¼è®¾ç½® Filter çš„æ‰§è¡Œé¡ºåºï¼Œå³ä¼˜å…ˆæƒã€‚ boolean shouldFilter()ï¼šä½¿ç”¨è¿”å›å€¼è®¾ç½® Filter æ˜¯å¦æ‰§è¡Œï¼Œå¯ä½œä¸ºå¼€å…³ä½¿ç”¨ã€‚ Object run()ï¼šFilter é‡Œé¢çš„æ ¸å¿ƒæ‰§è¡Œé€»è¾‘ï¼Œä¸šåŠ¡å¤„ç†åœ¨æ­¤ç¼–å†™ã€‚è¯¥æ–¹æ³•æ˜¯é‡å†™äº† IZuulFilter æ¥å£ç±»çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯ Thread / Runnable çš„ã€‚ ä»£ç å®ä¾‹ï¼š 1234567891011121314151617181920212223public class FirstPreFilter extends ZuulFilter { @Override public String filterType() { return PRE_TYPE; } @Override public int filterOrder() { return 0; } @Override public boolean shouldFilter() { return true; } @Override public Object run() throws ZuulException { System.out.println(&quot;è¿™æ˜¯ç¬¬ä¸€ä¸ªè‡ªå®šä¹‰Zuul Filterï¼&quot;); return null; }} åˆ«å¿˜è®°äº†æ³¨å…¥è¯¥ Beanï¼š 1234@Beanpublic FirstPreFilter firstPreFilter() { return new FirstPreFilter();} ä¸šåŠ¡å¤„ç†å®æˆ˜è¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸ªä¸šåŠ¡éœ€æ±‚ï¼šä½¿ç”¨ SecondPreFilter æ¥éªŒè¯è¯·æ±‚æ˜¯å¦ä¼ å…¥å‚æ•° aï¼Œä½¿ç”¨ ThirdPreFilter æ¥éªŒè¯æ˜¯å¦ä¼ å…¥ b å‚æ•°ï¼Œæœ€ååœ¨ PostFilter é‡Œè¾¹ç»Ÿä¸€å¤„ç†è¿”å›å†…å®¹ã€‚ æ³¨æ„ï¼š ä» RequestContext è·å– Request çš„è¿‡ç¨‹ã€‚ filterOrder ä¼˜å…ˆçº§çš„è®¾ç½®ã€‚ åœ¨ pre ç¦æ­¢è·¯ç”±åçš„å¤„ç†ï¼šè®¾å®š responseBody ä¾› PostFilter ä½¿ç”¨ï¼›ä¸ºåŒç±»å‹ä¸‹æ¸¸ Filter è®¾ç½®æ‰§è¡Œå¼€å…³ã€‚ ä»¥ä¸‹ä¸º SecondPreFilter.java: 12345678910111213141516171819202122232425262728293031323334353637383940414243public class SecondPreFilter extends ZuulFilter { @Override public String filterType() { return PRE_TYPE; } @Override public int filterOrder() { return 2; } @Override public boolean shouldFilter() { return true; } @Override public Object run() throws ZuulException { System.out.println(&quot;è¿™æ˜¯SecondPreFilterï¼&quot;); //ä»RequestContextè·å–ä¸Šä¸‹æ–‡ RequestContext ctx = RequestContext.getCurrentContext(); //ä»ä¸Šä¸‹æ–‡è·å–HttpServletRequest HttpServletRequest request = ctx.getRequest(); //ä»requestå°è¯•è·å–aå‚æ•°å€¼ String a = request.getParameter(&quot;a&quot;); //å¦‚æœaå‚æ•°å€¼ä¸ºç©ºåˆ™è¿›å…¥æ­¤é€»è¾‘ if (null == a) { //å¯¹è¯¥è¯·æ±‚ç¦æ­¢è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯ç¦æ­¢è®¿é—®ä¸‹æ¸¸æœåŠ¡ ctx.setSendZuulResponse(false); //è®¾å®šresponseBodyä¾›PostFilterä½¿ç”¨ ctx.setResponseBody(&quot;{\\&quot;status\\&quot;:500,\\&quot;message\\&quot;:\\&quot;aå‚æ•°ä¸ºç©ºï¼\\&quot;}&quot;); //logic-is-successä¿å­˜äºä¸Šä¸‹æ–‡ï¼Œä½œä¸ºåŒç±»å‹ä¸‹æ¸¸Filterçš„æ‰§è¡Œå¼€å…³ ctx.set(&quot;logic-is-success&quot;, false); //åˆ°è¿™é‡Œæ­¤Filteré€»è¾‘ç»“æŸ return null; } //è®¾ç½®é¿å…æŠ¥ç©º ctx.set(&quot;logic-is-success&quot;, true); return null; }} ThirdPreFilter.java: 123456789101112131415161718192021222324252627282930313233343536373839404142public class ThirdPreFilter extends ZuulFilter { @Override public String filterType() { return PRE_TYPE; } @Override public int filterOrder() { return 3; } @Override public boolean shouldFilter() { RequestContext ctx = RequestContext.getCurrentContext(); //ä»ä¸Šä¸‹æ–‡è·å–logic-is-successå€¼ï¼Œç”¨äºåˆ¤æ–­æ­¤Filteræ˜¯å¦æ‰§è¡Œ return (boolean)ctx.get(&quot;logic-is-success&quot;); } @Override public Object run() throws ZuulException { System.out.println(&quot;è¿™æ˜¯ThirdPreFilterï¼&quot;); //ä»RequestContextè·å–ä¸Šä¸‹æ–‡ RequestContext ctx = RequestContext.getCurrentContext(); //ä»ä¸Šä¸‹æ–‡è·å–HttpServletRequest HttpServletRequest request = ctx.getRequest(); //ä»requestå°è¯•è·å–bå‚æ•°å€¼ String b = request.getParameter(&quot;b&quot;); //å¦‚æœbå‚æ•°å€¼ä¸ºç©ºåˆ™è¿›å…¥æ­¤é€»è¾‘ if (null == b) { //å¯¹è¯¥è¯·æ±‚ç¦æ­¢è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯ç¦æ­¢è®¿é—®ä¸‹æ¸¸æœåŠ¡ ctx.setSendZuulResponse(false); //è®¾å®šresponseBodyä¾›PostFilterä½¿ç”¨ ctx.setResponseBody(&quot;{\\&quot;status\\&quot;:500,\\&quot;message\\&quot;:\\&quot;bå‚æ•°ä¸ºç©ºï¼\\&quot;}&quot;); //logic-is-successä¿å­˜äºä¸Šä¸‹æ–‡ï¼Œä½œä¸ºåŒç±»å‹ä¸‹æ¸¸Filterçš„æ‰§è¡Œå¼€å…³ï¼Œå‡å®šåç»­è¿˜æœ‰è‡ªå®šä¹‰Filterå½“è®¾ç½®æ­¤å€¼ ctx.set(&quot;logic-is-success&quot;, false); //åˆ°è¿™é‡Œæ­¤Filteré€»è¾‘ç»“æŸ return null; } return null; }} PostFilter ä¸»è¦æ˜¯ç”¨äºæ£€æŸ¥æœ‰æ— å®šåˆ¶ ResponseBodyï¼Œä»¥åŠè®¾ç½®å“åº”å­—ç¬¦é›†ï¼Œé¿å…ä¸­æ–‡ä¹±ç ï¼Œæ­¤å¤–è¿˜è®¾å®šäº† http çŠ¶æ€ç ã€‚ PostFilter.java: 12345678910111213141516171819202122232425262728293031323334353637public class PostFilter extends ZuulFilter { @Override public String filterType() { return POST_TYPE; } @Override public int filterOrder() { return 0; } @Override public boolean shouldFilter() { return true; } @Override public Object run() throws ZuulException { System.out.println(&quot;è¿™æ˜¯PostFilterï¼&quot;); //ä»RequestContextè·å–ä¸Šä¸‹æ–‡ RequestContext ctx = RequestContext.getCurrentContext(); //å¤„ç†è¿”å›ä¸­æ–‡ä¹±ç  ctx.getResponse().setCharacterEncoding(&quot;UTF-8&quot;); //è·å–ä¸Šä¸‹æ–‡ä¸­ä¿å­˜çš„responseBody String responseBody = ctx.getResponseBody(); //å¦‚æœresponseBodyä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜æµç¨‹æœ‰å¼‚å¸¸å‘ç”Ÿ if (null != responseBody) { //è®¾å®šè¿”å›çŠ¶æ€ç  ctx.setResponseStatusCode(500); //æ›¿æ¢å“åº”æŠ¥æ–‡ ctx.setResponseBody(responseBody); } return null; }} 6.3.4 Zuul æƒé™é›†æˆ Spring Cloud ä¸é€‰æ‹© Apache Shiro çš„åŸå› ï¼šShiro æ›´é€‚åˆå•ä½“åº”ç”¨çš„åœºæ™¯ã€‚åœ¨è§£å†³æ–¹æ¡ˆçš„é€‰æ‹©ä¸Šé¢ï¼Œä¼ ç»Ÿçš„è­¬å¦‚å•ç‚¹ç™»é™†ï¼ˆSSOï¼‰ï¼Œæˆ–è€…åˆ†å¸ƒå¼ Sessionï¼Œè¦ä¹ˆè‡´ä½¿æƒé™æœåŠ¡å™¨é›†ä¸­åŒ–å¯¼è‡´æµé‡è‡ƒè‚¿ï¼Œè¦ä¹ˆéœ€è¦è‡ªå·±å®ç°ä¸€å¥—å¤æ‚çš„å­˜å‚¨åŒæ­¥æœºåˆ¶ï¼Œéƒ½ä¸æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆã€‚å¯¹äº Zuulï¼Œæ¯”è¾ƒå¥½çš„æ–¹æ¡ˆæœ‰ï¼š è‡ªå®šä¹‰æƒé™è®¤è¯ Filter OAuth2.0 + JWT(JSON Web Token) ä½¿ç”¨ OAuth2.0 åè®®çš„æ€æƒ³æ‹‰å–è®¤è¯ç”Ÿæˆ Tokenï¼Œå†é¢å‘ç»™ JWTã€‚ä½¿ç”¨ JWT ç¬æ—¶ä¿å­˜è¿™ä¸ª Tokenï¼Œåœ¨å®¢æˆ·ç«¯ä¸èµ„æºç«¯è¿›è¡Œå¯¹ç§°æˆ–éå¯¹ç§°åŠ å¯†ï¼Œä½¿å¾—è¿™ä¸ªè§„çº¦å…·æœ‰å®šæ—¶ã€å®šé‡çš„æˆæƒè®¤è¯åŠŸèƒ½ï¼Œä»è€Œå…å» Token å­˜å‚¨æ‰€å¸¦æ¥çš„å®‰å…¨æˆ–ç³»ç»Ÿæ‹“å±•é—®é¢˜ã€‚ å•ç‚¹ç™»é™†ï¼ˆSSOï¼‰å’Œåˆ†å¸ƒå¼ Session ä»‹ç»è®¤è¯ (authentication) å’Œæˆæƒ (authorization) çš„åŒºåˆ«User å’Œ Password Zuul + OAuth2.0 + JWT å®æˆ˜ - Hardly1). zuul-server ç¼–å†™è¯´æ˜ zuul-server çš„ä½œç”¨æ˜¯å½“è¯·æ±‚æ¥å£æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦ç™»å½•é‰´æƒã€‚å¦‚æœæœªç™»å½•ï¼Œåˆ™è·³è½¬åˆ° auth-server çš„ç™»å½•ç•Œé¢ï¼ˆé»˜è®¤ä¸º Spring Security OAuth çš„ç™»å½•ç•Œé¢ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œå®šåˆ¶ã€‚ï¼‰ï¼Œç™»å½•æˆåŠŸå auth-server é¢å‘ jwt tokenï¼Œzuul-server åœ¨è®¿é—®ä¸‹æ¸¸æœåŠ¡æ—¶å°† jwt token æ”¾å…¥ header ä¸­å³å¯ã€‚ å…·ä½“å®ç°ï¼š åœ¨ pom.xml ä¸­å¼•å…¥å¯¹ OAuth2 ä¸ Security çš„æ”¯æŒï¼š 12345678&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-security&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;&lt;/dependency&gt; ç¼–å†™æ ¸å¿ƒé…ç½®æ–‡ä»¶ bootstrap.ymlï¼š 1234567891011121314151617181920212223242526272829spring: application: name: zuul-serverserver: port: 5555eureka: client: serviceUrl: defaultZone: http://${eureka.host:127.0.0.1}:${eureka.port:8888}/eureka/ instance: prefer-ip-address: truezuul: routes: client-a: path: /client/** serviceId: client-asecurity: basic: enabled: false oauth2: client: access-token-uri: http://localhost:7777/uaa/oauth/token #ä»¤ç‰Œç«¯ç‚¹ user-authorization-uri: http://localhost:7777/uaa/oauth/authorize #æˆæƒç«¯ç‚¹ client-id: zuul_server #OAuth2å®¢æˆ·ç«¯ID client-secret: secret #OAuth2å®¢æˆ·ç«¯å¯†é’¥ resource: jwt: key-value: springcloud123 #ä½¿ç”¨å¯¹ç§°åŠ å¯†æ–¹å¼ï¼Œé»˜è®¤ç®—æ³•ä¸ºHS256 ç¼–å†™ä¸»å¯åŠ¨ç±»ï¼Œé‡å†™ WebSecurityConfigurerAdapter é€‚é…å™¨çš„ configure(HttpSecurity http) æ–¹æ³•ï¼Œå£°æ˜éœ€è¦é‰´æƒçš„ url ä¿¡æ¯ï¼š 1234567891011121314151617181920212223@SpringBootApplication@EnableDiscoveryClient@EnableZuulProxy@EnableOAuth2Ssopublic class ZuulServerApplication extends WebSecurityConfigurerAdapter{ public static void main(String[] args) { SpringApplication.run(ZuulServerApplication.class, args); } @Override protected void configure(HttpSecurity http) throws Exception { http .authorizeRequests() .antMatchers(&quot;/login&quot;, &quot;/client/**&quot;) .permitAll() .anyRequest() .authenticated() .and() .csrf() .disable(); }} 2). auth-server ç¼–å†™è¯´æ˜ auth-server ä½œä¸ºè®¤è¯æˆæƒä¸­å¿ƒï¼Œä¼šç”Ÿæˆé¢å‘ jwt token å‡­è¯ã€‚ å…·ä½“å®ç°ï¼š åœ¨ pom.xml ä¸­å¼•å…¥å¯¹ OAuth2 çš„æ”¯æŒï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;&lt;/dependency&gt; ç¼–å†™æ ¸å¿ƒé…ç½®æ–‡ä»¶ bootstrap.ymlï¼š 12345678910111213spring: application: name: auth-serverserver: port: 7777 servlet: contextPath: /uaa #webåŸºè·¯å¾„eureka: client: serviceUrl: defaultZone: http://${eureka.host:127.0.0.1}:${eureka.port:8888}/eureka/ instance: prefer-ip-address: true ç¼–å†™è®¤è¯æˆæƒæœåŠ¡é€‚é…å™¨ç±» **OAuthConfiguration.java**ï¼š 123456789101112131415161718192021222324252627282930313233343536373839@Configuration@EnableAuthorizationServerpublic class OAuthConfiguration extends AuthorizationServerConfigurerAdapter { @Autowired private AuthenticationManager authenticationManager; @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients .inMemory() .withClient(&quot;zuul_server&quot;) .secret(&quot;secret&quot;) .scopes(&quot;WRIGTH&quot;, &quot;read&quot;).autoApprove(true) .authorities(&quot;WRIGTH_READ&quot;, &quot;WRIGTH_WRITE&quot;) .authorizedGrantTypes(&quot;implicit&quot;, &quot;refresh_token&quot;, &quot;password&quot;, &quot;authorization_code&quot;); } @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception { endpoints .tokenStore(jwtTokenStore()) .tokenEnhancer(jwtTokenConverter()) .authenticationManager(authenticationManager); } @Bean public TokenStore jwtTokenStore() { return new JwtTokenStore(jwtTokenConverter()); } @Bean protected JwtAccessTokenConverter jwtTokenConverter() { JwtAccessTokenConverter converter = new JwtAccessTokenConverter(); converter.setSigningKey(&quot;springcloud123&quot;); return converter; }} ç¼–å†™ä¸»å¯åŠ¨ç±»ï¼š 12345678910111213141516171819202122232425262728@SpringBootApplication@EnableDiscoveryClientpublic class AuthServerApplication extends WebSecurityConfigurerAdapter { public static void main(String[] args) { SpringApplication.run(AuthServerApplication.class, args); } @Bean(name = BeanIds.AUTHENTICATION_MANAGER) @Override public AuthenticationManager authenticationManagerBean() throws Exception { return super.authenticationManagerBean(); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth .inMemoryAuthentication() .withUser(&quot;guest&quot;).password(&quot;guest&quot;).authorities(&quot;WRIGTH_READ&quot;) .and() .withUser(&quot;admin&quot;).password(&quot;admin&quot;).authorities(&quot;WRIGTH_READ&quot;, &quot;WRIGTH_WRITE&quot;); } @Bean public static NoOpPasswordEncoder passwordEncoder() { return (NoOpPasswordEncoder) NoOpPasswordEncoder.getInstance(); }} 3). client-a ç¼–å†™è¯´æ˜ client-a æŒ‰ç…§è§„åˆ™è§£æ jwt tokenã€‚ å…·ä½“å®ç°ï¼š ç¼–å†™ä¸»å¯åŠ¨ç±»ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152@SpringBootApplication@EnableDiscoveryClient@EnableResourceServer@RestControllerpublic class ClientAApplication extends ResourceServerConfigurerAdapter { public static void main(String[] args) { SpringApplication.run(ClientAApplication.class, args); } @RequestMapping(&quot;/test&quot;) public String test(HttpServletRequest request) { System.out.println(&quot;----------------header----------------&quot;); Enumeration headerNames = request.getHeaderNames(); while (headerNames.hasMoreElements()) { String key = (String) headerNames.nextElement(); System.out.println(key + &quot;: &quot; + request.getHeader(key)); } System.out.println(&quot;----------------header----------------&quot;); return &quot;hellooooooooooooooo!&quot;; } @Override public void configure(HttpSecurity http) throws Exception { http .csrf().disable() .authorizeRequests() .antMatchers(&quot;/**&quot;).authenticated() .antMatchers(HttpMethod.GET, &quot;/test&quot;) .hasAuthority(&quot;WRIGTH_READ&quot;); } @Override public void configure(ResourceServerSecurityConfigurer resources) throws Exception { resources .resourceId(&quot;WRIGTH&quot;) .tokenStore(jwtTokenStore()); } @Bean protected JwtAccessTokenConverter jwtTokenConverter() { JwtAccessTokenConverter converter = new JwtAccessTokenConverter(); converter.setSigningKey(&quot;springcloud123&quot;); return converter; } @Bean public TokenStore jwtTokenStore() { return new JwtTokenStore(jwtTokenConverter()); }} 6.3.5 Zuul é™æµ åº”å¯¹å¼‚å¸¸æµé‡æœ‰è®¸å¤šæ–¹æ³•ï¼Œå¦‚ï¼šé™çº§å¤„ç†ã€é™æµã€æµé‡æ’é˜Ÿã€åˆ†æµç­‰ã€‚ é™æµç®—æ³•æ¼æ¡¶ï¼ˆLeaky Bucketï¼‰æ¼æ¡¶ç®—æ³•èƒ½å¤Ÿå¼ºåˆ¶é™å®šæµé‡é€Ÿç‡ï¼Œæº¢å‡ºçš„æµé‡å¹¶éå®Œå…¨ä¸¢å¼ƒã€‚å¯å°†è¿™éƒ¨åˆ†æµé‡æ”¶é›†åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œåšæµé‡æ’é˜Ÿï¼Œå°½é‡åšåˆ°åˆç†åˆ©ç”¨èµ„æºã€‚ ä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰&nbsp; ä»¤ç‰ŒåŒ…è£…ç€æ•°æ®æµã€‚å½“æ•°æ®æµæ¶Œæ¥æ—¶ï¼Œå¦‚æœå–åˆ°ä»¤ç‰Œåˆ™æ”¾è¡Œï¼ŒåŒæ—¶æ¡¶å†…ä¸¢å¼ƒæ‰è¿™ä¸ªä»¤ç‰Œï¼›å¦‚æœä¸èƒ½å–åˆ°ä»¤ç‰Œï¼Œè¯·æ±‚åˆ™ä¼šè¢«ä¸¢å¼ƒã€‚&nbsp; ä»¤ç‰Œæ¡¶å¯ä»¥å­˜åœ¨ä¸€å®šç¨‹åº¦çš„æµé‡çªå‘ã€‚å› ä¸ºä»¤ç‰Œæ¡¶å¯ä»¥å­˜åœ¨ä¸€å®šæ•°é‡çš„ä»¤ç‰Œï¼Œä¸”ä»¤ç‰Œä¸€ç›´ä»¥æ’å®šé€Ÿç‡åŠ å…¥ã€‚ &amp;nbsp;ä»£è¡¨ No-Break Space é™æµå®æˆ˜ åˆ©ç”¨ spring-cloud-zuul-ratelimit zuul-server ç¼–å†™è¯´æ˜pom.xml 12345&lt;dependency&gt; &lt;groupId&gt;com.marcosbarbero.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-zuul-ratelimit&lt;/artifactId&gt; &lt;version&gt;2.0.6.RELEASE&lt;/version&gt;&lt;/dependency&gt; bootstrap.yml 1234567891011121314151617181920212223242526272829spring: application: name: zuul-serverserver: port: 5555eureka: client: serviceUrl: defaultZone: http://${eureka.host:127.0.0.1}:${eureka.port:8888}/eureka/ instance: prefer-ip-address: truezuul: routes: client-a: path: /client/** serviceId: client-a ratelimit: key-prefix: springcloud-book #æŒ‰ç²’åº¦æ‹†åˆ†çš„ä¸´æ—¶å˜é‡keyå‰ç¼€ enabled: true #å¯ç”¨å¼€å…³ repository: IN_MEMORY #keyå­˜å‚¨ç±»å‹ï¼Œé»˜è®¤æ˜¯IN_MEMORYæœ¬åœ°å†…å­˜ï¼Œæ­¤å¤–è¿˜æœ‰å¤šç§å½¢å¼ behind-proxy: true #è¡¨ç¤ºä»£ç†ä¹‹å default-policy: #å…¨å±€é™æµç­–ç•¥ï¼Œå¯å•ç‹¬ç»†åŒ–åˆ°æœåŠ¡ç²’åº¦ limit: 2 #åœ¨ä¸€ä¸ªå•ä½æ—¶é—´çª—å£çš„è¯·æ±‚æ•°é‡ quota: 1 #åœ¨ä¸€ä¸ªå•ä½æ—¶é—´çª—å£çš„è¯·æ±‚æ—¶é—´é™åˆ¶ refresh-interval: 3 #å•ä½æ—¶é—´çª—å£ type: - user #å¯æŒ‡å®šç”¨æˆ·ç²’åº¦ - origin #å¯æŒ‡å®šå®¢æˆ·ç«¯åœ°å€ç²’åº¦ - url #å¯æŒ‡å®šurlç²’åº¦ å½“æµé‡è¶…é™æ—¶ï¼Œä¼šè¿”å› Too Many Reqeusts 429 çŠ¶æ€ç ã€‚ 6.3.6 Zuul åŠ¨æ€è·¯ç”± 6.3.7 Zuul ç°åº¦å‘å¸ƒ 6.3.8 Zuul æ–‡ä»¶ä¸Šä¼  6.3.8 Zuul å®ç”¨å°æŠ€å·§é¥¥é¥¿åŠ è½½è¯·æ±‚ä½“ä¿®æ”¹ä½¿ç”¨ okhttp ä»£æ›¿ HttpClienté‡è¯•æœºåˆ¶Header ä¼ é€’æ•´åˆ Swagger2 è°ƒè¯•æºæœåŠ¡ç¬¬ 7 ç«  ç”Ÿäº§ç¯å¢ƒå„ç»„ä»¶å‚è€ƒé…ç½®7.1 Eureka æ¨èé…ç½®123456# eureka server# ...eureka: server: enable-self-preservation: false eviction-interval-timer-in-ms: 30000 # ä¸»åŠ¨å¤±æ•ˆæ£€æµ‹é—´éš”ï¼Œé»˜è®¤ 60sï¼Œå¯ä»¥è®¾ç½®çŸ­ä¸€ç‚¹ã€‚ 7.2 Ribbon æ¨èé…ç½®123456ribbon: ConnectTimeout: 5000 # å…¨å±€è¯·æ±‚è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 5 ç§’ã€‚ ReadTimeout: 5000 # å…¨å±€è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 5 ç§’ã€‚ MaxAutoRetries: 0 # å¯¹å½“å‰å®ä¾‹çš„é‡è¯•æ¬¡æ•°ã€‚ MaxAutoRetriesNextServer: 0 # åˆ‡æ¢ä¸‹ä¸€ä¸ªå®ä¾‹é‡è¯•æ¬¡æ•°ã€‚ OktoRetryOnAllOperations: false # å¯¹æ‰€æœ‰æ“ä½œè¯·æ±‚è¿›è¡Œé‡è¯•ã€‚ 7.3 Hystrix æ¨èé…ç½®1234567hystrix: command: default: executino: isolation: thread: timeoutInMilliseconds: 10000 # å…¨å±€è¯·æ±‚è¿æ¥çš„è¶…æ—¶æ—¶é—´é»˜è®¤ä¸º 1sï¼Œé€šå¸¸ä¼šè°ƒæ•´è¿™ä¸ªå€¼çš„å¤§å°ï¼Œæ¨èè®¾ä¸º 10sã€‚è‹¥è¯·æ±‚éœ€è¦çš„æ—¶é—´è¿‡é•¿åˆ™å¯¹å•ä¸ª command è®¾ç½®å•ç‹¬æ—¶é—´ã€‚ 7.4 Zuul æ¨èé…ç½®12345678910111213141516171819202122232425262728zuul: ribbonIsolationStrategy: THREAD threadPool: useSeparateThreadPools: true threadPoolKeyPrefix: zuulgateway max: host: max-per-route-connections: 200 max-total-connections: 500 host: socket-timeout-millis: 5000 connect-timeout-millis: 10000hystrix: threadpool: default: coreSize: 20 maximumSize: 50 maxQueueSize: -1 allowMaximumSizeToDivergeFromCoreSize: true command: default: execution: timeout: enabled: false isolation: thread: interruptOnTimeout: false timeoutInMilliseconds: 15000 ç¬¬ 8 ç«  Spring Cloud Config8.1 Spring Cloud Config å…¥é—¨æ¡ˆä¾‹ Config Server é…ç½® 12345678910111213spring: cloud: config: server: git: uri: https://gitee.com/zhongzunfa/spring-cloud-config.git # é¡¹ç›®åœ°å€ #username: #password: search-paths: SC-BOOK-CONFIG # é…ç½®æ–‡ä»¶çš„è·¯å¾„ application: name: sc-config-gitserver: port: 9090 Config Client é…ç½® 12345678spring: cloud: config: label: master uri: http://localhost:9090 # é…ç½®æ–‡ä»¶åï¼šconfig-info-dev.yml name: config-info profile: dev ConfigInfoProperties.java: 1234567891011121314@Component@ConfigurationProperties(prefix = &quot;cn.springcloud.book&quot;)public class ConfigInfoProperties { private String config; public String getConfig() { return config; } public void setConfig(String config) { this.config = config; }} 8.2 ç»“åˆ Spring Cloud bus çƒ­åˆ·æ–°8.2.1 config-server-buspom.xml: 1234567891011121314151617181920212223&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-monitor&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- éœ€è¦å®‰è£… rabbitmq --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- åšç®€å•çš„å®‰å…¨å’Œç«¯ç‚¹å¼€æ”¾ --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; SecurityConfiguration.java: 12345678@Configurationpublic class SecurityConfiguration extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { http.csrf().disable(); }} application.properties: 1 application.yml: 123456789101112131415161718192021222324252627spring: cloud: config: server: git: uri: https://gitee.com/zhongzunfa/spring-cloud-config.git #username: #password: search-paths: SC-BOOK-CONFIG bus: trace: enabled: true application: name: ch11-3-config-server-bus ## é…ç½®rabbitMQ ä¿¡æ¯ rabbitmq: host: localhost port: 5672 username: guest password: guestserver: port: 9090 8.2.2 config-client-bus-refreshpom.xml: 12345678910111213141516171819&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-client&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- åšç®€å•çš„å®‰å…¨å’Œç«¯ç‚¹å¼€æ”¾ --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; bootstrap.yml: 1234567spring: cloud: config: label: master uri: http://localhost:9090 name: config-info profile: dev application.yml: 1234567891011121314151617server: port: 9095spring: application: name: ch11-3-config-client-bus-refresh ## é…ç½®rabbitMQ ä¿¡æ¯ rabbitmq: host: localhost port: 5672 username: guest password: guest cloud: bus: trace: enabled: true ConfigClientController.java: 12345678910111213@RefreshScope@RestController@RequestMapping(&quot;configConsumer&quot;)public class ConfigClientController { @Autowired private ConfigInfoProperties configInfoValue; @RequestMapping(&quot;/getConfigInfo&quot;) public String getConfigInfo(){ return configInfoValue.getConfig(); }} æ‰§è¡ŒæœåŠ¡ç«¯çš„ç«¯ç‚¹ bus-refreshï¼Œåœ°å€ä¸º http://localhost:9090/actuator/bus-refresh å¯å°†å…¶æŒ‚åœ¨ webhooks ä¸Šã€‚ 8.3 æ•°æ®åº“çš„é…ç½®ä¸­å¿ƒçš„å®ç°8.3.1 MySQL å®ç°project of config-server-db: 123456789101112131415161718192021222324252627server: port: 9090spring: application: name: ch12-3-config-server-db cloud: config: server: jdbc: sql: SELECT `KEY`, `VALUE` FROM PROPERTIES WHERE application =? AND profile =? AND lable =? label: master refresh: refreshable: none profiles: active: jdbc ## æ•°æ®é…ç½® datasource: url: jdbc:mysql://127.0.0.1:3306/spring-cloud?useUnicode=true&amp;characterEncoding=UTF-8 username: root password: 123456 driver-class-name: com.mysql.jdbc.Driverlogging: level: org.springframework.jdbc.core: DEBUG org.springframework.jdbc.core.StatementCreatorUtils: Trace project of config-client-db: 123456789spring: cloud: config: # name, profileï¼Œlabelï¼ˆæŒ‰é¡ºåºï¼‰ æ˜¯ sql ä¸­çš„å‚æ•°ã€‚ label: master uri: http://localhost:9090 name: config-info profile: dev 8.3.2 MongoDB å®ç°project of config-server-mongodb: pom.xml: 123456789101112&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server-mongodb&lt;/artifactId&gt; &lt;version&gt;0.0.2.BUILD-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; application.yml: 123456789server: port: 9090spring: application: name: ch12-4-config-server-mongodb data: mongodb: uri: mongodb://localhost/springcloud Application.java: å¢åŠ @EnableMongoConfigServeræ³¨è§£ã€‚ project of config-client-mongodb: ç•¥ ç¬¬ 9 ç«  Spring Cloud è®¤è¯å’Œé‰´æƒ9.1 è®¤è¯å’Œé‰´æƒæ–¹æ¡ˆ9.1.1 å•ä½“åº”ç”¨ä¸‹çš„å¸¸ç”¨æ–¹æ¡ˆåœ¨ä¼ ç»Ÿçš„å•ä½“åº”ç”¨ä¸­ï¼Œä¸€èˆ¬ä¼šå†™ä¸€ä¸ªå›ºå®šçš„è®¤è¯å’Œé‰´æƒçš„åŒ…ï¼ˆåˆ©ç”¨shiroç­‰ï¼‰ï¼Œé‡Œé¢åŒ…å«äº†å¾ˆå¤šè®¤è¯å’Œé‰´æƒçš„ç±»ï¼Œå½“ç”¨æˆ·å‘èµ·è¯·æ±‚æ—¶å¯ä»¥åˆ©ç”¨ session çš„æ–¹å¼ï¼ŒæŠŠç”¨æˆ·å­˜å…¥ session å¹¶ç”Ÿæˆä¸€ä¸ª sessionIdï¼Œä¹‹åè¿”å›å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯å¯ä»¥å°† session ä¿¡æ¯å­˜åœ¨ Cookie é‡Œï¼Œä»è€Œåœ¨åç»­çš„è¯·æ±‚ä¸­é¡ºåˆ©é€šè¿‡éªŒè¯ã€‚ 9.1.2 å¾®æœåŠ¡ä¸‹ SSO å•ç‚¹ç™»å½•æ–¹æ¡ˆå¯¹æ¯ä¸ªå¾®æœåŠ¡éƒ½é‡‡ç”¨ SSO å•ç‚¹ç™»å½•æ–¹æ¡ˆã€‚ 9.1.3 åˆ†å¸ƒå¼ Session ä¸ç½‘å…³ç»“åˆæ–¹æ¡ˆStepï¼š ç”¨æˆ·åœ¨ç½‘å…³è¿›è¡Œ SSO ç™»å½•ï¼Œè¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨å’Œæœ‰æ•ˆã€‚ å¦‚æœè®¤è¯é€šè¿‡ï¼Œåˆ™å°†ç”¨æˆ·çš„ä¿¡æ¯æˆ–æ•°æ®å­˜å‚¨åœ¨ç¬¬ä¸‰æ–¹éƒ¨ä»¶ä¸­ï¼ˆå¦‚ MySQLï¼ŒRedisï¼‰ã€‚ åç«¯å¾®æœåŠ¡å¯ä»¥ä»å…±äº«å­˜å‚¨ä¸­æ‹¿åˆ°ç”¨æˆ·çš„æ•°æ®ã€‚ æ¨èæ–¹æ¡ˆï¼Œå› ä¸ºæ–¹ä¾¿åŒæ—¶å¯ä»¥åšæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ä¿è¯é«˜å¯ç”¨çš„æ–¹æ¡ˆï¼ˆæ•°æ®åº“é›†ç¾¤ï¼‰ï¼Œä¸è¿‡éœ€è¦å¢åŠ å®‰å…¨æ§åˆ¶ï¼Œæ‰€ä»¥å®ç°èµ·æ¥æœ‰ä¸€å®šå¤æ‚æ€§ã€‚ 9.1.4 å®¢æˆ·ç«¯ Token ä¸ç½‘å…³ç»“åˆæ–¹æ¡ˆStepï¼š å®¢æˆ·ç«¯æŒæœ‰ä¸€ä¸ª Tokenï¼Œé€šå¸¸å¯ç”¨ JWT æˆ–è€…å…¶ä»–åŠ å¯†çš„ç®—æ³•å®ç°è‡ªå·±çš„ä¸€ç§ Tokenï¼Œç„¶åé€šè¿‡ Token ä¿å­˜äº†ç”¨æˆ·çš„ä¿¡æ¯ã€‚ å‘èµ·è¯·æ±‚å¹¶æºå¸¦ Tokenï¼Œ Token ä¼ åˆ°ç½‘å…³å±‚åï¼Œç½‘å…³å±‚è¿›è¡Œè®¤è¯å’Œæ ¡éªŒã€‚ æ ¡éªŒé€šè¿‡ï¼Œæºå¸¦ Token åˆ°åå°çš„å¾®æœåŠ¡ä¸­ï¼Œå¯ä»¥è¿›è¡Œå…·ä½“çš„æ¥å£æˆ–è€… url éªŒè¯ã€‚ å¦‚æœè¦æ¶‰åŠç”¨æˆ·çš„å¤§é‡æ•°æ®å­˜æ”¾ï¼Œåˆ™ Token å°±æœ‰å¯èƒ½ä¸å¤§åˆé€‚ï¼Œæˆ–è€…å’Œä¸Šé¢çš„åˆ†å¸ƒå¼ Session ä¸€æ ·ï¼Œä½¿ç”¨ç¬¬ä¸‰æ–¹éƒ¨ä»¶æ¥å­˜å‚¨è¿™äº›ä¿¡æ¯ï¼Œè¿™ç§æ–¹æ¡ˆä¹Ÿæ˜¯ä¸šç•Œå¸¸ç”¨çš„æ–¹æ¡ˆï¼Œä½†å¯¹äº Token æ¥è¯´ï¼Œå®ƒçš„æ³¨é”€æœ‰ç‚¹éº»çƒ¦ï¼Œéœ€è¦åœ¨ç½‘å…³å±‚è¿›è¡Œ Token çš„æ³¨é”€ã€‚ 9.1.5 æµè§ˆå™¨ Cookie ä¸ç½‘å…³ç»“åˆæ–¹æ¡ˆæŠŠç”¨æˆ·ä¿¡æ¯å­˜åœ¨ Cookie é‡Œï¼Œç„¶åé€šè¿‡ç½‘å…³æ¥è§£æ Cookieï¼Œä»è€Œè·å¾—ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯ã€‚é€‚åˆä½œä¸ºè€ç³»ç»Ÿæ”¹é€ æ—¶é‡‡å–çš„æ–¹æ¡ˆã€‚ 9.1.6 ç½‘å…³ä¸ Token å’ŒæœåŠ¡é—´é‰´æƒç»“åˆStep: åœ¨ Gateway ç½‘å…³å±‚åšè®¤è¯ï¼Œé€šè¿‡å¯¹ç”¨æˆ·æ ¡éªŒåï¼Œä¼ é€’ç”¨æˆ·çš„ä¿¡æ¯åˆ° header ä¸­ï¼Œ åå°å¾®æœåŠ¡åœ¨æ”¶åˆ° header åè¿›è¡Œè§£æï¼Œè§£æå®ŒåæŸ¥çœ‹æ˜¯å¦æœ‰è°ƒç”¨æ­¤æœåŠ¡æˆ–è€…æŸä¸ª url çš„æƒé™ï¼Œç„¶åå®Œæˆé‰´æƒã€‚ ä»æœåŠ¡å†…éƒ¨å‘å‡ºçš„è¯·æ±‚ï¼Œåœ¨å‡ºå»æ—¶è¿›è¡Œæ‹¦æˆªï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯ä¿å­˜åœ¨ header é‡Œï¼Œç„¶åä¼ å‡ºå»ï¼Œè¢«è°ƒç”¨æ–¹æ³•è·å–åˆ° header åè¿›è¡Œè§£æå’Œé‰´æƒã€‚ 9.2 è¿˜æœ‰ä¸€ä¸ªçœ‹ä¸æ‡‚çš„æ¡ˆä¾‹â€¦ç¬¬ 10 ç«  Spring Cloud å…¨é“¾è·¯ç›‘æ§ ï¼ˆomissionï¼‰10.1 æœ¯è¯­ Spanï¼šåŸºæœ¬å·¥ä½œå•å…ƒã€‚ Traceï¼š ä¸€ç³»åˆ— Span ç»„æˆçš„æ ‘çŠ¶ç»“æ„ã€‚ Annotationï¼šæ ‡æ³¨ï¼Œç”¨æ¥æè¿°äº‹ä»¶çš„å®æ—¶çŠ¶æ€ã€‚ csï¼šClient Sentã€‚å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª Span çš„å¼€å§‹ã€‚ srï¼šServer Receivedã€‚æœåŠ¡æ–¹æ”¶åˆ°è¯·æ±‚å¹¶å¼€å§‹å¤„ç†ï¼Œå®ƒå‡å» cs çš„æ—¶é—´å°±æ˜¯ç½‘ç»œå»¶è¿Ÿæ—¶é—´ã€‚ ssï¼šServer Sentã€‚è¯·æ±‚å¤„ç†å®Œæˆï¼Œå°†å“åº”æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®ƒå‡å» sr çš„æ—¶é—´å°±æ˜¯æœåŠ¡æ–¹å¤„ç†æ—¶é—´ã€‚ crï¼šClient Receivedã€‚å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡æ–¹çš„è¿”å›å€¼ï¼Œæ˜¯å½“å‰ Span ç»“æŸçš„ä¿¡å·ã€‚ ç¬¬ 11 ç«  Spring Cloud Gatewayç¬¬ 12 ç«  Spring Cloud ä¸ gRPC12.1 gRPC æ¯” HTTP/JSON å®¢æˆ·ç«¯çš„æ€§èƒ½æ›´å¥½çš„åŸå›  gRPC é‡‡ç”¨äº† Protocol Buffers ä½œä¸ºåºåˆ—åŒ–å·¥å…·ï¼Œè¿™æ¯”é‡‡ç”¨ JSON æ–¹å¼è¿›è¡Œåºåˆ—åŒ–æ€§èƒ½æé«˜äº†ä¸å°‘ã€‚ gRPC é‡‡ç”¨äº† HTTP2 åè®®ï¼Œè¿›è¡Œäº†å¤´éƒ¨ä¿¡æ¯å‹ç¼©ï¼Œå¯¹è¿æ¥è¿›è¡Œäº†å¤šè·¯å¤ç”¨ï¼Œå‡å°‘äº† TCP çš„(çŸ­)è¿æ¥æ¬¡æ•°ã€‚ gRPC é‡‡ç”¨äº† Netty ä½œä¸º IO å¤„ç†æ¡†æ¶ï¼Œæé«˜äº†æ€§èƒ½ã€‚ HTTP2 æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶åè®®ï¼ŒHTTP1.x æ˜¯æ–‡æœ¬åè®®ã€‚ 12.2 gRPC çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µ12.2.1 æœåŠ¡å®šä¹‰gRPC å¯ä»¥å®šä¹‰ 4 ç§æœåŠ¡æ–¹æ³•ï¼š Unary RPCS Server streaming RPCS Client streaming RPCS Bidirectional streaming RPCS","link":"/2021/03/04/SpringCloud/"},{"title":"spring cloud alibaba","text":"â€¦ 0. å‰è¨€ spring cloud alibaba é¡¹ç›®åœ°å€ 0.1 ç‰ˆæœ¬è¯´æ˜ 0.2 å¯¹æ¯”æ—§ SC 1. Nacos ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚ä¸ Eureka ç›¸åŒï¼Œå‡å¼•å…¥äº† Ribbon ä¾èµ–ä½œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚ 1.1 é…ç½®å®‰è£…å¯åŠ¨ nacos-serverå…³äºé›†ç¾¤éƒ¨ç½²å¯å‚ç…§å®˜æ–¹æŒ‡å—ï¼šhttps://github.com/nacos-group/nacos-docker Discoveryapplication.yaml 123456spring: application: name: nacos-ribbon-consumer cloud: nacos: server-addr: localhost:8848 code@EnableDiscoveryClient pom.xml 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;&lt;/dependency&gt; Ribbon12345678910111213141516171819202122232425262728293031323334@SpringBootApplication@EnableDiscoveryClient@RibbonClient(name = &quot;service-provider&quot;,configuration = RibbonSpecialConfig.class)public class ConsumerApplication { public static void main(String[] args) { SpringApplication.run(ConsumerApplication.class, args); } @Bean @LoadBalanced // å¼€å¯ ribbonï¼Œè¯†åˆ«æœåŠ¡åå¹¶å®ç°è´Ÿè½½å‡è¡¡ public RestTemplate restTemplate() { return new RestTemplate(); }// @Bean// public IRule randomRule() {// return new RandomRule();// } @RestController static class TestController { @Autowired RestTemplate restTemplate; @GetMapping(&quot;/test&quot;) public String test() { // getForObject æ˜¯è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼ŒEntityæ˜¯ http æŠ¥æ–‡System.out.println(restTemplate.getForObject(&quot;http://service-provider/echo/test&quot;, String.class)); return &quot;ribbonä½œç”¨ç»“æŸ&quot;; } }} 12345678// æ­¤å¤„ä¸åŠ  @Configuration æ³¨è§£æ˜¯ä¸ºäº†é˜²æ­¢å…¨å±€ç”Ÿæ•ˆï¼Œå› ä¸ºè¯¥é…ç½®åªä½œç”¨äºä¸€ä¸ªserviceã€‚FeignClient çš„ç‹¬ç«‹é…ç½®ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚public class RibbonSpecialConfig { @Bean public IRule roundRobinRule() { return new RoundRobinRule(); }} YML æ–‡ä»¶é…ç½® &lt;clientName&gt;.ribbon.NFLoadBalancerClassName: Should implement ILoadBalancer &lt;clientName&gt;.ribbon.NFLoadBalancerRuleClassName: Should implement IRule &lt;clientName&gt;.ribbon.NFLoadBalancerPingClassName: Should implement IPing &lt;clientName&gt;.ribbon.NIWSServerListClassName: Should implement ServerList &lt;clientName&gt;.ribbon.NIWSServerListFilterClassName: Should implement ServerListFilter 1.2 è‡ªå®šä¹‰ Ribbon è´Ÿè½½å‡è¡¡ç®—æ³•åŸºäº nacos ä¸­æœåŠ¡çš„å®ä¾‹æƒé‡ Attentionï¼šç›´æ¥ä½¿ç”¨æ¡†æ¶è‡ªå¸¦çš„ NacosRule å³å¯ï¼Œä¸éœ€è¦æ‰‹åŠ¨å®ç°ã€‚ 12345678910111213141516171819202122232425262728293031@Configuration@Slf4jpublic class NacosWeightRule extends AbstractLoadBalancerRule { @Autowired private NacosDiscoveryProperties nacosDiscoveryProperties; @Override public void initWithNiwsConfig(IClientConfig iClientConfig) { } /** * æœåŠ¡å-&gt;æœåŠ¡å®ä¾‹-&gt;æœåŠ¡ */ @Override public Server choose(Object o) { BaseLoadBalancer loadBalancer = (BaseLoadBalancer) this.getLoadBalancer(); String serviceName = loadBalancer.getName(); try { // åŸºäº nacos æƒé‡çš„è´Ÿè½½å‡è¡¡ç®—æ³• Instance serviceInstance = nacosDiscoveryProperties.namingServiceInstance().selectOneHealthyInstance(serviceName); return new NacosServer(serviceInstance); } catch (NacosException e) { e.printStackTrace(); log.error(e.getErrMsg()); return null; } }} 1.3 ä½œä¸ºé…ç½®ä¸­å¿ƒå¿«é€Ÿå¼€å§‹é¦–å…ˆï¼Œåœ¨pom.xmlæ·»åŠ ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;&lt;/dependency&gt; åœ¨bootstrap.ymlä¸­é…ç½®nacos-configé…ç½®ä¸­å¿ƒåœ°å€ï¼š 12345678spring: cloud: nacos: config: server-addr: 127.0.0.1:8848 file-extension: yaml # profiles: # active: prod Note${spring.profiles.active} å½“é€šè¿‡é…ç½®æ–‡ä»¶æ¥æŒ‡å®šæ—¶å¿…é¡»æ”¾åœ¨ bootstrap.yml æ–‡ä»¶ä¸­ã€‚ | æœ€åï¼Œåœ¨nacosæ–°å»ºå¦‚ä¸‹é…ç½®å³å¯ï¼ˆåç¼€yamlä¸èƒ½ä¸ºymlï¼‰ï¼š å½“é…ç½®äº†spring.profiles.activeæ—¶ï¼Œé…ç½®ä¸­å¿ƒçš„dataIdå‘½ååº”ä¸º{appName}-{active}.yaml å¦å¤–ï¼Œç”±äº@Bean(å•ä¾‹)åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œæ‰€ä»¥åº”åœ¨@Valueæ³¨è§£æ‰€åœ¨ç±»ä¸Šå¢åŠ @RefreshScopeæ‰èƒ½åŠ¨æ€åˆ·æ–°é…ç½®ã€‚ è·å–ç¯å¢ƒå˜é‡çš„ä»£ç å¦‚ä¸‹ï¼› 123456public static void main(String[] args) { ConfigurableApplicationContext applicationContext = SpringApplication.run(NacosConfigApplication.class, args); String userName = applicationContext.getEnvironment().getProperty(&quot;env.user.name&quot;); String userAge = applicationContext.getEnvironment().getProperty(&quot;env.user.age&quot;);} å¤šä¸ªç¯å¢ƒé€šç”¨é…ç½®é…ç½®åœ¨{appName}.yamlä¸­å³å¯ï¼Œå¯¹åº”{appName}.ymlæ–‡ä»¶ã€‚ å¤šä¸ªåº”ç”¨çš„é…ç½®å…±äº«ä¾‹å¦‚ï¼Œå½“å„ä¸ªæœåŠ¡éƒ½é…ç½®äº†åŒä¸€ä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒæ—¶ï¼Œè¿™äº›é…ç½®å…¶å®éƒ½å¯ä»¥æŠ½ç¦»å‡ºä½œä¸ºé€šç”¨é…ç½®ã€‚ ï¼ˆå·²å¼ƒç”¨ï¼‰ 123456789101112131415spring.application.name=opensource-service-providerspring.cloud.nacos.config.server-addr=127.0.0.1:8848# config external configuration# 1ã€Data Id åœ¨é»˜è®¤çš„ç»„ DEFAULT_GROUP,ä¸æ”¯æŒé…ç½®çš„åŠ¨æ€åˆ·æ–°spring.cloud.nacos.config.extension-configs[0].data-id=ext-config-common01.properties# 2ã€Data Id ä¸åœ¨é»˜è®¤çš„ç»„ï¼Œä¸æ”¯æŒåŠ¨æ€åˆ·æ–°spring.cloud.nacos.config.extension-configs[1].data-id=ext-config-common02.propertiesspring.cloud.nacos.config.extension-configs[1].group=GLOBALE_GROUP# 3ã€Data Id æ—¢ä¸åœ¨é»˜è®¤çš„ç»„ï¼Œä¹Ÿæ”¯æŒåŠ¨æ€åˆ·æ–°spring.cloud.nacos.config.extension-configs[2].data-id=ext-config-common03.propertiesspring.cloud.nacos.config.extension-configs[2].group=REFRESH_GROUPspring.cloud.nacos.config.extension-configs[2].refresh=true 12345678# é…ç½®æ”¯æŒå…±äº«çš„ Data Idspring.cloud.nacos.config.shared-configs[0].data-id=common.yaml# é…ç½® Data Id æ‰€åœ¨åˆ†ç»„ï¼Œç¼ºçœé»˜è®¤ DEFAULT_GROUPspring.cloud.nacos.config.shared-configs[0].group=GROUP_APP1# é…ç½®Data Id åœ¨é…ç½®å˜æ›´æ—¶ï¼Œæ˜¯å¦åŠ¨æ€åˆ·æ–°ï¼Œç¼ºçœé»˜è®¤ falsespring.cloud.nacos.config.shared-configs[0].refresh=true é€šè¿‡ spring.cloud.nacos.config.shared-configs[n].data-id æ¥æ”¯æŒå¤šä¸ªå…±äº« Data Id çš„é…ç½®ã€‚ é€šè¿‡ spring.cloud.nacos.config.shared-configs[n].group æ¥é…ç½®è‡ªå®šä¹‰ Data Id æ‰€åœ¨çš„ç»„ï¼Œä¸æ˜ç¡®é…ç½®çš„è¯ï¼Œé»˜è®¤æ˜¯ DEFAULT_GROUPã€‚ é€šè¿‡ spring.cloud.nacos.config.shared-configs[n].refresh æ¥æ§åˆ¶è¯¥Data Idåœ¨é…ç½®å˜æ›´æ—¶ï¼Œæ˜¯å¦æ”¯æŒåº”ç”¨ä¸­åŠ¨æ€åˆ·æ–°ï¼Œé»˜è®¤falseã€‚ å…¶å®ƒç‰¹æ€§namespace ç”¨äºè¿›è¡Œç§Ÿæˆ·ç²’åº¦çš„é…ç½®éš”ç¦»ã€‚ä¸åŒçš„å‘½åç©ºé—´ä¸‹ï¼Œå¯ä»¥å­˜åœ¨ç›¸åŒçš„ Group æˆ– Data ID çš„é…ç½®ã€‚Namespace çš„å¸¸ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯ä¸åŒç¯å¢ƒçš„é…ç½®çš„åŒºåˆ†éš”ç¦»ï¼Œä¾‹å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„èµ„æºï¼ˆå¦‚é…ç½®ã€æœåŠ¡ï¼‰éš”ç¦»ç­‰ã€‚ group Nacos ä¸­çš„ä¸€ç»„é…ç½®é›†ï¼Œæ˜¯ç»„ç»‡é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚é€šè¿‡ä¸€ä¸ªæœ‰æ„ä¹‰çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ Buy æˆ– Trade ï¼‰å¯¹é…ç½®é›†è¿›è¡Œåˆ†ç»„ï¼Œä»è€ŒåŒºåˆ† Data ID ç›¸åŒçš„é…ç½®é›†ã€‚å½“æ‚¨åœ¨ Nacos ä¸Šåˆ›å»ºä¸€ä¸ªé…ç½®æ—¶ï¼Œå¦‚æœæœªå¡«å†™é…ç½®åˆ†ç»„çš„åç§°ï¼Œåˆ™é…ç½®åˆ†ç»„çš„åç§°é»˜è®¤é‡‡ç”¨ DEFAULT_GROUP ã€‚é…ç½®åˆ†ç»„çš„å¸¸è§åœºæ™¯ï¼šä¸åŒçš„åº”ç”¨æˆ–ç»„ä»¶ä½¿ç”¨äº†ç›¸åŒçš„é…ç½®ç±»å‹ï¼Œå¦‚ database_url é…ç½®å’Œ MQ_topic é…ç½®ã€‚ 1.4 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²cloneå¹¶ä½¿ç”¨docker-composeå¯åŠ¨ï¼šhttps://github.com/nacos-group/nacos-docker Attention åœ¨docker-compose.ymlå’Œxxx.envæ–‡ä»¶ä¸­ä¿®æ”¹ä½¿ç”¨è‡ªå·±åˆå§‹åŒ–åçš„mysql åˆå§‹åŒ–sqlè„šæœ¬ï¼šhttps://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql 2. Feign åº”ç”¨2.1 æ—¥å¿—æ‰“å° YML å…¨å±€é…ç½®1234567feign: client: config: default: connectTimeout: 5000 readTimeout: 5000 loggerLevel: basic YML è‡ªå®šä¹‰é…ç½®12345678910111213141516feign: client: config: feignName: connectTimeout: 5000 readTimeout: 5000 loggerLevel: full errorDecoder: com.example.SimpleErrorDecoder retryer: com.example.SimpleRetryer requestInterceptors: - com.example.FooRequestInterceptor - com.example.BarRequestInterceptor decode404: false encoder: com.example.SimpleEncoder decoder: com.example.SimpleDecoder contract: com.example.SimpleContract ä»£ç é…ç½®1logging.level.project.user.UserClient: DEBUG 1234567@Configurationpublic class FooConfiguration { @Bean Logger.Level feignLoggerLevel() { return Logger.Level.FULL; }} 2.2 å®ç°æ‹¦æˆªå™¨2.3 ç»†èŠ‚ å¤šå‚æ•°è¯·æ±‚ 12@GetMapping(&quot;/q&quot;) # ä»…é™GETè¯·æ±‚ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨@RequestParamæ›¿ä»£@SpringQueryMapæ‹†åˆ†ä¸ºå¤šä¸ªå‚æ•°ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ç”¨@RequestParam + Mapæ¥å—å‚æ•°ï¼Œä½†æ˜¯ä¸æ¨èUserDTO query(@SpringQueryMap UserDTO userDTO); å…³é—­ Hystrix 1234# To disable Hystrix in Feignfeign: hystrix: enabled: false æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ é¦–å…ˆï¼Œæ·»åŠ ä¾èµ–ï¼š 123456789101112&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;io.github.openfeign.form&lt;/groupId&gt; &lt;artifactId&gt;feign-form&lt;/artifactId&gt; &lt;version&gt;3.8.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.github.openfeign.form&lt;/groupId&gt; &lt;artifactId&gt;feign-form-spring&lt;/artifactId&gt; &lt;version&gt;3.8.0&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; æ–‡ä»¶ä¸Šä¼ ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617@FeignClient( name = &quot;file-upload-service&quot;, configuration = FileUploadServiceClient.MultipartSupportConfig.class)public interface FileUploadServiceClient extends IFileUploadServiceClient { public class MultipartSupportConfig { @Bean public Encoder feignFormEncoder () { return new SpringFormEncoder(); } } @PostMapping(value = &quot;/upload&quot;) String fileUpload(@RequestPart(value = &quot;file&quot;) MultipartFile file);} æ–‡ä»¶ä¸‹è½½ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738@FeignClient( name = &quot;${feign.name}&quot;, url = &quot;${feign.url}&quot; configuration = DownloadClient.ClientConfiguration.class)public interface DownloadClient { @RequestMapping(&quot;/multipart/download/{fileId}&quot;) MultipartFile[] download(@PathVariable(&quot;fileId&quot;) String fileId); class ClientConfiguration { @Autowired private ObjectFactory&lt;HttpMessageConverters&gt; messageConverters; @Bean public Decoder feignDecoder () { List&lt;HttpMessageConverter&lt;?&gt;&gt; springConverters = messageConverters.getObject().getConverters(); List&lt;HttpMessageConverter&lt;?&gt;&gt; decoderConverters = new ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;(springConverters.size() + 1); decoderConverters.addAll(springConverters); decoderConverters.add(new SpringManyMultipartFilesReader(4096)); HttpMessageConverters httpMessageConverters = new HttpMessageConverters(decoderConverters); return new SpringDecoder(new ObjectFactory&lt;HttpMessageConverters&gt;() { @Override public HttpMessageConverters getObject() { return httpMessageConverters; } }); } }} 2.4 æ€§èƒ½ä¼˜åŒ– è¿æ¥æ±  ä½¿ç”¨feign-httpclient(Hotoxç‰ˆæœ¬å·²ç»é›†æˆï¼Œå› ä¸ºymlçš„é…ç½®å·²æœ‰ï¼Ÿ) åœ¨pom.xmlä¸­æ·»åŠ è¯¥ä¾èµ–12345&lt;dependency&gt; &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt; &lt;artifactId&gt;feign-httpclient&lt;/artifactId&gt; &lt;version&gt;11.0&lt;/version&gt;&lt;/dependency&gt; ä¿®æ”¹ymlé…ç½®123feign: httpclient: enabled: true 3. Sentinel éšç€å¾®æœåŠ¡çš„æµè¡Œï¼ŒæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´çš„ç¨³å®šæ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Sentinel ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ï¼ˆé™æµï¼‰ã€ç†”æ–­é™çº§ï¼ˆç†”æ–­ï¼‰ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚Sentinel æ–°æ‰‹æŒ‡å—URLWith springcloud 3.1 åŸºç¡€æ¦‚å¿µæ–­è·¯å™¨çŠ¶æ€ ä¸»è¦åŠŸèƒ½ 3.2 Quick startä¸‹è½½å¹¶å¯åŠ¨ sentinel dashboardå¯åŠ¨å‘½ä»¤ï¼šjava -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar é¢å¤–å¯åŠ¨å‘½ä»¤ï¼ˆ-Dï¼‰ï¼š demo1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;&lt;/dependency&gt; 123456789101112131415161718192021222324252627282930313233343536373839@SpringBootApplicationpublic class SentinelApplication { public static void main(String[] args) { SpringApplication.run(SentinelApplication.class, args); } @Service public static class TestService { @SentinelResource(value = &quot;sayHello&quot;,blockHandler = &quot;exceptionHandler&quot;) // ,fallback = &quot;protect&quot; public String sayHello(String name) { System.out.println(10/Integer.parseInt(name)); return &quot;Hello, &quot; + name; } public String protect(String name) { return &quot;ç”Ÿä¸å‡ºäººï¼Œæˆ‘å¾ˆæŠ±æ­‰&quot;; } public String exceptionHandler(String name, BlockException ex) { // Do some log here. System.out.println(&quot;å‘µå‘µ&quot;); return &quot;Oops, error occurred at &quot; + name; } } @RestController public static class TestController { @Autowired private TestService service; @GetMapping(value = &quot;/hello/{name}&quot;) public String apiHello(@PathVariable String name) { return service.sayHello(name); } }} å¦å¤–ï¼ŒFeign çš„æ¥å…¥ä¹Ÿå’Œ Hystrix ç›¸ä¼¼ã€‚ 3.3 Sentinel é…ç½®åŸºç¡€é…ç½® é…ç½®sentinel dashboardï¼šlocalhost:8080 å…³é—­æ‰€æœ‰èŠ‚ç‚¹çš„ç›‘æ§ï¼šspring.cloud.sentinel.filter.enabled=falseï¼Œä½¿ç”¨@SentinelResourceæ³¨è§£åœ¨Serviceå®ç°æ–¹æ³•å¤„åŸ‹ç‚¹ã€‚ å¼€å¯ Sentinel å¯¹ feign çš„æ”¯æŒï¼šfeign.sentinel.enabled=true(é»˜è®¤æ˜¯ false)ã€‚å¦å¤–ï¼Œfallback çš„ç±»éœ€è¦åŠ ä¸Š@Componentæ³¨è§£ã€‚ é…ç½® DataSource è‹¥ä¸é…ç½®datasourceï¼Œæµæ§ã€é™çº§ç­‰è§„åˆ™æ— æ³•æŒä¹…åŒ–ï¼Œå®¹æ˜“é€ æˆä¸¢å¤±ã€‚ SentinelProperties å†…éƒ¨æä¾›äº† TreeMap ç±»å‹çš„ datasource å±æ€§ç”¨äºé…ç½®æ•°æ®æºä¿¡æ¯ã€‚ æ¯”å¦‚é…ç½® 4 ä¸ªæ•°æ®æºï¼š 12345678910111213141516171819202122spring.cloud.sentinel.datasource.ds1.file.file=classpath: degraderule.jsonspring.cloud.sentinel.datasource.ds1.file.rule-type=flow#spring.cloud.sentinel.datasource.ds1.file.file=classpath: flowrule.json#spring.cloud.sentinel.datasource.ds1.file.data-type=custom#spring.cloud.sentinel.datasource.ds1.file.converter-class=com.alibaba.cloud.examples.JsonFlowRuleListConverter#spring.cloud.sentinel.datasource.ds1.file.rule-type=flowspring.cloud.sentinel.datasource.ds2.nacos.server-addr=localhost:8848spring.cloud.sentinel.datasource.ds2.nacos.data-id=sentinelspring.cloud.sentinel.datasource.ds2.nacos.group-id=DEFAULT_GROUPspring.cloud.sentinel.datasource.ds2.nacos.data-type=jsonspring.cloud.sentinel.datasource.ds2.nacos.rule-type=degradespring.cloud.sentinel.datasource.ds3.zk.path = /Sentinel-Demo/SYSTEM-CODE-DEMO-FLOWspring.cloud.sentinel.datasource.ds3.zk.server-addr = localhost:2181spring.cloud.sentinel.datasource.ds3.zk.rule-type=authorityspring.cloud.sentinel.datasource.ds4.apollo.namespace-name = applicationspring.cloud.sentinel.datasource.ds4.apollo.flow-rules-key = sentinelspring.cloud.sentinel.datasource.ds4.apollo.default-flow-rule-value = testspring.cloud.sentinel.datasource.ds4.apollo.rule-type=param-flow 3.4 å¼‚å¸¸å¤„ç†å…¨å±€å¼‚å¸¸å¤„ç†1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253@Componentpublic class MyUrlBlockHandler implements UrlBlockHandler { @Override public void blocked(HttpServletRequest request, HttpServletResponse response, BlockException ex) throws IOException { ErrorMsg msg = null; if (ex instanceof FlowException) { msg = ErrorMsg.builder() .status(100) .msg(&quot;é™æµäº†&quot;) .build(); } else if (ex instanceof DegradeException) { msg = ErrorMsg.builder() .status(101) .msg(&quot;é™çº§äº†&quot;) .build(); } else if (ex instanceof ParamFlowException) { msg = ErrorMsg.builder() .status(102) .msg(&quot;çƒ­ç‚¹å‚æ•°é™æµ&quot;) .build(); } else if (ex instanceof SystemBlockException) { msg = ErrorMsg.builder() .status(103) .msg(&quot;ç³»ç»Ÿè§„åˆ™ï¼ˆè´Ÿè½½/...ä¸æ»¡è¶³è¦æ±‚ï¼‰&quot;) .build(); } else if (ex instanceof AuthorityException) { msg = ErrorMsg.builder() .status(104) .msg(&quot;æˆæƒè§„åˆ™ä¸é€šè¿‡&quot;) .build(); } // httpçŠ¶æ€ç  response.setStatus(500); response.setCharacterEncoding(&quot;utf-8&quot;); response.setHeader(&quot;Content-Type&quot;, &quot;application/json;charset=utf-8&quot;); response.setContentType(&quot;application/json;charset=utf-8&quot;); // spring mvcè‡ªå¸¦çš„jsonæ“ä½œå·¥å…·ï¼Œå«jackson new ObjectMapper() .writeValue( response.getWriter(), msg ); }}@Data@Builder@AllArgsConstructor@NoArgsConstructorclass ErrorMsg { private Integer status; private String msg;} æ–¹æ³•å†…å¼‚å¸¸å¤„ç†123456789101112@SentinelResource( value = &quot;test-sentinel-api&quot;, blockHandler = &quot;block&quot;, blockHandlerClass = TestControllerBlockHandlerClass.class, fallback = &quot;fallback&quot;)public String testSentinelResource(@RequestParam(required = false) String a) { if (StringUtils.isBlank(a)) { throw new IllegalArgumentException(&quot;a cannot be blank.&quot;); } return a;} 1234567891011121314@Slf4jpublic class TestControllerBlockHandlerClass { /** * å¤„ç†é™æµæˆ–è€…é™çº§ * * @param a * @param e * @return */ public static String block(String a, BlockException e) { log.warn(&quot;é™æµï¼Œæˆ–è€…é™çº§äº† block&quot;, e); return &quot;é™æµï¼Œæˆ–è€…é™çº§äº† block&quot;; }} 3.5 ç½‘å…³é™æµ å…³é”®å°±æ˜¯èƒ½æŠŠèµ„æºè¯†åˆ«æˆ @SentinelSourceå‚ç…§ï¼šhttps://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81 Spring Cloud GatewayZuul 1.x &amp; 2.x4. RocketMQ æ–‡æ¡£æ±‡æ€»ï¼šRocketMQ å¼€å‘è€…æŒ‡å—ï¼šhttps://github.com/apache/rocketmq/tree/master/docs/cnapache rocketmq å®˜æ–¹æ–‡æ¡£ï¼šhttps://rocketmq.apache.org/docs/quick-start/ RocketMQ-Spring æ¡†æ¶æ˜¯ RocketMQ ä¸ Spring Boot çš„æ•´åˆï¼ŒRocketMQ Spring ä¸»è¦æä¾›äº† 3 ä¸ªç‰¹æ€§ï¼š ä½¿ç”¨ RocketMQTemplate ç”¨æ¥ç»Ÿä¸€å‘é€æ¶ˆæ¯ï¼ŒåŒ…æ‹¬åŒæ­¥ã€å¼‚æ­¥å‘é€æ¶ˆæ¯å’Œäº‹åŠ¡æ¶ˆæ¯ @RocketMQTransactionListener æ³¨è§£ç”¨æ¥å¤„ç†äº‹åŠ¡æ¶ˆæ¯çš„ç›‘å¬å’Œå›æŸ¥ @RocketMQMessageListener æ³¨è§£ç”¨æ¥æ¶ˆè´¹æ¶ˆæ¯ 4.1 åŸºæœ¬æ¦‚å¿µ Additionæ ‡ç­¾(Tag)ï¼šä¸ºæ¶ˆæ¯è®¾ç½®çš„æ ‡å¿—ï¼Œç”¨äºåŒä¸€ä¸»é¢˜ä¸‹åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚æ¥è‡ªåŒä¸€ä¸šåŠ¡å•å…ƒçš„æ¶ˆæ¯ï¼Œå¯ä»¥æ ¹æ®ä¸åŒä¸šåŠ¡ç›®çš„åœ¨åŒä¸€ä¸»é¢˜ä¸‹è®¾ç½®ä¸åŒæ ‡ç­¾ã€‚æ ‡ç­¾èƒ½å¤Ÿæœ‰æ•ˆåœ°ä¿æŒä»£ç çš„æ¸…æ™°åº¦å’Œè¿è´¯æ€§ï¼Œå¹¶ä¼˜åŒ–RocketMQæä¾›çš„æŸ¥è¯¢ç³»ç»Ÿã€‚æ¶ˆè´¹è€…å¯ä»¥æ ¹æ®Tagå®ç°å¯¹ä¸åŒå­ä¸»é¢˜çš„ä¸åŒæ¶ˆè´¹é€»è¾‘ï¼Œå®ç°æ›´å¥½çš„æ‰©å±•æ€§ã€‚ 4.2 æœ€ä½³å®è·µ TIPS:a. ä¸éœ€è¦ä¾èµ–è¿”å›å€¼çš„ methods å¯ä»¥ä½¿ç”¨ async æ‰§è¡Œï¼ˆè€—æ—¶ç­‰äº 0ï¼‰ã€‚b. MQ é€‚ç”¨åœºæ™¯ï¼š Spring å®ç°å¼‚æ­¥çš„æ–¹æ³• AsyncRestTemplate @Async æ³¨è§£ï¼ˆå¸¸ç”¨ï¼‰ WebClient æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæ¬¡å¸¸ç”¨ï¼‰ï¼šç”Ÿäº§ + æ¶ˆè´¹æ¶æ„ Kafkaã€RocketMQã€RabbitMQ å¯¹æ¯” é¢è¯•å›´ç»•ï¼š1.ä¸šåŠ¡(äº‹åŠ¡ï¼Œå®šæ—¶/å»¶è¿Ÿæ¶ˆæ¯ï¼Œé‡è¯•æœºåˆ¶) 2.æ€§èƒ½(TPSï¼Œé›†ç¾¤) RocketMQ: å”¯ä¸€æ”¯æŒäº‹åŠ¡ï¼Œæ¶ˆæ¯å †ç§¯æ€§èƒ½ç¨³å®šï¼ˆå’Œå¡å¤«å¡ä¸€æ ·ï¼‰RabbitMQ: ä½¿ç”¨ Erlang è¯­è¨€ a. ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ³¨æ„äº‹é¡¹ TAG: ä¸€ä¸ªåº”ç”¨å°½å¯èƒ½ç”¨ä¸€ä¸ªTopicï¼Œè€Œæ¶ˆæ¯å­ç±»å‹åˆ™å¯ä»¥ç”¨tagsæ¥æ ‡è¯†ã€‚ 1MessageBuilder builder = MessageBuilder.withPayload(msg) .setHeader(RocketMQHeaders.TAGS, &quot;binder&quot;) .setHeader(RocketMQHeaders.KEYS, &quot;my-key&quot;) .setHeader(MessageConst.PROPERTY_DELAY_TIME_LEVEL, &quot;1&quot;); Message message = builder.build(); output().send(message); Keys: æ¯ä¸ªæ¶ˆæ¯åœ¨ä¸šåŠ¡å±‚é¢çš„å”¯ä¸€æ ‡è¯†ç è¦è®¾ç½®åˆ°keyså­—æ®µï¼Œæ–¹ä¾¿å°†æ¥å®šä½æ¶ˆæ¯ä¸¢å¤±é—®é¢˜ã€‚ 123// è®¢å•IdString orderId = &quot;20034568923546&quot;;message.setKeys(orderId); æ—¥å¿—çš„æ‰“å°ï¼šæ¶ˆæ¯å‘é€æˆåŠŸæˆ–è€…å¤±è´¥è¦æ‰“å°æ¶ˆæ¯æ—¥å¿—ï¼ŒåŠ¡å¿…è¦æ‰“å°SendResultå’Œkeyå­—æ®µã€‚ æ¶ˆæ¯å‘é€å¤±è´¥å¤„ç†æ–¹å¼Producerçš„sendæ–¹æ³•æœ¬èº«æ”¯æŒå†…éƒ¨é‡è¯•ï¼Œé‡è¯•é€»è¾‘å¦‚ä¸‹ï¼š è‡³å¤šé‡è¯•2æ¬¡ï¼ˆåŒæ­¥å‘é€ä¸º2æ¬¡ï¼Œå¼‚æ­¥å‘é€ä¸º0æ¬¡ï¼‰ã€‚ å¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™è½®è½¬åˆ°ä¸‹ä¸€ä¸ªBrokerã€‚è¿™ä¸ªæ–¹æ³•çš„æ€»è€—æ—¶æ—¶é—´ä¸è¶…è¿‡sendMsgTimeoutè®¾ç½®çš„å€¼ï¼Œé»˜è®¤10sã€‚ å¦‚æœæœ¬èº«å‘brokerå‘é€æ¶ˆæ¯äº§ç”Ÿè¶…æ—¶å¼‚å¸¸ï¼Œå°±ä¸ä¼šå†é‡è¯•ã€‚ï¼ˆè‡ªè¡Œå¤„ç†ï¼‰ å¦‚æœä¸šåŠ¡å¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå»ºè®®åº”ç”¨å¢åŠ ç›¸åº”çš„é‡è¯•é€»è¾‘ï¼šæ¯”å¦‚è°ƒç”¨sendåŒæ­¥æ–¹æ³•å‘é€å¤±è´¥æ—¶ï¼Œåˆ™å°è¯•å°†æ¶ˆæ¯å­˜å‚¨åˆ°dbï¼Œç„¶åç”±åå°çº¿ç¨‹å®šæ—¶é‡è¯•ï¼Œç¡®ä¿æ¶ˆæ¯ä¸€å®šåˆ°è¾¾Brokerã€‚(RocketMQä¸é›†æˆDBä¸»è¦è€ƒè™‘2ç‚¹ï¼šæ€§èƒ½å’Œå®‰å…¨) b. æ¶ˆè´¹è€…ä¿è¯å¹‚ç­‰æ€§åˆ©ç”¨æ¶ˆæ¯ä½“ä¸­çš„å”¯ä¸€æ ‡è¯†å­—æ®µåšåˆ¤æ–­ã€‚ä¸èƒ½ä½¿ç”¨æ¶ˆæ¯ idï¼Œå› ä¸ºå¯èƒ½ä¼šå­˜åœ¨ç›¸åŒçš„æ¶ˆæ¯æœ‰ä¸¤ä¸ªä¸åŒmsgIdçš„æƒ…å†µï¼ˆæ¶ˆè´¹è€…ä¸»åŠ¨é‡å‘ã€å› å®¢æˆ·ç«¯é‡æŠ•æœºåˆ¶å¯¼è‡´çš„é‡å¤ç­‰ï¼‰ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦ä½¿ä¸šåŠ¡å­—æ®µè¿›è¡Œé‡å¤æ¶ˆè´¹ã€‚ æ¶ˆè´¹é€Ÿåº¦æ…¢çš„å¤„ç†æ–¹å¼æé«˜æ¶ˆè´¹å¹¶è¡Œåº¦ ç»å¤§éƒ¨åˆ†æ¶ˆæ¯æ¶ˆè´¹è¡Œä¸ºéƒ½å±äº IO å¯†é›†å‹ï¼Œå³å¯èƒ½æ˜¯æ“ä½œæ•°æ®åº“ï¼Œæˆ–è€…è°ƒç”¨ RPCï¼Œè¿™ç±»æ¶ˆè´¹è¡Œä¸ºçš„æ¶ˆè´¹é€Ÿåº¦åœ¨äºåç«¯æ•°æ®åº“æˆ–è€…å¤–ç³»ç»Ÿçš„ååé‡ï¼Œé€šè¿‡å¢åŠ æ¶ˆè´¹å¹¶è¡Œåº¦ï¼Œå¯ä»¥æé«˜æ€»çš„æ¶ˆè´¹ååé‡ï¼Œä½†æ˜¯å¹¶è¡Œåº¦å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼Œåè€Œä¼šä¸‹é™ã€‚æ‰€ä»¥ï¼Œåº”ç”¨å¿…é¡»è¦è®¾ç½®åˆç†çš„å¹¶è¡Œåº¦ã€‚ å¦‚ä¸‹æœ‰å‡ ç§ä¿®æ”¹æ¶ˆè´¹å¹¶è¡Œåº¦çš„æ–¹æ³•ï¼š åŒä¸€ä¸ª ConsumerGroup ä¸‹ï¼Œé€šè¿‡å¢åŠ  Consumer å®ä¾‹æ•°é‡æ¥æé«˜å¹¶è¡Œåº¦ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯è¶…è¿‡è®¢é˜…é˜Ÿåˆ—æ•°çš„ Consumer å®ä¾‹æ— æ•ˆï¼‰ã€‚å¯ä»¥é€šè¿‡åŠ æœºå™¨ï¼Œæˆ–è€…åœ¨å·²æœ‰æœºå™¨å¯åŠ¨å¤šä¸ªè¿›ç¨‹çš„æ–¹å¼ã€‚ æé«˜å•ä¸ª Consumer çš„æ¶ˆè´¹å¹¶è¡Œçº¿ç¨‹ï¼Œé€šè¿‡ä¿®æ”¹å‚æ•° consumeThreadMinã€consumeThreadMaxå®ç°ã€‚ æ‰¹é‡æ–¹å¼æ¶ˆè´¹ æŸäº›ä¸šåŠ¡æµç¨‹å¦‚æœæ”¯æŒæ‰¹é‡æ–¹å¼æ¶ˆè´¹ï¼Œåˆ™å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜æ¶ˆè´¹ååé‡ï¼Œä¾‹å¦‚è®¢å•æ‰£æ¬¾ç±»åº”ç”¨ï¼Œä¸€æ¬¡å¤„ç†ä¸€ä¸ªè®¢å•è€—æ—¶ 1 sï¼Œä¸€æ¬¡å¤„ç† 10 ä¸ªè®¢å•å¯èƒ½ä¹Ÿåªè€—æ—¶ 2 sï¼Œè¿™æ ·å³å¯å¤§å¹…åº¦æé«˜æ¶ˆè´¹çš„ååé‡ï¼Œé€šè¿‡è®¾ç½® consumerçš„ consumeMessageBatchMaxSize è¿”ä¸ªå‚æ•°ï¼Œé»˜è®¤æ˜¯ 1ï¼Œå³ä¸€æ¬¡åªæ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯ï¼Œä¾‹å¦‚è®¾ç½®ä¸º Nï¼Œé‚£ä¹ˆæ¯æ¬¡æ¶ˆè´¹çš„æ¶ˆæ¯æ•°å°äºç­‰äº Nã€‚ c. Broker Broker è§’è‰²åˆ†ä¸º ASYNC_MASTERï¼ˆå¼‚æ­¥ä¸»æœºï¼‰ã€SYNC_MASTERï¼ˆåŒæ­¥ä¸»æœºï¼‰ä»¥åŠSLAVEï¼ˆä»æœºï¼‰ã€‚å¦‚æœå¯¹æ¶ˆæ¯çš„å¯é æ€§è¦æ±‚æ¯”è¾ƒä¸¥æ ¼ï¼Œå¯ä»¥é‡‡ç”¨ SYNC_MASTERåŠ SLAVEçš„éƒ¨ç½²æ–¹å¼ã€‚å¦‚æœå¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥é‡‡ç”¨ASYNC_MASTERåŠ SLAVEçš„éƒ¨ç½²æ–¹å¼ã€‚å¦‚æœåªæ˜¯æµ‹è¯•æ–¹ä¾¿ï¼Œåˆ™å¯ä»¥é€‰æ‹©ä»…ASYNC_MASTERæˆ–ä»…SYNC_MASTERçš„éƒ¨ç½²æ–¹å¼ã€‚ e. Message ç»“æ„ å­—æ®µå é»˜è®¤å€¼ è¯´æ˜ Topic null å¿…å¡«ï¼Œæ¶ˆæ¯æ‰€å±topicçš„åç§° Body null å¿…å¡«ï¼Œæ¶ˆæ¯ä½“ Tags null é€‰å¡«ï¼Œæ¶ˆæ¯æ ‡ç­¾ï¼Œæ–¹ä¾¿æœåŠ¡å™¨è¿‡æ»¤ä½¿ç”¨ã€‚ç›®å‰åªæ”¯æŒæ¯ä¸ªæ¶ˆæ¯è®¾ç½®ä¸€ä¸ªtag Keys null é€‰å¡«ï¼Œä»£è¡¨è¿™æ¡æ¶ˆæ¯çš„ä¸šåŠ¡å…³é”®è¯ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®keysåˆ›å»ºå“ˆå¸Œç´¢å¼•ï¼Œè®¾ç½®åï¼Œå¯ä»¥åœ¨Consoleç³»ç»Ÿæ ¹æ®Topicã€Keysæ¥æŸ¥è¯¢æ¶ˆæ¯ï¼Œç”±äºæ˜¯å“ˆå¸Œç´¢å¼•ï¼Œè¯·å°½å¯èƒ½ä¿è¯keyå”¯ä¸€ï¼Œä¾‹å¦‚è®¢å•å·ï¼Œå•†å“Idç­‰ã€‚ Flag 0 é€‰å¡«ï¼Œå®Œå…¨ç”±åº”ç”¨æ¥è®¾ç½®ï¼ŒRocketMQä¸åšå¹²é¢„ DelayTimeLevel 0 é€‰å¡«ï¼Œæ¶ˆæ¯å»¶æ—¶çº§åˆ«ï¼Œ0è¡¨ç¤ºä¸å»¶æ—¶ï¼Œå¤§äº0ä¼šå»¶æ—¶ç‰¹å®šçš„æ—¶é—´æ‰ä¼šè¢«æ¶ˆè´¹ WaitStoreMsgOK TRUE é€‰å¡«ï¼Œè¡¨ç¤ºæ¶ˆæ¯æ˜¯å¦åœ¨æœåŠ¡å™¨è½ç›˜åæ‰è¿”å›åº”ç­”ã€‚ ç³»ç»Ÿé…ç½®JVMä¼˜åŒ– æ¨èä½¿ç”¨æœ€æ–°å‘å¸ƒçš„JDK 1.8ç‰ˆæœ¬ã€‚é€šè¿‡è®¾ç½®ç›¸åŒçš„Xmså’ŒXmxå€¼æ¥é˜²æ­¢JVMè°ƒæ•´å †å¤§å°ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚ç®€å•çš„JVMé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š -server -Xms8g -Xmx8g -Xmn4g å¦‚æœæ‚¨ä¸å…³å¿ƒRocketMQ Brokerçš„å¯åŠ¨æ—¶é—´ï¼Œè¿˜æœ‰ä¸€ç§æ›´å¥½çš„é€‰æ‹©ï¼Œå°±æ˜¯é€šè¿‡â€œé¢„è§¦æ‘¸â€Javaå †ä»¥ç¡®ä¿åœ¨JVMåˆå§‹åŒ–æœŸé—´æ¯ä¸ªé¡µé¢éƒ½å°†è¢«åˆ†é…ã€‚é‚£äº›ä¸å…³å¿ƒå¯åŠ¨æ—¶é—´çš„äººå¯ä»¥å¯ç”¨å®ƒï¼š â€‹ -XX:+AlwaysPreTouchç¦ç”¨åç½®é”å®šå¯èƒ½ä¼šå‡å°‘JVMæš‚åœï¼Œ â€‹ -XX:-UseBiasedLockingè‡³äºåƒåœ¾å›æ”¶ï¼Œå»ºè®®ä½¿ç”¨å¸¦JDK 1.8çš„G1æ”¶é›†å™¨ã€‚ 1234-XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 è¿™äº›GCé€‰é¡¹çœ‹èµ·æ¥æœ‰ç‚¹æ¿€è¿›ï¼Œä½†äº‹å®è¯æ˜å®ƒåœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­å…·æœ‰è‰¯å¥½çš„æ€§èƒ½ã€‚å¦å¤–ä¸è¦æŠŠ-XX:MaxGCPauseMillisçš„å€¼è®¾ç½®å¤ªå°ï¼Œå¦åˆ™JVMå°†ä½¿ç”¨ä¸€ä¸ªå°çš„å¹´è½»ä»£æ¥å®ç°è¿™ä¸ªç›®æ ‡ï¼Œè¿™å°†å¯¼è‡´éå¸¸é¢‘ç¹çš„minor GCï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨rolling GCæ—¥å¿—æ–‡ä»¶ï¼š 1234-XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=30m å¦‚æœå†™å…¥GCæ–‡ä»¶ä¼šå¢åŠ ä»£ç†çš„å»¶è¿Ÿï¼Œå¯ä»¥è€ƒè™‘å°†GCæ—¥å¿—æ–‡ä»¶é‡å®šå‘åˆ°å†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼š 1-Xloggc:/dev/shm/mq_gc_%p.log123 é›†ç¾¤éƒ¨ç½² åŒ…æ‹¬å•Masteræ¨¡å¼ã€å¤šMasteræ¨¡å¼ã€å¤šMasterå¤šslaveæ¨¡å¼ã€‚è¯¦è§https://github.com/apache/rocketmq/blob/master/docs/cn/operation.md 4.3 demo a. å®‰è£…éƒ¨ç½²å‚è€ƒï¼šhttp://www.imooc.com/article/290089 æˆ– quick startã€‚b. å¸¸ç”¨ç‰¹æ€§æœ‰ï¼šRocketMQTemplateï¼Œ@RocketMQTransactionListenerï¼Œ@RocketMQMessageListenerc. RocketMQ Console å¯è§†åŒ–å·¥å…·ï¼šhttps://github.com/apache/rocketmq-externals/tree/master/rocketmq-console 4.4 äº‹åŠ¡å¤„ç†åŸºæœ¬æ¦‚å¿µ2PCï¼šThree-phase commitï¼ŒäºŒé˜¶æ®µæäº¤ã€‚3PCï¼šå¤šäº†ä¸€ä¸ªè¡¥å¿æœºåˆ¶ã€‚å³æœ¬åœ°æœåŠ¡æŒ‚äº†æ— æ³•é€šçŸ¥äº‹åŠ¡çŠ¶æ€çš„æ—¶å€™ï¼Œå¯¹æ–¹ï¼ˆmqï¼‰ä¼šç”±å®šæ—¶ä»»åŠ¡æ¥ä¸»åŠ¨è¯¢é—®ä»–çš„çŠ¶æ€ï¼Œå¹¶ä¸”æœ‰è¶…æ—¶æœºåˆ¶ã€‚ å®ç°åŸç†åŸç†ï¼šç­‰æœ¬åœ°äº‹åŠ¡ï¼ˆä¸€é˜¶æ®µï¼‰å®Œæˆï¼Œå†æ ¹æ®æœ¬åœ°äº‹åŠ¡çš„çŠ¶æ€å†³å®šæ—¶å€™è¦æ¶ˆè´¹è¿˜æ˜¯ä¸¢å¼ƒè¿™æ¡æ¶ˆæ¯ï¼ˆäºŒé˜¶æ®µï¼‰ã€‚ï¼ˆä»¥æ€§èƒ½æŸè€—ä¸ºä»£ä»·ï¼‰ æµç¨‹å›¾ï¼š ä»£ç å®ç°Stream-rocketmq è‹¥è¦å‘é€å¸¦äº‹åŠ¡çš„æ¶ˆæ¯ï¼Œéœ€è¦åœ¨ymlä¸­é…ç½®ï¼š 123456789spring.cloud.stream.bindings.output1.destination=test-topicspring.cloud.stream.bindings.output1.content-type=application/jsonspring.cloud.stream.rocketmq.bindings.output1.producer.group=binder-groupspring.cloud.stream.rocketmq.bindings.output1.producer.sync=truespring.cloud.stream.bindings.output2.destination=TransactionTopicspring.cloud.stream.bindings.output2.content-type=application/jsonspring.cloud.stream.rocketmq.bindings.output2.producer.transactional=true # çœ‹è¿™é‡Œspring.cloud.stream.rocketmq.bindings.output2.producer.group=myTxProducerGroup ç¤ºä¾‹ä¸€ 12345678910111213141516171819202122232425262728293031@RocketMQTransactionListener(txProducerGroup = &quot;myTxProducerGroup&quot;, corePoolSize = 5, maximumPoolSize = 10)public class TransactionListenerImpl implements RocketMQLocalTransactionListener { @Override public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) { Object num = msg.getHeaders().get(&quot;test&quot;); if (&quot;1&quot;.equals(num)) { System.out.println( &quot;executer: &quot; + new String((byte[]) msg.getPayload()) + &quot; unknown&quot;); return RocketMQLocalTransactionState.UNKNOWN; } else if (&quot;2&quot;.equals(num)) { System.out.println( &quot;executer: &quot; + new String((byte[]) msg.getPayload()) + &quot; rollback&quot;); return RocketMQLocalTransactionState.ROLLBACK; } System.out.println( &quot;executer: &quot; + new String((byte[]) msg.getPayload()) + &quot; commit&quot;); return RocketMQLocalTransactionState.COMMIT; } @Override public RocketMQLocalTransactionState checkLocalTransaction(Message msg) { System.out.println(&quot;check: &quot; + new String((byte[]) msg.getPayload())); return RocketMQLocalTransactionState.COMMIT; }} ç¤ºä¾‹äºŒï¼šç»“åˆäº‹åŠ¡è¡¨ 1234567891011121314151617181920212223242526272829303132333435363738394041@RocketMQTransactionListener(txProducerGroup = &quot;tx-add-bonus-group&quot;)@RequiredArgsConstructor(onConstructor = @__(@Autowired))public class AddBonusTransactionListener implements RocketMQLocalTransactionListener { private final ShareService shareService; private final RocketmqTransactionLogMapper rocketmqTransactionLogMapper; @Override public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) { MessageHeaders headers = msg.getHeaders(); String transactionId = (String) headers.get(RocketMQHeaders.TRANSACTION_ID); Integer shareId = Integer.valueOf((String) headers.get(&quot;share_id&quot;)); String dtoString = (String) headers.get(&quot;dto&quot;); ShareAuditDTO auditDTO = JSON.parseObject(dtoString, ShareAuditDTO.class); try { this.shareService.auditByIdWithRocketMqLog(shareId, auditDTO, transactionId); return RocketMQLocalTransactionState.COMMIT; } catch (Exception e) { return RocketMQLocalTransactionState.ROLLBACK; } } @Override public RocketMQLocalTransactionState checkLocalTransaction(Message msg) { MessageHeaders headers = msg.getHeaders(); String transactionId = (String) headers.get(RocketMQHeaders.TRANSACTION_ID); // select * from xxx where transaction_id = xxx RocketmqTransactionLog transactionLog = this.rocketmqTransactionLogMapper.selectOne( RocketmqTransactionLog.builder() .transactionId(transactionId) .build() ); if (transactionLog != null) { return RocketMQLocalTransactionState.COMMIT; } return RocketMQLocalTransactionState.ROLLBACK; }} 5. Spring Cloud StreamSpring Cloud Stream æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºåŸºäºæ¶ˆæ¯çš„å¾®æœåŠ¡åº”ç”¨æ¡†æ¶ã€‚å®ƒåŸºäº SpringBoot æ¥åˆ›å»ºå…·æœ‰ç”Ÿäº§çº§åˆ«çš„å•æœº Spring åº”ç”¨ï¼Œå¹¶ä¸”ä½¿ç”¨ Spring Integration ä¸ Broker è¿›è¡Œè¿æ¥ã€‚ Spring Cloud Stream æä¾›äº†æ¶ˆæ¯ä¸­é—´ä»¶é…ç½®çš„ç»Ÿä¸€æŠ½è±¡ï¼Œæ¨å‡ºäº† publish-subscribeã€consumer groupsã€partition è¿™äº›ç»Ÿä¸€çš„æ¦‚å¿µã€‚ Spring Cloud Stream å†…éƒ¨æœ‰ä¸¤ä¸ªæ¦‚å¿µï¼šBinder å’Œ Bindingã€‚ Binder: è·Ÿå¤–éƒ¨æ¶ˆæ¯ä¸­é—´ä»¶é›†æˆçš„ç»„ä»¶ï¼Œç”¨æ¥åˆ›å»º Bindingï¼Œå„æ¶ˆæ¯ä¸­é—´ä»¶éƒ½æœ‰è‡ªå·±çš„ Binder å®ç°ã€‚ æ¯”å¦‚ Kafka çš„å®ç° KafkaMessageChannelBinderï¼ŒRabbitMQ çš„å®ç° RabbitMessageChannelBinder ä»¥åŠ RocketMQ çš„å®ç° RocketMQMessageChannelBinderã€‚ Binding: åŒ…æ‹¬ Input Binding(æ¶ˆè´¹è€…) å’Œ Output Bindingï¼ˆç”Ÿäº§è€…ï¼‰ã€‚ Binding åœ¨æ¶ˆæ¯ä¸­é—´ä»¶ä¸åº”ç”¨ç¨‹åºæä¾›çš„ Provider å’Œ Consumer ä¹‹é—´æä¾›äº†ä¸€ä¸ªæ¡¥æ¢ï¼Œå®ç°äº†å¼€å‘è€…åªéœ€ä½¿ç”¨åº”ç”¨ç¨‹åºçš„ Provider æˆ– Consumer ç”Ÿäº§æˆ–æ¶ˆè´¹æ•°æ®å³å¯ï¼Œå±è”½äº†å¼€å‘è€…ä¸åº•å±‚æ¶ˆæ¯ä¸­é—´ä»¶çš„æ¥è§¦ã€‚ NOTEï¼ˆæ³¨è§£ä»¥åå¯èƒ½å¼ƒç”¨ï¼‰:æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ï¼ˆè¯·å‚é˜…Spring Cloud Functionæ”¯æŒï¼‰å°†å•ä¸ªæ¶ˆæ¯å¤„ç†ç¨‹åºå®šä¹‰ä¸ºConsumer 5.1 ç¤ºä¾‹å¦‚ä½•æ¥å…¥ RocketMQåœ¨å¯åŠ¨ç¤ºä¾‹è¿›è¡Œæ¼”ç¤ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ Spring Cloud åº”ç”¨å¦‚ä½•æ¥å…¥ RocketMQ Binderã€‚ æ³¨æ„ï¼šæœ¬ç« èŠ‚åªæ˜¯ä¸ºäº†ä¾¿äºæ‚¨ç†è§£æ¥å…¥æ–¹å¼ï¼Œæœ¬ç¤ºä¾‹ä»£ç ä¸­å·²ç»å®Œæˆ**æ¥å…¥å·¥ä½œï¼Œæ‚¨æ— éœ€å†è¿›è¡Œä¿®æ”¹ã€‚** é¦–å…ˆï¼Œä¿®æ”¹ pom.xml æ–‡ä»¶ï¼Œå¼•å…¥ RocketMQ Stream Starterã€‚ 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-stream-rocketmq&lt;/artifactId&gt;&lt;/dependency&gt; é…ç½® Input å’Œ Output çš„ Binding ä¿¡æ¯å¹¶é…åˆ @EnableBinding æ³¨è§£ä½¿å…¶ç”Ÿæ•ˆ 1234567@SpringBootApplication@EnableBinding({ Source.class, Sink.class })public class RocketMQApplication { public static void main(String[] args) { SpringApplication.run(RocketMQApplication.class, args); }} é…ç½® Binding ä¿¡æ¯ï¼š 1234567891011# é…ç½®rocketmqçš„nameserveråœ°å€spring.cloud.stream.rocketmq.binder.name-server=127.0.0.1:9876# å®šä¹‰nameä¸ºoutputçš„bindingspring.cloud.stream.bindings.output.destination=test-topicspring.cloud.stream.bindings.output.content-type=application/json# å®šä¹‰nameä¸ºinputçš„bindingspring.cloud.stream.bindings.input.destination=test-topicspring.cloud.stream.bindings.input.content-type=application/json# input çš„ group ä¸èƒ½çœç•¥ï¼Œå¦åˆ™ä¼šæŠ¥é”™spring.cloud.stream.bindings.input.group=test-group ç¤ºä¾‹ä»£ç  123456789101112131415161718192021222324252627282930313233@SpringBootApplication@EnableBinding({Source.class, Sink.class})public class RocketMQApplication { public static void main(String[] args) { SpringApplication.run(RocketMQApplication.class, args); } @Service static class TestService { @StreamListener(&quot;input&quot;) public void consumer(String msg) { System.out.println(&quot;æ¥å—åˆ°çš„æ¶ˆæ¯ä¸ºï¼š&quot; + msg); } // æ¶ˆè´¹æŒ‡å®štagçš„æ¶ˆæ¯ } @RestController static class TestController { @Autowired// private MessageChannel output; private Source source; @GetMapping(&quot;/test/{msg}&quot;) public String test(@PathVariable String msg) { source.output().send(MessageBuilder.withPayload(msg).build()); System.out.println(&quot;æ¶ˆæ¯å·²å‘é€&quot;); return msg; } }} æ¶ˆæ¯å¤„ç†ä½¿ç”¨ name ä¸º output å¯¹åº”çš„ binding å‘é€æ¶ˆæ¯åˆ° test-topic è¿™ä¸ª topicã€‚ ä½¿ç”¨2ä¸ª input binding è®¢é˜…æ•°æ®ã€‚ input1: è®¢é˜… topic ä¸º test-topic çš„æ¶ˆæ¯ï¼Œé¡ºåºæ¶ˆè´¹æ‰€æœ‰æ¶ˆæ¯(é¡ºåºæ¶ˆè´¹çš„å‰ææ˜¯æ‰€æœ‰æ¶ˆæ¯éƒ½åœ¨ä¸€ä¸ª MessageQueue ä¸­) input2: è®¢é˜… topic ä¸º test-topic çš„æ¶ˆæ¯ï¼Œå¼‚æ­¥æ¶ˆè´¹ tags ä¸º tagStr çš„æ¶ˆæ¯ï¼ŒConsumer ç«¯çº¿ç¨‹æ± ä¸ªæ•°ä¸º20 é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š 1234567891011121314151617spring.cloud.stream.rocketmq.binder.name-server=127.0.0.1:9876spring.cloud.stream.bindings.output.destination=test-topicspring.cloud.stream.bindings.output.content-type=application/jsonspring.cloud.stream.bindings.input1.destination=test-topicspring.cloud.stream.bindings.input1.content-type=text/plainspring.cloud.stream.bindings.input1.group=test-group1spring.cloud.stream.rocketmq.bindings.input1.consumer.orderly=truespring.cloud.stream.bindings.input2.destination=test-topicspring.cloud.stream.bindings.input2.content-type=text/plainspring.cloud.stream.bindings.input2.group=test-group2spring.cloud.stream.rocketmq.bindings.input2.consumer.orderly=falsespring.cloud.stream.rocketmq.bindings.input2.consumer.tags=tagStrspring.cloud.stream.bindings.input2.consumer.concurrency=20 æ¶ˆæ¯å‘é€ä½¿ç”¨ MessageChannel è¿›è¡Œæ¶ˆæ¯å‘é€ï¼š 123456789101112public class ProducerRunner implements CommandLineRunner { @Autowired private MessageChannel output; // è·å–nameä¸ºoutputçš„binding @Override public void run(String... args) throws Exception { Map&lt;String, Object&gt; headers = new HashMap&lt;&gt;(); headers.put(MessageConst.PROPERTY_TAGS, &quot;tagStr&quot;); Message message = MessageBuilder.createMessage(msg, new MessageHeaders(headers)); output.send(message); }} æˆ–è€…ä½¿ç”¨ RocketMQ åŸç”Ÿçš„ API è¿›è¡Œæ¶ˆæ¯å‘é€: 123456789public class RocketMQProducer { DefaultMQProducer producer = new DefaultMQProducer(&quot;producer_group&quot;); producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;); producer.start(); Message msg = new Message(&quot;test-topic&quot;, &quot;tagStr&quot;, &quot;message from rocketmq producer&quot;.getBytes()); producer.send(msg);} æ¶ˆæ¯æ¥æ”¶ä½¿ç”¨ @StreamListener æ³¨è§£æ¥æ”¶æ¶ˆæ¯ï¼š 1234567891011121314@Servicepublic class ReceiveService { @StreamListener(&quot;input1&quot;) public void receiveInput1(String receiveMsg) { System.out.println(&quot;input1 receive: &quot; + receiveMsg); } @StreamListener(&quot;input2&quot;) public void receiveInput2(String receiveMsg) { System.out.println(&quot;input2 receive: &quot; + receiveMsg); }} æ¶ˆæ¯è¿‡æ»¤å¯å‚ç…§ï¼šhttp://www.imooc.com/article/290424 ä¸»è¦åŒ…æ‹¬Tagså’Œ@StreamListenerçš„condition 5.2 é…ç½®è¯´æ˜Stream-RocketMQRocketMQ Consumer Propertiesä¸‹é¢çš„è¿™äº›é…ç½®æ˜¯ä»¥ spring.cloud.stream.rocketmq.bindings.&lt;channelName&gt;.consumer. ä¸ºå‰ç¼€çš„ RocketMQ Consumer ç›¸å…³çš„é…ç½®ã€‚ enableæ˜¯å¦å¯ç”¨ Consumerã€‚ é»˜è®¤å€¼: true. tagsConsumer åŸºäº TAGS è®¢é˜…ï¼Œå¤šä¸ª tag ä»¥ || åˆ†å‰²ã€‚ é»˜è®¤å€¼: empty. sqlConsumer åŸºäº SQL è®¢é˜…ã€‚ é»˜è®¤å€¼: empty. broadcastingConsumer æ˜¯å¦æ˜¯å¹¿æ’­æ¶ˆè´¹æ¨¡å¼ã€‚å¦‚æœæƒ³è®©æ‰€æœ‰çš„è®¢é˜…è€…éƒ½èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨å¹¿æ’­æ¨¡å¼ã€‚ é»˜è®¤å€¼: false. orderlyConsumer æ˜¯å¦åŒæ­¥æ¶ˆè´¹æ¶ˆæ¯æ¨¡å¼ã€‚ é»˜è®¤å€¼: false. delayLevelWhenNextConsumeå¼‚æ­¥æ¶ˆè´¹æ¶ˆæ¯æ¨¡å¼ä¸‹æ¶ˆè´¹å¤±è´¥é‡è¯•ç­–ç•¥ï¼š -1,ä¸é‡å¤ï¼Œç›´æ¥æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ— 0,broker æ§åˆ¶é‡è¯•ç­–ç•¥ 0,client æ§åˆ¶é‡è¯•ç­–ç•¥ é»˜è®¤å€¼: 0. suspendCurrentQueueTimeMillisåŒæ­¥æ¶ˆè´¹æ¶ˆæ¯æ¨¡å¼ä¸‹æ¶ˆè´¹å¤±è´¥åå†æ¬¡æ¶ˆè´¹çš„æ—¶é—´é—´éš”ã€‚ é»˜è®¤å€¼: 1000. RocketMQ Provider Propertiesä¸‹é¢çš„è¿™äº›é…ç½®æ˜¯ä»¥ spring.cloud.stream.rocketmq.bindings.&lt;channelName&gt;.producer. ä¸ºå‰ç¼€çš„ RocketMQ Producer ç›¸å…³çš„é…ç½®ã€‚ enableæ˜¯å¦å¯ç”¨ Producerã€‚ é»˜è®¤å€¼: true. groupProducer group nameã€‚ é»˜è®¤å€¼: empty. maxMessageSizeæ¶ˆæ¯å‘é€çš„æœ€å¤§å­—èŠ‚æ•°ã€‚ é»˜è®¤å€¼: 8249344. transactionalæ˜¯å¦å‘é€äº‹åŠ¡æ¶ˆæ¯ã€‚ é»˜è®¤å€¼: false. syncæ˜¯å¦ä½¿ç”¨åŒæ­¥å¾—æ–¹å¼å‘é€æ¶ˆæ¯ã€‚ é»˜è®¤å€¼: false. vipChannelEnabledæ˜¯å¦åœ¨ Vip Channel ä¸Šå‘é€æ¶ˆæ¯ã€‚ é»˜è®¤å€¼: true. sendMessageTimeoutå‘é€æ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´(æ¯«ç§’)ã€‚ é»˜è®¤å€¼: 3000. compressMessageBodyThresholdæ¶ˆæ¯ä½“å‹ç¼©é˜€å€¼(å½“æ¶ˆæ¯ä½“è¶…è¿‡ 4k çš„æ—¶å€™ä¼šè¢«å‹ç¼©)ã€‚ é»˜è®¤å€¼: 4096. retryTimesWhenSendFailedåœ¨åŒæ­¥å‘é€æ¶ˆæ¯çš„æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥çš„é‡è¯•æ¬¡æ•°ã€‚ é»˜è®¤å€¼: 2. retryTimesWhenSendAsyncFailedåœ¨å¼‚æ­¥å‘é€æ¶ˆæ¯çš„æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥çš„é‡è¯•æ¬¡æ•°ã€‚ é»˜è®¤å€¼: 2. retryNextServeræ¶ˆæ¯å‘é€å¤±è´¥çš„æƒ…å†µä¸‹æ˜¯å¦é‡è¯•å…¶å®ƒçš„ brokerã€‚ é»˜è®¤å€¼: false. 5.3 Stream å…¶å®ƒç‰¹æ€§ç›‘æ§ å¼•å…¥ actuator ä¾èµ–å³å¯ã€‚ å¼‚å¸¸å¤„ç† å‚ç…§ï¼šhttp://www.imooc.com/article/290435 æ­¤å¤„å±•ç¤ºä¸€ç§å…¨å±€å¤„ç†ï¼š 1234567891011@StreamListener(value = Processor.INPUT)public void handle(String body) { throw new RuntimeException(&quot;x&quot;);}@StreamListener(&quot;errorChannel&quot;)public void error(Message&lt;?&gt; message) { ErrorMessage errorMessage = (ErrorMessage) message; System.out.println(&quot;Handling ERROR: &quot; + errorMessage);} ä¹‹å‰åšè¿‡çš„é¡¹ç›®æ˜¯ï¼Œä¸ç®¡å¼‚å¸¸ä¸å¦ï¼Œéƒ½ä¼š ACK æ¶ˆè´¹æ¶ˆæ¯ï¼Œå†åœ¨ç‰¹å®šæ–¹æ³•ä¸­å¤„ç†å¼‚å¸¸ï¼ˆæœ€ç®€å•çš„å°±æ˜¯è®°å½•æ—¥å¿—ï¼Œå†æ‰‹åŠ¨å¤„ç†ï¼‰ã€‚ 6. Gateway å¾®æœåŠ¡ä½¿ç”¨ç½‘å…³/è·¯ç”±çš„å¿…è¦æ€§ï¼ˆç›¸æ¯”ç›´æ¥è°ƒç”¨å…·ä½“æœåŠ¡çš„ APIï¼‰ï¼šç™»å½•ï¼Œé‰´æƒï¼Œapiå˜åŠ¨å°ï¼Œè¿‡æ»¤å™¨ã€‚ 6.1 æ¦‚å¿µæœ¯è¯­ Route: æ„å»ºç½‘å…³çš„åŸºæœ¬å•ä½ã€‚ç”± ID, URI, predicates, filters ç»„æˆã€‚ Predicate: JDK8 predicate. ç”¨äºåŒ¹é… HTTP è¯·æ±‚ï¼Œå¦‚ headers æˆ–è€… parameters Filter: GatewayFilter,ç½‘å…³è¿‡æ»¤å™¨ã€‚ å·¥ä½œæµç¨‹ 6.2 å¿«é€Ÿå¼€å§‹é…ç½®predicates application.yml 12345678spring: cloud: gateway: routes: - id: after_route uri: https://example.org predicates: - After=2017-01-20T17:42:47.789-07:00[America/Denver] # æŒ‡å®šå…è®¸è®¿é—®çš„æ—¶é—´ï¼ŒåŒ…æ‹¬Beforeå’ŒAfterã€‚å¦‚12306 12345678spring: cloud: gateway: routes: - id: between_route uri: https://example.org predicates: - Between=2017-01-20T17:42:47.789-07:00[America/Denver], 2017-01-21T17:42:47.789-07:00[America/Denver] 12345678spring: cloud: gateway: routes: - id: after_route uri: https://example.org predicates: - Cookie=mycookie,mycookievalue 12345678spring: cloud: gateway: routes: - id: path_route uri: https://example.org predicates: - Path=/red/{segment},/blue/{segment} # åŒ¹é…è·¯å¾„ 12345678spring: cloud: gateway: routes: - id: query_route uri: https://example.org predicates: - Query=green # åŒ¹é…è¯·æ±‚å‚æ•° 12345678spring: cloud: gateway: routes: - id: remoteaddr_route uri: https://example.org predicates: - RemoteAddr=192.168.1.1/24 # åŒ¹é…å…è®¸è¯·æ±‚ä¸»æœºçš„ ip åœ°å€ filters è‹¥éœ€è¦è‡ªå®šä¹‰ filtersï¼Œå‚è€ƒæºç å³å¯ã€‚ 12345678spring: cloud: gateway: routes: - id: add_request_header_route uri: https://example.org filters: - AddRequestHeader=X-Request-red, blue # è¯·æ±‚å¤´è¿‡æ»¤å™¨ 12345678910spring: cloud: gateway: routes: - id: add_request_parameter_route uri: https://example.org predicates: - Host: {segment}.myhost.org filters: - AddRequestParameter=foo, bar-{segment} # è¯·æ±‚å‚æ•°è¿‡æ»¤å™¨ 12345678spring: cloud: gateway: routes: - id: add_response_header_route uri: https://example.org filters: - AddResponseHeader=X-Response-Red, Blue 12345678spring: cloud: gateway: routes: - id: prefixpath_route uri: https://example.org filters: - PrefixPath=/mypath # So a request to `/hello` would be sent to `/mypath/hello`. å…¨å±€è¿‡æ»¤å™¨å®ç° GlobalFilterï¼ŒOrderæ¥å£ï¼š 123456789101112131415161718@Beanpublic GlobalFilter customFilter() { return new CustomGlobalFilter();}public class CustomGlobalFilter implements GlobalFilter, Ordered { @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) { log.info(&quot;custom global filter&quot;); return chain.filter(exchange); } @Override public int getOrder() { return -1; }} CORS é…ç½®123456789spring: cloud: gateway: globalcors: cors-configurations: '[/**]': allowedOrigins: &quot;https://docs.spring.io&quot; allowedMethods: - GET å®ç°è´Ÿè½½å‡è¡¡åœ¨æœåŠ¡ Application ä¸ŠåŠ ä¸Š@RibbonClientæ³¨è§£å³å¯ï¼Œspring cloud gateway é»˜è®¤å¼€å¯ LBï¼š é…ç½®æ ¼å¼å¯å‚ç…§å¦‚ä¸‹ï¼š 12345678910111213141516spring: application: name: gateway cloud: nacos: server-addr: localhost:8848 gateway: discovery: locator: enabled: true # è·å–æœåŠ¡ä¸­å¿ƒçš„å…¶å®ƒæœåŠ¡ï¼Œæ”¹æˆfalseä¹Ÿä¸ä¼šå½±å“ä¸‹é¢çš„ routes é…ç½®^ ^ routes: - id: useless uri: lb://service-provider predicates : - Path=/echo/{segment} # è®¿é—® path ä¼šè‡ªåŠ¨åœ¨å‰é¢æ‹¼ä¸Š {serviceName} è¿™æ˜¯å¦ä¸€ç§ä¸å®ç”¨çš„ Ribbon å®˜æ–¹ demoï¼š 1234service-provider: ribbon: listOfServers: localhost:8070, localhost:8071 NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule ç½‘å…³é™æµä»£ç å®ç°å‚ç…§ï¼šå®˜ç½‘æˆ–http://www.imooc.com/article/290828 è¿™é‡Œè¯´æ˜ä¸€ä¸‹é™æµç®—æ³•ï¼š æ¼æ¡¶ç®—æ³•ï¼š æƒ³è±¡æœ‰ä¸€ä¸ªæ°´æ¡¶ï¼Œæ°´æ¡¶ä»¥ä¸€å®šçš„é€Ÿåº¦å‡ºæ°´ï¼ˆä»¥ä¸€å®šé€Ÿç‡æ¶ˆè´¹è¯·æ±‚ï¼‰ï¼Œå½“æ°´æµé€Ÿåº¦è¿‡å¤§æ°´ä¼šæº¢å‡ºï¼ˆè®¿é—®é€Ÿç‡è¶…è¿‡å“åº”é€Ÿç‡ï¼Œå°±ç›´æ¥æ‹’ç»ï¼‰ã€‚ æ¼æ¡¶ç®—æ³•çš„ä¸¤ä¸ªå˜é‡ï¼š æ°´æ¡¶æ¼æ´çš„å¤§å°ï¼šrateæœ€å¤šå¯ä»¥å­˜å¤šå°‘çš„æ°´ï¼šburstä»¤ç‰Œæ¡¶ç®—æ³•ï¼š ç³»ç»ŸæŒ‰ç…§æ’å®šé—´éš”å‘æ°´æ¡¶é‡ŒåŠ å…¥ä»¤ç‰Œï¼ˆTokenï¼‰ï¼Œå¦‚æœæ¡¶æ»¡äº†çš„è¯ï¼Œå°±ä¸åŠ äº†ã€‚æ¯ä¸ªè¯·æ±‚æ¥çš„æ—¶å€™ï¼Œä¼šæ‹¿èµ°1ä¸ªä»¤ç‰Œï¼Œå¦‚æœæ²¡æœ‰ä»¤ç‰Œå¯æ‹¿ï¼Œé‚£ä¹ˆå°±æ‹’ç»æœåŠ¡ã€‚ demo12345678910spring: application: name: gateway cloud: nacos: server-addr: localhost:8848 gateway: discovery: locator: enabled: true # è·å–æœåŠ¡ä¸­å¿ƒçš„å…¶å®ƒæœåŠ¡ï¼Œå³å¯é€šè¿‡æœåŠ¡åç§°ç›´æ¥è°ƒç”¨ API 7 å¾®æœåŠ¡çš„è®¤è¯å’Œæˆæƒ7.1 è®¤è¯å‡ ç§å¸¸ç”¨æ–¹æ¡ˆ å¤§è‡´åˆ†ä¸ºä¸¤ç±»ï¼šæœ‰çŠ¶æ€ï¼ˆå°† session ç»´æŠ¤åœ¨æœåŠ¡ç«¯ï¼‰ã€æ— çŠ¶æ€ï¼ˆæœåŠ¡ç«¯ä¸ä¿å­˜ session ç­‰ä¿¡æ¯ï¼Œä»…å¯¹ jwt åšæ ¡éªŒè€Œå·²ï¼‰ æœ‰çŠ¶æ€çš„ç¼ºç‚¹ï¼šéœ€è¦å•ä¸ª redis æœåŠ¡ï¼Œå’Œå¾®æœåŠ¡ç†å¿µè¿èƒŒï¼Œå½“ redis æŒ‚äº†åï¼Œæ‰€æœ‰æœåŠ¡çš„ session å°†å…¨éƒ¨å¤±æ•ˆã€‚ æˆ‘ä»¬ç°åœ¨çš„ç³»ç»Ÿï¼š 7.2 æˆæƒè®¿é—®æ§åˆ¶æ¨¡å‹ JWT é¡¹ç›®åœ°å€ï¼šhttps://github.com/auth0/java-jwt Quick start 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748/** * ç”Ÿæˆå’Œæ ¡éªŒ JWT çš„å·¥å…·ç±» * * @author Jacky * Date: 2019/9/26 17:26 */@Slf4j@Componentpublic class JWTHelper { // åº”ä½¿ç”¨é…ç½®ç»´æŠ¤ private String SECRET = &quot;love&quot;; private final Algorithm algorithm = Algorithm.HMAC256(SECRET); // @Value ä¸‹çš„å˜é‡ä¸èƒ½ç”¨ static ä¿®é¥°ç¬¦ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚å¹¶ä¸”æ‰€åœ¨ç±»éœ€è¦è¢«springå®¹å™¨åŠ è½½ï¼Œå³éœ€è¦@Componentæ³¨è§£ @Value(&quot;${jwt.expireTime:60}&quot;) public Long expireTime; public String generateJWT(Map&lt;String, String&gt; claims) { JWTCreator.Builder builder = JWT.create(); claims.forEach(builder::withClaim); return builder .withExpiresAt(new Date(System.currentTimeMillis() + expireTime * 1000)) .sign(algorithm); } /** * éœ€è¦å¤„ç†å¼‚å¸¸æƒ…å†µ+åˆ¤æ–­æ˜¯å¦è¿‡æœŸ */ public Map&lt;String, String&gt; verifyToken(String jwt) { DecodedJWT decodedJWT = JWT.require(algorithm).build().verify(jwt); log.info(&quot;decodedJWT is : {}&quot;, decodedJWT); Map&lt;String, Claim&gt; claims = decodedJWT.getClaims(); Map&lt;String, String&gt; res = new HashMap&lt;&gt;(); claims.forEach((k, v) -&gt; res.put(k, v.asString())); return res; } public void main(String[] args) { Map&lt;String, String&gt; claims = new HashMap&lt;&gt;(); claims.put(&quot;name&quot;, &quot;jacky&quot;); String jwt = generateJWT(claims); log.info(jwt); verifyToken(jwt).forEach((k, v) -&gt; System.out.println(&quot;key: &quot; + k + &quot; value: &quot; + v)); }} 7.3 è®¤è¯ä»£ç å®ç° ä¸»è¦æœ‰ 3 ç§å®ç° Servlet è¿‡æ»¤å™¨ æ‹¦æˆªå™¨ï¼ˆç»§æ‰¿ HandlerInterceptorAdapterï¼‰ Spring AOPï¼ˆæ¯ä¸ªæ¥å£éƒ½éœ€è¦åŠ ä¸Šè‡ªå®šä¹‰æ³¨è§£ï¼‰ è¿‡æ»¤å™¨æ‹¦æˆªå™¨123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * å¯¹æœªç™»å½•çš„ç”¨æˆ·è¿›è¡Œæ‹¦æˆª * * @author Jacky * Date: 2019/9/26 18:33 */@Slf4jpublic class AuthInterceptor extends HandlerInterceptorAdapter { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { if (!(handler instanceof HandlerMethod)) { // å¦‚æœä¸æ˜¯æ˜ å°„åˆ°æ–¹æ³•åˆ™ç›´æ¥é€šè¿‡ return true; } HandlerMethod handlerMethod = (HandlerMethod) handler; String jwt = request.getHeader(&quot;Authorization&quot;); if (StringUtils.isEmpty(jwt)) { throw new Exception(&quot;jwtä¸ºç©ºï¼&quot;); } else { Map&lt;String, String&gt; res = JWTHelper.verifyToken(jwt); String username = res.get(&quot;username&quot;); if (StringUtils.isEmpty(username)) { throw new Exception(&quot;jwtä¸æ­£ç¡®ï¼&quot;); } // å‡è£…éªŒè¯é€šè¿‡ User user = new User(); user.setUsername(username); UserContext.setUser(user); response.setHeader(&quot;Authorization&quot;, jwt); return true; } } @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception { } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { String jwt = request.getHeader(&quot;Authorization&quot;); response.setHeader(&quot;Authorization&quot;, jwt); UserContext.remove(); }} AOPæ¦‚è¿° æ‰§è¡Œé¡ºåº around &gt; before &gt; around &gt; after &gt; afterReturning ä»£ç ç¤ºä¾‹ éœ€å¼•å…¥ spring-boot-starter-aop ä¾èµ– ä¾‹ä¸€ï¼š 123456789101112@Aspect@Componentpublic class AOPProcess { // @checkLogin åªèƒ½ä½œç”¨å†æ–¹æ³•(aop)ä¸Šã€‚ @Around(&quot;@annotation(CheckLogin)&quot;) public Object around(ProceedingJoinPoint joinPoint) throws Throwable { System.out.println(&quot;ccccheck loginï¼&quot;); return joinPoint.proceed(); }} ä¾‹äºŒï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566@Aspect@Component@RequiredArgsConstructor(onConstructor = @__(@Autowired))public class AuthAspect { private final JwtOperator jwtOperator; @Around(&quot;@annotation(com.itmuch.usercenter.auth.CheckLogin)&quot;) public Object checkLogin(ProceedingJoinPoint point) throws Throwable { checkToken(); return point.proceed(); } private void checkToken() { try { // 1. ä»headeré‡Œé¢è·å–token HttpServletRequest request = getHttpServletRequest(); String token = request.getHeader(&quot;X-Token&quot;); // 2. æ ¡éªŒtokenæ˜¯å¦åˆæ³•&amp;æ˜¯å¦è¿‡æœŸï¼›å¦‚æœä¸åˆæ³•æˆ–å·²è¿‡æœŸç›´æ¥æŠ›å¼‚å¸¸ï¼›å¦‚æœåˆæ³•æ”¾è¡Œ Boolean isValid = jwtOperator.validateToken(token); if (!isValid) { throw new SecurityException(&quot;Tokenä¸åˆæ³•ï¼&quot;); } // 3. å¦‚æœæ ¡éªŒæˆåŠŸï¼Œé‚£ä¹ˆå°±å°†ç”¨æˆ·çš„ä¿¡æ¯è®¾ç½®åˆ°requestçš„attributeé‡Œé¢ Claims claims = jwtOperator.getClaimsFromToken(token); request.setAttribute(&quot;id&quot;, claims.get(&quot;id&quot;)); request.setAttribute(&quot;wxNickname&quot;, claims.get(&quot;wxNickname&quot;)); request.setAttribute(&quot;role&quot;, claims.get(&quot;role&quot;)); } catch (Throwable throwable) { throw new SecurityException(&quot;Tokenä¸åˆæ³•&quot;); } } private HttpServletRequest getHttpServletRequest() { RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes(); ServletRequestAttributes attributes = (ServletRequestAttributes) requestAttributes; return attributes.getRequest(); } @Around(&quot;@annotation(com.itmuch.usercenter.auth.CheckAuthorization)&quot;) public Object checkAuthorization(ProceedingJoinPoint point) throws Throwable { try { // 1. éªŒè¯tokenæ˜¯å¦åˆæ³•ï¼› this.checkToken(); // 2. éªŒè¯ç”¨æˆ·è§’è‰²æ˜¯å¦åŒ¹é… HttpServletRequest request = getHttpServletRequest(); String role = (String) request.getAttribute(&quot;role&quot;); MethodSignature signature = (MethodSignature) point.getSignature(); Method method = signature.getMethod(); CheckAuthorization annotation = method.getAnnotation(CheckAuthorization.class); String value = annotation.value(); if (!Objects.equals(role, value)) { throw new SecurityException(&quot;ç”¨æˆ·æ— æƒè®¿é—®ï¼&quot;); } } catch (Throwable throwable) { throw new SecurityException(&quot;ç”¨æˆ·æ— æƒè®¿é—®ï¼&quot;, throwable); } return point.proceed(); }} 7.4 å…¶å®ƒè¦ç‚¹Feign å®ç° token ä¼ é€’ ä½¿ç”¨@RequestHeaderæ³¨è§£ï¼Œæ¥æ”¶tokenå‚æ•°ã€‚ ä½¿ç”¨Feignçš„æ‹¦æˆªå™¨ RequestInterceptor(å¸¸ç”¨) å¯¹äºç¬¬ 2 ç§æ–¹æ³•çš„å®ç°ï¼Œé‡ç‚¹æ˜¯èƒ½å¤Ÿè·å– request ä¸­çš„headerï¼ˆåœ¨Spring HandlerInterceptorä¸­ï¼Œå°±å·²ç»æä¾›äº†è¯¥requestå‚æ•°ï¼‰ï¼Œå³ RequestContextHolderã€‚ 1234567891011121314151617181920212223242526272829@FeignClient(name = &quot;service-provider&quot;,configuration = DiscoveryFeign.FeignInterceptor.class)public interface DiscoveryFeign { @GetMapping(&quot;/echo/{string}&quot;) String echo(@PathVariable(&quot;string&quot;) String string); /** * ä¹Ÿå¯æ”¹å†™æˆ: * @Bean * public xxxIntercetor xxx() { * return new xxxIntercetor(); * } */ class FeignInterceptor implements RequestInterceptor, HandlerInterceptor { @Override public void apply(RequestTemplate requestTemplate) { System.out.println(&quot;ç»è¿‡feignæ‹¦æˆªå™¨äº†&quot;); // 1. è·å– request (é€šè¿‡ RequestContextHolder) ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes(); HttpServletRequest request = attributes.getRequest(); // 2. (feign)ä¼ é€’ token requestTemplate.header(&quot;Authorization&quot;, request.getHeader(&quot;Authorization&quot;)); } }} åœ¨DiscoveryApplicationæ‰“å°tokenï¼š 123456789@Configurationpublic class WebConfig implements WebMvcConfigurer { @Override public void addInterceptors(InterceptorRegistry registry) { registry.addInterceptor(new WebInterceptor()).addPathPatterns(&quot;/**&quot;).excludePathPatterns(&quot;/&quot;); }} 12345678public class WebInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { String token = request.getHeader(&quot;Authorization&quot;); System.out.println(token); return true; }} 8 åˆ†å¸ƒå¼è·Ÿè¸ª Spring Cloud Sleuth provides Spring Boot auto-configuration for distributed tracing.å®˜æ–¹æ–‡æ¡£ï¼šhttps://spring.io/projects/spring-cloud-sleuthé¡¹ç›®åœ°å€ï¼šhttps://github.com/spring-cloud/spring-cloud-sleuth Zipkinæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿã€‚å®ƒæœ‰åŠ©äºæ”¶é›†è§£å†³æœåŠ¡ä½“ç³»ç»“æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜æ‰€éœ€çš„æ—¶åºæ•°æ®ã€‚åŠŸèƒ½åŒ…æ‹¬è¯¥æ•°æ®çš„æ”¶é›†å’ŒæŸ¥æ‰¾ã€‚å®˜ç½‘ï¼šhttps://zipkin.io/é¡¹ç›®åœ°å€ï¼šhttps://github.com/openzipkin/zipkin 8.1 ä»‹ç» 8.2 å¿«é€Ÿå¼€å§‹è¿è¡Œ ZipKin-server 1docker run -d -p 9411:9411 openzipkin/zipkin åœ¨é¡¹ç›®ä¸­æ·»åŠ ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;&lt;/dependency&gt; é…ç½® zipkin-server åœ°å€ 12345678910spring: application: name: monitor cloud: nacos: server-addr: localhost:8848 zipkin: # look at here base-url: http://localhost:9411 discovery-client-enabled: false 8.3 ZipKin æ•°æ®æŒä¹…åŒ–å»ºè®®ä½¿ç”¨ ES + spark jobã€‚å‚è€ƒï¼šhttps://github.com/openzipkin/zipkin-dependencies zipkinæ”¯æŒä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼ˆhttps://github.com/openzipkin/zipkin/tree/master/zipkin-serverï¼‰ï¼š æ•…åœ¨å¯åŠ¨æ—¶å¢åŠ esçš„ç¯å¢ƒå˜é‡å³å¯ï¼š 1docker run -e &quot;STORAGE_TYPE=elasticsearch&quot; -e &quot;ES_HOSTS=172.17.0.1:9200&quot; -d -p 9411:9411 openzipkin/zipkin æ³¨æ„ï¼š ES_HOSTS å‚æ•°ä¸èƒ½ç›´æ¥ä½¿ç”¨ localhost ä¸å…¶ä»–å®¹å™¨é€šä¿¡ï¼Œè¦ä½¿ç”¨ docker ç½‘ç»œé€šä¿¡ï¼Œåœ¨å®¹å™¨å¯åŠ¨æ—¶æŒ‡å®š--netï¼Œä¹Ÿå¯ä»¥ç”¨--link [å®¹å™¨åç§°]ï¼š 12docker network create somenetworkdocker run -d --name kibana --net somenetwork -p 5601:5601 kibana:tag OR use the java command: 1STORAGE_TYPE=elasticsearch ES_HOSTS=localhost:9200 java -jar zipkin.jar spark job ä¸º zipkin-denpendencies å­é¡¹ç›®ï¼Œä½¿ç”¨æ–¹æ³•åŒä¸Šã€‚ 8.4 zipkin-dependenciesdocker åœ°å€ï¼šhttps://hub.docker.com/r/openzipkin/zipkin-dependencies 9 ä»£ç è´¨é‡9.1 å·¥å…· æœ¬ç« èŠ‚ä»…æ¼”ç¤ºsonarQubeçš„ç”¨æ³•ã€‚å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.sonarqube.org/latest/setup/install-server/ SonarQube å¿«é€Ÿå¼€å§‹https://hub.docker.com/_/sonarqube å®‰è£…æŒ‡å—https://docs.sonarqube.org/latest/setup/install-server/ æµ‹è¯•ç”¨ 1docker run -d --name sonarqube -p 9000:9000 sonarqube:community å¦å¤–éœ€æ³¨æ„ï¼ŒsonarQube ä¸æ”¯æŒ mysql åˆ†æä»£ç  12345mvn sonar:sonar \\ -Dsonar.projectKey=SC-alibaba \\ -Dsonar.host.url=http://localhost:9000 \\ -Dsonar.login=42c0f2e5fb71cac3ce38392935f47955c8851e75 \\ -Dsonar.java.binaries=target/sonar ç»“åˆ Jenkinshttps://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/ 10 ç›‘æ§å·¥å…·10.1 SBA å¿«é€Ÿå¼€å§‹ åŒ…æ‹¬ç›‘æ§ JVM ç­‰æŒ‡æ ‡ã€‚ å‚ç…§ï¼šhttps://codecentric.github.io/spring-boot-admin/2.2.3/#getting-started 10.2 JVM ç›‘æ§ é™¤äº† Jvisualvm å¤–ï¼Œä¹Ÿå¯ä»¥ç”¨ SBA GCæ—¥å¿—/çº¿ç¨‹Dumpæ—¥å¿—/å †Dumpå¯è§†åŒ–åˆ†æå¢åŠ å¯åŠ¨å‚æ•° VM options: -XX:+PrintGCDetails -Xloggc:gc.log GCEasy(ç›´æ¥ä¸Šä¼ GCæ—¥å¿—å³å¯)ã€GCPlot FastThread HeapHero 10.3 æ—¥å¿—ç›‘æ§ ELK 11. Seata Attention:192.168.1.1æ˜¯å†…ç½‘åœ°å€ï¼Œæ˜¯ç½‘å¡çš„å®é™…åœ°å€ï¼›å¯ä»¥æ˜¯æœ¬æœºä¹Ÿå¯ä»¥æ˜¯å…¶ä»–æœºå™¨127.0.0.1æ˜¯loopbackåœ°å€ï¼Œæ˜¯ä¸“é—¨ç”¨äºæœ¬æœºç½‘ç»œåº”ç”¨çš„å®ç°ï¼Œä¸ä¾èµ–äºå®é™…çš„ç½‘å¡(å®¹å™¨ä¸èƒ½ä½¿ç”¨)ã€‚ 11.1 æ¦‚è¿° Pre description:åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ï¼šåé¢å‡ºç°å¼‚å¸¸ï¼Œå‰é¢æˆåŠŸçš„è¿œç¨‹æœåŠ¡ï¼ˆfeignï¼ŒRestTemplateï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼‰æ— æ³•å›æ»šã€‚å› ä¸ºå®ƒä»¬çš„æœ¬åœ°äº‹åŠ¡å·²ç»ç»“æŸäº†ã€‚ ä¸¤é˜¶æ®µæäº¤åè®®ã€‚æœ¬åœ°äº‹åŠ¡æäº¤çš„ç»“æœä¸ŠæŠ¥ç»™ TCã€‚TCCæ¨¡å¼ï¼Œ TCC æ¨¡å¼è¦æ±‚çš„ä¸‰ä¸ªæ¥å£ï¼Ÿ Seata ç”± 3 éƒ¨åˆ†ç»„æˆï¼š TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚ TM (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚ RM (Resource Manager) - èµ„æºç®¡ç†å™¨ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚ å¿«é€Ÿå¼€å§‹éƒ¨ç½² seata-server 1docker run --name seata-server -p 8091:8091 seataio/seata-server:latest æˆ–è€…ç”¨ docker-compose è‡ªå®šä¹‰é…ç½®å¯åŠ¨ 12345678910version: &quot;3&quot;services: seata-server: image: seataio/seata-server hostname: seata-server ports: - &quot;8091:8091&quot; environment: - SEATA_PORT=8091 - STORE_MODE=file å¼•å…¥ä¾èµ– 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;&lt;/dependency&gt; æ³¨æ„ï¼šå¦‚æœä¸æ˜¯ springcloudï¼Œåˆ™éœ€è¦æ‰‹åŠ¨å®ç° xidï¼ˆç±»ä¼¼ä¸€ä¸²åˆ†å¸ƒå¼äº‹åŠ¡çš„tokenï¼‰ è·¨æœåŠ¡ä¼ é€’ã€‚ YML é…ç½® 1234567891011121314spring.cloud.alibaba.seata.tx-service-group=business-service # äº‹åŠ¡ç»„(å¿…é¡»)seata.service.vgroup-mapping.business-service=default # äº‹åŠ¡ç»„æ‰€åœ¨çš„ TC é›†ç¾¤åç§°(å¿…é¡»)seata.service.grouplist.default=127.0.0.1:8091 # ä»…æ³¨å†Œä¸­å¿ƒä¸º file æ—¶ä½¿ç”¨ (seata.registry.type = file)seata.service.disable-global-transaction=false # é»˜è®¤å°±æ˜¯ false## if use registry center#seata.registry.type=nacos#seata.registry.nacos.cluster=default#seata.registry.nacos.server-addr=localhost### if use config center#seata.config.type=apollo#seata.config.apollo.apollo-meta=http://192.168.1.204:8801#seata.config.apollo.app-id=seata-server åˆ›å»º undo_log è¡¨ æ˜¯æ‰€æœ‰æ•°æ®åº“éƒ½è¦åˆ›å»ºå—ï¼Ÿ@EnableDiscoveryClient(autoRegister = false)ï¼Ÿ 1234567891011121314-- æ³¨æ„æ­¤å¤„0.3.0+ å¢åŠ å”¯ä¸€ç´¢å¼• ux_undo_logCREATE TABLE `undo_log` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `branch_id` bigint(20) NOT NULL, `xid` varchar(100) NOT NULL, `context` varchar(128) NOT NULL, `rollback_info` longblob NOT NULL, `log_status` int(11) NOT NULL, `log_created` datetime NOT NULL, `log_modified` datetime NOT NULL, `ext` varchar(100) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8; åˆ°æ­¤å®Œæˆï¼Œä½¿ç”¨@GlobalTransactional(timeoutMills = 300000, name = &quot;spring-cloud-demo-tx&quot;)å³å¯å¼€å¯åˆ†å¸ƒå¼äº‹åŠ¡ã€‚ é…ç½®è¯´æ˜ 11.2 é«˜å¯ç”¨éƒ¨ç½² Seata çš„é«˜å¯ç”¨ä¾èµ–äºæ³¨å†Œä¸­å¿ƒã€é…ç½®ä¸­å¿ƒå’Œæ•°æ®åº“æ¥å®ç° store.mode ä¸ä½¿ç”¨é»˜è®¤çš„ fileã€‚å»ºè®®ä½¿ç”¨é«˜å¯ç”¨HA db/redis å­˜æ”¾äº‹åŠ¡æ•°æ®ã€‚ Description: fileæ¨¡å¼ä¸ºå•æœºæ¨¡å¼ï¼Œå…¨å±€äº‹åŠ¡ä¼šè¯ä¿¡æ¯å†…å­˜ä¸­è¯»å†™å¹¶æŒä¹…åŒ–æœ¬åœ°æ–‡ä»¶root.dataï¼Œæ€§èƒ½è¾ƒé«˜; è‹¥ä½¿ç”¨dbï¼Œåˆ™éœ€è¦å»º3å¼ è¡¨ã€‚å…¨å±€äº‹åŠ¡ä¼šè¯ä¿¡æ¯ç”±3å—å†…å®¹æ„æˆï¼Œå…¨å±€äº‹åŠ¡â€“&gt;åˆ†æ”¯äº‹åŠ¡â€“&gt;å…¨å±€é”ï¼Œå¯¹åº”è¡¨global_tableã€branch_tableã€lock_table ï¼Œå¯¹åº”è„šæœ¬ https://github.com/seata/seata/tree/develop/script/server/db å¿«é€Ÿå¼€å§‹ ä½¿ç”¨æ³¨å†Œä¸­å¿ƒ + db/redis a. ä¿®æ”¹registry.confçš„æ³¨å†Œä¸­å¿ƒé…ç½® 123456789101112131415161718192021222324registry { type = &quot;nacos&quot; nacos { application = &quot;seata-server&quot; serverAddr = &quot;192.168.199.2&quot; # å®¹å™¨å†…ç”¨hostnameæˆ–è€…xxxï¼ˆåº”è¯¥ä¸èƒ½ç”¨localhostï¼‰ï¼Œåœ¨nacoså¯åŠ¨æ—¥å¿—çœ‹ipã€‚ namespace = &quot;&quot; cluster = &quot;default&quot; username = &quot;nacos&quot; password = &quot;nacos&quot; }}config { type = &quot;nacos&quot; nacos { serverAddr = &quot;192.168.199.2&quot; namespace = &quot;&quot; group = &quot;SEATA_GROUP&quot; username = &quot;&quot; password = &quot;&quot; }} Locationï¼š b. éœ€è¦ä¿®æ”¹é…ç½®ä¸­å¿ƒçš„ä»¥ä¸‹å‡ ä¸ªé…ç½®(å«dbä¸redis,äºŒè€…é€‰å…¶ä¸€ æ³¨:rediséœ€seata-server 1.3ç‰ˆæœ¬åŠä»¥ä¸Š) 1234567891011121314151617service.vgroupMapping.my_test_tx_group=defaultstore.mode=db|redis-----db-----store.db.datasource=druidstore.db.dbType=mysqlstore.db.driverClassName=com.mysql.jdbc.Driverstore.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=truestore.db.user=rootstore.db.password=123456----redis----store.redis.host=127.0.0.1store.redis.port=6379store.redis.maxConn=10store.redis.minConn=1store.redis.database=0store.redis.password=nullstore.redis.queryLimit=100 c. docker å¯åŠ¨ 12345docker run --name seata-server \\ -p 8091:8091 \\ -e SEATA_CONFIG_NAME=file:/root/seata-config/registry \\ -v /User/seata/config:/root/seata-config \\ seataio/seata-server 11.3 é›†æˆ nacosseata-server æœåŠ¡ç«¯é…ç½® è·å–é…ç½®æ–‡ä»¶å’Œ nacos-config.sh åˆå§‹åŒ–è„šæœ¬æ–‡ä»¶ï¼šhttps://github.com/seata/seata/tree/develop/script/config-center ä¿®æ”¹ conf/registry.conf é…ç½® æ³¨æ„ï¼šnacosçš„serverAddrä¸èƒ½æœ‰ http:// å‰ç¼€** 1234567891011121314151617181920registry { # file ã€nacos ã€eurekaã€redisã€zkã€consulã€etcd3ã€sofa type = &quot;nacos&quot; nacos { serverAddr = &quot;192.168.21.89&quot; namespace = &quot;&quot; cluster = &quot;default&quot; }}config { # fileã€nacos ã€apolloã€zkã€consulã€etcd3 type = &quot;nacos&quot; nacos { serverAddr = &quot;192.168.21.89&quot; namespace = &quot;&quot; cluster = &quot;default&quot; }} ä¿®æ”¹conf/nacos-config.txt é…ç½® å¢åŠ service.vgroup_mapping.${your-service-gruop}=default(æœ¬è´¨ä¸Šè¿˜æ˜¯åº”ç”¨application.ymlå¤„è¯»å–)ï¼Œå…¶ä¸­${..}ä¸ºæœåŠ¡ç»„åç§°ã€‚ä¾‹å¦‚ï¼Œdemoä¸­æœ‰ä¸¤ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«æ˜¯storage-serviceå’Œorder-serviceï¼Œæ‰€ä»¥é…ç½®å¦‚ä¸‹ï¼š 1å¢åŠ `service.vgroup_mapping.${your-service-gruop}=default`ï¼Œå…¶ä¸­${..}ä¸ºæœåŠ¡ç»„åç§°ã€‚ä¾‹å¦‚ï¼Œdemoä¸­æœ‰ä¸¤ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«æ˜¯storage-serviceå’Œorder-serviceï¼Œæ‰€ä»¥é…ç½®å¦‚ä¸‹ åˆå§‹åŒ–seataçš„nacosé…ç½® 1sh ${SEATAPATH}/script/config-center/nacos/nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 5a3c7d6c-f497-4d68-a71a-2e5e3340b3ca -u username -w password æœ€åï¼Œå¯åŠ¨seata-server 1docker run --name seata-server-complex -p 8091:8091 -e SEATA_CONFIG_NAME=file:/root/seata-config/registry -v C:\\Users\\Administrator\\Desktop\\seata-config\\config:/root/seata-config seataio/seata-server 1234567891011121314Parameter Description:-h: host, the default value is localhost.-p: port, the default value is 8848.-g: Configure grouping, the default value is 'SEATA_GROUP'.-t: Tenant information, corresponding to the namespace ID field of Nacos, the default value is ''.-u: username, nacos 1.2.0+ on permission control, the default value is ''.-w: password, nacos 1.2.0+ on permission control, the default value is ''. å®¢æˆ·ç«¯æœåŠ¡é…ç½®åˆå§‹åŒ–undo_logè¡¨ï¼› æ¯ä¸ªåº”ç”¨çš„resourceé‡Œéœ€è¦é…ç½®ä¸€ä¸ªregistry.conf ï¼Œdemoä¸­ä¸seata-serveré‡Œçš„é…ç½®ç›¸åŒ(ä¹Ÿå¯ä»¥åœ¨application.ymlé…ç½®) application.yml çš„å„ä¸ªé…ç½®é¡¹ï¼Œæ³¨æ„spring.cloud.alibaba.seata.tx-service-group æ˜¯æœåŠ¡ç»„åç§°ï¼Œä¸nacos-config.txt é…ç½®çš„service.vgroup_mapping.${your-service-gruop}å…·æœ‰å¯¹åº”å…³ç³» Other (for Tests):import static org.assertj.core.api.Assertions.assertThat;","link":"/2021/03/07/spring-cloud-alibaba/"},{"title":"åˆ†å¸ƒå¼äº‹åŠ¡ç†è®º","text":"â€¦ åˆ†å¸ƒå¼äº‹åŠ¡ç†è®º Seataã€ShardingSphere çš„åˆ†å¸ƒå¼äº‹åŠ¡éƒ½æ˜¯åŸºäº XAã€Base ã€‚ä¸¤/ä¸‰é˜¶æ®µ XA å°±ä¸æäº†ï¼Œåªé€‚ç”¨äºçŸ­äº‹åŠ¡ &amp; ä½å¹¶å‘çš„åœºæ™¯ã€‚ShardingSphereå’ŒSeataä¼šå¯¹SQLè¿›è¡Œé‡å¤è§£æã€‚ èƒŒæ™¯æ•°æ®åº“äº‹åŠ¡éœ€è¦æ»¡è¶³ACIDï¼ˆåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼‰å››ä¸ªç‰¹æ€§ã€‚ åŸå­æ€§ï¼ˆAtomicityï¼‰æŒ‡äº‹åŠ¡ä½œä¸ºæ•´ä½“æ¥æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰æŒ‡äº‹åŠ¡åº”ç¡®ä¿æ•°æ®ä»ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€è½¬å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚ éš”ç¦»æ€§ï¼ˆIsolationï¼‰æŒ‡å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”å½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œã€‚ æŒä¹…æ€§ï¼ˆDurabilityï¼‰æŒ‡å·²æäº¤çš„äº‹åŠ¡ä¿®æ”¹æ•°æ®ä¼šè¢«æŒä¹…ä¿å­˜ã€‚ åœ¨å•ä¸€æ•°æ®èŠ‚ç‚¹ä¸­ï¼Œäº‹åŠ¡ä»…é™äºå¯¹å•ä¸€æ•°æ®åº“èµ„æºçš„è®¿é—®æ§åˆ¶ï¼Œç§°ä¹‹ä¸ºæœ¬åœ°äº‹åŠ¡ã€‚å‡ ä¹æ‰€æœ‰çš„æˆç†Ÿçš„å…³ç³»å‹æ•°æ®åº“éƒ½æä¾›äº†å¯¹æœ¬åœ°äº‹åŠ¡çš„åŸç”Ÿæ”¯æŒã€‚ ä½†æ˜¯åœ¨åŸºäºå¾®æœåŠ¡çš„åˆ†å¸ƒå¼åº”ç”¨ç¯å¢ƒä¸‹ï¼Œè¶Šæ¥è¶Šå¤šçš„åº”ç”¨åœºæ™¯è¦æ±‚å¯¹å¤šä¸ªæœåŠ¡çš„è®¿é—®åŠå…¶ç›¸å¯¹åº”çš„å¤šä¸ªæ•°æ®åº“èµ„æºèƒ½çº³å…¥åˆ°åŒä¸€ä¸ªäº‹åŠ¡å½“ä¸­ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡åº”è¿è€Œç”Ÿã€‚ å…³ç³»å‹æ•°æ®åº“è™½ç„¶å¯¹æœ¬åœ°äº‹åŠ¡æä¾›äº†å®Œç¾çš„ACIDåŸç”Ÿæ”¯æŒã€‚ ä½†åœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ä¸‹ï¼Œå®ƒå´æˆä¸ºç³»ç»Ÿæ€§èƒ½çš„æ¡æ¢ã€‚å¦‚ä½•è®©æ•°æ®åº“åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹æ»¡è¶³ACIDçš„ç‰¹æ€§æˆ–æ‰¾å¯»ç›¸åº”çš„æ›¿ä»£æ–¹æ¡ˆï¼Œæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„é‡ç‚¹å·¥ä½œã€‚ æœ¬åœ°äº‹åŠ¡åœ¨ä¸å¼€å¯ä»»ä½•åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨çš„å‰æä¸‹ï¼Œè®©æ¯ä¸ªæ•°æ®èŠ‚ç‚¹å„è‡ªç®¡ç†è‡ªå·±çš„äº‹åŠ¡ã€‚ å®ƒä»¬ä¹‹é—´æ²¡æœ‰åè°ƒä»¥åŠé€šä¿¡çš„èƒ½åŠ›ï¼Œä¹Ÿå¹¶ä¸äº’ç›¸çŸ¥æ™“å…¶ä»–æ•°æ®èŠ‚ç‚¹äº‹åŠ¡çš„æˆåŠŸä¸å¦ã€‚ æœ¬åœ°äº‹åŠ¡åœ¨æ€§èƒ½æ–¹é¢æ— ä»»ä½•æŸè€—ï¼Œä½†åœ¨å¼ºä¸€è‡´æ€§ä»¥åŠæœ€ç»ˆä¸€è‡´æ€§æ–¹é¢åˆ™åŠ›ä¸ä»å¿ƒã€‚ ä¸¤é˜¶æ®µæäº¤XAåè®®æœ€æ—©çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹æ˜¯ç”±X/Openå›½é™…è”ç›Ÿæå‡ºçš„X/Open Distributed Transaction Processingï¼ˆDTPï¼‰æ¨¡å‹ï¼Œç®€ç§°XAåè®®ã€‚ åŸºäºXAåè®®å®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡å¯¹ä¸šåŠ¡ä¾µå…¥å¾ˆå°ã€‚ å®ƒæœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯å¯¹ä½¿ç”¨æ–¹é€æ˜ï¼Œç”¨æˆ·å¯ä»¥åƒä½¿ç”¨æœ¬åœ°äº‹åŠ¡ä¸€æ ·ä½¿ç”¨åŸºäºXAåè®®çš„åˆ†å¸ƒå¼äº‹åŠ¡ã€‚ XAåè®®èƒ½å¤Ÿä¸¥æ ¼ä¿éšœäº‹åŠ¡ACIDç‰¹æ€§ã€‚ ä¸¥æ ¼ä¿éšœäº‹åŠ¡ACIDç‰¹æ€§æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚ äº‹åŠ¡æ‰§è¡Œåœ¨è¿‡ç¨‹ä¸­éœ€è¦å°†æ‰€éœ€èµ„æºå…¨éƒ¨é”å®šï¼Œå®ƒæ›´åŠ é€‚ç”¨äºæ‰§è¡Œæ—¶é—´ç¡®å®šçš„çŸ­äº‹åŠ¡ã€‚ å¯¹äºé•¿äº‹åŠ¡æ¥è¯´ï¼Œæ•´ä¸ªäº‹åŠ¡è¿›è¡ŒæœŸé—´å¯¹æ•°æ®çš„ç‹¬å ï¼Œå°†å¯¼è‡´å¯¹çƒ­ç‚¹æ•°æ®ä¾èµ–çš„ä¸šåŠ¡ç³»ç»Ÿå¹¶å‘æ€§èƒ½è¡°é€€æ˜æ˜¾ã€‚ å› æ­¤ï¼Œåœ¨é«˜å¹¶å‘çš„æ€§èƒ½è‡³ä¸Šåœºæ™¯ä¸­ï¼ŒåŸºäºXAåè®®çš„åˆ†å¸ƒå¼äº‹åŠ¡å¹¶ä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚ æŸ”æ€§äº‹åŠ¡å¦‚æœå°†å®ç°äº†ACIDçš„äº‹åŠ¡è¦ç´ çš„äº‹åŠ¡ç§°ä¸ºåˆšæ€§äº‹åŠ¡çš„è¯ï¼Œé‚£ä¹ˆåŸºäºBASEäº‹åŠ¡è¦ç´ çš„äº‹åŠ¡åˆ™ç§°ä¸ºæŸ”æ€§äº‹åŠ¡ã€‚ BASEæ˜¯åŸºæœ¬å¯ç”¨ã€æŸ”æ€§çŠ¶æ€å’Œæœ€ç»ˆä¸€è‡´æ€§è¿™ä¸‰ä¸ªè¦ç´ çš„ç¼©å†™ã€‚ åŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡å‚ä¸æ–¹ä¸ä¸€å®šåŒæ—¶åœ¨çº¿ã€‚ æŸ”æ€§çŠ¶æ€ï¼ˆSoft stateï¼‰åˆ™å…è®¸ç³»ç»ŸçŠ¶æ€æ›´æ–°æœ‰ä¸€å®šçš„å»¶æ—¶ï¼Œè¿™ä¸ªå»¶æ—¶å¯¹å®¢æˆ·æ¥è¯´ä¸ä¸€å®šèƒ½å¤Ÿå¯Ÿè§‰ã€‚ è€Œæœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventually consistentï¼‰é€šå¸¸æ˜¯é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼ä¿è¯ç³»ç»Ÿçš„æœ€ç»ˆä¸€è‡´æ€§ã€‚ åœ¨ACIDäº‹åŠ¡ä¸­å¯¹éš”ç¦»æ€§çš„è¦æ±‚å¾ˆé«˜ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¿…é¡»å°†æ‰€æœ‰çš„èµ„æºé”å®šã€‚ æŸ”æ€§äº‹åŠ¡çš„ç†å¿µåˆ™æ˜¯é€šè¿‡ä¸šåŠ¡é€»è¾‘å°†äº’æ–¥é”æ“ä½œä»èµ„æºå±‚é¢ä¸Šç§»è‡³ä¸šåŠ¡å±‚é¢ã€‚é€šè¿‡æ”¾å®½å¯¹å¼ºä¸€è‡´æ€§è¦æ±‚ï¼Œæ¥æ¢å–ç³»ç»Ÿååé‡çš„æå‡ã€‚ åŸºäºACIDçš„å¼ºä¸€è‡´æ€§äº‹åŠ¡å’ŒåŸºäºBASEçš„æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡éƒ½ä¸æ˜¯é“¶å¼¹ï¼Œåªæœ‰åœ¨æœ€é€‚åˆçš„åœºæ™¯ä¸­æ‰èƒ½å‘æŒ¥å®ƒä»¬çš„æœ€å¤§é•¿å¤„ã€‚ å¯é€šè¿‡ä¸‹è¡¨è¯¦ç»†å¯¹æ¯”å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ï¼Œä»¥å¸®åŠ©å¼€å‘è€…è¿›è¡ŒæŠ€æœ¯é€‰å‹ã€‚ - æœ¬åœ°äº‹åŠ¡ ä¸¤ï¼ˆä¸‰ï¼‰é˜¶æ®µäº‹åŠ¡ æŸ”æ€§äº‹åŠ¡ ä¸šåŠ¡æ”¹é€  æ—  æ—  å®ç°ç›¸å…³æ¥å£ ä¸€è‡´æ€§ ä¸æ”¯æŒ æ”¯æŒ æœ€ç»ˆä¸€è‡´ éš”ç¦»æ€§ ä¸æ”¯æŒ æ”¯æŒ ä¸šåŠ¡æ–¹ä¿è¯ å¹¶å‘æ€§èƒ½ æ— å½±å“ ä¸¥é‡è¡°é€€ ç•¥å¾®è¡°é€€ é€‚åˆåœºæ™¯ ä¸šåŠ¡æ–¹å¤„ç†ä¸ä¸€è‡´ çŸ­äº‹åŠ¡ &amp; ä½å¹¶å‘ é•¿äº‹åŠ¡ &amp; é«˜å¹¶å‘ å…·ä½“å®ç° Sagaæ¨¡å¼ï¼šSagaæ¨¡å¼æ˜¯SEATAæä¾›çš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œåœ¨Sagaæ¨¡å¼ä¸­ï¼Œä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…éƒ½æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå½“å‡ºç°æŸä¸€ä¸ªå‚ä¸è€…å¤±è´¥åˆ™è¡¥å¿å‰é¢å·²ç»æˆåŠŸçš„å‚ä¸è€…ï¼Œä¸€é˜¶æ®µæ­£å‘æœåŠ¡å’ŒäºŒé˜¶æ®µè¡¥å¿æœåŠ¡éƒ½ç”±ä¸šåŠ¡å¼€å‘å®ç°ã€‚ æŒ‘æˆ˜ç”±äºåº”ç”¨çš„åœºæ™¯ä¸åŒï¼Œéœ€è¦å¼€å‘è€…èƒ½å¤Ÿåˆç†çš„åœ¨æ€§èƒ½ä¸åŠŸèƒ½ä¹‹é—´æƒè¡¡å„ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚ å¼ºä¸€è‡´çš„äº‹åŠ¡ä¸æŸ”æ€§äº‹åŠ¡çš„APIå’ŒåŠŸèƒ½å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œåœ¨å®ƒä»¬ä¹‹é—´å¹¶ä¸èƒ½åšåˆ°è‡ªç”±çš„é€æ˜åˆ‡æ¢ã€‚åœ¨å¼€å‘å†³ç­–é˜¶æ®µï¼Œå°±ä¸å¾—ä¸åœ¨å¼ºä¸€è‡´çš„äº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡ä¹‹é—´æŠ‰æ‹©ï¼Œä½¿å¾—è®¾è®¡å’Œå¼€å‘æˆæœ¬è¢«å¤§å¹…å¢åŠ ã€‚ åŸºäºXAçš„å¼ºä¸€è‡´äº‹åŠ¡ä½¿ç”¨ç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯æ— æ³•å¾ˆå¥½çš„åº”å¯¹äº’è”ç½‘çš„é«˜å¹¶å‘æˆ–å¤æ‚ç³»ç»Ÿçš„é•¿äº‹åŠ¡åœºæ™¯ï¼›æŸ”æ€§äº‹åŠ¡åˆ™éœ€è¦å¼€å‘è€…å¯¹åº”ç”¨è¿›è¡Œæ”¹é€ ï¼Œæ¥å…¥æˆæœ¬éå¸¸é«˜ï¼Œå¹¶ä¸”éœ€è¦å¼€å‘è€…è‡ªè¡Œå®ç°èµ„æºé”å®šå’Œåå‘è¡¥å¿ã€‚ ç›®æ ‡æ•´åˆç°æœ‰çš„æˆç†Ÿäº‹åŠ¡æ–¹æ¡ˆï¼Œä¸ºæœ¬åœ°äº‹åŠ¡ã€ä¸¤é˜¶æ®µäº‹åŠ¡å’ŒæŸ”æ€§äº‹åŠ¡æä¾›ç»Ÿä¸€çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¥å£ï¼Œå¹¶å¼¥è¡¥å½“å‰æ–¹æ¡ˆçš„ä¸è¶³ï¼Œæä¾›ä¸€ç«™å¼çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆæ˜¯ShardingSphereåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å—çš„ä¸»è¦è®¾è®¡ç›®æ ‡ã€‚","link":"/2021/03/24/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%90%86%E8%AE%BA/"},{"title":"","text":"ç¼ç¼è¡¥è¡¥ç»ˆäºå·®ä¸å¤šå†™å®Œä»£ç  å‡Œæ™¨4ç‚¹å¤šåˆç†¬å¤œå•¦ï¼ï¼ æ´—æ´—ç¡è§‰ æ˜å¤©æ€è€ƒäººç”ŸğŸ¤”","link":"/2021/02/25/%E5%8E%9F%E5%9C%B0%E7%9D%A1%E8%A7%89/"},{"title":"åœ¨m1-macå®‰è£…tensorflow","text":"â€¦ Installation Instructions éœ€è¦å…ˆå®‰è£…arm64çš„miniforgeæ›¿ä»£æš‚æœªå…¼å®¹çš„anaconda Step 1: Environment setupx86 : AMDCreate virtual environment (recommended): 123python3 -m venv ~/tensorflow-metalsource ~/tensorflow-metal/bin/activatepython -m pip install -U pip NOTE: python version 3.8 required arm64 : Apple SiliconDownload and install Conda env: 123chmod +x ~/Downloads/Miniforge3-MacOSX-arm64.shsh ~/Downloads/Miniforge3-MacOSX-arm64.shsource ~/miniforge3/bin/activate Install the Tensorflow dependencies: 1conda install -c apple tensorflow-deps NOTE: python versions 3.8 and 3.9 supported Step 2: Install base TensorFlow1python -m pip install tensorflow-macos Step 3: Install tensorflow-metal plugin1python -m pip install tensorflow-metal å®‰è£…å®Œæˆåï¼Œå³å¯åœ¨pythonå‘½ä»¤è¡Œä¸­å¯¼å…¥tensorflowæ¨¡å—ã€‚åœ¨PyCharmä¸­æ–°å»ºé¡¹ç›®å¦‚ä¸‹ï¼Œæ³¨æ„éœ€è¦ä½¿ç”¨miniforgeçš„pythonç¯å¢ƒã€‚ é€‚é…æŸ¥è¯¢https://isapplesiliconready.com/zh/app/TensorFlow https://doesitarm.com/ åœ¨M1ä¸Šå®‰è£…æ‰€æœ‰pythonçš„åº“1.ä¸‹è½½å®‰è£…miniforge3(arm64)https://github.com/conda-forge/miniforge/#download 2. æ›´æ”¹condaçš„mirroré•œåƒæºåœ¨terminalè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š 123456conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/ ä¿®æ”¹condarcæ–‡ä»¶ï¼š 1234channels: - https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/ - https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/ - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/ ä¹‹åä½ æƒ³è¦ä¸‹è½½æŸäº›åº“å°±ç›´æ¥æ‰“å¼€terminalconda install numpyconda install pandasconda install pysparkâ€¦..(é€Ÿåº¦æ¯”æŒ‚VPNå¿«å¤šäº†ï¼ å„ç§æ¨¡å—éƒ½å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°ï¼šhttps://anaconda.org/ 3. conda å¸¸ç”¨å‘½ä»¤conda [env] -hï¼šå¸®åŠ© conda env listï¼šåˆ—å‡ºæ‰€æœ‰condaç¯å¢ƒ conda remove â€“name your_env_name â€“allï¼šåˆ é™¤æŸä¸ªç¯å¢ƒ","link":"/2021/10/11/%E5%9C%A8m1-mac%E5%AE%89%E8%A3%85tensorflow/"},{"title":"å¿«é€Ÿéƒ¨ç½²","text":"â€¦ è¯¥æ–‡ç« ä»…æä¾›å¼€å‘ã€æµ‹è¯•ç¯å¢ƒçš„éƒ¨åˆ†éƒ¨ç½²æµç¨‹ã€‚å¦å¤–ï¼Œç”Ÿäº§ç¯å¢ƒè¯·å‚è€ƒå…¶å®ƒæ–‡ç« ã€‚ 1. Spring Cloud Alibaba1.1 Nacosä½¿ç”¨docker-compose -f xxx.yml upå‘½ä»¤ï¼Œä¸‹é¢ä¸ºç›¸å…³æ–‡ä»¶ï¼Œå¯æ ¹æ®è‡ªå·±çš„éœ€è¦ä¿®æ”¹é…ç½®ï¼Œå¦‚æŒ‡å®šmysqlã€æ—¥å¿—ç›®å½•ç­‰ã€‚ xxx.yml 12345678910111213141516171819202122232425version: &quot;2&quot;services: nacos: image: nacos/nacos-server:1.3.1 container_name: nacos-standalone-mysql env_file: - ../env/nacos-standlone-mysql.env volumes: - ./standalone-logs/:/home/nacos/logs - ./init.d/custom.properties:/home/nacos/init.d/custom.properties ports: - &quot;8848:8848&quot; - &quot;9555:9555&quot; depends_on: - mysql restart: always mysql: container_name: mysql image: nacos/nacos-mysql:8.0.16 env_file: - ../env/mysql.env volumes: - ./mysql:/var/lib/mysql ports: - &quot;3306:3306&quot; nacos-standlone-mysql.env 12345678PREFER_HOST_MODE=hostnameMODE=standaloneSPRING_DATASOURCE_PLATFORM=mysqlMYSQL_SERVICE_HOST=mysqlMYSQL_SERVICE_DB_NAME=nacos_devtestMYSQL_SERVICE_PORT=3306MYSQL_SERVICE_USER=nacosMYSQL_SERVICE_PASSWORD=nacos mysql.env 1234MYSQL_ROOT_PASSWORD=rootMYSQL_DATABASE=nacos_devtestMYSQL_USER=nacosMYSQL_PASSWORD=nacos 1.2 seata1.3 rocketmqDocker æ–¹å¼éƒ¨ç½² ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é›†ç¾¤éƒ¨ç½²ï¼šå¤šMasterå¤šSlave-åŒæ­¥åŒå†™æ¨¡å¼(docker-compose / Kubernetes)ã€‚åŒæ­¥åŒå†™ç±»ä¼¼äºMysql-Clusterï¼Œè€Œå¼‚æ­¥åŒå†™ç±»ä¼¼äºMysql-Replicationsã€‚ å…·ä½“å‚ç…§ï¼š https://github.com/apache/rocketmq-docker/blob/master/product/README.md https://github.com/apache/rocketmq-docker https://github.com/apache/rocketmq/blob/master/docs/cn/operation.md https://hub.docker.com/r/foxiswho/rocketmq 2. MySQL2.1 Cluster &amp; Replications åŒºåˆ«å…·ä½“å¯å‚è€ƒè¿™ 2 ç¯‡æ–‡ç« ï¼šhttps://stackoverflow.com/questions/5300490/mysql-cluster-ndb-vs-mysql-replication-innodb-for-rails-3-apps-pros-conshttp://www.mysqlab.net/knowledge/kb/detail/topic/cluster/id/5184 åŠŸèƒ½ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹åŒºåˆ«ï¼š Clust å®æ—¶åŒæ­¥ vs Repå¼‚æ­¥åŒæ­¥ã€‚binlog å¼‚æ­¥åŒæ­¥æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ã€‚ è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚MySQL Cluster è¿˜ä½¿ç”¨åŒæ­¥å¤åˆ¶ä»¥ä»ç³»ç»Ÿä¸­æ¶ˆé™¤ä»»ä½•å•ç‚¹æ•…éšœã€‚ ä½¿ç”¨æ–¹ä¾¿ã€‚åº”ç”¨ä¸éœ€è¦çŸ¥é“æ•°æ®åº“åœ¨å“ªé‡Œï¼ˆä¸ç”¨é…ç½®å’Œå¤„ç† master/slave ç­‰è§„åˆ™ï¼‰ã€‚ 2.2 é›†ç¾¤æ­å»ºDocker æ­å»º ä¸»è¦æµç¨‹ï¼šç®¡ç†èŠ‚ç‚¹â€“&gt;æ•°æ®èŠ‚ç‚¹ &amp; MySQLæœåŠ¡å™¨èŠ‚ç‚¹å…·ä½“å‚ç…§ï¼šhttps://hub.docker.com/r/mysql/mysql-clusteré¡¹ç›®åœ°å€ï¼šhttps://github.com/mysql/mysql-docker.git é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå†…éƒ¨Dockerç½‘ç»œï¼Œå®¹å™¨å°†ä½¿ç”¨è¯¥ç½‘ç»œè¿›è¡Œé€šä¿¡ 1docker network create cluster --subnet=192.168.0.0/16 ç„¶åæˆ‘ä»¬å¯åŠ¨ç®¡ç†èŠ‚ç‚¹ 1docker run -d --net=cluster --name=management1 --ip=192.168.0.2 mysql/mysql-cluster ndb_mgmd ä¸¤ä¸ªæ•°æ®èŠ‚ç‚¹ 12docker run -d --net=cluster --name=ndb1 --ip=192.168.0.3 mysql/mysql-cluster ndbddocker run -d --net=cluster --name=ndb2 --ip=192.168.0.4 mysql/mysql-cluster ndbd æœ€åæ˜¯ MySQL æœåŠ¡å™¨èŠ‚ç‚¹ã€‚å…¶ä¸­MYSQL_ROOT_HOSTæ˜¯å®¿ä¸»æœºçš„ localhostï¼Œä¸doceker inspect containerId çš„ gateway ip ä¸€è‡´ã€‚ 1docker run -d --net=cluster --name=mysql1 --ip=192.168.0.10 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_ROOT_HOST=192.168.0.1 mysql/mysql-cluster mysqld æ€»ç»“ æ·»åŠ èŠ‚ç‚¹ç­‰ç­‰mysql-cluster.conf 123456789101112131415161718192021222324[ndbd default]NoOfReplicas=2DataMemory=80MIndexMemory=18M[ndb_mgmd]NodeId=1hostname=192.168.0.2datadir=/var/lib/mysql[ndbd]NodeId=2hostname=192.168.0.3datadir=/var/lib/mysql[ndbd]NodeId=3hostname=192.168.0.4datadir=/var/lib/mysql[mysqld]NodeId=4hostname=192.168.0.10 my.conf 1234567[mysqld]ndbclusterndb-connectstring=192.168.0.2user=mysql[mysql_cluster]ndb-connectstring=192.168.0.2 bin æ–‡ä»¶æ­å»º å…·ä½“å‚ç…§ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-install-linux-binary.html","link":"/2021/03/25/%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2/"},{"title":"å¥½å›°å¥½å›°ï¼ï¼ï¼","text":"å‡Œæ™¨04:32 å¥½å›°å¥½å›° æŠ˜è…¾äº†å¥½å‡ å¤©æ–°å°ç ´ç½‘ç«™ç»ˆäºæœ‰é›å½¢äº†ï¼ï¼ å…è®¸æˆ‘å·æ‡’ä»Šå¤©å°‘å†™ç‚¹æ—¥è®°åˆ·ç‰™æ´—è„¸çˆ¬åºŠäº†ï¼ èŒ¶èŒ¶å“¦å‘€ç²Ÿç±³030 è¡¥å……ï¼šå‡Œæ™¨5ç‚¹å¤šå¿«å…­ç‚¹äº†ï¼èŒ¶èŒ¶ä¸ºäº†å¯ä¹ç‚¹äº†å¤–å–å“ˆå“ˆå•Šå“ˆï¼","link":"/2021/02/24/%E5%A5%BD%E5%9B%B0%E5%A5%BD%E5%9B%B0%EF%BC%81%EF%BC%81%EF%BC%81/"},{"title":"æ“ä½œç³»ç»Ÿ&amp;è®¡ç®—æœºç½‘ç»œ&amp;ç®—æ³•","text":"â€¦ 1. æ“ä½œç³»ç»Ÿ1.1 FAQ è™šæ‹Ÿå†…å­˜ï¼šå½“ç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼ŒæŠŠç‰©ç†å†…å­˜ä¸­å°‘ç”¨çš„æ•°æ®è½¬å‚¨åœ¨è™šæ‹Ÿå†…å­˜çš„åˆ†é¡µæ–‡ä»¶ä¸Šã€‚ 2. è®¡ç®—æœºç½‘ç»œ2.1 FAQåœ¨æµè§ˆå™¨è¾“å…¥RULåçš„è¿‡ç¨‹ dnsè§£æå‡ºipåœ°å€ =&gt; å»ºç«‹tcpè¿æ¥ =&gt; å‘é€httpè¯·æ±‚ =&gt; å¤„ç†è¯·æ±‚å¹¶è¿”å›httpæŠ¥æ–‡ Get å’Œ Post çš„åŒºåˆ« ä»åŠŸèƒ½ä¸Šæ¥è®²ï¼ŒGetè¯·æ±‚çš„æ•°æ®èƒ½å¤Ÿè¢«ç¼“å­˜ï¼Œæ‰€ä»¥æµè§ˆå™¨å€’é€€çš„æ—¶å€™ä¸ä¼šåƒPostè¯·æ±‚å‡ºç°é‡å¤æäº¤è¡¨å•çš„æƒ…å†µã€‚ ä»å‚æ•°ä¸Šæ¥è®²ï¼ŒGetçš„å‚æ•°åœ¨URLå¯è§ï¼ŒPoståœ¨Rquset Bodyå¯è§ï¼›å¹¶ä¸”Getä¼ é€’çš„å‚æ•°å¤§å°æœ‰é™åˆ¶(urlæœ‰é•¿åº¦é™åˆ¶)ã€‚ åœ¨HTTPåè®®ä¸­å»ºè®®ï¼ŒGetç”¨äºæŸ¥è¯¢è¯·æ±‚ï¼ŒPostã€Putã€Deleteç”¨äºæ•°æ®ä¿®æ”¹ã€‚ HTTPè¯·æ±‚ï¼Œæœ€åˆè®¾å®šäº†å…«ç§æ–¹æ³•ã€‚è¿™å…«ç§æ–¹æ³•æœ¬è´¨ä¸Šæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚åªæ˜¯è®©è¯·æ±‚ï¼Œæ›´åŠ æœ‰è¯­ä¹‰è€Œå·²ã€‚ OPTIONS è¿”å›æœåŠ¡å™¨æ‰€æ”¯æŒçš„è¯·æ±‚æ–¹æ³• GET å‘æœåŠ¡å™¨è·å–æŒ‡å®šèµ„æº HEAD ä¸GETä¸€è‡´ï¼Œåªä¸è¿‡å“åº”ä½“ä¸è¿”å›ï¼Œåªè¿”å›å“åº”å¤´ POST å‘æœåŠ¡å™¨æäº¤æ•°æ®ï¼Œæ•°æ®æ”¾åœ¨è¯·æ±‚ä½“é‡Œ PUT ä¸POSTç›¸ä¼¼ï¼Œåªæ˜¯å…·æœ‰å¹‚ç­‰ç‰¹æ€§ï¼Œä¸€èˆ¬ç”¨äºæ›´æ–° DELETE åˆ é™¤æœåŠ¡å™¨æŒ‡å®šèµ„æº TRACE å›æ˜¾æœåŠ¡å™¨ç«¯æ”¶åˆ°çš„è¯·æ±‚ï¼Œæµ‹è¯•çš„æ—¶å€™ä¼šç”¨åˆ°è¿™ä¸ª CONNECT é¢„ç•™ï¼Œæš‚æ— ä½¿ç”¨ Cookie å’Œ Session çš„åŒºåˆ« Cookieæ˜¯ç”±æœåŠ¡ç«¯å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„æ•°æ®ã€‚å®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šå›å‘Cookieç»™æœåŠ¡ç«¯ã€‚(å¦‚ç™»å½•é€‰é¡¹çš„â€œè¯·è®°ä½æˆ‘â€) Cookieçš„è®¾ç½®ä»¥åŠå‘é€è¿‡ç¨‹ï¼š â€“&gt; HTTP Request â€“&lt; HTTP Response + Set-Cookie(:JSESSIONID=xxxxx) â€“&gt; HTTP Request + Cookie(:JSESSIONID=xxxxx) â€“&lt; HTTP Response Sessionæ˜¯ä¿å­˜åœ¨æœåŠ¡ç«¯ä¸Šçš„ä¿¡æ¯ã€‚ Sessionç›¸å¯¹Cookieæ›´åŠ å®‰å…¨ï¼Œä½†æ˜¯å ç”¨æœåŠ¡å™¨èµ„æºã€‚ HTTP å’Œ HTTPS çš„åŒºåˆ« SSL(security Sockets Layerï¼Œå®‰å…¨å¥—æ¥å±‚)ï¼šé‡‡ç”¨èº«ä»½è®¤è¯+æ•°æ®åŠ å¯†ä¿è¯ç½‘ç»œé€šä¿¡çš„å®‰å…¨å’Œæ•°æ®çš„å®Œæ•´æ€§ï¼Œé¿å…æ•°æ®åœ¨ç½‘ç»œä¸­æ˜æ–‡ä¼ è¾“ã€‚ åŠ å¯†æ–¹å¼æœ‰å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†ï¼ŒåŒºåˆ«åœ¨äºåŠ å¯†è·Ÿè§£å¯†ä½¿ç”¨çš„æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯†é’¥ã€‚æ­¤å¤–è¿˜æœ‰å“ˆå¸Œç®—æ³•ï¼Œæ•°å­—ç­¾åç­‰ã€‚ HTTP æ˜æ–‡ä¼ è¾“ï¼Œé»˜è®¤ä½¿ç”¨80ç«¯å£(HTTPSé»˜è®¤ä½¿ç”¨443)ã€‚ HTTPè¯·æ±‚æŠ¥æ–‡çš„ç»„æˆç»“æ„ è¯·æ±‚æ–¹æ³• ï¼ˆmethodï¼‰ è¯·æ±‚URL åè®®(HTTP/HTTPS)åŠç‰ˆæœ¬ æŠ¥æ–‡å¤´ï¼ˆheaderï¼‰ æŠ¥æ–‡ä½“ï¼ˆbodyï¼‰ HTTP1.0 &amp; 1.1åŒºåˆ« HTTP(è¶…æ–‡æœ¬ä¼ è¾“åè®®)æ˜¯ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œæ˜¯ç›®å‰ä¸‡ç»´ç½‘æ•°æ®é€šä¿¡çš„åŸºç¡€ã€‚ Connection:keep-alive/close,Host(multi machine tied common IP)ã€‚ç°åœ¨é»˜è®¤ä½¿ç”¨é•¿è¿æ¥äº†ã€‚ http2 &amp; http1.1 updated on 2021.11.2 Http2ç”±å›½é™…äº’è”ç½‘å·¥ç¨‹ä»»åŠ¡ç»„äº2015å¹´å‘å¸ƒã€‚å¼€å‘http2çš„ä¸»è¦ç›®æ ‡æ˜¯ï¼šæé«˜é¡µé¢åŠ è½½é€Ÿåº¦ï¼›è¯·æ±‚å¤´å‹ç¼©ï¼›äºŒè¿›åˆ¶åè®®ï¼›æœåŠ¡ç«¯æ¨é€ï¼›TCPè¿æ¥çš„å¤šè·¯å¤ç”¨ã€‚ TCPè¿æ¥çš„å¤šè·¯å¤ç”¨ï¼šåœ¨1.0ä¸­ï¼Œä¸€ä¸ªTCPè¿æ¥ä¼šåœ¨ä¸€ä¸ªHTTPè¯·æ±‚åæ–­å¼€ï¼ˆTCPè¿æ¥æ— æ³•å¤ç”¨ï¼‰ã€‚åœ¨1.1ä¸­ï¼Œç”±äºkeep-aliveæœºåˆ¶çš„å­˜åœ¨ï¼Œåœ¨å®Œæˆä¸€ä¸ªHTTPè¯·æ±‚åè¯¥TCPè¿æ¥ä¸ä¼šç«‹å³æ–­å¼€ï¼Œå³è¿æ¥å¯ä»¥å¤ç”¨ï¼ˆTCPè¿æ¥å•è·¯å¤ç”¨ï¼‰ã€‚åœ¨2.0ä¸­ï¼Œå¯ä»¥åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸­åŒæ—¶å®Œæˆå¤šä¸ª HTTP è¯·æ±‚ï¼ˆTCPè¿æ¥å¤šè·¯å¤ç”¨ï¼‰ã€‚ æ­¤å¤–ï¼Œç°åœ¨çš„dubboã€gRPCæ¡†æ¶éƒ½æ˜¯åŸºäºHTTP2çš„åè®®äº†ã€‚ **äºŒè¿›åˆ¶åè®®ï¼šä»æ–‡æœ¬åè®®è½¬æ¢ä¸ºäº†äºŒè¿›åˆ¶åè®®ã€‚HTTP1.xé€šè¿‡å¤„ç†æ–‡æœ¬å‘½ä»¤æ¥å®Œæˆè¯·æ±‚-å“åº”å¾ªç¯ã€‚HTTP/2åˆ™æ˜¯ä½¿ç”¨äºŒè¿›åˆ¶å‘½ä»¤æ¥æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ã€‚äºŒè¿›åˆ¶åè®®å‡è½»äº†æ„é€ çš„å¤æ‚æ€§ï¼Œå¹¶ç®€åŒ–äº†ç”±äºå‘½ä»¤åŒ…å«æ–‡æœ¬å’Œå¯é€‰ç©ºæ ¼è€Œæ˜“è¢«æ··æ·†çš„å‘½ä»¤çš„å®ç°ã€‚ æµè§ˆå™¨å¦‚æœä½¿ç”¨äº†HTTP/2çš„å®ç°ï¼Œä¼šå°†å‘½ä»¤è½¬åŒ–ä¸ºäºŒè¿›åˆ¶å†è¿›è¡Œä¼ è¾“ã€‚ httpçŠ¶æ€ç  2.2 äº”å±‚æ¨¡å‹ e. åº”ç”¨å±‚(DNS SMTP FTP HTTP Telnet)d. è¿è¾“å±‚(TCP UDP)c. ç½‘ç»œå±‚(IP)(æ•°æ®æŠ¥) â€“ è·¯ç”±å™¨b. æ•°æ®é“¾è·¯å±‚a. ç‰©ç†å±‚ â€“ ç½‘å¡ æ¨¡å‹ åŠŸèƒ½ TCP/IP åè®®æ— åº”ç”¨å±‚ å„ç§æœåŠ¡å’Œåº”ç”¨ç¨‹åºåŒé€šè¿‡è¯¥å±‚åˆ©ç”¨ç½‘ç»œ DNS SMTP FTP HTTP(åº”ç”¨äºè¶…æ–‡æœ¬ä¼ è¾“) Telnet è¿è¾“å±‚ è¿›è¡Œæ•°æ®ä¼ é€ TCP UDP ç½‘ç»œå±‚ é€‰æ‹©è·¯ç”±ï¼Œè¿˜è´Ÿè´£å»ºç«‹å’Œç»´æŠ¤è¿æ¥ï¼Œæ§åˆ¶ç½‘ç»œæ‹¥å¡ IP æ•°æ®é“¾è·¯å±‚ å°†æ•°æ®å°è£…æˆå¸§ PPP ç‰©ç†å±‚ åˆ©ç”¨ç‰©ç†ä¼ è¾“ä»‹è´¨ä¸ºæ•°æ®é“¾è·¯å±‚æä¾›ç‰©ç†è¿æ¥ï¼Œä»¥ä¾¿é€æ˜ä¼ è¾“æ¯”ç‰¹æµ 2.3 TCP å’Œ UDPTCP(Transmission Control Protocol): æ˜¯ä¸€ç§é¢å‘è¿æ¥çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµçš„ä¼ è¾“å±‚é€šä¿¡åè®®ã€‚ UDP(User Datagram Protocol): æ˜¯ä¸€ç§æ— è¿æ¥ã€ä¸å¯é (i.e æ•°æ®ä¸¢åŒ… æ¸¸æˆæ‰çº¿)çš„ä¼ è¾“å±‚åè®®ã€‚ä½†UDPé€Ÿåº¦æ›´å¿«ï¼Œé€‚åˆè§†é¢‘èŠå¤©ï¼Œæ¸¸æˆäº¤äº’ï¼Œåœ¨çº¿èŠå¤©ç­‰åœºæ™¯ã€‚ 2.4 TCP çš„æ»‘åŠ¨çª—å£ TCPä½¿ç”¨æ»‘åŠ¨çª—å£åšæµé‡æ§åˆ¶ä¸ä¹±åºé‡æ’ã€‚ï¼ˆå³ä¿è¯äº†TCPçš„å¯é æ€§ï¼‰çª—å£å†…çš„æ•°æ®åŒ…æ˜¯æŒ‰é¡ºåºackçš„ï¼Œå½“å‰é¢çš„æŸä¸ªåŒ…æ— æ³•ackåˆ™ä¼šé‡è¯•ã€‚ä¿è¯äº†æ•°æ®çš„å®Œæ•´æ€§ã€‚ RTT(Round Trip Time)ï¼šå‘é€ä¸€ä¸ªæ•°æ®åŒ…åˆ°å“åº”ACKçš„æ—¶é—´ã€‚ Client å’Œ Server çš„ sequence number éƒ½æ˜¯ä» 0 å¼€å§‹çš„ï¼š æ»‘åŠ¨çª—å£ï¼šå‘é€SYNï¼ˆsynchronousï¼ŒåŒæ­¥ä¿¡å·ï¼Œç”¨äºå»ºç«‹è¿æ¥ï¼‰ + ACKï¼ˆacknowledgementï¼Œç¡®è®¤ä¿¡å·ï¼‰ TCP ä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹ã€é•¿è¿æ¥(TCP-KeepAlive)çŸ­è¿æ¥ï¼š å››æ¬¡æŒ¥æ‰‹ï¼šFINï¼ˆç»“æŸä¿¡å·ï¼Œç”¨äºé‡Šæ”¾è¿æ¥ï¼‰ã€ACK;(æ²¡æœ‰ç›´æ¥å‘é€FINä¿¡å·æ˜¯å› ä¸ºæœåŠ¡ç«¯å¯èƒ½ä»æœ‰æ•°æ®éœ€è¦ä¼ è¾“ç»™å®¢æˆ·ç«¯) FINã€ACK ä¸‰æ¬¡æ¡æ‰‹æ˜¯å› ä¸ºserverç«¯ç¬¬äºŒæ¬¡æ¡æ‰‹ ACK+SYN å‡ ç§æ‹¥å¡æ§åˆ¶æ–¹æ³•ï¼š æ…¢å¼€å§‹( slow-start ) æ‹¥å¡é¿å…( congestion avoidance ) å¿«é‡ä¼ ( fast retransmit ) å¿«æ¢å¤( fast recovery ) 3. ç®—æ³•å’Œæ•°æ®ç»“æ„ å‚ç…§ github project æ—¶é—´å¤æ‚åº¦(ä»å¤§åˆ°å°)ï¼š O(n!) &gt; O(2^n) &gt; O(n^2) &gt; O(nlogn) &gt; O(n) &gt; O(logn) O(n!) O(2^n) O(n^2) O(nlogn) O(n) O(logn) äºŒåˆ†æŸ¥æ‰¾(log2n) 3.1 ç™½æ¿ç¼–ç¨‹å•ä¾‹æ¨¡å¼,åè½¬é“¾è¡¨,äºŒåˆ†æŸ¥æ‰¾,æ ‘çš„éå†â€¦ 3.2 å¸¸è§æ’åºç®—æ³• 3.3 å¿…å¤‡åŸºç¡€ å„ç§æ’åºç®—æ³• åŸºç¡€æ•°æ®ç»“æ„å’Œç®—æ³•çš„å®ç°ï¼šå¦‚å †ã€äºŒå‰æ ‘ã€å›¾â€¦ åŸºç¡€æ•°æ®ç»“æ„çš„ä½¿ç”¨ï¼šå¦‚é“¾è¡¨ã€æ ˆã€é˜Ÿåˆ—ã€å“ˆå¸Œè¡¨ã€å›¾ã€Trieã€å¹¶æŸ¥é›†â€¦ åŸºç¡€ç®—æ³•ï¼šæ·±åº¦ä¼˜å…ˆã€å¹¿åº¦ä¼˜å…ˆã€äºŒåˆ†æŸ¥æ‰¾ã€é€’å½’â€¦ åŸºæœ¬ç®—æ³•æ€æƒ³ï¼šé€’å½’ã€åˆ†æ²»ã€å›æº¯æœç´¢ã€è´ªå¿ƒç®—æ³•ã€åŠ¨æ€è§„åˆ’â€¦ äºŒåˆ†æŸ¥æ‰¾O(logn) æœ€å¤§å…¬çº¦æ•°gcdï¼šè¾—è½¬ç›¸é™¤æ³• æœ€å°å…¬å€æ•°lcmï¼šä¸¤æ•°ç›¸ä¹˜ / æœ€å¤§å…¬çº¦æ•° O(logN) : né™¤xxxçš„æ“ä½œç­‰äº1ï¼Œ1ä¹˜xxxçš„æ“ä½œç­‰äºnã€‚eg: äºŒåˆ†æŸ¥æ‰¾ é€’å½’ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ï¼šé€’å½’çš„æ·±åº¦ depth å†³å®šã€‚ ä¸¤æ¬¡é€’å½’ï¼šO(2^n) åˆ†æ²»ç®—æ³•: O(nlogn) äºŒåˆ†æŸ¥æ‰¾ï¼š1234567891011121314151617public static int binarySearch(int[] nums, int length, int target) { int left = 0, right = length - 1; // é—­åŒºé—´ while (left &lt;= right) { int mid = (left + right) / 2; if (target == nums[mid]) { return mid; } else if (target &lt; nums[mid]) { right = mid - 1; } else { left = mid + 1; } } return -1; }","link":"/2021/04/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%AE%97%E6%B3%95/"},{"title":"æ­å»ºè½»é‡çº§ JavaWeb æ¡†æ¶","text":"è¿™æ˜¯ä¸€ä¸ªåŸºäºmvcæ¨¡å¼çš„è½»é‡java webæ¡†æ¶ï¼Œå®ç°äº†æ ¸å¿ƒçš„IOCã€AOPç­‰åŠŸèƒ½ã€‚ 0. å‰ç½®è¯´æ˜é¡¹ç›®åœ°å€ï¼šhttps://github.com/cloris-cc/mini-mvc-framework æ ¸å¿ƒåŠŸèƒ½ï¼šIOC(Inversion of Control) &amp; AOP(Aspect Oriented Programming) IOC: æ§åˆ¶æƒç”±åº”ç”¨ä»£ç ä¸­è½¬åˆ°äº†å¤–éƒ¨å®¹å™¨(å³Beanå®¹å™¨)ã€‚å³ç”±æ¡†æ¶(å¦‚Spring)æ¥æ§åˆ¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œè€Œéé€šè¿‡ä»£ç æ§åˆ¶ã€‚IOC åŠŸèƒ½é€šè¿‡ä¾èµ–æ³¨å…¥(Dependency Injection)å®ç°ã€‚ AOPï¼šå°è£…é€šç”¨é€»è¾‘ä¸ºåˆ‡é¢ä½¿ç”¨ã€‚å®ç°æŠ€æœ¯ä¸ºä»£ç†æŠ€æœ¯ æ ¸å¿ƒæŠ€æœ¯ï¼šåå°„ &amp; ä»£ç† åå°„ï¼šç¨‹åºåœ¨è¿è¡ŒçŠ¶æ€(RUNTIME)ä¸­ï¼Œèƒ½å¤Ÿè·å–ã€è°ƒç”¨ä»»æ„ç±»çš„æ–¹æ³•æˆ–å±æ€§çš„æŠ€æœ¯ã€‚ ä»£ç†ï¼šéš”ç¦»åŸå¯¹è±¡ï¼Œæˆ–ä¸ºå…¶å¢åŠ åŠŸèƒ½ã€‚ä¸»è¦æœ‰ 3 ç§ä»£ç†çš„å®ç°ï¼šé™æ€ä»£ç†ã€JDKåŠ¨æ€ä»£ç†ã€CGLibåŠ¨æ€ä»£ç† AOPçš„åº”ç”¨åœºæ™¯ï¼š æ€§èƒ½ç›‘æ§ã€æ—¥å¿—è®°å½•ã€æƒé™æ§åˆ¶ã€äº‹åŠ¡åŠŸèƒ½ç­‰ Beançš„ç”Ÿå‘½å‘¨æœŸï¼š å®ä¾‹åŒ–ï¼ˆå°†Classå®ä¾‹åŒ–ï¼Œå³cls.newInstance()ï¼‰ å±æ€§èµ‹å€¼ï¼ˆä¸»è¦æ˜¯ç»™å±æ€§Beanèµ‹å€¼ï¼Œé€šè¿‡åå°„å®ç°ï¼‰ åˆå§‹åŒ–ï¼ˆåœ¨ DispatcherServlet ä¸­åˆå§‹åŒ–ï¼Œç»§æ‰¿è‡ªHttpServletï¼‰ é”€æ¯ 1. åŸºç¡€æ¡†æ¶æ­å»º1.1 è¯»å–é…ç½®æ–‡ä»¶ æ³¨ï¼špropertiesæ˜¯Map(ç»§æ‰¿äº†hashtable)ï¼Œå­˜å‚¨k-vç»“æ„æ•°æ®ã€‚æ•…åªèƒ½ç”¨äºpropertiesæ–‡ä»¶ï¼Œä¸é€‚ç”¨äºymlæ ¼å¼æ–‡ä»¶ ä¸‹é¢æ¼”ç¤ºäº†å¦‚ä½•è¯»å–é…ç½®æ–‡ä»¶å¦‚application.propertiesçš„ä»£ç ï¼š æ­¥éª¤ï¼šæ–‡ä»¶å =&gt; InputStream (é€šè¿‡classLoaderå®ç°) =&gt; Properties 12345678// è½¬åŒ–æ–‡ä»¶ä¸ºInputStreamInputStream is = Thread.currentThread() .getContextClassLoader() .getResourceAsStream(fileName); // fileName: application.yml// åŠ è½½InputStreamProperties props = new Properties();props.load(is); 1.2 å¼€å‘ IOC æ¡†æ¶ å°†æ‰€æœ‰Beanæ”¾å…¥ä¸€ä¸ªå®¹å™¨ä¸­, å¹¶å®ä¾‹åŒ–æ‰€æœ‰Bean ç®€è¿°IOCå®ç°æ­¥éª¤ï¼š 1. Bean contextç®¡ç†: æ‰«æè·å–æŒ‡å®šåŒ…åä¸‹çš„æ‰€æœ‰ Beanï¼ˆåŒ…æ‹¬jaråŒ…é‡Œé¢classæ–‡ä»¶çš„Beanï¼Œè¿™äº›Beanå‡ç”±è‡ªå®šä¹‰æ³¨è§£å¦‚@Controllerã€@Serviceæ‰€ä¿®é¥°ï¼‰ï¼Œå¹¶ä¿å­˜åœ¨Seté›†åˆä¸­ï¼ˆä¿è¯Beanä¸ºå•ä¾‹ï¼‰ Bean å®ä¾‹åŒ–: å®ä¾‹åŒ–æ‰€æœ‰Beanï¼ˆå¹¶åˆå§‹åŒ–Controllerçš„Serviceå®ä¾‹å˜é‡ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263// 1. è·å–åŒ…åä¸‹çš„æ‰€æœ‰ç±»public class URLTest { public static void main(String[] args) throws IOException, ClassNotFoundException { getClass(&quot;cn.teamwang.framework.test&quot;); } // 1. è·å–åŒ…åä¸‹çš„æ‰€æœ‰ç±» public static Set&lt;Class&lt;?&gt;&gt; getClass(String packageName) throws IOException, ClassNotFoundException { Set&lt;Class&lt;?&gt;&gt; clsSet = new HashSet&lt;&gt;(); // è·å–ç±»åŠ è½½å™¨çš„å¦ä¸€ç§æ–¹å¼ï¼šThread.currentThread().getContextClassLoader(); // getResources(String name) - nameè·¯å¾„ä½¿ç”¨/åˆ†éš”ç¬¦ Enumeration&lt;URL&gt; urls = ClassLoader.getSystemClassLoader() .getResources(packageName.replace(&quot;.&quot;, &quot;/&quot;)); while (urls.hasMoreElements()) { URL url = urls.nextElement(); System.out.println(url.getProtocol()); // 1. protocol ä¸º fileï¼ˆå³classæ–‡ä»¶ï¼‰ if (&quot;file&quot;.equals(url.getProtocol())) { // è¿‡æ»¤å‡ºåç§°ä»¥classç»“å°¾çš„æ–‡ä»¶ File[] files = new File(url.getPath()).listFiles(new FileFilter() { @Override public boolean accept(File file) { return file.getName().endsWith(&quot;class&quot;); } }); // åå°„è·å–classï¼ˆä¸åˆå§‹åŒ–ï¼‰ if (null != files) { for (File file : files) { // eg: cn.teamwang.framework.test.Actionï¼Œå»æ‰åç¼€.class String name = packageName + &quot;.&quot; + file.getName().substring(0, file.getName().lastIndexOf(&quot;.&quot;)); System.out.println(name); // ä¸åŠ è½½å†…éƒ¨ç±» if (-1 == name.lastIndexOf(&quot;$&quot;)) { Class&lt;?&gt; cls = ClassLoader.getSystemClassLoader().loadClass(name); clsSet.add(cls); } } } } // 2. protocol ä¸º jar(å‹ç¼©åŒ…ï¼Œæ•…é‡Œé¢ä¹Ÿæœ‰æ–‡ä»¶è·¯å¾„) if (&quot;jar&quot;.equals(url.getProtocol())) { System.out.println(&quot;wait...&quot;); Enumeration&lt;JarEntry&gt; entries = ((JarURLConnection) url.openConnection()).getJarFile().entries(); while (entries.hasMoreElements()) { JarEntry jarEntry = entries.nextElement(); // jarEntry.getName(): cn/teamwang/framework/test/URLTest.class String name = jarEntry.getName().replace(&quot;/&quot;, &quot;.&quot;) .substring(0, jarEntry.getName().lastIndexOf(&quot;.&quot;)); Class&lt;?&gt; cls = ClassLoader.getSystemClassLoader().loadClass(name); clsSet.add(cls); } } } return clsSet; }} 123456789101112131415161718192021222324252627// 2. å†æ ¹æ®æ³¨è§£ç­›é€‰å‡ºæ‰€æœ‰ Bean /** * è·å–åº”ç”¨åŒ…åä¸‹æ‰€æœ‰ Service ç±» */ public static Set&lt;Class&lt;?&gt;&gt; getServiceClassSet() { Set&lt;Class&lt;?&gt;&gt; classSet = new HashSet&lt;Class&lt;?&gt;&gt;(); for (Class&lt;?&gt; cls : CLASS_SET) { if (cls.isAnnotationPresent(Service.class)) { classSet.add(cls); } } return classSet; } /** * è·å–åº”ç”¨åŒ…åä¸‹æ‰€æœ‰ Controller ç±» */ public static Set&lt;Class&lt;?&gt;&gt; getControllerClassSet() { Set&lt;Class&lt;?&gt;&gt; classSet = new HashSet&lt;Class&lt;?&gt;&gt;(); for (Class&lt;?&gt; cls : CLASS_SET) { if (cls.isAnnotationPresent(Controller.class)) { classSet.add(cls); } } return classSet; } 12345678910111213141516171819202122// 3. å®ä¾‹åŒ–åæ”¾è¿›beanå®¹å™¨ &amp; èµ‹å€¼ static { ClassHelper.getBeanClassSet().forEach(i -&gt; { BEAN_MAP.put(i, ReflectionUtil.newInstance(i)); }); } /* * 1. éå†æ‰€æœ‰ Bean å®ä¾‹ * 2. éå† Bean çš„ Fieldï¼Œå¹¶ç»™è¢« @Autowired ä¿®é¥°çš„ Field æˆå‘˜å˜é‡èµ‹å€¼ */ static { BeanHelper.getBeanMap().forEach((beanClass, beanInstance) -&gt; { for (Field field : beanClass.getDeclaredFields()) { if (field.isAnnotationPresent(Autowired.class)) { ReflectionUtil.setField(field.getType(), field, BeanHelper.getBean(field.getType())); } } }); } 1.3 é¢å¤–å†…å®¹è¿­ä»£å™¨ Iterator &amp; Enumeration ä¸¤è€…å‡å¯ä»¥éå† Set å’Œ List é›†åˆï¼ˆCollections å®¹å™¨ï¼‰ã€‚è™½ç„¶Enumerationæ•ˆç‡æ›´é«˜ï¼Œä½†æ˜¯Iteratoræ›´å®‰å…¨ã€‚å› ä¸ºå…¶ä»–çº¿ç¨‹ä¸èƒ½å¤Ÿä¿®æ”¹æ­£åœ¨è¢« iterator éå†çš„é›†åˆé‡Œé¢çš„å¯¹è±¡ã€‚ åŒæ—¶ï¼ŒIterator å…è®¸è°ƒç”¨è€…åˆ é™¤åº•å±‚é›†åˆé‡Œé¢çš„å…ƒç´ ã€‚(foreachå’Œenumerationéƒ½æ— æ³•åˆ é™¤) å¦å¤–ï¼ŒMapå®¹å™¨çš„è¿­ä»£å™¨ä¸ºentrySetã€‚ ClassLoader å¸¸ç”¨æ–¹æ³• è·å–å½“å‰çš„ClassLoaderä¹Ÿå¯ä»¥é€šè¿‡ï¼šClassLoader.getSystemClassLoader() url.getProtocol(åº”ç”¨å±‚åè®®)å¯ä»¥æ˜¯ HTTPã€HTTPSã€FTP å’Œ Fileã€‚ URL è§£æï¼š åè®®ä¸º(protocol)ï¼š http **ä¸»æœºä¸º(host:port)**ï¼šwww.runoob.com ç«¯å£å·ä¸º(port): 80 ï¼Œä»¥ä¸ŠURLå®ä¾‹å¹¶æœªæŒ‡å®šç«¯å£ï¼Œå› ä¸º HTTP åè®®é»˜è®¤çš„ç«¯å£å·ä¸º 80ã€‚ æ–‡ä»¶è·¯å¾„ä¸º(path)ï¼š/index.html **è¯·æ±‚å‚æ•°(query)**ï¼šlanguage=cn å®šä½ä½ç½®(fragment)ï¼š j2seï¼Œå®šä½åˆ°ç½‘é¡µä¸­ id å±æ€§ä¸º j2se çš„ HTML å…ƒç´ ä½ç½® å½“ä¸ºhttpæ—¶ï¼ŒURLä¸ºhttp://www.runoob.com/index.html?language=cn#j2seï¼ˆå…¶ä¸­httpä¸º protocolï¼‰ å½“ä¸ºfileæ—¶ï¼ŒURLä¸ºfile:/Users/jacky/IdeaProjects/jacky-framework/framework/target/classes/cn/teamwang/framework/testï¼Œä¸‹é¢åŒæ—¶ç»™å‡ºè·å–è¯¥ path ä¸‹ class æ–‡ä»¶çš„ä»£ç  File[] files = new File(url.getPath()).listFiles(); 1.4 Q &amp; AClassHelperè·å–Beanä¹‹åï¼Œå†é€šè¿‡åå°„æ–¹å¼æ¥è·å–å®ä¾‹å¯¹è±¡ã€‚æœ‰äº†å®ä¾‹ä¹‹åæ‰èƒ½çœŸæ­£ä½¿ç”¨è¿™ä¸ªç±»å¯¹è±¡ã€‚ @Controllerä¿®é¥°çš„ç±»æ˜¯å•ä¾‹å—ï¼Ÿ@Serviceä¿®é¥°çš„ç±»æ˜¯å•ä¾‹å—ï¼Ÿ@Controllerä¿®é¥°çš„ç±»çš„å®ä¾‹å˜é‡/æˆå‘˜å˜é‡ä¹Ÿéœ€è¦è¢«åˆå§‹åŒ–ï¼Œè¯´æ˜è¿™ä¸ªç±»çš„@Serviceçš„å®ä¾‹å˜é‡ä¼šè¢«åˆå§‹åŒ–å¤šæ¬¡ï¼Ÿ javaä¸­ä¸€ä¸ªç±»å®ä¾‹åŒ–åï¼Œé‚£ä¹ˆå…¶ä¸­çš„æˆå‘˜å˜é‡è¦å®ä¾‹åŒ–å—ï¼Ÿ è¦ï¼Œä¸å®ä¾‹åŒ–æ— æ³•ä½¿ç”¨ï¼Œä½†å®ä¾‹åŒ–å§‹ç»ˆåªè¿›è¡Œ 1 æ¬¡ã€‚ç±»çš„æˆå‘˜å±æ€§åœ¨è°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™,å¦‚æœä½ æ²¡æœ‰åœ¨æ„é€ æ–¹æ³•ä¸­ç»™è¿™äº›å±æ€§èµ‹å€¼,è¿™äº›å±æ€§éƒ½ä¼šè¢«èµ‹é»˜è®¤å€¼,æ•°å€¼ç±»å‹çš„èµ‹å€¼ä¸º 0, boolean ç±»å‹çš„èµ‹å€¼ä¸º false, å¼•ç”¨ç±»å‹èµ‹å€¼ä¸º nullã€‚ Controllerç±»ä¸­çš„è¢«@Serviceä¿®é¥°çš„å®ä¾‹å˜é‡ï¼Œæ˜¯å·²ç»è¢«å®¹å™¨åˆå§‹åŒ–è¿‡çš„ï¼Œä»…éœ€ç»™Controllerç±»çš„å®ä¾‹å˜é‡èµ‹å€¼å³å¯ï¼ˆèµ‹å€¼æ–¹å¼æœ‰2ç§ï¼šæ„é€ æ–¹æ³•èµ‹å€¼ã€åå°„è·å–Controllerç±»çš„fieldåå†èµ‹å€¼ï¼Œå¦‚ä½¿ç”¨@Mapper, @Serviceç­‰æ³¨è§£ï¼‰ @RequestMapping å®ç°çš„å…³é”®ï¼šæ˜ å°„ Request è¯·æ±‚å’Œ Handler å¤„ç†å™¨çš„å…³ç³»ã€‚ todoï¼šä»£ç ç¤ºä¾‹ï¼Œæˆ–è€…githubè¿æ¥ DispatcherServletå‰ç½®ï¼šServletæ˜¯ä»€ä¹ˆï¼Ÿä¸€ä¸ªå¤„ç†ç½‘ç»œè¯·æ±‚å’Œå“åº”çš„æ¥å£è€Œå·²ã€‚æºç å¦‚ä¸‹ï¼š 12345678910111213141516package javax.servlet; import java.io.IOException; public interface Servlet { void init(ServletConfig var1) throws ServletException; ServletConfig getServletConfig(); // ç”±service()æ–¹æ³•å†³å®šè°ƒç”¨doGetï¼ŒdoPostç­‰æ–¹æ³•ã€‚ void service(ServletRequest var1, ServletResponse var2) throws ServletException, IOException; String getServletInfo(); void destroy(); } Servlet çš„ç”Ÿå‘½å‘¨æœŸ å®¢æˆ·ç«¯è¯·æ±‚è¯¥ Servlet åŠ è½½ Servletç±»åˆ°å†…å­˜ å®ä¾‹åŒ–å¹¶è°ƒç”¨void init()æ–¹æ³•åˆå§‹åŒ–Servlet; è°ƒç”¨void service(req, res)æ–¹æ³• (æ ¹æ®è¯·æ±‚æ–¹æ³•ä¸åŒè°ƒç”¨ doget0æˆ–è€… dopost0,æ­¤å¤–è¿˜æœ‰ tohead()ã€ donut0ã€ dotrace0ã€ dodelete0ã€ dooptions(. destroy) åŠ è½½å’Œå®ä¾‹åŒ– Servletã€‚è¿™é¡¹æ“ä½œä¸€èˆ¬æ˜¯åŠ¨æ€æ‰§è¡Œçš„ã€‚ç„¶è€Œ, Serveré€šå¸¸ä¼šæä¾›ä¸€ä¸ªç®¡ç†çš„é€‰é¡¹,ç”¨äºåœ¨ Serverå¯åŠ¨æ—¶å¼ºåˆ¶è£…è½½å’Œåˆå§‹åŒ–ç‰¹å®šçš„ Servlet å…¶ä¸­ä¸€ä¸ªServletçš„å®ç°ç±»â€”â€”HttpServletï¼Œå…¶éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š æ­¤å¤–ï¼Œå¸¸è§çš„Servletè¿˜æœ‰Springå®ç°çš„DispatcherServletã€‚ 2. ä½¿æ¡†æ¶å…·å¤‡AOPç‰¹æ€§ 2.1 ä»€ä¹ˆæ˜¯ä»£ç† æ³¨æ„ï¼Œå½“æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸ºObjectæ—¶ï¼Œè¯´æ˜ä¸ºå®ä¾‹ï¼›å½“ä¸ºClassæ—¶ï¼Œè¯´æ˜ä¸ºxx.Classæˆ–instance.getClass() é€šè¿‡å®ç°ä»£ç†ç±»ï¼Œæ¥æ›¿ä»£å¯¹åŸå¯¹è±¡çš„ä½¿ç”¨ã€‚ä¸»è¦æœ‰2ç§ç”¨é€”ï¼š1.ä¸­ä»‹éš”ç¦»ä½œç”¨ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨åŸå¯¹è±¡ï¼›2.å¼€é—­åŸåˆ™ï¼Œå¢åŠ åŠŸèƒ½ ä»£ç†æŠ€æœ¯ä¸»è¦æœ‰ 3 ç§ï¼šé™æ€ä»£ç†ã€JDKåŠ¨æ€ä»£ç†ã€CGLibåŠ¨æ€ä»£ç† é™æ€ä»£ç† ç¼ºç‚¹ï¼šéœ€è¦æœ‰æ¥å£ç±»ï¼Œå¹¶ä¸”éœ€è¦é‡å†™æ¯ä¸€ä¸ªæ–¹æ³•ã€‚é€šè¿‡å®ç°æ¥å£æ–¹æ³•çš„æ–¹å¼ï¼Œæ•…ä»£ç†ç±»æ‰€ä»£ç†çš„æ–¹æ³•å‡è¦@Override 123public interface Action { void eat(); } 123456public class ActionImpl implements Action{ @Override public void eat() { System.out.println(&quot;eat&quot;); } } ä»£ç† ActionImpl ç±»: 12345678910111213141516171819202122public class ActionProxy implements Action{ private final Action action; public ActionProxy() { this.action = new ActionImpl(); } @Override public void eat() { this.sleep(); this.action.eat(); this.sleep(); } // @Override // å…¶å®ƒéœ€è¦è¢«ä»£ç†çš„æ–¹æ³• public void sleep() { System.out.println(&quot;sleep&quot;); } } JDK åŠ¨æ€ä»£ç† ç¼ºç‚¹ï¼šè¢«ä»£ç†å¯¹è±¡éœ€è¦æœ‰æ¥å£ç±»ã€‚ åœ¨æ–¹æ³•è°ƒç”¨(å³åŠ¨æ€ï¼Œä½¿ç”¨åå°„æŠ€æœ¯å®ç°)æ—¶ç«‹åˆ»ç”Ÿæ•ˆï¼Œä½†åªèƒ½ä»£ç†æœ‰æ¥å£çš„å®ç°ç±»ã€‚é€šè¿‡å®ç°JDKçš„InvocationHandleræ¥å£å®Œæˆä»£ç†ã€‚ 1234567891011public class TestMain { public static void main(String[] args) { // è¢«ä»£ç†å¯¹è±¡ Action target = new ActionImpl(); // è·å– proxy Action targetProxy = DynamicProxyHandler.getProxy(target); targetProxy.eat(); } } 1234567891011121314151617181920212223242526272829303132333435363738public class DynamicProxyHandler implements InvocationHandler { private final Object target; public DynamicProxyHandler(Object target) { this.target = target; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { before(); Object result = method.invoke(target, args); after(); return result; } /** * è·å–ä»£ç†ç±» * * @param target ä»£ç†å¯¹è±¡å®ä¾‹ * @return ä»£ç†ç±» */ @SuppressWarnings(&quot;unchecked&quot;) public static &lt;T&gt; T getProxy(T target) { return (T) Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new DynamicProxyHandler(target)); } private void before() { System.out.println(&quot;before&quot;); } private void after() { System.out.println(&quot;after&quot;); } } CGlib åŠ¨æ€ä»£ç† 1. JDKä»£ç†æ˜¯åŸºäºåå°„æœºåˆ¶ï¼ŒCGLIBæ˜¯åŸºäºç»§æ‰¿æœºåˆ¶ã€‚2. åŸç”ŸJDKä»£ç†åˆ›å»ºä»£ç†çš„é€Ÿåº¦æ›´å¿«ï¼Œä½†åˆ›å»ºåçš„ä»£ç†è¿è¡Œé€Ÿåº¦æ›´æ…¢ã€‚CGLibç›¸åï¼Œè™½ç„¶åˆå§‹åŒ–æ…¢ï¼Œä½†æ˜¯è¿è¡Œé€Ÿåº¦æ›´å¿«ï¼Œæ‰€ä»¥ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™æ›´é€‚åˆç”¨CGLibä»£ç†ã€‚ é€šè¿‡å®ç°MethodInterceptoræ¥å£å®Œæˆä»£ç†ã€‚ CGLibå¸¸ç”¨æ–¹æ³•ä»‹ç»ï¼š Enhancer.create(): åˆ›å»ºCGLibä»£ç†ç±» Method.intercept(Object obj, Method method, Object[] args, MethodProxy methodProxy) throws Throwable: ç”±ç”¨æˆ·è‡ªè¡Œå®ç°çš„ä»£ç†(æˆ–æ‹¦æˆª)æ–¹æ³•ã€‚è¿”å›ç»“æœä¸ºç›®æ ‡æ–¹æ³•çš„è¿”å›å€¼ã€‚ å®ç°MethodInterceptoræ¥å£ï¼Œé‡å†™å…¶intercept()æ–¹æ³•ã€‚å…¶ä¸­MethodProxyå‚æ•°æ˜¯ä»£ç†çš„å…³é”®ã€‚ 123456789101112131415161718192021222324252627282930public class CGLibProxy implements MethodInterceptor { @SuppressWarnings(&quot;unchecked&quot;) public &lt;T&gt; T getProxy(Class&lt;T&gt; target) { // this çš„ç±»å‹ä¸º MethodInterceptor return (T) Enhancer.create(target, this); } @SuppressWarnings(&quot;unchecked&quot;) public &lt;T&gt; T getProxy(Object target) { return (T) Enhancer.create(target.getClass(), this); } @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy methodProxy) throws Throwable { before(); Object result = methodProxy.invokeSuper(obj, args); after(); return result; } private void before() { System.out.println(&quot;before&quot;); } private void after() { System.out.println(&quot;after&quot;); } } 2.2 AOP ç®€ä»‹ AOP: Aspect-Oriented Programmingï¼Œä¸»è¦ç”¨äºä»ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥çš„æ¨ªåˆ‡é€»è¾‘ï¼Œå¦‚æ€§èƒ½ç›‘æ§ã€æ—¥å¿—è®°å½•ã€æƒé™æ§åˆ¶ç­‰ã€‚å®ç°AOPçš„æŠ€æœ¯ä¸»è¦æœ‰ï¼šä»£ç†*2ã€Spring AOPæ¡†æ¶ã€‚ Spring AOP ç¤ºä¾‹ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788package cn.teamwang.aop.sample; import org.aopalliance.intercept.MethodInterceptor; import org.aopalliance.intercept.MethodInvocation; import org.aspectj.lang.ProceedingJoinPoint; import org.aspectj.lang.annotation.Around; import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Before; import org.springframework.aop.AfterReturningAdvice; import org.springframework.aop.MethodBeforeAdvice; import org.springframework.aop.framework.ProxyFactory; import org.springframework.stereotype.Component; import java.lang.reflect.Method; /** * @author Jacky * Date: 2020/12/13 0:00 */ public class SpringAOP { static class BeforeAdvice implements MethodBeforeAdvice { @Override public void before(Method method, Object[] objects, Object o) throws Throwable { System.out.println(&quot;èµ·åºŠ&quot;); } } static class AfterAdvice implements AfterReturningAdvice { @Override public void afterReturning(Object o, Method method, Object[] objects, Object o1) throws Throwable { System.out.println(&quot;ç¡è§‰&quot;); } } /** * Around = Before + After */ static class AroundAdvice implements MethodInterceptor { @Override public Object invoke(MethodInvocation methodInvocation) throws Throwable { // before(); System.out.println(&quot;èµ·åºŠ&quot;); Object result = methodInvocation.proceed(); // after(); System.out.println(&quot;ç¡è§‰&quot;); return result; } } public static void main(String[] args) { ProxyFactory factory = new ProxyFactory(); factory.setTarget(new ActionImpl()); factory.addAdvice(new SpringAOP.BeforeAdvice()); factory.addAdvice(new SpringAOP.AfterAdvice()); Action action = (Action) factory.getProxy(); action.eat(); } /* * ç»“åˆ AspectJï¼ˆmaven: Spring-boot-starter-aopï¼‰ * é¡ºåºï¼šaround &gt; before &gt; around &gt; after &gt; afterReturning */ // todo å†…éƒ¨ç±»ä½¿ç”¨@Autowiredæœ‰æ•ˆå—ï¼Ÿæ— æ•ˆã€‚è¿™é‡Œä»…ä½œå±•ç¤ºç”¨ã€‚ @Component @Aspect class AspectSample { /** * execution()æ–¹æ³•ï¼šæ‰§è¡Œç›®æ ‡ * ç¬¬ä¸€ä¸ª*ï¼šæ‰€æœ‰ç±»å‹è¿”å›å€¼ * ç¬¬äºŒä¸ª*ï¼šæ‰€æœ‰æ–¹æ³• * (..): ä»»æ„å‚æ•° */ @Around(&quot;execution(* cn.teamwang.aop.sample.ActionImpl.*(..))&quot;) public Object around(ProceedingJoinPoint joinPoint) throws Throwable { // before(); // proceed(): è®©ç›®æ ‡æ–¹æ³•æ‰§è¡Œ Object methodResult = joinPoint.proceed(); // after(); return methodResult; } @Before(&quot;@annotation(cn.teamwang.aop.sample.Tag)&quot;) public void before() { } } } 2.3 å¼€å‘ AOP æ¡†æ¶ä¸»è¦æµç¨‹ æµç¨‹/æ€è·¯æ•´ç†(ä¸»è¦ä½¿ç”¨CGLibåŠ¨æ€ä»£ç†æŠ€æœ¯)ï¼š å®ç°åˆ‡é¢ä»£ç†ç±»AspectProxy è·å–ä»£ç†ç±»å®ä¾‹ å°†ä»£ç†ç±»å®ä¾‹æ”¾å…¥Beanå®¹å™¨è¦†ç›–ç›®æ ‡ç±»å®ä¾‹ï¼Œå³å¯ç”Ÿæ•ˆ åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆæ¨¡ä»¿CGLibçš„MethodInterceptoræ¥å£ï¼Œè®¾è®¡ä¸€ä¸ªèƒ½å¾ªç¯æ‰§è¡Œå¤šæ¬¡ä»£ç†ï¼ˆå³æ‰§è¡Œå¤šæ¬¡intercept()æ–¹æ³•ï¼‰çš„æ¥å£ã€‚ 123public interface MethodInterceptor extends Callback { Object intercept(Object var1, Method var2, Object[] var3, MethodProxy var4) throws Throwable;} 123456789101112/** * @author Jacky * Date: 2020/12/13 2:16 */public interface ProxyInterceptor { /** * ç”±ç”¨æˆ·æ¥å®ç°çš„åˆ‡é¢æ–¹æ³•ã€‚ * &lt;p&gt; * æŒ‰é¡ºåºæ‰§è¡Œé“¾å¼ä»£ç† */ Object intercept(ProxyChain proxyChain) throws Throwable;} ä¸ºäº†èƒ½å¤šæ¬¡è°ƒç”¨intercepte()æ–¹æ³•ï¼ŒProxyChain é™¤äº†å°è£…äº†åŸæœ‰çš„objï¼Œmethodï¼Œargsï¼ŒMethodProxyå‚æ•°å¤–ï¼Œå¦å¤–å¢åŠ äº†List&lt;ProxyInterceptor&gt;å‚æ•°ã€‚å¹¶åœ¨invokeæ–¹æ³•å†…å®ç°äº†å¤šæ¬¡è°ƒç”¨intercept()æ–¹æ³•ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950/** * @author Jacky * Date: 2020/12/13 2:23 */public class ProxyChain { // target: class, obj, method, args... // proxy: proxyList, methodProxy... private final Class&lt;?&gt; targetClass; private final Object targetObject; private final Method targetMethod; private final MethodProxy methodProxy; private final Object[] methodParams; private final List&lt;ProxyInterceptor&gt; proxyInterceptorList; private int proxyIndex = 0; public ProxyChain(Class&lt;?&gt; targetClass, Object targetObject, Method targetMethod, MethodProxy methodProxy, Object[] methodParams, List&lt;ProxyInterceptor&gt; proxyList) { this.targetClass = targetClass; this.targetObject = targetObject; this.targetMethod = targetMethod; this.methodProxy = methodProxy; this.methodParams = methodParams; this.proxyInterceptorList = proxyList; } public Class&lt;?&gt; getTargetClass() { return targetClass; } public Method getTargetMethod() { return targetMethod; } public Object[] getMethodParams() { return methodParams; } public Object invoke() throws Throwable { Object methodResult; if (proxyIndex &lt; proxyInterceptorList.size()) { methodResult = proxyInterceptorList.get(proxyIndex++).intercept(this); } else { // æ‰§è¡Œå®Œç”¨æˆ·å®ç°çš„æ‰€æœ‰ intercept() åï¼Œæœ€ç»ˆè°ƒç”¨ç›®æ ‡å¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•ã€‚ methodResult = methodProxy.invokeSuper(targetObject, methodParams); } return methodResult; }} Step 1. å®ç°åˆ‡é¢ä»£ç†ç±» AspectProxy1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859/** * @author Jacky * Date: 2020/12/14 2:10 */public abstract class AspectProxy implements ProxyInterceptor { public static final Logger LOGGER = LoggerFactory.getLogger(AspectProxy.class); @Override public Object intercept(ProxyChain proxyChain) throws Throwable { Object result; Class&lt;?&gt; cls = proxyChain.getTargetClass(); Method method = proxyChain.getTargetMethod(); Object[] args = proxyChain.getMethodParams(); begin(); try { if (validate()) { before(cls, method, args); result = proxyChain.invoke(); after(cls, method, args, result); } else { result = proxyChain.invoke(); } } catch (Exception e) { LOGGER.error(&quot;proxy failure: &quot;, e); error(cls, method, args, e); throw e; } finally { end(); } return result; } public boolean validate() { return true; } public void begin() { } public void before(Class&lt;?&gt; cls, Method method, Object[] args) { } public void after(Class&lt;?&gt; cls, Method method, Object[] args, Object result) throws Throwable { } public void error(Class&lt;?&gt; cls, Method method, Object[] args, Throwable e) { } public void end() { }} Step 2. è·å–ä»£ç†ç±»å®ä¾‹123456789public static &lt;T&gt; T getProxy(final Class&lt;?&gt; targetClass, final List&lt;ProxyInterceptor&gt; proxyInterceptorList) { return (T) Enhancer.create(targetClass, new MethodInterceptor() { @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy methodProxy) throws Throwable { return new ProxyChain(targetClass, obj, method, methodProxy, args, proxyInterceptorList) .invoke(); } });} Step 3. å°†ä»£ç†ç±»å®ä¾‹æ”¾å…¥Beanå®¹å™¨è¦†ç›–12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788/** * å¤„ç† ç›®æ ‡ç±»ã€åˆ‡é¢ç±» &amp; åˆ›å»ºä»£ç†ç±»å®ä¾‹ çš„å…³ç³»ã€‚ * æœ€ç»ˆä»¥ä»£ç†ç±»å®ä¾‹è¦†ç›–IOCå®¹å™¨ä¸­çš„ç›®æ ‡ç±»å®ä¾‹ã€‚ï¼ˆå¦å¤–ï¼Œè¯¥ç±»çš„åˆå§‹åŒ–æ—¶é—´åº”åœ¨IOCå®¹å™¨åˆå§‹åŒ–ä¹‹åï¼Œæ‰èƒ½å®ç°è¦†ç›–ï¼‰ * * @author Jacky * Date: 2020/12/14 4:08 */public class AOPHelper { private static final Logger LOGGER = LoggerFactory.getLogger(AOPHelper.class); static { try { Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = createProxyMap(); // ç›®æ ‡ç±»ï¼šä»£ç† Map&lt;Class&lt;?&gt;, List&lt;ProxyInterceptor&gt;&gt; targetMap = createTargetMap(proxyMap); for (Map.Entry&lt;Class&lt;?&gt;, List&lt;ProxyInterceptor&gt;&gt; targetEntry : targetMap.entrySet()) { Class&lt;?&gt; targetClass = targetEntry.getKey(); List&lt;ProxyInterceptor&gt; proxyList = targetEntry.getValue(); // åˆ›å»ºä»£ç†ç±»å®ä¾‹ Object proxyInstance = ProxyUtil.getProxy(targetClass, proxyList); // æ›¿æ¢IOCå®¹å™¨ä¸­targetClassçš„å®ä¾‹ä¸ºä»£ç†ç±»å®ä¾‹ BeanHelper.setBean(targetClass, proxyInstance); } } catch (Exception e) { LOGGER.error(&quot;aop failure&quot;, e); } } /** * (ä¸€ä¸ª)åˆ‡é¢ä»£ç†ç±» : (å¤šä¸ª)ç›®æ ‡ç±» * ä¾‹å¦‚ï¼šControllerAspectåˆ‡é¢ä»£ç†ç±» å’Œ æ‰€æœ‰çš„(value=)Controllerç›®æ ‡ç±» */ private static Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; createProxyMap() { // ä»£ç†ç±»å’Œ(å¤šä¸ª)ç›®æ ‡ç±»çš„æ˜ å°„é›†åˆ Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = new HashMap&lt;&gt;(); // proxySet: è·å–æ‰€æœ‰ç»§æ‰¿äº†AspectProxyçš„åˆ‡é¢ç±»ï¼ˆå³ AspectProxy çš„å­ç±»ï¼‰ Set&lt;Class&lt;?&gt;&gt; proxySet = ClassHelper.getClassSetBySuper(AspectProxy.class); // è·å–ç›®æ ‡ç±» for (Class&lt;?&gt; proxyClass : proxySet) { if (proxyClass.isAnnotationPresent(Aspect.class)) { // è·å– @Aspect æ³¨è§£ä¸­çš„ valueï¼Œå†è·å–è¢« value ä¿®é¥°çš„æ‰€æœ‰ç±»ã€‚ // ä»¥ ControllerAspect ä¸ºä¾‹ï¼Œç›®æ ‡ç±»å°±æ˜¯ @Aspect(Controller.class) çš„ value proxyMap.put(proxyClass, ClassHelper.getClassSetByAnnotation(proxyClass.getAnnotation(Aspect.class).value())); } } addTransactionProxy(proxyMap); return proxyMap; } /** * å› ä¸ºåˆ›å»ºä»£ç†ç±»å®ä¾‹éœ€è¦targetClassï¼ŒproxyInterceptorListå‚æ•°ï¼Œæ‰€ä»¥éœ€è¦åœ¨proxyMapçš„åŸºç¡€ä¸Šå»ºç«‹æ–°çš„æ˜ å°„å…³ç³»ã€‚ */ private static Map&lt;Class&lt;?&gt;, List&lt;ProxyInterceptor&gt;&gt; createTargetMap(Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap) throws Exception { Map&lt;Class&lt;?&gt;, List&lt;ProxyInterceptor&gt;&gt; targetMap = new HashMap&lt;&gt;(); for (Map.Entry&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyEntry : proxyMap.entrySet()) { // ä»£ç†ç±» Class&lt;?&gt; proxyClass = proxyEntry.getKey(); // n ä¸ªç›®æ ‡ç±» Set&lt;Class&lt;?&gt;&gt; targetClassSet = proxyEntry.getValue(); for (Class&lt;?&gt; targetCls : targetClassSet) { // åˆ›å»ºä»£ç†å®ä¾‹ ProxyInterceptor proxyInterceptor = (ProxyInterceptor) proxyClass.newInstance(); if (targetMap.containsKey(targetCls)) { targetMap.get(targetCls).add(proxyInterceptor); } else { List&lt;ProxyInterceptor&gt; temp = new ArrayList&lt;&gt;(); temp.add(proxyInterceptor); targetMap.put(targetCls, temp); } } } return targetMap; } private static void addTransactionProxy(Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap) { Set&lt;Class&lt;?&gt;&gt; serviceClassSet = ClassHelper.getClassSetByAnnotation(Service.class); proxyMap.put(TransactionProxy.class, serviceClassSet); }} 2.4 ThreadLocal ThreadLocal (JDK1.2): ä¸€ä¸ªç”¨æ¥å­˜æ”¾çº¿ç¨‹çš„ map å®¹å™¨ã€‚ç”¨äºè§£å†³å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ã€‚ ThreadLocalçš„æ ¸å¿ƒæœºåˆ¶ æ¯ä¸ªThreadçº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªMapã€‚ Mapé‡Œé¢å­˜å‚¨çº¿ç¨‹æœ¬åœ°å¯¹è±¡ï¼ˆkeyï¼‰å’Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼ˆvalueï¼‰ ä½†æ˜¯ï¼ŒThreadå†…éƒ¨çš„Mapæ˜¯ç”±ThreadLocalç»´æŠ¤çš„ï¼Œç”±ThreadLocalè´Ÿè´£å‘mapè·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼ã€‚ ThreadLocalçš„ä»£ç å®ç° åœ¨å®ç°ä¹‹å‰ï¼Œå…ˆè¯´æ˜ä¸‹HashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œéœ€ç”¨ConcurrentHashMap/Collections.synchronizedMap/Hashtable(æŒ‰æ€§èƒ½æ’åº)ã€‚ æ€§èƒ½å·®å¼‚æ˜¯ç”±äºHashTableç›´æ¥ç”¨synchronizedä¿®é¥°æ–¹æ³•ï¼›Collections.synchronizedMapç”¨synchronizedä¿®é¥°ä»£ç å—ï¼›ConcurrentHashMapä½¿ç”¨åˆ†æ®µé” (jdk1.7åŠæ›´æ—©)/CASã€‚ HashMapçš„çº¿ç¨‹ä¸å®‰å…¨ä¸»è¦ä½“ç°åœ¨ä¸‹é¢ä¸¤ä¸ªæ–¹é¢ï¼š1.åœ¨JDK1.7ä¸­ï¼Œå½“å¹¶å‘æ‰§è¡Œæ‰©å®¹æ“ä½œæ—¶ä¼šé€ æˆç¯å½¢é“¾å’Œæ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚2.åœ¨JDK1.8ä¸­ï¼Œåœ¨å¹¶å‘æ‰§è¡Œputæ“ä½œæ—¶ä¼šå‘ç”Ÿæ•°æ®è¦†ç›–çš„æƒ…å†µã€‚ ä¸‹é¢æ˜¯å±±å¯¨ç‰ˆThreadLocalçš„ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031public class MyThreadLocal&lt;T&gt; { // å­˜æ”¾çº¿ç¨‹çš„mapå®¹å™¨ private final Map&lt;Thread, T&gt; threadLocalMap = Collections.synchronizedMap(new HashMap&lt;&gt;()); public void set(T value) { // ä¿®æ”¹å½“å‰çš„çº¿ç¨‹Map threadLocalMap.put(Thread.currentThread(), value); } public T get() { T value = threadLocalMap.get(Thread.currentThread()); if (value == null) { value = initialValue(); } return value; } /** * ç”±å­ç±»å®ç° */ protected T initialValue() { return null; } public void remove() { threadLocalMap.remove(Thread.currentThread()); }} åº”ç”¨åœºæ™¯ï¼š æ•°æ®éš”ç¦» æ–¹ä¾¿è·å–æ•°æ®ï¼Œé¿å…æ–¹æ³•ä¸æ–­ä¼ å‚ï¼ˆå¦‚userIdï¼Œtokenç­‰ç­‰ï¼‰ 2.5 å®ç°äº‹åŠ¡åŠŸèƒ½è¯¥èŠ‚ä¸»è¦åŒ…æ‹¬ï¼šäº‹åŠ¡çš„ç‰¹æ€§(ACID)ã€éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸º(Spring) è¿™é‡Œä»…ä»‹ç»7ç§ä¼ æ’­è¡Œä¸ºçš„ä¸€ç§ï¼Œä¹Ÿæ˜¯Springæ¡†æ¶é»˜è®¤çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºã€‚ å‡è®¾ï¼šæ–¹æ³•Aä¼ æ’­åˆ°æœ‰äº‹åŠ¡çš„æ–¹æ³•Bï¼ˆå…¶å®å°±æ˜¯A\bè¢«Bè°ƒç”¨äº†ï¼‰ï¼Œæ–¹æ³•Aæœ‰äº‹åŠ¡å—ï¼Ÿ å¦‚æœæ²¡æœ‰ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼›å¦‚æœæœ‰ï¼Œå°±åŠ å…¥å½“å‰(Bçš„)äº‹åŠ¡ã€‚è¿™å°±æ˜¯Springé»˜è®¤çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºâ€”â€”PROPAGATION_REQUIRED 6 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸º æ”¯æŒå½“å‰äº‹åŠ¡(å½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœæ²¡æœ‰åˆ™å¦‚ä¸‹ï¼š) TransactionDefinition.PROPAGATION_REQUIRED: åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ã€‚ supportsï¼šä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚ mandatoryï¼šæŠ›å‡ºå¼‚å¸¸ã€‚ ä¸æ”¯æŒå½“å‰äº‹åŠ¡ requires_new: åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ï¼ˆè‹¥æœ‰ï¼‰ã€‚ not_supported: ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ï¼ˆè‹¥æœ‰ï¼‰ never: ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ˆè‹¥æœ‰ï¼‰ å®ç°@TransactionåŠŸèƒ½ 1234567891011121314151617181920212223242526272829303132333435363738public class TransactionProxy implements ProxyInterceptor { public static final Logger LOGGER = LoggerFactory.getLogger(TransactionProxy.class); public static final ThreadLocal&lt;Boolean&gt; FLAG_HOLDER = new ThreadLocal&lt;Boolean&gt;(){ @Override protected Boolean initialValue() { return false; } }; @Override public Object intercept(ProxyChain proxyChain) throws Throwable { Object result; boolean flag = FLAG_HOLDER.get(); Method method = proxyChain.getTargetMethod(); if (!flag &amp;&amp; method.isAnnotationPresent(Transaction.class)) { FLAG_HOLDER.set(true); try { DatabaseHelper.beginTransaction(); LOGGER.debug(&quot;begin transaction&quot;); result = proxyChain.invoke(); DatabaseHelper.commitTransaction(); LOGGER.debug(&quot;commit transaction&quot;); } catch (Exception e) { DatabaseHelper.rollbackTransaction(); LOGGER.debug(&quot;rollback transaction&quot;); throw e; } finally { FLAG_HOLDER.remove(); } } else { result = proxyChain.invoke(); } return result; }} æœ€åï¼Œåœ¨AOPHelperä¸­å¤„ç†ä»£ç†ç±»(TransactionProxy)å’Œç›®æ ‡ç±»(æ‰€æœ‰Service)çš„å…³ç³»å³å¯ã€‚ 4. ä¼˜åŒ–å’Œæ‹“å±•4.1 è·å–ServletAPIè·å–Servlet APIï¼Œå³è·å–HttpServletRequestå’ŒResponseå¯¹è±¡ã€‚ä¸BaseHandlerä¸€æ ·ï¼Œç”¨æ‹¦æˆª(Intercepter/DispacherServlet)çš„æ–¹æ³•å®ç°ã€‚ åœ¨DispatcherServletçš„serviceæ–¹æ³•æŠŠreqå’Œreså‚æ•°æ”¾è¿›ThreadLocalä¸­ã€‚ 5. å‘å¸ƒåˆ°mavenä»“åº“4.1 github packageç›¸å…³ä»‹ç»ï¼š https://docs.github.com/cn/free-pro-team@latest/packages/guides/configuring-apache-maven-for-use-with-github-packages è‹¥åªæƒ³è®©ä¸ªäººæˆ–åä½œè€…è®¿é—®ï¼Œåˆ™ä½¿ç”¨ç§æœ‰ä»“åº“ã€‚å¦å¤–ï¼Œå³ä¾¿æ˜¯åªä½¿ç”¨ï¼ˆå³å®‰è£…jarä¾èµ–ï¼‰ï¼Œä¹Ÿéœ€è¦é…ç½®github-tokenï¼›maven deployæ—¶éœ€è¦é…ç½®POMçš„distributionManagementæ¥æŒ‡å®šMavenåˆ†å‘æ„ä»¶çš„ä½ç½® 4.2 maven(ç•¥)4.3 jitpackç½‘ç«™ï¼šhttps://jitpack.io/ ç›´æ¥releasesç‰ˆæœ¬å·å³å¯ï¼Œç„¶åä¿®æ”¹pom.xmlæ–‡ä»¶ï¼š 123456&lt;repositories&gt; &lt;repository&gt; &lt;id&gt;jitpack.io&lt;/id&gt; &lt;url&gt;https://jitpack.io&lt;/url&gt; &lt;/repository&gt;&lt;/repositories&gt; 12345&lt;dependency&gt; &lt;groupId&gt;com.github.cloris-cc&lt;/groupId&gt; &lt;artifactId&gt;public-package&lt;/artifactId&gt; &lt;version&gt;Tag&lt;/version&gt;&lt;/dependency&gt;","link":"/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/"},{"title":"è®¾è®¡æ¨¡å¼","text":"æ¶µç›–äº†å¼€å‘ä¸­çš„å„ç§è®¾è®¡æ¨¡å¼â€¦ https://www.runoob.com/design-pattern/design-pattern-tutorial.html 1. è®¾è®¡æ¨¡å¼åˆ†ç±»1.1 åˆ›å»ºå‹æ¨¡å¼å·¥å‚æ–¹æ³•æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼ã€å•ä¾‹æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼ã€åŸå‹æ¨¡å¼ã€‚ 1.2 ç»“æ„å‹æ¨¡å¼é€‚é…å™¨æ¨¡å¼ã€è£…é¥°å™¨æ¨¡å¼ã€ä»£ç†æ¨¡å¼ã€å¤–è§‚æ¨¡å¼ã€æ¡¥æ¥æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€äº«å…ƒæ¨¡å¼ã€‚ 1.3 è¡Œä¸ºå‹æ¨¡å¼ç­–ç•¥æ¨¡å¼ã€æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ã€è¿­ä»£å­æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€å¤‡å¿˜å½•æ¨¡å¼ã€çŠ¶æ€æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼ã€ä¸­ä»‹è€…æ¨¡å¼ã€è§£é‡Šå™¨æ¨¡å¼ã€‚ 2. è®¾è®¡æ¨¡å¼çš„å…­å¤§åŸåˆ™2.1 å…·ä½“å†…å®¹ æ€»ç»“ï¼šéš”ç¦» + æ˜“æ‰©å±•ï¼ˆé€šè¿‡ å¤šæ¥å£ç»„åˆï¼›ä»£ç†ï¼›ï¼‰ é«˜å±‚ç»„ä»¶å¯ä»¥è°ƒç”¨æ§åˆ¶åº•å±‚ç»„ä»¶ï¼Œè€Œä½å±‚ç»„ä»¶ä¸å…è®¸ç›´æ¥è°ƒç”¨é«˜å±‚ç»„ä»¶ã€‚æ¯”å¦‚ hock, web åˆ†å±‚â€¦ å…­å¤§åŸåˆ™ å…·ä½“å†…å®¹ å¼€é—­åŸåˆ™ å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚(å¦‚ä»£ç†) é‡Œæ°ä»£æ¢åŸåˆ™ ä»»ä½•åŸºç±»å¯ä»¥å‡ºç°çš„åœ°æ–¹ï¼Œå­ç±»ä¸€å®šå¯ä»¥å‡ºç°ã€‚ ä¾èµ–å€’è½¬åŸåˆ™ é’ˆå¯¹æ¥å£ç¼–ç¨‹ï¼Œä¾èµ–äºæŠ½è±¡è€Œä¸ä¾èµ–äºå…·ä½“ã€‚ æ¥å£éš”ç¦»åŸåˆ™ ä½¿ç”¨å¤šä¸ªéš”ç¦»çš„æ¥å£ï¼Œæ¯”ä½¿ç”¨å•ä¸ªæ¥å£è¦å¥½ã€‚ è¿ªç±³ç‰¹æ³•åˆ™ / æœ€å°‘çŸ¥è¯†åŸåˆ™ ä¸€ä¸ªå®ä½“åº”å½“å°½é‡å°‘åœ°ä¸å…¶ä»–å®ä½“ä¹‹é—´å‘ç”Ÿç›¸äº’ä½œç”¨ï¼Œä½¿å¾—ç³»ç»ŸåŠŸèƒ½æ¨¡å—ç›¸å¯¹ç‹¬ç«‹ã€‚(åªå’Œä½ çš„å¯†å‹è°ˆè¯ã€‚) åˆæˆå¤ç”¨åŸåˆ™ å°½é‡ä½¿ç”¨ç»„åˆï¼Œè€Œä¸æ˜¯ç»§æ‰¿ã€‚ 2.2 è®¾è®¡æ¨¡å¼çš„è§£é‡Š æ¨¡å¼ æè¿° è£…é¥°è€… åŒ…è£…ä¸€ä¸ªå¯¹è±¡ï¼Œä»¥æä¾›æ–°çš„è¡Œä¸ºã€‚ çŠ¶æ€ å°è£…äº†åŸºäºçŠ¶æ€çš„è¡Œä¸ºï¼Œå¹¶ä½¿ç”¨å§”æ‰˜æ¥å†³å®šè¦ä½¿ç”¨å“ªä¸€ä¸ªã€‚ è¿­ä»£å™¨ åœ¨å¯¹è±¡çš„é›†åˆä¸­æ¸¸èµ°ï¼Œè€Œä¸æš´éœ²é›†åˆçš„å®ç°ã€‚ å¤–è§‚ ç®€åŒ–ä¸€ç¾¤å†…çš„æ¥å£ã€‚ ç­–ç•¥ å°è£…å¯ä»¥äº’æ¢çš„è¡Œä¸ºï¼Œå¹¶ä½¿ç”¨å§”æ‰˜æ¥å†³å®šè¦ä½¿ç”¨å“ªä¸€ä¸ªã€‚ ä»£ç† åŒ…è£…å¯¹è±¡ï¼Œä»¥æ§åˆ¶å¯¹æ­¤å¯¹è±¡çš„è®¿é—®ã€‚ å·¥å‚æ–¹æ³• ç”±å­ç±»å†³å®šè¦åˆ›å»ºçš„å…·ä½“ç±»æ˜¯å“ªä¸€ä¸ªã€‚ æŠ½è±¡å·¥å‚ å…è®¸å®¢æˆ·åˆ›å»ºå¯¹è±¡çš„å®¶æ—ï¼Œè€Œæ— éœ€æŒ‡å®šä»–ä»¬çš„å…·ä½“ç±»ã€‚ è§‚å¯Ÿè€… è®©å¯¹è±¡èƒ½å¤Ÿåœ¨çŠ¶æ€æ”¹å˜æ—¶è¢«é€šçŸ¥ã€‚ æ¨¡æ¿æ–¹æ³• ç”±å­ç±»å†³å®šå¦‚ä½•å®ç°ä¸€ä¸ªç®—æ³•ä¸­çš„æ­¥éª¤ã€‚ ç»„åˆ å®¢æˆ·ç”¨ä¸€è‡´çš„æ–¹å¼å¤„ç†å¯¹è±¡é›†åˆå’Œå•ä¸ªå¯¹è±¡ã€‚ å•ä»¶ ç¡®ä¿æœ‰ä¸”åªæœ‰ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚ é€‚é…å™¨ å°è£…å¯¹è±¡ï¼Œå¹¶æä¾›ä¸åŒçš„æ¥å£ã€‚ å‘½ä»¤ å°è£…è¯·æ±‚æˆä¸ºå¯¹è±¡ã€‚ 3. è§‚å¯Ÿè€…æ¨¡å¼ ä¸€å¯¹å¤šå…³ç³»ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚ 3.1 å®šä¹‰å¤šä¸ªè§‚å¯Ÿè€…(æ¶ˆè´¹è€…) è®¢é˜… æŸä¸ªä¸»é¢˜å¯¹è±¡(1*nå…³ç³»)ï¼Œå½“è¿™ä¸ªå¯¹è±¡çŠ¶æ€æ”¹å˜æ—¶ï¼Œå®ƒçš„æ‰€æœ‰è§‚å¯Ÿè€…éƒ½ä¼šæ”¶åˆ°é€šçŸ¥å¹¶è‡ªåŠ¨æ›´æ–°ã€‚ä¸»é¢˜æ˜¯çœŸæ­£æ‹¥æœ‰æ•°æ®çš„äººï¼Œåœ¨æ•°æ®å˜åŒ–æ—¶æ›´æ–°ï¼Œè¿™æ ·æ¯”è®©å¤šä¸ªå¯¹è±¡æ§åˆ¶åŒä¸€ä»½æ•°æ®(repeat)æ¥ï¼Œå¯ä»¥å¾—åˆ°æ›´å¹²å‡€çš„OOè®¾è®¡ã€‚ 3.2 è®¾è®¡åŸåˆ™æ¾è€¦åˆã€‚å³å¯¹è±¡ä¹‹é—´çš„ä¾èµ–æ€§é™ä½ã€‚ 3.3 ä»£ç ç¤ºä¾‹1234567891011// ä¸»é¢˜æ¥å£public interface Subject { // æ³¨å†Œè§‚å¯Ÿè€…(è§‚å¯Ÿè€…çš„è®¢é˜…è¡Œä¸º)ã€‚ public void registerObserver(Observer o); // ç§»é™¤è§‚å¯Ÿè€…(è§‚å¯Ÿè€…çš„é€€è®¢è¡Œä¸º)ã€‚ public void removeObserver(Observer o); // å½“ä¸»é¢˜çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä»¥é€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…å¯¹è±¡ã€‚ï¼ˆå‘æŠ¥çº¸ï¼‰ public void notifyObservers();} 12345// è§‚å¯Ÿè€…æ¥å£public interface Observer { // å½“ä¸»é¢˜çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ³¨æ„ä¼šæŠŠè¿™äº›æ•°æ®(å‚æ•°)å‘ŠçŸ¥(ä¼ é€)ç»™è§‚å¯Ÿè€…ã€‚ public void update(float temp, float humidity, float pressure);} 3.4 æ³¨æ„Observable æ˜¯ä¸€ä¸ªç±»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ¥å£ã€‚ä¸”è¿åäº†ç»„åˆå¤ç”¨åŸåˆ™ã€‚ å› ä¸ºjavaä¸æ”¯æŒç±»çš„å¤šç»§æ‰¿ï¼Œé™åˆ¶äº†Observableçš„å¤ç”¨èƒ½åŠ›ï¼Œæ— æ³•è®©ç»§æ‰¿å®ƒçš„å¯¹è±¡åšæ›´å¤šçš„äº‹æƒ…ï¼Œåè€Œå¯ä»¥é€šè¿‡å®ç°å¤šä¸ªæ¥å£æ¥å®ç°æ›´å¤šç‰¹æ€§ã€‚ æœ‰å¤šä¸ªè§‚å¯Ÿè€…æ—¶ï¼Œä¸å¯ä»¥ä¾èµ–ç‰¹å®šçš„é€šçŸ¥æ¬¡åºã€‚ 3.5 éƒ¨åˆ†æºç 1234567891011121314151617181920212223242526public class Observable { private boolean changed = false; private Vector&lt;Observer&gt; obs; /** Construct an Observable with zero Observers. */ public Observable() { obs = new Vector&lt;&gt;(); } /** * Adds an observer to the set of observers for this object, provided * that it is not the same as some observer already in the set. * The order in which notifications will be delivered to multiple * observers is not specified. See the class comment. * * @param o an observer to be added. * @throws NullPointerException if the parameter o is null. */ public synchronized void addObserver(Observer o) { if (o == null) throw new NullPointerException(); if (!obs.contains(o)) { obs.addElement(o); } } 3.6 ä½¿ç”¨åœºæ™¯MVC æ¨¡å¼ã€Swing ç¼–ç¨‹ã€JavaBeansã€RMI. 4. è£…é¥°è€…æ¨¡å¼ åœ¨ä¸ä¿®æ”¹å­ç±»çš„æƒ…å†µä¸‹ä¿®æ”¹ç±»å‹ã€å¢åŠ åŠŸèƒ½ã€‚ ä¾‹å¦‚ï¼Œé¥®æ–™åŒ…æ‹¬äº†çº¢èŒ¶ã€ç»¿èŒ¶ã€ç™½å’–å•¡ã€æ‹¿é“ç­‰ç­‰ï¼Œç„¶åè¿™äº›é¥®æ–™åˆæœ‰è®¸å¤šé…æ–™(å¦‚ç³–ã€å†°å—ã€ç‰›å¥¶ç­‰)ã€‚æ‰€ä»¥å¯å°†è¿™äº›é…æ–™(è£…é¥°)æå–ä¸ºä¸€ä¸ªæŠ½è±¡(è£…é¥°)ç±»å†è®©å­ç±»å»å®ç°ã€‚æœ¬è´¨ä¸Šå°±æ˜¯åˆ©ç”¨äº†Javaçš„ä¸‰å¤§ç‰¹æ€§ã€‚ 4.1 å®šä¹‰åŠ¨æ€åœ°å°†è¡Œä¸ºé™„åŠ åˆ°å¯¹è±¡ä¸Šã€‚é€šå¸¸é‡‡ç”¨æŠ½è±¡ç±»ï¼Œç»§æ‰¿æŠ½è±¡ç±»(æˆä¸ºè£…é¥°å™¨)**ï¼Œæ˜¯ä¸ºäº†æœ‰æ­£ç¡®çš„ç±»å‹ï¼Œè€Œä¸æ˜¯è¡Œä¸ºã€‚è¡Œä¸ºæ¥è‡ªè£…é¥°è€…å’ŒåŸºç¡€ç»„ä»¶ï¼Œæˆ–ä¸å…¶ä»–è£…é¥°è€…çš„ç»„åˆå…³ç³»ã€‚è£…é¥°è€…æ¨¡å¼æ˜¯ç»§æ‰¿çš„æœ€ä½³ä½¿ç”¨æ–¹æ³•ã€‚** è£…é¥°è€…çš„è´£ä»»ï¼šåŠ¨æ€å¢åŠ è¡Œä¸ºåˆ°è¢«åŒ…è£…çš„å¯¹è±¡ä¸Šï¼Œå°±ä¸ç”¨å»ä¿®æ”¹å¯¹è±¡çš„ä»£ç äº†ã€‚ 4.2 è®¾è®¡åŸåˆ™ç»„åˆå¤ç”¨åŸåˆ™ã€å¼€é—­åŸåˆ™(å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­)ã€‚ 4.3 ä»£ç ç¤ºä¾‹123456789public abstract class Beverage { String description = &quot;Unknow Beverage&quot;; public String getDescription() { return description; } // åœ¨å­ç±»å®ç°æŠ½è±¡æ–¹æ³• public abstract double cost();} 1234567891011// æµ“ç¼©å’–å•¡public class BlackCoffee extends Beverage { public BlackCoffee() { description = &quot;BlackCoffee-é»‘å’–å•¡&quot;; } @Override public double cost() { return 1.99; }} 12345678910public class WhiteCoffee extends Beverage { public WhiteCoffee() { description = &quot;WhiteCoffee-ç™½å’–å•¡&quot;; } @Override public double cost() { return .89; }} 1234public abstract class CondimentDecorator extends Beverage { // æ‰€æœ‰çš„è£…é¥°è€…éƒ½å¿…é¡»å®ç°æ­¤æŠ½è±¡æ–¹æ³•ã€‚ public abstract String getDescription();} 1234567891011121314151617public class Mocha extends CondimentDecorator { Beverage beverage; public Mocha(Beverage beverage) { this.beverage = beverage; } @Override public String getDescription() { return beverage.getDescription() + &quot;, Mocha&quot;; } @Override public double cost() { return .2 + beverage.cost(); }} 123456789101112131415161718public class Sugar extends CondimentDecorator { Beverage beverage; public Sugar(Beverage beverage) { this.beverage = beverage; } @Override public String getDescription() { return beverage.getDescription() + &quot;, Sugar&quot;; } @Override public double cost() { return .1 + beverage.cost(); }} 123456789101112131415161718public class Soy extends CondimentDecorator { Beverage beverage; public Soy(Beverage beverage) { this.beverage = beverage; } @Override public String getDescription() { return beverage.getDescription() + &quot;, Soy&quot;; } @Override public double cost() { return 0.3 + beverage.cost(); }} 123456789101112131415161718public class StarbuzzCoffeeApplication { public static void main(String[] args) { // åŠ ç³–çš„ç™½å’–å•¡ Beverage whiteCoffee = new WhiteCoffee(); whiteCoffee = new Sugar(whiteCoffee); System.out.println(&quot;è¯·äº«ç”¨ï¼š&quot; + whiteCoffee.getDescription()); System.out.println(&quot;ä»·æ ¼ä¸ºï¼š&quot; + whiteCoffee.cost()); // åŠ ç³–ã€åŠ é»„è±†çš„é»‘å’–å•¡ Beverage blackCoffee = new BlackCoffee(); blackCoffee = new Sugar(blackCoffee); blackCoffee = new Soy(blackCoffee); System.out.println(&quot;è¯·äº«ç”¨ï¼š&quot; + whiteCoffee.getDescription()); System.out.println(&quot;ä»·æ ¼ä¸ºï¼š&quot; + whiteCoffee.cost()); }} 4.4 ä½¿ç”¨åœºæ™¯Javaä¸­çš„I/O: FilterInputStreamæ˜¯ä¸€ä¸ªæŠ½è±¡çš„è£…é¥°ç±»ã€‚BufferedInputStreamå’ŒLineNumberInputStreamæ˜¯å…·ä½“çš„è£…é¥°è€…ã€‚åŸºç±»æ˜¯InputStream. ä¸‹é¢ä»¥ BufferedInputStream ä¸ºä¾‹ï¼š 12345678// ä½¿ç”¨è£…é¥°å™¨(è¿˜æ˜¯é€šè¿‡ç»§æ‰¿)public class BufferedInputStream extends FilterInputStream {..}// ç»§æ‰¿æŠ½è±¡ç±»ï¼Œæˆä¸ºè£…é¥°å™¨public class FilterInputStream extends InputStream {..}public abstract class InputStream implements Closeable {..} 5 å·¥å‚æ¨¡å¼ ä½œä¸ºä¸€ç§åˆ›å»ºç±»æ¨¡å¼ï¼Œåœ¨ä»»ä½•éœ€è¦ç”Ÿæˆå¤æ‚å¯¹è±¡(å¯¹è±¡ç§ç±»ç¹å¤šã€åˆ›å»ºæµç¨‹å¤æ‚)çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼ã€‚å¦‚æ—¥å¿—å·¥å‚(LoggerFactory)ã€æ•°æ®åº“é©±åŠ¨å·¥å‚(JDBCFactory)ç­‰ã€‚ 5.1 å®šä¹‰å°†åˆ›å»ºå¯¹è±¡çš„ä»£ç é›†ä¸­åœ¨ä¸€ä¸ªå¯¹è±¡æˆ–æ–¹æ³•ä¸­ï¼Œå¯ä»¥é¿å…ä»£ç çš„é‡å¤ï¼Œæ›´åŠ æ–¹ä¾¿ç»´æŠ¤ã€‚æ„å‘³ç€åœ¨å®ä¾‹åŒ–å¯¹è±¡æ—¶ï¼Œåªä¼šä¾èµ–æ¥å£ï¼Œè€Œä¸æ˜¯å…·ä½“ç±»ã€‚ æŠ½è±¡å·¥å‚æ¨¡å¼æä¾›ä¸€ä¸ªæ¥å£ï¼Œç”¨äºåˆ›å»ºç›¸å…³æˆ–ä¾èµ–å¯¹è±¡çš„å®¶æ—ï¼Œè€Œä¸éœ€è¦æ˜ç¡®æŒ‡å®šå…·ä½“ç±»ã€‚ æŠ½è±¡å·¥å‚ä½¿ç”¨å¯¹è±¡ç»„åˆã€‚ å·¥å‚æ–¹æ³•æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œä½†ç”±å­ç±»å†³å®šè¦å®ä¾‹åŒ–çš„ç±»æ—¶å“ªä¸€ä¸ªã€‚å·¥å‚æ–¹æ³•è®©ç±»æŠŠå®ä¾‹åŒ–æ¨è¿Ÿåˆ°å­ç±»ã€‚ å·¥å‚æ–¹æ³•ä½¿ç”¨ç»§æ‰¿ã€‚ 5.2 è®¾è®¡åŸåˆ™ä¾èµ–å€’ç½®åŸåˆ™ï¼šè¦ä¾èµ–æŠ½è±¡ï¼Œä¸è¦ä¾èµ–å…·ä½“ç±»ã€‚ 6. å•ä¾‹æ¨¡å¼ å•ä¾‹å’Œstaticæ–¹æ³•çš„åŒºåˆ«ï¼š é¦–å…ˆï¼Œå•ä¾‹æ˜¯é¢å‘å¯¹è±¡è€Œè¨€çš„ï¼›è€Œstaticæ˜¯é¢å‘å…·ä½“æ–¹æ³•çš„ï¼Œåœ¨å·¥å…·ç±»ä¸Šå°±èƒ½è¡¨ç°å‡ºæ¥ staticæ–¹æ³•æ•ˆç‡æ›´å¥½ å•ä¾‹å› ä¸ºåªæœ‰ä¸€å¤„å¯ä»¥è·å–å®ä¾‹ï¼Œå¯ä»¥é˜²æ­¢å®ä¾‹è¢«ä¿®æ”¹ï¼›è€Œstaticæ–¹æ³•æ‰€åœ¨çš„ç±»æ— æ³•ä¿è¯ã€‚ 7 å‘½ä»¤æ¨¡å¼7.1 å®šä¹‰1ï¼‰æŠŠæ–¹æ³•è°ƒç”¨çš„è¡Œä¸º(æˆ–ç§°è¯·æ±‚)å°è£…æˆä¸€ä¸ªå¯¹è±¡ã€‚åŒºåˆ«äºå¯¹è±¡çš„å°è£…ã€‚ 2ï¼‰å°†è¯·æ±‚å°è£…æˆå¯¹è±¡ã€‚è¿™å¯ä»¥è®©ä½ ä½¿ç”¨ä¸åŒçš„è¯·æ±‚ã€é˜Ÿåˆ—ï¼Œæˆ–è€…æ—¥å¿—è¯·æ±‚æ¥å‚æ•°åŒ–å…¶ä»–å¯¹è±¡ã€‚å‘½ä»¤æ¨¡å¼ä¹Ÿå¯ä»¥æ”¯æŒæ’¤é”€æ“ä½œã€‚ 7.2 ä½¿ç”¨åœºæ™¯å·¥ä½œé˜Ÿåˆ—ã€çº¿ç¨‹æ± ã€æ—¥å¿—è¯·æ±‚ã€‚ 8. é€‚é…å™¨æ¨¡å¼8.1 å®šä¹‰åŠä½œç”¨é€‚é…å™¨ä½œç”¨ï¼šå°†ä¸€ä¸ªæ¥å£è½¬æ¢æˆå¦ä¸€ä¸ªæ¥å£ï¼Œè®©åŸæœ¬æ¥å£ä¸å…¼å®¹çš„ç±»å¯ä»¥åˆä½œæ— é—´ã€‚ä¸åšé€‚é…å™¨åªèƒ½å»è¯¥æ¥å£çš„ä»£ç äº†ã€‚ 8.2 å¤–è§‚æ¨¡å¼12345678public float getTemp() { Thermometer thermometer = station.getThermometer(); return thermometer.getTemperature();}// éµå¾ªæœ€å°‘çŸ¥è¯†åŸåˆ™public float getTemp() { return station.getTemperature();} 9 æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼9.1 å®šä¹‰åŠç¤ºä¾‹æŠ½è±¡åŒ–ç®—æ³•ä¸ºæ¨¡æ¿ï¼Œç”±å­ç±»è´Ÿè´£å…¨éƒ¨æˆ–éƒ¨åˆ†å®ç°ã€‚ æ¨¡æ¿æ–¹æ³•æ¨¡å¼â€”â€”åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­å®šä¹‰ä¸€ä¸ªç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚æ¨¡æ¿æ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥åœ¨ä¸æ”¹å˜ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹ï¼Œé‡æ–°å®šä¹‰ç®—æ³•ä¸­çš„æŸäº›æ­¥éª¤ã€‚ 12345678910111213141516171819abstract class AbstractClass { // è¿™æ˜¯ä¸€ä¸ªæ¨¡ç‰ˆæ–¹æ³•ã€‚finalè¡¨ç¤ºä¸å…è®¸è¢«å­ç±»é‡å†™ã€‚ final void templateMethod() { primitiveOperation1(); primitiveOperation2(); concreteOperation(); hook(); } // è¿™äº›æ–¹æ³•å¯èƒ½æœ‰åŒºåˆ«ï¼Œæ‰€ä»¥ç”±å…·ä½“çš„å­ç±»å®ç°ã€‚ abstract void primitiveOperation1(); abstract void primitiveOperation2(); void concreteOperation() { // è¿™é‡Œæ˜¯å®ç°... } // æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªå…·ä½“çš„ Hock æ–¹æ³•ï¼Œä½†æ˜¯å®ƒä»€ä¹ˆéƒ½ä¸åšï¼ // å› ä¸ºä¸€ä¸ªæ–¹æ³•ï¼Œä¸æ˜¯çˆ¶ç±»å®ç°å°±æ˜¯å­ç±»å®ç°ï¼Œæ€»ä¹‹ä¸€å®šè¦å®ç°ã€‚ void hock() {}} 9.2 å¯¹æ¨¡æ¿æ–¹æ³•æŒ‚é’©12345678910111213141516171819202122public abstract class CaffeineBeverageWithHock { // template method. void prepareRecipe() { boilWater(); brew(); pourInCup(); if (customerWantsCondiments()) { addCondiments(); } } abstract void brew(); abstract void addCondiments(); void boilWater() { System.out.println(&quot;Boiling water...&quot;); } void pourInCup() { System.out.println(&quot;Pouring into cup...&quot;); } // Hook Method. SubClass can override this method. boolean customerWantsCondiments();} 10 ä»£ç†æ¨¡å¼11. å…¶å®ƒæ¨¡å¼çŠ¶æ€æ¨¡å¼ï¼šå…è®¸å¯¹è±¡åœ¨å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºï¼Œå¯¹è±¡çœ‹èµ·æ¥å¥½åƒä¿®æ”¹äº†å®ƒçš„ç±»ã€‚ æ¡¥æ¥æ¨¡å¼ï¼šä½¿ç”¨æ¡¥æ¥æ¨¡å¼ï¼Œä¸åªæ”¹å˜ä½ çš„å®ç°ï¼Œä¹Ÿæ”¹å˜ä½ çš„æŠ½è±¡ã€‚ ç”Ÿæˆå™¨æ¨¡å¼ï¼šä½¿ç”¨ç”Ÿæˆå™¨æ¨¡å¼å°è£…ä¸€ä¸ªäº§å“çš„æ„é€ è¿‡ç¨‹ï¼Œå¹¶å…è®¸æŒ‰æ­¥éª¤æ„é€ ã€‚ è´£ä»»é“¾æ¨¡å¼ï¼šè®©å¤šä¸ªå¯¹è±¡å¤„ç†æŸä¸ªè¯·æ±‚ã€‚åº”ç”¨åœºæ™¯ï¼šè¯·æ±‚ â€“&gt; A-Handler â€“&gt; B-Handler â€“&gt; C-Handler â€“&gt; New-Handler è‡é‡æ¨¡å¼ï¼šè®©æŸä¸ªç±»çš„ä¸€ä¸ªå®ä¾‹æä¾›å¤šä¸ªâ€œè™šæ‹Ÿå®ä¾‹â€ã€‚å¦‚List, Setâ€¦ è§£é‡Šå™¨æ¨¡å¼ ä¸­ä»‹è€…æ¨¡å¼ï¼šä½¿ç”¨ä¸­ä»‹è€…å¯¹è±¡æ¥é›†ä¸­ç®¡ç†å¤šä¸ªå¯¹è±¡é—´å¤æ‚çš„æ²Ÿé€šå’Œæ§åˆ¶æ–¹å¼ã€‚ å¤‡å¿˜å½•æ¨¡å¼ï¼šå¤‡ä»½ã€‚åœ¨javaä¸­ï¼Œå¯ä»¥ä½¿ç”¨åºåˆ—åŒ–æœºåˆ¶å­˜å‚¨ç³»ç»Ÿçš„çŠ¶æ€ã€‚ åŸå‹æ¨¡å¼ï¼šclone åŸå‹","link":"/2021/03/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"title":"è¿ˆå‘é«˜çº§Javaçš„é¢è¯•çªå›´è¯¾","text":"â€¦ 3. é¡¹ç›®ä¸šåŠ¡é—®é¢˜é‡å¤æ”¯ä»˜ä»€ä¹ˆæ˜¯é‡å¤æ”¯ä»˜ï¼Ÿç”±äºæ”¯ä»˜ç³»ç»Ÿæ˜¯å¼‚æ­¥å¤„ç†ä»»åŠ¡çš„ã€‚æ‰€ä»¥å¯èƒ½å­˜åœ¨è¯¥æƒ…å†µï¼šå½“ç”¨æˆ·æ”¯ä»˜å®Œæˆåï¼Œ(å¯èƒ½ç”±äºç½‘ç»œæ³¢åŠ¨ç­‰)æœ¬åœ°æœåŠ¡å™¨æ²¡æœ‰ç«‹å³æ¥æ”¶åˆ°æ”¯ä»˜ç³»ç»Ÿçš„å›è°ƒé€šçŸ¥ï¼Œè€Œæ— æ³•åŠæ—¶æ›´æ–°è®¢å•ä¿¡æ¯ï¼Œè€Œæ­¤æ—¶ç”¨æˆ·å¯èƒ½è¯¯æ“ä½œé‡æ–°å‘èµ·æ”¯ä»˜ï¼Ÿã€‚/ çŸ­æ—¶é—´2ä¸¤æ¬¡æˆ–å¤šæ¬¡æ”¯ä»˜æˆåŠŸçš„å›è°ƒé€šçŸ¥ï¼Œå³å¹¶å‘è¯·æ±‚ã€‚ è¶…æ—¶å–æ¶ˆè®¢å•å›æ»šå¤±è´¥å¦‚ä½•å¤„ç†ï¼Ÿé‡è¯•æœºåˆ¶ï¼›åˆ†å¸ƒå¼äº‹åŠ¡ï¼› äºŒé˜¶æ®µTPCæäº¤ï¼šhttps://en.wikipedia.org/wiki/Two-phase_commit_protocol é€šç”¨jvmå·¥å…·jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶æ€å·¥å…·ã€‚eg: jps -v | grep pid jinfoï¼šjvmå‚æ•°ä¿¡æ¯å·¥å…·ã€‚eg: info -flags pid jstateï¼šæŸ¥çœ‹è™šæ‹Ÿæœºå„ç§è¿ç®—çŠ¶æ€ã€‚eg: stat -gcutil pid jstackï¼šçº¿ç¨‹å¿«ç…§å·¥å…·ã€‚eg: stack -l pid jmapï¼šHeapDumpå·¥å…·ã€‚eg:1.jmap -heap pid æŸ¥çœ‹å †ä¿¡æ¯2.jmap -dumpï¼šformat=bï¼Œfile=heapDump.hprof pid å¯¼å‡ºå †æ–‡ä»¶å¹¶ç”¨ jhat æŸ¥çœ‹3.jhat -port 8899 heapDump.hprof javaæ’æŸ¥é—®é¢˜å·¥å…·ï¼švisualvm, jprofiler(ä»˜è´¹) todo å¤šçº¿ç¨‹çš„åº”ç”¨åœºæ™¯ï¼Ÿå’Œç›¸å…³ä»£ç å®ä¾‹ æ± åŒ–ç­–ç•¥ï¼šè¿æ¥æ± ä¸­çš„ç©ºé—²çº¿ç¨‹ã€‚IOå¯†é›†å‹2nï¼Œè®¡ç®—å¯†é›†å‹n+1ï¼Œå…¶ä¸­nä¸ºæœåŠ¡å™¨cpuçš„æ ¸æ•°ã€‚ 4. ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½4.1 å•æœºæ•°æ®åº“å¸¸è§æ–¹æ³•æœ‰ï¼šæŸ¥è¯¢ä¼˜åŒ–ã€æ‰¹é‡å†™(batch insert)ã€ç´¢å¼•ä¼˜åŒ–ã€innodbç›¸å…³ä¼˜åŒ–ã€‚ 6. å¾®æœåŠ¡å’Œæ¶æ„è®¤çŸ¥6.1 å¦‚ä½•é˜…è¯»æºç å¿…è¦å‰æï¼šå…ˆä¼šç”¨æ¡†æ¶+çœ‹å®˜æ–¹æ–‡æ¡£ æ¶æ„å›¾ =&gt; å¯åŠ¨æµç¨‹ =&gt; æœ€åå†çœ‹æ‰§è¡Œæ–¹æ³• Testæµ‹è¯•ç”¨ä¾‹æˆ–æ¡†æ¶æºç ï¼Œä½¿ç”¨Assert.notNull()ç­‰æ–¹æ³•æ¥æ›¿ä»£System.out.println() 6.2 SpringApplicationSpringApplicationä¸ºspringbootçš„å…¥å£ç±»ã€‚ 12345678910public SpringApplication(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) { this.resourceLoader = resourceLoader; Assert.notNull(primarySources, &quot;PrimarySources must not be null&quot;); this.primarySources = new LinkedHashSet&lt;&gt;(Arrays.asList(primarySources)); this.webApplicationType = WebApplicationType.deduceFromClasspath(); this.bootstrapRegistryInitializers = getBootstrapRegistryInitializersFromSpringFactories(); setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class)); setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class)); this.mainApplicationClass = deduceMainApplicationClass();} 6.3 spring.factories æ–‡ä»¶çš„ä½œç”¨åœ¨é˜…è¯» Spring-Boot ç›¸å…³æºç æ—¶ï¼Œå¸¸å¸¸è§åˆ° spring.factories æ–‡ä»¶ï¼Œé‡Œé¢å†™äº†è‡ªåŠ¨é…ç½®ï¼ˆAutoConfigurationï¼‰ç›¸å…³çš„ç±»åï¼Œå› æ­¤äº§ç”Ÿäº†ä¸€ä¸ªç–‘é—®ï¼šâ€œæ˜æ˜è‡ªåŠ¨é…ç½®çš„ç±»å·²ç»æ‰“ä¸Šäº† @Configuration çš„æ³¨è§£ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å†™ spring.factories æ–‡ä»¶ï¼Ÿ ç”¨è¿‡ Spring Boot çš„éƒ½çŸ¥é“ @ComponentScan æ³¨è§£çš„ä½œç”¨æ˜¯æ‰«æ @SpringBootApplication æ‰€åœ¨çš„ Application ç±»æ‰€åœ¨çš„åŒ…ï¼ˆbasepackageï¼‰ä¸‹æ‰€æœ‰çš„ @component æ³¨è§£ï¼ˆæˆ–æ‹“å±•äº† @component çš„æ³¨è§£ï¼‰æ ‡è®°çš„ beanï¼Œå¹¶æ³¨å†Œåˆ° spring å®¹å™¨ä¸­ã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº† åœ¨ Spring Boot é¡¹ç›®ä¸­ï¼Œå¦‚æœä½ æƒ³è¦è¢« Spring å®¹å™¨ç®¡ç†çš„ bean ä¸åœ¨ Spring Boot åŒ…æ‰«æè·¯å¾„ä¸‹ï¼Œæ€ä¹ˆåŠï¼Ÿ è§£å†³ Spring Boot ä¸­ä¸èƒ½è¢«é»˜è®¤è·¯å¾„æ‰«æçš„é…ç½®ç±»çš„æ–¹å¼ï¼Œæœ‰ 2 ç§ï¼š ï¼ˆ1ï¼‰åœ¨ Spring Boot ä¸»ç±»ä¸Šä½¿ç”¨ @Import æ³¨è§£ï¼ˆ2ï¼‰ä½¿ç”¨ spring.factories æ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536private static Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(ClassLoader classLoader) { Map&lt;String, List&lt;String&gt;&gt; result = cache.get(classLoader); if (result != null) { return result; } result = new HashMap&lt;&gt;(); try { // FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;; Enumeration&lt;URL&gt; urls = classLoader.getResources(FACTORIES_RESOURCE_LOCATION); while (urls.hasMoreElements()) { URL url = urls.nextElement(); UrlResource resource = new UrlResource(url); Properties properties = PropertiesLoaderUtils.loadProperties(resource); for (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) { String factoryTypeName = ((String) entry.getKey()).trim(); String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String) entry.getValue()); for (String factoryImplementationName : factoryImplementationNames) { result.computeIfAbsent(factoryTypeName, key -&gt; new ArrayList&lt;&gt;()) .add(factoryImplementationName.trim()); } } } // Replace all lists with unmodifiable lists containing unique elements result.replaceAll((factoryType, implementations) -&gt; implementations.stream().distinct() .collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList))); cache.put(classLoader, result); } catch (IOException ex) { throw new IllegalArgumentException(&quot;Unable to load factories from location [&quot; + FACTORIES_RESOURCE_LOCATION + &quot;]&quot;, ex); } return result;} è€ŒSpringè¿™ç§æœºåˆ¶ç±»ä¼¼äºJavaSPIæ¥å£ã€‚ Javaä¸­ä¾‹å¦‚æœåŠ¡å‘ç°ã€webæœåŠ¡å™¨(tomcat, netty, luccent)ã€æ•°æ®åº“è¿æ¥æ± (jdbc,hirika..)ã€æ—¥å¿—æ¨¡å—ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰éƒ½æœ‰è®¸å¤šä¸åŒçš„å®ç°ã€‚è€ŒSPIå°±æä¾›äº†è¿™ç§æœºåˆ¶ï¼šä¸ºæŸä¸ªæ¥å£å¯»æ‰¾æœåŠ¡å®ç°çš„æœºåˆ¶ã€‚ Springä¹Ÿæœ‰ç±»ä¼¼çš„JavaSPIæœºåˆ¶ã€‚å®ƒæœ‰è®¸å¤šjaråŒ…åœ¨ resources/META-INF/spring.factories æ–‡ä»¶é…ç½®äº†æ¥å£çš„å®ç°ç±»åç§°ï¼Œç„¶ååœ¨ç¨‹åºä¸­è¯»å–è¿™äº›é…ç½®æ–‡ä»¶(åœ¨classpathä¸‹èƒ½è¯»å–åˆ°)å¹¶å®ä¾‹åŒ–ã€‚ ä»¥ spring-boot-autoconfigure åŒ…ä¸ºä¾‹è¿›è¡Œä»‹ç»ï¼Œå…¶spring.factoriesä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829# Initializersorg.springframework.context.ApplicationContextInitializer=\\org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\\org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener# Application Listenersorg.springframework.context.ApplicationListener=\\org.springframework.boot.autoconfigure.BackgroundPreinitializer# Environment Post Processorsorg.springframework.boot.env.EnvironmentPostProcessor=\\org.springframework.boot.autoconfigure.integration.IntegrationPropertiesEnvironmentPostProcessor# Auto Configuration Import Listenersorg.springframework.boot.autoconfigure.AutoConfigurationImportListener=\\org.springframework.boot.autoconfigure.condition.ConditionEvaluationReportAutoConfigurationImportListener# Auto Configuration Import Filtersorg.springframework.boot.autoconfigure.AutoConfigurationImportFilter=\\org.springframework.boot.autoconfigure.condition.OnBeanCondition,\\org.springframework.boot.autoconfigure.condition.OnClassCondition,\\org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition# Auto Configureorg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\\org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\\org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\\... 6.4 DubboRPCåŸç† RPC(Remote Procedure Callï¼Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨) çº¿ç¨‹æ¨¡å‹ IOçº¿ç¨‹æ± ã€ä¸šåŠ¡å·¥ä½œçº¿ç¨‹æ± ã€Bossçº¿ç¨‹æ±  å¾®æœåŠ¡é…ç½®çŸ¥è¯†å¸¸è§çš„é…ç½®æœ‰å“ªäº›ï¼Ÿ Timeout è¶…æ—¶æ—¶é—´ã€Retrieså¤±è´¥é‡è¯•(ä¸€èˆ¬å…³é—­ï¼Œå¦åˆ™å¯èƒ½é€ æˆå¹‚ç­‰æ€§é—®é¢˜)ã€LoadBalanceè´Ÿè½½å‡è¡¡(è½®è¯¢ï¼Œéšæœºï¼Œæœ€å°‘æ´»è·ƒè°ƒç”¨ï¼Œä¸€è‡´æ€§hash)ã€‚ æœåŠ¡å‘å¸ƒæœ‰ä¾èµ–æ€ä¹ˆåŠï¼Ÿ é»˜è®¤check=â€trueâ€ï¼Œå¯ä»¥é€šè¿‡check=â€falseâ€å…³é—­æ£€æŸ¥ã€‚ åºåˆ—åŒ–æ–¹å¼ hessian(é»˜è®¤ï¼ŒäºŒè¿›åˆ¶), fastjson/Jackson, jok, protobuf(æ¨èï¼ŒäºŒè¿›åˆ¶), protostuf ä¸ºä»€ä¹ˆ PB çš„æ•ˆç‡æ˜¯æœ€é«˜çš„ï¼Ÿ å¯èƒ½æœ‰ä¸€äº›åŒå­¦æ¯”è¾ƒä¹ æƒ¯äº JSON or XML æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯¹äº Protocol Buffer è¿˜æ¯”è¾ƒé™Œç”Ÿã€‚Protocol Buffer å…¶å®æ˜¯ Google å‡ºå“çš„ä¸€ç§è½»é‡å¹¶ä¸”é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œæ€§èƒ½æ¯” JSONã€XML è¦é«˜å¾ˆå¤šã€‚RESTä¼ è¾“JSONè™½ç„¶æ–¹ä¾¿ä½†æ€§èƒ½æ›´ä½ã€‚ å…¶å® PB ä¹‹æ‰€ä»¥æ€§èƒ½å¦‚æ­¤å¥½ï¼Œä¸»è¦å¾—ç›Šäºä¸¤ä¸ªï¼šç¬¬ä¸€ï¼Œå®ƒä½¿ç”¨ proto ç¼–è¯‘å™¨ï¼Œè‡ªåŠ¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œé€Ÿåº¦éå¸¸å¿«ï¼Œåº”è¯¥æ¯” XML å’Œ JSON å¿«ä¸Šäº† 20~100 å€ï¼›ç¬¬äºŒï¼Œå®ƒçš„æ•°æ®å‹ç¼©æ•ˆæœå¥½ï¼Œå°±æ˜¯è¯´å®ƒåºåˆ—åŒ–åçš„æ•°æ®é‡ä½“ç§¯å°ã€‚å› ä¸ºä½“ç§¯å°ï¼Œä¼ è¾“èµ·æ¥å¸¦å®½å’Œé€Ÿåº¦ä¸Šä¼šæœ‰ä¼˜åŒ–ã€‚ æ‰€ä»¥ï¼Œå¦‚æœDubboæ»¡è¶³ä¸šåŠ¡åœºæ™¯çš„è¯ï¼Œä½¿ç”¨Dubboç›¸å¯¹Feignè¿™ç§ä¼ è¾“JSONæ•°æ®çš„RPCæ¡†æ¶(ä½†éRPCåè®®ï¼Œè€Œæ˜¯RESTåè®®)è€Œè¨€ï¼Œæ€§èƒ½ä¼šæ›´å¥½ã€‚è€Œç›®å‰Feign(SpringCloud)çš„å¾®æœåŠ¡ç»„ä»¶æ›´åŠ å…¨é¢ã€‚ RPCæœåŠ¡çš„é™çº§ è¿œç¨‹æœåŠ¡å‡ºç°é—®é¢˜åˆ™è¿”å›null æœåŠ¡æš´éœ²çš„è¿‡ç¨‹ todo Dubboçš„æœåŠ¡æ³¨å†Œã€å‘ç°ã€è°ƒç”¨æ˜¯å¦‚ä½•å®ç°çš„ï¼ŸSPIï¼Ÿâ€¦Dubboå¿«é€Ÿå¯åŠ¨ï¼ æœåŠ¡å‘ç°åŠè°ƒç”¨çš„è¿‡ç¨‹ç•¥ 6.5 å¦‚ä½•è§£å†³å¾®æœåŠ¡å¼‚å¸¸é—®é¢˜é™æµæ–¹å¼ï¼šæ¥å£é™æµã€æ€»é™æµã€‚ ç†”æ–­7 Other7.1 è·¨ç«™ç‚¹æ”»å‡»XSSè·¨ç«™ç‚¹jsè„šæœ¬æ”»å‡»XSS, Cross Site Scripting. è¯¥æ”»å‡»ç±»å‹æœ‰ä¸¤ç§ï¼šåå°„å‹ / å­˜å‚¨å‹ã€‚é¢„é˜²æªæ–½æ˜¯ 1.åšè¾“å…¥æ ¡éªŒï¼Œæ›¿æ¢ 2.è®¾ç½®cookieä¸ºhttp-onlyè®¿é—®æ–¹å¼ CSRFè·¨ç«™ç‚¹è¯·æ±‚æ”»å‡»è§¦å‘è·¨ç«™è¯·æ±‚é¢„é˜²ï¼šcookie hash 2.web token 7.2 å®¹å™¨åŒ–éƒ¨ç½²ç®€ä»‹Dockerçš„æ ¸å¿ƒæŠ€æœ¯æ˜¯ä»€ä¹ˆï¼š namespace å‘½åç©ºé—´ï¼Œæ˜¯éš”ç¦»è¿›ç¨‹ï¼Œç”¨æˆ·ã€ç½‘ç»œã€IPCä»¥åŠUTSç­‰çš„åŸºç¡€ã€‚ CGroups æ§åˆ¶ç»„é™åˆ¶ç¡¬ä»¶èµ„æº UnionFS åšäº†é•œåƒç®¡ç† å®¹å™¨Dockerä¸è™šæ‹Ÿæœºçš„åŒºåˆ«ï¼š è¿›ç¨‹ä¸ç³»ç»Ÿçš„åŒºåˆ«ï¼Œdockerä»…ä»…æ˜¯æ“ä½œç³»ç»Ÿ(è™šæ‹Ÿæœº)çš„ä¸€ä¸ªè¿›ç¨‹ã€‚ æ”¹é€ ä¸ºdockeréƒ¨ç½² éƒ¨åˆ†çœç•¥ application.propertiesæ–‡ä»¶ä¸­å¦‚server.port=${SERVER_PORT:8888}è¡¨ç¤ºè·å–æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒå˜é‡SERVER_PORT,å¦‚æœæ²¡æœ‰è¯¥ç¯å¢ƒå˜é‡åˆ™ä½¿ç”¨é»˜è®¤å€¼8888. 7.3 å¯¹å¼€å‘è€Œè¨€ç®—æ³•æ˜¯ä»€ä¹ˆ99.9%çš„å…¬å¸éƒ½æ˜¯äº§å“ä¸šåŠ¡é©±åŠ¨ï¼›å½“äº§å“çš„è¿è¥æ¨¡å¼æˆåŠŸåï¼Œåˆ™è€ƒè™‘éƒ¨åˆ†ä¸šåŠ¡è½¬ä¸ºæ•°æ®é©±åŠ¨ï¼Œä¾èµ–æ•°æ®(BI, å¤§æ•°æ®, ç®—æ³•)æ¥é©±åŠ¨å†³ç­–ï¼›ã€‚æ‰€ä»¥ä¸€èˆ¬åœ¨å¤§å‹äº’è”ç½‘å…¬å¸æ‰ä¼šæœ‰å¤§æ•°æ®ã€æ•°æ®æŒ–æ˜ã€ç®—æ³•å’Œäººå·¥æ™ºèƒ½è¿™ç§å®éªŒå®¤æˆ–éƒ¨é—¨ã€‚ 7.4 freshäº‘åŸç”Ÿäº‘åŸç”Ÿ = å¾®æœåŠ¡ + DevOps + æŒç»­äº¤ä»˜ + å®¹å™¨åŒ– service meshservice mesh = serverlessserverless = k8så·¥ä½œæµç¨‹ å¤§æ•°æ®","link":"/2021/10/29/%E8%BF%88%E5%90%91%E9%AB%98%E7%BA%A7Java%E7%9A%84%E9%9D%A2%E8%AF%95%E7%AA%81%E5%9B%B4%E8%AF%BE/"}],"tags":[{"name":"ç½‘æ˜“â˜ï¸","slug":"ç½‘æ˜“â˜ï¸","link":"/tags/%E7%BD%91%E6%98%93%E2%98%81%EF%B8%8F/"}],"categories":[{"name":"åç«¯å¼€å‘","slug":"åç«¯å¼€å‘","link":"/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"},{"name":"å‰ç«¯å¼€å‘","slug":"å‰ç«¯å¼€å‘","link":"/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/"},{"name":"æœªåˆ†ç±»","slug":"æœªåˆ†ç±»","link":"/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"},{"name":"Spring Cloud","slug":"Spring-Cloud","link":"/categories/Spring-Cloud/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","link":"/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"name":"DevOps","slug":"DevOps","link":"/categories/DevOps/"},{"name":"æœºå™¨å­¦ä¹ ","slug":"æœºå™¨å­¦ä¹ ","link":"/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"}]}