<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>spring cloud alibaba - 茶茶日记 - winklog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="茶茶日记 - winklog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="茶茶日记 - winklog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="于 2021 年 11 月更新！！"><meta property="og:type" content="blog"><meta property="og:title" content="spring cloud alibaba"><meta property="og:url" content="https://teamwang.cn/2021/03/07/spring-cloud-alibaba/"><meta property="og:site_name" content="茶茶日记 - winklog"><meta property="og:description" content="于 2021 年 11 月更新！！"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/veF1gH.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/R2wFkW.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/IeSkKW.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/RjDfE8.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/SgtijT.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/eVV8Wf.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/0HTX95.png"><meta property="og:image" content="https://teamwang.cn/579865af-6202-486d-aeaa-f96f94aba730.jpg"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/r8HBHv.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/fpRs3L.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/r8yB7A.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/PoCKJx.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/Rp01zA.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/8ShK3U.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/xhj1Zm.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/jnaOdX.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/zlIrBp.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/TMy4Tb.png"><meta property="og:image" content="https://teamwang.cn/96b4faf2-950f-45aa-b6b3-ef66a2850dbf.jpg"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/EwGO0G.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/zXKlvC.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/47oci7.png"><meta property="og:image" content="https://teamwang.cn/5452cd49-5ee5-40f8-8b2f-709e6a8f6fe3.jpg"><meta property="og:image" content="https://teamwang.cn/6a988529-dcc1-45f9-b623-041a48cbcd50.png"><meta property="og:image" content="https://teamwang.cn/5aa03bed-6464-4813-8f07-b51d811117c6.jpg"><meta property="og:image" content="https://teamwang.cn/7640cc08-2323-4191-be89-fc7b4004f606.jpg"><meta property="og:image" content="https://teamwang.cn/a3d95e29-8aca-4125-95d5-94a8dd50f8f0.png"><meta property="og:image" content="https://teamwang.cn/e7a62b65-c9b4-4180-aa1b-781fdfafa0a0.jpg"><meta property="og:image" content="https://teamwang.cn/3cf52e78-dbb6-4bf8-b353-d621c4401696.png"><meta property="og:image" content="https://teamwang.cn/144aae9e-73ed-4412-a10a-acd6cbf60069.jpg"><meta property="og:image" content="https://teamwang.cn/69e2087f-8786-4c13-9fa3-336f9ecb593d.png"><meta property="og:image" content="https://teamwang.cn/419cc375-240e-430e-af69-89542a75dfbf.jpg"><meta property="og:image" content="https://teamwang.cn/2caee130-8706-4474-928f-1ff975a00f1f.png"><meta property="og:image" content="https://teamwang.cn/afe3cc58-fe70-46f1-a335-ec90bdee89b6.png"><meta property="og:image" content="https://teamwang.cn/a0265e5a-4796-444d-9805-4656dbddc889.png"><meta property="og:image" content="https://teamwang.cn/48415471-9179-4f75-8182-b5e9d3cbec94.jpg"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/TOSfdm.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/IeYm0s.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/OGhLf3.png"><meta property="og:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/suFfDe.png"><meta property="article:published_time" content="2021-03-07T10:20:09.000Z"><meta property="article:modified_time" content="2021-11-09T16:18:37.834Z"><meta property="article:author" content="Jacky"><meta property="article:tag" content="茶茶,日记,茶茶日记,winklog,WinkLog,博客,teamwang,TeamWang,王嘉尔,Jakcy,jacky"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://gitee.com/jacky_cloud/oss/raw/master/uPic/veF1gH.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://teamwang.cn/2021/03/07/spring-cloud-alibaba/"},"headline":"spring cloud alibaba","image":["https://gitee.com/jacky_cloud/oss/raw/master/uPic/veF1gH.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/R2wFkW.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/IeSkKW.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/RjDfE8.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/SgtijT.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/eVV8Wf.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/0HTX95.png","https://teamwang.cn/579865af-6202-486d-aeaa-f96f94aba730.jpg","https://gitee.com/jacky_cloud/oss/raw/master/uPic/r8HBHv.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/fpRs3L.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/r8yB7A.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/PoCKJx.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/Rp01zA.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/8ShK3U.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/xhj1Zm.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/jnaOdX.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/zlIrBp.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/TMy4Tb.png","https://teamwang.cn/96b4faf2-950f-45aa-b6b3-ef66a2850dbf.jpg","https://gitee.com/jacky_cloud/oss/raw/master/uPic/EwGO0G.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/zXKlvC.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/47oci7.png","https://teamwang.cn/5452cd49-5ee5-40f8-8b2f-709e6a8f6fe3.jpg","https://teamwang.cn/6a988529-dcc1-45f9-b623-041a48cbcd50.png","https://teamwang.cn/5aa03bed-6464-4813-8f07-b51d811117c6.jpg","https://teamwang.cn/7640cc08-2323-4191-be89-fc7b4004f606.jpg","https://teamwang.cn/a3d95e29-8aca-4125-95d5-94a8dd50f8f0.png","https://teamwang.cn/e7a62b65-c9b4-4180-aa1b-781fdfafa0a0.jpg","https://teamwang.cn/3cf52e78-dbb6-4bf8-b353-d621c4401696.png","https://teamwang.cn/144aae9e-73ed-4412-a10a-acd6cbf60069.jpg","https://teamwang.cn/69e2087f-8786-4c13-9fa3-336f9ecb593d.png","https://teamwang.cn/419cc375-240e-430e-af69-89542a75dfbf.jpg","https://teamwang.cn/2caee130-8706-4474-928f-1ff975a00f1f.png","https://teamwang.cn/afe3cc58-fe70-46f1-a335-ec90bdee89b6.png","https://teamwang.cn/a0265e5a-4796-444d-9805-4656dbddc889.png","https://teamwang.cn/48415471-9179-4f75-8182-b5e9d3cbec94.jpg","https://gitee.com/jacky_cloud/oss/raw/master/uPic/TOSfdm.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/IeYm0s.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/OGhLf3.png","https://gitee.com/jacky_cloud/oss/raw/master/uPic/suFfDe.png"],"datePublished":"2021-03-07T10:20:09.000Z","dateModified":"2021-11-09T16:18:37.834Z","author":{"@type":"Person","name":"Jacky"},"description":"于 2021 年 11 月更新！！"}</script><link rel="canonical" href="https://teamwang.cn/2021/03/07/spring-cloud-alibaba/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?05af3f3bd18ffe652b63cc7ee6abb48c";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="茶茶日记 - winklog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">时光轴</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-07T10:20:09.000Z" title="3/7/2021, 6:20:09 PM">2021-03-07</time>发表</span><span class="level-item"><time dateTime="2021-11-09T16:18:37.834Z" title="11/10/2021, 12:18:37 AM">2021-11-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Spring-Cloud/">Spring Cloud</a></span><span class="level-item">1 小时读完 (大约11573个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">spring cloud alibaba</h1><div class="content"><p>于 2021 年 11 月更新！！</p>
<span id="more"></span>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">spring cloud alibaba 项目地址</a></p>
</blockquote>
<h3 id="0-1-版本说明"><a href="#0-1-版本说明" class="headerlink" title="0.1 版本说明"></a>0.1 版本说明</h3><p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/veF1gH.png" alt="veF1gH"></p>
<p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/R2wFkW.png" alt="R2wFkW"></p>
<h3 id="0-2-对比旧-SC"><a href="#0-2-对比旧-SC" class="headerlink" title="0.2 对比旧 SC"></a>0.2 对比旧 SC</h3><p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/IeSkKW.png" alt="IeSkKW"></p>
<h2 id="1-Nacos"><a href="#1-Nacos" class="headerlink" title="1. Nacos"></a><strong><a target="_blank" rel="noopener" href="https://github.com/alibaba/Nacos">1. Nacos</a></strong></h2><blockquote>
<p>一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。<br>与 Eureka 相同，均引入了 Ribbon 依赖作负载均衡功能。</p>
</blockquote>
<h3 id="1-1-配置"><a href="#1-1-配置" class="headerlink" title="1.1 配置"></a>1.1 配置</h3><h4 id="安装启动-nacos-server"><a href="#安装启动-nacos-server" class="headerlink" title="安装启动 nacos-server"></a>安装启动 nacos-server</h4><p>关于集群部署可参照官方指南：<a target="_blank" rel="noopener" href="https://github.com/nacos-group/nacos-docker">https://github.com/nacos-group/nacos-docker</a></p>
<h4 id="客户端-Discovery"><a href="#客户端-Discovery" class="headerlink" title="客户端 Discovery"></a>客户端 Discovery</h4><p><strong>application.yaml</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-ribbon-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br></pre></td></tr></table></figure>

<p><strong>code</strong><br><code>@EnableDiscoveryClient</code></p>
<p><strong>pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;service-provider&quot;,configuration = RibbonSpecialConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span> <span class="comment">// 开启 ribbon，识别服务名并实现负载均衡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public IRule randomRule() &#123;</span></span><br><span class="line"><span class="comment">//        return new RandomRule();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getForObject 是返回一个对象，Entity是 http 报文</span></span><br><span class="line">System.out.println(restTemplate.getForObject(<span class="string">&quot;http://service-provider/echo/test&quot;</span>, String.class));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ribbon作用结束&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此处不加 @Configuration 注解是为了防止全局生效，因为该配置只作用于一个service。FeignClient 的独立配置也是一样的道理。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonSpecialConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">roundRobinRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RoundRobinRule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>YML 文件配置</strong></p>
<ul>
<li>  <code>&lt;clientName&gt;.ribbon.NFLoadBalancerClassName</code>: Should implement <code>ILoadBalancer</code></li>
<li>  <code>&lt;clientName&gt;.ribbon.NFLoadBalancerRuleClassName</code>: Should implement <code>IRule</code></li>
<li>  <code>&lt;clientName&gt;.ribbon.NFLoadBalancerPingClassName</code>: Should implement <code>IPing</code></li>
<li>  <code>&lt;clientName&gt;.ribbon.NIWSServerListClassName</code>: Should implement <code>ServerList</code></li>
<li>  <code>&lt;clientName&gt;.ribbon.NIWSServerListFilterClassName</code>: Should implement <code>ServerListFilter</code></li>
</ul>
<h3 id="1-2-自定义-Ribbon-负载均衡算法"><a href="#1-2-自定义-Ribbon-负载均衡算法" class="headerlink" title="1.2 自定义 Ribbon 负载均衡算法"></a>1.2 自定义 Ribbon 负载均衡算法</h3><h4 id="基于-nacos-中服务的实例权重"><a href="#基于-nacos-中服务的实例权重" class="headerlink" title="基于 nacos 中服务的实例权重"></a>基于 nacos 中服务的实例权重</h4><blockquote>
<p>Attention：直接使用框架自带的 NacosRule 即可，不需要手动实现。</p>
</blockquote>
<p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/RjDfE8.png" alt="RjDfE8"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosWeightRule</span> <span class="keyword">extends</span> <span class="title">AbstractLoadBalancerRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NacosDiscoveryProperties nacosDiscoveryProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWithNiwsConfig</span><span class="params">(IClientConfig iClientConfig)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务名-&gt;服务实例-&gt;服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">choose</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        BaseLoadBalancer loadBalancer = (BaseLoadBalancer) <span class="keyword">this</span>.getLoadBalancer();</span><br><span class="line">        String serviceName = loadBalancer.getName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 基于 nacos 权重的负载均衡算法</span></span><br><span class="line">            Instance serviceInstance = nacosDiscoveryProperties.namingServiceInstance().selectOneHealthyInstance(serviceName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NacosServer(serviceInstance);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(e.getErrMsg());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-作为配置中心"><a href="#1-3-作为配置中心" class="headerlink" title="1.3 作为配置中心"></a>1.3 作为配置中心</h3><h4 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h4><p>首先，在pom.xml添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在bootstrap.yml中配置nacos-config配置中心地址：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">  <span class="comment"># profiles:</span></span><br><span class="line">    <span class="comment"># active: prod</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note<br>${spring.profiles.active} 当通过配置文件来指定时必须放在 bootstrap.yml 文件中。 |</p>
</blockquote>
<p>最后，在nacos新建如下配置即可（后缀yaml不能为yml）：</p>
<img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/SgtijT.png" alt="SgtijT" style="zoom:50%;" />

<p>当配置了<code>spring.profiles.active</code>时，配置中心的dataId命名应为<code>&#123;appName&#125;-&#123;active&#125;.yaml</code></p>
<p>另外，由于@Bean(单例)只会初始化一次，所以应在<code>@Value</code>注解所在类上增加<code>@RefreshScope</code>才能动态刷新配置。</p>
<p>获取环境变量的代码如下；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ConfigurableApplicationContext applicationContext = SpringApplication.run(NacosConfigApplication.class, args);</span><br><span class="line">    String userName = applicationContext.getEnvironment().getProperty(<span class="string">&quot;env.user.name&quot;</span>);</span><br><span class="line">    String userAge = applicationContext.getEnvironment().getProperty(<span class="string">&quot;env.user.age&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多个环境通用配置"><a href="#多个环境通用配置" class="headerlink" title="多个环境通用配置"></a>多个环境通用配置</h4><p>配置在{appName}.yaml中即可，对应{appName}.yml文件。</p>
<img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/eVV8Wf.png" alt="eVV8Wf" style="zoom:50%;" />

<img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/0HTX95.png" alt="0HTX95" style="zoom:50%;" />

<h4 id="多个应用的配置共享"><a href="#多个应用的配置共享" class="headerlink" title="多个应用的配置共享"></a>多个应用的配置共享</h4><p>例如，当各个服务都配置了同一个服务注册中心时，这些配置其实都可以抽离出作为通用配置。</p>
<p><strong>（已弃用）</strong><br><img src="/579865af-6202-486d-aeaa-f96f94aba730.jpg"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">opensource-service-provider</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># config external configuration</span></span><br><span class="line"><span class="comment"># 1、Data Id 在默认的组 DEFAULT_GROUP,不支持配置的动态刷新</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.extension-configs[0].data-id</span>=<span class="string">ext-config-common01.properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、Data Id 不在默认的组，不支持动态刷新</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.extension-configs[1].data-id</span>=<span class="string">ext-config-common02.properties</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.extension-configs[1].group</span>=<span class="string">GLOBALE_GROUP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3、Data Id 既不在默认的组，也支持动态刷新</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.extension-configs[2].data-id</span>=<span class="string">ext-config-common03.properties</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.extension-configs[2].group</span>=<span class="string">REFRESH_GROUP</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.extension-configs[2].refresh</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置支持共享的 Data Id</span></span><br><span class="line"><span class="string">spring.cloud.nacos.config.shared-configs[0].data-id=common.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Data Id 所在分组，缺省默认 DEFAULT_GROUP</span></span><br><span class="line"><span class="string">spring.cloud.nacos.config.shared-configs[0].group=GROUP_APP1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Data Id 在配置变更时，是否动态刷新，缺省默认 false</span></span><br><span class="line"><span class="string">spring.cloud.nacos.config.shared-configs[0].refresh=true</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>  通过 <code>spring.cloud.nacos.config.shared-configs[n].data-id</code> 来支持多个共享 Data Id 的配置。</p>
</li>
<li><p>  通过 <code>spring.cloud.nacos.config.shared-configs[n].group</code> 来配置自定义 Data Id 所在的组，不明确配置的话，默认是 DEFAULT_GROUP。</p>
</li>
<li><p>  通过 <code>spring.cloud.nacos.config.shared-configs[n].refresh</code> 来控制该Data Id在配置变更时，是否支持应用中动态刷新，默认false。</p>
</li>
</ul>
<h4 id="其它特性"><a href="#其它特性" class="headerlink" title="其它特性"></a>其它特性</h4><h5 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h5><blockquote>
<p>用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。</p>
</blockquote>
<h5 id="group"><a href="#group" class="headerlink" title="group"></a>group</h5><blockquote>
<p>Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。</p>
</blockquote>
<h3 id="1-4-生产环境部署"><a href="#1-4-生产环境部署" class="headerlink" title="1.4 生产环境部署"></a>1.4 生产环境部署</h3><p>clone并使用docker-compose启动：<br><a target="_blank" rel="noopener" href="https://github.com/nacos-group/nacos-docker">https://github.com/nacos-group/nacos-docker</a></p>
<p><strong>Attention</strong></p>
<p>在 docker-compose.yml 和 xxx.env 文件中修改使用自己初始化后的 mysql</p>
<p>初始化sql脚本：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql">https://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql</a></p>
<h2 id="2-Feign-应用"><a href="#2-Feign-应用" class="headerlink" title="2. Feign 应用"></a>2. Feign 应用</h2><h3 id="2-1-日志打印"><a href="#2-1-日志打印" class="headerlink" title="2.1 日志打印"></a>2.1 日志打印</h3><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/r8HBHv.png" alt="r8HBHv" style="zoom:50%;" />

<h4 id="YML-全局配置"><a href="#YML-全局配置" class="headerlink" title="YML 全局配置"></a>YML 全局配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line"> <span class="attr">client:</span></span><br><span class="line">   <span class="attr">config:</span></span><br><span class="line">     <span class="attr">default:</span></span><br><span class="line">       <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">       <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">       <span class="attr">loggerLevel:</span> <span class="string">basic</span></span><br></pre></td></tr></table></figure>

<h4 id="YML-自定义配置"><a href="#YML-自定义配置" class="headerlink" title="YML 自定义配置"></a>YML 自定义配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">feignName:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">full</span></span><br><span class="line">        <span class="attr">errorDecoder:</span> <span class="string">com.example.SimpleErrorDecoder</span></span><br><span class="line">        <span class="attr">retryer:</span> <span class="string">com.example.SimpleRetryer</span></span><br><span class="line">        <span class="attr">requestInterceptors:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">com.example.FooRequestInterceptor</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">com.example.BarRequestInterceptor</span></span><br><span class="line">        <span class="attr">decode404:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">encoder:</span> <span class="string">com.example.SimpleEncoder</span></span><br><span class="line">        <span class="attr">decoder:</span> <span class="string">com.example.SimpleDecoder</span></span><br><span class="line">        <span class="attr">contract:</span> <span class="string">com.example.SimpleContract</span></span><br></pre></td></tr></table></figure>

<h4 id="代码配置"><a href="#代码配置" class="headerlink" title="代码配置"></a>代码配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging.level.project.user.UserClient:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-实现拦截器"><a href="#2-2-实现拦截器" class="headerlink" title="2.2 实现拦截器"></a>2.2 实现拦截器</h3><p>略</p>
<h3 id="2-3-Feign-的文讲传输"><a href="#2-3-Feign-的文讲传输" class="headerlink" title="2.3 Feign 的文讲传输"></a>2.3 Feign 的文讲传输</h3><ul>
<li><p>Feign 的多参数请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/q&quot;) # 仅限GET请求，也可以使用@RequestParam替代@SpringQueryMap拆分为多个参数。也可以直接用@RequestParam + Map接受参数，但是不推荐</span><br><span class="line"><span class="function">UserDTO <span class="title">query</span><span class="params">(<span class="meta">@SpringQueryMap</span> UserDTO userDTO)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭 Hystrix 功能</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To disable Hystrix in Feign</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>文件上传/下载</p>
</li>
</ul>
<p>首先，添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>文件上传代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">    name = &quot;file-upload-service&quot;,</span></span><br><span class="line"><span class="meta">    configuration = FileUploadServiceClient.MultipartSupportConfig.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FileUploadServiceClient</span> <span class="keyword">extends</span> <span class="title">IFileUploadServiceClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultipartSupportConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Encoder <span class="title">feignFormEncoder</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> SpringFormEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/upload&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">fileUpload</span><span class="params">(<span class="meta">@RequestPart(value = &quot;file&quot;)</span> MultipartFile file)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件下载代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">    name = &quot;$&#123;feign.name&#125;&quot;,</span></span><br><span class="line"><span class="meta">    url = &quot;$&#123;feign.url&#125;&quot;</span></span><br><span class="line"><span class="meta">    configuration = DownloadClient.ClientConfiguration.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DownloadClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping(&quot;/multipart/download/&#123;fileId&#125;&quot;)</span></span><br><span class="line">  MultipartFile[] download(<span class="meta">@PathVariable(&quot;fileId&quot;)</span> String fileId);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ClientConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectFactory&lt;HttpMessageConverters&gt; messageConverters;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Decoder <span class="title">feignDecoder</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">      List&lt;HttpMessageConverter&lt;?&gt;&gt; springConverters =</span><br><span class="line">            messageConverters.getObject().getConverters();</span><br><span class="line"></span><br><span class="line">      List&lt;HttpMessageConverter&lt;?&gt;&gt; decoderConverters =</span><br><span class="line">            <span class="keyword">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;(springConverters.size() + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      decoderConverters.addAll(springConverters);</span><br><span class="line">      decoderConverters.add(<span class="keyword">new</span> SpringManyMultipartFilesReader(<span class="number">4096</span>));</span><br><span class="line"></span><br><span class="line">      HttpMessageConverters httpMessageConverters = <span class="keyword">new</span> HttpMessageConverters(decoderConverters);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> SpringDecoder(<span class="keyword">new</span> ObjectFactory&lt;HttpMessageConverters&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpMessageConverters <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> httpMessageConverters;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-性能优化"><a href="#2-4-性能优化" class="headerlink" title="2.4 性能优化"></a>2.4 性能优化</h3><blockquote>
<p>连接池</p>
</blockquote>
<p>使用<code>feign-httpclient</code>(Hotox版本已经集成，因为yml的配置已有？)</p>
<ol>
<li>在pom.xml中添加该依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>修改yml配置<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="3-Sentinel"><a href="#3-Sentinel" class="headerlink" title="3. Sentinel"></a><strong><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">3. Sentinel</a></strong></h2><blockquote>
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从<strong>流量控制</strong>（限流）、<strong>熔断降级</strong>（熔断）、系统负载保护等多个维度保护服务的稳定性。<br><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%96%B0%E6%89%8B%E6%8C%87%E5%8D%97#%E5%85%AC%E7%BD%91-demo">Sentinel 新手指南URL</a><br><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel">With springcloud</a></p>
</blockquote>
<h3 id="3-1-基础概念"><a href="#3-1-基础概念" class="headerlink" title="3.1 基础概念"></a>3.1 基础概念</h3><h4 id="断路器状态"><a href="#断路器状态" class="headerlink" title="断路器状态"></a>断路器状态</h4><p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/fpRs3L.png" alt="fpRs3L"></p>
<h4 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h4><p>监控；限流降级；异常熔断；</p>
<p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/r8yB7A.png" alt="r8yB7A"></p>
<p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/PoCKJx.png" alt="PoCKJx"></p>
<h3 id="3-2-快速开始"><a href="#3-2-快速开始" class="headerlink" title="3.2 快速开始"></a>3.2 快速开始</h3><h4 id="下载并启动-Sentinel-Dashboard"><a href="#下载并启动-Sentinel-Dashboard" class="headerlink" title="下载并启动 Sentinel Dashboard"></a>下载并启动 Sentinel Dashboard</h4><p>启动命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar</span><br></pre></td></tr></table></figure>

<p>额外启动命令（-D）：</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认值</th>
<th>最小值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>server.port</td>
<td>8080</td>
<td>-</td>
<td>指定 Dashboard 端口</td>
</tr>
<tr>
<td>csp.sentinel.dashboard.server</td>
<td>localhost:8080</td>
<td>-</td>
<td>指定地址</td>
</tr>
<tr>
<td>project.name</td>
<td>-</td>
<td>-</td>
<td>指定程序的名称</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.username [v1.6]</td>
<td>sentinel</td>
<td>-</td>
<td>Dashboard登录账号</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.password [v1.6]</td>
<td>sentinel</td>
<td>-</td>
<td>Dashboard登录密码</td>
</tr>
<tr>
<td>server.servlet.sesion.timeout [v1.6]</td>
<td>30分钟</td>
<td>-</td>
<td>登录Session过期时间。配置为7200表示7200秒，配置60m表示60分钟</td>
</tr>
</tbody></table>
<h4 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h4><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">sentinel:</span></span><br><span class="line">			<span class="attr">transport:</span></span><br><span class="line">				<span class="attr">port:</span> <span class="number">8719</span> <span class="comment"># 客户端和 sentinel 传输数据的端口。比如: 限流规则等数据</span></span><br><span class="line">				<span class="attr">dashboard:</span> <span class="string">localhost:8080</span> <span class="comment"># Sentinel Dashboard</span></span><br></pre></td></tr></table></figure>

<p>在 Service 层的方法上添加 <code>@SentinelResource</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SentinelApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SentinelApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SentinelResource(value = &quot;sayHello&quot;,blockHandler = &quot;exceptionHandler&quot;)</span> <span class="comment">// ,fallback = &quot;protect&quot;</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="number">10</span>/Integer.parseInt(name));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">protect</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;生不出人，我很抱歉&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">exceptionHandler</span><span class="params">(String name, BlockException ex)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Do some log here.</span></span><br><span class="line">            System.out.println(<span class="string">&quot;呵呵&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Oops, error occurred at &quot;</span> + name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        <span class="keyword">private</span> TestService service;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(value = &quot;/hello/&#123;name&#125;&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">apiHello</span><span class="params">(<span class="meta">@PathVariable</span> String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> service.sayHello(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，Feign 的接入也和 Hystrix 相似。</p>
<h3 id="3-3-Sentinel-配置"><a href="#3-3-Sentinel-配置" class="headerlink" title="3.3 Sentinel 配置"></a>3.3 Sentinel 配置</h3><h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><ul>
<li><p>配置 sentinel dashboard：localhost:8080</p>
</li>
<li><p>关闭所有节点的监控：<code>spring.cloud.sentinel.filter.enabled=false</code>，使用<code>@SentinelResource</code>注解在<strong>Service实现方法</strong>处埋点。</p>
</li>
<li><p>实现 Sentinel 对 feign 的支持：<code>feign.sentinel.enabled=true</code>(默认是 false，即 sentinel 的功能对 feign 的调用是不生效的)。另外 fallback 的类需要加上<code>@Component</code>注解。</p>
</li>
</ul>
<p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/Rp01zA.png" alt="Rp01zA"></p>
<h4 id="为-Sentinel-配置-DataSource"><a href="#为-Sentinel-配置-DataSource" class="headerlink" title="为 Sentinel 配置 DataSource"></a>为 Sentinel 配置 DataSource</h4><blockquote>
<p>若不配置 Datasource，Sentinel的流控、降级等<strong>规则</strong>这些数据无法持久化，容易造成丢失。</p>
</blockquote>
<p><code>SentinelProperties</code> 内部提供了 <code>TreeMap</code> 类型的 <code>datasource</code> 属性用于配置数据源信息。</p>
<p>比如配置 4 个数据源：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入本地文件</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds1.file.file</span>=<span class="string">classpath: degraderule.json</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds1.file.rule-type</span>=<span class="string">flow</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#spring.cloud.sentinel.datasource.ds1.file.file=classpath: flowrule.json</span></span><br><span class="line"><span class="comment">#spring.cloud.sentinel.datasource.ds1.file.data-type=custom</span></span><br><span class="line"><span class="comment">#spring.cloud.sentinel.datasource.ds1.file.converter-class=com.alibaba.cloud.examples.JsonFlowRuleListConverter</span></span><br><span class="line"><span class="comment">#spring.cloud.sentinel.datasource.ds1.file.rule-type=flow</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 nacos 保存 Sentinel 的规则数据（然后nacos使用mysql....）</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds2.nacos.server-addr</span>=<span class="string">localhost:8848</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds2.nacos.data-id</span>=<span class="string">sentinel</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds2.nacos.group-id</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds2.nacos.data-type</span>=<span class="string">json</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds2.nacos.rule-type</span>=<span class="string">degrade</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># zookeeper</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds3.zk.path</span> = <span class="string">/Sentinel-Demo/SYSTEM-CODE-DEMO-FLOW</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds3.zk.server-addr</span> = <span class="string">localhost:2181</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds3.zk.rule-type</span>=<span class="string">authority</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apollo</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds4.apollo.namespace-name</span> = <span class="string">application</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds4.apollo.flow-rules-key</span> = <span class="string">sentinel</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds4.apollo.default-flow-rule-value</span> = <span class="string">test</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds4.apollo.rule-type</span>=<span class="string">param-flow</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-对-Sentinel-中的异常处理"><a href="#3-4-对-Sentinel-中的异常处理" class="headerlink" title="3.4 对 Sentinel 中的异常处理"></a>3.4 对 Sentinel 中的异常处理</h3><h4 id="全局异常处理"><a href="#全局异常处理" class="headerlink" title="全局异常处理"></a>全局异常处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUrlBlockHandler</span> <span class="keyword">implements</span> <span class="title">UrlBlockHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">blocked</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException ex)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ErrorMsg msg = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> FlowException) &#123;</span><br><span class="line">            msg = ErrorMsg.builder()</span><br><span class="line">                .status(<span class="number">100</span>)</span><br><span class="line">                .msg(<span class="string">&quot;限流了&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> DegradeException) &#123;</span><br><span class="line">            msg = ErrorMsg.builder()</span><br><span class="line">                .status(<span class="number">101</span>)</span><br><span class="line">                .msg(<span class="string">&quot;降级了&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ParamFlowException) &#123;</span><br><span class="line">            msg = ErrorMsg.builder()</span><br><span class="line">                .status(<span class="number">102</span>)</span><br><span class="line">                .msg(<span class="string">&quot;热点参数限流&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> SystemBlockException) &#123;</span><br><span class="line">            msg = ErrorMsg.builder()</span><br><span class="line">                .status(<span class="number">103</span>)</span><br><span class="line">                .msg(<span class="string">&quot;系统规则（负载/...不满足要求）&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> AuthorityException) &#123;</span><br><span class="line">            msg = ErrorMsg.builder()</span><br><span class="line">                .status(<span class="number">104</span>)</span><br><span class="line">                .msg(<span class="string">&quot;授权规则不通过&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// http状态码</span></span><br><span class="line">        response.setStatus(<span class="number">500</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="comment">// spring mvc自带的json操作工具，叫jackson</span></span><br><span class="line">        <span class="keyword">new</span> ObjectMapper()</span><br><span class="line">            .writeValue(</span><br><span class="line">                response.getWriter(),</span><br><span class="line">                msg</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorMsg</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法内异常处理"><a href="#方法内异常处理" class="headerlink" title="方法内异常处理"></a>方法内异常处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(</span></span><br><span class="line"><span class="meta">    value = &quot;test-sentinel-api&quot;,</span></span><br><span class="line"><span class="meta">    blockHandler = &quot;block&quot;,</span></span><br><span class="line"><span class="meta">    blockHandlerClass = TestControllerBlockHandlerClass.class,</span></span><br><span class="line"><span class="meta">    fallback = &quot;fallback&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testSentinelResource</span><span class="params">(<span class="meta">@RequestParam(required = false)</span> String a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(a)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;a cannot be blank.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestControllerBlockHandlerClass</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理限流或者降级</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> a</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">block</span><span class="params">(String a, BlockException e)</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">&quot;限流，或者降级了 block&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;限流，或者降级了 block&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-网关限流"><a href="#3-5-网关限流" class="headerlink" title="3.5 网关限流"></a>3.5 网关限流</h3><blockquote>
<p>关键就是能把资源识别成 @SentinelSource<br>参照：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81">https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81</a></p>
</blockquote>
<h4 id="Spring-Cloud-Gateway"><a href="#Spring-Cloud-Gateway" class="headerlink" title="Spring Cloud Gateway"></a>Spring Cloud Gateway</h4><h4 id="Zuul-1-x-amp-2-x"><a href="#Zuul-1-x-amp-2-x" class="headerlink" title="Zuul 1.x &amp; 2.x"></a>Zuul 1.x &amp; 2.x</h4><h2 id="4-RocketMQ-快速开始"><a href="#4-RocketMQ-快速开始" class="headerlink" title="4. RocketMQ 快速开始"></a>4. <a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/quick-start/">RocketMQ 快速开始</a></h2><blockquote>
<p>下载rocketmq，分别启动 nameserver 和 broker</p>
</blockquote>
<p>RocketMQ 开发者指南：<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/tree/master/docs/cn">https://github.com/apache/rocketmq/tree/master/docs/cn</a></p>
<p>apache rocketmq 官方文档：<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/quick-start/">https://rocketmq.apache.org/docs/quick-start/</a></p>
<p>RocketMQ-Spring 框架是 RocketMQ 与 Spring Boot 的整合，RocketMQ Spring 主要提供了 3 个特性：</p>
<ol>
<li> 使用 <code>RocketMQTemplate</code> 用来统一发送消息，包括同步、异步发送消息和事务消息</li>
<li> <code>@RocketMQTransactionListener</code> 注解用来处理事务消息的监听和回查（或者也可以用分布式事务框架处理）</li>
<li> <code>@RocketMQMessageListener</code> 注解用来消费消息</li>
</ol>
<h3 id="4-1-基本概念"><a href="#4-1-基本概念" class="headerlink" title="4.1 基本概念"></a>4.1 基本概念</h3><p>主题 Topic：RocketMQ 消息的基本订阅单位</p>
<p>消息模型：Producer生产者，Broker消息代理 用于存储转发消息，Consumer消费者</p>
<p>部署结构：</p>
<ul>
<li><p>name server：通过该 server 查找各 topic 对应的 broker IP 列表</p>
</li>
<li><p>broker server：消息中转角色，负责存储消息、转发消息</p>
</li>
</ul>
<p>消费模式：</p>
<ul>
<li>Pull Consumer：消费者主动从 Broker Server 拉取消息</li>
<li>Push Consumer：Broker 收到消息后主动推送给消费者，该模式实时性较高（默认）</li>
</ul>
<p>Group：</p>
<ul>
<li>Producer Group：同一类Producer的集合</li>
<li>Consumer Group：同一类Consumer的集合</li>
</ul>
<p>消息传播模式：</p>
<ul>
<li>Clustering (集群)：同个ConsumerGroup的每个Consumer平均分摊消息</li>
<li>Broadcasting (广播)：同个ConsumerGroup的每个Consumer都接收全量消息</li>
</ul>
<p>消息类型：普通消息、顺序消息、<strong>定时/延时消息</strong>、<strong>事务消息</strong></p>
<p>标签 Tag ：为消息设置的标志，用于<mark>同一主题下区分不同类型</mark>的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</p>
<h3 id="4-2-最佳实践"><a href="#4-2-最佳实践" class="headerlink" title="4.2 最佳实践"></a>4.2 最佳实践</h3><blockquote>
<p>TIPS:<br>a. 不需要依赖返回值的 methods 可以使用 async 执行（耗时等于 0）。<br>b. MQ 适用场景：</p>
</blockquote>
<p><strong>Spring 实现异步的方法</strong></p>
<ol>
<li>AsyncRestTemplate</li>
<li>@Async 注解（常用）</li>
<li>WebClient</li>
<li>消息队列（次常用）：生产 + 消费架构</li>
</ol>
<p><strong>Kafka、RocketMQ、RabbitMQ 对比</strong></p>
<p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/8ShK3U.png" alt="8ShK3U"><br><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/xhj1Zm.png" alt="xhj1Zm"><br><br/></p>
<p>面试围绕：1.业务(<strong>事务</strong>，<strong>定时/延迟消息</strong>，重试机制) 2.性能(TPS，集群)</p>
<p>RocketMQ: **唯一支持事务(消息)**，消息堆积性能稳定（和卡夫卡一样）</p>
<h4 id="a-生产者"><a href="#a-生产者" class="headerlink" title="a. 生产者"></a>a. 生产者</h4><h5 id="发送消息注意事项"><a href="#发送消息注意事项" class="headerlink" title="发送消息注意事项"></a>发送消息注意事项</h5><ol>
<li>TAG: 一个应用尽可能用一个Topic，而消息子类型则可以用<strong>tags</strong>来标识。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MessageBuilder builder = MessageBuilder.withPayload(msg) .setHeader(RocketMQHeaders.TAGS, <span class="string">&quot;binder&quot;</span>) .setHeader(RocketMQHeaders.KEYS, <span class="string">&quot;my-key&quot;</span>) .setHeader(MessageConst.PROPERTY_DELAY_TIME_LEVEL, <span class="string">&quot;1&quot;</span>); Message message = builder.build(); output().send(message);</span><br></pre></td></tr></table></figure></li>
<li>Keys: 每个消息在业务层面的唯一标识码要设置到<strong>keys</strong>字段，方便将来定位消息丢失问题。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单Id</span></span><br><span class="line">String orderId = <span class="string">&quot;20034568923546&quot;</span>;</span><br><span class="line">message.setKeys(orderId);</span><br></pre></td></tr></table></figure></li>
<li>日志的打印：消息发送成功或者失败要打印消息日志，务必要打印SendResult和key字段。</li>
</ol>
<h5 id="消息发送失败处理方式"><a href="#消息发送失败处理方式" class="headerlink" title="消息发送失败处理方式"></a>消息发送失败处理方式</h5><p>Producer的send方法本身支持内部重试，<strong>重试逻辑</strong>如下：</p>
<ul>
<li>至多重试2次（同步发送为2次，异步发送为0次）。</li>
<li>如果发送失败，则轮转到下一个Broker。这个方法的总耗时时间不超过sendMsgTimeout设置的值，默认10s。</li>
<li>如果本身向broker发送消息产生超时异常，就不会再重试。（<strong>自行处理</strong>）</li>
</ul>
<p>如果业务对消息可靠性要求比较高，建议应用增加相应的重试逻辑：比如调用send同步方法发送失败时，则尝试将消息存储到db，然后由后台线程定时重试，确保消息一定到达Broker。(RocketMQ不集成DB主要考虑2点：性能和安全)</p>
<h4 id="b-消费者"><a href="#b-消费者" class="headerlink" title="b. 消费者"></a>b. 消费者</h4><h5 id="保证幂等性"><a href="#保证幂等性" class="headerlink" title="保证幂等性"></a>保证幂等性</h5><blockquote>
<p>什么是幂等性？在编程中一个幂等操作的特点是其<strong>任意多次执行所产生的影响均与一次执行的影响相同</strong>。</p>
</blockquote>
<p>利用消息体中的<strong>唯一标识字段</strong>做判断。不能使用消息 id，因为可能会存在相同的消息有两个不同msgId的情况（消费者主动重发、因客户端重投机制导致的重复等），这种情况就需要使业务字段进行重复消费。</p>
<h5 id="消费速度慢的处理方式"><a href="#消费速度慢的处理方式" class="headerlink" title="消费速度慢的处理方式"></a>消费速度慢的处理方式</h5><p><strong>提高消费并行度</strong></p>
<p>绝大部分消息消费行为都属于 IO 密集型，即可能是操作数据库，或者调用 RPC，这类消费行为的消费速度在于后端数据库或者外系统的吞吐量，通过增加消费并行度，可以提高总的消费吞吐量，但是并行度增加到一定程度，反而会下降。所以，应用必须要设置合理的并行度。 如下有几种修改消费并行度的方法：</p>
<ul>
<li>  同一个 ConsumerGroup 下，通过增加 Consumer 实例数量来提高并行度（需要注意的是超过订阅队列数的 Consumer 实例无效）。可以通过加机器，或者在已有机器启动多个进程的方式。</li>
<li>  提高单个 Consumer 的消费并行线程，通过修改参数 consumeThreadMin、consumeThreadMax实现。</li>
</ul>
<p><strong>批量方式消费</strong></p>
<p>某些业务流程如果支持批量方式消费，则可以很大程度上提高消费吞吐量，例如订单扣款类应用，一次处理一个订单耗时 1 s，一次处理 10 个订单可能也只耗时 2 s，这样即可大幅度提高消费的吞吐量，通过设置 consumer 的 <code>consumeMessageBatchMaxSize</code> 返个参数，默认是 1，即一次只消费一条消息，例如设置为 N，那么每次消费的消息数小于等于 N。</p>
<h4 id="c-Broker"><a href="#c-Broker" class="headerlink" title="c. Broker"></a>c. Broker</h4><blockquote>
<p>Broker 角色分为 ASYNC_MASTER（异步主机）、SYNC_MASTER（同步主机）以及SLAVE（从机）。如果对消息的可靠性要求比较严格，可以采用 SYNC_MASTER加SLAVE的部署方式。如果对消息可靠性要求不高，可以采用ASYNC_MASTER加SLAVE的部署方式。如果只是测试方便，则可以选择仅ASYNC_MASTER或仅SYNC_MASTER的部署方式。</p>
</blockquote>
<h4 id="e-Message-结构"><a href="#e-Message-结构" class="headerlink" title="e. Message 结构"></a>e. Message 结构</h4><table>
<thead>
<tr>
<th>字段名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Topic</td>
<td>null</td>
<td>必填，消息所属topic的名称</td>
</tr>
<tr>
<td>Body</td>
<td>null</td>
<td>必填，消息体</td>
</tr>
<tr>
<td>Tags</td>
<td>null</td>
<td>选填，消息标签，方便服务器过滤使用。目前只支持每个消息设置一个tag</td>
</tr>
<tr>
<td>Keys</td>
<td>null</td>
<td>选填，代表这条消息的业务关键词，服务器会根据keys创建哈希索引，设置后，可以在Console系统根据Topic、Keys来查询消息，由于是哈希索引，请尽可能保证key唯一，例如订单号，商品Id等。</td>
</tr>
<tr>
<td>Flag</td>
<td>0</td>
<td>选填，完全由应用来设置，RocketMQ不做干预</td>
</tr>
<tr>
<td>DelayTimeLevel</td>
<td>0</td>
<td>选填，消息延时级别，0表示不延时，大于0会延时特定的时间才会被消费</td>
</tr>
<tr>
<td>WaitStoreMsgOK</td>
<td>TRUE</td>
<td>选填，表示消息是否在服务器落盘后才返回应答。</td>
</tr>
</tbody></table>
<h4 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h4><p><strong>JVM优化</strong></p>
<p>推荐使用最新发布的JDK 1.8版本。通过设置相同的Xms和Xmx值来防止JVM调整堆大小以获得更好的性能。简单的JVM配置如下所示：</p>
<p><code>-server -Xms8g -Xmx8g -Xmn4g </code></p>
<p>如果您不关心RocketMQ Broker的启动时间，还有一种更好的选择，就是通过“预触摸”Java堆以确保在JVM初始化期间每个页面都将被分配。那些不关心启动时间的人可以启用它： ​ -XX:+AlwaysPreTouch<br>禁用偏置锁定可能会减少JVM暂停， ​ -XX:-UseBiasedLocking<br>至于垃圾回收，建议使用带JDK 1.8的G1收集器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseG1GC -XX:G1HeapRegionSize&#x3D;16m   </span><br><span class="line">-XX:G1ReservePercent&#x3D;25 </span><br><span class="line">-XX:InitiatingHeapOccupancyPercent&#x3D;30</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这些GC选项看起来有点激进，但事实证明它在我们的生产环境中具有良好的性能。另外不要把-XX:MaxGCPauseMillis的值设置太小，否则JVM将使用一个小的年轻代来实现这个目标，这将导致非常频繁的minor GC，所以建议使用rolling GC日志文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseGCLogFileRotation   </span><br><span class="line">-XX:NumberOfGCLogFiles&#x3D;5 </span><br><span class="line">-XX:GCLogFileSize&#x3D;30m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果写入GC文件会增加代理的延迟，可以考虑将GC日志文件重定向到内存文件系统：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xloggc:&#x2F;dev&#x2F;shm&#x2F;mq_gc_%p.log123   </span><br></pre></td></tr></table></figure>

<h4 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h4><blockquote>
<p>包括单Master模式、多Master模式、多Master多slave模式。<br>详见<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/master/docs/cn/operation.md">https://github.com/apache/rocketmq/blob/master/docs/cn/operation.md</a></p>
</blockquote>
<h3 id="4-3-demo"><a href="#4-3-demo" class="headerlink" title="4.3 demo"></a>4.3 demo</h3><blockquote>
<p>a. 安装部署参考：<a target="_blank" rel="noopener" href="http://www.imooc.com/article/290089">http://www.imooc.com/article/290089</a> 或 quick start。<br>b. 常用特性有：RocketMQTemplate，@RocketMQTransactionListener，@RocketMQMessageListener<br>c. RocketMQ Console 可视化工具：<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-externals/tree/master/rocketmq-console">https://github.com/apache/rocketmq-externals/tree/master/rocketmq-console</a></p>
</blockquote>
<h3 id="4-4-事务处理"><a href="#4-4-事务处理" class="headerlink" title="4.4 事务处理"></a>4.4 事务处理</h3><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><p>2PC：Three-phase commit，二阶段提交。<br>3PC：多了一个补偿机制。即本地服务挂了无法通知事务状态的时候，对方（mq）会由定时任务来主动询问他的状态，并且有超时机制。</p>
<h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p>原理：等<strong>本地事务</strong>（<strong>一阶段</strong>）完成，再根据<strong>本地事务的状态</strong>(主动通知)决定时候要消费还是丢弃这条消息（<strong>二阶段</strong>）。（以性能损耗为代价）</p>
<p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/jnaOdX.png" alt="jnaOdX"></p>
<h5 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h5><p>Stream-rocketmq 若要发送带事务的消息，需要在yml中配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.stream.bindings.output1.destination</span>=<span class="string">test-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.output1.content-type</span>=<span class="string">application/json</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rocketmq.bindings.output1.producer.group</span>=<span class="string">binder-group</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rocketmq.bindings.output1.producer.sync</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.output2.destination</span>=<span class="string">TransactionTopic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.output2.content-type</span>=<span class="string">application/json</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rocketmq.bindings.output2.producer.transactional</span>=<span class="string">true # 看这里</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rocketmq.bindings.output2.producer.group</span>=<span class="string">myTxProducerGroup</span></span><br></pre></td></tr></table></figure>

<p><strong>示例一</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RocketMQTransactionListener(txProducerGroup = &quot;myTxProducerGroup&quot;, corePoolSize = 5,</span></span><br><span class="line"><span class="meta">        maximumPoolSize = 10)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionListenerImpl</span> <span class="keyword">implements</span> <span class="title">RocketMQLocalTransactionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RocketMQLocalTransactionState <span class="title">executeLocalTransaction</span><span class="params">(Message msg,</span></span></span><br><span class="line"><span class="function"><span class="params">            Object arg)</span> </span>&#123;</span><br><span class="line">        Object num = msg.getHeaders().get(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;1&quot;</span>.equals(num)) &#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                    <span class="string">&quot;executer: &quot;</span> + <span class="keyword">new</span> String((<span class="keyword">byte</span>[]) msg.getPayload()) + <span class="string">&quot; unknown&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> RocketMQLocalTransactionState.UNKNOWN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;2&quot;</span>.equals(num)) &#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                    <span class="string">&quot;executer: &quot;</span> + <span class="keyword">new</span> String((<span class="keyword">byte</span>[]) msg.getPayload()) + <span class="string">&quot; rollback&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">&quot;executer: &quot;</span> + <span class="keyword">new</span> String((<span class="keyword">byte</span>[]) msg.getPayload()) + <span class="string">&quot; commit&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RocketMQLocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;check: &quot;</span> + <span class="keyword">new</span> String((<span class="keyword">byte</span>[]) msg.getPayload()));</span><br><span class="line">        <span class="keyword">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>示例二</strong>：结合事务表</p>
<table>
<thead>
<tr>
<th>id</th>
<th>transaction_id</th>
<th>log</th>
</tr>
</thead>
<tbody><tr>
<td>..</td>
<td>…</td>
<td>….</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RocketMQTransactionListener(txProducerGroup = &quot;tx-add-bonus-group&quot;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor(onConstructor = @__(@Autowired))</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddBonusTransactionListener</span> <span class="keyword">implements</span> <span class="title">RocketMQLocalTransactionListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShareService shareService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RocketmqTransactionLogMapper rocketmqTransactionLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RocketMQLocalTransactionState <span class="title">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> </span>&#123;</span><br><span class="line">        MessageHeaders headers = msg.getHeaders();</span><br><span class="line"></span><br><span class="line">        String transactionId = (String) headers.get(RocketMQHeaders.TRANSACTION_ID);</span><br><span class="line">        Integer shareId = Integer.valueOf((String) headers.get(<span class="string">&quot;share_id&quot;</span>));</span><br><span class="line"></span><br><span class="line">        String dtoString = (String) headers.get(<span class="string">&quot;dto&quot;</span>);</span><br><span class="line">        ShareAuditDTO auditDTO = JSON.parseObject(dtoString, ShareAuditDTO.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.shareService.auditByIdWithRocketMqLog(shareId, auditDTO, transactionId);</span><br><span class="line">            <span class="keyword">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RocketMQLocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        MessageHeaders headers = msg.getHeaders();</span><br><span class="line">        String transactionId = (String) headers.get(RocketMQHeaders.TRANSACTION_ID);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// select * from xxx where transaction_id = xxx</span></span><br><span class="line">        RocketmqTransactionLog transactionLog = <span class="keyword">this</span>.rocketmqTransactionLogMapper.selectOne(</span><br><span class="line">            RocketmqTransactionLog.builder()</span><br><span class="line">                .transactionId(transactionId)</span><br><span class="line">                .build()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (transactionLog != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="5-Spring-Cloud-Stream"><a href="#5-Spring-Cloud-Stream" class="headerlink" title="5. Spring Cloud Stream"></a>5. Spring Cloud Stream</h2><p>Spring Cloud Stream 是一个用于构建基于消息的微服务应用框架。它基于 SpringBoot 来创建具有生产级别的单机 Spring 应用，并且使用 <code>Spring Integration</code> 与 Broker 进行连接。Spring Cloud Stream 提供了消息中间件配置的统一<strong>抽象</strong>，推出了 publish-subscribe、consumer groups、partition 这些统一的概念。**(SCS 相当于消息中间件的 SPI) **</p>
<p><strong>Spring Cloud Stream 内部有两个概念：Binder 和 Binding</strong></p>
<ul>
<li>  <strong>Binder</strong>: 跟外部消息中间件集成的组件，用来创建 Binding，各消息中间件都有自己的 Binder 实现。</li>
</ul>
<p>比如 <code>Kafka</code> 的实现 <code>KafkaMessageChannelBinder</code>，<code>RabbitMQ</code> 的实现 <code>RabbitMessageChannelBinder</code> 以及 <code>RocketMQ</code> 的实现 <code>RocketMQMessageChannelBinder</code>。</p>
<ul>
<li>  <strong>Binding</strong>: 包括 Input Binding(消费者) 和 Output Binding(生产者)。Input/Output 在此作为名词。</li>
</ul>
<p>Binding 在消息中间件与应用程序提供的 Provider 和 Consumer 之间提供了一个桥梁，实现了开发者只需使用应用程序的 Provider 或 Consumer 生产或消费数据即可，屏蔽了开发者与底层消息中间件的接触。</p>
<blockquote>
<p>NOTE（注解以后可能弃用）:<br>我们正在使用函数式编程模型（请参阅 Spring Cloud Function支持](<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-stream/3.0.6.RELEASE/reference/html/spring-cloud-stream.html#spring_cloud_function)%EF%BC%89%E5%B0%86%E5%8D%95%E4%B8%AA%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E5%AE%9A%E4%B9%89%E4%B8%BA%60Consumer%60">https://cloud.spring.io/spring-cloud-static/spring-cloud-stream/3.0.6.RELEASE/reference/html/spring-cloud-stream.html#spring_cloud_function)）将单个消息处理程序定义为`Consumer`</a></p>
</blockquote>
<h3 id="5-1-示例"><a href="#5-1-示例" class="headerlink" title="5.1 示例"></a>5.1 示例</h3><h4 id="快速开始-1"><a href="#快速开始-1" class="headerlink" title="快速开始"></a>快速开始</h4><p>以 RocketMQ 为例，在启动示例进行演示之前，我们先了解一下如何接入 RocketMQ Binder。</p>
<ol>
<li>首先，修改 <code>pom.xml</code> 文件，引入 RocketMQ Stream Starter。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rocketmq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 Input &amp; Output Binding 信息并配合 <code>@EnableBinding</code> 注解使其生效</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableBinding(&#123; Source.class, Sink.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocketMQApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RocketMQApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 Binding 信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置rocketmq的nameserver地址</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rocketmq.binder.name-server</span>=<span class="string">127.0.0.1:9876</span></span><br><span class="line"><span class="comment"># 自定义name为output的binding</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.&lt;output&gt;.destination</span>=<span class="string">test-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.output.content-type</span>=<span class="string">application/json</span></span><br><span class="line"><span class="comment"># 定义name为input的binding</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.&lt;input&gt;.destination</span>=<span class="string">test-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input.content-type</span>=<span class="string">application/json</span></span><br><span class="line"><span class="comment"># input 的 group 不能省略，否则会报错</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input.group</span>=<span class="string">test-group</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面的 input, output 均为 ChannelName (名词)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>示例代码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableBinding(&#123;Source.class, Sink.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocketMQApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RocketMQApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line">        <span class="meta">@StreamListener(&quot;input&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;接受到的消息为：&quot;</span> + msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消费指定tag的消息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line"><span class="comment">//        private MessageChannel output;</span></span><br><span class="line">        <span class="keyword">private</span> Source source;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(&quot;/test/&#123;msg&#125;&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(<span class="meta">@PathVariable</span> String msg)</span> </span>&#123;</span><br><span class="line">            source.output().send(MessageBuilder.withPayload(msg).build());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息已发送&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="消息处理"><a href="#消息处理" class="headerlink" title="消息处理"></a>消息处理</h4><p>使用 name 为 output 对应的 binding 发送消息到 test-topic 这个 topic。</p>
<p>使用 2 个 input binding 订阅数据。</p>
<ul>
<li><p>  input1: 订阅 topic 为 test-topic 的消息，顺序消费所有消息 (顺序消费的前提是所有消息都在一个 MessageQueue 中)</p>
</li>
<li><p>  input2: 订阅 topic 为 test-topic 的消息，异步消费 tags 为 tagStr 的消息，Consumer 端线程池个数为20</p>
</li>
</ul>
<p>配置信息如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.stream.rocketmq.binder.name-server</span>=<span class="string">127.0.0.1:9876</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.output.destination</span>=<span class="string">test-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.output.content-type</span>=<span class="string">application/json</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input1.destination</span>=<span class="string">test-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input1.content-type</span>=<span class="string">text/plain</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input1.group</span>=<span class="string">test-group1</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rocketmq.bindings.input1.consumer.orderly</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input2.destination</span>=<span class="string">test-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input2.content-type</span>=<span class="string">text/plain</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input2.group</span>=<span class="string">test-group2</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rocketmq.bindings.input2.consumer.orderly</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rocketmq.bindings.input2.consumer.tags</span>=<span class="string">tagStr</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.input2.consumer.concurrency</span>=<span class="string">20</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h5><p>使用 MessageChannel 进行消息发送：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerRunner</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output; <span class="comment">// 获取name为output的binding</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; headers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        headers.put(MessageConst.PROPERTY_TAGS, <span class="string">&quot;tagStr&quot;</span>);</span><br><span class="line">        Message message = MessageBuilder.createMessage(msg, <span class="keyword">new</span> MessageHeaders(headers));</span><br><span class="line">        output.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者使用 RocketMQ 原生的 API 进行消息发送:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocketMQProducer</span> </span>&#123;</span><br><span class="line">    DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">&quot;producer_group&quot;</span>);</span><br><span class="line">    producer.setNamesrvAddr(<span class="string">&quot;127.0.0.1:9876&quot;</span>);</span><br><span class="line">    producer.start();</span><br><span class="line"></span><br><span class="line">    Message msg = <span class="keyword">new</span> Message(<span class="string">&quot;test-topic&quot;</span>, <span class="string">&quot;tagStr&quot;</span>, <span class="string">&quot;message from rocketmq producer&quot;</span>.getBytes());</span><br><span class="line">    producer.send(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="消息接收"><a href="#消息接收" class="headerlink" title="消息接收"></a>消息接收</h5><p>使用 <code>@StreamListener</code> 注解接收消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(&quot;input1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveInput1</span><span class="params">(String receiveMsg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;input1 receive: &quot;</span> + receiveMsg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(&quot;input2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveInput2</span><span class="params">(String receiveMsg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;input2 receive: &quot;</span> + receiveMsg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>消息过滤</strong>可参照：<a target="_blank" rel="noopener" href="http://www.imooc.com/article/290424">http://www.imooc.com/article/290424</a></p>
<p>主要包括<code>Tags</code>和<code>@StreamListener</code>的<code>condition</code></p>
<h3 id="5-2-配置说明"><a href="#5-2-配置说明" class="headerlink" title="5.2 配置说明"></a>5.2 配置说明</h3><h4 id="Stream-RocketMQ"><a href="#Stream-RocketMQ" class="headerlink" title="Stream-RocketMQ"></a>Stream-RocketMQ</h4><h5 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h5><p>下面的这些配置是以 <code>springcloud.stream.rocketmq.bindings.&lt;channelName&gt;.consumer.</code> 为前缀的 RocketMQ Consumer 相关的配置。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>enable</td>
<td>是否启用 Consumer。默认值: true</td>
</tr>
<tr>
<td>tags</td>
<td>Consumer 基于 TAGS 订阅，多个 tag 以 `</td>
</tr>
<tr>
<td>sql</td>
<td>Consumer 基于 SQL 订阅。默认值: empty</td>
</tr>
<tr>
<td>broadcasting</td>
<td>Consumer 是否是广播消费模式。如果想让所有的订阅者都能接收到消息，可以使用广播模式。默认值: false</td>
</tr>
<tr>
<td>orderly</td>
<td>Consumer 是否同步消费消息模式。默认值: false</td>
</tr>
<tr>
<td>delayLevelWhenNextConsume</td>
<td>异步消费消息模式下消费失败重试策略。-1, 不重试，直接放入死信队列。0, broker 控制重试策略。默认值: 0</td>
</tr>
<tr>
<td>suspendCurrentQueueTimeMillis</td>
<td>同步消费消息模式下消费失败后再次消费的时间间隔。默认值: 1000</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h5 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h5><p>下面的这些配置是以 <code>spring.cloud.stream.rocketmq.bindings.&lt;channelName&gt;.producer.</code> 为前缀的 RocketMQ Producer 相关的配置。</p>
<p>enable<br>是否启用 Producer。</p>
<p>默认值: true.</p>
<p>group<br>Producer group name。</p>
<p>默认值: empty.</p>
<p>maxMessageSize<br>消息发送的最大字节数。</p>
<p>默认值: 8249344.</p>
<p><strong>transactional</strong><br>是否发送事务消息。</p>
<p>默认值: false.</p>
<p>sync<br>是否使用同步得方式发送消息。</p>
<p>默认值: false.</p>
<p>vipChannelEnabled<br>是否在 Vip Channel 上发送消息。</p>
<p>默认值: true.</p>
<p>sendMessageTimeout<br>发送消息的超时时间(毫秒)。</p>
<p>默认值: 3000.</p>
<p>compressMessageBodyThreshold<br>消息体压缩阀值(当消息体超过 4k 的时候会被压缩)。</p>
<p>默认值: 4096.</p>
<p>retryTimesWhenSendFailed<br>在同步发送消息的模式下，消息发送失败的重试次数。</p>
<p>默认值: 2.</p>
<p>retryTimesWhenSendAsyncFailed<br>在异步发送消息的模式下，消息发送失败的重试次数。</p>
<p>默认值: 2.</p>
<p>retryNextServer<br>消息发送失败的情况下是否重试其它的 broker。</p>
<p>默认值: false.</p>
<h3 id="5-3-Stream-其它特性"><a href="#5-3-Stream-其它特性" class="headerlink" title="5.3 Stream 其它特性"></a>5.3 Stream 其它特性</h3><p><strong>监控</strong>：引入 actuator 依赖即可。</p>
<p><strong>异常处理</strong></p>
<p>参照：<a target="_blank" rel="noopener" href="http://www.imooc.com/article/290435">http://www.imooc.com/article/290435</a></p>
<p>此处展示一种全局处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@StreamListener(value = Processor.INPUT)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String body)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;x&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@StreamListener(&quot;errorChannel&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Message&lt;?&gt; message)</span> </span>&#123;</span><br><span class="line">    ErrorMessage errorMessage = (ErrorMessage) message;</span><br><span class="line">    System.out.println(<span class="string">&quot;Handling ERROR: &quot;</span> + errorMessage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之前做过的项目是，不管异常与否，都会 ACK 消费消息，再在特定方法中处理异常（应当<strong>回滚事务，再记录错误日志</strong>）</p>
<h2 id="6-Gateway"><a href="#6-Gateway" class="headerlink" title="6. Gateway"></a>6. Gateway</h2><blockquote>
<p>微服务使用网关/路由的必要性（相比直接调用具体服务的 API）：登录，<strong>鉴权</strong>，api变动小，<strong>过滤器</strong></p>
</blockquote>
<h3 id="6-1-概念"><a href="#6-1-概念" class="headerlink" title="6.1 概念"></a>6.1 概念</h3><h4 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h4><ul>
<li><strong>Route</strong>: 构建网关的基本单位。由 ID, URI, predicates, filters 组成</li>
<li><strong>Predicate</strong>: JDK8 predicate. 用于匹配 HTTP 请求，如 headers 或者 parameters</li>
<li><strong>Filter</strong>: GatewayFilter, 网关过滤器</li>
</ul>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/zlIrBp.png" alt="zlIrBp" style="zoom:50%;" />

<h3 id="6-2-快速开始"><a href="#6-2-快速开始" class="headerlink" title="6.2 快速开始"></a>6.2 快速开始</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><h5 id="predicates"><a href="#predicates" class="headerlink" title="predicates"></a>predicates</h5><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/TMy4Tb.png" alt="TMy4Tb" style="zoom: 33%;" />

<p><strong>application.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">After=2017-01-20T17:42:47.789-07:00[America/Denver]</span> <span class="comment"># 指定允许访问的时间，包括Before和After。如12306</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">between_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Between=2017-01-20T17:42:47.789-07:00[America/Denver],</span> <span class="number">2017-01-21T17:42:47.789-07:00</span>[<span class="string">America/Denver</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Cookie=mycookie,mycookievalue</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">path_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/red/&#123;segment&#125;,/blue/&#123;segment&#125;</span> <span class="comment"># 匹配路径</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">query_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Query=green</span> <span class="comment"># 匹配请求参数</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">remoteaddr_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RemoteAddr=192.168.1.1/24</span> <span class="comment"># 匹配允许请求主机的 ip 地址</span></span><br></pre></td></tr></table></figure>

<h5 id="filters"><a href="#filters" class="headerlink" title="filters"></a>filters</h5><blockquote>
<p>若需要自定义 filters，参考源码即可。</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_request_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=X-Request-red,</span> <span class="string">blue</span> <span class="comment"># 请求头过滤器</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_request_parameter_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Host:</span> &#123;<span class="string">segment</span>&#125;<span class="string">.myhost.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestParameter=foo,</span> <span class="string">bar-&#123;segment&#125;</span> <span class="comment"># 请求参数过滤器</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_response_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Red,</span> <span class="string">Blue</span></span><br></pre></td></tr></table></figure>


<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">prefixpath_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">PrefixPath=/mypath</span> <span class="comment"># So a request to `/hello` would be sent to `/mypath/hello`.</span></span><br></pre></td></tr></table></figure>

<h5 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h5><p>实现 GlobalFilter，Order接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">customFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CustomGlobalFilter();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomGlobalFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;custom global filter&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="CORS-配置"><a href="#CORS-配置" class="headerlink" title="CORS 配置"></a>CORS 配置</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">cors-configurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="string">&quot;https://docs.spring.io&quot;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">GET</span></span><br></pre></td></tr></table></figure>

<h5 id="实现负载均衡"><a href="#实现负载均衡" class="headerlink" title="实现负载均衡"></a>实现负载均衡</h5><p>在服务 Application 上加上<code>@RibbonClient</code>注解即可，spring cloud gateway 默认开启 LB：</p>
<p><img src="/96b4faf2-950f-45aa-b6b3-ef66a2850dbf.jpg"></p>
<p>配置格式可参照如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 获取服务中心的其它服务，改成false也不会影响下面的 routes 配置^ ^</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">useless</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://service-provider</span></span><br><span class="line">        <span class="attr">predicates  :</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/echo/&#123;segment&#125;</span> <span class="comment"># 访问 path 会自动在前面拼上 &#123;serviceName&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是另一种不实用的 Ribbon 官方 demo：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">service-provider:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">listOfServers:</span> <span class="string">localhost:8070,</span> <span class="string">localhost:8071</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure>

<h5 id="网关限流"><a href="#网关限流" class="headerlink" title="网关限流"></a>网关限流</h5><p>代码实现参照：官网或<a target="_blank" rel="noopener" href="http://www.imooc.com/article/290828">http://www.imooc.com/article/290828</a></p>
<p>这里说明一下限流算法：</p>
<blockquote>
<p>漏桶算法：</p>
</blockquote>
<blockquote>
<p>想象有一个水桶，水桶以一定的速度出水（以一定速率消费请求），当水流速度过大水会溢出（访问速率超过响应速率，就直接拒绝）。</p>
</blockquote>
<blockquote>
<p>漏桶算法的两个变量：</p>
</blockquote>
<blockquote>
<p>水桶漏洞的大小：rate<br>最多可以存多少的水：burst<br>令牌桶算法：</p>
</blockquote>
<blockquote>
<p>系统按照恒定间隔向水桶里加入令牌（Token），如果桶满了的话，就不加了。每个请求来的时候，会拿走1个令牌，如果没有令牌可拿，那么就拒绝服务。</p>
</blockquote>
<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 获取服务中心的其它服务，即可通过服务名称直接调用 API</span></span><br></pre></td></tr></table></figure>


<h2 id="7-微服务的认证和授权"><a href="#7-微服务的认证和授权" class="headerlink" title="7 微服务的认证和授权"></a>7 微服务的认证和授权</h2><h3 id="7-1-认证几种常用方案"><a href="#7-1-认证几种常用方案" class="headerlink" title="7.1 认证几种常用方案"></a>7.1 认证几种常用方案</h3><blockquote>
<p>大致分为两类：有状态（将 session 维护在服务端）、无状态（服务端不保存 session 等信息，仅对 jwt 做校验而已）</p>
<p>有状态的缺点：需要单个 redis 服务，和微服务理念违背，当 redis 挂了后，所有服务的 session 将全部失效。</p>
</blockquote>
<p><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/EwGO0G.png" alt="EwGO0G"></p>
<p>我们现在的系统（无状态）：</p>
<img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/zXKlvC.png" alt="zXKlvC" style="zoom:50%;" />

<h3 id="7-2-授权"><a href="#7-2-授权" class="headerlink" title="7.2 授权"></a>7.2 授权</h3><p><strong>访问控制模型</strong></p>
<img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/47oci7.png" alt="47oci7" style="zoom:25%;" />

<p><strong>JWT</strong></p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/auth0/java-jwt">https://github.com/auth0/java-jwt</a></p>
<p>JWT (Java Web <strong>Token</strong>) = Base64(Header).Base64(Payoad).Base64(Signature)</p>
<p><strong>快速开始</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成和校验 JWT 的工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jacky</span></span><br><span class="line"><span class="comment"> * Date: 2019/9/26 17:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应使用配置维护</span></span><br><span class="line">    <span class="keyword">private</span> String SECRET = <span class="string">&quot;love&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Algorithm algorithm = Algorithm.HMAC256(SECRET);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Value 下的变量不能用 static 修饰符，否则不生效。并且所在类需要被spring容器加载，即需要@Component注解</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.expireTime:60&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Long expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generateJWT</span><span class="params">(Map&lt;String, String&gt; claims)</span> </span>&#123;</span><br><span class="line">        JWTCreator.Builder builder = JWT.create();</span><br><span class="line">        claims.forEach(builder::withClaim);</span><br><span class="line">        <span class="keyword">return</span> builder</span><br><span class="line">                .withExpiresAt(<span class="keyword">new</span> Date(System.currentTimeMillis() + expireTime * <span class="number">1000</span>))</span><br><span class="line">                .sign(algorithm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要处理异常情况+判断是否过期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">verifyToken</span><span class="params">(String jwt)</span> </span>&#123;</span><br><span class="line">        DecodedJWT decodedJWT = JWT.require(algorithm).build().verify(jwt);</span><br><span class="line">        log.info(<span class="string">&quot;decodedJWT is : &#123;&#125;&quot;</span>, decodedJWT);</span><br><span class="line">        Map&lt;String, Claim&gt; claims = decodedJWT.getClaims();</span><br><span class="line">        Map&lt;String, String&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        claims.forEach((k, v) -&gt; res.put(k, v.asString()));</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        claims.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jacky&quot;</span>);</span><br><span class="line">        String jwt = generateJWT(claims);</span><br><span class="line">        log.info(jwt);</span><br><span class="line">        verifyToken(jwt).forEach((k, v) -&gt; System.out.println(<span class="string">&quot;key: &quot;</span> + k + <span class="string">&quot; value: &quot;</span> + v));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-3-认证代码实现"><a href="#7-3-认证代码实现" class="headerlink" title="7.3 认证代码实现"></a>7.3 认证代码实现</h3><blockquote>
<p>主要有 3 种实现</p>
</blockquote>
<ul>
<li>Servlet 过滤器</li>
<li><strong>拦截器</strong>（继承 HandlerInterceptorAdapter）</li>
<li>Spring AOP（每个接口都需要加上自定义注解）</li>
</ul>
<h4 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h4><h4 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对未登录的用户进行拦截</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jacky</span></span><br><span class="line"><span class="comment"> * Date: 2019/9/26 18:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) &#123; <span class="comment">// 如果不是映射到方法则直接通过</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        HandlerMethod handlerMethod = (HandlerMethod) handler;</span><br><span class="line">        String jwt = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(jwt)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;jwt为空！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Map&lt;String, String&gt; res = JWTHelper.verifyToken(jwt);</span><br><span class="line">            String username = res.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(username)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;jwt不正确！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 假装验证通过</span></span><br><span class="line">            User user = <span class="keyword">new</span> User();</span><br><span class="line">            user.setUsername(username);</span><br><span class="line">            UserContext.setUser(user);</span><br><span class="line">            response.setHeader(<span class="string">&quot;Authorization&quot;</span>, jwt);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String jwt = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Authorization&quot;</span>, jwt);</span><br><span class="line">        UserContext.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h4><p><strong>概述</strong><br><img src="/5452cd49-5ee5-40f8-8b2f-709e6a8f6fe3.jpg"></p>
<p><strong>执行顺序</strong></p>
<p>around &gt; before &gt; around &gt; after &gt; afterReturning</p>
<p><img src="/6a988529-dcc1-45f9-b623-041a48cbcd50.png"></p>
<p><strong>代码示例</strong></p>
<blockquote>
<p>需引入 spring-boot-starter-aop 依赖</p>
</blockquote>
<p>例一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOPProcess</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @checkLogin 只能作用再方法(aop)上。</span></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(CheckLogin)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ccccheck login！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例二：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor(onConstructor = @__(@Autowired))</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthAspect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtOperator jwtOperator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(com.itmuch.usercenter.auth.CheckLogin)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">checkLogin</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        checkToken();</span><br><span class="line">        <span class="keyword">return</span> point.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 从header里面获取token</span></span><br><span class="line">            HttpServletRequest request = getHttpServletRequest();</span><br><span class="line"></span><br><span class="line">            String token = request.getHeader(<span class="string">&quot;X-Token&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 校验token是否合法&amp;是否过期；如果不合法或已过期直接抛异常；如果合法放行</span></span><br><span class="line">            Boolean isValid = jwtOperator.validateToken(token);</span><br><span class="line">            <span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">&quot;Token不合法！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 如果校验成功，那么就将用户的信息设置到request的attribute里面</span></span><br><span class="line">            Claims claims = jwtOperator.getClaimsFromToken(token);</span><br><span class="line">            request.setAttribute(<span class="string">&quot;id&quot;</span>, claims.get(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">            request.setAttribute(<span class="string">&quot;wxNickname&quot;</span>, claims.get(<span class="string">&quot;wxNickname&quot;</span>));</span><br><span class="line">            request.setAttribute(<span class="string">&quot;role&quot;</span>, claims.get(<span class="string">&quot;role&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">&quot;Token不合法&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> HttpServletRequest <span class="title">getHttpServletRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">        ServletRequestAttributes attributes = (ServletRequestAttributes) requestAttributes;</span><br><span class="line">        <span class="keyword">return</span> attributes.getRequest();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(com.itmuch.usercenter.auth.CheckAuthorization)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">checkAuthorization</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 验证token是否合法；</span></span><br><span class="line">            <span class="keyword">this</span>.checkToken();</span><br><span class="line">            <span class="comment">// 2. 验证用户角色是否匹配</span></span><br><span class="line">            HttpServletRequest request = getHttpServletRequest();</span><br><span class="line">            String role = (String) request.getAttribute(<span class="string">&quot;role&quot;</span>);</span><br><span class="line"></span><br><span class="line">            MethodSignature signature = (MethodSignature) point.getSignature();</span><br><span class="line">            Method method = signature.getMethod();</span><br><span class="line">            CheckAuthorization annotation = method.getAnnotation(CheckAuthorization.class);</span><br><span class="line"></span><br><span class="line">            String value = annotation.value();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!Objects.equals(role, value)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">&quot;用户无权访问！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">&quot;用户无权访问！&quot;</span>, throwable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> point.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-4-其它要点"><a href="#7-4-其它要点" class="headerlink" title="7.4 其它要点"></a>7.4 其它要点</h3><h4 id="Feign-实现-token-传递"><a href="#Feign-实现-token-传递" class="headerlink" title="Feign 实现 token 传递"></a>Feign 实现 token 传递</h4><ol>
<li>使用<code>@RequestHeader</code>注解，接收token参数。</li>
<li>使用Feign的拦截器 <code>RequestInterceptor</code>(常用)</li>
</ol>
<p>对于第 2 种方法的实现，重点是能够获取 <strong>request</strong> 中的header（在Spring HandlerInterceptor中，就已经提供了该request参数），即 <code>RequestContextHolder</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;service-provider&quot;,configuration = DiscoveryFeign.FeignInterceptor.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DiscoveryFeign</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/echo/&#123;string&#125;&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">echo</span><span class="params">(<span class="meta">@PathVariable(&quot;string&quot;)</span> String string)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 也可改写成:</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Bean</span></span></span><br><span class="line"><span class="comment">     * public xxxIntercetor xxx() &#123;</span></span><br><span class="line"><span class="comment">     *     return new xxxIntercetor();</span></span><br><span class="line"><span class="comment">     * &#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FeignInterceptor</span> <span class="keyword">implements</span> <span class="title">RequestInterceptor</span>, <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate requestTemplate)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;经过feign拦截器了&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 获取 request (通过 RequestContextHolder)</span></span><br><span class="line">            ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">            HttpServletRequest request = attributes.getRequest();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. (feign)传递 token</span></span><br><span class="line">            requestTemplate.header(<span class="string">&quot;Authorization&quot;</span>, request.getHeader(<span class="string">&quot;Authorization&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在DiscoveryApplication打印token：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> WebInterceptor()).addPathPatterns(<span class="string">&quot;/**&quot;</span>).excludePathPatterns(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String token  = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        System.out.println(token);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-分布式跟踪"><a href="#8-分布式跟踪" class="headerlink" title="8 分布式跟踪"></a>8 分布式跟踪</h2><blockquote>
<p>Spring Cloud Sleuth provides Spring Boot auto-configuration for distributed tracing.<br>官方文档：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-sleuth">https://spring.io/projects/spring-cloud-sleuth</a><br>项目地址：<a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-sleuth">https://github.com/spring-cloud/spring-cloud-sleuth</a></p>
</blockquote>
<blockquote>
<p>Zipkin是一个分布式跟踪系统。它有助于收集解决服务体系结构中的延迟问题所需的时序数据。功能包括该数据的收集和查找。<br>官网：<a target="_blank" rel="noopener" href="https://zipkin.io/">https://zipkin.io/</a><br>项目地址：<a target="_blank" rel="noopener" href="https://github.com/openzipkin/zipkin">https://github.com/openzipkin/zipkin</a></p>
</blockquote>
<h3 id="8-1-介绍"><a href="#8-1-介绍" class="headerlink" title="8.1 介绍"></a>8.1 介绍</h3><p><img src="/5aa03bed-6464-4813-8f07-b51d811117c6.jpg"></p>
<p><img src="/7640cc08-2323-4191-be89-fc7b4004f606.jpg"></p>
<h3 id="8-2-快速开始"><a href="#8-2-快速开始" class="headerlink" title="8.2 快速开始"></a>8.2 快速开始</h3><p><strong>运行 ZipKin-server</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9411:9411 openzipkin&#x2F;zipkin</span><br></pre></td></tr></table></figure>

<p><strong>在项目中添加依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>配置 zipkin-server 地址</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="comment"># look at here</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">    <span class="attr">discovery-client-enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><img src="/a3d95e29-8aca-4125-95d5-94a8dd50f8f0.png"></p>
<h3 id="8-3-ZipKin-数据持久化"><a href="#8-3-ZipKin-数据持久化" class="headerlink" title="8.3 ZipKin 数据持久化"></a>8.3 ZipKin 数据持久化</h3><p>建议使用 ES + spark job。参考：<a target="_blank" rel="noopener" href="https://github.com/openzipkin/zipkin-dependencies">https://github.com/openzipkin/zipkin-dependencies</a></p>
<p><img src="/e7a62b65-c9b4-4180-aa1b-781fdfafa0a0.jpg"></p>
<p><img src="/3cf52e78-dbb6-4bf8-b353-d621c4401696.png"></p>
<p>zipkin支持以下环境变量（<a target="_blank" rel="noopener" href="https://github.com/openzipkin/zipkin/tree/master/zipkin-server">https://github.com/openzipkin/zipkin/tree/master/zipkin-server</a>）：</p>
<p><img src="/144aae9e-73ed-4412-a10a-acd6cbf60069.jpg"></p>
<p>故在启动时增加es的环境变量即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e &quot;STORAGE_TYPE&#x3D;elasticsearch&quot; -e &quot;ES_HOSTS&#x3D;172.17.0.1:9200&quot; -d -p 9411:9411 openzipkin&#x2F;zipkin</span><br></pre></td></tr></table></figure>

<p><img src="/69e2087f-8786-4c13-9fa3-336f9ecb593d.png"></p>
<p><strong>注意：</strong> <code>ES_HOSTS</code> 参数不能直接使用 <code>localhost</code> 与其他容器通信，要使用 docker 网络通信，在容器启动时指定<code>--net</code>，也可以用<code>--link</code> [容器名称]：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker network create somenetwork</span><br><span class="line">docker run -d --name kibana --net somenetwork -p 5601:5601 kibana:tag</span><br></pre></td></tr></table></figure>

<p>OR use the java command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STORAGE_TYPE&#x3D;elasticsearch ES_HOSTS&#x3D;localhost:9200 java -jar zipkin.jar</span><br></pre></td></tr></table></figure>

<p>spark job 为 zipkin-denpendencies 子项目，使用方法同上。</p>
<p><img src="/419cc375-240e-430e-af69-89542a75dfbf.jpg"></p>
<h3 id="8-4-zipkin-dependencies"><a href="#8-4-zipkin-dependencies" class="headerlink" title="8.4 zipkin-dependencies"></a>8.4 zipkin-dependencies</h3><p>docker 地址：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/openzipkin/zipkin-dependencies">https://hub.docker.com/r/openzipkin/zipkin-dependencies</a></p>
<h2 id="9-代码质量"><a href="#9-代码质量" class="headerlink" title="9 代码质量"></a>9 代码质量</h2><h3 id="9-1-工具"><a href="#9-1-工具" class="headerlink" title="9.1 工具"></a>9.1 工具</h3><blockquote>
<p>本章节仅演示sonarQube的用法。<br>官方文档：<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/setup/install-server/">https://docs.sonarqube.org/latest/setup/install-server/</a></p>
</blockquote>
<p><img src="/2caee130-8706-4474-928f-1ff975a00f1f.png"></p>
<h4 id="SonarQube-快速开始"><a href="#SonarQube-快速开始" class="headerlink" title="SonarQube 快速开始"></a>SonarQube 快速开始</h4><p><a target="_blank" rel="noopener" href="https://hub.docker.com/_/sonarqube">https://hub.docker.com/_/sonarqube</a></p>
<p><strong>安装指南</strong><a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/setup/install-server/">https://docs.sonarqube.org/latest/setup/install-server/</a></p>
<p><strong>测试用</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name sonarqube -p 9000:9000 sonarqube:community</span><br></pre></td></tr></table></figure>

<p>另外需注意，sonarQube 不支持 mysql</p>
<p><strong>分析代码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mvn sonar:sonar \</span><br><span class="line">  -Dsonar.projectKey&#x3D;SC-alibaba \</span><br><span class="line">  -Dsonar.host.url&#x3D;http:&#x2F;&#x2F;localhost:9000 \</span><br><span class="line">  -Dsonar.login&#x3D;42c0f2e5fb71cac3ce38392935f47955c8851e75 \</span><br><span class="line">  -Dsonar.java.binaries&#x3D;target&#x2F;sonar</span><br></pre></td></tr></table></figure>

<p><img src="/afe3cc58-fe70-46f1-a335-ec90bdee89b6.png"><br><img src="/a0265e5a-4796-444d-9805-4656dbddc889.png"></p>
<p><strong>结合 Jenkins</strong><br><a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/</a></p>
<h2 id="10-监控工具"><a href="#10-监控工具" class="headerlink" title="10 监控工具"></a>10 监控工具</h2><h3 id="10-1-SBA-快速开始"><a href="#10-1-SBA-快速开始" class="headerlink" title="10.1 SBA 快速开始"></a>10.1 SBA 快速开始</h3><blockquote>
<p>包括监控 JVM 等指标。</p>
</blockquote>
<p>参照：<a target="_blank" rel="noopener" href="https://codecentric.github.io/spring-boot-admin/2.2.3/#getting-started">https://codecentric.github.io/spring-boot-admin/2.2.3/#getting-started</a></p>
<h3 id="10-2-JVM-监控"><a href="#10-2-JVM-监控" class="headerlink" title="10.2 JVM 监控"></a>10.2 JVM 监控</h3><blockquote>
<p>除了 Jvisualvm 外，也可以用 SBA</p>
</blockquote>
<h4 id="GC日志-线程Dump日志-堆Dump可视化分析"><a href="#GC日志-线程Dump日志-堆Dump可视化分析" class="headerlink" title="GC日志/线程Dump日志/堆Dump可视化分析"></a>GC日志/线程Dump日志/堆Dump可视化分析</h4><p>增加启动参数 VM options: <code>-XX:+PrintGCDetails -Xloggc:gc.log</code></p>
<ul>
<li>GCEasy(直接上传GC日志即可)、GCPlot</li>
<li>FastThread</li>
<li>HeapHero</li>
</ul>
<h3 id="10-3-日志监控"><a href="#10-3-日志监控" class="headerlink" title="10.3 日志监控"></a>10.3 日志监控</h3><ul>
<li>ELK<br><img src="/48415471-9179-4f75-8182-b5e9d3cbec94.jpg"></li>
</ul>
<h2 id="11-Seata"><a href="#11-Seata" class="headerlink" title="11. Seata"></a>11. <a target="_blank" rel="noopener" href="http://seata.io/zh-cn/docs/overview/what-is-seata.html">Seata</a></h2><blockquote>
<p>Attention:<br>192.168.1.1是内网地址，是网卡的实际地址；可以是本机也可以是其他机器<br>127.0.0.1是loopback地址，是专门用于本机网络应用的实现，不依赖于实际的网卡(容器不能使用)。</p>
</blockquote>
<h3 id="11-1-概述"><a href="#11-1-概述" class="headerlink" title="11.1 概述"></a>11.1 概述</h3><blockquote>
<p>Pre description:<br>分布式事务场景：后面出现异常，前面成功的远程服务（feign，RestTemplate，消息队列）无法回滚。因为它们的本地事务已经结束了。</p>
</blockquote>
<img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/TOSfdm.png" alt="TOSfdm" style="zoom: 50%;" />

<p>两阶段提交协议。本地事务提交的结果上报给 TC。TCC模式， TCC 模式要求的三个接口？</p>
<p>Seata 由 3 部分组成：</p>
<ul>
<li><p>TC (Transaction Coordinator) - 事务协调者<br>维护全局和分支事务的状态，驱动全局事务提交或回滚。</p>
</li>
<li><p>TM (Transaction Manager) - 事务管理器<br>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p>
</li>
<li><p>RM (Resource Manager) - 资源管理器<br>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
</li>
</ul>
<h4 id="快速开始-2"><a href="#快速开始-2" class="headerlink" title="快速开始"></a>快速开始</h4><p><strong>部署 seata-server</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name seata-server -p 8091:8091 seataio&#x2F;seata-server:latest</span><br></pre></td></tr></table></figure>
<p>或者用 docker-compose 自定义配置启动</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">seata-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">seataio/seata-server</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">seata-server</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8091:8091&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SEATA_PORT=8091</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">STORE_MODE=file</span></span><br></pre></td></tr></table></figure>

<p><strong>引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意：如果不是 springcloud，则需要手动实现 xid（类似一串分布式事务的token） 跨服务传递。</p>
<p><strong>YML 配置</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.cloud.alibaba.seata.tx-service-group=business-service</span> <span class="comment"># 事务组(必须)</span></span><br><span class="line"><span class="string">seata.service.vgroup-mapping.business-service=default</span> <span class="comment"># 事务组所在的 TC 集群名称(必须)</span></span><br><span class="line"><span class="string">seata.service.grouplist.default=127.0.0.1:8091</span> <span class="comment"># 仅注册中心为 file 时使用 (seata.registry.type = file)</span></span><br><span class="line"><span class="string">seata.service.disable-global-transaction=false</span> <span class="comment"># 默认就是 false</span></span><br><span class="line"><span class="comment">## if use registry center</span></span><br><span class="line"><span class="comment">#seata.registry.type=nacos</span></span><br><span class="line"><span class="comment">#seata.registry.nacos.cluster=default</span></span><br><span class="line"><span class="comment">#seata.registry.nacos.server-addr=localhost</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## if use config center</span></span><br><span class="line"><span class="comment">#seata.config.type=apollo</span></span><br><span class="line"><span class="comment">#seata.config.apollo.apollo-meta=http://192.168.1.204:8801</span></span><br><span class="line"><span class="comment">#seata.config.apollo.app-id=seata-server</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>创建 undo_log 表</strong> 是所有数据库都要创建吗？<br>@EnableDiscoveryClient(autoRegister = false)？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log</span><br><span class="line">CREATE TABLE &#96;undo_log&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;branch_id&#96; bigint(20) NOT NULL,</span><br><span class="line">  &#96;xid&#96; varchar(100) NOT NULL,</span><br><span class="line">  &#96;context&#96; varchar(128) NOT NULL,</span><br><span class="line">  &#96;rollback_info&#96; longblob NOT NULL,</span><br><span class="line">  &#96;log_status&#96; int(11) NOT NULL,</span><br><span class="line">  &#96;log_created&#96; datetime NOT NULL,</span><br><span class="line">  &#96;log_modified&#96; datetime NOT NULL,</span><br><span class="line">  &#96;ext&#96; varchar(100) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;ux_undo_log&#96; (&#96;xid&#96;,&#96;branch_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;1 DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>到此完成，使用<code>@GlobalTransactional(timeoutMills = 300000, name = &quot;spring-cloud-demo-tx&quot;)</code>即可开启分布式事务。</p>
<h4 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h4><img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/IeYm0s.png" alt="IeYm0s" style="zoom:50%;" />

<img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/OGhLf3.png" alt="OGhLf3" style="zoom:67%;" />

<h3 id="11-2-高可用部署"><a href="#11-2-高可用部署" class="headerlink" title="11.2 高可用部署"></a>11.2 高可用部署</h3><blockquote>
<p>Seata 的高可用依赖于注册中心、配置中心和数据库来实现</p>
</blockquote>
<ul>
<li>store.mode 不使用默认的 file。建议使用高可用HA db/redis 存放事务数据。</li>
</ul>
<p>Description:</p>
<p>file模式为单机模式，全局事务会话信息内存中读写并持久化本地文件root.data，性能较高;</p>
<p>若使用db，则需要建3张表。全局事务会话信息由3块内容构成，全局事务–&gt;分支事务–&gt;全局锁，对应表global_table、branch_table、lock_table ，对应脚本 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/develop/script/server/db">https://github.com/seata/seata/tree/develop/script/server/db</a></p>
<p><strong>快速开始</strong></p>
<blockquote>
<p>使用注册中心 + db/redis</p>
</blockquote>
<p>a. 修改<code>registry.conf</code>的注册中心配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  type &#x3D; &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    application &#x3D; &quot;seata-server&quot;</span><br><span class="line">    serverAddr &#x3D; &quot;192.168.199.2&quot; # 容器内用hostname或者xxx（应该不能用localhost），在nacos启动日志看ip。</span><br><span class="line">    namespace &#x3D; &quot;&quot;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">    username &#x3D; &quot;nacos&quot;</span><br><span class="line">    password &#x3D; &quot;nacos&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line">  type &#x3D; &quot;nacos&quot;</span><br><span class="line">  </span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;192.168.199.2&quot;</span><br><span class="line">    namespace &#x3D; &quot;&quot;</span><br><span class="line">    group &#x3D; &quot;SEATA_GROUP&quot;</span><br><span class="line">    username &#x3D; &quot;&quot;</span><br><span class="line">    password &#x3D; &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Location：</p>
<img src="https://gitee.com/jacky_cloud/oss/raw/master/uPic/suFfDe.png" alt="suFfDe" style="zoom:50%;" />

<p>b. 需要修改配置中心的以下几个配置(含db与redis,二者选其一 注:redis需seata-server 1.3版本及以上)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">service.vgroupMapping.my_test_tx_group&#x3D;default</span><br><span class="line">store.mode&#x3D;db|redis</span><br><span class="line">-----db-----</span><br><span class="line">store.db.datasource&#x3D;druid</span><br><span class="line">store.db.dbType&#x3D;mysql</span><br><span class="line">store.db.driverClassName&#x3D;com.mysql.jdbc.Driver</span><br><span class="line">store.db.url&#x3D;jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;seata?useUnicode&#x3D;true</span><br><span class="line">store.db.user&#x3D;root</span><br><span class="line">store.db.password&#x3D;123456</span><br><span class="line">----redis----</span><br><span class="line">store.redis.host&#x3D;127.0.0.1</span><br><span class="line">store.redis.port&#x3D;6379</span><br><span class="line">store.redis.maxConn&#x3D;10</span><br><span class="line">store.redis.minConn&#x3D;1</span><br><span class="line">store.redis.database&#x3D;0</span><br><span class="line">store.redis.password&#x3D;null</span><br><span class="line">store.redis.queryLimit&#x3D;100</span><br></pre></td></tr></table></figure>

<p>c. docker 启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --name seata-server \</span><br><span class="line">        -p 8091:8091 \</span><br><span class="line">        -e SEATA_CONFIG_NAME&#x3D;file:&#x2F;root&#x2F;seata-config&#x2F;registry \</span><br><span class="line">        -v &#x2F;User&#x2F;seata&#x2F;config:&#x2F;root&#x2F;seata-config  \</span><br><span class="line">        seataio&#x2F;seata-server</span><br></pre></td></tr></table></figure>

<h3 id="11-3-集成-nacos"><a href="#11-3-集成-nacos" class="headerlink" title="11.3 集成 nacos"></a>11.3 集成 nacos</h3><h4 id="seata-server-服务端配置"><a href="#seata-server-服务端配置" class="headerlink" title="seata-server 服务端配置"></a>seata-server 服务端配置</h4><blockquote>
<p>获取配置文件和 nacos-config.sh 初始化脚本文件：<br><a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/develop/script/config-center">https://github.com/seata/seata/tree/develop/script/config-center</a></p>
</blockquote>
<p><strong>修改 conf/registry.conf 配置</strong></p>
<p>注意：nacos的serverAddr不能有 http:// 前缀</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line">  type &#x3D; &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;192.168.21.89&quot;</span><br><span class="line">    namespace &#x3D; &quot;&quot;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">config &#123;</span><br><span class="line">  # file、nacos 、apollo、zk、consul、etcd3</span><br><span class="line">  type &#x3D; &quot;nacos&quot;</span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;192.168.21.89&quot;</span><br><span class="line">    namespace &#x3D; &quot;&quot;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>修改conf/nacos-config.txt 配置</strong></p>
<p>增加<code>service.vgroup_mapping.$&#123;your-service-gruop&#125;=default</code>(本质上还是应用application.yml处读取)，其中${..}为服务组名称。例如，demo中有两个服务，分别是storage-service和order-service，所以配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">增加&#96;service.vgroup_mapping.$&#123;your-service-gruop&#125;&#x3D;default&#96;，其中$&#123;..&#125;为服务组名称。例如，demo中有两个服务，分别是storage-service和order-service，所以配置如下</span><br></pre></td></tr></table></figure>

<p><strong>初始化 seata 的 nacos 配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh $&#123;SEATAPATH&#125;&#x2F;script&#x2F;config-center&#x2F;nacos&#x2F;nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 5a3c7d6c-f497-4d68-a71a-2e5e3340b3ca -u username -w password</span><br></pre></td></tr></table></figure>

<p><strong>最后，启动seata-server</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name seata-server-complex -p 8091:8091 -e SEATA_CONFIG_NAME&#x3D;file:&#x2F;root&#x2F;seata-config&#x2F;registry -v C:\Users\Administrator\Desktop\seata-config\config:&#x2F;root&#x2F;seata-config seataio&#x2F;seata-server</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Parameter Description:</span><br><span class="line"></span><br><span class="line">-h: host, the default value is localhost.</span><br><span class="line"></span><br><span class="line">-p: port, the default value is 8848.</span><br><span class="line"></span><br><span class="line">-g: Configure grouping, the default value is &#39;SEATA_GROUP&#39;.</span><br><span class="line"></span><br><span class="line">-t: Tenant information, corresponding to the namespace ID field of Nacos, the default value is &#39;&#39;.</span><br><span class="line"></span><br><span class="line">-u: username, nacos 1.2.0+ on permission control, the default value is &#39;&#39;.</span><br><span class="line"></span><br><span class="line">-w: password, nacos 1.2.0+ on permission control, the default value is &#39;&#39;.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="客户端服务配置"><a href="#客户端服务配置" class="headerlink" title="客户端服务配置"></a>客户端服务配置</h4><p>初始化<code>undo_log</code>表；</p>
<ol>
<li> 每个应用的resource里需要配置一个registry.conf ，demo中与seata-server里的配置相同(也可以在application.yml配置)</li>
<li> application.yml 的各个配置项，注意spring.cloud.alibaba.seata.tx-service-group 是服务组名称，与nacos-config.txt 配置的service.vgroup_mapping.${your-service-gruop}具有对应关系</li>
</ol>
<blockquote>
<p>Other (for Tests):<br>import static org.assertj.core.api.Assertions.assertThat;</p>
</blockquote>
</div><div class="article-licensing box"><div class="licensing-title"><p>spring cloud alibaba</p><p><a href="https://teamwang.cn/2021/03/07/spring-cloud-alibaba/">https://teamwang.cn/2021/03/07/spring-cloud-alibaba/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Jacky</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-03-07</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-11-10</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/03/14/ShardingSphere/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ShardingSphere</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/03/07/MacApp%E6%8E%A8%E8%8D%90/"><span class="level-item">MacApp推荐</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "D7nrmJ3xSHla6mxR3p0BrXqD-gzGzoHsz",
            appKey: "rGXO6glIn8ETvzytN7maFaoP",
            placeholder: "Leave your comments~",
            
            
            meta: ["nick"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            enableQQ: true,
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item"> </span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#0-前言"><span class="level-left"><span class="level-item">0. 前言</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#0-1-版本说明"><span class="level-left"><span class="level-item">0.1 版本说明</span></span></a></li><li><a class="level is-mobile" href="#0-2-对比旧-SC"><span class="level-left"><span class="level-item">0.2 对比旧 SC</span></span></a></li></ul></li><li><a class="level is-mobile" href="#1-Nacos"><span class="level-left"><span class="level-item">1. Nacos</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-配置"><span class="level-left"><span class="level-item">1.1 配置</span></span></a></li><li><a class="level is-mobile" href="#1-2-自定义-Ribbon-负载均衡算法"><span class="level-left"><span class="level-item">1.2 自定义 Ribbon 负载均衡算法</span></span></a></li><li><a class="level is-mobile" href="#1-3-作为配置中心"><span class="level-left"><span class="level-item">1.3 作为配置中心</span></span></a></li><li><a class="level is-mobile" href="#1-4-生产环境部署"><span class="level-left"><span class="level-item">1.4 生产环境部署</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-Feign-应用"><span class="level-left"><span class="level-item">2. Feign 应用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-日志打印"><span class="level-left"><span class="level-item">2.1 日志打印</span></span></a></li><li><a class="level is-mobile" href="#2-2-实现拦截器"><span class="level-left"><span class="level-item">2.2 实现拦截器</span></span></a></li><li><a class="level is-mobile" href="#2-3-Feign-的文讲传输"><span class="level-left"><span class="level-item">2.3 Feign 的文讲传输</span></span></a></li><li><a class="level is-mobile" href="#2-4-性能优化"><span class="level-left"><span class="level-item">2.4 性能优化</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-Sentinel"><span class="level-left"><span class="level-item">3. Sentinel</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-基础概念"><span class="level-left"><span class="level-item">3.1 基础概念</span></span></a></li><li><a class="level is-mobile" href="#3-2-快速开始"><span class="level-left"><span class="level-item">3.2 快速开始</span></span></a></li><li><a class="level is-mobile" href="#3-3-Sentinel-配置"><span class="level-left"><span class="level-item">3.3 Sentinel 配置</span></span></a></li><li><a class="level is-mobile" href="#3-4-对-Sentinel-中的异常处理"><span class="level-left"><span class="level-item">3.4 对 Sentinel 中的异常处理</span></span></a></li><li><a class="level is-mobile" href="#3-5-网关限流"><span class="level-left"><span class="level-item">3.5 网关限流</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-RocketMQ-快速开始"><span class="level-left"><span class="level-item">4. RocketMQ 快速开始</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-基本概念"><span class="level-left"><span class="level-item">4.1 基本概念</span></span></a></li><li><a class="level is-mobile" href="#4-2-最佳实践"><span class="level-left"><span class="level-item">4.2 最佳实践</span></span></a></li><li><a class="level is-mobile" href="#4-3-demo"><span class="level-left"><span class="level-item">4.3 demo</span></span></a></li><li><a class="level is-mobile" href="#4-4-事务处理"><span class="level-left"><span class="level-item">4.4 事务处理</span></span></a></li></ul></li><li><a class="level is-mobile" href="#5-Spring-Cloud-Stream"><span class="level-left"><span class="level-item">5. Spring Cloud Stream</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-1-示例"><span class="level-left"><span class="level-item">5.1 示例</span></span></a></li><li><a class="level is-mobile" href="#5-2-配置说明"><span class="level-left"><span class="level-item">5.2 配置说明</span></span></a></li><li><a class="level is-mobile" href="#5-3-Stream-其它特性"><span class="level-left"><span class="level-item">5.3 Stream 其它特性</span></span></a></li></ul></li><li><a class="level is-mobile" href="#6-Gateway"><span class="level-left"><span class="level-item">6. Gateway</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-概念"><span class="level-left"><span class="level-item">6.1 概念</span></span></a></li><li><a class="level is-mobile" href="#6-2-快速开始"><span class="level-left"><span class="level-item">6.2 快速开始</span></span></a></li></ul></li><li><a class="level is-mobile" href="#7-微服务的认证和授权"><span class="level-left"><span class="level-item">7 微服务的认证和授权</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#7-1-认证几种常用方案"><span class="level-left"><span class="level-item">7.1 认证几种常用方案</span></span></a></li><li><a class="level is-mobile" href="#7-2-授权"><span class="level-left"><span class="level-item">7.2 授权</span></span></a></li><li><a class="level is-mobile" href="#7-3-认证代码实现"><span class="level-left"><span class="level-item">7.3 认证代码实现</span></span></a></li><li><a class="level is-mobile" href="#7-4-其它要点"><span class="level-left"><span class="level-item">7.4 其它要点</span></span></a></li></ul></li><li><a class="level is-mobile" href="#8-分布式跟踪"><span class="level-left"><span class="level-item">8 分布式跟踪</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#8-1-介绍"><span class="level-left"><span class="level-item">8.1 介绍</span></span></a></li><li><a class="level is-mobile" href="#8-2-快速开始"><span class="level-left"><span class="level-item">8.2 快速开始</span></span></a></li><li><a class="level is-mobile" href="#8-3-ZipKin-数据持久化"><span class="level-left"><span class="level-item">8.3 ZipKin 数据持久化</span></span></a></li><li><a class="level is-mobile" href="#8-4-zipkin-dependencies"><span class="level-left"><span class="level-item">8.4 zipkin-dependencies</span></span></a></li></ul></li><li><a class="level is-mobile" href="#9-代码质量"><span class="level-left"><span class="level-item">9 代码质量</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#9-1-工具"><span class="level-left"><span class="level-item">9.1 工具</span></span></a></li></ul></li><li><a class="level is-mobile" href="#10-监控工具"><span class="level-left"><span class="level-item">10 监控工具</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#10-1-SBA-快速开始"><span class="level-left"><span class="level-item">10.1 SBA 快速开始</span></span></a></li><li><a class="level is-mobile" href="#10-2-JVM-监控"><span class="level-left"><span class="level-item">10.2 JVM 监控</span></span></a></li><li><a class="level is-mobile" href="#10-3-日志监控"><span class="level-left"><span class="level-item">10.3 日志监控</span></span></a></li></ul></li><li><a class="level is-mobile" href="#11-Seata"><span class="level-left"><span class="level-item">11. Seata</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#11-1-概述"><span class="level-left"><span class="level-item">11.1 概述</span></span></a></li><li><a class="level is-mobile" href="#11-2-高可用部署"><span class="level-left"><span class="level-item">11.2 高可用部署</span></span></a></li><li><a class="level is-mobile" href="#11-3-集成-nacos"><span class="level-left"><span class="level-item">11.3 集成 nacos</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Jacky"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Jacky</p><p class="is-size-6 is-block">(ง ˙o˙)ว</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">33</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">1</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cloris-cc"><i class="fab fa-github"></i></a></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><p class="is-size-7"><span>&copy; 2021 Jacky</span>  <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备19098392号</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/"><i class="fab fa-weibo"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/cloris-cc"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>