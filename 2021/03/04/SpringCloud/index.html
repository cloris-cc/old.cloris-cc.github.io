<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Spring Cloud - 茶茶日记 - winklog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="茶茶日记 - winklog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="茶茶日记 - winklog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Spring Cloud 系列笔记…"><meta property="og:type" content="blog"><meta property="og:title" content="Spring Cloud"><meta property="og:url" content="https://teamwang.cn/2021/03/04/SpringCloud/"><meta property="og:site_name" content="茶茶日记 - winklog"><meta property="og:description" content="Spring Cloud 系列笔记…"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://teamwang.cn/b2253bab-1e35-4a54-9e29-0a569a8608a7.png"><meta property="og:image" content="https://teamwang.cn/5b41a208-166f-4ee2-a6d7-e38ae3b12ee5.png"><meta property="og:image" content="https://teamwang.cn/16b4ac12-7368-4465-8683-c76baa27aee0.jpg"><meta property="og:image" content="https://teamwang.cn/bde8347d-1357-4695-9f70-1c5493516d44.png"><meta property="og:image" content="https://teamwang.cn/259010b1-4096-45f6-802d-4db252d23a9a.png"><meta property="article:published_time" content="2021-03-04T08:03:22.000Z"><meta property="article:modified_time" content="2021-10-29T08:20:39.105Z"><meta property="article:author" content="Jacky"><meta property="article:tag" content="茶茶,日记,茶茶日记,winklog,WinkLog,博客,teamwang,TeamWang,王嘉尔,Jakcy,jacky"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/b2253bab-1e35-4a54-9e29-0a569a8608a7.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://teamwang.cn/2021/03/04/SpringCloud/"},"headline":"Spring Cloud","image":["https://teamwang.cn/b2253bab-1e35-4a54-9e29-0a569a8608a7.png","https://teamwang.cn/5b41a208-166f-4ee2-a6d7-e38ae3b12ee5.png","https://teamwang.cn/16b4ac12-7368-4465-8683-c76baa27aee0.jpg","https://teamwang.cn/bde8347d-1357-4695-9f70-1c5493516d44.png","https://teamwang.cn/259010b1-4096-45f6-802d-4db252d23a9a.png"],"datePublished":"2021-03-04T08:03:22.000Z","dateModified":"2021-10-29T08:20:39.105Z","author":{"@type":"Person","name":"Jacky"},"description":"Spring Cloud 系列笔记…"}</script><link rel="canonical" href="https://teamwang.cn/2021/03/04/SpringCloud/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?05af3f3bd18ffe652b63cc7ee6abb48c";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="茶茶日记 - winklog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">时光轴</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-04T08:03:22.000Z" title="3/4/2021, 4:03:22 PM">2021-03-04</time>发表</span><span class="level-item"><time dateTime="2021-10-29T08:20:39.105Z" title="10/29/2021, 4:20:39 PM">2021-10-29</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Spring-Cloud/">Spring Cloud</a></span><span class="level-item">1 小时读完 (大约8317个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Spring Cloud</h1><div class="content"><p>Spring Cloud 系列笔记…</p>
<span id="more"></span>

<h1 id="第-1-章-微服务与SC"><a href="#第-1-章-微服务与SC" class="headerlink" title="第 1 章 微服务与SC"></a>第 1 章 微服务与SC</h1><h2 id="1-1-微服务架构技术栈"><a href="#1-1-微服务架构技术栈" class="headerlink" title="1.1 微服务架构技术栈"></a>1.1 微服务架构技术栈</h2><table>
<thead>
<tr>
<th>–</th>
<th>Spring Cloud</th>
<th>Dubbo</th>
<th>Motan</th>
<th>MSEC</th>
<th>其他</th>
</tr>
</thead>
<tbody><tr>
<td>功能</td>
<td>服务方案完整</td>
<td>服务治理框架</td>
<td>服务治理框架</td>
<td>服务开发运营框架</td>
<td>略</td>
</tr>
<tr>
<td>通信方式</td>
<td>REST / Http</td>
<td>RPC 协议</td>
<td>RPC / Hessian2</td>
<td>Protocol buffer</td>
<td>grpc, thrift</td>
</tr>
<tr>
<td>服务发现 / 注册</td>
<td>Eureka (AP)</td>
<td>ZK, Nacos</td>
<td>ZK / Conusl</td>
<td>只有服务发现</td>
<td>Etcd</td>
</tr>
<tr>
<td>负载均衡</td>
<td>Ribbon</td>
<td>客户端负载均衡</td>
<td>客户端负载均衡</td>
<td>客户端负载均衡</td>
<td>Nginx + Lua</td>
</tr>
<tr>
<td>容错机制</td>
<td>6种容错策略</td>
<td>6种容错策略</td>
<td>2种容错策略</td>
<td>自动容错</td>
<td>Keepalived、HeartBeat</td>
</tr>
<tr>
<td>熔断机制</td>
<td>Hystrix</td>
<td>无</td>
<td>无</td>
<td>提供过载保护</td>
<td>无</td>
</tr>
<tr>
<td>配置中心</td>
<td>Spring Cloud Config</td>
<td>Nacos</td>
<td>无</td>
<td>无</td>
<td>Apollo, Nacos</td>
</tr>
<tr>
<td>网关</td>
<td>Zuul, Gateway</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>Kong, 自研</td>
</tr>
<tr>
<td>服务监控</td>
<td>Hystrix + Turbine</td>
<td>Dubbo + Monitor</td>
<td>无</td>
<td>Monitor</td>
<td>ELK</td>
</tr>
<tr>
<td>链路监控</td>
<td>Sleuth + Zipkin</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>PinPoint</td>
</tr>
<tr>
<td>多语言</td>
<td>Rest 支持多语言</td>
<td>Java</td>
<td>Java</td>
<td>Java, C++, PHP</td>
<td>Java, PHP, Node.js</td>
</tr>
<tr>
<td>社区活跃</td>
<td>高 (Spring 社区)</td>
<td>高 (阿里)</td>
<td>一般</td>
<td>未知</td>
<td>略</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="1-2-架构演变"><a href="#1-2-架构演变" class="headerlink" title="1.2 架构演变"></a>1.2 架构演变</h2><p>单体应用 &gt;&gt; 分布式(水平复制) &gt;&gt; SOA(面向服务架构) &gt;&gt; 微服务</p>
<p>其中，微服务是更细粒度的划分；而SOA架构更庞重，主要包括有ESB（Enterprise Service Bus，企业服务总线。有SOAP/JMS技术），基于XML和WDSL语言。</p>
<h2 id="1-3-SpringCloud-D版中文文档"><a href="#1-3-SpringCloud-D版中文文档" class="headerlink" title="1.3 SpringCloud D版中文文档"></a>1.3 <a target="_blank" rel="noopener" href="https://springcloud.cc/spring-cloud-dalston.html">SpringCloud D版中文文档</a></h2><h1 id="第-2-章-Eureka"><a href="#第-2-章-Eureka" class="headerlink" title="第 2 章 Eureka"></a>第 2 章 Eureka</h1><h2 id="2-1-服务的核心操作"><a href="#2-1-服务的核心操作" class="headerlink" title="2.1 服务的核心操作"></a>2.1 服务的核心操作</h2><p>服务注册、下线、租约和剔除。</p>
<h2 id="2-2-分布式系统的复制方式"><a href="#2-2-分布式系统的复制方式" class="headerlink" title="2.2 分布式系统的复制方式"></a>2.2 分布式系统的复制方式</h2><ol>
<li><p>主从复制<Master-Slave><br>对数据的写操作都提交到主副本，最后再由主副本更新到其它副本。读操作可以分配在从副本上以缓解压力。<br>更新方式有：同步更新、异步更新、同步和异步混合。</p>
</li>
<li><p>对等复制<Peer to Peer><br>Eureka就是实现了Peer to Peer.</p>
</li>
</ol>
<h2 id="2-3-CAP理论在Eureka中的体现"><a href="#2-3-CAP理论在Eureka中的体现" class="headerlink" title="2.3 CAP理论在Eureka中的体现"></a>2.3 CAP理论在Eureka中的体现</h2><p>Eureka会存留过期的实例信息，Eureka并不是强一致性的。<br>C和A冲突的原因：为了保证数据一致性需要同步(加锁)，所以可能会造成阻塞(即牺牲了可用性)。</p>
<p>单机Redis为CA，没有P是因为不存在和其它网络分区通信。<br>集群Redis为AP，牺牲强一致性保证高可用。</p>
<p>总结：由于CAP理论是存在于分布式系统中的，故一般情况下都是会与其它网络分区通信的，所以一般会保证P。另外，由于分布式系统主要以性能为主，故也会保证A。所以分布式组件大多都是保证了<strong>AP</strong>，再用<strong>最终一致性</strong>来保证数据安全。Eureka/Redis也如此。</p>
<h2 id="2-4-Eureka的配置"><a href="#2-4-Eureka的配置" class="headerlink" title="2.4 Eureka的配置"></a>2.4 Eureka的配置</h2><ol>
<li>Server</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bootstrap.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8888</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span><span class="string">&lt;/pre&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">false</span> <span class="comment"># 注册中心为false</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">false</span> <span class="comment"># 注册中心为false</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:8761/eureka/ # one eureka server</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:8762/eureka/ # two eureka server</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8762/eureka/,http://localhost:8763/eureka/</span> <span class="comment"># three eureka server</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">      <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Client</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:8761/eureka/ # one eureka server</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:8761/eureka/,http://localhost:8762/eureka/ # two eureka server</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/,http://localhost:8763/eureka/</span> <span class="comment"># three eureka server</span></span><br></pre></td></tr></table></figure>


<h1 id="第-3-章-Feign"><a href="#第-3-章-Feign" class="headerlink" title="第 3 章 Feign"></a>第 3 章 Feign</h1><h2 id="3-1-概述"><a href="#3-1-概述" class="headerlink" title="3.1 概述"></a>3.1 概述</h2><blockquote>
<p>Feign 是一个声明式的 Web Service 客户端。Feign 会完全代理 HTTP 的请求。它的出现使开发 Web Service 客户端变得很简单。使用 Feign 只需要创建一个接口加上对应的注解，如：<code>@FeignClient</code>。</p>
</blockquote>
<blockquote>
<p>Feign 有可插拔的注解，包括 Feign 注解和 JAX-RS 注解。Feign 也支持编码器和解码器，Spring Cloud Open Feign 对 Feign 进行增强支持 Spring MVC 注解，可以像 Spring Web 一样使用 HttpMessageConverters.</p>
</blockquote>
<blockquote>
<p>此外，服务消费者调用提供者时，底层通过 HTTP Client 的方式访问。当然也可以使用 JDK 原生的 URLConnection、Apache 的 HTTP Client、Netty 的异步 HTTP Client，Spring 的 RestTemplate (实现 Ribbon 负载均衡的媒介) 去实现服务间的调用。</p>
</blockquote>
<h2 id="3-2-特性"><a href="#3-2-特性" class="headerlink" title="3.2 特性"></a>3.2 特性</h2><ul>
<li>可插拔的注解支持，包括 Feign 注解和 JAX-RS 注解。</li>
<li>支持可插拔的 HTTP 编码器和解码器。</li>
<li>支持 Hystrix 和它的 Fallback。</li>
<li>支持 Ribbon 的负载均衡。</li>
<li>支持 HTTP 请求和响应的压缩。</li>
</ul>
<h2 id="3-3-Feign-的基础用法"><a href="#3-3-Feign-的基础用法" class="headerlink" title="3.3 Feign 的基础用法"></a>3.3 Feign 的基础用法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudFeignApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(SpringCloudFeignApplication.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;github-client&quot;, url = &quot;https://api.github.com&quot;, configuration = HelloFeignServiceConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * content: &#123;&quot;message&quot;:&quot;Validation Failed&quot;,&quot;errors&quot;:[&#123;&quot;resource&quot;:&quot;Search&quot;,&quot;field&quot;:&quot;q&quot;,&quot;code&quot;:&quot;missing&quot;&#125;],</span></span><br><span class="line"><span class="comment">     * &quot;documentation_url&quot;:&quot;https://developer.github.com/v3/search&quot;&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queryStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/search/repositories&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function">String <span class="title">searchRepo</span><span class="params">(<span class="meta">@RequestParam(&quot;q&quot;)</span> String queryStr)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloFeignController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloFeignService helloFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务消费者对位提供的服务</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/search/github&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">searchGithubRepoByStr</span><span class="params">(<span class="meta">@RequestParam(&quot;str&quot;)</span> String queryStr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> helloFeignService.searchRepo(queryStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-Feign-的基础功能"><a href="#3-4-Feign-的基础功能" class="headerlink" title="3.4 Feign 的基础功能"></a>3.4 Feign 的基础功能</h2><h3 id="3-4-1-FeignClient-注解"><a href="#3-4-1-FeignClient-注解" class="headerlink" title="3.4.1 @FeignClient 注解"></a>3.4.1 @FeignClient 注解</h3><p><code>@FeignClient</code>的常用属性如下：</p>
<ul>
<li>name：指定 FeignClient 的名称，如果项目使用了 Ribbon，name 属性会作为微服务的名称，用于服务发现。</li>
<li>url：url 一般用于调试，可以手动指定<code>@FeignClient</code>调用的地址。</li>
<li>decode404：当发生 404 错误时，如果该字段为 true，会调用 decoder 进行解码，否则抛出 FeignException。</li>
<li>configuration：Feign配置类。可以定义 Feign 的 Encoder、Decoder、LogLevel、Contract。</li>
<li>fallback：定义容错的处理类，当调用远程接口失败或超时时，会调用对应接口的容错逻辑，fallback 指定的类必须实现<code>@FeignClient</code>标记的接口并用<code>@Component</code>注册Bean。</li>
<li>fallbackFactory：工厂类，用于生成 fallback 类示例，通过这个属性我们可以实现每个接口通用的容错逻辑，减少重复的代码。也要注册到Spring容器内。</li>
<li>path：定义当前 FeignClient 的统一前缀。</li>
</ul>
<h3 id="3-4-2-Feign-开启-GZIP-压缩"><a href="#3-4-2-Feign-开启-GZIP-压缩" class="headerlink" title="3.4.2 Feign 开启 GZIP 压缩"></a>3.4.2 Feign 开启 GZIP 压缩</h3><h1 id="第-4-章-Ribbon"><a href="#第-4-章-Ribbon" class="headerlink" title="第 4 章 Ribbon"></a>第 4 章 Ribbon</h1><h2 id="4-1-Ribbon的基本用法"><a href="#4-1-Ribbon的基本用法" class="headerlink" title="4.1 Ribbon的基本用法"></a>4.1 Ribbon的基本用法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonLoadbalancerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RibbonLoadbalancerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span> <span class="comment">// Eureka 已经间接依赖了 Ribbon，所以不需要再导入 Ribbon 的依赖。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate; <span class="comment">// 通过 RestTemplate 调用多个客户端，实现客户端负载均衡。</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(Integer a, Integer b)</span> </span>&#123;</span><br><span class="line">        String result = restTemplate</span><br><span class="line">                .getForObject(<span class="string">&quot;http://CLIENT-A/add?a=&quot;</span> + a + <span class="string">&quot;&amp;b=&quot;</span> + b, String.class);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-Ribbon负载均衡策略与自定义配置"><a href="#4-2-Ribbon负载均衡策略与自定义配置" class="headerlink" title="4.2 Ribbon负载均衡策略与自定义配置"></a>4.2 Ribbon负载均衡策略与自定义配置</h2><h3 id="4-2-1-策略详解"><a href="#4-2-1-策略详解" class="headerlink" title="4.2.1 策略详解"></a>4.2.1 策略详解</h3><table>
<thead>
<tr>
<th>策略类</th>
<th>命名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>RandomRule</td>
<td>随机策略</td>
<td>随机选择 server</td>
</tr>
<tr>
<td>RoundRobinRule（default）</td>
<td>轮询策略</td>
<td>按顺序循环选择 server</td>
</tr>
<tr>
<td>RetryRule</td>
<td>重试策略</td>
<td>在一个配置时间段内选择 server 不成功，则一直尝试选择一个可用的 server</td>
</tr>
<tr>
<td>BestAvailableRule</td>
<td>最低并发策略</td>
<td>逐个考察 server, 如果 server 断路器打开，则忽略，再选择其中并发连接最低的 server</td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>可用过滤策略</td>
<td>过滤掉一直连接失败并被标记为 circuit tripped 的 server，过滤掉那些高并发连接的 server（active connections 超过配置的阈值）</td>
</tr>
<tr>
<td>ResponseTimeWeightedRule</td>
<td>响应时间加权策略</td>
<td>根据 server 的响应时间改变权重</td>
</tr>
<tr>
<td>ZoneAvoidanceRule</td>
<td>区域权衡策略</td>
<td>综合判断 server 所在区域的性能和 server 的可用性轮询选择 server，并且判定一个 AWS Zone 的运行性能是否可用，剔除不可用的 Zone 中的所有 server</td>
</tr>
</tbody></table>
<h3 id="4-2-2-代码实现"><a href="#4-2-2-代码实现" class="headerlink" title="4.2.2 代码实现"></a>4.2.2 代码实现</h3><p><img src="/b2253bab-1e35-4a54-9e29-0a569a8608a7.png" alt="IRule接口"></p>
<h3 id="4-2-3-策略设置"><a href="#4-2-3-策略设置" class="headerlink" title="4.2.3 策略设置"></a>4.2.3 策略设置</h3><ol>
<li>全局策略设置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfiguration</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">ribbonRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>对特定的微服务设置 IRule 策略</li>
</ol>
<blockquote>
<p>使用<code>@RibbonClient</code>，设置 configuration 的属性值，eg:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;client-a&quot;, configuration = TestConfiguration.class)</span></span><br><span class="line"><span class="comment">//@RibbonClients(value = &#123;</span></span><br><span class="line"><span class="comment">//        @RibbonClient(name = &quot;client-a&quot;, configuration = TestConfiguration.class),</span></span><br><span class="line"><span class="comment">//        @RibbonClient(name = &quot;client-b&quot;, configuration = TestConfiguration.class)</span></span><br><span class="line"><span class="comment">//&#125;)</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123;@ComponentScan.Filter(type = FilterType.ANNOTATION, value = &#123;AvoidScan.class&#125;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonLoadbalancerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RibbonLoadbalancerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用yaml配置文件配置，eg:</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ribbon-loadbalancer</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7777</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.host:127.0.0.1&#125;:$&#123;eureka.port:8888&#125;/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#client-a:</span></span><br><span class="line"><span class="comment">#  ribbon:</span></span><br><span class="line"><span class="comment">#    ConnectTimeout: 3000</span></span><br><span class="line"><span class="comment">#    ReadTimeout: 60000</span></span><br><span class="line"><span class="comment">#    MaxAutoRetries: 1 #对第一次请求的服务的重试次数</span></span><br><span class="line"><span class="comment">#    MaxAutoRetriesNextServer: 1 #要重试的下一个服务的最大数量（不包括第一个服务）</span></span><br><span class="line"><span class="comment">#    OkToRetryOnAllOperations: true</span></span><br><span class="line"><span class="comment">#    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule#</span></span><br><span class="line"><span class="comment">#ribbon:</span></span><br><span class="line"><span class="comment">#  eager-load:</span></span><br><span class="line"><span class="comment">#    enabled: true</span></span><br><span class="line"><span class="comment">#    clients: client-a, client-b, client-c</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过配置文件自定义 Ribbon 客户端的语法说明（官方文档均有说明），eg:</p>
</blockquote>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>clientName.ribbon.NFLoadBalancerClassName</td>
<td>指定 ILoadBalancer 的实现类</td>
</tr>
<tr>
<td>clientName.ribbon.NFLoadBalancerRuleClassName</td>
<td>指定 IRule 的实现类</td>
</tr>
<tr>
<td>clientName.ribbon.NFLoadBalancerPingClassName</td>
<td>指定 IPing 的实现类</td>
</tr>
<tr>
<td>clientName.ribbon.NIWSServerListClassName</td>
<td>指定 ServerList 的实现类</td>
</tr>
<tr>
<td>clientName.ribbon.NIWSServerListFilterClassName</td>
<td>指定 ServerListFilter 的实现类</td>
</tr>
</tbody></table>
<p><strong>实现自定义负载均衡策略</strong>：实现IRule接口的choose方法再注册到容器即可。</p>
<h2 id="4-3-Ribbon-进阶"><a href="#4-3-Ribbon-进阶" class="headerlink" title="4.3 Ribbon 进阶"></a>4.3 Ribbon 进阶</h2><h3 id="4-3-1-Ribbon-的核心接口"><a href="#4-3-1-Ribbon-的核心接口" class="headerlink" title="4.3.1 Ribbon 的核心接口"></a>4.3.1 Ribbon 的核心接口</h3><p>在 IDE 中查看具体实现</p>
<blockquote>
<p>IRule、IPing 的 I 代表 Interface，以后的接口也使用此命名格式。如 IUserService…</p>
</blockquote>
<table>
<thead>
<tr>
<th>接口</th>
<th>描述</th>
<th>默认实现类</th>
</tr>
</thead>
<tbody><tr>
<td>IClientConfig</td>
<td>定义 Ribbon 中管理配置的接口</td>
<td>DefaultClientConfigImpl</td>
</tr>
<tr>
<td>IRule</td>
<td>定义 Ribbon 中负载均衡策略的接口</td>
<td>ZoneAvoidanceRule</td>
</tr>
<tr>
<td>IPing</td>
<td>定义定期 ping 服务检查可用性的接口</td>
<td>DummyPing</td>
</tr>
<tr>
<td>ServerList&lt;Server</td>
<td>定义获取服务列表方法的接口</td>
<td>ConfigurationBasedServerList</td>
</tr>
<tr>
<td>ServerListFilter&lt;Server</td>
<td>定义特定期望获取服务列表方法的接口</td>
<td>ZonePreferenceServerListFilter</td>
</tr>
<tr>
<td>ILoadBalancer</td>
<td>定义负载均衡选择服务的核心方法的接口</td>
<td>ZoneAwareLoadBalancer</td>
</tr>
<tr>
<td>ServerListUpdater</td>
<td>为 DynamicServerListLoadBalancer 定义动态更新服务列表的接口</td>
<td>PollingServerListUpdater</td>
</tr>
</tbody></table>
<h3 id="4-3-2-RestTemplate-达到负载均衡的原理"><a href="#4-3-2-RestTemplate-达到负载均衡的原理" class="headerlink" title="4.3.2 RestTemplate 达到负载均衡的原理"></a>4.3.2 RestTemplate 达到负载均衡的原理</h3><hr>
<p><code>RestTemplate.class</code>Bean 的继承关系图：</p>
<p><img src="/5b41a208-166f-4ee2-a6d7-e38ae3b12ee5.png" alt="RestTemplate"></p>
<hr>
<p><code>@LoadBalanced</code> 注解：</p>
<p><img src="/16b4ac12-7368-4465-8683-c76baa27aee0.jpg"></p>
<hr>
<p><code>LoadBalancerClient</code> 接口的方法和实现类，具体见注释文档：</p>
<p><img src="/bde8347d-1357-4695-9f70-1c5493516d44.png"></p>
<p>其中<code>LoadBalancerClient</code>接口继承自<code>ServiceInstanceChooser</code>接口，该接口只有一个<code>ServiceInstance choose(String serviceId);</code>方法 。</p>
<p><img src="/259010b1-4096-45f6-802d-4db252d23a9a.png"></p>
<h1 id="第-5-章-Hystrix-Defend-your-APP"><a href="#第-5-章-Hystrix-Defend-your-APP" class="headerlink" title="第 5 章 Hystrix - Defend your APP"></a>第 5 章 <a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki/">Hystrix</a> - Defend your APP</h1><h2 id="5-1-设计目标"><a href="#5-1-设计目标" class="headerlink" title="5.1 设计目标"></a>5.1 设计目标</h2><ol>
<li>通过客户端库对延迟和故障进行保护和控制</li>
<li>在一个复杂的分布式系统中停止级联故障</li>
<li>快速失败和迅速恢复</li>
<li>在合理的情况下回退和优雅地降级</li>
<li>开启近实时监控、告警和操作控制</li>
</ol>
<h2 id="5-2-Hystrix-的基本用法"><a href="#5-2-Hystrix-的基本用法" class="headerlink" title="5.2 Hystrix 的基本用法"></a>5.2 Hystrix 的基本<a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki/How-To-Use">用法</a></h2><p>使用<code>@EnableHystrix</code>、<code>@HystrixCommand</code>&lt;修饰方法&gt; 注解：</p>
<blockquote>
<p>@Client 的注解基本都是修饰类。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">implements</span> <span class="title">IUserService</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod=&quot;defaultUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">(String username)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(username.equals(<span class="string">&quot;spring&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;This is real user&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 出错则调用该方法返回友好错误</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">defaultUser</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;The user does not exist in this system&quot;</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Feign 中使用断路器，Feign 默认不开启 Hystrix：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;sc-provider-service&quot;, fallback = UserServiceFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/getUser&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-3-Hystrix-Dashboard"><a href="#5-3-Hystrix-Dashboard" class="headerlink" title="5.3 Hystrix Dashboard"></a>5.3 Hystrix Dashboard</h2><blockquote>
<p>Hystrix Dashboard 展示每个 HystrixCommand 执行过程中的信息。</p>
</blockquote>
<p>使用方法：<br>项目导入 actuator 依赖，暴露 hystrix.stream 端点。启动类增加 @EnableHystrixDashboard 注解。</p>
<h2 id="5-4-Turbine-聚合-Hystrix"><a href="#5-4-Turbine-聚合-Hystrix" class="headerlink" title="5.4 Turbine 聚合 Hystrix"></a>5.4 Turbine 聚合 Hystrix</h2><p>主启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableTurbine</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TurbineApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(TurbineApplication.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>YAML 配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.host:127.0.0.1&#125;:$&#123;eureka.port:8761&#125;/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"> <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">hystrix.stream</span></span><br><span class="line"><span class="attr">turbine:</span></span><br><span class="line">  <span class="comment"># 设置需要收集健康信息的服务名称</span></span><br><span class="line">  <span class="attr">appConfig:</span> <span class="string">sc-hello-service,sc-provider-service</span></span><br><span class="line">  <span class="attr">clusterNameExpression:</span> <span class="string">&quot;&#x27;default&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-5-Hystrix-详解"><a href="#5-5-Hystrix-详解" class="headerlink" title="5.5 Hystrix 详解"></a>5.5 Hystrix 详解</h2><h3 id="5-5-1-Hystrix-异常机制和处理"><a href="#5-5-1-Hystrix-异常机制和处理" class="headerlink" title="5.5.1 Hystrix 异常机制和处理"></a>5.5.1 Hystrix 异常机制和处理</h3><p>Hystrix 的异常处理中，有5种出错的情况下会被 fallback 截获，分别是：</p>
<ul>
<li>FAILURE：执行失败，抛出异常。</li>
<li>TIMEOUT：执行超时。</li>
<li>SHORT_CIRCUITED：断路器打开。</li>
<li>THREAD_POOL_REJECTED：线程池拒绝。</li>
<li>SEMAPHORE_REJECTED：信号量拒绝。</li>
</ul>
<p>对于 <code>BAD_REQUEST</code> 异常是不会触发 fallback 且不会被计数进入熔断的，会抛出 <code>HystrixBadRequestException</code>.</p>
<h3 id="5-5-2-Hystrix-配置说明"><a href="#5-5-2-Hystrix-配置说明" class="headerlink" title="5.5.2 Hystrix 配置说明"></a>5.5.2 <a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki/Configuration">Hystrix 配置说明</a></h3><h3 id="5-5-3-Hystrix-线程调整和计算"><a href="#5-5-3-Hystrix-线程调整和计算" class="headerlink" title="5.5.3 Hystrix 线程调整和计算"></a>5.5.3 Hystrix 线程调整和计算</h3><p>对业务的配置通用的做法：</p>
<ol>
<li>超时时间默认为 1000ms，如果业务明显超过 1000ms，则根据自己的业务进行修改。</li>
<li>线程池默认为 10，需要更多时自行调整。</li>
<li>金丝雀发布，如果成功则保持。</li>
<li>在生产环境中运行超过 24 小时。</li>
<li>如果系统有警告和监控，那么可以依靠它们捕捉问题。</li>
<li>运行 24 小时之后，通过延迟百分位和流量来计算有意义的最低满足值。</li>
<li>在生产或者测试环境中实时修改值，然后用仪表盘监控。</li>
<li>如果断路器产生变化和影响，则需再次确认这个配置。</li>
</ol>
<p>具体的调整和计算见官方说明文档。</p>
<h3 id="5-5-4-Hystrix-请求缓存"><a href="#5-5-4-Hystrix-请求缓存" class="headerlink" title="5.5.4 Hystrix 请求缓存"></a>5.5.4 Hystrix 请求缓存</h3><p>使用<code>@CacheResult</code>开启缓存，<code>@CacheRemove</code>清除缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> <span class="keyword">implements</span> <span class="title">IHelloService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">     </span><br><span class="line">    <span class="meta">@CacheResult</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        String json = restTemplate.getForObject(<span class="string">&quot;http://sc-provider-service/getUser/&#123;1&#125;&quot;</span>, String.class, id);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CacheResult</span></span><br><span class="line">    <span class="meta">@HystrixCommand(commandKey = &quot;getUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserToCommandKey</span><span class="params">(<span class="meta">@CacheKey</span> Integer id)</span> </span>&#123;</span><br><span class="line">        String json = restTemplate.getForObject(<span class="string">&quot;http://sc-provider-service/getUser/&#123;1&#125;&quot;</span>, String.class, id);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CacheRemove(commandKey=&quot;getUser&quot;)</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">updateUser</span><span class="params">(<span class="meta">@CacheKey</span> Integer id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;删除getUser缓存&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;update success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-5-5-Hystrix-Request-Collapser"><a href="#5-5-5-Hystrix-Request-Collapser" class="headerlink" title="5.5.5 Hystrix Request Collapser"></a>5.5.5 Hystrix Request Collapser</h3><p>使用注解进行请求合并：</p>
<ol>
<li>和缓存类似，用拦截器实现 Hystrix 上下文的初始化和关闭：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheContextInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> HystrixRequestContext context;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse respone, Object arg2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        context = HystrixRequestContext.initializeContext();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse respone, Object arg2, ModelAndView arg3)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse respone, Object arg2, Exception arg3)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        context.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>未完待续…</li>
</ol>
<h1 id="第-6-章-Zuul"><a href="#第-6-章-Zuul" class="headerlink" title="第 6 章 Zuul"></a>第 6 章 Zuul</h1><h2 id="6-1-简介"><a href="#6-1-简介" class="headerlink" title="6.1 简介"></a>6.1 简介</h2><blockquote>
<p>Zuul is the front door for all request from devices and web sites to the backend of the Netflix streaming application.</p>
</blockquote>
<p>Zuul 具有以下功能：</p>
<ul>
<li>认证与授权</li>
<li>压力控制</li>
<li>金丝雀测试</li>
<li>动态路由</li>
<li>负载削减</li>
<li>静态响应处理</li>
<li>主动流量管理</li>
</ul>
<h2 id="6-2-Zuul-的快速入门"><a href="#6-2-Zuul-的快速入门" class="headerlink" title="6.2 Zuul 的快速入门"></a>6.2 Zuul 的快速入门</h2><h3 id="6-2-1-基本配置"><a href="#6-2-1-基本配置" class="headerlink" title="6.2.1 基本配置"></a>6.2.1 基本配置</h3><ol>
<li>单实例配置：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">zuul-gateway:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/client/**</span>    <span class="comment"># 将所有 /client 开头的 URL 映射到 client-a 服务去。</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">client-a</span> <span class="comment"># 服务名</span></span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">client-a:</span> <span class="string">/client/**</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>多实例配置：<blockquote>
<p>默认情况下，Zuul 会使用 Eureka 集成的基本负载均衡功能，如果想使用 Ribbon 就需要制定一个 serviceId，此操作需要禁止 Ribbon 使用 Eureka，在 E 版之后新增了负载均衡策略的配置，如下：</p>
</blockquote>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 脱离eureka让zuul结合ribbon实现路由负载均衡  ###</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">ribbon-route:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/ribbon/**</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">ribbon-route</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span>  <span class="comment">#禁止Ribbon使用Eureka</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ribbon-route:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NIWSServerListClassName:</span> <span class="string">com.netflix.loadbalancer.ConfigurationBasedServerList</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span>     <span class="comment">#Ribbon LB Strategy</span></span><br><span class="line">    <span class="attr">listOfServers:</span> <span class="string">localhost:7070,localhost:7071</span>     <span class="comment">#client services for Ribbon LB</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-2-路由通配符"><a href="#6-2-2-路由通配符" class="headerlink" title="6.2.2 路由通配符"></a>6.2.2 路由通配符</h3><table>
<thead>
<tr>
<th>规则</th>
<th>释义</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>/**</td>
<td>匹配任意数量的路径与字符</td>
<td>/mul/a/b…</td>
</tr>
<tr>
<td>/*</td>
<td>匹配任意数量的字符</td>
<td>/mul</td>
</tr>
<tr>
<td>/?</td>
<td>匹配单个字符</td>
<td>/m</td>
</tr>
</tbody></table>
<h3 id="6-2-3-功能配置"><a href="#6-2-3-功能配置" class="headerlink" title="6.2.3 功能配置"></a>6.2.3 功能配置</h3><blockquote>
<p>路由前缀、服务屏蔽、路径屏蔽、敏感头信息、重定向问题、重试机制…</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### 服务忽略、路径忽略、前缀、重定向问题、重试机制 ####</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">ignored-services:</span> <span class="string">client-b</span>    <span class="comment"># 忽略的服务，防服务侵入</span></span><br><span class="line">  <span class="attr">ignored-patterns:</span> <span class="string">/**/div/**</span>  <span class="comment"># 忽略的接口，屏蔽接口</span></span><br><span class="line">  <span class="attr">prefix:</span> <span class="string">/pre</span>                  <span class="comment"># 前缀</span></span><br><span class="line">  <span class="attr">add-host-header:</span> <span class="literal">true</span>         <span class="comment"># 重定向header问题</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">sensitiveHeaders:</span> <span class="string">Cookie,Set-Cookie,Authorization</span> <span class="comment"># 敏感头信息</span></span><br><span class="line">    <span class="attr">client-a:</span> <span class="string">/client/**</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################## 重试机制 ##########################</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span> </span><br><span class="line">  <span class="attr">retryable:</span> <span class="literal">true</span> <span class="comment">#开启重试</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">1</span> <span class="comment">#同一个服务重试的次数(除去首次)</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span>  <span class="comment">#切换相同服务数量</span></span><br></pre></td></tr></table></figure>

<h2 id="6-3-Zuul-进阶"><a href="#6-3-Zuul-进阶" class="headerlink" title="6.3 Zuul 进阶"></a>6.3 Zuul 进阶</h2><h3 id="6-3-1-Zuul-Filter-链"><a href="#6-3-1-Zuul-Filter-链" class="headerlink" title="6.3.1 Zuul Filter 链"></a>6.3.1 Zuul Filter 链</h3><blockquote>
<p>Zuul 本质上是 Filter 责任链。<br>Zuul 内部提供了一个动态读取、编译和运行这些 Filter 的机制。<br>Filter 之间不直接通信（内部用 <code>ThreadLocal</code> 实现），在请求线程中会通过 <mark>RequestContext</mark>（与 doFilter 在同一 ThreadLocal 中） 来共享状态。<br>我们可以在 Filter 之间使用 ThreadLocal 来收集自己需要的状态或数据。</p>
</blockquote>
<p>Java 中的 Filter 接口（在<code>tomcat-embed-core.jar</code>中）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig var1)</span> <span class="keyword">throws</span> ServletException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest var1, ServletResponse var2, FilterChain var3)</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>com.netflix.zuul.context.RequestContext</code> 中的注释，它继承自<code>ConcurrentHashMap</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Request Context holds request, response,  state information and data for ZuulFilters to access and share.</span></span><br><span class="line"><span class="comment"> * The RequestContext lives for the duration of the request and is ThreadLocal.</span></span><br><span class="line"><span class="comment"> * extensions of RequestContext can be substituted by setting the contextClass.</span></span><br><span class="line"><span class="comment"> * Most methods here are convenience wrapper methods; the RequestContext is an extension of a ConcurrentHashMap</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mikey Cohen</span></span><br><span class="line"><span class="comment"> *         Date: 10/13/11</span></span><br><span class="line"><span class="comment"> *         Time: 10:21 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Zuul 中有四种不同生命周期的 Filter，分别是：</p>
</blockquote>
<ul>
<li>pre：在 Zuul 按照规则路由到下级服务之前执行。如果需要对请求进行预处理，比如鉴权、限流等，都应考虑在此类 Filter 中实现。</li>
<li>route：这类 Filter 是 Zuul 路由动作的执行者，是 Apache HttpClient 或 Netflix Ribbon 构建和发送原始 HTTP 请求的地方，目前已支持 OkHttp。</li>
<li>post：这类 Filter 是在源服务返回结果或者异常信息发生后执行的，如果需要对返回信息做一些处理，则在此 Filter 进行处理。</li>
<li>error：在整个生命周期内如果发生异常，则会进入 error Filter，可做全局异常处理。</li>
</ul>
<h3 id="6-3-2-Zuul-Filter-和-Actuator"><a href="#6-3-2-Zuul-Filter-和-Actuator" class="headerlink" title="6.3.2 Zuul Filter 和 Actuator"></a>6.3.2 Zuul Filter 和 Actuator</h3><p><code>@EnableZuulProxy</code> + Spring Boot Actuator 会多两个管控端点：</p>
<ul>
<li>/routes：返回当前 Zuul Server 中所有已生成的映射规则，加上 /details 可查看明细。</li>
<li>/filters：返回当前 Zuul Server 中所有已注册生效的 Filter。</li>
</ul>
<h3 id="6-3-3-多级业务处理"><a href="#6-3-3-多级业务处理" class="headerlink" title="6.3.3 多级业务处理"></a>6.3.3 多级业务处理</h3><h4 id="实现自定义-Filter"><a href="#实现自定义-Filter" class="headerlink" title="实现自定义 Filter"></a>实现自定义 Filter</h4><blockquote>
<p>继承 ZuulFIlter 抽象类，它包括以下等几个方法：</p>
</blockquote>
<ul>
<li>String filterType()：抽象方法。使用返回值设置 Filter 类型，可以设置为 pre，route，post，error 类型。</li>
<li>int filterOrder()：抽象方法。使用返回值设置 Filter 的执行顺序，即优先权。</li>
<li>boolean shouldFilter()：使用返回值设置 Filter 是否执行，可作为开关使用。</li>
<li>Object run()：Filter 里面的核心执行逻辑，业务处理在此编写。该方法是重写了 IZuulFilter 接口类的方法，而不是 Thread / Runnable 的。</li>
</ul>
<p>代码实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstPreFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是第一个自定义Zuul Filter！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>别忘记了注入该 Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FirstPreFilter <span class="title">firstPreFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FirstPreFilter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="业务处理实战"><a href="#业务处理实战" class="headerlink" title="业务处理实战"></a>业务处理实战</h4><p>这里模拟一个业务需求：使用 SecondPreFilter 来验证请求是否传入参数 a，使用 ThirdPreFilter 来验证是否传入 b 参数，最后在 PostFilter 里边统一处理返回内容。</p>
<blockquote>
<p>注意：</p>
</blockquote>
<ol>
<li>从 RequestContext 获取 Request 的过程。</li>
<li>filterOrder 优先级的设置。</li>
<li>在 pre 禁止路由后的处理：设定 responseBody 供 <strong>PostFilter</strong> 使用；为同类型下游 Filter 设置执行开关。</li>
</ol>
<p>以下为 <code>SecondPreFilter.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondPreFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是SecondPreFilter！&quot;</span>);</span><br><span class="line">        <span class="comment">//从RequestContext获取上下文</span></span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="comment">//从上下文获取HttpServletRequest</span></span><br><span class="line">        HttpServletRequest request = ctx.getRequest();</span><br><span class="line">        <span class="comment">//从request尝试获取a参数值</span></span><br><span class="line">        String a = request.getParameter(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="comment">//如果a参数值为空则进入此逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == a) &#123;</span><br><span class="line">            <span class="comment">//对该请求禁止路由，也就是禁止访问下游服务</span></span><br><span class="line">            ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//设定responseBody供PostFilter使用</span></span><br><span class="line">            ctx.setResponseBody(<span class="string">&quot;&#123;\&quot;status\&quot;:500,\&quot;message\&quot;:\&quot;a参数为空！\&quot;&#125;&quot;</span>);</span><br><span class="line">            <span class="comment">//logic-is-success保存于上下文，作为同类型下游Filter的执行开关</span></span><br><span class="line">            ctx.set(<span class="string">&quot;logic-is-success&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//到这里此Filter逻辑结束</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置避免报空</span></span><br><span class="line">        ctx.set(<span class="string">&quot;logic-is-success&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>ThirdPreFilter.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThirdPreFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PRE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="comment">//从上下文获取logic-is-success值，用于判断此Filter是否执行</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">boolean</span>)ctx.get(<span class="string">&quot;logic-is-success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是ThirdPreFilter！&quot;</span>);</span><br><span class="line">        <span class="comment">//从RequestContext获取上下文</span></span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="comment">//从上下文获取HttpServletRequest</span></span><br><span class="line">        HttpServletRequest request = ctx.getRequest();</span><br><span class="line">        <span class="comment">//从request尝试获取b参数值</span></span><br><span class="line">        String b = request.getParameter(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        <span class="comment">//如果b参数值为空则进入此逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == b) &#123;</span><br><span class="line">            <span class="comment">//对该请求禁止路由，也就是禁止访问下游服务</span></span><br><span class="line">            ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//设定responseBody供PostFilter使用</span></span><br><span class="line">            ctx.setResponseBody(<span class="string">&quot;&#123;\&quot;status\&quot;:500,\&quot;message\&quot;:\&quot;b参数为空！\&quot;&#125;&quot;</span>);</span><br><span class="line">            <span class="comment">//logic-is-success保存于上下文，作为同类型下游Filter的执行开关，假定后续还有自定义Filter当设置此值</span></span><br><span class="line">            ctx.set(<span class="string">&quot;logic-is-success&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//到这里此Filter逻辑结束</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PostFilter</code> 主要是用于检查有无定制 ResponseBody，以及设置响应字符集，避免中文乱码，此外还设定了 http 状态码。</p>
<p><code>PostFilter.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> POST_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是PostFilter！&quot;</span>);</span><br><span class="line">        <span class="comment">//从RequestContext获取上下文</span></span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="comment">//处理返回中文乱码</span></span><br><span class="line">        ctx.getResponse().setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//获取上下文中保存的responseBody</span></span><br><span class="line">        String responseBody = ctx.getResponseBody();</span><br><span class="line">        <span class="comment">//如果responseBody不为空，则说明流程有异常发生</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != responseBody) &#123;</span><br><span class="line">            <span class="comment">//设定返回状态码</span></span><br><span class="line">            ctx.setResponseStatusCode(<span class="number">500</span>);</span><br><span class="line">            <span class="comment">//替换响应报文</span></span><br><span class="line">            ctx.setResponseBody(responseBody);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-3-4-Zuul-权限集成"><a href="#6-3-4-Zuul-权限集成" class="headerlink" title="6.3.4 Zuul 权限集成"></a>6.3.4 Zuul 权限集成</h3><blockquote>
<p>Spring Cloud 不选择 Apache Shiro 的原因：Shiro 更适合单体应用的场景。<br>在解决方案的选择上面，传统的譬如单点登陆（SSO），或者分布式 Session，要么致使权限服务器集中化导致流量臃肿，要么需要自己实现一套复杂的存储同步机制，都不是最好的解决方案。<br>对于 Zuul，比较好的方案有：</p>
</blockquote>
<ul>
<li>自定义权限认证 Filter</li>
<li>OAuth2.0 + JWT(JSON Web Token)<ul>
<li>使用 OAuth2.0 协议的思想拉取认证生成 Token，再颁发给 JWT。使用 JWT 瞬时保存这个 Token，在客户端与资源端进行对称或非对称加密，使得这个规约具有定时、定量的授权认证功能，从而免去 Token 存储所带来的安全或系统拓展问题。</li>
</ul>
</li>
</ul>
<h4 id="单点登陆（SSO）和分布式-Session-介绍"><a href="#单点登陆（SSO）和分布式-Session-介绍" class="headerlink" title="单点登陆（SSO）和分布式 Session 介绍"></a>单点登陆（SSO）和分布式 Session 介绍</h4><h4 id="认证-authentication-和授权-authorization-的区别"><a href="#认证-authentication-和授权-authorization-的区别" class="headerlink" title="认证 (authentication) 和授权 (authorization) 的区别"></a>认证 (authentication) 和授权 (authorization) 的区别</h4><p>User 和 Password</p>
<h4 id="Zuul-OAuth2-0-JWT-实战-Hardly"><a href="#Zuul-OAuth2-0-JWT-实战-Hardly" class="headerlink" title="Zuul + OAuth2.0 + JWT 实战 - Hardly"></a>Zuul + OAuth2.0 + JWT 实战 - Hardly</h4><h5 id="1-zuul-server-编写说明"><a href="#1-zuul-server-编写说明" class="headerlink" title="1). zuul-server 编写说明"></a>1). zuul-server 编写说明</h5><blockquote>
<p>zuul-server 的作用是当请求接口时，判断是否<strong>登录鉴权</strong>。如果未登录，则跳转到 auth-server 的登录界面（默认为 Spring Security OAuth 的登录界面，也可以自行定制。），登录成功后 auth-server 颁发 jwt token，zuul-server 在访问下游服务时将 <strong>jwt token 放入 header</strong> 中即可。</p>
</blockquote>
<p>具体实现：</p>
<ul>
<li>在 pom.xml 中引入对 OAuth2 与 Security 的支持：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编写核心配置文件 bootstrap.yml：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul-server</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5555</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.host:127.0.0.1&#125;:$&#123;eureka.port:8888&#125;/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">client-a:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/client/**</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">client-a</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">basic:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">access-token-uri:</span> <span class="string">http://localhost:7777/uaa/oauth/token</span>           <span class="comment">#令牌端点</span></span><br><span class="line">      <span class="attr">user-authorization-uri:</span> <span class="string">http://localhost:7777/uaa/oauth/authorize</span> <span class="comment">#授权端点</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">zuul_server</span> <span class="comment">#OAuth2客户端ID</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">secret</span>  <span class="comment">#OAuth2客户端密钥</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">jwt:</span></span><br><span class="line">        <span class="attr">key-value:</span> <span class="string">springcloud123</span> <span class="comment">#使用对称加密方式，默认算法为HS256</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编写主启动类，重写 WebSecurityConfigurerAdapter 适配器的 configure(HttpSecurity http) 方法，<strong>声明需要鉴权的 url 信息</strong>：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@EnableOAuth2Sso</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulServerApplication</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/client/**&quot;</span>)</span><br><span class="line">        .permitAll()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf()</span><br><span class="line">        .disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-auth-server-编写说明"><a href="#2-auth-server-编写说明" class="headerlink" title="2). auth-server 编写说明"></a>2). auth-server 编写说明</h5><blockquote>
<p>auth-server 作为认证授权中心，会生成颁发 jwt token 凭证。</p>
</blockquote>
<p>具体实现：</p>
<ul>
<li>在 pom.xml 中引入对 OAuth2 的支持：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编写核心配置文件 bootstrap.yml：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">auth-server</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7777</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">contextPath:</span> <span class="string">/uaa</span> <span class="comment">#web基路径</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.host:127.0.0.1&#125;:$&#123;eureka.port:8888&#125;/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编写认证授权服务适配器类 **<code>OAuthConfiguration.java</code>**：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuthConfiguration</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients</span><br><span class="line">        .inMemory()</span><br><span class="line">        .withClient(<span class="string">&quot;zuul_server&quot;</span>)</span><br><span class="line">        .secret(<span class="string">&quot;secret&quot;</span>)</span><br><span class="line">        .scopes(<span class="string">&quot;WRIGTH&quot;</span>, <span class="string">&quot;read&quot;</span>).autoApprove(<span class="keyword">true</span>)</span><br><span class="line">        .authorities(<span class="string">&quot;WRIGTH_READ&quot;</span>, <span class="string">&quot;WRIGTH_WRITE&quot;</span>)</span><br><span class="line">        .authorizedGrantTypes(<span class="string">&quot;implicit&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        endpoints</span><br><span class="line">        .tokenStore(jwtTokenStore())</span><br><span class="line">        .tokenEnhancer(jwtTokenConverter())</span><br><span class="line">        .authenticationManager(authenticationManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">jwtTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> JwtAccessTokenConverter <span class="title">jwtTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        converter.setSigningKey(<span class="string">&quot;springcloud123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>编写主启动类：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthServerApplication</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AuthServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean(name = BeanIds.AUTHENTICATION_MANAGER)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth</span><br><span class="line">        .inMemoryAuthentication()</span><br><span class="line">        .withUser(<span class="string">&quot;guest&quot;</span>).password(<span class="string">&quot;guest&quot;</span>).authorities(<span class="string">&quot;WRIGTH_READ&quot;</span>)</span><br><span class="line">        .and()</span><br><span class="line">        .withUser(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;admin&quot;</span>).authorities(<span class="string">&quot;WRIGTH_READ&quot;</span>, <span class="string">&quot;WRIGTH_WRITE&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NoOpPasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (NoOpPasswordEncoder) NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-client-a-编写说明"><a href="#3-client-a-编写说明" class="headerlink" title="3). client-a 编写说明"></a>3). client-a 编写说明</h5><blockquote>
<p>client-a 按照规则解析 jwt token。</p>
</blockquote>
<p>具体实现：</p>
<ul>
<li>编写主启动类：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientAApplication</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ClientAApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------header----------------&quot;</span>);</span><br><span class="line">        Enumeration headerNames = request.getHeaderNames();</span><br><span class="line">        <span class="keyword">while</span> (headerNames.hasMoreElements()) &#123;</span><br><span class="line">            String key = (String) headerNames.nextElement();</span><br><span class="line">            System.out.println(key + <span class="string">&quot;: &quot;</span> + request.getHeader(key));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------header----------------&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hellooooooooooooooo!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">        .csrf().disable()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/**&quot;</span>).authenticated()</span><br><span class="line">        .antMatchers(HttpMethod.GET, <span class="string">&quot;/test&quot;</span>)</span><br><span class="line">        .hasAuthority(<span class="string">&quot;WRIGTH_READ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        resources</span><br><span class="line">        .resourceId(<span class="string">&quot;WRIGTH&quot;</span>)</span><br><span class="line">        .tokenStore(jwtTokenStore());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> JwtAccessTokenConverter <span class="title">jwtTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        converter.setSigningKey(<span class="string">&quot;springcloud123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">jwtTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-3-5-Zuul-限流"><a href="#6-3-5-Zuul-限流" class="headerlink" title="6.3.5 Zuul 限流"></a>6.3.5 Zuul 限流</h3><blockquote>
<p>应对异常流量有许多方法，如：降级处理、限流、流量排队、分流等。</p>
</blockquote>
<h4 id="限流算法"><a href="#限流算法" class="headerlink" title="限流算法"></a>限流算法</h4><h5 id="漏桶（Leaky-Bucket）"><a href="#漏桶（Leaky-Bucket）" class="headerlink" title="漏桶（Leaky Bucket）"></a>漏桶（Leaky Bucket）</h5><p>漏桶算法能够强制限定流量速率，溢出的流量并非完全丢弃。可将这部分流量收集到一个队列里，做<strong>流量排队</strong>，尽量做到合理利用资源。</p>
<h5 id="令牌桶（Token-Bucket）"><a href="#令牌桶（Token-Bucket）" class="headerlink" title="令牌桶（Token Bucket）"></a>令牌桶（Token Bucket）</h5><p>&nbsp; 令牌包装着数据流。当数据流涌来时，如果取到令牌则放行，同时桶内丢弃掉这个令牌；如果不能取到令牌，请求则会被丢弃。<br>&nbsp; 令牌桶可以存在一定程度的流量突发。因为令牌桶可以存在一定数量的令牌，且令牌一直以恒定速率加入。</p>
<blockquote>
<p><code>&amp;nbsp;</code>代表 No-Break Space</p>
</blockquote>
<h4 id="限流实战"><a href="#限流实战" class="headerlink" title="限流实战"></a>限流实战</h4><blockquote>
<p>利用 <a target="_blank" rel="noopener" href="http://github.com/marcosbarbero/spring-cloud-zuul-ratelimit">spring-cloud-zuul-ratelimit</a></p>
</blockquote>
<h5 id="zuul-server-编写说明"><a href="#zuul-server-编写说明" class="headerlink" title="zuul-server 编写说明"></a>zuul-server 编写说明</h5><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.marcosbarbero.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-zuul-ratelimit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul-server</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5555</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.host:127.0.0.1&#125;:$&#123;eureka.port:8888&#125;/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">client-a:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/client/**</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">client-a</span></span><br><span class="line">  <span class="attr">ratelimit:</span></span><br><span class="line">    <span class="attr">key-prefix:</span> <span class="string">springcloud-book</span> <span class="comment">#按粒度拆分的临时变量key前缀</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#启用开关</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">IN_MEMORY</span> <span class="comment">#key存储类型，默认是IN_MEMORY本地内存，此外还有多种形式</span></span><br><span class="line">    <span class="attr">behind-proxy:</span> <span class="literal">true</span> <span class="comment">#表示代理之后</span></span><br><span class="line">    <span class="attr">default-policy:</span> <span class="comment">#全局限流策略，可单独细化到服务粒度</span></span><br><span class="line">      <span class="attr">limit:</span> <span class="number">2</span> <span class="comment">#在一个单位时间窗口的请求数量</span></span><br><span class="line">      <span class="attr">quota:</span> <span class="number">1</span> <span class="comment">#在一个单位时间窗口的请求时间限制</span></span><br><span class="line">      <span class="attr">refresh-interval:</span> <span class="number">3</span> <span class="comment">#单位时间窗口</span></span><br><span class="line">      <span class="attr">type:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">user</span> <span class="comment">#可指定用户粒度</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">origin</span> <span class="comment">#可指定客户端地址粒度</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">url</span> <span class="comment">#可指定url粒度</span></span><br></pre></td></tr></table></figure>

<p>当流量超限时，会返回 Too Many Reqeusts 429 状态码。</p>
<h3 id="6-3-6-Zuul-动态路由"><a href="#6-3-6-Zuul-动态路由" class="headerlink" title="6.3.6 Zuul 动态路由"></a>6.3.6 Zuul 动态路由</h3><blockquote>
</blockquote>
<h3 id="6-3-7-Zuul-灰度发布"><a href="#6-3-7-Zuul-灰度发布" class="headerlink" title="6.3.7 Zuul 灰度发布"></a>6.3.7 Zuul 灰度发布</h3><blockquote>
</blockquote>
<h3 id="6-3-8-Zuul-文件上传"><a href="#6-3-8-Zuul-文件上传" class="headerlink" title="6.3.8 Zuul 文件上传"></a>6.3.8 Zuul 文件上传</h3><blockquote>
</blockquote>
<h3 id="6-3-8-Zuul-实用小技巧"><a href="#6-3-8-Zuul-实用小技巧" class="headerlink" title="6.3.8 Zuul 实用小技巧"></a>6.3.8 Zuul 实用小技巧</h3><h4 id="饥饿加载"><a href="#饥饿加载" class="headerlink" title="饥饿加载"></a>饥饿加载</h4><h4 id="请求体修改"><a href="#请求体修改" class="headerlink" title="请求体修改"></a>请求体修改</h4><h4 id="使用-okhttp-代替-HttpClient"><a href="#使用-okhttp-代替-HttpClient" class="headerlink" title="使用 okhttp 代替 HttpClient"></a>使用 okhttp 代替 HttpClient</h4><h4 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h4><h4 id="Header-传递"><a href="#Header-传递" class="headerlink" title="Header 传递"></a>Header 传递</h4><h4 id="整合-Swagger2-调试源服务"><a href="#整合-Swagger2-调试源服务" class="headerlink" title="整合 Swagger2 调试源服务"></a>整合 Swagger2 调试源服务</h4><h1 id="第-7-章-生产环境各组件参考配置"><a href="#第-7-章-生产环境各组件参考配置" class="headerlink" title="第 7 章 生产环境各组件参考配置"></a>第 7 章 生产环境各组件参考配置</h1><h2 id="7-1-Eureka-推荐配置"><a href="#7-1-Eureka-推荐配置" class="headerlink" title="7.1 Eureka 推荐配置"></a>7.1 Eureka 推荐配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eureka server</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">        <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">30000</span> <span class="comment"># 主动失效检测间隔，默认 60s，可以设置短一点。</span></span><br></pre></td></tr></table></figure>

<h2 id="7-2-Ribbon-推荐配置"><a href="#7-2-Ribbon-推荐配置" class="headerlink" title="7.2 Ribbon 推荐配置"></a>7.2 Ribbon 推荐配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">5000</span> <span class="comment"># 全局请求连接的超时时间，默认 5 秒。</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">5000</span>    <span class="comment"># 全局请求的超时时间，默认 5 秒。</span></span><br><span class="line">    <span class="attr">MaxAutoRetries:</span> <span class="number">0</span>    <span class="comment"># 对当前实例的重试次数。</span></span><br><span class="line">    <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">0</span>     <span class="comment"># 切换下一个实例重试次数。</span></span><br><span class="line">    <span class="attr">OktoRetryOnAllOperations:</span> <span class="literal">false</span> <span class="comment"># 对所有操作请求进行重试。</span></span><br></pre></td></tr></table></figure>

<h2 id="7-3-Hystrix-推荐配置"><a href="#7-3-Hystrix-推荐配置" class="headerlink" title="7.3 Hystrix 推荐配置"></a>7.3 Hystrix 推荐配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">        <span class="attr">default:</span></span><br><span class="line">            <span class="attr">executino:</span></span><br><span class="line">                <span class="attr">isolation:</span></span><br><span class="line">                    <span class="attr">thread:</span></span><br><span class="line">                        <span class="attr">timeoutInMilliseconds:</span> <span class="number">10000</span> <span class="comment"># 全局请求连接的超时时间默认为 1s，通常会调整这个值的大小，推荐设为 10s。若请求需要的时间过长则对单个 command 设置单独时间。</span></span><br></pre></td></tr></table></figure>

<h2 id="7-4-Zuul-推荐配置"><a href="#7-4-Zuul-推荐配置" class="headerlink" title="7.4 Zuul 推荐配置"></a>7.4 Zuul 推荐配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">ribbonIsolationStrategy:</span> <span class="string">THREAD</span></span><br><span class="line">  <span class="attr">threadPool:</span></span><br><span class="line">    <span class="attr">useSeparateThreadPools:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">threadPoolKeyPrefix:</span> <span class="string">zuulgateway</span></span><br><span class="line">  <span class="attr">max:</span></span><br><span class="line">    <span class="attr">host:</span></span><br><span class="line">      <span class="attr">max-per-route-connections:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">max-total-connections:</span> <span class="number">500</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line">    <span class="attr">socket-timeout-millis:</span> <span class="number">5000</span></span><br><span class="line">    <span class="attr">connect-timeout-millis:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">threadpool:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">maximumSize:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">maxQueueSize:</span> <span class="number">-1</span></span><br><span class="line">      <span class="attr">allowMaximumSizeToDivergeFromCoreSize:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">timeout:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">interruptOnTimeout:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">15000</span></span><br></pre></td></tr></table></figure>

<h1 id="第-8-章-Spring-Cloud-Config"><a href="#第-8-章-Spring-Cloud-Config" class="headerlink" title="第 8 章 Spring Cloud Config"></a>第 8 章 Spring Cloud Config</h1><h2 id="8-1-Spring-Cloud-Config-入门案例"><a href="#8-1-Spring-Cloud-Config-入门案例" class="headerlink" title="8.1 Spring Cloud Config 入门案例"></a>8.1 Spring Cloud Config 入门案例</h2><ol>
<li>Config Server 配置</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/zhongzunfa/spring-cloud-config.git</span> <span class="comment"># 项目地址</span></span><br><span class="line">          <span class="comment">#username:</span></span><br><span class="line">          <span class="comment">#password:</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">SC-BOOK-CONFIG</span> <span class="comment"># 配置文件的路径</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sc-config-git</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Config Client 配置</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">            <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">            <span class="attr">uri:</span> <span class="string">http://localhost:9090</span></span><br><span class="line">            <span class="comment"># 配置文件名：config-info-dev.yml</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">config-info</span></span><br><span class="line">            <span class="attr">profile:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
<p><code>ConfigInfoProperties.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;cn.springcloud.book&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigInfoProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String config;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfig</span><span class="params">(String config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-2-结合-Spring-Cloud-bus-热刷新"><a href="#8-2-结合-Spring-Cloud-bus-热刷新" class="headerlink" title="8.2 结合 Spring Cloud bus 热刷新"></a>8.2 结合 Spring Cloud bus 热刷新</h2><h3 id="8-2-1-config-server-bus"><a href="#8-2-1-config-server-bus" class="headerlink" title="8.2.1 config-server-bus"></a>8.2.1 config-server-bus</h3><p>pom.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-monitor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 需要安装 rabbitmq --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 做简单的安全和端点开放 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>SecurityConfiguration.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>application.properties:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>application.yml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/zhongzunfa/spring-cloud-config.git</span></span><br><span class="line">          <span class="comment">#username:</span></span><br><span class="line">          <span class="comment">#password:</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">SC-BOOK-CONFIG</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">bus:</span></span><br><span class="line">      <span class="attr">trace:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ch11-3-config-server-bus</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## 配置rabbitMQ 信息</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8-2-2-config-client-bus-refresh"><a href="#8-2-2-config-client-bus-refresh" class="headerlink" title="8.2.2 config-client-bus-refresh"></a>8.2.2 config-client-bus-refresh</h3><p>pom.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 做简单的安全和端点开放 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bootstrap.yml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">            <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">            <span class="attr">uri:</span> <span class="string">http://localhost:9090</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">config-info</span></span><br><span class="line">            <span class="attr">profile:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>application.yml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9095</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ch11-3-config-client-bus-refresh</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## 配置rabbitMQ 信息</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">      <span class="attr">bus:</span></span><br><span class="line">        <span class="attr">trace:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>ConfigClientController.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;configConsumer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigInfoProperties configInfoValue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getConfigInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfoValue.getConfig();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行服务端的端点 bus-refresh，地址为 <a target="_blank" rel="noopener" href="http://localhost:9090/actuator/bus-refresh">http://localhost:9090/actuator/bus-refresh</a></p>
<p>可将其挂在 webhooks 上。</p>
<h2 id="8-3-数据库的配置中心的实现"><a href="#8-3-数据库的配置中心的实现" class="headerlink" title="8.3 数据库的配置中心的实现"></a>8.3 数据库的配置中心的实现</h2><h3 id="8-3-1-MySQL-实现"><a href="#8-3-1-MySQL-实现" class="headerlink" title="8.3.1 MySQL 实现"></a>8.3.1 MySQL 实现</h3><p><strong>project of config-server-db:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ch12-3-config-server-db</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">jdbc:</span></span><br><span class="line">          <span class="attr">sql:</span> <span class="string">SELECT</span> <span class="string">`KEY`,</span> <span class="string">`VALUE`</span> <span class="string">FROM</span> <span class="string">PROPERTIES</span> <span class="string">WHERE</span> <span class="string">application</span> <span class="string">=?</span> <span class="string">AND</span> <span class="string">profile</span> <span class="string">=?</span> <span class="string">AND</span> <span class="string">lable</span> <span class="string">=?</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">refresh:</span></span><br><span class="line">        <span class="attr">refreshable:</span> <span class="string">none</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">jdbc</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## 数据配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/spring-cloud?useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.springframework.jdbc.core:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="attr">org.springframework.jdbc.core.StatementCreatorUtils:</span> <span class="string">Trace</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>project of config-client-db:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">            <span class="comment"># name, profile，label（按顺序） 是 sql 中的参数。</span></span><br><span class="line">            <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">            <span class="attr">uri:</span> <span class="string">http://localhost:9090</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">config-info</span></span><br><span class="line">            <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8-3-2-MongoDB-实现"><a href="#8-3-2-MongoDB-实现" class="headerlink" title="8.3.2 MongoDB 实现"></a>8.3.2 MongoDB 实现</h3><p><strong>project of config-server-mongodb:</strong></p>
<p>pom.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.2.BUILD-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ch12-4-config-server-mongodb</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">      <span class="attr">mongodb:</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">mongodb://localhost/springcloud</span></span><br></pre></td></tr></table></figure>

<p>Application.java: 增加<code>@EnableMongoConfigServer</code>注解。</p>
<p><strong>project of config-client-mongodb:</strong></p>
<p>略</p>
<h1 id="第-9-章-Spring-Cloud-认证和鉴权"><a href="#第-9-章-Spring-Cloud-认证和鉴权" class="headerlink" title="第 9 章 Spring Cloud 认证和鉴权"></a>第 9 章 Spring Cloud 认证和鉴权</h1><h2 id="9-1-认证和鉴权方案"><a href="#9-1-认证和鉴权方案" class="headerlink" title="9.1 认证和鉴权方案"></a>9.1 认证和鉴权方案</h2><h3 id="9-1-1-单体应用下的常用方案"><a href="#9-1-1-单体应用下的常用方案" class="headerlink" title="9.1.1 单体应用下的常用方案"></a>9.1.1 单体应用下的常用方案</h3><p>在传统的单体应用中，一般会写一个固定的认证和鉴权的包（利用shiro等），里面包含了很多认证和鉴权的类，当用户发起请求时可以利用 session 的方式，把用户存入 session 并生成一个 sessionId，之后返回客户端。客户端可以将 session 信息存在 Cookie 里，从而在后续的请求中顺利通过验证。</p>
<h3 id="9-1-2-微服务下-SSO-单点登录方案"><a href="#9-1-2-微服务下-SSO-单点登录方案" class="headerlink" title="9.1.2 微服务下 SSO 单点登录方案"></a>9.1.2 微服务下 SSO 单点登录方案</h3><p>对每个微服务都采用 SSO 单点登录方案。</p>
<h3 id="9-1-3-分布式-Session-与网关结合方案"><a href="#9-1-3-分布式-Session-与网关结合方案" class="headerlink" title="9.1.3 分布式 Session 与网关结合方案"></a>9.1.3 分布式 Session 与网关结合方案</h3><p>Step：</p>
<ol>
<li><p>用户在网关进行 SSO 登录，进行用户认证，检查用户是否存在和有效。</p>
</li>
<li><p>如果认证通过，则将用户的信息或数据存储在第三方部件中（如 MySQL，Redis）。</p>
</li>
<li><p>后端微服务可以从共享存储中拿到用户的数据。</p>
</li>
</ol>
<p>推荐方案，因为方便同时可以做扩展，也可以保证高可用的方案（数据库集群），不过需要增加安全控制，所以实现起来有一定复杂性。</p>
<h3 id="9-1-4-客户端-Token-与网关结合方案"><a href="#9-1-4-客户端-Token-与网关结合方案" class="headerlink" title="9.1.4 客户端 Token 与网关结合方案"></a>9.1.4 客户端 Token 与网关结合方案</h3><p>Step：</p>
<ol>
<li><p>客户端持有一个 Token，通常可用 JWT 或者其他加密的算法实现自己的一种 Token，然后通过 Token 保存了用户的信息。</p>
</li>
<li><p>发起请求并携带 Token， Token 传到网关层后，网关层进行认证和校验。</p>
</li>
<li><p>校验通过，携带 Token 到后台的微服务中，可以进行具体的接口或者 url 验证。</p>
</li>
<li><p>如果要涉及用户的大量数据存放，则 Token 就有可能不大合适，或者和上面的分布式 Session 一样，使用第三方部件来存储这些信息，这种方案也是业界常用的方案，但对于 Token 来说，它的注销有点麻烦，需要在网关层进行 Token 的注销。</p>
</li>
</ol>
<h3 id="9-1-5-浏览器-Cookie-与网关结合方案"><a href="#9-1-5-浏览器-Cookie-与网关结合方案" class="headerlink" title="9.1.5 浏览器 Cookie 与网关结合方案"></a>9.1.5 浏览器 Cookie 与网关结合方案</h3><p>把用户信息存在 Cookie 里，然后通过网关来解析 Cookie，从而获得用户相关的信息。适合作为老系统改造时采取的方案。</p>
<h3 id="9-1-6-网关与-Token-和服务间鉴权结合"><a href="#9-1-6-网关与-Token-和服务间鉴权结合" class="headerlink" title="9.1.6 网关与 Token 和服务间鉴权结合"></a>9.1.6 网关与 Token 和服务间鉴权结合</h3><p>Step:</p>
<ol>
<li><p>在 Gateway 网关层做认证，通过对用户校验后，传递用户的信息到 header 中， 后台微服务在收到 header 后进行解析，解析完后查看是否有调用此服务或者某个 url 的权限，然后完成鉴权。</p>
</li>
<li><p>从服务内部发出的请求，在出去时进行拦截，把用户信息保存在 header 里，然后传出去，被调用方法获取到 header 后进行解析和鉴权。</p>
</li>
</ol>
<h2 id="9-2-还有一个看不懂的案例…"><a href="#9-2-还有一个看不懂的案例…" class="headerlink" title="9.2 还有一个看不懂的案例…"></a>9.2 还有一个看不懂的案例…</h2><h1 id="第-10-章-Spring-Cloud-全链路监控-（omission）"><a href="#第-10-章-Spring-Cloud-全链路监控-（omission）" class="headerlink" title="第 10 章 Spring Cloud 全链路监控 （omission）"></a>第 10 章 Spring Cloud 全链路监控 （omission）</h1><h2 id="10-1-术语"><a href="#10-1-术语" class="headerlink" title="10.1 术语"></a>10.1 术语</h2><ul>
<li>Span：基本工作单元。</li>
<li>Trace： 一系列 Span 组成的树状结构。</li>
<li>Annotation：标注，用来描述事件的实时状态。<ul>
<li>cs：Client Sent。客户端发起请求，它表示一个 Span 的开始。</li>
<li>sr：Server Received。服务方收到请求并开始处理，它减去 cs 的时间就是网络延迟时间。</li>
<li>ss：Server Sent。请求处理完成，将响应数据返回给客户端。它减去 sr 的时间就是服务方处理时间。</li>
<li>cr：Client Received。客户端收到服务方的返回值，是当前 Span 结束的信号。</li>
</ul>
</li>
</ul>
<h1 id="第-11-章-Spring-Cloud-Gateway"><a href="#第-11-章-Spring-Cloud-Gateway" class="headerlink" title="第 11 章 Spring Cloud Gateway"></a>第 11 章 Spring Cloud Gateway</h1><h1 id="第-12-章-Spring-Cloud-与-gRPC"><a href="#第-12-章-Spring-Cloud-与-gRPC" class="headerlink" title="第 12 章 Spring Cloud 与 gRPC"></a>第 12 章 Spring Cloud 与 gRPC</h1><h2 id="12-1-gRPC-比-HTTP-JSON-客户端的性能更好的原因"><a href="#12-1-gRPC-比-HTTP-JSON-客户端的性能更好的原因" class="headerlink" title="12.1 gRPC 比 HTTP/JSON 客户端的性能更好的原因"></a>12.1 gRPC 比 HTTP/JSON 客户端的性能更好的原因</h2><ol>
<li><p>gRPC 采用了 Protocol Buffers 作为序列化工具，这比采用 JSON 方式进行序列化性能提高了不少。</p>
</li>
<li><p>gRPC 采用了 HTTP2 协议，进行了<strong>头部信息压缩</strong>，对连接进行了<strong>多路复用</strong>，减少了 TCP 的(短)连接次数。</p>
</li>
<li><p>gRPC 采用了 Netty 作为 IO 处理框架，提高了性能。</p>
</li>
</ol>
<p>HTTP2 是一个二进制协议，HTTP1.x 是文本协议。</p>
<h2 id="12-2-gRPC-的一些核心概念"><a href="#12-2-gRPC-的一些核心概念" class="headerlink" title="12.2 gRPC 的一些核心概念"></a>12.2 gRPC 的一些核心概念</h2><h3 id="12-2-1-服务定义"><a href="#12-2-1-服务定义" class="headerlink" title="12.2.1 服务定义"></a>12.2.1 服务定义</h3><p>gRPC 可以定义 4 种服务方法：</p>
<ol>
<li><p>Unary RPCS</p>
</li>
<li><p>Server streaming RPCS</p>
</li>
<li><p>Client streaming RPCS</p>
</li>
<li><p>Bidirectional streaming RPCS</p>
</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>Spring Cloud</p><p><a href="https://teamwang.cn/2021/03/04/SpringCloud/">https://teamwang.cn/2021/03/04/SpringCloud/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Jacky</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-03-04</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-10-29</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/03/05/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">设计模式</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/03/02/JVM/"><span class="level-item">Java虚拟机 (JVM)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "D7nrmJ3xSHla6mxR3p0BrXqD-gzGzoHsz",
            appKey: "rGXO6glIn8ETvzytN7maFaoP",
            placeholder: "Leave your comments~",
            
            
            meta: ["nick"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            enableQQ: true,
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#第-1-章-微服务与SC"><span class="level-left"><span class="level-item">第 1 章 微服务与SC</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-微服务架构技术栈"><span class="level-left"><span class="level-item">1.1 微服务架构技术栈</span></span></a></li><li><a class="level is-mobile" href="#1-2-架构演变"><span class="level-left"><span class="level-item">1.2 架构演变</span></span></a></li><li><a class="level is-mobile" href="#1-3-SpringCloud-D版中文文档"><span class="level-left"><span class="level-item">1.3 SpringCloud D版中文文档</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第-2-章-Eureka"><span class="level-left"><span class="level-item">第 2 章 Eureka</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-服务的核心操作"><span class="level-left"><span class="level-item">2.1 服务的核心操作</span></span></a></li><li><a class="level is-mobile" href="#2-2-分布式系统的复制方式"><span class="level-left"><span class="level-item">2.2 分布式系统的复制方式</span></span></a></li><li><a class="level is-mobile" href="#2-3-CAP理论在Eureka中的体现"><span class="level-left"><span class="level-item">2.3 CAP理论在Eureka中的体现</span></span></a></li><li><a class="level is-mobile" href="#2-4-Eureka的配置"><span class="level-left"><span class="level-item">2.4 Eureka的配置</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第-3-章-Feign"><span class="level-left"><span class="level-item">第 3 章 Feign</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-概述"><span class="level-left"><span class="level-item">3.1 概述</span></span></a></li><li><a class="level is-mobile" href="#3-2-特性"><span class="level-left"><span class="level-item">3.2 特性</span></span></a></li><li><a class="level is-mobile" href="#3-3-Feign-的基础用法"><span class="level-left"><span class="level-item">3.3 Feign 的基础用法</span></span></a></li><li><a class="level is-mobile" href="#3-4-Feign-的基础功能"><span class="level-left"><span class="level-item">3.4 Feign 的基础功能</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-4-1-FeignClient-注解"><span class="level-left"><span class="level-item">3.4.1 @FeignClient 注解</span></span></a></li><li><a class="level is-mobile" href="#3-4-2-Feign-开启-GZIP-压缩"><span class="level-left"><span class="level-item">3.4.2 Feign 开启 GZIP 压缩</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#第-4-章-Ribbon"><span class="level-left"><span class="level-item">第 4 章 Ribbon</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-Ribbon的基本用法"><span class="level-left"><span class="level-item">4.1 Ribbon的基本用法</span></span></a></li><li><a class="level is-mobile" href="#4-2-Ribbon负载均衡策略与自定义配置"><span class="level-left"><span class="level-item">4.2 Ribbon负载均衡策略与自定义配置</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-2-1-策略详解"><span class="level-left"><span class="level-item">4.2.1 策略详解</span></span></a></li><li><a class="level is-mobile" href="#4-2-2-代码实现"><span class="level-left"><span class="level-item">4.2.2 代码实现</span></span></a></li><li><a class="level is-mobile" href="#4-2-3-策略设置"><span class="level-left"><span class="level-item">4.2.3 策略设置</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-3-Ribbon-进阶"><span class="level-left"><span class="level-item">4.3 Ribbon 进阶</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-3-1-Ribbon-的核心接口"><span class="level-left"><span class="level-item">4.3.1 Ribbon 的核心接口</span></span></a></li><li><a class="level is-mobile" href="#4-3-2-RestTemplate-达到负载均衡的原理"><span class="level-left"><span class="level-item">4.3.2 RestTemplate 达到负载均衡的原理</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#第-5-章-Hystrix-Defend-your-APP"><span class="level-left"><span class="level-item">第 5 章 Hystrix - Defend your APP</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-1-设计目标"><span class="level-left"><span class="level-item">5.1 设计目标</span></span></a></li><li><a class="level is-mobile" href="#5-2-Hystrix-的基本用法"><span class="level-left"><span class="level-item">5.2 Hystrix 的基本用法</span></span></a></li><li><a class="level is-mobile" href="#5-3-Hystrix-Dashboard"><span class="level-left"><span class="level-item">5.3 Hystrix Dashboard</span></span></a></li><li><a class="level is-mobile" href="#5-4-Turbine-聚合-Hystrix"><span class="level-left"><span class="level-item">5.4 Turbine 聚合 Hystrix</span></span></a></li><li><a class="level is-mobile" href="#5-5-Hystrix-详解"><span class="level-left"><span class="level-item">5.5 Hystrix 详解</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-5-1-Hystrix-异常机制和处理"><span class="level-left"><span class="level-item">5.5.1 Hystrix 异常机制和处理</span></span></a></li><li><a class="level is-mobile" href="#5-5-2-Hystrix-配置说明"><span class="level-left"><span class="level-item">5.5.2 Hystrix 配置说明</span></span></a></li><li><a class="level is-mobile" href="#5-5-3-Hystrix-线程调整和计算"><span class="level-left"><span class="level-item">5.5.3 Hystrix 线程调整和计算</span></span></a></li><li><a class="level is-mobile" href="#5-5-4-Hystrix-请求缓存"><span class="level-left"><span class="level-item">5.5.4 Hystrix 请求缓存</span></span></a></li><li><a class="level is-mobile" href="#5-5-5-Hystrix-Request-Collapser"><span class="level-left"><span class="level-item">5.5.5 Hystrix Request Collapser</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#第-6-章-Zuul"><span class="level-left"><span class="level-item">第 6 章 Zuul</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-简介"><span class="level-left"><span class="level-item">6.1 简介</span></span></a></li><li><a class="level is-mobile" href="#6-2-Zuul-的快速入门"><span class="level-left"><span class="level-item">6.2 Zuul 的快速入门</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-2-1-基本配置"><span class="level-left"><span class="level-item">6.2.1 基本配置</span></span></a></li><li><a class="level is-mobile" href="#6-2-2-路由通配符"><span class="level-left"><span class="level-item">6.2.2 路由通配符</span></span></a></li><li><a class="level is-mobile" href="#6-2-3-功能配置"><span class="level-left"><span class="level-item">6.2.3 功能配置</span></span></a></li></ul></li><li><a class="level is-mobile" href="#6-3-Zuul-进阶"><span class="level-left"><span class="level-item">6.3 Zuul 进阶</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-3-1-Zuul-Filter-链"><span class="level-left"><span class="level-item">6.3.1 Zuul Filter 链</span></span></a></li><li><a class="level is-mobile" href="#6-3-2-Zuul-Filter-和-Actuator"><span class="level-left"><span class="level-item">6.3.2 Zuul Filter 和 Actuator</span></span></a></li><li><a class="level is-mobile" href="#6-3-3-多级业务处理"><span class="level-left"><span class="level-item">6.3.3 多级业务处理</span></span></a></li><li><a class="level is-mobile" href="#6-3-4-Zuul-权限集成"><span class="level-left"><span class="level-item">6.3.4 Zuul 权限集成</span></span></a></li><li><a class="level is-mobile" href="#6-3-5-Zuul-限流"><span class="level-left"><span class="level-item">6.3.5 Zuul 限流</span></span></a></li><li><a class="level is-mobile" href="#6-3-6-Zuul-动态路由"><span class="level-left"><span class="level-item">6.3.6 Zuul 动态路由</span></span></a></li><li><a class="level is-mobile" href="#6-3-7-Zuul-灰度发布"><span class="level-left"><span class="level-item">6.3.7 Zuul 灰度发布</span></span></a></li><li><a class="level is-mobile" href="#6-3-8-Zuul-文件上传"><span class="level-left"><span class="level-item">6.3.8 Zuul 文件上传</span></span></a></li><li><a class="level is-mobile" href="#6-3-8-Zuul-实用小技巧"><span class="level-left"><span class="level-item">6.3.8 Zuul 实用小技巧</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#第-7-章-生产环境各组件参考配置"><span class="level-left"><span class="level-item">第 7 章 生产环境各组件参考配置</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#7-1-Eureka-推荐配置"><span class="level-left"><span class="level-item">7.1 Eureka 推荐配置</span></span></a></li><li><a class="level is-mobile" href="#7-2-Ribbon-推荐配置"><span class="level-left"><span class="level-item">7.2 Ribbon 推荐配置</span></span></a></li><li><a class="level is-mobile" href="#7-3-Hystrix-推荐配置"><span class="level-left"><span class="level-item">7.3 Hystrix 推荐配置</span></span></a></li><li><a class="level is-mobile" href="#7-4-Zuul-推荐配置"><span class="level-left"><span class="level-item">7.4 Zuul 推荐配置</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第-8-章-Spring-Cloud-Config"><span class="level-left"><span class="level-item">第 8 章 Spring Cloud Config</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#8-1-Spring-Cloud-Config-入门案例"><span class="level-left"><span class="level-item">8.1 Spring Cloud Config 入门案例</span></span></a></li><li><a class="level is-mobile" href="#8-2-结合-Spring-Cloud-bus-热刷新"><span class="level-left"><span class="level-item">8.2 结合 Spring Cloud bus 热刷新</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#8-2-1-config-server-bus"><span class="level-left"><span class="level-item">8.2.1 config-server-bus</span></span></a></li><li><a class="level is-mobile" href="#8-2-2-config-client-bus-refresh"><span class="level-left"><span class="level-item">8.2.2 config-client-bus-refresh</span></span></a></li></ul></li><li><a class="level is-mobile" href="#8-3-数据库的配置中心的实现"><span class="level-left"><span class="level-item">8.3 数据库的配置中心的实现</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#8-3-1-MySQL-实现"><span class="level-left"><span class="level-item">8.3.1 MySQL 实现</span></span></a></li><li><a class="level is-mobile" href="#8-3-2-MongoDB-实现"><span class="level-left"><span class="level-item">8.3.2 MongoDB 实现</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#第-9-章-Spring-Cloud-认证和鉴权"><span class="level-left"><span class="level-item">第 9 章 Spring Cloud 认证和鉴权</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#9-1-认证和鉴权方案"><span class="level-left"><span class="level-item">9.1 认证和鉴权方案</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#9-1-1-单体应用下的常用方案"><span class="level-left"><span class="level-item">9.1.1 单体应用下的常用方案</span></span></a></li><li><a class="level is-mobile" href="#9-1-2-微服务下-SSO-单点登录方案"><span class="level-left"><span class="level-item">9.1.2 微服务下 SSO 单点登录方案</span></span></a></li><li><a class="level is-mobile" href="#9-1-3-分布式-Session-与网关结合方案"><span class="level-left"><span class="level-item">9.1.3 分布式 Session 与网关结合方案</span></span></a></li><li><a class="level is-mobile" href="#9-1-4-客户端-Token-与网关结合方案"><span class="level-left"><span class="level-item">9.1.4 客户端 Token 与网关结合方案</span></span></a></li><li><a class="level is-mobile" href="#9-1-5-浏览器-Cookie-与网关结合方案"><span class="level-left"><span class="level-item">9.1.5 浏览器 Cookie 与网关结合方案</span></span></a></li><li><a class="level is-mobile" href="#9-1-6-网关与-Token-和服务间鉴权结合"><span class="level-left"><span class="level-item">9.1.6 网关与 Token 和服务间鉴权结合</span></span></a></li></ul></li><li><a class="level is-mobile" href="#9-2-还有一个看不懂的案例…"><span class="level-left"><span class="level-item">9.2 还有一个看不懂的案例…</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第-10-章-Spring-Cloud-全链路监控-（omission）"><span class="level-left"><span class="level-item">第 10 章 Spring Cloud 全链路监控 （omission）</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#10-1-术语"><span class="level-left"><span class="level-item">10.1 术语</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第-11-章-Spring-Cloud-Gateway"><span class="level-left"><span class="level-item">第 11 章 Spring Cloud Gateway</span></span></a></li><li><a class="level is-mobile" href="#第-12-章-Spring-Cloud-与-gRPC"><span class="level-left"><span class="level-item">第 12 章 Spring Cloud 与 gRPC</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#12-1-gRPC-比-HTTP-JSON-客户端的性能更好的原因"><span class="level-left"><span class="level-item">12.1 gRPC 比 HTTP/JSON 客户端的性能更好的原因</span></span></a></li><li><a class="level is-mobile" href="#12-2-gRPC-的一些核心概念"><span class="level-left"><span class="level-item">12.2 gRPC 的一些核心概念</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#12-2-1-服务定义"><span class="level-left"><span class="level-item">12.2.1 服务定义</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Jacky"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Jacky</p><p class="is-size-6 is-block">(ง ˙o˙)ว</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">33</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">1</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cloris-cc"><i class="fab fa-github"></i></a></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><p class="is-size-7"><span>&copy; 2021 Jacky</span>  <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备19098392号</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/"><i class="fab fa-weibo"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/cloris-cc"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>