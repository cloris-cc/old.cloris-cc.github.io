<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>搭建轻量级 JavaWeb 框架 - 茶茶日记 - winklog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="茶茶日记 - winklog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="茶茶日记 - winklog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="这是一个基于mvc模式的轻量java web框架，实现了基本的IOC、AOP等功能。"><meta property="og:type" content="blog"><meta property="og:title" content="搭建轻量级 JavaWeb 框架"><meta property="og:url" content="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/"><meta property="og:site_name" content="茶茶日记 - winklog"><meta property="og:description" content="这是一个基于mvc模式的轻量java web框架，实现了基本的IOC、AOP等功能。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/7f062488-350f-42c9-8c01-0adfc4281294.png"><meta property="og:image" content="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/c9847352-8d61-4e26-89b1-825f631000dd.png"><meta property="og:image" content="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/286d8455-bf00-41e0-81f6-efaa47dff84f.png"><meta property="og:image" content="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/049249c4-135d-476d-8fe1-98fe060a4fbe.png"><meta property="og:image" content="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/2b596f6e-9bb1-4e1f-b759-b3b8945e83a8.png"><meta property="og:image" content="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/d9f91af3-df00-4d17-95ac-df75c96ec507.png"><meta property="og:image" content="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/f45b17d1-482a-41a9-b7a6-3a9dd0b28036.png"><meta property="article:published_time" content="2021-02-24T20:02:21.000Z"><meta property="article:modified_time" content="2021-03-05T04:32:16.004Z"><meta property="article:author" content="Jacky"><meta property="article:tag" content="茶茶,日记,茶茶日记,winklog,WinkLog,博客,teamwang,TeamWang,王嘉尔,Jakcy,jacky"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/7f062488-350f-42c9-8c01-0adfc4281294.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/"},"headline":"搭建轻量级 JavaWeb 框架","image":["https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/7f062488-350f-42c9-8c01-0adfc4281294.png","https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/c9847352-8d61-4e26-89b1-825f631000dd.png","https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/286d8455-bf00-41e0-81f6-efaa47dff84f.png","https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/049249c4-135d-476d-8fe1-98fe060a4fbe.png","https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/2b596f6e-9bb1-4e1f-b759-b3b8945e83a8.png","https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/d9f91af3-df00-4d17-95ac-df75c96ec507.png","https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/f45b17d1-482a-41a9-b7a6-3a9dd0b28036.png"],"datePublished":"2021-02-24T20:02:21.000Z","dateModified":"2021-03-05T04:32:16.004Z","author":{"@type":"Person","name":"Jacky"},"description":"这是一个基于mvc模式的轻量java web框架，实现了基本的IOC、AOP等功能。"}</script><link rel="canonical" href="https://teamwang.cn/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?05af3f3bd18ffe652b63cc7ee6abb48c";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="茶茶日记 - winklog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">AboutMe</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-02-24T20:02:21.000Z" title="2/25/2021, 4:02:21 AM">2021-02-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-03-05T04:32:16.004Z" title="3/5/2021, 12:32:16 PM">2021-03-05</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span> / </span><a class="link-muted" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/Java/">Java</a></span><span class="level-item">32 minutes read (About 4730 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">搭建轻量级 JavaWeb 框架</h1><div class="content"><p>这是一个基于mvc模式的轻量java web框架，实现了基本的IOC、AOP等功能。</p>
<span id="more"></span>

<h2 id="0-前置说明"><a href="#0-前置说明" class="headerlink" title="0. 前置说明"></a>0. 前置说明</h2><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/cloris-cc/mini-mvc-framework">https://github.com/cloris-cc/mini-mvc-framework</a></p>
<blockquote>
<p>IOC(Inversion of Control)和AOP(Aspect Oriented Programming)为核心</p>
</blockquote>
<blockquote>
<p> IOC: 控制权由应用代码中转到了外部容器。即由框架(如Spring)来控制对象的生命周期和对象之间的关系，而非通过代码控制。通过依赖注入实现IOC。</p>
</blockquote>
<blockquote>
<p> AOP：封装通用逻辑为切面使用。实现技术为代理技术。</p>
</blockquote>
<blockquote>
<p>反射：程序在运行状态(RUNTIME)中，能够获取、调用任意类的方法或属性的技术。</p>
</blockquote>
<p><img src="/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/7f062488-350f-42c9-8c01-0adfc4281294.png"></p>
<p><strong>Bean的生命周期：</strong></p>
<ol>
<li>实例化（将Class实例化，即<code>cls.newInstance()</code>）</li>
<li>属性赋值（主要是给属性Bean赋值，通过反射实现</li>
<li>初始化（在 <code>DispatcherServlet</code> 中初始化，继承自<code>HttpServlet</code>）</li>
<li>销毁</li>
</ol>
<h2 id="1-基础框架搭建"><a href="#1-基础框架搭建" class="headerlink" title="1. 基础框架搭建"></a>1. 基础框架搭建</h2><h3 id="1-1-主要问题"><a href="#1-1-主要问题" class="headerlink" title="1.1 主要问题"></a>1.1 主要问题</h3><p><strong>框架读取用户项目的配置文件方式</strong> (即框架读取<code>application.yml</code>中配置项的方法):</p>
<p>文件名 =&gt; InputStream (通过classLoader实现) =&gt; properties</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码示例</span></span><br><span class="line">InputStream is = Thread.currentThread()</span><br><span class="line">    .getContextClassLoader()</span><br><span class="line">    .getResourceAsStream(fileName); <span class="comment">// fileName: application.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Properties 继承自 HashTable</span></span><br><span class="line">Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.load(is);</span><br></pre></td></tr></table></figure>

<p>ClassHelper获取Bean之后，再通过反射方式来获取实例对象。<strong>有了实例之后才能真正使用这个类对象</strong>。</p>
<p><strong>@Controller修饰的类是单例吗？@Service修饰的类是单例吗？</strong><br>@Controller修饰的类的实例变量/成员变量也需要被初始化，说明这个类的@Service的实例变量会被初始化多次？</p>
<p><strong>java中一个类实例化后，那么其中的成员变量要实例化吗？</strong></p>
<p>要，不实例化无法使用，但实例化始终只进行 1 次。类的成员属性在调用类的构造方法实例化对象的时候,如果你没有在构造方法中给这些属性赋值,这些属性都会被赋默认值,数值类型的赋值为 0, boolean 类型的赋值为 false, 引用类型赋值为 null。</p>
<p>Controller类中的被@Service修饰的实例变量，是已经被容器初始化过的，仅需给Controller类的实例变量赋值即可（赋值方式有2种：构造方法赋值、反射获取Controller类的field后再赋值）</p>
<p><strong>@RequestMapping 实现的关键：</strong><br>映射 Request 请求和 Handler 处理器的关系。</p>
<p>todo：代码示例，或者github连接</p>
<p><strong>DispatcherServlet</strong><br>前置：Servlet是什么？一个处理网络请求和响应的<strong>接口</strong>而已。源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Servlet</span> </span>&#123;  </span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig var1)</span> <span class="keyword">throws</span> ServletException</span>;  </span><br><span class="line"></span><br><span class="line"> <span class="function">ServletConfig <span class="title">getServletConfig</span><span class="params">()</span></span>;  </span><br><span class="line"></span><br><span class="line"> <span class="comment">// 由service()方法决定调用doGet，doPost等方法。  </span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest var1, ServletResponse var2)</span> <span class="keyword">throws</span> ServletException, IOException</span>;  </span><br><span class="line"></span><br><span class="line"> <span class="function">String <span class="title">getServletInfo</span><span class="params">()</span></span>;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p><img src="/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/c9847352-8d61-4e26-89b1-825f631000dd.png"></p>
<p>HttpServlet的部分代码如下：<br><img src="/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/286d8455-bf00-41e0-81f6-efaa47dff84f.png"></p>
<p>todo, 看<code>spring</code>实现的<code>dispatcherServlet</code>并对比。<br>测试完再进入第四章。（双重测试）</p>
<h3 id="1-2-开发-IOC-框架"><a href="#1-2-开发-IOC-框架" class="headerlink" title="1.2 开发 IOC 框架"></a>1.2 开发 IOC 框架</h3><p><strong>简述IOC实现步骤：</strong></p>
<blockquote>
<p>均通过反射实现<br>todo 代码示例，Service的bean赋值了吗？</p>
</blockquote>
<p>1. 扫描<strong>获取</strong>指定包名下的所有 <strong>Bean</strong>（包括jar包里面class文件的Bean，这些Bean均由自定义注解如@Controller、@Service所修饰），并保存在Set集合中（保证Bean为单例）。</p>
<ol start="2">
<li><strong>实例化所有Bean</strong>（并初始化Controller的Service实例变量）。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 获取包名下的所有类</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        getClass(<span class="string">&quot;cn.teamwang.framework.test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 获取包名下的所有类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClass(String packageName) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; clsSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取类加载器的另一种方式：Thread.currentThread().getContextClassLoader();</span></span><br><span class="line">        <span class="comment">// getResources(String name) - name路径使用/分隔符</span></span><br><span class="line">        Enumeration&lt;URL&gt; urls = ClassLoader.getSystemClassLoader()</span><br><span class="line">                .getResources(packageName.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">            URL url = urls.nextElement();</span><br><span class="line">            System.out.println(url.getProtocol());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. protocol 为 file（即class文件）</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;file&quot;</span>.equals(url.getProtocol())) &#123;</span><br><span class="line">                <span class="comment">// 过滤出名称以class结尾的文件</span></span><br><span class="line">                File[] files = <span class="keyword">new</span> File(url.getPath()).listFiles(<span class="keyword">new</span> FileFilter() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> file.getName().endsWith(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">// 反射获取class（不初始化）</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != files) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">                        <span class="comment">// eg: cn.teamwang.framework.test.Action，去掉后缀.class</span></span><br><span class="line">                        String name = packageName + <span class="string">&quot;.&quot;</span> + file.getName().substring(<span class="number">0</span>, file.getName().lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">                        System.out.println(name);</span><br><span class="line">                        <span class="comment">// 不加载内部类</span></span><br><span class="line">                        <span class="keyword">if</span> (-<span class="number">1</span> == name.lastIndexOf(<span class="string">&quot;$&quot;</span>)) &#123;</span><br><span class="line">                            Class&lt;?&gt; cls = ClassLoader.getSystemClassLoader().loadClass(name);</span><br><span class="line">                            clsSet.add(cls);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. protocol 为 jar(压缩包，故里面也有文件路径)</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;jar&quot;</span>.equals(url.getProtocol())) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;wait...&quot;</span>);</span><br><span class="line">                Enumeration&lt;JarEntry&gt; entries = ((JarURLConnection) url.openConnection()).getJarFile().entries();</span><br><span class="line">                <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">                    JarEntry jarEntry = entries.nextElement();</span><br><span class="line">                    <span class="comment">// jarEntry.getName(): cn/teamwang/framework/test/URLTest.class</span></span><br><span class="line">                    String name = jarEntry.getName().replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;.&quot;</span>)</span><br><span class="line">                            .substring(<span class="number">0</span>, jarEntry.getName().lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">                    Class&lt;?&gt; cls = ClassLoader.getSystemClassLoader().loadClass(name);</span><br><span class="line">                    clsSet.add(cls);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clsSet;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 再根据注解筛选出所有 Bean</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取应用包名下所有 Service 类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getServiceClassSet() &#123;</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(Service.class)) &#123;</span><br><span class="line">                classSet.add(cls);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> classSet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取应用包名下所有 Controller 类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getControllerClassSet() &#123;</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(Controller.class)) &#123;</span><br><span class="line">                classSet.add(cls);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> classSet;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. 实例化后放进bean容器 &amp; 赋值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ClassHelper.getBeanClassSet().forEach(i -&gt; &#123;</span><br><span class="line">            BEAN_MAP.put(i, ReflectionUtil.newInstance(i));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 1. 遍历所有 Bean 实例</span></span><br><span class="line"><span class="comment">     * 2. 遍历 Bean 的 Field，并给被 @Autowired 修饰的 Field 成员变量赋值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        BeanHelper.getBeanMap().forEach((beanClass, beanInstance) -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Field field : beanClass.getDeclaredFields()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (field.isAnnotationPresent(Autowired.class)) &#123;</span><br><span class="line">                    ReflectionUtil.setField(field.getType(), field, BeanHelper.getBean(field.getType()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-额外内容"><a href="#1-3-额外内容" class="headerlink" title="1.3 额外内容"></a>1.3 额外内容</h3><p><strong>迭代器 Iterator &amp; Enumeration</strong></p>
<p>两者均可以遍历 Set 和 List 集合（Collection 容器）。虽然Enumeration效率更高，但是Iterator更安全。因为<strong>其他线程</strong>不能够修改正在被 iterator 遍历的集合里面的对象。<br>同时，Iterator 允许调用者<strong>删除</strong>底层集合里面的元素。(foreach和enumeration都无法删除)<br>另外，Map容器的迭代器为<code>entrySet</code>。</p>
<p><strong>ClassLoader 常用方法</strong></p>
<p><img src="/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/049249c4-135d-476d-8fe1-98fe060a4fbe.png"></p>
<p>获取当前的ClassLoader也可以通过：<code>ClassLoader.getSystemClassLoader()</code></p>
<p><code>url.getProtocol</code>(协议)可以是 HTTP、HTTPS、FTP 和 File。</p>
<p>URL 解析：</p>
<ul>
<li><strong>协议为(protocol)：</strong> http</li>
<li>**主机为(host:port)**：<a target="_blank" rel="noopener" href="http://www.runoob.com/">www.runoob.com</a></li>
<li><strong>端口号为(port):</strong> 80 ，以上URL实例并未指定端口，因为 HTTP 协议默认的端口号为 80。</li>
<li><strong>文件路径为(path)：</strong>/index.html</li>
<li>**请求参数(query)**：language=cn</li>
<li><strong>定位位置(fragment)：</strong> j2se，定位到网页中 id 属性为 j2se 的 HTML 元素位置</li>
</ul>
<p>当为<strong>http</strong>时，URL为<code>http://www.runoob.com/index.html?language=cn#j2se</code>（其中<code>http</code>为 protocol）</p>
<p>当为<strong>file</strong>时，URL为<code>file:/Users/jacky/IdeaProjects/jacky-framework/framework/target/classes/cn/teamwang/framework/test</code>，下面同时给出获取该 path 下 class 文件的代码</p>
<p><code>File[] files = new File(url.getPath()).listFiles();</code></p>
<p><img src="/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/2b596f6e-9bb1-4e1f-b759-b3b8945e83a8.png"></p>
<h2 id="2-使框架具备AOP特性"><a href="#2-使框架具备AOP特性" class="headerlink" title="2. 使框架具备AOP特性"></a>2. 使框架具备AOP特性</h2><p><img src="/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/d9f91af3-df00-4d17-95ac-df75c96ec507.png"></p>
<h3 id="2-1-什么是代理"><a href="#2-1-什么是代理" class="headerlink" title="2.1 什么是代理"></a>2.1 什么是代理</h3><p>通过实现<strong>代理类</strong>，来替代对原对象的使用。主要有2种用途：</p>
<ol>
<li>中介隔离作用。不能直接使用原对象。</li>
<li>开闭原则，增加功能。如：AOP。</li>
</ol>
<p>代理技术主要有3种：静态代理、JDK动态代理、CGLib动态代理。</p>
<p>NOTE: 当方法的参数类型为Object时，说明为实例；当为Class时，说明为<code>xx.Class</code>或<code>instance.getClass()</code>。</p>
<p><strong>静态代理</strong></p>
<blockquote>
<p> 代理类所代理的方法要一个一个写。静态代理示例，如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Action</span> </span>&#123;  </span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionImpl</span> <span class="keyword">implements</span> <span class="title">Action</span></span>&#123;  </span><br><span class="line"> <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> System.out.println(<span class="string">&quot;eat&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>代理 <code>ActionImpl</code> 类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionProxy</span> <span class="keyword">implements</span> <span class="title">Action</span></span>&#123;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Action action;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ActionProxy</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> <span class="keyword">this</span>.action = <span class="keyword">new</span> ActionImpl();  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> <span class="keyword">this</span>.sleep();  </span><br><span class="line"> <span class="keyword">this</span>.action.eat();  </span><br><span class="line"> <span class="keyword">this</span>.sleep();  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="comment">// @Override  </span></span><br><span class="line"> <span class="comment">// 其它需要被代理的方法  </span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> System.out.println(<span class="string">&quot;sleep&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p><strong>JDK 动态代理</strong></p>
<blockquote>
<p> 在方法调用(即<strong>动态</strong>，使用<strong>反射技术</strong>实现)时立刻生效，但只能代理<strong>有接口</strong>的实现类。通过实现JDK的<code>InvocationHandler</code>接口完成代理。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMain</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line"> <span class="comment">// 代理对象  </span></span><br><span class="line"> Action target = <span class="keyword">new</span> ActionImpl();  </span><br><span class="line"> <span class="comment">// 代理类  </span></span><br><span class="line"> Action targetProxy = DynamicProxyHandler.getProxy(target);  </span><br><span class="line"></span><br><span class="line"> targetProxy.eat();  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;  </span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Object target;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">DynamicProxyHandler</span><span class="params">(Object target)</span> </span>&#123;  </span><br><span class="line"> <span class="keyword">this</span>.target = target;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line"> before();  </span><br><span class="line"> Object result = method.invoke(target, args);  </span><br><span class="line"> after();  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> result;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * 获取代理类</span></span><br><span class="line"><span class="comment">  *  </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> target 代理对象实例</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> 代理类  </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"> <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(T target)</span> </span>&#123;  </span><br><span class="line"> <span class="keyword">return</span> (T) Proxy.newProxyInstance(  </span><br><span class="line"> target.getClass().getClassLoader(),  </span><br><span class="line"> target.getClass().getInterfaces(),  </span><br><span class="line"> <span class="keyword">new</span> DynamicProxyHandler(target));  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> System.out.println(<span class="string">&quot;before&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> System.out.println(<span class="string">&quot;after&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p><strong>CGlib 动态代理</strong></p>
<blockquote>
<p>1. JDK代理是基于反射机制，CGLIB是基于继承机制。<br>2. 原生JDK代理创建代理的速度更快，但创建后的代理运行速度更慢。CGLib相反，虽然初始化慢，但是<strong>运行速度更快</strong>，所以系统初始化的时候更适合用CGLib代理。</p>
<p>通过实现<code>MethodInterceptor</code>接口完成代理。</p>
</blockquote>
<p>CGLib常用方法介绍：</p>
<ul>
<li><code>Enhancer.create()</code>: 创建CGLib代理类</li>
<li><code>Method.intercept(Object obj, Method method, Object[] args, MethodProxy methodProxy) throws Throwable</code>: 由用户实现的代理(或拦截)方法。返回结果为目标方法的返回值。</li>
</ul>
<p><code>Ctrl+Q</code><br><img src="/2021/02/25/%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7java-web-MVC-%E6%A1%86%E6%9E%B6/f45b17d1-482a-41a9-b7a6-3a9dd0b28036.png"></p>
<p>实现<code>MethodInterceptor</code>接口，重写其<code>intercept()</code>方法。其中<strong>MethodProxy</strong>参数是代理的关键。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CGLibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line"> <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line"> <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; target)</span> </span>&#123;</span><br><span class="line"> <span class="comment">// this 的类型为 MethodInterceptor  </span></span><br><span class="line"> <span class="keyword">return</span> (T) Enhancer.create(target, <span class="keyword">this</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line"> <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Object target)</span> </span>&#123;  </span><br><span class="line"> <span class="keyword">return</span> (T) Enhancer.create(target.getClass(), <span class="keyword">this</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line"> before();  </span><br><span class="line"> Object result = methodProxy.invokeSuper(obj, args);  </span><br><span class="line"> after();  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> result;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> System.out.println(<span class="string">&quot;before&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> System.out.println(<span class="string">&quot;after&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h3 id="2-2-AOP-简介"><a href="#2-2-AOP-简介" class="headerlink" title="2.2 AOP 简介"></a>2.2 AOP 简介</h3><blockquote>
<p> AOP: Aspect-Oriented Programming，主要用于从业务逻辑中分离出来的横切逻辑，如性能监控、日志记录、权限控制等。实现AOP的技术主要有：代理*2、Spring AOP框架。</p>
</blockquote>
<p><code>Spring-AOP</code>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.teamwang.aop.sample;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aopalliance.intercept.MethodInterceptor;  </span><br><span class="line"><span class="keyword">import</span> org.aopalliance.intercept.MethodInvocation;  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;  </span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.AfterReturningAdvice;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.MethodBeforeAdvice;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.ProxyFactory;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;  </span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jacky  </span></span><br><span class="line"><span class="comment"> * Date: 2020/12/13 0:00  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringAOP</span> </span>&#123;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BeforeAdvice</span> <span class="keyword">implements</span> <span class="title">MethodBeforeAdvice</span> </span>&#123;  </span><br><span class="line"> <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Method method, Object[] objects, Object o)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line"> System.out.println(<span class="string">&quot;起床&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterAdvice</span> <span class="keyword">implements</span> <span class="title">AfterReturningAdvice</span> </span>&#123;  </span><br><span class="line"> <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(Object o, Method method, Object[] objects, Object o1)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line"> System.out.println(<span class="string">&quot;睡觉&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Around = Before + After  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AroundAdvice</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;  </span><br><span class="line"> <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation methodInvocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line"> <span class="comment">// before(); System.out.println(&quot;起床&quot;);  </span></span><br><span class="line"> Object result =  methodInvocation.proceed();  </span><br><span class="line"> <span class="comment">// after(); System.out.println(&quot;睡觉&quot;);  </span></span><br><span class="line"> <span class="keyword">return</span> result;  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line"> ProxyFactory factory = <span class="keyword">new</span> ProxyFactory();  </span><br><span class="line"> factory.setTarget(<span class="keyword">new</span> ActionImpl());  </span><br><span class="line"> factory.addAdvice(<span class="keyword">new</span> SpringAOP.BeforeAdvice());  </span><br><span class="line"> factory.addAdvice(<span class="keyword">new</span> SpringAOP.AfterAdvice());  </span><br><span class="line"></span><br><span class="line"> Action action = (Action) factory.getProxy();  </span><br><span class="line"></span><br><span class="line"> action.eat();  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="comment">/*  </span></span><br><span class="line"><span class="comment"> * 结合 AspectJ（maven: Spring-boot-starter-aop）  </span></span><br><span class="line"><span class="comment"> * 顺序：around &gt; before &gt; around &gt; after &gt; afterReturning  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> <span class="comment">// todo 内部类使用@Autowired有效吗？无效。这里仅作展示用。  </span></span><br><span class="line"> <span class="meta">@Component</span>  </span><br><span class="line"> <span class="meta">@Aspect</span>  </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">AspectSample</span> </span>&#123;  </span><br><span class="line"> <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * execution()方法：执行目标  </span></span><br><span class="line"><span class="comment"> * 第一个*：所有类型返回值  </span></span><br><span class="line"><span class="comment"> * 第二个*：所有方法  </span></span><br><span class="line"><span class="comment"> * (..): 任意参数  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> <span class="meta">@Around(&quot;execution(* cn.teamwang.aop.sample.ActionImpl.*(..))&quot;)</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </span><br><span class="line"> <span class="comment">// before();  </span></span><br><span class="line"> <span class="comment">// proceed(): 让目标方法执行  </span></span><br><span class="line"> Object methodResult = joinPoint.proceed();  </span><br><span class="line"> <span class="comment">// after();  </span></span><br><span class="line"> <span class="keyword">return</span> methodResult;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line"> <span class="meta">@Before(&quot;@annotation(cn.teamwang.aop.sample.Tag)&quot;)</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125;  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h3 id="2-3-开发-AOP-框架"><a href="#2-3-开发-AOP-框架" class="headerlink" title="2.3 开发 AOP 框架"></a>2.3 开发 AOP 框架</h3><blockquote>
<p> 流程/思路整理(主要使用CGLib动态代理技术)：</p>
<ol>
<li>实现<strong>切面代理类</strong>AspectProxy</li>
<li>获取代理类实例</li>
<li>将代理类实例放入Bean容器覆盖目标类实例，即可生效</li>
</ol>
</blockquote>
<p>在开始之前，先模仿CGLib的<code>MethodInterceptor</code>接口，设计一个能循环执行<strong>多次代理</strong>（即执行多次<code>intercept()</code>方法）的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodInterceptor</span> <span class="keyword">extends</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">intercept</span><span class="params">(Object var1, Method var2, Object[] var3, MethodProxy var4)</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jacky</span></span><br><span class="line"><span class="comment"> * Date: 2020/12/13 2:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProxyInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由用户来实现的切面方法。</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 按顺序执行链式代理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Object <span class="title">intercept</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了能多次调用<code>intercepte()</code>方法，ProxyChain 除了封装了原有的<code>obj</code>，<code>method</code>，<code>args</code>，<code>MethodProxy</code>参数外，另外增加了<code>List&lt;ProxyInterceptor&gt;</code>参数。并在invoke方法内实现了多次调用<code>intercept()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jacky</span></span><br><span class="line"><span class="comment"> * Date: 2020/12/13 2:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyChain</span> </span>&#123;</span><br><span class="line">    <span class="comment">// target: class, obj, method, args...</span></span><br><span class="line">    <span class="comment">// proxy: proxyList, methodProxy...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; targetClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object targetObject;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method targetMethod;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodProxy methodProxy;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] methodParams;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ProxyInterceptor&gt; proxyInterceptorList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyChain</span><span class="params">(Class&lt;?&gt; targetClass, Object targetObject, Method targetMethod, MethodProxy methodProxy, Object[] methodParams, List&lt;ProxyInterceptor&gt; proxyList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.targetClass = targetClass;</span><br><span class="line">        <span class="keyword">this</span>.targetObject = targetObject;</span><br><span class="line">        <span class="keyword">this</span>.targetMethod = targetMethod;</span><br><span class="line">        <span class="keyword">this</span>.methodProxy = methodProxy;</span><br><span class="line">        <span class="keyword">this</span>.methodParams = methodParams;</span><br><span class="line">        <span class="keyword">this</span>.proxyInterceptorList = proxyList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getTargetClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> targetClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Method <span class="title">getTargetMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> targetMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object[] getMethodParams() &#123;</span><br><span class="line">        <span class="keyword">return</span> methodParams;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object methodResult;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxyIndex &lt; proxyInterceptorList.size()) &#123;</span><br><span class="line">            methodResult = proxyInterceptorList.get(proxyIndex++).intercept(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 执行完用户实现的所有 intercept() 后，最终调用目标对象的业务逻辑方法。</span></span><br><span class="line">            methodResult = methodProxy.invokeSuper(targetObject, methodParams);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> methodResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 1. 实现切面代理类 <code>AspectProxy</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jacky</span></span><br><span class="line"><span class="comment"> * Date: 2020/12/14 2:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectProxy</span> <span class="keyword">implements</span> <span class="title">ProxyInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(AspectProxy.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object result;</span><br><span class="line">        Class&lt;?&gt; cls = proxyChain.getTargetClass();</span><br><span class="line">        Method method = proxyChain.getTargetMethod();</span><br><span class="line">        Object[] args = proxyChain.getMethodParams();</span><br><span class="line"></span><br><span class="line">        begin();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (validate()) &#123;</span><br><span class="line">                before(cls, method, args);</span><br><span class="line">                result = proxyChain.invoke();</span><br><span class="line">                after(cls, method, args, result);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = proxyChain.invoke();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;proxy failure: &quot;</span>, e);</span><br><span class="line">            error(cls, method, args, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            end();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] args, Object result)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] args, Throwable e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 2. 获取代理类实例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; targetClass, <span class="keyword">final</span> List&lt;ProxyInterceptor&gt; proxyInterceptorList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) Enhancer.create(targetClass, <span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ProxyChain(targetClass, obj, method, methodProxy, args, proxyInterceptorList)</span><br><span class="line">                    .invoke();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 3. 将代理类实例放入Bean容器覆盖</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理 目标类、切面类 &amp; 创建代理类实例 的关系。</span></span><br><span class="line"><span class="comment"> * 最终以代理类实例覆盖IOC容器中的目标类实例。（另外，该类的初始化时间应在IOC容器初始化之后，才能实现覆盖）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jacky</span></span><br><span class="line"><span class="comment"> * Date: 2020/12/14 4:08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOPHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(AOPHelper.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = createProxyMap();</span><br><span class="line">            <span class="comment">// 目标类：代理</span></span><br><span class="line">            Map&lt;Class&lt;?&gt;, List&lt;ProxyInterceptor&gt;&gt; targetMap = createTargetMap(proxyMap);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, List&lt;ProxyInterceptor&gt;&gt; targetEntry : targetMap.entrySet()) &#123;</span><br><span class="line">                Class&lt;?&gt; targetClass = targetEntry.getKey();</span><br><span class="line">                List&lt;ProxyInterceptor&gt; proxyList = targetEntry.getValue();</span><br><span class="line">                <span class="comment">// 创建代理类实例</span></span><br><span class="line">                Object proxyInstance = ProxyUtil.getProxy(targetClass, proxyList);</span><br><span class="line">                <span class="comment">// 替换IOC容器中targetClass的实例为代理类实例</span></span><br><span class="line">                BeanHelper.setBean(targetClass, proxyInstance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;aop failure&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * (一个)切面代理类 : (多个)目标类</span></span><br><span class="line"><span class="comment">     * 例如：ControllerAspect切面代理类 和 所有的(value=)Controller目标类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; createProxyMap() &#123;</span><br><span class="line">        <span class="comment">// 代理类和(多个)目标类的映射集合</span></span><br><span class="line">        Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// proxySet: 获取所有继承了AspectProxy的切面类（即 AspectProxy 的子类）</span></span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; proxySet = ClassHelper.getClassSetBySuper(AspectProxy.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取目标类</span></span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; proxyClass : proxySet) &#123;</span><br><span class="line">            <span class="keyword">if</span> (proxyClass.isAnnotationPresent(Aspect.class)) &#123;</span><br><span class="line">                <span class="comment">// 获取 @Aspect 注解中的 value，再获取被 value 修饰的所有类。</span></span><br><span class="line">                <span class="comment">// 以 ControllerAspect 为例，目标类就是 @Aspect(Controller.class) 的 value</span></span><br><span class="line">                proxyMap.put(proxyClass, ClassHelper.getClassSetByAnnotation(proxyClass.getAnnotation(Aspect.class).value()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addTransactionProxy(proxyMap);</span><br><span class="line">        <span class="keyword">return</span> proxyMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 因为创建代理类实例需要targetClass，proxyInterceptorList参数，所以需要在proxyMap的基础上建立新的映射关系。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, List&lt;ProxyInterceptor&gt;&gt; createTargetMap(Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Map&lt;Class&lt;?&gt;, List&lt;ProxyInterceptor&gt;&gt; targetMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyEntry : proxyMap.entrySet()) &#123;</span><br><span class="line">            <span class="comment">// 代理类</span></span><br><span class="line">            Class&lt;?&gt; proxyClass = proxyEntry.getKey();</span><br><span class="line">            <span class="comment">// n 个目标类</span></span><br><span class="line">            Set&lt;Class&lt;?&gt;&gt; targetClassSet = proxyEntry.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; targetCls : targetClassSet) &#123;</span><br><span class="line">                <span class="comment">// 创建代理实例</span></span><br><span class="line">                ProxyInterceptor proxyInterceptor = (ProxyInterceptor) proxyClass.newInstance();</span><br><span class="line">                <span class="keyword">if</span> (targetMap.containsKey(targetCls)) &#123;</span><br><span class="line">                    targetMap.get(targetCls).add(proxyInterceptor);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    List&lt;ProxyInterceptor&gt; temp = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                    temp.add(proxyInterceptor);</span><br><span class="line">                    targetMap.put(targetCls, temp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> targetMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addTransactionProxy</span><span class="params">(Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap)</span> </span>&#123;</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; serviceClassSet = ClassHelper.getClassSetByAnnotation(Service.class);</span><br><span class="line">        proxyMap.put(TransactionProxy.class, serviceClassSet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-ThreadLocal"><a href="#2-4-ThreadLocal" class="headerlink" title="2.4 ThreadLocal"></a>2.4 ThreadLocal</h3><blockquote>
<p> ThreadLocal (JDK1.2): 一个用来存放线程的 map 容器。用于解决多线程并发问题。</p>
</blockquote>
<p><strong>ThreadLocal的核心机制</strong></p>
<ul>
<li>每个Thread线程内部都有一个Map。</li>
<li>Map里面存储线程本地对象（key）和线程的变量副本（value）</li>
<li>但是，Thread内部的Map是由ThreadLocal维护的，由ThreadLocal负责向map获取和设置线程的变量值。</li>
</ul>
<p><strong>ThreadLocal的代码实现</strong></p>
<p>在实现之前，先说明下HashMap是线程不安全的，需用<code>ConcurrentHashMap</code>/<code>Collections.synchronizedMap</code>/<code>Hashtable</code>(按性能排序)。</p>
<p>性能差异是由于HashTable直接用synchronized修饰方法；<code>Collections.synchronizedMap</code>用synchronized修饰代码块；<code>ConcurrentHashMap</code>使用分段锁 (jdk1.7及更早)/CAS。</p>
<p><code>HashMap</code>的线程不安全主要体现在下面两个方面：<br>1.在JDK1.7中，当并发执行扩容操作时会造成环形链和数据丢失的情况。<br>2.在JDK1.8中，在并发执行put操作时会发生数据覆盖的情况。</p>
<p>下面是山寨版<code>ThreadLocal</code>的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThreadLocal</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存放线程的map容器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Thread, T&gt; threadLocalMap = Collections.synchronizedMap(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 修改当前的线程Map</span></span><br><span class="line">        threadLocalMap.put(Thread.currentThread(), value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        T value = threadLocalMap.get(Thread.currentThread());</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            value = initialValue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由子类实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> T <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        threadLocalMap.remove(Thread.currentThread());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>应用场景：</strong></p>
<ol>
<li>数据隔离</li>
<li>方便获取数据，避免方法不断传参（如userId，token等等）</li>
</ol>
<h3 id="2-5-实现事务功能"><a href="#2-5-实现事务功能" class="headerlink" title="2.5 实现事务功能"></a>2.5 实现事务功能</h3><p>该节主要包括：事务的特性(ACID)、隔离级别、传播行为(Spring)</p>
<p>这里仅介绍7种传播行为的一种，也是Spring框架默认的事务传播行为。</p>
<p>假设：方法A传播到<strong>有事务的方法B</strong>（其实就是A被B调用了），方法A有事务吗？</p>
<p>如果没有，就新建一个事务；如果有，就加入当前(B的)事务。这就是Spring默认的事务传播行为——<code>PROPAGATION_REQUIRED</code></p>
<p><strong>所有事务传播行为</strong></p>
<blockquote>
<p>支持当前事务(当前存在事务，则加入该事务；如果没有则如下：)</p>
</blockquote>
<ol>
<li>TransactionDefinition.PROPAGATION_REQUIRED: 创建一个新事务。</li>
<li>supports：以非事务的方式继续运行。</li>
<li>mandatory：抛出异常。</li>
</ol>
<blockquote>
<p>不支持当前事务</p>
</blockquote>
<ol>
<li>requires_new: 创建一个新事务，挂起当前事务（若有）。</li>
<li>not_supported: 以非事务方式运行，挂起当前事务（若有）</li>
<li>never: 以非事务方式运行，抛出异常（若有）</li>
</ol>
<p><strong>实现@Transaction功能</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionProxy</span> <span class="keyword">implements</span> <span class="title">ProxyInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(TransactionProxy.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; FLAG_HOLDER = <span class="keyword">new</span> ThreadLocal&lt;Boolean&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Boolean <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object result;</span><br><span class="line">        <span class="keyword">boolean</span> flag = FLAG_HOLDER.get();</span><br><span class="line">        Method method = proxyChain.getTargetMethod();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!flag &amp;&amp; method.isAnnotationPresent(Transaction.class)) &#123;</span><br><span class="line">            FLAG_HOLDER.set(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                DatabaseHelper.beginTransaction();</span><br><span class="line">                LOGGER.debug(<span class="string">&quot;begin transaction&quot;</span>);</span><br><span class="line">                result = proxyChain.invoke();</span><br><span class="line">                DatabaseHelper.commitTransaction();</span><br><span class="line">                LOGGER.debug(<span class="string">&quot;commit transaction&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                DatabaseHelper.rollbackTransaction();</span><br><span class="line">                LOGGER.debug(<span class="string">&quot;rollback transaction&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                FLAG_HOLDER.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = proxyChain.invoke();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，在<code>AOPHelper</code>中处理代理类(<code>TransactionProxy</code>)和目标类(所有<code>Service</code>)的关系即可。</p>
<h2 id="3-短暂总结"><a href="#3-短暂总结" class="headerlink" title="3. 短暂总结"></a>3. 短暂总结</h2><p><strong>反射</strong>是整个框架的基础技术。反射、IOC + 代理、再到 AOP+事务(其实也是aop的一小部分功能实现)。</p>
<p>流程图为：<strong>反射</strong> =&gt; <strong>IOC + 代理</strong> =&gt; <strong>AOP + 事务</strong>(aop的子集)</p>
<p>IOC是框架的核心，AOP、事务等功能都依赖于它。</p>
<h2 id="4-优化和拓展"><a href="#4-优化和拓展" class="headerlink" title="4. 优化和拓展"></a>4. 优化和拓展</h2><h3 id="4-1-获取ServletAPI"><a href="#4-1-获取ServletAPI" class="headerlink" title="4.1 获取ServletAPI"></a>4.1 获取ServletAPI</h3><p>获取Servlet API，即获取<code>HttpServletRequest</code>和<code>Response</code>对象。与BaseHandler一样，用拦截(Intercepter/DispacherServlet)的方法实现。</p>
<p>在DispatcherServlet的service方法把req和res参数放进ThreadLocal中。</p>
<h2 id="5-发布到maven仓库"><a href="#5-发布到maven仓库" class="headerlink" title="5. 发布到maven仓库"></a>5. 发布到maven仓库</h2><h3 id="4-1-github-package"><a href="#4-1-github-package" class="headerlink" title="4.1 github package"></a>4.1 github package</h3><p>相关介绍：</p>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/cn/free-pro-team@latest/packages/guides/configuring-apache-maven-for-use-with-github-packages">https://docs.github.com/cn/free-pro-team@latest/packages/guides/configuring-apache-maven-for-use-with-github-packages</a></p>
<p>若只想让个人或协作者访问，则使用私有仓库。另外，即便是只使用（即安装jar依赖），也需要配置<strong>github-token</strong>；maven deploy时需要配置POM的<code>distributionManagement</code>来指定Maven分发构件的位置</p>
<h3 id="4-2-maven-略"><a href="#4-2-maven-略" class="headerlink" title="4.2 maven(略)"></a>4.2 maven(略)</h3><h3 id="4-3-jitpack"><a href="#4-3-jitpack" class="headerlink" title="4.3 jitpack"></a>4.3 jitpack</h3><p>网站：<a target="_blank" rel="noopener" href="https://jitpack.io/">https://jitpack.io/</a></p>
<p>直接releases版本号即可，然后修改<code>pom.xml</code>文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>jitpack.io<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://jitpack.io<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.cloris-cc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>public-package<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>Tag<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>搭建轻量级 JavaWeb 框架</p><p><a href="https://teamwang.cn/2021/02/25/搭建轻量级java-web-MVC-框架/">https://teamwang.cn/2021/02/25/搭建轻量级java-web-MVC-框架/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Jacky</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-02-25</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-03-05</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=60364d8c1dae0d00189a79e8&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/02/25/%E5%8E%9F%E5%9C%B0%E7%9D%A1%E8%A7%89/"><i class="level-item fas fa-chevron-left"></i><span class="level-item"> </span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/02/25/Hexo%E5%8D%9A%E5%AE%A2%E7%BD%91%E7%AB%99%E6%90%AD%E5%BB%BA/"><span class="level-item">Hexo博客网站搭建</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "D7nrmJ3xSHla6mxR3p0BrXqD-gzGzoHsz",
            appKey: "rGXO6glIn8ETvzytN7maFaoP",
            placeholder: "Leave your comments~",
            
            
            meta: ["nick"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            enableQQ: true,
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#0-前置说明"><span class="level-left"><span class="level-item">0. 前置说明</span></span></a></li><li><a class="level is-mobile" href="#1-基础框架搭建"><span class="level-left"><span class="level-item">1. 基础框架搭建</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-主要问题"><span class="level-left"><span class="level-item">1.1 主要问题</span></span></a></li><li><a class="level is-mobile" href="#1-2-开发-IOC-框架"><span class="level-left"><span class="level-item">1.2 开发 IOC 框架</span></span></a></li><li><a class="level is-mobile" href="#1-3-额外内容"><span class="level-left"><span class="level-item">1.3 额外内容</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-使框架具备AOP特性"><span class="level-left"><span class="level-item">2. 使框架具备AOP特性</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-什么是代理"><span class="level-left"><span class="level-item">2.1 什么是代理</span></span></a></li><li><a class="level is-mobile" href="#2-2-AOP-简介"><span class="level-left"><span class="level-item">2.2 AOP 简介</span></span></a></li><li><a class="level is-mobile" href="#2-3-开发-AOP-框架"><span class="level-left"><span class="level-item">2.3 开发 AOP 框架</span></span></a></li><li><a class="level is-mobile" href="#2-4-ThreadLocal"><span class="level-left"><span class="level-item">2.4 ThreadLocal</span></span></a></li><li><a class="level is-mobile" href="#2-5-实现事务功能"><span class="level-left"><span class="level-item">2.5 实现事务功能</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-短暂总结"><span class="level-left"><span class="level-item">3. 短暂总结</span></span></a></li><li><a class="level is-mobile" href="#4-优化和拓展"><span class="level-left"><span class="level-item">4. 优化和拓展</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-获取ServletAPI"><span class="level-left"><span class="level-item">4.1 获取ServletAPI</span></span></a></li></ul></li><li><a class="level is-mobile" href="#5-发布到maven仓库"><span class="level-left"><span class="level-item">5. 发布到maven仓库</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-github-package"><span class="level-left"><span class="level-item">4.1 github package</span></span></a></li><li><a class="level is-mobile" href="#4-2-maven-略"><span class="level-left"><span class="level-item">4.2 maven(略)</span></span></a></li><li><a class="level is-mobile" href="#4-3-jitpack"><span class="level-left"><span class="level-item">4.3 jitpack</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Jacky"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Jacky</p><p class="is-size-6 is-block">(ง ˙o˙)ว</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">23</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tag</p><a href="/tags"><p class="title">1</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cloris-cc"><i class="fab fa-github"></i></a></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><p class="is-size-7"><span>&copy; 2021 Jacky</span>  <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备19098392号</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/"><i class="fab fa-weibo"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/cloris-cc"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>